# 第十章：*最佳实践*

感谢阅读这本书。我希望你已经准备好将持续交付方法引入你的 IT 项目。作为本书的最后一部分，我提出了持续交付的十大最佳实践列表。祝你阅读愉快！

# 实践 1 – 在团队内掌控过程！

在团队内拥有整个过程的掌控，从接收需求到监控生产。如曾经所说，"*开发者机器上的程序不能赚钱*。"这就是为什么拥有一个小型的 DevOps 团队并完全负责产品是很重要的。实际上，这正是**DevOps**的真正含义：**开发与运维**，从头到尾：

+   掌控持续交付管道的每个阶段：如何构建软件，验收测试中的要求是什么，以及如何发布产品。

+   避免拥有专门的管道专家！团队中的每个成员都应该参与创建管道。

+   找到一种良好的方式与团队成员共享当前的管道状态（以及生产监控）。最有效的解决方案是在团队空间内放置大屏幕。

+   如果开发者、QA 和 IT 运维工程师是不同的专家，那么确保他们在一个敏捷团队中共同工作。基于专长划分的团队会导致没有人对产品负责。

+   记住，赋予团队自主权会带来高水平的工作满意度和卓越的参与感。这将带来伟大的产品！

# 实践 2 – 自动化一切！

自动化一切，从业务需求（以验收测试的形式）到部署过程。手动描述、包含步骤说明的 Wiki 页面都会迅速过时，导致部落知识的积累，使得过程变得缓慢、繁琐且不可靠。这反过来又导致需要进行发布演练，使得每次部署都变得独一无二。不要走这条路！作为规则，如果你做任何事情已经是第二次，自动化它：

+   消除所有手动步骤；它们是错误的源头！整个过程必须是可重复和可靠的。

+   永远不要直接在生产环境中进行任何更改！请改用配置管理工具。

+   使用完全相同的机制来部署到每个环境中。

+   始终包含自动化冒烟测试，以检查发布是否成功完成。

+   使用数据库模式迁移来自动化数据库变更。

+   使用自动化维护脚本进行备份和清理。别忘了删除未使用的 Docker 镜像！

# 实践 3 – 版本化所有内容！

版本化所有内容：软件源代码、构建脚本、自动化测试、配置管理文件、持续交付管道、监控脚本、二进制文件以及文档；简而言之，一切都要版本化。将工作任务化，每个任务都会导致一个提交到仓库，无论该任务是与需求收集、架构设计、配置还是软件开发相关。任务从敏捷看板开始，最终结束在仓库中。这样，你就能维护一个单一的真实来源，记录变更的历史和原因：

+   严格遵循版本控制。版本化所有内容意味着一切！

+   将源代码和配置存储在代码仓库中，将二进制文件存储在工件仓库中，并将任务存储在敏捷问题追踪工具中。

+   将持续交付管道开发为代码。

+   使用数据库迁移并将其存储在仓库中。

+   将文档存储为可以版本控制的 markdown 文件形式。

# 实践 4 – 使用业务语言进行接受测试

在接受测试中使用面向业务的语言，以促进相互沟通，并帮助更好地理解需求。与产品负责人紧密合作，创建埃里克·埃文（Eric Evans）所称的*普遍语言*，即业务和技术之间的共同语言。误解是大多数项目失败的根本原因：

+   创建一个通用语言，并在项目中使用它。

+   使用接受测试框架，如 Cucumber 或 FitNesse，帮助业务团队理解并使他们参与进来。

+   在接受测试中表达业务价值，并且在开发过程中不要忽视它们。很容易在无关的议题上花费过多时间！

+   改进并维护接受测试，使其始终充当回归测试。

+   确保每个人都意识到，接受测试套件通过意味着业务部门同意发布软件。

# 实践 5 – 为回滚做好准备

为回滚做好准备；迟早你会需要它。记住，你不需要更多的 QA；你需要一个更快的回滚。如果生产环境出现问题，你首先要做的就是保持安全并回到最后一个正常版本：

+   制定回滚策略，并规划当系统故障时该做的事。

+   将不兼容的数据库变更拆分为兼容的变更。

+   始终使用相同的交付流程进行回滚和标准发布。

+   考虑引入蓝绿部署或金丝雀发布。

+   不要害怕 bug；如果你快速反应，用户是不会离开的！

# 实践 6 – 不低估人的影响

不要低估人的影响。人们通常比工具更重要。如果 IT 运维团队不愿意帮助你，你将无法实现自动化交付。毕竟，他们了解当前的流程。相同的道理适用于质量保证（QA）人员、业务部门以及所有相关人员。让他们成为重要角色并积极参与：

+   让 QA 和 IT 运维成为 DevOps 团队的一部分。你需要他们的知识和技能！

+   为当前执行手动操作的成员提供培训，使他们能够转向自动化。

+   更倾向于非正式沟通和扁平化的组织结构，而非等级制度和命令。没有善意，你什么都做不成！

# 实践 7 - 纳入可追溯性

将可追溯性纳入交付过程和工作系统中。没有任何日志信息的失败是最糟糕的。监控请求数量、延迟、生产服务器的负载、持续交付流水线的状态，以及任何你认为能帮助你分析当前软件的内容。要主动！在某些时候，你需要检查统计数据和日志：

+   记录流水线活动！在发生失败时，使用信息丰富的消息通知团队。

+   实现运行系统的适当日志记录和监控。

+   使用专门的系统监控工具，如 Kibana、Grafana 或 Logmatic.io。

+   将生产监控集成到你的开发生态系统中。考虑在公共团队空间中放置大屏幕显示当前的生产统计数据。

# 实践 8 - 经常集成

经常集成；事实上，应该始终集成！正如某人曾说过，"*持续集成比你想象的更频繁*。"没有什么比解决合并冲突更让人沮丧的了。持续集成更关乎团队实践，而非工具。每天至少将代码集成到一个代码库几次。忘掉长时间存在的功能分支和大量的本地更改。基于主干的开发和特性开关才是胜利之道！

+   使用基于主干的开发和特性开关，而不是功能分支。

+   如果需要一个分支或本地更改，请确保每天至少与团队其他成员进行一次集成。

+   始终保持主干的健康；在合并到基线之前确保先运行测试。

+   每次提交到代码库后都运行流水线，以获得更快速的反馈周期。

# 实践 9 - 只构建一次二进制文件

只构建一次二进制文件，并在每个环境中运行相同的文件，无论它们是以 Docker 镜像还是 JAR 包的形式存在；只构建一次可以消除由于不同环境引入的差异风险，同时节省时间和资源：

+   一次构建，跨环境传递相同的二进制文件。

+   使用工件库来存储和版本控制二进制文件。绝不要将源代码库用于此目的。

+   外部化配置并使用配置管理工具来引入环境之间的差异。

# 实践 10 - 经常发布

经常发布，最好在每次提交到代码仓库后进行发布。正如俗话所说，"*如果痛苦，就多做几次*"。将发布作为日常例行公事，使得过程变得可预测且平稳。避免陷入稀有发布的习惯。那样只会越来越糟，最终你将只在一年发布一次，并且准备期长达三个月！

+   重新定义完成的标准为*完成意味着已发布*。对整个过程负责！

+   使用功能开关将仍在进行中的功能对用户隐藏。

+   使用金丝雀发布和快速回滚来降低生产环境中出现错误的风险。

+   采用零停机时间的部署策略，以支持频繁发布。

在本书的最后部分，我们已经覆盖了关于持续交付过程的最重要的理念和工具。我希望你觉得这些内容有价值，并祝你在持续交付的旅程中一切顺利！
