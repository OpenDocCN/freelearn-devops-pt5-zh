# 拥抱破坏：宠物与牲畜

任何在项目中没有直接促进目标、未能尽快将有价值的软件交到用户手中的角色，都应该被仔细考虑。

-斯坦·英格·莫里斯巴克

在我们开始探索那些能够帮助我们创建和运营“真正的”Swarm 集群的工具和流程之前，应该先讨论一下高层次的策略。我们应该如何对待我们的服务器？它们是宠物，还是牲畜？

如何知道你是否在将服务器视为宠物或牲畜？问问自己以下问题：如果现在你的几台服务器掉线，会发生什么？如果它们是宠物，这种情况将会对用户造成严重的影响。如果它们是牲畜，这种结果将不会引起任何注意。由于你运行的是分布在多个节点上的多个服务实例，单台服务器（或几台服务器）的故障并不会导致所有副本的失败。唯一的即时效果是一些服务将运行较少的实例，负载会更高。失败的副本会被重新调度，原始的副本数量很快会恢复。同时，失败的节点会被新虚拟机替代。几台服务器的故障唯一的负面影响是由于容量减少而导致的响应时间增加。几分钟后，所有失败的副本会被重新调度，失败的节点会被新虚拟机替换，一切都会恢复正常。最棒的是，这一切都将无需人工干预。如果你的集群现在就是这样运行的，那么你把服务器当作了牲畜。否则，你的数据中心里有宠物。

传统的系统管理是基于物理服务器的。要向数据中心添加一台新机器，我们需要先购买它，等它从供应商处到货，再在办公室进行配置，然后将它搬到数据中心，最后连接好。这整个过程可能需要相当长的时间。通常需要几周，甚至几个月，才能让一台新的、配置完全的服务器在数据中心内部运行起来。

考虑到如此漫长的等待期和成本，保持服务器尽可能健康是自然而然的事。如果其中一台开始出现故障，我们会竭尽所能尽快修复它。我们还能做什么呢？等待几周或几个月直到替代品到货？当然不能。SSH 登录故障机器，找出问题并修复它。如果某个进程死掉了，就重新启动它。如果硬盘坏了，就更换它。如果服务器过载，就增加内存。

在这种情况下，我们对每一台服务器产生情感依赖是很自然的。它从一个名字开始。每台新服务器都会得到一个名字。有 Garfield，有 Mordor，有 Spiderman，还有 Sabrina。我们甚至可能会决定一个主题。也许我们的所有服务器都将以漫画书超级英雄命名。或者你更喜欢神话生物？怎么，叫它们前男友前女友怎么样？一旦我们为服务器命名，我们就开始将它当作宠物来对待。你怎么了？需要什么吗？怎么回事？我应该带你去看兽医吗？每一台宠物服务器都是独一无二的，精心养育和照料的。

变革始于虚拟化。创建和销毁虚拟机的能力使我们能够采用不同的计算方式。虚拟化让我们不再将服务器视为宠物。如果虚拟化服务器可以随意创建和销毁，那么为它们命名就没有意义了。由于它们的生命周期可能非常短暂，所以没有情感上的依赖。现在，我们不再有*Garfield*，而是有*vm262.ecme.com*。明天，当我们尝试登录时，可能会发现它已被*vm435.ecme.com*替代。

随着虚拟化的发展，我们开始将服务器当作牲畜来对待。它们没有名字，只有编号。我们不再单独处理它们，而是将它们视作一群。如果有一只生病了，我们会将其杀掉。治疗它既缓慢又有可能感染其他的牲畜。如果一台服务器开始出现问题，立刻终止它，并用新的服务器替换。

这种方法的问题在于，我们在与物理硬件打交道的多年经验中积累的习惯。从宠物到牲畜的转变需要一种心理上的变化。它要求我们在转向新的工作方式之前，先要抛弃过时的做法。

尽管本地虚拟化打开了许多新的可能性，但许多人仍然以对待物理节点的方式来对待虚拟化服务器。旧习惯难以改变。即使我们的服务器变成了一群牲畜，我们仍然将每台服务器当作宠物来对待。转向更具弹性和动态计算的困难部分原因在于我们数据中心的物理限制。只有在有可用资源的情况下，才可以创建新的虚拟机。一旦达到限制，就必须销毁一台虚拟机以创建新的虚拟机。我们的物理服务器仍然是宝贵的资源。虚拟机为我们提供了弹性，但这种弹性依然受到我们所拥有的计算能力总量的限制。

我们会小心地对待我们的贵重物品，因为它们不便宜，也不容易替换。我们会好好保管它们，因为它们应该能使用很长时间。另一方面，我们对于那些便宜且易于替换的物品有完全不同的处理方式。如果一只玻璃杯破了，你大概不会试图把碎片粘起来。你会把它丢进垃圾桶。橱柜里有很多其他的玻璃杯，当它们数量减少到一定程度时，我们只需要下次去购物中心时买一套餐具。如今，我们甚至不需要去购物中心，可以在线订购一套餐具，通常当天就能送到家门口。我们应该把同样的逻辑应用到服务器上。

云计算带来了巨大的变化。服务器不再是宝贵的财富，而是商品。我们可以随时替换一个节点而无需额外费用。我们可以在几分钟内向集群中添加十几台服务器。当我们不再需要它们时，可以将其移除，减少成本。

云计算与“传统”数据中心根本不同。当云计算充分发挥其潜力时，服务器不再是不可或缺的或独一无二的。我们能做的最糟糕的事情，就是在没有改变我们的流程和架构的情况下迁移到云端。如果我们只是将本地服务器迁移到云端，而不改变我们用来维护它们的流程，唯一能达成的就是更高的成本。

随着云计算的普及，服务器的概念、价值和获取所需的时间发生了巨大变化。如此重大的变化需要一套新的流程和工具来执行它们。容错是目标，速度是关键，自动化是必须的。

# 现在怎么办？

到目前为止，我们使用 Docker Machine 本地创建服务器并将其加入集群。目的是教你如何创建和操作一个 Swarm 集群，而无需为托管提供商支付费用。现在你已经掌握了 Docker Swarm 模式的工作原理，接下来是时候转向“真正”的服务器了。我们仍然会保持“便宜”的做法，使用免费的或非常便宜的小型实例，只创建足够多的服务器来展示这个过程。接下来的章节将带领你完成几个设置，比较它们，选择一个最终应用到我们的生产环境。你应该更改的仅仅是虚拟机实例类型和服务器数量，其他所有内容可以与我们所使用的示例保持一致。

我们已经看到了如何通过使用 Docker Swarm 作为服务调度器来实现容错。接下来的章节将尝试在基础设施层面实现所需的速度和自动化。我们将使用不同的工具和流程，自动化地在几个云计算提供商的环境中创建集群。排在第一位的是**亚马逊 Web 服务** (**AWS**)。

结构：宠物与牲畜
