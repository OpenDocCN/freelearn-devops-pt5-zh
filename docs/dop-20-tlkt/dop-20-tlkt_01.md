# 第一章：DevOps 理想

从事小型绿地项目是一件很棒的事。我参与的最后一个项目是在 2015 年夏天，尽管它有一些问题，但整体上还是非常愉快的。与一套小而相对新的产品合作使我们能够选择我们喜欢的技术、实践和框架。我们是否应该使用微服务？当然，为什么不呢？我们是否应该尝试 Polymer 和 GoLang？没问题！没有那些束缚你的包袱是一种美妙的感觉。一个错误的决定可能让我们退步一周，但它不会危及到别人之前辛勤工作的几年时间。简单来说，我们不需要考虑并害怕遗留系统的影响。

我的职业生涯大多数时间并不是这样的。我有机会，或者说是一种诅咒，参与到大型遗留系统的工作中。我曾为一些公司工作，这些公司在我加入之前就已存在，并且无论是好是坏，都已经有了自己的系统。我必须在创新和改进的需求与现有业务必须不间断运作之间找到平衡。在所有那些年里，我不断地尝试寻找新的方法来改进这些系统。虽然这很痛心，但我不得不承认，许多尝试都是失败的。

我们将探讨这些失败，以便更好地理解推动我们在本书中讨论的进展的动机。

# 持续集成、持续交付与持续部署

发现持续集成（CI）以及后来出现的持续交付（CD）是我职业生涯中的一个关键点。这一切都显得合情合理。在那个时候，集成阶段可能持续几天、几周，甚至几个月。这是我们都害怕的时期。在不同团队为不同服务或应用程序工作几个月后，集成阶段的第一天就是地狱的代名词。如果我不懂，我可能会说但丁是一个开发者，并且在集成阶段写了《地狱篇》。

在令人畏惧的集成阶段的第一天，我们都会带着严肃的面孔走进办公室。只能听到低声耳语，集成工程师宣布整个系统已搭建好，游戏可以开始了。他启动系统，有时，结果是一个空白屏幕。几个月的独立工作再次证明是灾难性的。服务和应用程序无法集成，修复问题的漫长过程就此开始。在某些情况下，我们可能需要重新做几周的工作。提前定义的需求，像往常一样，会有不同的解释，这种差异在集成阶段尤为明显。

然后，**极限编程**（**XP**）实践诞生了，随之而来的是**持续集成**（**CI**）。今天，集成应该持续进行这个想法听起来似乎是显而易见的。嗯！当然，你不应该等到最后一刻才进行集成！但在当时的瀑布开发时代，这种做法并不如今天这样显而易见。我们实施了一个持续集成的流水线，并开始检查每一次提交，运行静态分析、单元测试、功能测试、打包、部署和集成测试。如果任何一个阶段失败，我们会放弃正在做的工作，并将修复流水线检测到的问题作为我们的首要任务。流水线本身非常快速。在有人提交代码到仓库后几分钟内，我们就会收到通知，若出现失败。后来，**持续交付**（**CD**）开始得到普及，我们可以确信每次通过整个流水线的提交都能部署到生产环境。我们甚至做得更好，不仅能验证每个构建是否准备好生产，而且可以应用*持续部署*，在不等待任何人（手动）确认的情况下，部署每个构建。所有这些最棒的一点是，一切都是全自动化的。

这是一个梦想成真。字面意思！它是一个梦想。它不是我们设法变成现实的东西。那是为什么呢？我们犯了错误。我们认为 CI/CD 是运维部门的任务（今天我们称之为*DevOps*）。我们以为我们可以创建一个围绕应用程序和服务的流程。我们认为 CI 工具和框架已经准备好。我们认为架构、测试、商业谈判以及其他任务是别人负责的事。我们错了。我错了。

今天我知道，成功的 CI/CD 意味着没有任何环节可以忽略。我们需要影响一切；从架构到测试，再到开发和运维，直到管理层和商业预期。但让我们再回到原点。那些失败中，究竟出了什么问题？

## 架构

尝试调整一个由许多人多年来开发的单体应用，缺乏测试、耦合紧密且技术陈旧，就像试图让一个八十岁的老太太看起来年轻一样。我们可以改善她的外貌，但我们所能做的也就是让她看起来稍微不那么老，而不是年轻。简单来说，某些系统已经太老，不值得进行*现代化*努力。我尝试过，很多次，结果从未如预期。 有时候，使其*恢复年轻*的努力是不划算的。另一方面，我无法去对银行之类的客户说：“我们将重写你们的整个系统。”重写一切的风险太大，而且由于其紧密耦合、老化和技术过时，改动其中的一部分也不值得投入太多精力。常见的做法是开始构建新系统，并在此期间维护旧系统，直到一切完成。这总是个灾难。完成这样一个项目可能需要好几年，而我们都知道长期规划的事情最终会怎么样。那甚至不是瀑布方法。那就像站在尼亚加拉大瀑布的底部，困惑自己为什么会被淋湿。即便是像更新 JDK 这种琐事，也变得异常艰难。而那时候，我会觉得自己很幸运。那么，面对例如用 Fortran 或 Cobol 编写的代码库，你会怎么做呢？

然后我听说了微服务。这对我来说简直是如同天籁之音。我们可以构建许多小的独立服务，由小团队维护，代码库可以很快理解，能够在不影响整个系统的情况下更换框架、编程语言或数据库，并且可以独立部署的想法实在太美好了，几乎不敢相信。我们终于可以开始从单体应用中剥离一些部分，而不至于让整个系统（遭受重大）风险。听起来太完美了，结果也确实如此。好处的背后也有缺点。部署和维护大量服务最终变成了一项沉重的负担。我们不得不做出妥协，开始标准化服务（扼杀创新），创建共享库（再次耦合），将它们分组部署（拖慢一切进度），诸如此类。换句话说，我们不得不去除微服务本应带来的好处。更不用提配置和它们在服务器内部制造的混乱了。这些是我尽量忘记的日子。我们已经有了足够多与单体系统相关的问题，微服务只是将它们放大了。这是一次失败。然而，我还没有准备好放弃。叫我一个受虐狂也罢。

我不得不一次解决一个问题，其中一个关键问题就是部署。

## 部署

你知道这个过程。先将一些工件（JAR、WAR、DLL，或者任何你编程语言的产物）组装起来，然后部署到已经被“污染”的服务器上... 我甚至无法把这句话说完，因为在许多情况下，我们甚至不知道服务器上都有什么内容。随着时间的推移，任何手动维护的服务器都会堆满各种东西。库、可执行文件、配置文件、捣蛋鬼和恶作剧者。它开始发展出自己的个性。又老又脾气差，速度快但不可靠，要求高等等。所有服务器唯一的共同点就是它们各不相同，没有人能确保在“预生产环境”中测试过的软件在部署到生产环境后会表现得一样。那简直就是买彩票。你可能会幸运，但大概率不会。希望是最后死的。

你可能会问，为什么在那些日子里我们没有使用虚拟机。嗯，这个问题有两个答案，它们取决于“那些日子”是指哪段时间。一个答案是，在那些日子里我们根本没有虚拟机，或者它们太新了，管理层对批准使用它们感到害怕。另一个答案是，后来我们确实使用了虚拟机，而那才是真正的改进。我们可以复制生产环境，并将其用作，比如说，测试环境。只不过，仍然需要做很多工作来更新配置、网络设置等等。

此外，我们依然不知道这些机器上积累了多少东西。我们只知道如何复制它们。这仍然没有解决配置在不同虚拟机之间不同的问题，另外，复制虽然短时间内看似与原始环境一致，但最终会偏离。部署时，改一些配置，bada bing，bada boom，你又回到了测试与生产环境不一致的问题。差异随着时间的推移而积累，除非你有一个可重复且可靠的自动化流程，而不是依赖人工干预。如果这样的东西存在，我们就能创建不可变的服务器。与其把应用程序部署到现有的服务器上，走上积累差异的老路，我们可以把创建新的虚拟机作为 CI/CD 流水线的一部分。于是，我们不再创建 JAR、WAR、DLL 等文件，而是开始创建虚拟机。每当有新的版本发布时，它会作为一个从头构建的完整服务器出现。通过这种方式，我们可以确保测试过的就是将要投入生产的版本。创建新的虚拟机，部署软件，进行测试，然后将生产路由器切换到新的虚拟机。这非常棒，除了它慢且资源消耗大。为每个服务创建单独的虚拟机有些过头。尽管如此，凭借耐心，不可变的服务器确实是一个好主意，但我们使用这种方法的方式以及支持它的工具并不够成熟。

## 编排

编排是关键。*Puppet*和*Chef*证明了它们是巨大的帮助。编程所有与服务器设置和部署相关的任务是一个巨大的改进。不仅设置服务器和部署软件所需的时间大大减少，而且我们终于可以实现一个更可靠的过程。让人类（也就是运维部门）手动执行这些任务，简直是灾难的配方。终于有一个圆满的结局？其实不然。你可能已经开始注意到一个模式。一旦一个改进完成，通常它会伴随一个高昂的代价。随着时间的推移，Puppet 和 Chef 的脚本和配置会变成一大堆****（我被告知不要使用某些词，所以请用你的想象力填充这些空白）。维护它们本身往往成为一场噩梦。不过，通过编排工具，我们能够大幅度减少创建不可变虚拟机的时间。总比什么都没有好。

# 部署流水线尽头的曙光

我可以一直描述我们所面临的问题。别误会我，所有这些举措都是改进措施，并且在软件历史上有其地位。但历史是过去的，我们生活在当下，试图展望未来。我们曾经面临的许多问题，甚至可以说是所有问题，现在已经得到了解决。*Ansible* 证明了编排不需要复杂的设置，也不需要难以维护。随着*Docker*的出现，容器逐渐取代了虚拟机，成为创建不可变部署的首选方式。新的操作系统正在出现，并完全拥抱容器作为第一类公民。服务发现工具为我们展示了新的前景。*Swarm、Kubernetes 和 Mesos/DCOS*正在开启一些几年前难以想象的领域。

微服务正在慢慢成为构建大型、易于维护并具有高度可扩展性系统的首选方式，这得益于像*Docker、CoreOS、etcd、Consul、Fleet、Mesos、Rocket*等工具。这个想法一直很棒，但我们以前并没有足够的工具来让它正常运作。现在我们有了！这并不意味着我们所有的问题都已经解决。它意味着，当我们解决一个问题时，难度就会提高，而新的问题也会随之而来。

我一开始抱怨过去。以后不会再这样了。本书是给那些不想活在过去而是活在当下的读者的。本书是关于为未来做准备的。本书是关于穿越镜子的旅程，关于进入新领域，关于从新的角度看待事物。

|   | *这是你最后的机会。之后就没有回头路了。你服下蓝色药丸——故事结束，你回到床上，信仰你想信的任何东西。你服下红色药丸——你将留在仙境，我会带你看看兔子洞有多深。* |   |
| --- | --- | --- |
|   | --*摩尔菲斯（黑客帝国）* |

如果你选择了蓝色药丸，我希望你没有买这本书，而是通过阅读免费的样本来获取这些内容。没有任何不快。我们每个人都有不同的追求和目标。另一方面，如果你选择了红色药丸，你将会经历一场奇妙的旅程。这就像过山车一样，我们还未能预见到在这场旅程结束时将会有什么等着我们。
