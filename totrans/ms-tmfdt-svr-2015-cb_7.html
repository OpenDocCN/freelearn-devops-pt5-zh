<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Managing Team Foundation Server" id="aid-2G3F81"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Managing Team Foundation Server</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"It's hardware that makes a machine fast… It's software that makes a fast machine slow."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Craig Bruce</em></span></span></td></tr></table></div><p>In this chapter, we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Diagnosing builds in TFS</li><li class="listitem">Analyzing the TFS database and configuring test retention policies</li><li class="listitem">Using Activity and Job Monitoring logs to diagnose TFS issues</li><li class="listitem">Changing update frequency and forcing a rebuild of the TFS Warehouse</li><li class="listitem">Configuring TFS Cache settings</li><li class="listitem">Managing CodeLens in TFS</li><li class="listitem">Continuous synchronization with TFS Proxy server</li><li class="listitem">Creating a TFS database back up schedule</li><li class="listitem">Cleaning up dead workspaces and shelvesets in TFS</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Introduction</h1></div></div></div><p>We are entering the era of self-driven cars; you may ask, "why can't products just maintain themselves?" The Product Teams deliver high-quality software yet the real-world usage of a feature can significantly differ from its anticipated usage. The building blocks the product operates on and the ecosystem of frameworks that rely on the product keep evolving too. TFS does not have a very high administration over head. The administration needs are somewhat proportional to the level of usage. Smaller Teams may be able to administer TFS within the day-to-day activities of individuals on the Team, while larger Teams may need a dedicated TFS administrator.</p><p>The key tasks that need to be performed by a TFS administrator can broadly be divided into three categories: <span class="strong"><strong>Update</strong></span>, <span class="strong"><strong>Maintain</strong></span>, and <span class="strong"><strong>Optimize</strong></span>:</p><div class="mediaobject"><img src="../Images/image00804.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>Let's explain each of these tasks in detail:</p><p><span class="strong"><strong>Update</strong></span>: It is very important to keep the environment secure, and for this reason, all security updates that the MBSA tool identifies as "Critical" should be applied within 48 hours. The product updates are roughly rolled out every quarter. Each product update contains bug fixes, performance enhancements, and new features. Quarterly updates rarely have breaking changes; this also reduces the effort in testing the upgrade. The product updates should also be applied as soon as possible. It is also recommended to keep the underlying OS and SQL Server updated to the latest available service packs.</p><p><span class="strong"><strong>Maintain</strong></span>: There needs to be a clear strategy for disaster recovery and backup restore. The TFS database usage should be closely monitored to find any unexpected growth patterns. It is recommended that the TFS Perfmon counters be used to benchmark the performance of the server and reevaluated overtime regularly, especially during upgrades. More information on TFS Perfmon counters<a id="id830" class="indexterm"/> is available at <a class="ulink" href="http://bit.ly/1SijysU">http://bit.ly/1SijysU</a>. Maintaining TFS also involves day-to-day cleanup activities such as managing permissions, build drop locations, test attachments, workspaces, shelvesets, and so on.</p><p><span class="strong"><strong>Optimize</strong></span>: By monitoring the TFS usage using the Activity logs, you can identity requirements for scalability. Load balancing the TFS application tier is usually the first step to provide resilience and scale to the TFS setup. If Teams are working in a low bandwidth location, installing a TFS proxy server can significantly improve the experience. By closely monitoring the build and release agent utilization, you can supplement the build queues with additional agents. This can help bring down the queue times for builds and releases.</p><p>If your organization has systems center setup, there is now a management pack available for Visual Studio Team Foundation Server 2015 that <a id="id831" class="indexterm"/>can be downloaded from <a class="ulink" href="http://bit.ly/1lgcEJN">http://bit.ly/1lgcEJN</a>. If you have recently upgraded from TFS 2013 or any of the earlier versions, then it's worth reading up about enabling TFS 2015-specific features on existing Team Projects (<a class="ulink" href="http://bit.ly/1P6IbLu">http://bit.ly/1P6IbLu</a>). There is a wealth of documentation available on MSDN (<a class="ulink" href="http://bit.ly/1R4Uh79">http://bit.ly/1R4Uh79</a>) covering key administration concepts with samples and walkthroughs. In addition to that, this article (<a class="ulink" href="http://bit.ly/1QGxVcQ">http://bit.ly/1QGxVcQ</a>) talks at length about all things TFS administrators should focus on. TFS administration and management is a fairly big topic. In this chapter, we'll focus on some of the key administration and management activities that every TFS administrator should perform.</p></div></div>
<div class="section" title="Diagnosing builds in TFS" id="aid-2H1VQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Diagnosing builds in TFS</h1></div></div></div><p>Development Teams <a id="id832" class="indexterm"/>use TFBuild for validating code changes and inspecting <a id="id833" class="indexterm"/>code quality and running tests. Builds are a critical part of any software development life cycle. As a TFS administrator, you may need to inspect issues with a build agent or diagnose a specific build definition. In this recipe, we'll learn how to diagnose build agents and build definitions.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec216"/>Getting ready</h2></div></div></div><p>Download TFBuild Agent from the TFS Administration Console. For more information on how to download the TFBuild Agent, refer to the <span class="emphasis"><em>Configuring TFBuild Agent, Pool</em></span>,<span class="emphasis"><em> and Queues</em></span> recipe in <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span>. You need to have collection administration permissions to configure a TFBuild Agent. To create or edit a build definition, you need to be a member of the Build Administrators Group.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec217"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The best place to start when diagnosing agent issues is to look at the agent trace logs. The agent trace logs are stored in the <code class="literal">_diag</code> folder in the agent working directory.</li><li class="listitem">If there is nothing obvious in the agent trace logs, as a next step you should run an HTTP Trace against the agent. This can be done using an HTTP Proxy tool. If you are on Windows, you can use Fiddler; for other platforms, you can use Charles Proxy. Refer to <a class="ulink" href="http://bit.ly/1P6dqGt">http://bit.ly/1P6dqGt</a> on how to set up and capture an <a id="id834" class="indexterm"/>HTTP Trace.</li><li class="listitem">When capturing an<a id="id835" class="indexterm"/> HTTP Trace, the agent needs to be run in <a id="id836" class="indexterm"/>interactive mode. Browse to the location where the TFBuild Agent has been downloaded. Unzip the TFBuild Agent. Open a command prompt in administrator mode and set the working directory to the unzipped location of the TFBuild Agent. As illustrated here, run the <code class="literal">ConfigureAgent</code> command:<div class="mediaobject"><img src="../Images/image00805.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>The <code class="literal">ConfigureAgent</code> command will prompt to configure the agent for a few details. When prompted for <code class="literal">Would you like to install the agent as a Windows Service</code> key in <span class="emphasis"><em>N</em></span>, this will run the agent as an interactive process rather than installing the agent as a service:</p><div class="mediaobject"><img src="../Images/image00806.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>All agent activity will show up in verbose in the command prompt. This will likely provide clues to diagnose problems with the agent.</p></li><li class="listitem">When troubleshooting problems with the build definition, its best to run the build definition in verbose mode. In verbose mode, the agent produces very detailed logs; investigating the logs is usually the best way to identify problems causing the unexpected behavior. To run the build definition in verbose mode, create a new variable <code class="literal">System.Debug</code> and set the value of this variable to <code class="literal">true</code>:<div class="mediaobject"><img src="../Images/image00807.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec218"/>How it works…</h2></div></div></div><p>An HTTP Trace <a id="id837" class="indexterm"/>can contain credentials, so avoid sharing HTTP Traces publically. TFS <a id="id838" class="indexterm"/>currently does not support personal access tokens, so as a work-around, you can create a temporary account for the purposes of capturing the trace; alternatively, sanitize the trace logs before sharing with other Teams for investigation.</p></div></div>
<div class="section" title="Analyzing the TFS database and configuring test retention policies" id="aid-2I0GC1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Analyzing the TFS database and configuring test retention policies</h1></div></div></div><p>As the TFS usage <a id="id839" class="indexterm"/>increases over time, the TFS instances can build up very large <a id="id840" class="indexterm"/>volumes of data files, builds, releases, Work Items, and so on. For the most part, this is a very good thing – a big part of the value of many <a id="id841" class="indexterm"/>
<span class="strong"><strong>Application Lifecycle Management</strong></span> (<span class="strong"><strong>ALM</strong></span>) features, after all, is maintaining a reliable history of the various artifacts involved in a producing software. At some point, however, there are implicit and explicit costs involved in maintaining older data, such as performance impacts and increased time spent on upgrades, in addition to the increased disk space requirements. In this recipe, you'll learn how to analyze the TFS database size and set up test retention policies for a Team Project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec219"/>Getting ready</h2></div></div></div><p>It is not recommended to query the live instance of TFS transactional database directly. Restore a backup of the TFS transactional database on an alternate instance of SQL and execute the queries in this recipe on that instance instead of the live instance. To administer the test retention policies for a Team Project, you need to be a member of the Team Project Administrator Group.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec220"/>How to do it...</h2></div></div></div><p>Let's first analyze the TFS databases to understand the storage distribution:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open SQL Server Management Studio. Connect to the SQL instance the TFS transactional database has been restored to, open a new query window and run the following T-SQL code to get the database size for TFS databases:<div class="informalexample"><pre class="programlisting">use [master]
select DB_NAME(database_id) AS DBName, (size/128) SizeInMB
FROM sys.master_files with (nolock)
where type=0  and substring(db_name(database_id),1,4)='Tfs_' and DB_NAME(database_id)&lt;&gt;'Tfs_Configuration' order by size desc 
GO</pre></div><p>You will get the following output after executing the preceding code:</p><div class="mediaobject"><img src="../Images/image00808.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Scope the<a id="id842" class="indexterm"/> connected database in the SQL Server<a id="id843" class="indexterm"/> Management Studio to the <code class="literal">TFS_DefaultCollection</code> column. Execute the following T-SQL to identify the distribution of storage within this collection:<div class="informalexample"><pre class="programlisting">SELECT Owner = 
       CASE
              WHEN OwnerId = 0 THEN 'Generic' 
              WHEN OwnerId = 1 THEN 'VersionControl'
              WHEN OwnerId = 2 THEN 'WorkItemTracking'
              WHEN OwnerId = 3 THEN 'TeamBuild'
              WHEN OwnerId = 4 THEN 'TeamTest'
              WHEN OwnerId = 5 THEN 'Servicing'
              WHEN OwnerId = 7 THEN 'WebAccess'
              WHEN OwnerId = 8 THEN 'ProcessTemplate'
              WHEN OwnerId = 9 THEN 'StrongBox'
              WHEN OwnerId = 10 THEN 'FileContainer'
              WHEN OwnerId = 11 THEN 'CodeSense'
              WHEN OwnerId = 255 THEN 'PendingDeletion'
           END,
       SUM(CompressedLength) / 1024 as TotalSizeInKB
FROM tbl_FileReference fr
JOIN tbl_FileMetadata fm
on fr.PartitionId = fm.PartitionId
AND fr.ResourceId = fm.ResourceId
WHERE fr.PartitionId = 1
GROUP BY OwnerId
ORDER BY 2 DESC</pre></div><p>The storage is categorized into the areas of ownership. This should help identity the hot spots at a high level.</p></li><li class="listitem">The following query will show you the next level of details on the individual areas of ownership:<div class="informalexample"><pre class="programlisting">use Tfs_DefaultCollection 
select  SUBSTRING(a.filename,len(a.filename)- CHARINDEX('.',REVERSE(a.filename))+2,999)as Extension, sum(fm.compressedlength)/1024 as SizeInKB from tbl_Attachment as a 
inner join tbl_FileReference as fr on a.TfsFileId= fr.fileid
join tbl_FileMetadata fm on fr.PartitionId = fm.PartitionId and fm.ResourceId = fr.ResourceId
group by SUBSTRING(a.filename,len(a.filename)- CHARINDEX('.',REVERSE(a.filename))+2,999)
order by sum(fm.compressedlength) desc</pre></div></li><li class="listitem">From the<a id="id844" class="indexterm"/> analysis so far, we narrowed down that <code class="literal">TeamTest</code> is<a id="id845" class="indexterm"/> the biggest occupier in the database. The breakdown shows that this is because of the large volume of test runs, results, and attachments from manual and automated tests. To configure test retention policies for the FabrikamTFVC project, navigate to the FabrikamTFVC Administration Console in Team Web Portal and browse to the <span class="strong"><strong>Test</strong></span> tab. As illustrated in the following screenshot, set the manual and automated test retention policies:<div class="mediaobject"><img src="../Images/image00809.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec221"/>How it works…</h2></div></div></div><p>Test retention policies is a new addition to TFS 2015. Test retention policies allow you to individually manage the retention policies for automated and manual tests. The default configuration is set to retain indefinitely. In this recipe, we've configured the automated test execution runs, results, and attachments to be deleted in 30 days and the manual test execution runs, results, and attachments to be deleted in 365 days. The retention policies are automatically processed by a job in TFS.</p><div class="note" title="Note"><h3 class="title"><a id="tip15"/>Tip</h3><p><span class="strong"><strong>Warning</strong></span></p><p>Removing any files should be done with caution and <span class="emphasis"><em>never directly from the database</em></span>. As always, before you modify, update, or delete, take a full backup of the databases.</p></div><p>There is no <a id="id846" class="indexterm"/>provision to configure the test retention policies centrally. For <a id="id847" class="indexterm"/>this reason, the test reason policies need to be configured for each Team Project individually.</p><p>The test retention policies are just one of the ways to control the size of your TFS database. TFS also supports build retention policies; this has been discussed at length in the <span class="emphasis"><em>Using the build retention policy to automate build deletion</em></span> recipe in <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span>. In addition to this, you can free up more space by destroying deleted version control branches, Team Projects, files, and XAML builds. Refer to <a class="ulink" href="http://bit.ly/1PMhuvB">http://bit.ly/1PMhuvB</a> to know how this can be accomplished.</p></div></div>
<div class="section" title="Using Activity and Job Monitoring logs to diagnose TFS issues"><div class="titlepage" id="aid-2IV0U2"><div><div><h1 class="title"><a id="ch07lvl1sec80"/>Using Activity and Job Monitoring logs to diagnose TFS issues</h1></div></div></div><p>TFS logs both the<a id="id848" class="indexterm"/> activity and the job execution <a id="id849" class="indexterm"/>data in the backend database. TFS<a id="id850" class="indexterm"/> has a built-in job agent that runs <a id="id851" class="indexterm"/>on the application tier and logs diagnostic information about jobs and processes. Having visibility of poor performing and failed jobs, along with diagnostic information, helps narrow down potential problems faster. The diagnostics page in TFS comprises of Activity logs and Job Monitoring logs. In this recipe, you'll learn how to use the diagnostics page in TFS.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec222"/>Getting ready</h2></div></div></div><p>To use the diagnostics page, you need to be a member of the TFS Administrators Group. Validate access by browsing <code class="literal">http://tfs2015:8080/tfs/_oi/</code>:</p><div class="mediaobject"><img src="../Images/image00810.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec223"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To access <a id="id852" class="indexterm"/>Activity <a id="id853" class="indexterm"/>log navigate to <code class="literal">http://tfs2015:8080/tfs/_oi/_diagnostics/activityLog</code>. The page can<a id="id854" class="indexterm"/> take a little longer to load<a id="id855" class="indexterm"/> if you are accessing it for the first time.</li><li class="listitem">This page basically presents the data in the <code class="literal">tbl_Command</code> table. As illustrated in the following screenshot among other things, the page contains a list of commands, applications, status, start time, time taken for execution, execution status, identity, IP address, unique identifier, user agent, command identifier, execution count, authentication, and response code:<div class="mediaobject"><img src="../Images/image00811.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Double-click on an item in the list to see more details. As illustrated in the following image, the details for the reconcile workspace command shows you the rich next level of details of the operation:<div class="mediaobject"><img src="../Images/image00812.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The <span class="strong"><strong>Activity Log</strong></span> page also allows filter and export operations. Since the data in the <code class="literal">tbl_command</code> table is only retained for 14 days, you can export the data in the Activity log incrementally to a separate repository to keep this valuable information for historic trend analysis.</li><li class="listitem">Click on the <span class="strong"><strong>Job Monitoring</strong></span> tab to navigate to the <span class="strong"><strong>Job Monitoring</strong></span> view. Alternatively, you can directly browse <code class="literal">http://tfs2015:8080/tfs/_oi/_jobMonitoring</code>. The <span class="strong"><strong>Job Monitoring</strong></span> view has three more submenus: <span class="strong"><strong>Job Summary</strong></span>, <span class="strong"><strong>Job Queue</strong></span>, and <span class="strong"><strong>Job History</strong></span>:<div class="mediaobject"><img src="../Images/image00813.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Let's first<a id="id856" class="indexterm"/> look at the <a id="id857" class="indexterm"/><span class="strong"><strong>Job Summary</strong></span> <a id="id858" class="indexterm"/>view. The summary view <a id="id859" class="indexterm"/>shows a graphical representation of the total runtime for each job. Being able to visualize job execution time relative to other jobs helps identify potential problems. As you can see in the following screenshot, the TFS Periodic Identity Synchronization and Incremental Analysis Database sync job takes longer to process as compared to optimize databases job:<div class="mediaobject"><img src="../Images/image00814.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To get more details on Incremental Analysis Database sync job, click on the blue bar next to the job name. This will navigate you to the <span class="strong"><strong>Job History</strong></span> tab. The <span class="strong"><strong>Job History</strong></span> tab has two graphs, one showing the job execution time for all jobs and the other showing the details for Incremental Analysis Database sync job. Seeing the two charts together helps you compare the contribution one has on the other. The following figure illustrates the graph for the execution of Incremental Analysis Database sync job. Looking at the chart, you can work out that the job on the 07/25 is out of pattern and has taken significantly longer than usual. However, the queue time metric on the chart shows that the delay is contributed by the prolonged average queue time:<div class="mediaobject"><img src="../Images/image00815.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate <a id="id860" class="indexterm"/>back to the<a id="id861" class="indexterm"/> <span class="strong"><strong>Job Summary</strong></span> view; this<a id="id862" class="indexterm"/> view also has a pie <a id="id863" class="indexterm"/>chart that shows the split between <span class="strong"><strong>Succeeded</strong></span>, <span class="strong"><strong>Blocked</strong></span>, and <span class="strong"><strong>Disabled</strong></span> jobs. Clicking on any will navigate you to the <span class="strong"><strong>Job History</strong></span> view and provide job-level details on each type:<div class="mediaobject"><img src="../Images/image00816.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Last but not least, the <span class="strong"><strong>Job Summary</strong></span> page has a chart for number of job runs. The chart displays the number of times a job has run combined with the result types for that particular job. Click on any of the bars in the chart to display details on those jobs. Hovering over the chart provides further information:<div class="mediaobject"><img src="../Images/image00817.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Next, navigate to the <span class="strong"><strong>Job Queue</strong></span> tab. The chart in this tab describes the job queue; it provides the counts for each queue type. Click on the bar to see the job details associated to each queue type:<div class="mediaobject"><img src="../Images/image00818.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec224"/>How it works...</h2></div></div></div><p>It is recommended <a id="id864" class="indexterm"/>that you do not directly query<a id="id865" class="indexterm"/> the TFS Transactional database. Any <a id="id866" class="indexterm"/>changes made to the database<a id="id867" class="indexterm"/> can significantly impact the functioning of TFS. While some changes may not show the impact immediately, the changes can cause disruption during upgrades. Prior to the introduction of the diagnostics page, there was no alternate but to query the database directly to retrieve and analyze the data from the <code class="literal">command</code> and <code class="literal">actions</code> table. The diagnostics page makes it easier to access this valuable dataset.</p><p>All built-in TFS jobs track their activity in the <code class="literal">command</code> table. The logging is internally handled by the framework in TFS. There is a very interesting article that talks about the built-in jobs <a id="id868" class="indexterm"/>and the <a id="id869" class="indexterm"/>execution interval; you can read more about this at <a class="ulink" href="http://bit.ly/1kPSbfg">http://bit.ly/1kPSbfg</a>.</p></div></div>
<div class="section" title="Changing update frequency and forcing a rebuild of TFS Warehouse"><div class="titlepage" id="aid-2JTHG2"><div><div><h1 class="title"><a id="ch07lvl1sec81"/>Changing update frequency and forcing a rebuild of TFS Warehouse</h1></div></div></div><p>The reporting warehouse in<a id="id870" class="indexterm"/> TFS is a traditional data warehouse that consists of a <a id="id871" class="indexterm"/>relational database and an analysis<a id="id872" class="indexterm"/> services database. The data warehouse aggregates all the operational data, such as version control, Work Item tracking, build, and test. The warehouse corresponds to the <code class="literal">Tfs_Warehouse</code> relational database. The cube corresponds to the SQL Server Analysis Services database <code class="literal">Tfs_Analysis</code>. The default rebuild frequency for the TFS Warehouse is 2 hours. In this recipe, you'll learn how to manually change the TFS Warehouse refresh frequency from 2 hours to 1 hour. You'll also learn how to force a rebuild of the TFS Warehouse cube.</p><div class="note" title="Note"><h3 class="title"><a id="note41"/>Note</h3><p>TFS Warehouse refresh is default to 2 hours; if you reduce the interval to less than the default of 2 hours, processing of the data warehouse will consume server resources frequently. If your TFS Server has large volumes of data, reducing the refresh frequency may adversely affect the performance of the server.</p></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec225"/>Getting ready</h2></div></div></div><p>To work through this recipe, you'll<a id="id873" class="indexterm"/> need to ensure the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The TFS deployment<a id="id874" class="indexterm"/> you are working with a TFS <a id="id875" class="indexterm"/>Warehouse configured. You can validate this by checking the <span class="strong"><strong>Reporting</strong></span> tab of TFS Administration Console:<div class="mediaobject"><img src="../Images/image00819.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You must be a member of the Team Foundation Administrators security group or you must have the server-level administer warehouse permission set to <span class="strong"><strong>Allow</strong></span>.</li><li class="listitem">The Microsoft Team Foundation Server Application Pool must be running for the Warehouse Control Web Service:<div class="mediaobject"><img src="../Images/image00820.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></li></ul></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec226"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into Team Foundation Server Application Tier and validate that the Warehouse Control Service is available by browsing <code class="literal">http://localhost:8080/tfs/TeamFoundation/Administration/v3.0/WarehouseControlService.asmx</code>. Revisit the <span class="emphasis"><em>Getting ready</em></span> section if you don't see the Warehouse Control Web Service as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00821.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the <code class="literal">WarehouseControlWebService</code> page, look for the <code class="literal">changesetting</code> web<a id="id876" class="indexterm"/> method. Click on this to navigate to the definition<a id="id877" class="indexterm"/> of this function. This method has two <a id="id878" class="indexterm"/>input parameters, namely, <code class="literal">settingId</code> and <code class="literal">newValue</code>. In the <code class="literal">settingId</code> textbox, type <code class="literal">RunIntervalSeconds</code>. This property holds the warehouse rebuild frequency. In the <code class="literal">newValue</code> textbox type <code class="literal">3600</code>, <code class="literal">3600</code> here represents 3600 seconds (1 hour), that is, the new value for the property <code class="literal">RunIntervalSeconds</code>:<div class="mediaobject"><img src="../Images/image00822.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Invoke</strong></span>. This will redirect you to the response page. The response page will list the result of the action. In this case, the message confirms that the run interval value has been successfully updated to 3600 seconds:<div class="mediaobject"><img src="../Images/image00823.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In this step, we'll see how to force the rebuild of the warehouse. Navigate back to the Warehouse Control Web Service and select the <span class="strong"><strong>ProcessWarehouse</strong></span> web method. This method has two input parameters, namely, <span class="strong"><strong>collectionName</strong></span> and <span class="strong"><strong>jobName</strong></span>. In the <span class="strong"><strong>collectionName</strong></span> textbox, enter <span class="strong"><strong>defaultcollection</strong></span>. This is the TFS collection you want to force the rebuild for. Don't pass any values in the <span class="strong"><strong>jobName</strong></span> textbox:<div class="mediaobject"><img src="../Images/image00824.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="tip16"/>Tip</h3><p>You can optionally leave the <span class="strong"><strong>collectionName</strong></span> textbox empty. This will force the rebuild of all Team Project Collections.</p></div></li><li class="listitem">Clicking <a id="id879" class="indexterm"/>on <span class="strong"><strong>Invoke</strong></span> will redirect you to the response page. The <a id="id880" class="indexterm"/>response page will list the result of the<a id="id881" class="indexterm"/> action. The service returns <code class="literal">True</code> when it successfully starts the processing of the warehouse and <code class="literal">False</code> if it is not successful. A value of <code class="literal">False</code> indicates that the warehouse is currently being processed:<div class="mediaobject"><img src="../Images/image00825.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec227"/>How it works…</h2></div></div></div><p>Forcing a TFS Warehouse rebuild isn't something you need to do on a regular basis. However, a TFS Warehouse and cube rebuild is required if you move, restore, rename, and fail over the data tier of TFS. The warehouse rebuild is required to see refreshed reports if you move, attach, detach, or delete a Team Project Collection.</p></div><div class="section" title="There is more"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec228"/>There is more</h2></div></div></div><p>The <code class="literal">RebuildWarehouse</code> command is available via command-line utility as well. More details on how to use the <code class="literal">RebuildWarehouse</code> command<a id="id882" class="indexterm"/> can be found at <a class="ulink" href="http://bit.ly/1HjaQdp">http://bit.ly/1HjaQdp</a>.</p></div></div>
<div class="section" title="Configuring TFS Cache settings" id="aid-2KS221"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec82"/>Configuring TFS Cache settings</h1></div></div></div><p>The TFS application tier <a id="id883" class="indexterm"/>maintains a file cache in order to speed up the file download process to the end user by serving the files from the cache, rather than getting them afresh from the database each time. The cache grows over time and can start to dent the available storage space on the application tier. The cache uses a good percentage of the available space; in case your main drive does not have a lot of available space, you will ignorantly not benefit from the caching facility. Moving the TFS Cache to a separate directory enables you to free up the storage on the main drive and plan a more relaxed backup or recovery procedure for the new drive. It is possible that you may see some performance gains by changing the cache directory to its own directory. In this recipe, you'll learn how to change the TFS Cache directory to a different directory.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec229"/>Getting ready</h2></div></div></div><p>You need permission to log into the TFS application tier.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec230"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into the TFS application tier. Navigate to the installation folder for TFS. The default install location is <code class="literal">C:\Program Files\Microsoft Team Foundation Server 14.0</code>.</li><li class="listitem">The TFS's <code class="literal">web.config</code> is available in the folder location <code class="literal">C:\Program Files\Microsoft Team Foundation Server 14.0\Application Tier\Web Services</code>. Take a backup of the <code class="literal">web.config</code> file before making any changes. Open the <code class="literal">web.config</code> file and search for the key <code class="literal">dataDirectory</code>:<div class="mediaobject"><img src="../Images/image00826.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Change the value of the data directory from the default to the new location. For this recipe, a new drive <code class="literal">W</code> has been set up for TFS Cache. Repoint the cache to <code class="literal">W:\TfsData\ApplicationTier\_fileCache</code> and save the changes in the config file:<div class="mediaobject"><img src="../Images/image00827.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In addition to this, you <a id="id884" class="indexterm"/>can optionally add a <code class="literal">PercentageBasedPolicy</code> key, which would dictate what percentage of the free space can be consumed by the cache. This key only accepts whole number values:<div class="mediaobject"><img src="../Images/image00828.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>Alternatively, the <code class="literal">FixedSizeBasedPolicy</code> key can be used. The value for this key is the total allowed space to the cache. For example, setting this to <code class="literal">500</code> would mean the cache only has 500 MB of available space for storage. If both <code class="literal">FixedSizeBasedPolicy</code> and <code class="literal">PercentageBasedPolicy</code> keys are specified, the value of <code class="literal">FixedSizeBasedPolicy</code> takes precedence.</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec231"/>How it works…</h2></div></div></div><p>Saving <code class="literal">web.config</code> will restart the application pool and the changes will be effective immediately. Carry out a <code class="literal">get</code> operation on version control and TFS will cache a copy of the files served back to the client as a result of the get operation in the new location.</p></div></div>
<div class="section" title="Managing CodeLens in TFS" id="aid-2LQIK1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec83"/>Managing CodeLens in TFS</h1></div></div></div><p>CodeLens is a<a id="id885" class="indexterm"/> Microsoft Visual Studio feature that shows you information about your code directly in the code editor. Before CodeLens, one had to dig through several different windows for information such as method references, tests linked to a method, the last change to a line of code, or the code churn to a class. Since all of this information is in TFS, you <a id="id886" class="indexterm"/>would just expect it to be available in one place. CodeLens<a id="id887" class="indexterm"/> just does that by putting this information literally at your fingertips within the code editor. CodeLens supports both TFVC and Git repositories. CodeLens now supports C#, VB, C++, SQL, and JavaScript files. You can learn more about <a id="id888" class="indexterm"/>CodeLens and other quality and diagnostic tools available in Visual Studio at <a class="ulink" href="http://bit.ly/1NNbtJ6">http://bit.ly/1NNbtJ6</a>.</p><p>This book focuses on TFS, you are probably wondering why Visual Studio-specific features are being discussed. TFS is responsible for preparing the information served by CodeLens in Visual Studio. TFS has specific jobs for code indexing, and the information produced off that is stored in the TFS database. In this recipe, you'll learn how to manage the <code class="literal">TfsConfig CodeIndex</code> command to check the indexing status of a Team Project Collection, enable/disable indexing, find large files, and ignore them from indexing, review ignore list, and destroy code index.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec232"/>Getting ready</h2></div></div></div><p>In order to use <a id="id889" class="indexterm"/>the <code class="literal">CodeIndex</code> command, you need to be a member of the<a id="id890" class="indexterm"/> Team Foundation Administrators Security Group. This command can only be invoked from the TFS Application tier; for this reason, you need to have login permissions to the TFS Application tier.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec233"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log on to TFS Application tier and open a command prompt in the elevated mode.</li><li class="listitem">Run the following command to see the indexing status for the default collection:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /indexingStatus /collectionName:"default collection"</strong></span>
</pre></div></li><li class="listitem">Start indexing all changesets:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /setIndexing:on /collectionName:"default collection"</strong></span>
</pre></div></li><li class="listitem">Stop indexing previously created changesets and start indexing new changesets only:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /setIndexing:keepupOnly /collectionName:"default collection"</strong></span>
</pre></div></li><li class="listitem">Run the following command to list the top 50 files that have a size greater than 10 KB in the default collection:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TfsConfig CodeIndex /listLargeFiles /fileCount:50 /minSize:10 /collectionName:&lt;CollectionName&gt;</strong></span>
</pre></div></li><li class="listitem">Run the following command to exclude a specific file from indexing and add it to the ignored file list:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /ignoreList:add "$/Fabrikam Web Site/Catalog.cs" /collectionName:"default collection"</strong></span>
</pre></div></li><li class="listitem">Run the following command to see all the files that aren't indexed:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /ignoreList:view</strong></span>
</pre></div></li><li class="listitem">Run the following command to clear previously indexed data and restart indexing:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /reindexAll /collectionName:"default collection"</strong></span>
</pre></div></li><li class="listitem">Run the following command to delete the code index with confirmation:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>TFSConfig CodeIndex /destroyCodeIndex /collectionName:"default collection"</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec234"/>How it works...</h2></div></div></div><p>The <code class="literal">TfsConfig</code> command <a id="id891" class="indexterm"/>gives you the ability to manage<a id="id892" class="indexterm"/> the <code class="literal">CodeIndex</code> functions. Refer to <a class="ulink" href="http://bit.ly/1NNcwZi">http://bit.ly/1NNcwZi</a> for more details on the<a id="id893" class="indexterm"/> individual commands.</p></div></div>
<div class="section" title="Continuous synchronization with the TFS Proxy server" id="aid-2MP361"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec84"/>Continuous synchronization with the TFS Proxy server</h1></div></div></div><p>It is not uncommon today to have <a id="id894" class="indexterm"/>geographically distributed Teams accessing TFS from remote locations. Remote users may suffer from latency of the connection between their location and the location where TFS is hosted. The Team Foundation Proxy Server comes to the rescue here. There is a common misconception about TFS Proxy caching all requests. However, the proxy server only caches the <code class="literal">Get</code> operation for TFVC-based version control. The proxy server does not carry out a continuous synchronization or replication operation, instead it caches the item on first request. While the first caller from the remote location will still face the latency in their <code class="literal">get</code> operation, all future requests will get the data as if it was being accessed locally. Today, developers are encouraged to check in code frequently. This means geographically distributed Teams operating in low network bandwidth regions will notice a lag when performing a get operation on source control. In this recipe, you'll learn how to precache the data in TFS Proxy to improve the overall performance of the proxy.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec235"/>Getting ready</h2></div></div></div><p>This recipe requires that you have a <a id="id895" class="indexterm"/>TFS Proxy Server setup. Follow the steps at <a class="ulink" href="http://bit.ly/1lfGDS7">http://bit.ly/1lfGDS7</a> to configure a TFS Proxy Server if you don't already have one. Supplement your proxy server with an additional drive. In this recipe, we'll be using <code class="literal">D:\TFS\Workspace</code> as the additional directory.</p><p>Scenario: A part of the distributed Team that is working in a remote location does not have great network bandwidth. Operations that require code download from the TFS server are generally slow. The Team has installed the TFS Proxy Server in their remote location; however, they still face a lag when downloading the incremental changes in the source code. The Team would like a proactive solution that downloads the incremental code changes to the proxy server, so when the Team performs a <code class="literal">Get</code> operation on TFS, the proxy server can serve the content from the local cache rather than needing to make a round trip to TFS.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec236"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into the TFS Proxy Server machine. Browse to the <code class="literal">D:\TFS\Command</code> directory and create a new file called <code class="literal">PreGetTfsProxy.bat</code>.</li><li class="listitem">Copy the following<a id="id896" class="indexterm"/> code into to the <code class="literal">PreGetTfsProxy.bat</code> file and save the changes:<div class="informalexample"><pre class="programlisting">@echo off 
set local 
set TFSPROXY=http://localhost:8081 
echo Forcing Pre-cache of files using TFS VC proxy at %TFSPROXY% 
cd D:\TFS\Workspace 
"%PROGRAMFILES%\Microsoft Visual Studio 14\Common7\IDE\TF.exe" get 
del /F /S /Q d:\ tfs\workspace\*.* 
echo Pre-cache complete. 
end local </pre></div></li><li class="listitem">Test the script by double-clicking on <code class="literal">PreGetTfsProxy.bat</code> to run the script. If the script is set up correctly, the <code class="literal">D:\TFS\Workspace</code> location should now be populated with the source code from TFS.</li><li class="listitem">Set up a Windows scheduled task to run the <code class="literal">PreGetTfsProxy.bat</code> file once every 10 minutes. You can tune the frequency of execution of this job to best suit the landscape of your organization.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec237"/>How it works...</h2></div></div></div><p>Installing Team Foundation Server Proxy Server installs the Team Foundation Server command-line tools. The core function of the TFS Proxy Server is to locally cache any files requested from TFS, so any subsequent calls for that file can be served directly by the proxy server. By saving a round trip out to the TFS Server, the proxy server can significantly reduce the lag noticed when performing the <code class="literal">Get</code> operation. TFS Proxy Server does not perform a workspace synchronization operation, instead it only caches the files requested from the TFS Server. In this recipe, we created a temporary workspace on the proxy server and scheduled the execution of <code class="literal">Get</code> operation through a Windows-scheduled task to proactively fetch the incremental code changes. This will, in turn cause the proxy server to cache the changes on the proxy server proactively. While the approach is simple, it is effective in synchronizing the changes from source control locally on the proxy server.</p><p>The TFS Proxy Server can significantly reduce the time taken to perform a <code class="literal">Get</code> operation. Perfmon is a very useful tool to measure the system performance using performance counters. Follow the walkthrough in <a class="ulink" href="http://bit.ly/1SZEN2T">http://bit.ly/1SZEN2T</a> to measure the times for the <code class="literal">Get</code> operation with and without the proxy server. It is generally recommended to baseline the performance gained by the proxy server. This should be revalidated after TFS upgrades.</p></div></div>
<div class="section" title="Creating a TFS database back up schedule"><div class="titlepage" id="aid-2NNJO2"><div><div><h1 class="title"><a id="ch07lvl1sec85"/>Creating a TFS database back up schedule</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"If you fail to plan, you are planning to fail!"</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Benjamin Franklin</em></span></span></td></tr></table></div><p>No one wants to be the <a id="id897" class="indexterm"/>administrator of a server that goes down without a complete set of backups in place. TFS Database sits at the core of the product; the database is the repository of the data you interact with using Web Portal, Visual Studio, and Microsoft Test Manager. In this recipe, you'll learn about the database backup capability available with in TFS.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec238"/>Getting ready</h2></div></div></div><p>To configure the backup schedule, you will need to be a member of the TFS Administrator Group, a member of SQL Server Administrator Group, and (if your deployment uses SharePoint Products) a member of the Farm Administrators Group.</p><p>The TFS Service Account must have a SQL Server perform backup and create maintenance plan permissions set to allow on each instance of the SQL Server that hosts the databases that you want to back up. You need a network share to store the database backup. The service account needs full control permission on the network share, folder, or storage device where the backups will be kept.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec239"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into the Team Foundation Server Application tier and open the Team Foundation Server Administration Console. Navigate to the <span class="strong"><strong>Scheduled Backups</strong></span> screen by clicking on <span class="strong"><strong>Scheduled Backups</strong></span> from the navigation panel on the left:<div class="mediaobject"><img src="../Images/image00829.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">As illustrated here, specify the network backup path and duration to 30 days:<div class="mediaobject"><img src="../Images/image00830.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>The <span class="strong"><strong>Advanced</strong></span> section allows you specify the file extension for the backup and the transactional backup file:</p><div class="mediaobject"><img src="../Images/image00831.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>You can optionally choose a unique extension name and configure that to be exempted from the antivirus scan. The general industry wide accepted extension for backups are <code class="literal">bak</code> for the full backups, <code class="literal">diff</code> for differential backups, and <code class="literal">trn</code> for transactional backups.</p></li><li class="listitem">The next screen <a id="id898" class="indexterm"/>allows you to specify the reporting databases. Check the option to include the reporting database in the backup schedule. This will allow you to back up the reporting databases along with the TFS Database backups.</li><li class="listitem">Reporting services needs an encryption key for accessing reports after the database restore, set an encryption key password in the reporting key page and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">You can optionally choose to backup SharePoint databases as well by checking the <span class="strong"><strong>Include SharePoint databases in the backup schedule</strong></span> option.</li><li class="listitem">Click on next to go to the <span class="strong"><strong>Alerts</strong></span> screen. The <span class="strong"><strong>Alert</strong></span> screen can be used to specify the backup scheduled alert settings. You can choose to alert the user on the success or failure of the backup job:<div class="mediaobject"><img src="../Images/image00832.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The schedule backup page allows you to choose from <span class="strong"><strong>Nightly</strong></span>, <span class="strong"><strong>Manual</strong></span>, and <span class="strong"><strong>Custom</strong></span> schedule. The <span class="strong"><strong>Custom</strong></span> schedule gives you more control to set a schedule for the full backup, a differential backup schedule, and the interval for the transactional backup.<div class="mediaobject"><img src="../Images/image00833.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Confirm the settings on<a id="id899" class="indexterm"/> the review page and click on <span class="strong"><strong>Next</strong></span> to trigger the validation checks. Now that the validation has successfully passed, you can click on the <span class="strong"><strong>Configure</strong></span> button to configure the backup per the settings:<div class="mediaobject"><img src="../Images/image00834.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to <code class="literal">\\tfs2015\backup</code> and you'll find the <code class="literal">BackupSets.xml</code>, <code class="literal">BackupSettings.xml</code>, and strong key for the reporting server. Make a copy and store these in a safe location.</li><li class="listitem">You can trigger an ad hoc backup by clicking on the <span class="strong"><strong>Take Full Backup Now</strong></span> link from the Team Foundation Server Administration Console:<div class="mediaobject"><img src="../Images/image00835.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Updates on the backup processing are displayed in a pop-up window. Once the backup completes, you can find the full set available in the network share.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec240"/>How it works...</h2></div></div></div><p>Knowing the classification <a id="id900" class="indexterm"/>and criticality of the data as well as the recover goals of the organization are really useful in working out a backup and recovery strategy for the organization. Certain organizations may have very specific backup needs, which may not be possible to configure via the built-in "schedule backup". The website <a class="ulink" href="http://bit.ly/1IbxBLd">http://bit.ly/1IbxBLd</a> discusses these use cases in length.</p><p>Visual Studio ALM Rangers<a id="id901" class="indexterm"/> have some great guidance on disaster recovery planning for TFS. You can read more about it at <a class="ulink" href="http://bit.ly/1Lwgx2y">http://bit.ly/1Lwgx2y</a>.</p></div></div>
<div class="section" title="Cleaning up unused workspaces and shelvesets in TFS &#x2013; in progress" id="aid-2OM4A1"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec86"/>Cleaning up unused workspaces and shelvesets in TFS – in progress</h1></div></div></div><p>It is common for TFVC<a id="id902" class="indexterm"/> users to create workspaces to temporarily<a id="id903" class="indexterm"/> download files or simply forget to delete<a id="id904" class="indexterm"/> unused shelvesets. As a Team <a id="id905" class="indexterm"/>Foundation Server Administrator, you will benefit from reducing this clutter. The <code class="literal">tf.exe</code> command-line utility has commands for administrating workspaces and shelvesets. In this recipe, you'll learn how to use the <code class="literal">tf.exe</code> utility to delete unused workspaces and shelvesets.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec241"/>Getting ready</h2></div></div></div><p>To modify or delete an existing workspace or shelveset, you must have the global administer workspaces permission set to <span class="strong"><strong>Allow</strong></span>.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec242"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch the<a id="id906" class="indexterm"/> developer command <a id="id907" class="indexterm"/>prompt in the elevated mode.</li><li class="listitem">The following<a id="id908" class="indexterm"/> command will delete the <code class="literal">Win2k12R2_John</code> workspace, which belongs to default collection in TFS. Refer<a id="id909" class="indexterm"/> to <a class="ulink" href="http://bit.ly/1P6mo6t">http://bit.ly/1P6mo6t</a> for more examples on how to use the workspace switch with the <code class="literal">tf.exe</code> command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tf workspace /delete /collection:"http://tfs2015:8080/tfs/defaultcollection" workspacename:"Win2k12R2_John" </strong></span>
</pre></div></li><li class="listitem">Similar to the workspace delete, the shelveset delete follows a similar command pattern. The following command will delete the <code class="literal">Fabrikam_Delta</code> workspace from the default collection in TFS. Refer to <a class="ulink" href="http://bit.ly/1lHChUk">http://bit.ly/1lHChUk</a> for more examples<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>tf shelve /delete shelvesetname:"Fabrikam_Delta" /collection:"http://tfs2015:8080/tfs/defaultcollection"</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec243"/>How it works…</h2></div></div></div><p>The TFS command-line utility (<code class="literal">tf.exe</code>) is installed along with the installation of the Visual Studio. The TFS command-line utility includes switches for various TFS operations that empower TFS Administrators to script these routine operations. You can read more about these operations at <a class="ulink" href="http://bit.ly/1P6mo6t">http://bit.ly/1P6mo6t</a>.</p><p>The build server is the biggest consumer of workspaces. Build definitions that have not been used for a while will retain the workspace and consume large amounts of storage in doing so. Identifying and manually deleting these dead workspaces is a painstaking task. TFS Workspace cleaner is an open source utility hosted on CodePlex that helps you free up storage by deleting workspaces unused in a number of days. You can learn more about this utility at <a class="ulink" href="http://bit.ly/1LxFDhv">http://bit.ly/1LxFDhv</a>.</p></div></div></body></html>