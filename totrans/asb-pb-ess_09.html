<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Encrypting Data with Vault</h1></div></div></div><p>Using variables, we saw how to separate data and code. Often, the data provided is sensitive, for example, user passwords, data base credentials, API keys, and other organization-specific information. Ansible-<a id="id233" class="indexterm"/>playbooks, being a source code, are most commonly stored in version control repositories such as a <strong>git</strong>, which makes it even more difficult to protect this sensitive information in a collaborative environment. Starting with version 1.5, Ansible provides a solution <a id="id234" class="indexterm"/>called <strong>vault</strong> to store and retrieve such sensitive information securely, using proven encryption technologies. The objective of using vault is to encrypt data that can then be stored and shared freely with a version control system, such as git, without the values being compromised.</p><p>In this chapter, we will learn about the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding the Ansible-vault</li><li class="listitem" style="list-style-type: disc">Securing data using the Ansible-vault</li><li class="listitem" style="list-style-type: disc">Encryption, decryption, and rekeying operations</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Ansible-vault</h1></div></div></div><p>Ansible provides a <a id="id235" class="indexterm"/>utility named Ansible-vault, which as the name suggests, lets you manage data securely. The Ansible-vault utility can either let you create an encrypted file by launching an editor interface, or encrypt an existing file. In either case, it will ask for a vault password, which is then used to encrypt the data with the AES cipher. The encrypted contents can be stored in a version control system without being compromised. Since the AES is based on shared secret, the same password needs to be provided for decryption too. To provide the password, there are two options, while launching Ansible, run the <code class="literal">--ask-vault-pass</code> option to prompt for the password, and the <code class="literal">--vault-password-file</code> <a id="id236" class="indexterm"/>option to provide the path to the file that contains the password.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec47"/>Advanced Encryption Standard</h2></div></div></div><p>
<strong>Advanced </strong><a id="id237" class="indexterm"/><strong>Encryption Standard</strong> (<strong>AES</strong>) is an encryption standard based on the <strong>Rijndael</strong> symmetric block cipher, named <a id="id238" class="indexterm"/>after, and developed by, two Belgian cryptographers—Vincent Rijmen and Joan Daemen. Initially, established by (the U.S.) <strong>National Institute of Standards and Technology</strong> (<strong>NIST</strong>) in 2001, AES is an algorithm adopted by the U.S. government to share classified information, and is the most popular symmetric-key cryptography algorithm. AES is also the first publicly accessible open cypher approved by the <strong>National Security Agency</strong> (<strong>NSA</strong>).</p><p>Being an open and popular standard, Ansible uses the AES cypher with a key size of 256 bits to encrypt data with the vault.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec48"/>What to encrypt with the vault? </h2></div></div></div><p>Ansible-vault <a id="id239" class="indexterm"/>can encrypt any structured data. Since YAML itself is a structured language, almost everything that you write for Ansible meets this criteria. The following are the pointers on what can be encrypted with the vault:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Most commonly, we encrypt variables, which can be as follows:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Variable files in roles, for example, <code class="literal">vars</code> and <code class="literal">defaults</code></li><li class="listitem" style="list-style-type: disc">Inventory variables, for example, <code class="literal">host_vars</code>, <code class="literal">group_vars</code></li><li class="listitem" style="list-style-type: disc">Variables files included with <code class="literal">include_vars</code> or <code class="literal">vars_files</code></li><li class="listitem" style="list-style-type: disc">Variable files passed to the Ansible-playbook with the <code class="literal">-e</code> option, for example, <code class="literal">-e @vars.yml</code> or <code class="literal">-e @vars.json</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">Since tasks and handlers are also JSON data, these can be encrypted with the vault. However, this should be rarely practiced. It's recommended that you encrypt variables and reference them in tasks and handlers instead.</li></ul></div><p>The following are the pointers on what cannot be encrypted with the vault:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Since the unit of encryption for the vault is a file, partial files or values cannot be encrypted. You can encrypt the complete file or none of it.</li><li class="listitem" style="list-style-type: disc">Files and templates cannot be encrypted as they may not be similar to JSON or YML.</li></ul></div><p>The following data are a good candidates for encryption:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Credentials, for <a id="id240" class="indexterm"/>example, database passwords and application credentials</li><li class="listitem" style="list-style-type: disc">API keys, for example, AWS access and secret keys</li><li class="listitem" style="list-style-type: disc">SSL keys for web servers</li><li class="listitem" style="list-style-type: disc">Private SSH keys for deployments</li></ul></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Using the Ansible-vault</h1></div></div></div><p>The following table lists <a id="id241" class="indexterm"/>all the subcommands that the Ansible-vault <a id="id242" class="indexterm"/>utility comes with:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Subcommand</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">create</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This creates a encrypted file from scratch using the editor. This needs the editor environment variable set before launching the command.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">edit</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This edits the existing encrypted file with an editor, without decrypting the contents.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">encrypt</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This encrypts an existing file with structured data.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">decrypt</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This decrypts the file. Use this with care and do not commit the decrypted file to version control.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rekey</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This changes the key or password used to encrypt or decrypt.</p>
</td></tr></tbody></table></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec49"/>Encrypting the data</h2></div></div></div><p>Let's perform some <a id="id243" class="indexterm"/>operations using Ansible-vault. We will start by creating an encrypted file. To create a new file from scratch, Ansible-vault uses the <code class="literal">create</code> subcommand. Before using this subcommand, it is important to set an editor in the environment, as follows:</p><div><pre class="programlisting">
<strong># setting up vi as editor</strong>
<strong>$ export EDITOR=vi</strong>
<strong># Generate a encrypted file</strong>
<strong>$ ansible-vault create aws_creds.yml</strong>
<strong>Vault password:</strong>
<strong>Confirm Vault password:</strong>
</pre></div><p>Launching this command opens up an editor specified with the editor environment variable. The following is an example of the <code class="literal">aws_creds.yml</code> file that you may create to store the AWS user credentials in the form of an access key and secret key. These keys are then used to make API <a id="id244" class="indexterm"/>calls to the Amazon web services cloud platform. Saving this file and exiting the editor will generate an encrypted file:</p><div><img src="img/B03800_08_01.jpg" alt="Encrypting the data"/></div><p>You can check the type of file created and its contents by running following commands:</p><div><pre class="programlisting">
<strong># Check file type and content</strong>
<strong>$ file aws_creds.yml</strong>
<strong>aws_creds.yml: ASCII text</strong>
<strong>$ cat aws_creds.yml</strong>
<strong>$ANSIBLE_VAULT;1.1;AES256</strong>
<strong>64616236666362376630366435623538336565393331333331663663636237636335313234313134</strong>
<strong>3337303865323239623436646630336239653864356561640a363966393135316661636562333932</strong>
<strong>61323932313230383433313735646438623032613635623966646232306433383335326566343333</strong>
<strong>3136646536316261300a616438643463656263636237316136356163646161313365336239653434</strong>
<strong>36626135313138343939363635353563373865306266363532386537623463623464376134353863</strong>
<strong>37646638636231303461343564343232343837356662316262356537653066356465353432396436</strong>
<strong>31336664313661306630653765356161616266653232316637653132356661343162396331353863</strong>
<strong>34356632373963663230373866313961386435663463656561373461623830656261636564313464</strong>
<strong>37383465353665623830623363353161363033613064343932663432653666633538</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec50"/>Updating the encrypted data</h2></div></div></div><p>To update the <a id="id245" class="indexterm"/>AWS keys added to the encrypted file, you can later use Ansible-vault's <code class="literal">edit</code> subcommand as follows:</p><div><pre class="programlisting">
<strong>$ ansible-vault edit aws_creds.yml</strong>
<strong>Vault password:</strong>
</pre></div><p>The <code class="literal">edit</code> command does the following operations:</p><div><ol class="orderedlist arabic"><li class="listitem">Prompts for a password</li><li class="listitem">Decrypts a file on the fly using the AES symmetric cypher</li><li class="listitem">Opens the editor interface, which allows you to change the content of a file</li><li class="listitem">Encrypts the file again after being saved</li></ol></div><p>There is another way to update the content of the file. You can decrypt the file as follows:</p><div><pre class="programlisting">
<strong>$ ansible-vault decrypt aws_creds.yml</strong>
<strong>Vault password:</strong>
<strong>Decryption successful</strong>
</pre></div><p>Once updated, this file can then be encrypted again, as you learned earlier.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec51"/>Rotating the encryption keys</h2></div></div></div><p>As a good security <a id="id246" class="indexterm"/>practice, it's a good idea to change encryption keys used with Ansible-vault often. When this happens, it's essential to rekey all the files encrypted earlier using the vault. Ansible vault offers a <code class="literal">rekey</code> subcommand, which can be used as follows:</p><div><pre class="programlisting">
<strong>$ ansible-vault rekey aws_creds.yml</strong>
<strong>Vault password:</strong>
<strong>New Vault password:</strong>
<strong>Confirm New Vault password:</strong>
<strong>Rekey successful</strong>
</pre></div><p>It asks for the current password, and then allows you to specify and confirm your new password. Note that if you <a id="id247" class="indexterm"/>are managing this file with version control, you would also need to commit the change. Even though the actual contents are unchanged, rekeying the operation updates the resulting file that is created, which is part of our repository.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Encrypting the database credentials</h1></div></div></div><p>Earlier while <a id="id248" class="indexterm"/>creating database users, we provided the passwords as plain text in <code class="literal">group_vars</code>. This can be a potential threat, especially when checked into a version control repository. Let's encrypt it. We will use the <code class="literal">encrypt</code> subcommand as we already have a variables file.</p><p>Since we are using the <code class="literal">group_vars</code> group to provide database credentials, we will encrypt the <code class="literal">group_vars/all</code> file as follows:</p><div><pre class="programlisting">
<strong>$ ansible-vault encrypt group_vars/all</strong>
<strong>Vault password:</strong>
<strong>Confirm Vault password:</strong>
<strong>Encryption successful</strong>
</pre></div><p>For encryption, Ansible-vault asks for a password or key to be entered by the user. Using this key, the vault encrypts the data and replaces the file with the encrypted content. The following diagram shows the plain text content on the left and the equivalent encrypted content on the right for the <code class="literal">group_vars/all</code> file:</p><div><img src="img/B03800_08_02.jpg" alt="Encrypting the database credentials"/></div><p>This file now can be safely checked into a version control system and shared. However, the following are <a id="id249" class="indexterm"/>the caveats users should be aware of:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Unlike plain text, the resulting file is an encrypted format. It's not possible to get a different file format, for example, <code class="literal">git diff</code>, to compare the changes while committing to version control.</li><li class="listitem" style="list-style-type: disc">It's not possible to use <code class="literal">grep</code>, <code class="literal">sed</code>, or any text search or manipulation programs on this file directly. The only way to do so is to decrypt it first, run the text manipulation utilities, and encrypt it back.</li></ul></div><div><div><h3 class="title"><a id="tip16"/>Tip</h3><p>Ensure that you use the same password for all the files that you are going to decrypt with one Ansible-playbook run. Ansible can take only one value for the password at a time, and will fail if the files in the same playbook are encrypted using different passwords.</p></div></div><p>Let's now run the Ansible playbook using the following command:</p><div><pre class="programlisting">
<strong>$ ansible-playbook -i customhosts site.yml</strong>
<strong>ERROR: A vault password must be specified to decrypt /vagrant/chap8/group_vars/all</strong>
</pre></div><p>It fails with an error! That's because we are providing the playbook with encrypted data, without the key to decrypt it. The primary use for vault is to secure data while it's in the Ansible repository. Ultimately, these values need to be decrypted while running the playbook. The decryption password <a id="id250" class="indexterm"/>can be specified with the <code class="literal">--ask-vault-pass</code> option, as follows:</p><div><pre class="programlisting">
<strong>$ ansible-playbook -i customhosts site.yml --ask-vault-pass</strong>
</pre></div><p>This will prompt for "Vault Password" and then continue running Ansible code as usual. </p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Using a password file</h1></div></div></div><p>Entering the <a id="id251" class="indexterm"/>password every time may not be ideal. Often at times you may also want to automate the process of launching Ansible playbook runs, in which case, an interactive way is not feasible. This can be avoided by storing the password in a file and providing the file to the Ansible playbook run. The password should be provided as a single line string in this file.</p><p>Let's create a password file and secure it with the correct permissions:</p><div><pre class="programlisting">
<strong>$ echo "password" &gt; ~/.vault_pass</strong>
<strong>(replace password with your own secret)</strong>
<strong>$ chmod 600 ~/.vault_pass</strong>
</pre></div><div><div><h3 class="title"><a id="tip17"/>Tip</h3><p>When the vault password is stored as plain text, anyone who has access to this file can decrypt the data. Make sure the password file is secured with appropriate permissions, and is not added to version control. If you decide to version control it, use <strong>gpg</strong> or equivalent measures.</p></div></div><p>Now this file can be provided to the Ansible playbook, as follows:</p><div><pre class="programlisting">
<strong>$ ansible-playbook -i customhosts site.yml --vault-password-file ~/.vault_pass</strong>
</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec63"/>Adding the vault password file option to the Ansible configuration</h1></div></div></div><p>With <a id="id252" class="indexterm"/>version 1.7, it's also possible to <a id="id253" class="indexterm"/>add the <code class="literal">vault_password_file</code> option to the <code class="literal">ansible.cfg</code> file in the defaults section.</p><p>Consider the following:</p><div><pre class="programlisting">[defaults]
  vault_password_file = ~/.vault_pass</pre></div><p>The preceding option gives you the freedom of not specifying the encryption password or the password file <a id="id254" class="indexterm"/>every time. Let's take a look at the following commands:</p><div><pre class="programlisting">
<strong># launch ansible playbook run with encrypted data</strong>
<strong># with vault_password_file option set in the config</strong>
<strong>$ ansible-playbook -i customhosts site.yml</strong>
<strong>$ ansible-vault encrypt roles/mysql/defaults/main.yml</strong>
<strong>Encryption successful</strong>
<strong>$ ansible-vault decrypt roles/mysql/defaults/main.yml</strong>
<strong>Decryption successful</strong>
</pre></div><p>Moreover, when starting with version 1.7, instead of storing a plain text password in the file, a script can also be provided in the <code class="literal">vault_password_file</code> option. When using the script, ensure that:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The execute <a id="id255" class="indexterm"/>bit is enabled on the script</li><li class="listitem" style="list-style-type: disc">Calling this script outputs a password on the standard output</li><li class="listitem" style="list-style-type: disc">If the script prompts for user inputs, it can be sent to the standard error</li></ul></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec52"/>Using encrypted data in templates</h2></div></div></div><p>You learned <a id="id256" class="indexterm"/>earlier that since a template may not be a structured file such as YAML or JSON, it cannot be encrypted. However, there is a way to add <a id="id257" class="indexterm"/>encrypted data to the templates. Remember, templates are, after all, generated on the fly, and the dynamic content actually comes from variables, which can be encrypted. Let's discuss how to achieve this by adding SSL support for the Nginx web server.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec53"/>Adding SSL support to Nginx</h2></div></div></div><p>We have already set up an <a id="id258" class="indexterm"/>Nginx web server, now let's add SSL support to the <a id="id259" class="indexterm"/>default site by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">We begin by adding the variables, as follows:<div><pre class="programlisting">#file: roles/nginx/defaults/main.yml 
nginx_ssl: true
nginx_port_ssl: 443
nginx_ssl_path: /etc/nginx/ssl
nginx_ssl_cert_file: nginx.crt
nginx_ssl_key_file: nginx.key</pre></div></li><li class="listitem">Let's also create self-signed SSL certificates:<div><pre class="programlisting">
<strong>$ openssl req -x509 -nodes -newkey rsa:2048 -keyout nginx.key -out nginx.crt</strong>
</pre></div><p>The preceding command will generate two files, <code class="literal">nginx.key</code> and <code class="literal">nginx.crt</code>. These are the files that we will have copied over to the web server.</p></li><li class="listitem">Let's add the <a id="id260" class="indexterm"/>contents of these files to the variables, and <a id="id261" class="indexterm"/>create the <code class="literal">group_vars/www</code> file:<div><pre class="programlisting"># file: group_vars/www
---
nginx_ssl_cert_content: |
    -----BEGIN CERTIFICATE-----
    -----END CERTIFICATE-----
nginx_ssl_key_content: |
    -----BEGIN PRIVATE KEY-----
    -----END PRIVATE KEY-----</pre></div><p>In the preceding example, we are just adding placeholders that are to be replaced with the actual contents for the key and certificate. These keys and certificates should not be exposed in a version control system.</p></li><li class="listitem">Let's encrypt this file using the vault:<div><pre class="programlisting">
<strong>$ ansible-vault encrypt group_vars/www</strong>
<strong>Encryption successful</strong>
</pre></div><p>Since we have already provided the path to the vault password in the configuration, the Ansible-vault does not ask for the password.</p></li><li class="listitem">Let's now create the templates, which add these keys:<div><pre class="programlisting"># filename: roles/nginx/templates/nginx.crt.j2
{{ nginx_ssl_cert_content }}

# filename: roles/nginx/templates/nginx.key.j2
{{ nginx_ssl_key_content }}</pre></div></li><li class="listitem">Also, let's add a virtual host <code class="literal">config</code> file to the SSL:<div><pre class="programlisting"># filename: roles/nginx/templates/nginx.key.j2
server {
  listen {{ nginx_port_ssl }};
  server_name {{ ansible_hostname }};
  ssl on;
  ssl_certificate {{ nginx_ssl_path }}/{{ nginx_ssl_cert_file }};
  ssl_certificate_key {{ nginx_ssl_path }}/{{ nginx_ssl_key_file }};

  location / {
    root {{ nginx_root }};
    index {{ nginx_index }};
  }
}</pre></div></li><li class="listitem">We also need to <a id="id262" class="indexterm"/>create a task file to configure the SSL <a id="id263" class="indexterm"/>site, which will create the required directory, files, and configurations:<div><pre class="programlisting">---
# filename: roles/nginx/tasks/configure_ssl.yml
 - name: create ssl directory
    file: path="{{ nginx_ssl_path }}" state=directory owner=root group=root
 - name: add ssl key 
    template: src=nginx.key.j2 dest="{{ nginx_ssl_path }}/nginx.key" mode=0644
 - name: add ssl cert 
    template: src=nginx.crt.j2 dest="{{ nginx_ssl_path }}/nginx.crt" mode=0644
 - name: create ssl site configurations 
    template: src=default_ssl.conf.j2 dest="{{ nginx_ssl_path }}/default_ssl.conf" mode=0644
    notify:
    - restart nginx service</pre></div></li><li class="listitem">Finally, let's call this task selectively based on whether the <code class="literal">nginx_ssl var</code> parameter is set to true:<div><pre class="programlisting"># filename: roles/nginx/tasks/main.yml
 - include: configure_ssl.yml
    when: nginx_ssl</pre></div></li><li class="listitem">Now, run the playbook as follows:<div><pre class="programlisting">
<strong>$ ansible-playbook -i customhosts  site.yml</strong>
</pre></div></li></ol></div><p>This should configure the default SSL site running at port <code class="literal">443</code> with self-signed certificates. Now, you should be able to <a id="id264" class="indexterm"/>open the web server address with the <code class="literal">https</code> <a id="id265" class="indexterm"/>secure protocol as follows:</p><div><img src="img/B03800_08_03.jpg" alt="Adding SSL support to Nginx"/></div><p>Of course, it should show a warning as our certificate is self-signed and not provided by a designated certification authority.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec64"/>Review questions</h1></div></div></div><p>Do you think you've understood the chapter well enough? Try answering the following questions to test your understanding:</p><div><ol class="orderedlist arabic"><li class="listitem">Why is there a need to encrypt the data provided to Ansible playbooks?</li><li class="listitem">What is AES, and what is a symmetric-key cipher?</li><li class="listitem">What are the two methods to update a file previously encrypted with the vault?</li><li class="listitem">What is the parameter that is added to the Ansible configuration file to make it aware of the location of the vault password file?</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec65"/>Summary</h1></div></div></div><p>In this chapter, you learned how to secure the data passed to the playbooks using Ansible-vault. We started with the need to encrypt data, how the vault works, and which cipher it uses. We then started to dive into the Ansible-vault utility and basic operations such as creating encrypted files, decrypting, rekeying, and so on. You also learned how to encrypt existing files by running Ansible-vault on the <code class="literal">vars</code> file holding the database credentials. Finally, we added SSL support to Nginx and you learned how to securely store private keys and certificates for the web server using the vault and copying them using templates. Note that Ansible vault offers a way to provide data to Ansible modules securely. In addition to using the vault, additional system security measures are advised that do not come under the purview of this text.</p><p>After learning about vault, in the next chapter, we will start learning about the various approaches to managing multiple environments such as development, staging, and production with Ansible. These environments typically map to the software development workflow.</p></div></body></html>