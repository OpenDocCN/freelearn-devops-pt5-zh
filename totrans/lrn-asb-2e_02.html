<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-37"><a id="_idTextAnchor080"/>2</h1>
<h1 id="_idParaDest-38"><a id="_idTextAnchor081"/>Exploring Ansible Galaxy</h1>
<p>Welcome to our second chapter. Here, we are going to be looking at the <code>ansible-galaxy</code> command; we are going to be covering the features provided by the command and also discussing its importance in the development of Ansible over the last few years.</p>
<p><strong class="bold">Ansible Galaxy</strong> is an <a id="_idIndexMarker086"/>online repository of community-contributed roles; we will discover some of the best roles available, how to use them, and how to create your own role and have it hosted on Ansible Galaxy.</p>
<p>By the end of the chapter, we will have worked through the following topics:<a id="_idTextAnchor082"/></p>
<ul>
<li>The Ansible release life cycle</li>
<li>Introduction to Ansible Galaxy</li>
<li>What is a role?<a id="_idTextAnchor083"/></li>
<li>Publishing to and using Ansible Galaxy roles</li>
<li>Ansible collections</li>
<li>Ansible Galaxy commands</li>
</ul>
<p>Before we start exploring Ansible Galaxy, let’s discuss the Ansible core release life cycle and how it has changed over the last few years, as these changes have made it an essential component of the Ansible ecosystem.</p>
<h1 id="_idParaDest-39"><a id="_idTextAnchor084"/>Technical requirements</h1>
<p>In this chapter, we will again make use of <strong class="bold">Multipass</strong>, the<a id="_idIndexMarker087"/> tool that we covered in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, and the GitHub repository that accompanies this title, which can be found at <a href="https://github.com/PacktPublishing/Learn-Ansible-Second-Edition">https://github.com/PacktPublishing/Learn-Ansible-Second-Edition</a>.</p>
<h1 id="_idParaDest-40"><a id="_idTextAnchor085"/>The Ansible release life cycle</h1>
<p>In the previous chapter, when we installed Ansible, the keen-eyed among you may have spotted a few different Ansible packages installed using the <code>sudo -H pip install </code><code>ansible</code> command.</p>
<p>What follows is an edited version of the output of installing Ansible using <code>pip</code>:</p>
<pre class="console">
 $ sudo -H pip install ansible
Collecting ansible
  Downloading ansible-8.2.0-py3-none-any.whl (45.1 MB)
Collecting ansible-core~=2.15.2
  Downloading ansible_core-2.15.2-py3-none-any.whl (2.2 MB)
Installing collected packages: resolvelib, packaging, ansible-core, ansible
Successfully installe<a id="_idTextAnchor086"/>d ansible-8.2.0 ansible-core-2.15.2 packaging-23.1 resolvelib-1.0.1</pre> <p>As you can see, two main Ansible packages were installed: <code>ansible-8.2.0</code> and <code>ansible-core-2.15.2</code>. Before we discuss the difference between the two packages, let’s quickly discuss how Ansible was maintained and packaged up until <code>version 2.9</code> of Ansible.</p>
<p>Every version of Ansible before <code>version 2.10</code> shipped with many modules baked into the release; while Ansible was new and its user base and functionality were focused on a few tasks, it was easy to manage and maintain the releases of these modules as part of the main Ansible code base, which was maintained by the Ansible team at the official GitHub repo, which you can find at <a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a>.</p>
<p>By the end of <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, we had used a total of five modules, all of which are built into Ansible; these were the following<a id="_idTextAnchor087"/>:</p>
<ul>
<li><code>ansible.builtin.setup</code>: A <a id="_idIndexMarker088"/>module that discovers information on the target host and makes it available during the playbook run</li>
<li><code>ansible.builtin.service</code>: A <a id="_idIndexMarker089"/>module that manages the state of a service on the target host</li>
<li><code>ansible.builtin.debug</code>: This <a id="_idIndexMarker090"/>module allows you to print statements during your playbook execution</li>
<li><code>ansible.builtin.apt</code>: This <a id="_idIndexMarker091"/>module manages packages on the target host using the <code>apt</code> package manager</li>
<li><code>ansible.builtin.template</code>: This<a id="_idIndexMarker092"/> module brings templating to Ansible, allowing you to output files to your target hosts</li>
</ul>
<p>That was just a single playbook that did a single task; add to that the sheer number of modules to give you an idea of the numbers—there are currently 95 modules in the Amazon AWS namespace and 282 in the Microsoft Azure namespace—that’s over 370 modules that cover the basic functionality of two different namespaces. There are, at the time of writing, over 40 different namespaces.</p>
<p>You might be asking, <em class="italic">“Wait, what is a namespace?”</em> The modules are now grouped into collections, and each collection has its <a id="_idIndexMarker093"/>namespace; some examples are the following:</p>
<ul>
<li><strong class="bold">ansible.builtin</strong>: As you<a id="_idIndexMarker094"/> might have already guessed, the modules within this namespace provide some of Ansible’s core functionality</li>
<li><strong class="bold">amazon.aws</strong>: These are the<a id="_idIndexMarker095"/> official Amazon Web Services modules</li>
<li><strong class="bold">azure.azcollection</strong>: Here, you<a id="_idIndexMarker096"/> will find the official Microsoft Azure modules</li>
<li><strong class="bold">kubernetes.core</strong>: If<a id="_idIndexMarker097"/> you want to work with Kubernetes, these will be your modules</li>
</ul>
<p>Again, you might be thinking, <em class="italic">“That’s useful information, but what has this got to do with anything?”</em>; well, Ansible used to have a few major releases a year and had to ship a release that had slowly grown to include thousands of modules, plus their associated plugins meant that the release process quickly became unmanageable, as the team not only had to worry about the core Ansible code base but also about the modules that shipped with it.</p>
<p>Each <a id="_idIndexMarker098"/>namespace potentially has its dev team comprised of core Ansible contributors, community members, and, in the case of some namespaces, large corporations such as Amazon and Microsoft. Thus, trying to coordinate an Ansible release became a challenge, both in terms of logistics and timing. Some of the technology that Ansible supports changes very fast; for example, both Amazon Web Services and Microsoft Azure introduce new features and add functionality to existing services almost weekly. It didn’t make sense for Ansible to potentially wait up to six months to provide an update that adds compatibility issues, which is why the Ansible team decided it was time to <a id="_idIndexMarker099"/>decouple the release of what is now known as <strong class="bold">Ansible Core</strong>, which is the tooling needed to <a id="_idIndexMarker100"/>run <strong class="bold">Ansible</strong>; this now comprises over 85 name namespace collections, which are made up of well over 1,000 modules and plugins.</p>
<h2 id="_idParaDest-41"><a id="_idTextAnchor088"/>The life cycle of a release</h2>
<p>The release cycle <a id="_idIndexMarker101"/>begins with introducing a new major version of <code>ansible-core</code>, such as <code>ansible-core 2.11</code>. Following this, the latest release of <code>ansible-core</code> and its two preceding versions, <code>ansible-base 2.10</code> and <code>Ansible 2.9</code>, are actively maintained. Development then shifts to the <code>ansible-core</code> are continuously worked on. During this phase, there’s a freeze on adding or updating <strong class="bold">collections</strong> in the <strong class="bold">Ansible </strong><strong class="bold">community</strong> package.</p>
<p>Subsequently, a release candidate for the <strong class="bold">Ansible community</strong> package is introduced. This undergoes testing, and additional release candidates are rolled out if necessary.</p>
<p>Once finalized, a new major version of the <code>ansible-core</code>; for instance, <code>Ansible 4.0.0</code> would be based on <code>ansible-core 2.11</code>. After this release, only the latest version of the <strong class="bold">Ansible community</strong> package remains under active maintenance.</p>
<p>The focus then shifts to <code>ansible-core</code> versions, such as <code>2.11.1</code>, and for the single supported version of the <code>4.1.0</code>.</p>
<p>As the cycle progresses, there’s a feature freeze on <code>ansible-core</code>. This is followed by introducing a release candidate for <code>ansible-core</code>, which undergoes testing. If needed, more release candidates are introduced. Finally, the subsequent major version of <code>ansible-core</code> is released, marking the commencement of a new cycle.</p>
<p>The following chart<a id="_idIndexMarker102"/> provides an overview <a id="_idTextAnchor089"/><a id="_idTextAnchor090"/>of the cycle:</p>
<div><div><img alt="Figure 2.1 – An overview of the Ansible release cycle" src="img/B21620_02_1.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – An overview of the Ansible release cycle</p>
<p>As you can see, this <a id="_idIndexMarker103"/>approach allows the Ansible team to be a lot more flexible with their release schedules and allows a lot more concurrent work on the two different releases.</p>
<p>Now that we have an idea of how Ansible manages its release cycle and also how modules can be packaged, let’s take a look at Ansible Galaxy, which can be used to distribute collections and roles.</p>
<h1 id="_idParaDest-42"><a id="_idTextAnchor091"/>Introduction to Ansible Galaxy</h1>
<p>Most people’s first exposure to <a id="_idIndexMarker104"/>Ansible Galaxy is the website hosted<a id="_idIndexMarker105"/> at <a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a>. The website is home to community-contributed roles and modules:</p>
<div><div><img alt="Figure 2.2 – The Ansible Galaxy home page" src="img/B21620_02_2.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2 – The Ansible Galaxy home page</p>
<p>Throughout the remainder of this book, we will be writing custom roles that interact with the Ansible Core modules for use in our playbook.</p>
<p>More than 15,000 roles are published on Ansible Galaxy; these roles cover many tasks and support almost all the operating systems supported by Ansible.</p>
<p>Then, we have the <code>ansible-galaxy</code> command; this is a way of interacting with the Ansible Galaxy website <a id="_idIndexMarker106"/>from the comfort of your command line, as well as being able to bootstrap roles, which we will look at shortly; we can also use it to download, search, and publish our custom roles on Ansible Galaxy.</p>
<p>Finally, Red Hat has open-sourced the code for <a id="_idIndexMarker107"/>Ansible Galaxy, meaning you can also run a self-hosted version of the site should you need to distribute your roles behind a company firewall.</p>
<p>Before we look at publishing roles and using roles from Ansible Galaxy, let’s discuss what a role means.</p>
<h2 id="_idParaDest-43"><a id="_idTextAnchor092"/>What is a role?</h2>
<p>Throughout the remainder of this book, we will be building custom roles of our own, so this will be just an overview<a id="_idTextAnchor093"/> of what a role<a id="_idIndexMarker108"/> is.</p>
<p>In <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, our final playbook comprised some variables, a handler, four tasks, and a template.</p>
<p>Apart from the template file, all of the code was hardcoded into our playbook file, which, although this makes it easy to read when using a small number of tasks and variables, etc., taking this approach doesn’t make the code very re-useable. Additionally, in later chapters, we could potentially be executing over 50 tasks in a single playbook run, which will make for quite a large, unruly file.</p>
<p>To get around this, Ansible has the concept of roles; they allow you to structure your Ansible code in a way that makes sense logically, for example, grouping tasks that perform a s<a id="_idTextAnchor094"/>ingle job, which, in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, was installing and configuring the NTPD service.</p>
<p>It also means you can drop a role into another playbook by copying the role folder, publishing it, and then pulling it down from Ansible Galaxy.</p>
<p>So, let’s look at creating a basic role based on the tasks, handler, variables, and template from the final playbook we ran at the end of <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and </em><em class="italic">Running Ansible</em>.</p>
<p>To start with, we will need to create the folder and file structure recommended by Ansible for a role; luckily, the <code>ansible-galaxy</code> command has us covered here; by running the following command in the folder where your playbook is going to be stored, it will bootstrap the folder and file structure, which is considered by Red Hat to be a best practice:</p>
<pre class="console">
$ ansible-ga<a id="_idTextAnchor095"/>laxy role init roles/learnansible-example-role</pre> <p>The preceding command will create a folder called <code>roles</code> if one doesn’t already exist, and inside the <code>roles</code> folder, add a second called <code>learnansible-example-role</code>.</p>
<p>The <code>learnansible-example-role</code> folder<a id="_idIndexMarker109"/> contains all the best-practice folder layouts and files needed to be able to publish a role on Ansible Galaxy.</p>
<p>These are as follows:</p>
<ul>
<li><code>README.md</code>: This file contains an outline for you to fill in to provide information on your role; you can use as much or as little as you want of the template. Please note its contents will appear on Ansible Galaxy if you decide to publish your role there, so make it as des<a id="_idTextAnchor096"/>criptive as possible.</li>
<li><code>defaults/main.yml</code>: This YAML file typically contains any default values for your role.</li>
<li><code>files/</code>: This empty folder holds any files that need to be copied for your role to the target hosts during playbook execution.</li>
<li><code>handlers/main.yml</code>: As you may have already guessed by the name of this folder, this YAML file is where you define any handlers your role needs.</li>
<li><code>meta/main.yml</code>: This YAML file, like the <code>README.md</code> file, is only used once the role is published to Ansible Galaxy; here, you can provide your details, any tags you want to add, and define the supported platform and the minimum version of Ansible version your role support.</li>
<li><code>tasks/main.yml</code>: This is the file we will spend most of the time in throughout the rest of the chapters; it is where all of the roles’ tasks are defined.</li>
<li><code>templates/</code>: This is another empty folder; this time, it is here to store your template files.</li>
<li><code>tests/inventory</code> and <code>test.yml</code>: Here, we have a file that contains two files, an inventory file and a test playbook; it is used to run tests on your role.</li>
<li><code>vars/main.yml</code>: Finally, this YAML file contains any variables that you may wish to use, and these override the contents of the <code>defaults/main.yml</code> file, should you need to do so.</li>
</ul>
<p>To populate the <a id="_idIndexMarker110"/>role, I have taken the code from the final playbook and split it across the aforementioned various files; the only change that I made to the playbook itself was to remove the following task, as we don’t need it:</p>
<pre class="source-code">
    - name: "Output some information on our host"
      ansible.builtin.debug:
        msg: "I am connecting to {{ ansible_nodename }} which is running {{ ansible_distribution }} {{ ansible_distribution_versi<a id="_idTextAnchor097"/>on }}"</pre> <p>This leaves the <code>roles/learnansible-example-role/tasks/main.yml</code> file looking like the following code:</p>
<pre class="source-code">
# tasks file for roles/learnansible-example-role
- name: "Update all packages to the latest version"
  ansible.builtin.apt:
    name: "*"
    state: "latest"
    update_cache: true
  tags:
    - "skip_ansible_lint"
- name: "Install packages"
  ansible.builtin.apt:
    state: "present"
    pkg:
      - "ntp"
      - "sntp"
      - "ntp-doc"
- name: "Configure NTP"
  ansible.builtin.template:
    src: "./ntp.conf.j2"
    dest: "/etc/ntp.conf"
    mode: "0644"
  notify: "Restart ntp"</pre> <p>Notice that, as mentioned in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, we have <code>---</code> at the top of the file to show that <code>main.yml</code> is a separate file. As it is in the <code>tasks</code> folder, we do not need to define that it contains tasks by using tasks, as we did in our original playbook.</p>
<p>This patt<a id="_idTextAnchor098"/><a id="_idTextAnchor099"/>ern is followed by the <code>roles/learnansible-example-role/handlers/main.yml</code> file, which <a id="_idIndexMarker111"/>looks like this:</p>
<pre class="source-code">
# handlers file for roles/learnansible-example-role
- name: "Restart ntp"
  ansible.builtin.service:
    name: "ntp"
    state: "r<a id="_idTextAnchor100"/>estarted"</pre> <p>Additionally, this is followed by the <code>roles/learnansible-example-role/vars/main.yml</code> file, which contains the following:</p>
<pre class="source-code">
---
# vars file for roles/learnansible-example-role
ntp_servers:
  - "0.uk.pool.ntp.org"
  - "1.uk.pool.ntp.org"
  - "2.uk.pool.ntp.org"
  - <a id="_idTextAnchor101"/>"3.uk.pool.ntp.org"</pre> <p>The <code>roles/learnansible-example-role/vars/ntp.conf.j2</code> file is an exact copy of the template file we used in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and </em><em class="italic">Running Ansible</em>.</p>
<p>The only addition outside of the <code>README.md</code> file is <code>roles/learnansible-example-role/meta/main.yml</code>. This file, as mentioned, contains all of the information needed to publish the role to Ansible<a id="_idIndexMarker112"/> Galaxy; in our example, this looks like the following:</p>
<pre class="source-code">
galaxy_info:
  role_name: "ansible_role_learnansible_example"
  namespace: "russmckendrick"
  author: "Russ McKendrick"
  description: "Example role to accompany Learn Ansible (Second Edition)"
  issue_tracker_url: "https://github.com/russmckendrick/ansible-role-learnansible-example/issues"
  license: "license (BSD-3-Clause)"
  min_ansible_version: "2.9"
  platforms:
    - name: "Ubuntu"
      versions:
        - "jammy"
  galaxy_tags:
    - "ntp"
    - "time"
    - "example"
dependencies: []</pre> <p>We will revisit this file in the next section of this chapter when it comes to publishing our role to <a id="_idIndexMarker113"/>Ansible Galaxy.</p>
<p>Now that we have everything that we need to run the role in place, we need a playbook to call it; in the <code>Chapter02</code> folder for the repo, which accompanies this title, you will file the roles folder, as described earlier, and a playbook called <code>playbook01.yml</code>, which looks like the following:</p>
<pre class="source-code">
- name: "Run the role locally"
  hosts: "ansible_hosts"
  gather_facts: true
  become: true
  become_method: "ansible.builtin.sudo"
  roles:
    - learnansible_example_role</pre> <p>As you can see, the start of the playbook looks precisely the same as the one we ran at the end of <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>. However, it is missing the <code>vars</code>, <code>handlers</code>, and <code>tasks</code> sections, and instead, we are just using a <code>roles</code> section, which contains the single role found at <code>roles/learnansible-example-role</code>.</p>
<p>In the <code>Chapter02</code> folder, you will find all the files needed to launch a local virtual machine using Multipass.</p>
<p class="callout-heading">Important note</p>
<p class="callout">When running the following commands, create a copy of the <code>hosts.example</code> file and call it <code>hosts</code>; once copied, update the newly created file with the IP address of the newly launched VM, as we did in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and </em><em class="italic">Running Ansible</em>.</p>
<p>To launch the virtual machine, get its IP address and run the playbook using the following commands:</p>
<pre class="console">
$ multipass launch -n ansiblevm --cloud-init cloud-init.yaml
$ multipass info ansiblevm
$ ansible-playbook -i hosts playbook01.yml</pre> <p>This should give you something like<a id="_idTextAnchor102"/> the following output:</p>
<div><div><img alt="Figure 2.3 – Running the playbook using the newly created role" src="img/B21620_02_3.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – Running the playbook using the newly created role</p>
<p>You can stop and delete the VM by using the following two commands:</p>
<pre class="console">
$ multipass stop ansiblevm
$ multipass delete --purge ansiblevm</pre> <p>Now that we know what a role is and have a fundamental one defined, let’s look at publishing our simple <a id="_idIndexMarker114"/>role to Ansible Galaxy and then use it—along with some others—in an Ansible playbook.</p>
<h1 id="_idParaDest-44"><a id="_idTextAnchor103"/>Publishing to and using Ansible Galaxy roles</h1>
<p>Now that we know what a role is and have seen how using them can make our Ansible playbooks a little cleaner and repeatable, we should look at how we can publish our roles to Ansible Galaxy and use them from there in our playbooks.</p>
<h2 id="_idParaDest-45"><a id="_idTextAnchor104"/>Publishing your roles to Ansible Galaxy</h2>
<p>You need <a id="_idIndexMarker115"/>two main prerequisites when publishing your role to <a id="_idIndexMarker116"/>Ansible Galaxy: an active GitHub account, which will be used to authenticate to Ansible Galaxy, and a public GitHub repository containing the code for your role.</p>
<p>In this example, I am going to be using my own GitHub account; you can find me at <a href="http://github.com/russmckendrick/">http://github.com/russmckendrick/</a>. I will be using a repository that can be found at <a href="https://github.com/russmckendrick/ansible-role-learnansible-example/">https://github.com/russmckendrick/ansible-role-learnansible-example/</a>.</p>
<p>To publish your role, you need to take the following steps:</p>
<ol>
<li>Go to the Ansible Galaxy website, which can be found at <a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a>, and click on th<a id="_idTextAnchor105"/>e GitHub logo to log in:</li>
</ol>
<div><div><img alt="Figure 2.4 – Logging in to Ansible Galaxy" src="img/B21620_02_4.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – Logging in to Ansible Galaxy</p>
<ol>
<li value="2">Once logged<a id="_idIndexMarker117"/> in, click on the <strong class="bold">My Content</strong> menu <a id="_idIndexMarker118"/>item, which is represented by the bulleted pointed list icon in the left-h<a id="_idTextAnchor106"/>and side menu as follows:</li>
</ol>
<div><div><img alt="Figure 2.5 – Going to the My Content page" src="img/B21620_02_5.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Going to the My Content page</p>
<ol>
<li value="3">Once on the <strong class="bold">My Content</strong> page, click on the <strong class="bold">+ Add Content</strong> button; here, you<a id="_idTextAnchor107"/> will be given two options: <strong class="bold">Import Role from GitHub</strong> o<a id="_idTextAnchor108"/>r <strong class="bold">Upload </strong><strong class="bold">New Collection</strong>:</li>
</ol>
<div><div><img alt="Figure 2.6 – Adding content options" src="img/B21620_02_6.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – Adding content options</p>
<ol>
<li value="4">Click on <a id="_idIndexMarker119"/>the <strong class="bold">Import Role from GitHub</strong> button, and <a id="_idIndexMarker120"/>you will be presented with a list of your repositories; select the repository containing the role you would like to publish an<a id="_idTextAnchor109"/>d click on the <strong class="bold">OK</strong> button:</li>
</ol>
<div><div><img alt="Figure 2.7 – Choosing the repository containing the role you want to publish" src="img/B21620_02_7.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – Choosing the repository containing the role you want to publish</p>
<ol>
<li value="5">After a few moments, your role will be published, and you will be returned to the <strong class="bold">My Content</strong> page, which should now list yo<a id="_idTextAnchor110"/>ur newly published role:</li>
</ol>
<div><div><img alt="Figure 2.8 – Returning to the My Content page" src="img/B21620_02_8.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8 – Returning to the My Content page</p>
<ol>
<li value="6">Click on the<a id="_idIndexMarker121"/> newly published role name, which will take<a id="_idIndexMarker122"/> you to the A<a id="_idTextAnchor111"/>nsible Galaxy roles page:</li>
</ol>
<div><div><img alt="Figure 2.9 – The newly published Ansible Galaxy roles page" src="img/B21620_02_9.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9 – The newly published Ansible Galaxy roles page</p>
<p>You can find a copy of the role I published during this walk-through at https://galaxy.ansible.com/russmckendrick/ansible_role_learnansible_example.</p>
<p>As you can see, the details in the <code>meta/main.yml</code> file and clicking on the <code>README.md</code> file.</p>
<p>Now that the role has been published, how do we use it in our Ansible playbooks? Let’s find out.</p>
<h2 id="_idParaDest-46"><a id="_idTextAnchor112"/>Using roles from Ansible Galaxy</h2>
<p>The first <a id="_idIndexMarker123"/>thing we need to do before we use the role in our playbook<a id="_idIndexMarker124"/> is to download the role; there are a few ways of doing this; first, you can download the role using the command given on the roles Ansible Galaxy page.</p>
<p>Running the following command w<a id="_idTextAnchor113"/>ill download the role to your Ansible configuration directory:</p>
<pre class="console">
$ ansible-galaxy install russmckendrick.ansible_role_learnansible_example</pre> <p>The Ansible <a id="_idIndexMarker125"/>configuration directory is typically a hidden folder in<a id="_idIndexMarker126"/> your user’s home folder. The shorthand for this folder is <code>~/.ansible</code>, or in my case, the full path to the folder is <code>/Users/russ.mckendrick/.ansible</code>, as you can see in<a id="_idTextAnchor114"/> the following shell output:</p>
<div><div><img alt="Figure 2.10 – Downloading the role from Ansible Galaxy" src="img/B21620_02_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10 – Downloading the role from Ansible Galaxy</p>
<p>The second way to download roles from<a id="_idTextAnchor115"/> Ansible Galaxy is to create a <code>requirements.yml</code> file; this file should contain a list of the roles you wish to download, for example, the <code>requirements.yml</code> file in the <code>Chapter02</code> folder of the repository, which accompanies this book and loo<a id="_idTextAnchor116"/>ks like the following:</p>
<pre class="source-code">
- src: "itnok.update_ubuntu"
- src: "geerlingguy.nginx"
- src: "russmckendrick.ansible_role_learnansible_example"</pre> <p>As you can see, there are three roles defined in there; to install all three, you can run the following comman<a id="_idTextAnchor117"/>d:</p>
<pre class="console">
$ ansible-galaxy install -r requirements.yml</pre> <p>The two others we will download are the following:</p>
<ul>
<li><code>itnok.update_ubuntu</code>: This role manages updates on Ubuntu hosts</li>
<li><code>geerlingguy.nginx</code>: This role helps you download, install, and configure NGINX on multiple Linux distributions</li>
</ul>
<p>You can find links for the roles in the further reading section at the end of the chapter.</p>
<p>This will <a id="_idIndexMarker127"/>download only the missing roles; when I ran the command,<a id="_idTextAnchor118"/> I<a id="_idIndexMarker128"/> got the following output:</p>
<div><div><img alt="Figure 2.11 – Downloading the missing roles from Ansible Galaxy" src="img/B21620_02_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11 – Downloading the missing roles from Ansible Galaxy</p>
<p>As you can see, as <code>russmckendrick.ansible_role_learnansible_example</code> was already present on my machine, it skipped downloading it.</p>
<p>The Ansible playbook called <code>playbook02.yml</code>, which can be found in the <code>Chapter02</code> folder, calls the three roles defined in the <code>requirements.yml</code> file using the following code:</p>
<pre class="source-code">
---
- name: "Run the remote roles"
  hosts: "ansible_hosts"
  gather_facts: true
  become: true
  become_method: "ansible.builtin.sudo"
  roles:
    - "itnok.update_ubuntu"
    - "geerlingguy.nginx"
    - "russmckendrick.ansible_role_learnansible_example"</pre> <p>As before, you can<a id="_idIndexMarker129"/> launch a VM using Multipass (ensuring that you update the IP address in the hosts file) and run the playbook using the following <a id="_idIndexMarker130"/>commands:</p>
<pre class="console">
$ multipass launch -n ansible<a id="_idTextAnchor119"/>vm --cloud-init cloud-init.yaml
$ multipass info ansiblevm
$ ansible-playbook -i hosts playbook02.yml</pre> <p>As you can see from the playbook recap in the following screen, <a id="_idTextAnchor120"/>a lot more happened this time:</p>
<div><div><img alt="Figure 2.12 – Running the playbook, which uses the roles downloaded from Ansible Galaxy" src="img/B21620_02_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12 – Running the playbook, which uses the roles downloaded from Ansible Galaxy</p>
<p>The two additional roles did a more thorough update of the operating system than our role did, installing the NGINX package and starting the service up; this means that if you put the IP address returned by the <code>multipass info ansiblevm</code> command into your browser, you can see the default NGINX page.</p>
<p>Once again, when<a id="_idIndexMarker131"/> ready, you can stop and delete the VM by us<a id="_idTextAnchor121"/>ing <a id="_idIndexMarker132"/>the following two comm<a id="_idTextAnchor122"/>ands:</p>
<pre class="console">
$ multipass stop ansiblevm
$ multipass delete --purge ansiblevm</pre> <p>So now that you understand what an Ansible Role is, how to publish it to Ansible Galaxy, and how to incorporate our own published and community roles into an Ansible playbook, what else can Ansible Galaxy do?</p>
<h1 id="_idParaDest-47"><a id="_idTextAnchor123"/>Ansible collections</h1>
<p>At the start of this chapter, we discussed how the Ansible development team decoupled Ansible Modules away <a id="_idIndexMarker133"/>from Ansible Core and how this affected the release life cycle.</p>
<p>All of these modules, plugins, and other supporting code are available on Ansible Galaxy; for example, the AWS collection from the Amazon namespace can be found at <a href="https://galaxy.ansible.com/amazon/aws">https://galaxy.ansible.com/amazon/aws</a>; you can install the collection using the following command:</p>
<pre class="console">
<a id="_idTextAnchor124"/>$ ansible-galaxy collection install amazon.aws</pre> <p>Running this command will download and install the collection to <code>~/.ansible/collections/ansible_collections/amazon/aws</code>, as seen in the following terminal output:</p>
<div><div><img alt="Figure 2.13 – Installing the amazon.aws collection" src="img/B21620_02_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13 – Installing the amazon.aws collection</p>
<p>However, just having the collection <a id="_idIndexMarker134"/>installed doesn’t mean that you will be able to use it within your playbooks just yet; for example, the Amazon AWS module requires some additional Python libraries to be installed, and typically, each collection will come with a <code>requirements.txt</code> file that lists the required Python libraries that need to be installed on your system for the collections modules and plugins to work.</p>
<p>To install these libraries, you should use pip to install them:</p>
<pre class="console">
$ pip install -r ~/.ansible/collections/ansible_collections/amazon/aws/requirements.txt</pre> <p>Once installed, you will be able to use the modules and plugins which make up the collection.</p>
<h1 id="_idParaDest-48"><a id="_idTextAnchor125"/>Ansible Galaxy commands</h1>
<p>Before finishing this chapter <a id="_idIndexMarker135"/>on Ansible Galaxy, let’s quickly discuss some other useful commands.</p>
<p>The <code>ansible-galaxy</code> command<a id="_idIndexMarker136"/> has some of the basic functionality you would expect, such as the following:</p>
<pre class="console">
$ ansible-galaxy --version
$ ansible-galaxy --help</pre> <p>This displays details of the version and basic help options on the command, respectively.</p>
<p>The <code>ansible-galaxy</code> command is split into two parts, which we have <a id="_idTextAnchor126"/>already touched upon.</p>
<p>First<a id="_idTextAnchor127"/>, there is <code>ansible-galaxy collection</code>; from here, you can add the following commands:</p>
<ul>
<li><code>download</code>: Retrieves <a id="_idIndexMarker137"/>collections and their dependencies, such<a id="_idIndexMarker138"/> as <strong class="bold">tarballs</strong>, which is an archive format for Linux machines for offline installations.</li>
<li><code>init</code>: Set up a new collection with the foundational structure.</li>
<li><code>build</code>: Construct an Ansible collection artifact suitable for publication to Ansible Galaxy.</li>
<li><code>publish</code>: Release a collection artifact to Ansible Galaxy.</li>
<li><code>install</code>: Add collection(s) from the specified file(s), URL(s), or directly from Ansible Galaxy.</li>
<li><code>list</code>: Display the name and version of every collection in the collections path.</li>
<li><code>verify</code>: Contrast the<a id="_idIndexMarker139"/> checksums of the installed collection(s) with those on the server; any dependencies are not verified.</li>
</ul>
<p>Secondly, there<a id="_idIndexMarker140"/> is <code>ansible-galaxy role</code>, as I am sure you will have already<a id="_idIndexMarker141"/> guessed; these commands are for working with roles:</p>
<ul>
<li><code>init</code>: Set up a new role with the foundational structure of a role</li>
<li><code>remove</code>: Erase roles from the specified roles path</li>
<li><code>delete</code>: Remove the role from Galaxy. Note that this does not affect or modify the actual GitHub repository</li>
<li><code>list</code>: Display the name a<a id="_idTextAnchor128"/>nd version of every role in the roles path</li>
<li><code>search</code>: Query the Galaxy database using tags, platforms, authors, and keywords</li>
<li><code>import</code>: Incorporate a role into a Galaxy server</li>
<li><code>setup</code>: Oversee the connection between Galaxy and the designated source</li>
<li><code>info</code>: Obtain detailed information about a particular role</li>
<li><code>install</code>: Add role(s) from specified file(s), URL(s), or directly from Ansible Galaxy</li>
</ul>
<p>For more help on any of these commands, you can append <code>--help</code> to the end. For example, you can run the following:</p>
<pre class="console">
$ ansible-galaxy role search --help</pre> <p>This will give you detailed information on how to search Ansible Galaxy; for example, to search for my roles, you would need to run the following:</p>
<pre class="console">
$ ansible-galaxy role search --author russmckendrick</pre> <p>This returns a list of all of the roles I have published<a id="_idTextAnchor129"/> to Ansible Galaxy, or you could run this:</p>
<pre class="console">
$ ansible-galaxy role list</pre> <p>This lists all the roles you have <a id="_idIndexMarker142"/>installed in the roles path (which is <code>~/.ansible/roles/</code>). From there, you could run something like the following:</p>
<pre class="console">
$ ansible-galaxy role info russmckendrick.ansible_role_learnansible_example</pre> <p>This helps you obtain information on a role you have installed, which concludes our look at the <code>ansible-galaxy</code> command.</p>
<h1 id="_idParaDest-49"><a id="_idTextAnchor130"/>Summary</h1>
<p>In this chapter, we have had an in-depth look at Ansible Galaxy, the website, and the command-line tool. We have also discussed the Ansible development and release cycle and understood what an Ansible Role is.</p>
<p>I am sure that you will agree that Ansible Galaxy offers valuable community services in that it allows users to share roles for everyday tasks and provides a way for users to contribute to the Ansible community by publishing their roles.</p>
<p>However, just be careful. Remember to check the code and read through bug trackers before using roles from Ansible Galaxy in production environments; after all, many roles need escalated privileges to execute their tasks successfully.</p>
<p>As mentioned in this chapter, we will be creating our own Ansible Roles throughout the remainder of this title, and there will be additional hints and tips on creating and using roles as our Ansible playbooks get more and more sophisticated.</p>
<p>In our next chapter, we will look at more Ansible commands and tools that ship as part of Ansible Core.</p>
<h1 id="_idParaDest-50"><a id="_idTextAnchor131"/>Further reading</h1>
<p>You can find more details on the two additional roles that we installed from Ansible Galaxy and the off<a id="_idTextAnchor132"/>icial documentation at the following sites:</p>
<ul>
<li><code>geerlingguy.nginx</code>: <a href="https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/nginx">https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/nginx</a><a href="https://galaxy.ansible.com/geerlingguy/nginx "/></li>
<li><code>itnok.update_ubuntu</code>: <a href="https://galaxy.ansible.com/ui/standalone/roles/itnok/update_ubuntu/">https://galaxy.ansible.com/ui/standalone/roles/itnok/update_ubuntu/</a><a href="https://galaxy.ansible.com/itnok/update_ubuntu "/></li>
<li><strong class="bold">Ansible Galaxy </strong><strong class="bold">Documentation</strong>: <a href="https://ansible.readthedocs.io/projects/galaxy-ng/en/latest/community/userguide/">https://ansible.readthedocs.io/projects/galaxy-ng/en/latest/community/userguide/</a></li>
</ul>
</div>
</body></html>