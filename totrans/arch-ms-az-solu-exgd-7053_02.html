<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Configuring Compute-Intensive Applications</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the Azure Virtual Machine (VM) objective. We covered how to design Azure VMs by discussing the available series and sizes. We also covered how to design for high availability and performance using the various features Azure provides.</span></p>
<p><span>This chapter introduces the compute-intensive applications objective</span>. It will cover how to design high-performance computing (HPC) and other compute-intensive applications using Azure services, how to determine when to use Azure Batch, and how to design stateless components to accommodate scale and containers with Azure Batch.</p>
<p><span>The following topics will be covered:</span></p>
<ul>
<li>High-performance compute virtual machines</li>
<li>Microsoft HPC Pack</li>
<li>Azure Batch</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">High-performance compute virtual machines</h1>
                </header>
            
            <article>
                
<p>Azure offers several virtual machine series and sizes that are designed and optimized for compute-intensive tasks. They are also known as compute-intensive instances. At the time of writing this book, Azure offers the A8-A11, the N-series, and the H-series, which all support HPC workloads. </p>
<p><span>These series and sizes consist of hardware that is designed and optimized for compute-intensive, graphics-intensive, and network-intensive applications. They are best suited for modeling, simulations, and HPC cluster applications: </span></p>
<ul>
<li>The A-series offers <span>RDMA networking, which provides ultra-low-latency and high bandwidth networking.</span></li>
<li>The N-series is aimed at graphics-intensive and compute-intensive applications. They consist of different NVIDIA Tesla GPUs that are well suited for deep learning applications, gaming applications, or virtualization.</li>
<li>The H-series offers virtual machines that are <span>specifically aimed at </span>high performance. They offer fast Intel <span>Xeon </span>processors, <span>SSD-based local storage, and DDR4 memory. These VMs are best suited for HPC workloads, such as batching, modeling, and simulations.</span></li>
</ul>
<div class="packt_infobox">For more information on the hardware specifications of the N-series virtual machines, you can refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-gpu">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-gpu</a>. For more information about h<span>igh-performance VMs, you can refer to the following article: </span><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json</a><span>.</span></div>
<p>The Azure Marketplace offers several virtual machine images that are specifically designed for HPC, such as Azure Data Science VMs for Windows and Linux, D3View, and more. You can navigate to the marketplace using the following URL: <a href="https://azuremarketplace.microsoft.com/en-us/marketplace">https://azuremarketplace.microsoft.com/en-us/marketplace.</a></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Microsoft HPC Pack</h1>
                </header>
            
            <article>
                
<p><span>Microsoft provides an HPC Pack for Windows Server 2012, 2016, and Linux machines. This is a free offering and you can use this to create HPC clusters on your on-premises servers and Azure VMs. </span></p>
<p>You can install HPC Pack on a Windows or Linux Server. These machines will automatically become the head node of the cluster. You can then add additional nodes to the cluster and run a job on it. This job will be distributed across all the available nodes automatically. </p>
<p>It offers the following additional features:</p>
<ul>
<li><strong>Hybrid Cluster</strong>: You can set up hybrid clusters using on-premises servers and Azure VMs</li>
<li><strong>HPC Cluster Manager</strong>: A tool for managing, deploying, and configuring HPC clusters</li>
<li><strong>PowerShell: </strong>You can use HPC PowerShell to manage, configure, deploy, add, and execute jobs on the cluster</li>
</ul>
<p>You can use HPC Pack for designing effective cloud-native HPC solutions and hybrid HPC solutions. Both of these are explained in the following sections.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Cloud-native HPC solutions</h1>
                </header>
            
            <article>
                
<p>A cloud-native HPC solution uses HPC virtual machines and can scale up to thousands of<span> </span><span>instances and </span>compute cores. It uses a head node, several compute nodes, and storage. The following Azure resources can be used to create a cloud-native HPC architecture:</p>
<ul>
<li><strong>HPC head node</strong>: The head node runs in Azure on a Windows or Linux server virtual machine. When you install Azure HPC Pack on this machine, it will become the head node automatically.</li>
<li><span><strong>HPC compute nodes</strong>: The HPC compute nodes are created using A8 and A9 instances. These instances provide RDMA networking, which can be used to achieve high bandwidth and microsecond latencies between the nodes.</span></li>
<li><strong>Virtual Machine Scale Set</strong>: You can place the compute nodes in a <strong>Virtual Machine Scale Set</strong> (<strong>VMSS</strong>) for redundancy and availability. VMs that use RDMA for communicating with each other are placed in the same Availability Set.</li>
<li><strong>Virtual network</strong>:<span> </span>All the Azure resources, such as the head node, the compute nodes, and storage layer, are added to an Azure virtual network.</li>
<li><strong>Storage</strong>: The disks that are used for all the different nodes are stored inside Azure Blob Storage.</li>
<li><strong>ARM templates</strong>: You can use ARM templates to deploy the applications to the nodes.</li>
</ul>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><img src="Images/8c09dd12-1d9e-4aa0-9811-47fb3e5b5bea.jpg" style="width:60.25em;height:41.17em;" width="1250" height="855"/><br/>
<br/>
Cloud-native HPC architecture</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Hybrid HPC architecture</h1>
                </header>
            
            <article>
                
<p>Hybrid HPC architecture uses some of the building blocks that are used for a cloud-native HPC architecture complemented with the on-premises part. The following Azure resources will be used in this scenario:</p>
<ul>
<li><strong>HPC head node</strong>: The head node runs on your on-premises environment. The head node can be installed on a virtual machine in Azure as well, on a Windows or Linux server virtual machine, and just like the cloud-native architecture, you can install Azure HPC Pack on it and it will become the head node automatically.</li>
<li><span><strong>HPC compute nodes</strong>: The HPC compute nodes in your on-premises environment can be Linux or Windows servers with sufficient compute power. The VMs in Azure are created using A8 and A9 instances and provide RDMA networking.</span></li>
<li><strong>Virtual Machine Scale Sets</strong>: You can place the compute nodes in Azure inside a VMSS for redundancy and availability. VMs that use RDMA for communicating with each other are placed in the same availability set.</li>
<li><strong>Virtual network</strong>:<span> </span>The Azure resources, such as the compute nodes and storage layer are added to an Azure virtual network.</li>
<li><strong>ExpressRoute</strong>:<span> </span>ExpressRoute offers a secure and reliable connection between your on-premises environment and Azure. These connections don't go over the public internet but use a private connection, which is usually set up between an ExpressRoute broker and Azure. </li>
<li><strong>VPN Gateway</strong>:<span> </span>A VPN Gateway offers an endpoint between Azure and your on-premises network and enables secure connectivity and communication between the different nodes in the HPC cluster. This connection uses the public internet. </li>
<li><strong>Storage</strong>: The disks that are used for the nodes that are hosted in Azure, are stored inside Azure Blob Storage.</li>
</ul>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><img src="Images/a8c4ce1a-f32a-444f-bb3a-813d06a4b574.jpg" style="width:71.75em;height:39.08em;" width="1783" height="971"/><br/>
<br/>
Hybrid HPC architecture</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Batch</h1>
                </header>
            
            <article>
                
<p>Azure Batch is a service that helps developers scale their workloads over virtual machines (Windows or Linux) or containers, without the need to manage the infrastructure. With Azure Batch, you can run large-scale, parallel and HPC applications <span>efficiently in the cloud. Batch computing is most commonly used for applications that regularly process, transform, or analyze large volumes of data. </span><span>Typically, HPC applications that run on Azure Batch include deep learning applications, image rendering applications, media encoding applications, and Monte Carlo simulations. Azure Media Services uses Azure Batch internally for media encoding as well.</span></p>
<p class="mce-root CDPAlignLeft CDPAlign">The Azure Batch service uses Azure compute as its infrastructure, which means you can use both Windows or Linux VMs to host your applications or workloads. Azure uses the <span>A8/A9 series VMs with RDMA networking internally for the nodes and is fully responsible </span>for creating and managing those virtual machines. Azure adds the nodes<strong> </strong>to a <strong>pool</strong> inside the Azure Batch account. </p>
<p>Inside the Azure Batch account, a <strong>job</strong> can be created that will run the workload on the pool.<strong> </strong>Your workload is then added to the Batch <strong>queue</strong> and split up into several tasks, so they can run in parallel. <span>Azure Batch</span> scales those tasks <span>automatically and they can be scheduled as well. Your workloads, which are called <strong>tasks</strong>, are added to the Batch Queue, spread over the managed pool of virtual machines, and can be scaled automatically. Most of these tasks can run completely independent, but for some HPC workloads, it might be necessary for the tasks to communicate with each other. In that case, Azure Batch uses persistent storage to store output data for retrieval by other tasks. By default, Azure Blob Storage is used for this, but you can use other storage types as well. The tasks communicate with each other using a runtime called <strong>Message Passing Interface</strong> (<strong>MPI</strong>) and the outcome of all these different tasks can be consolidated into a single result:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-345 image-border" src="Images/f82d9264-c26a-4476-ae2f-a284b059f88a.png" style="width:58.50em;height:38.08em;" width="702" height="457"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Azure Batch architecture</div>
<p>To automate the creation of Azure Batch processes, Azure Batch uses a JSON template (not to be confused with an ARM template, this one is different). In this template, you can automate the creation of the Batch pool, including the VM sizes, the operating system, and the number of nodes (the number of VMs). You can use Azure CLI for automation as well.</p>
<p>A Batch pool consists of virtual machines that can be created using images from the Azure Marketplace, cloud services (a standard guest image from Azure), custom images (a custom VHD from a storage account), and specific graphic and rendering images. </p>
<div class="packt_tip">You can use low priority VMs for Azure Batch. This reduces the costs of VMs significantly. This discount is only available for Azure Batch, for all the VM sizes Azure Batch supports, and in all regions. For more information on these prices, you can refer to the following web page: <a href="https://azure.microsoft.com/en-us/pricing/details/batch/">https://azure.microsoft.com/en-us/pricing/details/batch/</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Batch service</h1>
                </header>
            
            <article>
                
<p>In this example, we are going to create a Batch pool from the Azure Portal. This will give you some extra information on the different settings for Azure Batch, such as how to start your applications on the pool of VMs.</p>
<p>To create an Azure Batch pool, you can refer to the following steps:</p>
<ol>
<li>The first step is to create an Azure Batch account in the Azure Portal. You can refer to the following article to create one: <a href="https://docs.microsoft.com/en-us/azure/batch/batch-account-create-portal">https://docs.microsoft.com/en-us/azure/batch/batch-account-create-portal</a>. I've created an Azure Batch account called <span class="packt_screen">packtpub</span> in a <span class="packt_screen">Resource group</span> called <span class="packt_screen">PacktBatchGroup</span>:</li>
</ol>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-346 image-border" src="Images/33fb0bd6-e4a0-489a-b0fa-444198deae7b.png" style="width:95.08em;height:60.08em;" width="1141" height="721"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Azure Batch service</div>
<ol start="2">
<li>Next, click on <span class="packt_screen">Pools</span> in the left-menu and click on <span class="packt_screen">Add</span>.<strong> </strong>Add the following values:<br/>
<ul>
<li><span class="packt_screen">Pool ID</span>: <span class="packt_screen">packtpool1</span></li>
<li><span class="packt_screen">Display name</span>: <span class="packt_screen">PactPool</span></li>
<li><span class="packt_screen">Image Type</span>: <span class="packt_screen">Cloud Services (Windows Only)</span></li>
<li><span class="packt_screen">Node Size</span>: Pick <span class="packt_screen">Standard A1</span></li>
<li><span class="packt_screen">Scale Mode</span>: <span class="packt_screen">Auto Scale</span></li>
<li><span class="packt_screen">Formula</span>: <span class="packt_screen">"$TargetDedicated=0"</span> (you can refer to the following article about <strong>Automatic Scaling Formulas </strong>for more information: <a href="https://docs.microsoft.com/en-us/azure/batch/batch-automatic-scaling">https://docs.microsoft.com/en-us/azure/batch/batch-automatic-scaling</a>)</li>
<li><span class="packt_screen">Start Task</span>: <span class="packt_screen">Disabled</span> (here, you can provide a command for the startup of executables or other workloads)</li>
</ul>
</li>
</ol>
<p style="padding-left: 60px">Leave the other default values for the rest of the settings.</p>
<div class="packt_infobox">For the virtual network settings, you can run your Batch pool inside a VNet. This way, the VMs can communicate with other VMs that are not part of the Batch pool, such as a file server or a license server. </div>
<ol start="3">
<li>Click on <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-347 image-border" src="Images/f7af7184-706c-4196-b40e-982cc0d582c3.png" style="width:34.08em;height:49.33em;" width="1027" height="1485"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Azure Batch pool settings</span></div>
<ol start="4">
<li><span>After creating the Batch pool, you can select </span><span class="packt_screen">Application<span> </span>packages</span><span> from the left-hand menu to upload your executables, libraries, or other metadata that is associated with your application. To upload packages, you have to create or link an Azure Storage account. Application packages are uploaded as ZIP files that consist of all the necessary files. Those files are installed on the VMs automatically by Azure:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign packt_figref"><span><img class="alignnone size-full wp-image-348 image-border" src="Images/21332571-4d49-4227-8bd4-1ae6ea683838.png" style="width:67.83em;height:29.08em;" width="1430" height="613"/></span></p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Azure Batch application packages</span></div>
<ol start="5">
<li>You can also provide the <span class="packt_screen">Start task</span> properties from the left-hand menu as well.</li>
</ol>
<div class="packt_infobox">This is just one way of creating a Batch service. There are more methods that you can use. You can use Visual Studio, call the Batch API directly, or use CLI or PowerShell. </div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Stateless components</h1>
                </header>
            
            <article>
                
<p>Azure Batch uses parallel actions to process the workloads. To fully leverage this capability, applications need to be split up into single and stateless tasks, called multi-instance tasks. By default, a Batch task is executed on a single compute node. By enabling multi-instance tasks, the task is executed on multiple compute nodes. </p>
<p class="CDPAlignCenter CDPAlign CDPAlignLeft">Those <span>multi-instance tasks are submitted to the Batch job and then distributed over the available nodes inside the Batch pool. Azure Batch automatically creates one primary task and several subtasks based on the multi-instance settings. The tasks that run in parallel then use Azure Storage to save and retrieve the data that's used by the different tasks:</span></p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/4615bb0d-05d7-4536-9551-e5b103f9a480.png" style="width:44.42em;height:29.58em;" width="1020" height="679"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Azure Batch jobs and tasks</span><span><br/></span></div>
<p>Those multi-instance tasks can be created in code using the Batch .NET SDK or the Python SDK. </p>
<div class="packt_tip">For more information on creating an Azure Batch Solution using the Batch .NET SDK, you can refer to the following tutorial: <a href="https://docs.microsoft.com/en-us/azure/batch/tutorial-parallel-dotnet">https://docs.microsoft.com/en-us/azure/batch/tutorial-parallel-dotnet</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Containers on Azure Batch</h1>
                </header>
            
            <article>
                
<p>Azure Batch also supports the deployment of containers. You can use Docker containers or Singularity. Singularity is similar to Docker, but it is primary designed to run on shared HPC clusters in on-premises environments a<span>nd super computing installations</span>. <span>Singularity does not require root privileges to execute containers. It allows applications to leverage GPUs and specialized networking within the privilege scope of the executing user. This makes Singularity compatible for permissions-constrained HPC environments. </span><span>Where Docker is originally designed to run Linux containers, Singularity can import Docker images and run Windows containers as well.</span></p>
<p>Singularity can be run from the Azure Cloud Shell without any installation and can be installed from the Azure Batch Shipyard release. This is an <span>open system for enabling simple, configuration-based container execution on Azure Batch. Any knowledge of the Azure Batch .NET SDK is not needed; only configuration files are used here.</span></p>
<div class="packt_tip"><span>For more information on containers on Batch Shipyard, you can refer to the following GitHub page: <a href="https://github.com/Azure/batch-shipyard">https://github.com/Azure/batch-shipyard</a>.</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p><span>In this chapter, we have covered the compute-intensive applications objective. We've covered how to design HPC and other compute-intensive applications using Azure services, how to determine when to use Azure Batch, and how to design stateless components to accommodate scale and Containers on Azure Batch.</span></p>
<p>In the next chapter, we will cover the web application objective.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>You want to create HPC clusters in your on-premises environment. Should you use Azure Batch?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>
<ol start="2">
<li>For creating high-performance compute VMs, should we use the H-series?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li><span>To automate the creation of Azure Batch processes, should we use ARM templates?</span>
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that are covered in this chapter:</span></p>
<ul>
<li><strong>High performance compute VM sizes</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json</a></li>
<li><strong>Options with HPC Pack to create and manage a cluster for Windows HPC workloads in Azure</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/hpcpack-cluster-options">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/hpcpack-cluster-options</a></li>
<li><strong>Batch Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/batch/">https://docs.microsoft.com/en-us/azure/batch/</a></li>
<li><strong>HPC, Batch, and Big Compute solutions using Azure VMs</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/high-performance-computing">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/high-performance-computing</a></li>
<li><strong>Deploy applications to compute nodes with Batch application packages</strong>: <a href="https://docs.microsoft.com/en-us/azure/batch/batch-application-packages">https://docs.microsoft.com/en-us/azure/batch/batch-application-packages</a></li>
<li><strong>Solution architecture: On-premises HPC implementation bursting to Azure</strong>: <a href="https://azure.microsoft.com/en-us/solutions/architecture/hpc-on-prem-burst/">https://azure.microsoft.com/en-us/solutions/architecture/hpc-on-prem-burst/</a></li>
<li><strong>Solution architecture: HPC cluster deployed in the cloud</strong>: <a href="https://azure.microsoft.com/en-us/solutions/architecture/hpc-cluster/">https://azure.microsoft.com/en-us/solutions/architecture/hpc-cluster/</a></li>
<li><strong>Solution architecture: Big compute solutions as a service</strong>: <a href="https://azure.microsoft.com/en-us/solutions/architecture/hpc-big-compute-saas/">https://azure.microsoft.com/en-us/solutions/architecture/hpc-big-compute-saas/</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>