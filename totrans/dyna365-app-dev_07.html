<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Develop Apps using Web API</h1>
                </header>
            
            <article>
                
<p>Web API is a new feature, introduced for the first time for Dynamics CRM 2016. You can use Dynamics 365 Web API with different programming languages, multiple platforms, and devices. Web API in Dynamics 365 uses <strong>Open Data Protocol</strong> (<strong>OData</strong>), also known as OData version 4. As Dynamics 365 Web API is built on open standards, it is not necessary to use any assemblies.</p>
<p>With Dynamics 365, <strong>Organization Data Service</strong> was deprecated and was replaced with Web API. The main purpose of the API is to provide parity with organization services and try to reduce as many constraints as possible.</p>
<p>The following are the characteristics of Web API:</p>
<ul>
<li>It implements OData version 4.0 for building and consuming RESTful APIs over rich data sources such as DOC, HTML, and PDF</li>
<li>It supports a wide variety of programming languages such as .Net, C++, Java, Python, devices, and platforms</li>
<li>Request and response have JSON format</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting started with Dynamics 365 Web API (client-side JavaScript)</h1>
                </header>
            
            <article>
                
<p>Dynamics 365 Web API can be called and accessed using JavaScript. You can use Web API with HTML web resources, form scripts, and ribbon commands to perform various operations on data.</p>
<p>Web API is very convenient to use with JavaScript as it returns results in the form of JSON objects that can be easily converted to JavaScript objects.</p>
<p>In Dynamics 365, Web API is used mainly with HTML web resources and in Single Page Applications.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">JavaScript web resources</h1>
                </header>
            
            <article>
                
<p>The main benefit of using Web API in JavaScript web resources is that you will not need to authenticate because web resources are a part of the application and can be accessed by authenticated users only. You can directly write a code for Web API operations in the JavaScript web resource, and perform operations.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Single Page Applications</h1>
                </header>
            
            <article>
                
<p>Single Page Applications are capable of making Dynamics 365 Web API calls. They consists of many JavaScript libraries that are running on browsers, which authenticate the Dynamics 365 API using <strong>Cross-Origin Resource Sharing</strong> (<strong>CORS</strong>).</p>
<p>While using JavaScript in a Single Page Application, the <kbd>adal.js</kbd> library is used to allow the user to authenticate and to access Dynamics 365 from a hosted web app. You must also integrate an authorization header that contains an authentication token.</p>
<p>Further on, in this chapter, we will look through some examples that use Web API for performing CRUD operations using web resources.</p>
<p>Dynamics 365 Web API uses <kbd>XMLHttpRequest</kbd> object to perform operations.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Working with XMLHttpRequest in Dynamics 365 Web API</h1>
                </header>
            
            <article>
                
<p><strong>XMLHttpRequest</strong> (<strong>XHR</strong>) is a native object supported by all browsers, which enables AJAX techniques for making web pages dynamic.</p>
<p>We will look at a very simple example that uses a Web API and <kbd>XMLHttpRequest</kbd> object.</p>
<p>The following is the Web API code that will fetch all the opportunities:</p>
<pre>    var req = new XMLHttpRequest();<br/>    req.open("GET", Xrm.Page.context.getClientUrl() +   <br/>    "/api/data/v8.2/opportunities()", true);<br/>    req.setRequestHeader("OData-MaxVersion", "4.0");<br/>    req.setRequestHeader("OData-Version", "4.0");<br/>    req.setRequestHeader("Accept", "application/json");<br/>    req.setRequestHeader("Content-Type",<br/>    "application/json; charset=utf-8");<br/>    req.setRequestHeader("Prefer", "odata.include-annotations="*"");<br/>    req.onreadystatechange = function() {<br/>      if (this.readyState === 4) {<br/>        req.onreadystatechange = null;<br/>        if (this.status === 200) {<br/>          var result = JSON.parse(this.response);<br/>          var opportunityid = result["opportunityid"];<br/>        } else {<br/>        Xrm.Utility.alertDialog(this.statusText);<br/>       }<br/>      }<br/>    };<br/>    req.send();</pre>
<p>In the preceding code, you will notice that after initializing a new <kbd>XMLHttpRequest</kbd> object, you need to open it before sending or setting any properties for it. The parameters of an <kbd>open</kbd> method are an HTTP request method (<kbd>GET</kbd>, <kbd>PUT</kbd>, <kbd>POST</kbd>, <kbd>DELETE</kbd>, and so on), a URL, and a Boolean parameter that indicates whether the operation is to be performed asynchronously.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Web API URL and versions</h1>
                </header>
            
            <article>
                
<p>A Web API URL consists of the following:</p>
<ul>
<li><strong>Protocol</strong>: A protocol in HTTP request can be <kbd>http://</kbd> or <kbd>https://</kbd>.</li>
<li><strong>Base URL</strong>: A base URL is nothing but the URL of your current organization that can be retrieved using the function—<kbd>Xrm.Page.context.getClientUrl()</kbd>.</li>
<li><strong>Web API path</strong>: Web API path in Dynamics 365 is API/data.</li>
<li><strong>Version</strong>: It is the version of Web API for Dynamics 365. The latest version is 9.0.</li>
<li><strong>Resource</strong>: A resource can be the name of the entity, function, or an action you want to perform.</li>
</ul>
<p>The URL used in the preceding example is <kbd>Xrm.Page.context.getClientUrl() + "/api/data/v8.2/opportunities()</kbd>.</p>
<p>HTTP request also supports various <strong>HTTP methods</strong> described as follows:</p>
<ul>
<li><kbd>GET</kbd>: It is used for retrieving data; the status code for a successful call is <kbd>200 OK</kbd></li>
<li><kbd>POST</kbd>: It is used for the creation of new records</li>
<li><kbd>PATCH</kbd>: It is used for updating or performing <kbd>upsert</kbd> operations on entity records</li>
<li><kbd>DELETE</kbd>: It is used for deletion of records</li>
<li><kbd>PUT</kbd>: It is used when updating individual properties of an entity record</li>
</ul>
<p>For HTTP Request, various HTTP headers are also used that are described as follows:</p>
<p>Dynamics 365 supports only JSON format. So, these following headers can be used with Dynamics 365 Web API<span>.</span></p>
<p>For every request, you must include the <kbd>Accept</kbd> header value of <kbd>application/json</kbd>, which returns body, even in the case of no response. If there is an error, it will be returned in JSON format. Your code can work without this header, but it is a best practice to use it with your request.</p>
<p>You must always include headers, <kbd>OData-Version</kbd> and <kbd>OData-Max-Version</kbd> set to a value of 4.0. The current version of OData is 4.0, but to avoid ambiguity about OData versions in future, you should have these headers included in your request.</p>
<p>The properties that do not include any recent changes may include cached data. So, to override browser caching of Web API requests, you must include the <kbd>If-None-Match: null</kbd> header in the request body<strong>.</strong></p>
<p>After getting a basic idea about Web API in Dynamics 365, we will move toward performing various operations using Web API. We will also learn how to create, retrieve, update, and delete an entity record using a Web API request. We will also go through associate and disassociate request examples.</p>
<p>Therefore, at least the following HTTP headers should be included:</p>
<ul>
<li><kbd>Accept: application/json</kbd></li>
<li><kbd>OData-MaxVersion: 4.0</kbd></li>
<li><kbd>OData-Version: 4.0</kbd></li>
<li><kbd>If-None-Match: null</kbd></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Querying data using Dynamics 365 Web API</h1>
                </header>
            
            <article>
                
<p>While retrieving data from Dynamics 365, you can set various criteria for the data you need and can apply various filters for retrieving specific data. For this, we will look at an example for querying data, using Web API from Dynamics 365:</p>
<ol>
<li>In this example, we will use <kbd>$set</kbd> and <kbd>$top</kbd> system query options to return the <kbd>firstname</kbd> property of the first five contacts:</li>
</ol>
<pre style="padding-left: 60px">   Request: GET [Organization URI] /api/data/v9.0/contacts? <br/>    $select=firstname&amp;$top=5<br/>    Accept: application/json<br/>    OData-MaxVersion: 4.0<br/>    OData-Version: 4.0</pre>
<p style="padding-left: 60px">The response to the preceding request will be as follows:</p>
<pre style="padding-left: 60px">    {<br/>      "@odata.context":  "https://biocondev3.crm8.dynamics.com<br/>      /api/data/v9.0/$metadata#contacts(firstname)",<br/>      "value": [<br/>      {<br/>        "@odata.etag": "W/"684628"",<br/>        "firstname": null,<br/>        "contactid": "ade1d0f5-28ed-e711-a95e-000d3af27347"<br/>      },<br/>      {<br/>        "@odata.etag": "W/"679541"",<br/>        "firstname": null,<br/>        "contactid": "fa420510-85ec-e711-a95f-000d3af27534"<br/>      },<br/>      {<br/>        "@odata.etag": "W/"679547"",<br/>        "firstname": "C",<br/>        "contactid": "94cd4c79-85ec-e711-a95f-000d3af27534"<br/>      },<br/>      {<br/>        "@odata.etag": "W/"679575"",<br/>        "firstname": null,<br/>        "contactid": "e8f5339f-88ec-e711-a95f-000d3af27534"<br/>      },<br/>      {<br/>        "@odata.etag": "W/"681230"",<br/>        "firstname": null,<br/>        "contactid": "fc71e9b9-a2ec-e711-a95f-000d3af27534"<br/>      }<br/>    ]<br/>   }</pre>
<ol start="2">
<li>In the next example, we will look at how to limit the number of entity records returned for any request. The maximum number of records that can be returned is 5,000. You cannot retrieve more than 5,000 records in Dynamics 365:</li>
</ol>
<pre style="padding-left: 60px">Request: GET [Organization URI]/api/data/v9.0/accounts?$select=nameHTTP/1.1<br/>Accept: application/json<br/>OData-MaxVersion: 4.0<br/>OData-Version: 4.0<br/>Prefer: odata.maxpagesize=3</pre>
<p style="padding-left: 30px">The response to the preceding request will be as follows:</p>
<pre style="padding-left: 60px">{<br/>"@odata.context": "https://biocondev3.crm8.dynamics.com/api/data/v9.0/$metadata#contacts(firstname)",<br/>"value": [<br/>{<br/>"@odata.etag": "W/"684628"",<br/>"firstname": null,<br/>"contactid": "ade1d0f5-28ed-e711-a95e-000d3af27347"<br/>},<br/>{<br/>"@odata.etag": "W/"679541"",<br/>"firstname": null,<br/>"contactid": "fa420510-85ec-e711-a95f-000d3af27534"<br/>},<br/>{<br/>"@odata.etag": "W/"679547"",<br/>"firstname": "C",<br/>"contactid": "94cd4c79-85ec-e711-a95f-000d3af27534"<br/>}<br/>]<br/>}</pre>
<ol start="3">
<li>Now, we will see how to apply system query options to query data using Dynamics 365 Web API. The first query option is appended after [<kbd>?</kbd>] and every proceeding option is separated using [<kbd>&amp;</kbd>]. Query options are case sensitive.</li>
</ol>
<p>In the next query, we will select the <kbd>firstname</kbd> and <kbd>lastname</kbd> of a contact whose age is less than <kbd>50</kbd>:</p>
<pre>GET [Organization URI]/api/data/v9.0/contacts?$select=firstname,lastname&amp;$top=3&amp;$filter=age lt 50</pre>
<p>The standard filter operators used in Dynamics 365 Web API are as follows:</p>
<table class="table">
<tbody>
<tr>
<td>
<p><strong>Operator</strong></p>
</td>
<td>
<p><strong>Description</strong></p>
</td>
<td>
<p><strong>Example</strong></p>
</td>
</tr>
<tr>
<td>
<p><strong>Comparison operators</strong></p>
</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>
<p><kbd>Eq</kbd></p>
</td>
<td>
<p>Equal</p>
</td>
<td>
<p><kbd>$filter=age eq 50</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Ne</kbd></p>
</td>
<td>
<p>Not equal</p>
</td>
<td>
<p><kbd>$filter=age ne 50</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Gt</kbd></p>
</td>
<td>
<p>Greater than</p>
</td>
<td>
<p><kbd>$filter=age gt 50</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Ge</kbd></p>
</td>
<td>
<p>Greater than or equal</p>
</td>
<td>
<p><kbd>$filter=age ge 50</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Lt</kbd></p>
</td>
<td>
<p>Less than</p>
</td>
<td>
<p><kbd>$filter=age lt 50</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Le</kbd></p>
</td>
<td>
<p>Less than or equal</p>
</td>
<td>
<p><kbd>$filter=age le 50</kbd></p>
<p> </p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>The logical operators are as follows:</p>
<table class="table">
<tbody>
<tr>
<td>
<p><strong>Operator</strong></p>
</td>
<td>
<p><strong>Description</strong></p>
</td>
<td>
<p><strong>Example</strong></p>
</td>
</tr>
<tr>
<td>
<p><strong>Logical operators</strong></p>
</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>
<p><kbd>And</kbd></p>
</td>
<td>
<p>Logical and</p>
</td>
<td>
<p><kbd>$filter=age lt 50 and age gt 20</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Or</kbd></p>
</td>
<td>
<p>Logical or</p>
</td>
<td>
<p><kbd>$filter=contains(firstname,'(sample)') or contains(firstname,'test')</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Not</kbd></p>
</td>
<td>
<p>Logical negation</p>
</td>
<td>
<p><kbd>$filter=not contains(firstname,'sample')</kbd></p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p>The grouping operators are as follows:</p>
<table class="table">
<tbody>
<tr>
<td>
<p><strong>Grouping operators</strong></p>
</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>
<p><kbd>( )</kbd></p>
</td>
<td>
<p>Precedence grouping</p>
</td>
<td>
<p><kbd>(contains(firstname,'sample') or contains(firstname,'test')) and age gt 50</kbd></p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Standard query options</h1>
                </header>
            
            <article>
                
<p>The OData string query functions supported by Web API are as follows:</p>
<table class="table">
<tbody>
<tr>
<td>
<p><strong>Function</strong></p>
</td>
<td>
<p><strong>Example</strong></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Contains</kbd></p>
</td>
<td>
<p><kbd>$filter=contains(firstname,'(sample)')</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>Endswith</kbd></p>
</td>
<td>
<p><kbd>$filter=endswith(firstname,'Inc.')</kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd>startswith</kbd></p>
</td>
<td>
<p><kbd>$filter=startswith(firstname,'a')</kbd></p>
</td>
</tr>
</tbody>
</table>
<p> </p>
<p><strong>Order by query</strong>:</p>
<p>You can order the records in ascending or descending order. The following example shows how to order records:</p>
<pre>GET [Organization URI]/api/data/v9.0/contacts?$select=firstname,age,&amp;$orderby=age asc,firstname desc&amp;$filter=age ne null</pre>
<p>Now, after learning to query using Dynamics 365 Web API, we will go through CRUD operations. We will look through some examples of performing these operations.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">CRUD operations using Dynamics 365 Web API</h1>
                </header>
            
            <article>
                
<p>We will look at some basic examples for creating, updating, retrieving, and deleting an entity.</p>
<p><strong>Create an entity</strong></p>
<p>The following is a code for Web API that creates a new record for the <kbd>entity</kbd> account. For that first, we will create a JSON object and set the required properties:</p>
<pre style="padding-left: 60px">//Creates a JSON object for an Entity to be created.<br/>var entity = {};<br/>//Sets the properties for entity.<br/>entity.accountnumber = "AC1009348YU";<br/>entity.name = "Shree Technosoft";<br/>entity.telephone1 = "9978759612";<br/>var req = new XMLHttpRequest();<br/>req.open("POST", Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts", true);<br/>req.setRequestHeader("OData-MaxVersion", "4.0");<br/>req.setRequestHeader("OData-Version", "4.0");<br/>req.setRequestHeader("Accept", "application/json");<br/>req.setRequestHeader("Content-Type", "application/json; charset=utf-8");<br/>req.onreadystatechange = function() {<br/>  if (this.readyState === 4) {<br/>    req.onreadystatechange = null;<br/>    if (this.status === 204) {<br/>      var uri = this.getResponseHeader("OData-EntityId");<br/>      var regExp = /(([^)]+))/;<br/>      var matches = regExp.exec(uri);<br/>      var newEntityId = matches[1];<br/>    } else {<br/>      Xrm.Utility.alertDialog(this.statusText);<br/>     }<br/>   }<br/>  };<br/>  req.send(JSON.stringify(entity));</pre>
<p><strong>Retrieving list of entity records</strong></p>
<p>Next, we will retrieve a list of accounts from Dynamics 365 using a Web API request. The following is the code for retrieving a list of entities:</p>
<pre style="padding-left: 60px">var req = new XMLHttpRequest();<br/>req.open("GET", Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts?$select=accountid,accountnumber,accountratingcode,telephone1", true);<br/>req.setRequestHeader("OData-MaxVersion", "4.0");<br/>req.setRequestHeader("OData-Version", "4.0");<br/>req.setRequestHeader("Accept", "application/json");<br/>req.setRequestHeader("Content-Type", "application/json; charset=utf-8");<br/>req.onreadystatechange = function() {<br/>  if (this.readyState === 4) {<br/>    req.onreadystatechange = null;<br/>    if (this.status === 200) {<br/>      var results = JSON.parse(this.response);<br/>      for (var i = 0; i &lt; results.value.length; i++) {<br/>        var accountid = results.value[i]["accountid"];<br/>        var accountnumber = results.value[i]["accountnumber"];<br/>        var accountratingcode = results.value[i]<br/>        ["accountratingcode"];<br/>        var telephone1 = results.value[i]["telephone1"];<br/>     }<br/>   } else {<br/>       Xrm.Utility.alertDialog(this.statusText);<br/>     }<br/>   }<br/>  };<br/>  req.send();<br/>  The response for the above code will be as below:<br/>  {<br/>    "@odata.context":    "https://demoorg3.crm8.dynamics.com/api/<br/>    data/v8.2/$metadata#accounts<br/>    (accountid,accountnumber,accountratingcode,telephone1)",<br/>    "value": [<br/>    {<br/>      "@odata.etag": "W/"671215"",<br/>      "accountid": "9252cd68-e9e3-e711-a95e-000d3af27163",<br/>      "accountnumber": "DR567821X",<br/>      "accountratingcode": 1,<br/>      "telephone1": null<br/>   },<br/>   {<br/>     "@odata.etag": "W/"677922"",<br/>     "accountid": "e771ecea-edea-e711-a95f-000d3af27534",<br/>     "accountnumber": "DR9888900RR",<br/>     "accountratingcode": 1,<br/>     "telephone1": null<br/>   },<br/>   {<br/>     "@odata.etag": "W/"707246"",<br/>     "accountid": "2de6ad4f-0ef1-e711-a95e-000d3af278ae",<br/>     "accountnumber": "AC1009348YU",<br/>     "accountratingcode": 1,<br/>     "telephone1": "9978759612"<br/>   },<br/>   {<br/>     "@odata.etag": "W/"684666"",<br/>     "accountid": "493d50f5-28ed-e711-a95e-000d3af27fd9",<br/>     "accountnumber": "DR7845699AS",<br/>     "accountratingcode": 1,<br/>     "telephone1": null<br/>   }<br/>  ]<br/> }</pre>
<p>These retrieved objects can be easily converted to JavaScript objects. These objects can be assigned to a JavaScript array and can be used for further operations.</p>
<p><strong>Update an entity record</strong></p>
<p>Now, we will update an <kbd>entity</kbd> record. For updating a record, you will need to pass the GUID of the record you want to update and also a JSON object that consists of fields to be updated. Here, we will update <kbd>email</kbd> and <kbd>city</kbd> for an account record:</p>
<pre style="padding-left: 60px">var entity = {};<br/>entity.emailaddress1 = "contact@shreetech.in";<br/>entity.address1_city = "Mumbai";<br/>var req = new XMLHttpRequest();<br/>req.open("PATCH", Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts(2de6ad4f-0ef1-e711-a95e-000d3af278ae)", true);<br/>req.setRequestHeader("OData-MaxVersion", "4.0");<br/>req.setRequestHeader("OData-Version", "4.0");<br/>req.setRequestHeader("Accept", "application/json");<br/>req.setRequestHeader("Content-Type", "application/json; charset=utf-8");<br/>req.onreadystatechange = function() {<br/>  if (this.readyState === 4) {<br/>    req.onreadystatechange = null;<br/>    if (this.status === 204) {<br/>      //Success - No Return Data - Do Something<br/>    } else {<br/>      Xrm.Utility.alertDialog(this.statusText);<br/>    }<br/>   }<br/> };<br/> req.send(JSON.stringify(entity));</pre>
<p><strong>Delete an entity record</strong></p>
<p>For deleting an <kbd>entity</kbd> record, you will need to pass the GUID of the record to be deleted. The following is the code to delete an account <kbd>entity</kbd> record from Dynamics 365:</p>
<pre style="padding-left: 60px">var req = new XMLHttpRequest();<br/>req.open("DELETE", Xrm.Page.context.getClientUrl() + "/api/data/v8.2/accounts(2de6ad4f-0ef1-e711-a95e-000d3af278ae)", true);<br/>req.setRequestHeader("Accept", "application/json");<br/>req.setRequestHeader("Content-Type", "application/json; charset=utf-8");<br/>req.setRequestHeader("OData-MaxVersion", "4.0");<br/>req.setRequestHeader("OData-Version", "4.0");<br/>req.onreadystatechange = function () {<br/>  if (this.readyState === 4) {<br/>    req.onreadystatechange = null;<br/>    if (this.status === 204 || this.status === 1223) {<br/>      //Success - No Return Data - Do Something<br/>    } else {<br/>      Xrm.Utility.alertDialog(this.statusText);<br/>    }<br/>  }<br/>};<br/>req.send();</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Impersonation in Dynamics 365 Web API</h1>
                </header>
            
            <article>
                
<p>When you want to execute business logic on behalf of another user, then you will need to use impersonation. Sometimes, there are some processes or business logic on behalf of a particular Dynamics 365 user that has the appropriate security role of that user; for such requirements, impersonation is very useful.</p>
<div class="packt_tip">In the code, whenever you need to create a record on behalf of another user, you will use this feature. For that, you will need two user accounts. To use impersonation you will need to add one header named <kbd>MSCRMCallerID</kbd> with a GUID value that is equal to the user's system user ID as shown in the next request.</div>
<p>Please refer to the following code:</p>
<pre style="padding-left: 60px"><strong>Request</strong><br/>POST [Organization URI]/api/data/v9.0/contacts HTTP/1.1<br/>MSCRMCallerID: 9ba9f608-514e-49fd-81cd-84537a31f68e<br/>Accept: application/json<br/>Content-Type: application/json; charset=utf-8<br/>OData-MaxVersion: 4.0<br/>OData-Version: 4.0<br/>{"name":"Contact created using impersonation"}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Retrieving metadata using Web API</h1>
                </header>
            
            <article>
                
<p>Microsoft Dynamics 365 is a metadata-driven application, where you will need to query metadata for some scenarios and specific requirements. Dynamics 365 Web API supports querying metadata. We will use the <kbd>EntityDefinitions</kbd> entity to retrieve the metadata of the <kbd>contact</kbd> entity.</p>
<p>The following is the request to query metadata:</p>
<pre style="padding-left: 60px">GET [OrgURL]/api/data/v8.2/EntityDefinitions(LogicalName='contact')/Attributes"<br/>Following is the Sample code for querying metadata for Contact Entity:<br/>var req = new XMLHttpRequest();<br/>//Opens request<br/>req.open("GET", window.parent.Xrm.Page.context.getClientUrl() + "/api/data/v8.2/EntityDefinitions(LogicalName='contact')/Attributes", true);<br/>//Sets request Headers<br/>req.setRequestHeader("OData-MaxVersion", "4.0");<br/>req.setRequestHeader("OData-Version", "4.0");<br/>req.setRequestHeader("Accept", "application/json");<br/>req.setRequestHeader("Content-Type", "application/json; charset=utf-8");<br/>req.setRequestHeader("Prefer", "odata.include-annotations="*"");<br/>//Function to detect ready state change<br/>req.onreadystatechange = function () {<br/>  if (this.readyState === 4) {<br/>    req.onreadystatechange = null;<br/>    //Check if request completed successfully<br/>    if (this.status === 200) {<br/>      var result = JSON.parse(this.response);<br/>      var index = 1;<br/>      for (var i = 0; i &lt; result.value.length; i++) {<br/>        //Gets schemaname from response.<br/>        var schemaName = result.value[i].SchemaName;<br/>      }<br/>    }<br/>    else {<br/>      Xrm.Utility.alertDialog(this.statusText);<br/>    }<br/>   }<br/> };<br/> req.send();<br/>});</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Updates for Web API in Dynamics 365 in version 9.0</h1>
                </header>
            
            <article>
                
<p>Now, in the newly released version 9.0 for Dynamics 365, there are many remarkable changes made to querying data and performing various operations using Dynamics 365 Web API. With the new release, we will not need to create any requests for using Web API, instead, you will use built-in and pre-defined functions for using Web API.</p>
<p>Using Web API in the new Dynamics 365 version is very simple and easy. Now, Dynamics 365 has a new library <kbd>Xrm.WebApi</kbd> and performs CRUD operations using Web API. This library provides functions to perform operations, which we will look through in the following examples and sample code.</p>
<p><strong>Create an entity record</strong></p>
<p>Here is a sample code to create a new contact using the <kbd>Xrm.WebApi.createRecord()</kbd> function:</p>
<pre style="padding-left: 60px">function createContact() {<br/>  // contact data object<br/>  var entity = {};<br/>  entity.firstname = "Mark";<br/>  entity.lastname = "Andrew";<br/>  entity.telephone1 = "7845687845";<br/>  entity.address1_city = "California";<br/>  // create record<br/>  Xrm.WebApi.createRecord("contact", entity).then(<br/>  function success(result) {<br/>    console.log("Contact Created Successfully !!");<br/>  },<br/>  function (error) {<br/>    console.log(error.message);<br/>  }<br/> );<br/>}</pre>
<p><strong>Update an entity record</strong></p>
<p>In the following example, we will be updating a record contact by adding a new attribute <kbd>email</kbd>:</p>
<pre style="padding-left: 60px">function updateContact() {<br/>  // contact data object<br/>  var entity = {};<br/>  entity.emailaddress1 = "mark@gmail.com";<br/>  //get contact id<br/>  var contactId = "DC1F674E-55F1-E711-A95F-000D3AF27163"<br/>  // update contact record<br/>  Xrm.WebApi.updateRecord("contact", contactId, entity).then(<br/>  function success(result) {<br/>    console.log("Contact Record Updated");<br/>  },<br/>  function (error) {<br/>    console.log(error.message);<br/>  }<br/> );<br/>}</pre>
<p><strong>Delete an entity record</strong></p>
<p>The following is the sample code to delete a contact record:</p>
<pre style="padding-left: 60px">function deleteContact() {<br/>  var contactId = "DC1F674E-55F1-E711-A95F-000D3AF27163";<br/>  Xrm.WebApi.deleteRecord("contact", contactId).then(<br/>  function success(result) {<br/>    console.log("Contact deleted");<br/>  },<br/>  function (error) {<br/>    console.log(error.message);<br/>  }<br/> );<br/>}</pre>
<p><strong>Retrieving records</strong></p>
<p>In the new version, you can directly use fetch XML to retrieve multiple records from Dynamics 365 using Web API. In the following example, we will use fetch an XML query to fetch/retrieve contacts for a selected account. The following is the sample code for retrieving records from Dynamics 365:</p>
<pre style="padding-left: 60px">function retrieveMultipleContacts(executioncontext) {<br/>  var formContext = executioncontext.getFormContext();<br/>  var contactId = formContext.data.entity.getId();<br/>  var fetchContacts = "&lt;fetch version='1.0' output-format='xml-  <br/>  platform' mapping='logical' distinct='false'&gt;" +<br/>  "&lt;entity name='contact' &gt;" +<br/>  "&lt;attribute name='fullname' /&gt;" +<br/>  "&lt;attribute name='telephone1' /&gt;" +<br/>  "&lt;attribute name='contactid' /&gt;" +<br/>  "&lt;order attribute='fullname' descending='false' /&gt;" +<br/>  "&lt;filter type='and'&gt;" +<br/>  "&lt;condition attribute='parentcustomerid' operator='eq'   <br/>  uitype='account' value ='" + accountId + "' /&gt;" +<br/>  "&lt;/filter&gt;" +<br/>  "&lt;/entity &gt;" +<br/>  "&lt;/fetch &gt; ";<br/>  Xrm.WebApi.retrieveMultipleRecords("contact", "fetchXml= " +    <br/>  fetchContacts).then(<br/>    function success(result) {<br/>    for (var i = 0; i &lt; result.entities.length; i++) {<br/>      console.log(result.entities[i]);<br/>    }<br/>  },<br/>   function (error) {<br/>     console.log(error.message);<br/>    });<br/>  }</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we saw how to work on Single Page Applications, XMLHttpRequest in Dynamics 365 Web API, Web API URL and versions, and Standard Query Options, and also saw how to work on CRUD operations using Dynamics 365 Web API.  In the next chapter, we will cover Azure integration with Dynamics 365, configure Azure integration with Dynamics 365, and write Azure-aware plugins and different listener applications.</p>


            </article>

            
        </section>
    </body></html>