- en: Chapter 6. Iterative Control Structures – Loops
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You learned about conditional controls in the previous chapter. Our journey
    into Ansible's world of control structures continues with iterative controls.
    Often, we need to create a list of directories, install a bunch of packages, or
    define and walk over nested hashes or dictionaries. Traditional programming languages
    use the `for` or `while` loops for iteration. Ansible replaces them with the `with`
    statements.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we are going to learn about:'
  prefs: []
  type: TYPE_NORMAL
- en: How to use iterative controls using the `with` statements
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to loop arrays to create multiple objects at once
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How to define nested hashes and walk over them to create data-driven roles
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The omnipotent with statement
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Iterating plain lists, parsing dictionaries, looping a sequence of numbers,
    parsing through a path and selectively copying files, or just picking up a random
    item from a list could be achieved using the "Swiss knife" utility, `with` statement.
    The `with` statements take the following form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Here, the `xxx` parameter is the type of data that needs to be looped, for example,
    items, dictionaries, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following table lists the types of data that the `with` statement can iterate:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Construct | Data type | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `with_items` | Array | This is used to loop array items. For example, this
    is used to create a group of users, directories, or to install a list of packages.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `with_nested` | Nested loops | This is used to parse multidimensional arrays.
    For example, to create a list of MySQL users and grant them access to a group
    of databases. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_dict` | Hashes | This is used to parse a dictionary of key-value pairs
    and create virtual hosts. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_fileglobs` | Files with pattern match | This is used to parse a path
    and copy only those files that match a certain pattern. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_together` | Sets | This is used to join two arrays as a set and to
    loop over it. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_subelements` | Hash subelement | This is used to parse a subelement
    of a hash. For example, to walk over the list of SSH keys and distribute them
    to a user. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_sequence` | Integer sequence | This is used to loop a sequence of numbers.
    |'
  prefs: []
  type: TYPE_TB
- en: '| `with_random_choice` | Random choice | This is used to pick up items from
    the array in a random order. |'
  prefs: []
  type: TYPE_TB
- en: '| `with_indexed_items` | Array with index | This is an array with an index
    and is useful when an index for items is required. |'
  prefs: []
  type: TYPE_TB
- en: Configuring WordPress requisites
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'While creating a role to install WordPress in [Chapter 4](ch04.html "Chapter 4. Bringing
    In Your Code – Custom Commands and Scripts"), *Bringing In Your Code – Custom
    Commands and Scripts*, we created tasks to download, extract, and copy the WordPress
    application. However, that''s not enough to launch WordPress, which has the following
    prerequisites:'
  prefs: []
  type: TYPE_NORMAL
- en: A web server
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: PHP bindings for a web server
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The MySQL database and MySQL users
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An Nginx web server and MySQL service have already been installed in our case.
    We still need to install and configure PHP along with the MySQL database and a
    user required for our WordPress application. To handle PHP requests, we choose
    to implement the PHP5-FPM handler, which is an alternative to the traditional
    FastCGI implementation.
  prefs: []
  type: TYPE_NORMAL
- en: The PHP5-FPM role
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In **PHP5-FPM**, **FPM** stands for **FastCGI Process Manager**. PHP5-FPM comes
    with advanced features over **fastcgi**, which are useful for managing high-traffic
    sites. It is suitable for serving our fifanews site, which is expected to get
    a few million hits a day. Following our design tenet of creating a modular code,
    we would keep PHP functionality in its own role. Let''s initialize the PHP5-FPM
    role using the Ansible-Galaxy command, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Defining an array
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'PHP installation will involve the installation of multiple packages, including
    `php5-fpm`, `php5-mysql`, and a few others. So far, we have been writing tasks
    one at a time. For example, let''s take a look at the following code snippet:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'However, this could become repetitive when we want to install multiple packages,
    also causing redundant code. Being committed to writing data-driven roles, we
    would drive the installation of packages through a variable, which takes a list
    of packages and then iterates the list. Let''s begin defining the parameters required
    to list the packages, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the analysis of the preceding code:'
  prefs: []
  type: TYPE_NORMAL
- en: The `php5` variable is a variable dictionary, which would contain all the parameters
    that we pass to the `php5-fpm` role.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `php5.packages` parameter is an array of packages, one defined on each line
    in the code. This will be passed to a task that will iterate each item and install
    it.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `php5.service` parameter defines the name of the service, which would be
    referred to from the service task.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Looping an array
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s now create tasks for the `php5-fpm` role. We need to install packages
    from the array and then start the service. We will split the package''s functionalities
    in to two separate task files and call it from the `main.yml` file, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Along with tasks, the handler to restart the `php5-fpm` role can be written,
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Let''s analyze the preceding code:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Main**: The `main.yml` file includes variables based on the `ansible_os_family`
    fact for non-Debian systems. This is useful for overriding variables that are
    platform-specific. After including the `vars` file, the main task goes on to include
    the `install.yml` and `service.yml` files.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Install**: The `install.yml` file is where we iterate an array of packages
    that were defined earlier. Since the file contains an array, we use the `with.items`
    construct with the `php5.packages` variable and pass the `{{ item }}` parameter
    as the name of the package to be installed. We could have alternatively passed
    the array directly, as follows:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '**Service and handler**: The `service.yml` file and the handler `main.yml`
    file manage the start and restart of the `php5-fom` service. It takes a dictionary
    variable `php5[''service''][''name'']` to determine the service name.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Creating MySQL databases and user accounts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: WordPress is a content management system that requires a MySQL DB to be available
    to store data, such as posts, users, and so on. Additionally, it also requires
    a MySQL user with appropriate privileges to connect to the database from a WordPress
    application. We get one admin user while installing MySQL, however, it's a good
    practice to create an additional user account and grant privileges to the user
    as and when required.
  prefs: []
  type: TYPE_NORMAL
- en: Creating a hash
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'A **hash**, an abbreviation of hash table, is a dictionary of key-value pairs.
    It''s a useful data structure to create a multilevel variable, which can then
    be programmatically to create multiple objects, each having their own values.
    We will define the databases and users as dictionary items in the `group_vars`/`all`
    file, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the analysis of the preceding code:'
  prefs: []
  type: TYPE_NORMAL
- en: We defined this variable hash in the `group_vars`/`all` file instead of in the
    role. This is because we would like to keep roles generic and shareable, without
    adding data specific to our respective environments.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: We defined the databases and user configurations as multilevel dictionaries,
    or hashes.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Nested hashes
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'This multilevel hash is explained through the following diagram:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Nested hashes](img/B03800_06_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'The following is the description of how this nested hash is structured:'
  prefs: []
  type: TYPE_NORMAL
- en: 'A MySQL variable is a hash with two keys: databases and users. For example:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'The values for each of these two keys are in turn hashes, or dictionaries of
    information, about the databases and users that are to be created. For example:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Each database in turn is a dictionary of keys and values. For example, for the
    MySQL user `fifalive`, the key-value pairs are "state:present".
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Iterating a hash
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Creating databases and user accounts would typically require the creation of
    custom scripts with templates, which would then be called using command modules.
    Ansible instead comes with batteries, and staying true to this statement, it provides
    us with ready-made modules to perform MySQL-related tasks, that is, the `mysql_db`
    and `mysql_user` parameters. Using the `with_dict` statement, we will walk through
    the dictionaries of databases and users that we defined earlier, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the analysis of the preceding code:'
  prefs: []
  type: TYPE_NORMAL
- en: The `mysql['databases']` and `mysql['users']` parameters are dictionaries that
    are passed to a task using the `with_dict` statements
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Each dictionary, or hash, has a key-value pair that is passed as the `{{ item.key
    }}` and `{{ item.value }}` parameters
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The `{{ item.value }}` parameter is a dictionary. Each key in this dictionary
    is then referred to as `{{ item.value.<key> }}`. For example, the `{{ item.value.state
    }}` parameter
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following diagram explains how this nested hash is parsed:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Iterating a hash](img/B03800_06_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Creating Nginx virtual hosts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: After installing the `php5-fpm` manager and creating the MySQL databases and
    user accounts, the last bit of configuration that is left is to create a virtual
    host with Nginx to serve our WordPress application. The Nginx web server that
    we installed earlier serves a simple HTML page and is not aware of the existence
    of the WordPress application or how to serve it. Let's start by adding these configurations.
  prefs: []
  type: TYPE_NORMAL
- en: Defining the PHP site information
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In addition to the `fifanews.com` site that we are setting up, we may also
    launch a few more sites related to soccer in future. Hence, we need to have the
    ability to programmatically add multiple sites with the same Nginx server. Creating
    a dictionary to define site information and embedding it into a template sounds
    like a good choice for this. Since site information is specific to us, we will
    add the variable hash to the `group_vars` file, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'We learned how to parse this dictionary from the Ansible task. Let''s add a
    task that will allow us to walk through this dictionary, pass the values to templates,
    and create virtual host configurations:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Each item in this dictionary is passed to the template, in this case, to the
    `php_vhost.j2` parameter. This in turn reads the hash and creates a virtual host
    template, which configures a PHP application, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the analysis of the preceding code:'
  prefs: []
  type: TYPE_NORMAL
- en: The `{{ ansible_managed }}` parameter is a special variable that adds a comment
    notifying the server that this file is being managed by Ansible, with the path
    to this file in the Ansible repository, last modification time, and the user who
    modified it.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The template gets a dictionary item and parses its values since it's a nested
    hash. This template has configuration for creating a php virtual hosts for Nginx
    using dictionary values set with `nginx.phpsites`.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Configuration parameters provided with the dictionary include doc root, port,
    backend to use which make Nginx aware of how to handle incoming PHP requests,
    which backend to use, which port to listen on, and so on.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Finally, we add the new role to the `www.yaml` file, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Run the playbook using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'After the run is complete, it''s time to test our work. Let''s load the following
    URL in the browser:'
  prefs: []
  type: TYPE_NORMAL
- en: '`http://<web_server_ip>:8080`'
  prefs: []
  type: TYPE_NORMAL
- en: 'Congratulations!! We''ve successfully created a WordPress PHP application with
    the Nginx web server and MySQL backend, fully configured. Now, we are ready to
    set up our fifanews site:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Defining the PHP site information](img/B03800_06_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Review questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Do you think you''ve understood this chapter well enough? Try answering the
    following questions to test your understanding:'
  prefs: []
  type: TYPE_NORMAL
- en: Which statement in Ansible replaces the `for` loop?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How is the `with_____` statement used to iterate dictionaries?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How would you add a statement to a template that prints when, and by whom, it
    was modified?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How would you print the values of a nested hash?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned how to create multiple objects iteratively. We
    started with an overview of the omnipotent `with` statement and its various forms.
    Then, we dove deeper into iterating the two most essential data structures, which
    are, arrays and hashes. The `php5-fpm` role takes an array with a list of packages
    and creates a task to install those in a loop. To create MySQL databases and users,
    we defined variable dictionaries or hashes and iterated them. Finally, we added
    Nginx template configurations to create multiple virtual hosts serving PHP applications
    by iterating a nested dictionary.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, you will learn how to discover information about other
    nodes using magic variables.
  prefs: []
  type: TYPE_NORMAL
