<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-294"><a id="_idTextAnchor294"/>16</h1>
<h1 id="_idParaDest-295"><a id="_idTextAnchor295"/>Ansible Automation Best Practices for Production</h1>
<p>Ansible can be used to automate IT infrastructure and DevOps tasks. Because of its flexible and modular architecture, we can implement large, complex automation use cases using Ansible. But at the same time, we need to keep the simplicity and reusability of the automation artifacts and methods.</p>
<p>In this chapter, you will learn about the important and well-known best practices for implementing efficient automation solutions. </p>
<p>First, you will learn how to organize the playbooks, roles, collections, and inventories in an Ansible project. After that, we will discuss the best practices for storing managed node information in the inventory and different methods for storing and maintaining multiple inventories. You can store the remote nodes separately based on their function, criticality, or location; these details will be explained in the upcoming sections. </p>
<p>You will also learn about the most efficient ways to store the variables in dynamic methods and how to store host variables and group variables to maintain them appropriately.</p>
<p>Another critical component in Ansible automation is handling credentials such as usernames and passwords, API keys, and secrets. Therefore, you will explore the best practices for Ansible credential management, such as how to store sensitive data for an Ansible playbook.</p>
<p>Finally, you will learn about the best practices, methods, and optimization techniques for developing and executing Ansible playbooks.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Organizing Ansible automation content </li>
<li>Storing remote host information – inventory best practices</li>
<li>Ansible host variables and group variables</li>
<li>Ansible credentials best practices</li>
<li>Ansible playbook best practices</li>
</ul>
<p>This chapter will start by covering various Ansible content organization methods and different inventory organization methods.</p>
<h1 id="_idParaDest-296"><a id="_idTextAnchor296"/>Technical requirements</h1>
<p>You will need the following technical requirements to complete this chapter:</p>
<ul>
<li>A Linux machine for the Ansible control node.</li>
<li>One or more Linux machines as managed nodes with Red Hat repositories configured (if you are using non-RHEL machines, then make sure you have the appropriate repositories configured to get packages and updates).</li>
</ul>
<p>All the Ansible artifacts, Ansible playbooks, commands, and snippets for this chapter can be found in this book’s GitHub repository at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-16">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-16</a>.</p>
<h1 id="_idParaDest-297"><a id="_idTextAnchor297"/>Organizing Ansible automation content</h1>
<p>In <a href="B18383_04.xhtml#_idTextAnchor067"><em class="italic">Chapter 4</em></a>, <em class="italic">Exploring Collaboration in Automation Development</em>, you<a id="_idIndexMarker1034"/> learned about <strong class="bold">version control systems</strong> (<strong class="bold">VCSs</strong>) and <strong class="bold">source control management</strong> (<strong class="bold">SCM</strong>) and how to use <a id="_idIndexMarker1035"/>GitHub services<a id="_idIndexMarker1036"/> to store Ansible artifacts. </p>
<p>It is the best practice to create project-specific directories (that is, repositories) to keep all related items at a single location, such as project-specific <code>ansible.cfg</code> files, playbooks, roles, collections, or libraries. If there are external roles or collections dependencies, then mention the details inside the <code>requirements.yaml</code> (or <code>requirements.yml</code>) file. </p>
<p>Use the <code>tree</code> command in Linux to list the directories and files recursively and understand the structure of the directory’s content. A sample project directory can be organized like so:</p>
<div><div><img alt="Figure 16.1 – Typical Ansible project directory " height="484" src="img/B18383_16_01.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.1 – Typical Ansible project directory</p>
<p>Your roles will be under the <code>roles</code> directory, as shown<a id="_idIndexMarker1037"/> in the following screenshot:</p>
<div><div><img alt="Figure 16.2 – Ansible roles directory " height="591" src="img/B18383_16_02.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.2 – Ansible roles directory</p>
<p>Depending on the projects and use cases, you may have more or fewer directories and files. We will explore the best practices for storing an inventory in the next section.</p>
<h1 id="_idParaDest-298"><a id="_idTextAnchor298"/>Storing remote host information – inventory best practices</h1>
<p>Managed nodes <a id="_idIndexMarker1038"/>or remote host information is critical data in Ansible automation since, without the proper host details, Ansible will not be able to execute the automation tasks. You learned about the Ansible inventory and its basic details in <a href="B18383_01.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a>, <em class="italic">Ansible Automation – Introduction</em>. In <em class="italic">Chapter 4</em>, <em class="italic">Exploring Collaboration in Automation Development</em>, you learned about the importance of storing an inventory in a GitHub repository for version control and better management. If your managed nodes are hosted in cloud platforms, then it is a best practice to use Ansible dynamic inventories, as you learned in <a href="B18383_05.xhtml#_idTextAnchor086"><em class="italic">Chapter 5</em></a>, <em class="italic">Expanding Your Automation Landscape</em>.</p>
<h2 id="_idParaDest-299"><a id="_idTextAnchor299"/>Using meaningful hostnames</h2>
<p>When you create<a id="_idIndexMarker1039"/> your Ansible static inventory files, use meaningful<a id="_idIndexMarker1040"/> and user-friendly names for your managed nodes instead of complex <strong class="bold">Fully Qualified Domain Names</strong> (<strong class="bold">FQDNs</strong>) or IP addresses. It will help you while executing the Ansible playbook and troubleshooting it if that’s required.</p>
<p>For example, the following is a generic Ansible static inventory file:</p>
<div><div><img alt="Figure 16.3 – Sample static inventory file " height="248" src="img/B18383_16_03.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.3 – Sample static inventory file</p>
<p>The same static inventory can be rewritten with user-friendly names and <code>ansible_host</code> information, as shown in the following screenshot:</p>
<div><div><img alt="Figure 16.4 – Ansible inventory with user-friendly names " height="248" src="img/B18383_16_04.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.4 – Ansible inventory with user-friendly names</p>
<p>Using <code>ansible_host</code> means you don’t have to rely on your DNS name (FQDN) by using the IP address to access the managed nodes. </p>
<p>This practice will not only help you troubleshoot<a id="_idIndexMarker1041"/> output and logs but also help you manage your inventory with simple and meaningful names.</p>
<p class="callout-heading">How to Build Your Inventory</p>
<p class="callout">Refer to the official<a id="_idIndexMarker1042"/> documentation for more details: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.xhtml">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.xhtml</a>. </p>
<p>In the next section, you will learn how to separate the inventory based on environments such as production, staging, and development.</p>
<h2 id="_idParaDest-300"><a id="_idTextAnchor300"/>Storing production, staging, and development hosts separately</h2>
<p>You need to organize your inventory<a id="_idIndexMarker1043"/> at the project level or overall <a id="_idIndexMarker1044"/>inventory level. If you are using<a id="_idIndexMarker1045"/> the same managed nodes for multiple Ansible projects (the same nodes but different automation and use cases), then keep your inventory somewhere in a central GitHub repository as a single source of truth. This will help you organize your managed node information in a better way so that it can be used for different automation playbooks. The following diagram shows a scenario where the inventory is stored in a dedicated GitHub repository:</p>
<div><div><img alt="Figure 16.5 – Ansible inventory in a dedicated repository " height="491" src="img/B18383_16_05.jpg" width="998"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.5 – Ansible inventory in a dedicated repository</p>
<p>In the following example, we have<a id="_idIndexMarker1046"/> created a separate<a id="_idIndexMarker1047"/> directory for the inventories<a id="_idIndexMarker1048"/> and placed the production, development, and staging managed nodes in separate directories (refer to the <code>Chapter-16</code> directory in this book’s GitHub repository):</p>
<div><div><img alt="Figure 16.6 – Ansible inventory organized based on the environment " height="536" src="img/B18383_16_06.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.6 – Ansible inventory organized based on the environment</p>
<p>When you execute<a id="_idIndexMarker1049"/> the playbook, you must mention<a id="_idIndexMarker1050"/> which inventory file<a id="_idIndexMarker1051"/> will be used, as follows:</p>
<pre class="source-code">
[ansible@ansible Chapter-16]$ ansible-playbook site.yml -i inventories/prod/host</pre>
<p>The inventory can also be categorized based on location, criticality, server type, and more. It is possible to do the same categorization inside the inventory file using host groups, as shown in the following screenshot:</p>
<div><div><img alt="Figure 16.7 – Host groups and group variables for managed nodes " height="724" src="img/B18383_16_07.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.7 – Host groups and group variables for managed nodes</p>
<p>Verify the grouping<a id="_idIndexMarker1052"/> of managed nodes<a id="_idIndexMarker1053"/> using the <code>ansible-inventory</code> command, as shown<a id="_idIndexMarker1054"/> in the following screenshot:</p>
<div><div><img alt="Figure 16.8 – Listing the hosts and host groups using the ansible-inventory command " height="802" src="img/B18383_16_08.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.8 – Listing the hosts and host groups using the ansible-inventory command</p>
<p>In the preceding examples, we created<a id="_idIndexMarker1055"/> multiple inventory files<a id="_idIndexMarker1056"/> in the same or different folders<a id="_idIndexMarker1057"/> and grouped-managed nodes based on function or location. In the next section, you will learn how to maintain host-specific and group-specific variables using the <code>group_vars</code> and <code>host_vars</code> variables, respectively.</p>
<h1 id="_idParaDest-301"><a id="_idTextAnchor301"/>Ansible host variables and group variables</h1>
<p>As you learned previously, like many other<a id="_idIndexMarker1058"/> automation tools, Ansible allows you to use variables<a id="_idIndexMarker1059"/> for dynamically executing playbooks. It is possible to configure the same playbook so that it can be executed for different desired states using variables and values. We can keep the variables inside the playbooks, external variable files, inventory files, and many other places. You learned more about variables in <a href="B18383_06.xhtml#_idTextAnchor105"><em class="italic">Chapter 6</em></a>, <em class="italic">Automating Microsoft Windows and Network Devices</em>.</p>
<p>The same variable can be specified in multiple<a id="_idIndexMarker1060"/> places but depending on the location of your variable<a id="_idIndexMarker1061"/> and variable precedence, Ansible will apply the appropriate value for the variable.</p>
<p>Ansible uses the appropriate variable values and executes the playbooks based on them; the following diagram shows the typical flow where Ansible combines the variable values with the playbook:</p>
<div><div><img alt="Figure 16.9 – Ansible combines playbooks and variables for the final execution " height="400" src="img/B18383_16_09.jpg" width="625"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.9 – Ansible combines playbooks and variables for the final execution</p>
<p class="callout-heading">Understanding Variable Precedence</p>
<p class="callout">Refer to <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#understanding-variable-precedence">https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#understanding-variable-precedence</a> to learn and understand<a id="_idIndexMarker1062"/> more about variable precedence.</p>
<p>It is best practice to use host-specific variables<a id="_idIndexMarker1063"/> and group-specific variables<a id="_idIndexMarker1064"/> in the <code>host_vars</code> and <code>group_vars</code> directories, respectively, as shown in the following screenshot:</p>
<div><div><img alt="Figure 16.10 – host_vars and group_vars for the Ansible inventory " height="378" src="img/B18383_16_10.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.10 – host_vars and group_vars for the Ansible inventory</p>
<p>Now, let’s learn how to create <code>host_vars</code> and <code>group_vars</code>.</p>
<h2 id="_idParaDest-302"><a id="_idTextAnchor302"/>Ansible group_vars</h2>
<p>The variables<a id="_idIndexMarker1065"/> for a group should be mentioned in a file such as <code>group_vars/INVENTORY_GROUP_NAME.yaml</code> or a subdirectory such as <code>group_vars/INVENTORY_GROUP_NAME/VAR_FILE</code>.</p>
<p>For example: </p>
<ul>
<li><code>group_vars/web.yaml</code></li>
<li><code>group_vars/web/vars.yaml</code></li>
<li><code>group_vars/web/credential.yaml</code></li>
</ul>
<h2 id="_idParaDest-303"><a id="_idTextAnchor303"/>Ansible host_vars</h2>
<p>The variables<a id="_idIndexMarker1066"/> for the host should be mentioned in a file such as <code>host_vars/INVENTORY_HOSTNAME</code> or a subdirectory such as <code>host_vars/INVENTORY_HOSTNAME/VAR_FILE</code>.</p>
<p>For example: </p>
<ul>
<li><code>host_vars/node1.yaml</code></li>
<li><code>host_vars/node1/vars.yaml</code></li>
<li><code>host_vars/node2.yaml</code></li>
</ul>
<p>It is possible to create<a id="_idIndexMarker1067"/> multiple variable files for the same managed node so that you can manage related variables separately.</p>
<h2 id="_idParaDest-304"><a id="_idTextAnchor304"/>Keeping your secret variables in a safe location</h2>
<p>If you have credentials<a id="_idIndexMarker1068"/> or secrets as part of your host variables, then keep such variables in a separate variable file and encrypt them using Ansible Vault. The following are some examples of this:</p>
<ul>
<li><code>host_vars/node1/vars.yaml</code></li>
<li><code>host_vars/node1/credentials.yaml</code></li>
<li><code>group_vars/web/vault.yaml</code></li>
</ul>
<p>It is also possible to use other vault services such as HashiCorp Vault or CyberArk instead of Ansible Vault. Refer to <a href="B18383_13.xhtml#_idTextAnchor241"><em class="italic">Chapter 13</em></a>, <em class="italic">Using Ansible for Secret Management</em>, to learn more about Ansible Vault.</p>
<h2 id="_idParaDest-305"><a id="_idTextAnchor305"/>Managing group_vars and host_vars in Ansible</h2>
<p>In this exercise, you will use host <a id="_idIndexMarker1069"/>variables and group<a id="_idIndexMarker1070"/> variables to control the values of multiple web servers. Follow these steps:</p>
<ol>
<li>Create a <code>hosts</code> inventory file inside the staging inventory directory (<code>Chapter-16/inventories/stg</code>) with the following content (do not worry about <code>node1</code>, <code>node2</code>, or <code>node3</code> as we are not going to connect to these machines):</li>
</ol>
<div><div><img alt="Figure 16.11 – Ansible inventory with a web group " height="300" src="img/B18383_16_11.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.11 – Ansible inventory with a web group</p>
<ol>
<li value="2">Create the <code>group_vars</code> and <code>host_vars</code> directories<a id="_idIndexMarker1071"/> for storing group variables<a id="_idIndexMarker1072"/> and host variables, respectively:</li>
</ol>
<div><div><img alt="Figure 16.12 – Creating directories for group variables and host variables " height="141" src="img/B18383_16_12.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.12 – Creating directories for group variables and host variables</p>
<ol>
<li value="3">Create a group variable file called <code>inventories/stg/group_vars/web.yaml</code> with the following content:</li>
</ol>
<div><div><img alt="Figure 16.13 – Creating a group variable file " height="141" src="img/B18383_16_13.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.13 – Creating a group variable file</p>
<ol>
<li value="4">Configure a different value for <code>web_server_port</code> (<code>8080</code>) for <code>node1</code>. Create a host variable file called <code>inventories/stg/host_vars/node1.yaml</code> with the following content:</li>
</ol>
<div><div><img alt="Figure 16.14 – Creating a host variable file " height="141" src="img/B18383_16_14.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.14 – Creating a host variable file</p>
<ol>
<li value="5">Configure a different<a id="_idIndexMarker1073"/> value for <code>web_server_port</code> (<code>8081</code>) for <code>node2</code>. Then, create a host<a id="_idIndexMarker1074"/> variable file for <code>node2</code> in <code>inventories/stg/host_vars/node2.yaml</code> with the following content:</li>
</ol>
<div><div><img alt="Figure 16.15 – Creating a host variable file for node2 " height="168" src="img/B18383_16_15.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.15 – Creating a host variable file for node2</p>
<ol>
<li value="6">Now that all the variable files have been created, you must verify them, as shown in the following screenshot:</li>
</ol>
<div><div><img alt="Figure 16.16 – Project directory structure with group variables and host variables " height="378" src="img/B18383_16_10.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.16 – Project directory structure with group variables and host variables</p>
<ol>
<li value="7">Now, verify the variable values for each host with the <code>ansible-inventory</code> command:</li>
</ol>
<div><div><img alt="Figure 16.17 – Verifying the inventory and variables using the ansible-inventory command " height="724" src="img/B18383_16_17.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.17 – Verifying the inventory and variables using the ansible-inventory command</p>
<ol>
<li value="8">Now, you must verify<a id="_idIndexMarker1075"/> and understand the host variables that have been <a id="_idIndexMarker1076"/>assigned, as follows:<ul><li><code>node1</code> has been assigned with <code>web_server_port: 8080</code>, which is coming from <code>host_vars/node1.yaml</code>.</li><li><code>node2</code> has been assigned with <code>web_server_port: 8081</code>, which is coming from <code>host_vars/node2.yaml</code>.</li><li><code>node3</code> has been assigned with <code>web_server_port: 80</code>, which is coming from <code>group_vars/web.yaml</code>.</li></ul></li>
</ol>
<p>Based on variable precedence, the nodes will get different values for the same variable, as shown in the following diagram:</p>
<div><div><img alt="Figure 16.18 – Ansible group variables and host variables on target nodes " height="404" src="img/B18383_16_18.jpg" width="700"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.18 – Ansible group variables and host variables on target nodes</p>
<p>It is important to configure<a id="_idIndexMarker1077"/> the host-specific variable in <code>host_vars</code> or <code>group_vars</code> so that you don’t miss<a id="_idIndexMarker1078"/> important values at the playbook level. If you have the same variable and values being shared by multiple hosts in the same group, then configure them under <code>group_vars</code>.</p>
<p>In the next section, you will learn about the best practices for storing credentials in Ansible.</p>
<h1 id="_idParaDest-306"><a id="_idTextAnchor306"/>Ansible credentials best practices</h1>
<p>Ansible supports multiple credentials<a id="_idIndexMarker1079"/> and authentication methods, such as username and password, SSH keys, API tokens, webhooks, and even the ability to create custom credentials. You should use a simple authentication mechanism as a starting point, but you need to consider the best practices to ensure security and safety are in place. </p>
<h2 id="_idParaDest-307"><a id="_idTextAnchor307"/>Avoid using default admin user accounts</h2>
<p>It is common for engineers<a id="_idIndexMarker1080"/> to configure the default administrator accounts as a <code>remote_user</code> such as <code>root</code> in Linux or as an <strong class="bold">administrator</strong> in Microsoft Windows. This is not a best practice; you should create dedicated accounts for Ansible and configure them for managed nodes. </p>
<h2 id="_idParaDest-308"><a id="_idTextAnchor308"/>Split the login credentials for environments and nodes</h2>
<p>In the previous examples, you created<a id="_idIndexMarker1081"/> user accounts in Linux and Microsoft Windows for Ansible to log in and execute tasks. It is possible to create the same user account for all of your nodes, but this is not required or recommended. It is possible to create different user accounts for different managed nodes since you have the option to specify <code>remote_user</code> or <code>ansible_user</code> for every managed node or host group, as shown here:</p>
<div><div><img alt="Figure 16.19 – A different user account for remote nodes " height="759" src="img/B18383_16_19.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.19 – A different user account for remote nodes</p>
<p>In the preceding inventory<a id="_idIndexMarker1082"/> output, notice different <code>ansible_user</code> instances have been configured for different nodes, such as <code>ansibleadmin</code> for <code>node1</code>, <code>user1</code> for <code>node2</code>, <code>devops</code> for <code>node3</code>, and more.</p>
<h2 id="_idParaDest-309"><a id="_idTextAnchor309"/>Avoid passwords in plain text</h2>
<p>If you are using password-based<a id="_idIndexMarker1083"/> authentication, then the password should be encrypted and saved separately. Refer to <a href="B18383_03.xhtml#_idTextAnchor052"><em class="italic">Chapter 3</em></a><em class="italic">'s</em>, <em class="italic">Encrypting Sensitive Data Using Ansible Vault </em>section, to learn more about Ansible Vault and secret management. Once encrypted using Ansible Vault, the password file will be safe and cannot be read by anyone else, as shown in the following screenshot:</p>
<div><div><img alt="Figure 16.20 – Encrypting sensitive files using Ansible Vault " height="389" src="img/B18383_16_20.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.20 – Encrypting sensitive files using Ansible Vault</p>
<p>When you execute the playbook, it is also possible to instruct Ansible to prompt for a password using the <code>--ask-pass</code> switch:</p>
<div><div><img alt="Figure 16.21 – Ansible Vault password prompt " height="124" src="img/B18383_16_21.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.21 – Ansible Vault password prompt</p>
<p>Based on your organization’s best practices and compliance requirements, add more restrictions and best practices<a id="_idIndexMarker1084"/> for handling sensitive data in Ansible.</p>
<p>In the next section, you will learn about some of the best practices for Ansible playbooks.</p>
<h1 id="_idParaDest-310"><a id="_idTextAnchor310"/>Ansible playbook best practices</h1>
<p>It is important to develop your Ansible playbooks<a id="_idIndexMarker1085"/> with reader-friendliness and reusability in mind. Since the YAML format is human readable, it is easy to develop and follow some style guides for your Ansible playbooks.</p>
<p>In <a href="B18383_15.xhtml#_idTextAnchor275"><em class="italic">Chapter 15</em></a>, <em class="italic">Using Raw Commands for Network Operations</em>, you learned when to use the <code>raw</code> module and commands. Always check the documentation and see if there are modules available for your task. The <code>command</code>, <code>shell</code>, <code>raw</code>, and <code>script</code> modules can be used if no suitable modules are available for the task. But always keep in mind that the <code>command</code>, <code>shell</code>, <code>raw</code>, and <code>script</code> modules are not idempotent and will always report as <code>changed</code> when executed.</p>
<h2 id="_idParaDest-311"><a id="_idTextAnchor311"/>Always give your tasks names</h2>
<p>Even though the <code>name</code> parameter is an<a id="_idIndexMarker1086"/> optional component, it is a best practice to provide an appropriate and meaningful name for the plays, tasks, blocks, and other components in your Ansible playbooks. Refer to <em class="italic">Figure 16.22</em>, where you can see the sample names that were used for the tasks.</p>
<h2 id="_idParaDest-312"><a id="_idTextAnchor312"/>Use the appropriate comments</h2>
<p>Adding comments to your playbooks<a id="_idIndexMarker1087"/> will help you troubleshoot when there is an issue. Comments are also useful when further developments or enhancements are required so that the original author and other developers can easily understand the task or steps that are required in the Ansible playbook. </p>
<p>The following screenshot shows<a id="_idIndexMarker1088"/> that comments have been added before the tasks:</p>
<div><div><img alt="Figure 16.22 – Ansible playbook with comments, extra lines, and tags " height="625" src="img/B18383_16_22.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.22 – Ansible playbook with comments, extra lines, and tags</p>
<h2 id="_idParaDest-313"><a id="_idTextAnchor313"/>Extra lines and whitespaces</h2>
<p>Adding whitespaces and extra<a id="_idIndexMarker1089"/> lines in a playbook will increase its readability. As shown in the preceding screenshot, adding an extra line after each task will help you identify the individual tasks easily.</p>
<p>Implement your own style guide and follow the best practices for YAML writing to achieve better readability and reusability of Ansible artifacts. </p>
<h2 id="_idParaDest-314"><a id="_idTextAnchor314"/>Add tags to the tasks</h2>
<p>When you have large or complex<a id="_idIndexMarker1090"/> playbooks, you may need to run some tasks specifically instead of executing every task in the playbooks and roles. It is possible to achieve this by using <code>--tags</code> argument, as follows:</p>
<pre class="source-code">
$ ansible-playbook site.yml --tags=pretasks</pre>
<p>These tasks can be skipped by using the <code>--skip-tags</code> argument, as follows:</p>
<pre class="source-code">
$ ansible-playbook site.yml --skip-tags=email</pre>
<p>Refer to the<a id="_idIndexMarker1091"/> Ansible tags documentation (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.xhtml</a>) to learn more about the<a id="_idIndexMarker1092"/> usage and methods of tags in Ansible playbooks.</p>
<h2 id="_idParaDest-315"><a id="_idTextAnchor315"/>Use explicit declarations</h2>
<p>The modules may have default parameter<a id="_idIndexMarker1093"/> values and these values may apply automatically if we do not mention them in the playbook. But declaring such parameters explicitly in your playbooks will help you identify the desired result of the task. For example, in the <code>ansible.posix.firewalld</code> module, the default value for <code>immediate</code> is <strong class="bold">no</strong>, as shown in<a id="_idIndexMarker1094"/> the documentation at <a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/firewalld_module.xhtml">https://docs.ansible.com/ansible/latest/collections/ansible/posix/firewalld_module.xhtml</a>:</p>
<div><div><img alt="Figure 16.23 – firewalld module showing immediate parameter details " height="197" src="img/B18383_16_23.jpg" width="1202"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.23 – firewalld module showing immediate parameter details</p>
<p>Leave it as-is or declare it explicitly as <code>immediate: yes</code> if you need to apply the firewall entry immediately. The following screenshot shows an example <code>firewalld</code> task:</p>
<div><div><img alt="Figure 16.24 – firewalld task with explicit declarations " height="405" src="img/B18383_16_24.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.24 – firewalld task with explicit declarations</p>
<p>Always declare the desired<a id="_idIndexMarker1095"/> result in the Ansible playbook so that it is possible to troubleshoot and remediate issues when they occur.</p>
<h2 id="_idParaDest-316"><a id="_idTextAnchor316"/>Use native YAML for playbooks</h2>
<p>It is possible to write tasks<a id="_idIndexMarker1096"/> in any acceptable YAML format, so long as Ansible can read and understand it. The following screenshot shows some example tasks in an Ansible playbook:</p>
<div><div><img alt="Figure 16.25 – Ansible tasks in the non-native YAML format " height="202" src="img/B18383_16_25.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.25 – Ansible tasks in the non-native YAML format</p>
<p>The same playbook can be written in native YAML, which is tidier and more readable. This can be seen in the following screenshot:</p>
<div><div><img alt="Figure 16.26 – Ansible tasks written in native YAML format " height="414" src="img/B18383_16_26.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.26 – Ansible tasks written in native YAML format</p>
<p>Refer<a id="_idIndexMarker1097"/> to the Ansible YAML<a id="_idIndexMarker1098"/> syntax (<a href="https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.xhtml">https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.xhtml</a>) and advanced syntax (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_advanced_syntax.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_advanced_syntax.xhtml</a>) documentation<a id="_idIndexMarker1099"/> to learn more about YAML for Ansible.</p>
<h2 id="_idParaDest-317"><a id="_idTextAnchor317"/>Avoid hardcoding variables and details</h2>
<p>The following screenshot shows<a id="_idIndexMarker1100"/> a play where the target nodes and package details have been mentioned (hardcoded) inside the playbook:</p>
<div><div><img alt="Figure 16.27 – Ansible playbook with hardcoded values " height="255" src="img/B18383_16_27.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.27 – Ansible playbook with hardcoded values</p>
<p>If you need to execute the playbook for other target nodes, then you must modify the playbook file and update its values. The same playbook can be written like so:</p>
<div><div><img alt="Figure 16.28 – Ansible playbook with dynamic variables  " height="255" src="img/B18383_16_28.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.28 – Ansible playbook with dynamic variables </p>
<p>Now, pass the variable while executing the playbook, as follows:</p>
<pre class="source-code">
$ ansible-playbook site.yaml --extra-vars “nodes=webservers web_package=httpd”</pre>
<p>By avoiding<a id="_idIndexMarker1101"/> hardcoding, it is possible to dynamically use the same playbook for different target nodes with different values.</p>
<h2 id="_idParaDest-318"><a id="_idTextAnchor318"/>Use blocks in Ansible playbooks</h2>
<p>Blocks <a id="_idIndexMarker1102"/>are a logical grouping<a id="_idIndexMarker1103"/> of tasks in Ansible playbooks and help handle errors during execution. Instead of validating the success rate of tasks, use <code>block</code> in a playbook, as shown here:</p>
<div><div><img alt="Figure 16.29 – Using blocks in an Ansible playbook " height="678" src="img/B18383_16_29.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.29 – Using blocks in an Ansible playbook</p>
<p>If any of the tasks in <code>block</code> fail, Ansible<a id="_idIndexMarker1104"/> will execute<a id="_idIndexMarker1105"/> the tasks under the <code>rescue</code> block. The tasks under the <code>always</code> block will be executed regardless of the failure or success of the block and rescue tasks.</p>
<p>Refer to the blocks<a id="_idIndexMarker1106"/> documentation (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.xhtml</a>) to learn more about how to use blocks in Ansible.</p>
<h2 id="_idParaDest-319"><a id="_idTextAnchor319"/>Use roles and subtasks</h2>
<p>When you develop large<a id="_idIndexMarker1107"/> and complex automation use cases, you<a id="_idIndexMarker1108"/> should split the playbook into small subtask files and roles. This practice will improve the modularity and flexibility of Ansible artifacts and also help troubleshoot the playbook easily: </p>
<div><div><img alt="Figure 16.30 – An Ansible playbook calling roles and subtask files " height="414" src="img/B18383_16_30.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.30 – An Ansible playbook calling roles and subtask files</p>
<p>The preceding screenshot<a id="_idIndexMarker1109"/> shows an Ansible playbook calling the <code>linux-patching</code> role and some<a id="_idIndexMarker1110"/> of the specific task files from the role. </p>
<h2 id="_idParaDest-320"><a id="_idTextAnchor320"/>Use meaningful names for variables</h2>
<p>In the previous chapters, you learned<a id="_idIndexMarker1111"/> about Ansible variables and their different usages. It is possible to use multiple variables in your playbooks and roles, so it is important to use meaningful names for the variables. The following screenshot shows both good and bad examples of how to name variables:</p>
<div><div><img alt="Figure 16.31 – Ansible variables with short and meaningful names " height="414" src="img/B18383_16_31.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 16.31 – Ansible variables with short and meaningful names</p>
<p>Naming your variables<a id="_idIndexMarker1112"/> appropriately will help you avoid duplicating variable names and complexity in playbook development.</p>
<h2 id="_idParaDest-321"><a id="_idTextAnchor321"/>Learn playbook optimization</h2>
<p>There are multiple<a id="_idIndexMarker1113"/> ways to optimize Ansible playbooks and speed up their execution. Some of them are as follows:</p>
<ul>
<li>Use parallelism.</li>
<li>Use the appropriate execution strategy as needed.</li>
<li>Use the appropriate value for <code>forks</code>.</li>
<li>Use <code>serial</code> to execute in batches.</li>
<li>Use <code>order</code> to control execution based on inventory.</li>
<li>Use <code>throttle</code> for high CPU-intensive tasks.</li>
</ul>
<p>Read <em class="italic">8 ways to speed up your Ansible playbooks</em> (<a href="https://www.redhat.com/sysadmin/faster-ansible-playbook-execution">https://www.redhat.com/sysadmin/faster-ansible-playbook-execution</a>) and <em class="italic">5 ways to make your Ansible modules work faster</em> (<a href="https://www.redhat.com/sysadmin/faster-ansible-modules">https://www.redhat.com/sysadmin/faster-ansible-modules</a>) to learn more about Ansible<a id="_idIndexMarker1114"/> optimization<a id="_idIndexMarker1115"/> techniques. To expand your learning on Ansible best practices, refer<a id="_idIndexMarker1116"/> to the official Red Hat course <em class="italic">Advanced Automation: Red Hat Ansible Best Practices</em> (<a href="https://www.redhat.com/en/services/training/do447-advanced-automation-ansible-best-practices">https://www.redhat.com/en/services/training/do447-advanced-automation-ansible-best-practices</a>). </p>
<h1 id="_idParaDest-322"><a id="_idTextAnchor322"/>Summary</h1>
<p>In this chapter, you learned about some of the best practices that can be implemented in your Ansible development workflow. You explored the best practices for organizing Ansible artifacts, including playbooks, roles, variables, inventories, and other Ansible content. Then, you learned about the importance of storing the inventory separately based on the managed node environment, criticality, and other facts. You also learned how to use host variables and group variables to organize variables.</p>
<p>After that, you learned about some of the best practices for storing and managing credentials in Ansible, such as avoiding plain text passwords and separating secrets from regular variable files. Finally, you learned about the different best practices and optimization techniques for improving the efficiency of Ansible playbooks. Refer to the <em class="italic">Further reading</em> section to learn more about Ansible best practices.</p>
<p>Congratulations! With this chapter, you have reached the end of this book on Ansible automation for real-life use cases.</p>
<p>First, you were introduced to Ansible and learned how to install and deploy it. Based on that knowledge, you learned about Ansible commands, modules, and managed nodes. After that, you learned about Ansible playbooks and developed basic automation use cases, such as collecting system information, weekly system reboots, and system report generation. You also learned about the importance of version control systems and practiced how to use them to store Ansible artifacts.</p>
<p>After that, you expanded your learning by understanding how to find Ansible automation use cases. You learned how to automate Microsoft Windows and network devices such as VyOS and Cisco ASA using Ansible. You also learned how to use Ansible to manage virtualization platforms, cloud platforms (AWS, GCP, and VMware), and database operations.</p>
<p>Later, you learned how to use Ansible in DevOps practices and workflows and practiced container management using Ansible. You also learned how to use Ansible for Kubernetes management by deploying and scaling applications on Kubernetes. To expand your knowledge, you learned about Ansible Automation Platform and its various integration methods. After that, you learned how to manage sensitive information in Ansible using Ansible Vault.</p>
<p>In the last few chapters, you learned how to manage non-standard platforms and operations using raw commands, API calls, and modules. You also learned the best practices for developing and storing Ansible artifacts.</p>
<p>Before moving on, remember to join the Ansible community, real-time chat groups, and mailing lists. Refer to the Ansible community page (<a href="https://www.ansible.com/community">https://www.ansible.com/community</a>) to find details about meetup events. Contact me on LinkedIn (<a href="https://www.linkedin.com/in/gineesh">https://www.linkedin.com/in/gineesh</a>) if you have any questions or feedback on the content of this book.</p>
<p>If you are looking for official Ansible training, then check out the courses from Red Hat (<a href="https://www.ansible.com/products/training-certification">https://www.ansible.com/products/training-certification</a>).</p>
<p>Raise issues in the book repository (<a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/issues">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/issues</a>) if you have any issues while practicing the exercises in this book.</p>
<p>Thank you for your interest and your dedication to completing this book!</p>
<h1 id="_idParaDest-323"><a id="_idTextAnchor323"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li><em class="italic">Reusing Ansible artifacts (Include and Import)</em>: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.xhtml#playbooks-reuse">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.xhtml#playbooks-reuse</a></li>
<li><em class="italic">Ansible tips and tricks</em>: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.xhtml</a></li>
<li><em class="italic">Ansible Best Practices (Presentation Deck archive)</em>: <a href="https://aap2.demoredhat.com/decks/ansible_best_practices.pdf">https://aap2.demoredhat.com/decks/ansible_best_practices.pdf</a></li>
<li><em class="italic">10 habits of great Ansible users</em>: <a href="https://www.redhat.com/sysadmin/10-great-ansible-practices">https://www.redhat.com/sysadmin/10-great-ansible-practices</a></li>
</ul>
</div>
<div><div></div>
</div>
</div></body></html>