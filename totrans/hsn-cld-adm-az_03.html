<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Infrastructure as a Service - the First Layer of Cloud Computing</h1>
                </header>
            
            <article>
                
<p>The next step in our cloud journey is to leverage the Azure Virtual Machines offering as part of Azure IaaS. This is the first logical step when moving our workloads to the cloud, as managing Azure Virtual Machines is not much different from managing local VMs. We no longer have access to the virtualization host and hardware, but administrating and managing Azure VMs is no different from administrating and managing local servers or VMs.</p>
<p>We'll show you how to achieve high availability of your services and how to scale out workloads as one of the main benefits that Microsoft Azure offers.</p>
<p><span>Areas that we'll cover in this chapter are:</span></p>
<ul>
<li>Creating Azure Virtual Machines</li>
<li>Managing Azure Virtual Machines</li>
<li>Creating Azure Load Balancers</li>
<li>Configuring <span>Azure Load Balancers</span></li>
<li>Creating Azure Virtual Machines scale sets</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>For this chapter, you'll need:</p>
<ul>
<li>An Azure subscription</li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Deploying Azure Virtual Machines</h1>
                </header>
            
            <article>
                
<p>Deployment of any Azure resource can be done in several ways and it's no different with Azure Virtual Machines. We can use the Azure portal, ARM templates, Azure PowerShell, or Azure CLI. We will discuss all these methods but for the time being we'll stick to the Azure portal and occasionally use ARM templates. This is to gain better knowledge of Azure services and what is created in each deployment. Other tools can help us in the long run, especially when we talk redeployment and automation, but we'll get to that part later.</p>
<p>We already did a quick create of an Azure VM, but this time we'll look more closely for options that are available as last time we only considered the Azure networking part as the important one.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a new Azure Virtual Machine</h1>
                </header>
            
            <article>
                
<p>To create a new Azure VM, we <span>need to select <span class="packt_screen">New resource</span> and select <span class="packt_screen">New Virtual Machine</span>. </span></p>
<p>The first step is to select the operating system for our VM. There are hundreds of images available to select from both Windows and Linux. It's important to mention that more and more Linux VMs are deployed to Azure daily. Information from the end of 2017 tells us that more than 40% of all Azure Virtual Machines are running Linux, and that percentage is probably up since then. </p>
<p>Supported versions of Windows Server in Azure are:</p>
<ul>
<li>Windows Server 2008 R2 SP1</li>
<li><span>Windows Server 2012</span></li>
<li><span>Windows Server 2012 R2</span></li>
<li>Windows Server 2016</li>
</ul>
<p>For Linux, there are too many versions to name but supported distributions are:</p>
<ul>
<li>Ubuntu</li>
<li>CentOS</li>
<li>RHEL</li>
<li>Kali</li>
<li>Oracle</li>
</ul>
<p class="mce-root"/>
<p>All images can be selected as a minimum installation or preconfigured with additional software installed. For example, we can select Windows Server 2016 with all settings at default or select an image that has SQL Server installed and ready to use. We can choose the same for Linux, choose minimum installation, or choose an already configured image with software such as Chef, Puppet, Jenkins, and so on.</p>
<p>There is also an option to choose your custom image with the configuration and software of your choosing. This can be an image of your on-premises VM that is uploaded to Azure or an image created from another Azure VM.</p>
<p>After we choose the OS, we start a new blade that will take us through three stages.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Basic Azure Virtual Machine information</h1>
                </header>
            
            <article>
                
<p>The first step is to provide basic information for our VM. A name needs to be provided for any type of resource in Azure. It's useful to give names based on procedures and roles as this will help in later management. It's easier when the name of your VM gives you a hint about what its purpose is. As I intend to use this one as a web server, I'll name it <kbd>WebSrv1</kbd>.</p>
<p><span class="packt_screen">VM disk type</span> lets us choose between two values—<span class="packt_screen">HDD</span> and <span class="packt_screen">SSD</span>. This can be critical for our VM as the disk type can significantly impact performance. As this impacts the price of the VM as well, we need to find a balance and choose based on expected workloads. Choosing <span class="packt_screen">HDD</span> may be good enough if we create a web server but if you're going to deploy a database server, <span class="packt_screen">SSD</span> is the recommended option.</p>
<p>The <span class="packt_screen">Username</span> option doesn't allow us to use most common server usernames such as <kbd>Admin</kbd>, <kbd>Administrator</kbd>, <kbd>SysAdmin</kbd>, and similar. This is in order to protect your cloud resources. As most Azure VMs with a public IP address can be accessed through RDP, it's critical to limit that access as much as possible. I have multiple VMs that are attacked daily and the most common attempts are made using these exact usernames. We can apply additional security to VMs and usernames, but we'll discuss that in later chapters.</p>
<p class="mce-root"/>
<p>Similar to any other resource, we need to provide information for the <span class="packt_screen">Subscription</span>, the <span class="packt_screen">Resource group</span>, and <span class="packt_screen">Location</span> where the <span>VM</span> will be deployed. An example of basic information can be seen in the screenshot shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-316 image-border" src="Images/e5f54b82-dcd4-422b-a6a4-a01e58b70e0f.png" style="width:21.25em;height:37.92em;" width="359" height="640"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Virtual Machine sizes</h1>
                </header>
            
            <article>
                
<p>The second step in the Azure Virtual Machine creation blade is to choose the size of your VM. The size of the VM will determine three things—the number of CPUs, the amount of memory, and the type of OS disk. As you choose the type of disk in step one as well, this will narrow down the options that are available. VM sizes have three different pricing tiers:</p>
<ul>
<li>Basic</li>
<li>Standard</li>
<li>Low priority</li>
</ul>
<p>Basic-tier VMs are intended for <kbd>dev/test</kbd> environments and, even though they have a similar performance to VMs on the standard tier, there are a few limitations. They have lower IOPS than standard-tier VMs and don't support load balancing or auto-scaling.</p>
<p>Standard-tier VMs are intended to be used in a production environment and have better CPUs and IOPS performance.</p>
<p>Low-priority VMs are allocated based on free and unused resources in Azure Datacenter. They come with a lower price but can be unavailable at any time, as Microsoft Azure may claim these resources to satisfy requests with a higher priority. They are intended to be used for batch processing and random jobs.</p>
<p>But the pricing tier isn't the only thing to determine the price of your VM. Each tier has different sizes that provide a certain amount of CPU and memory; a higher amount equals a higher price.</p>
<p>The standard tier has additional categories based on the VM purpose:</p>
<ul>
<li>General-purpose</li>
<li>Compute-optimized</li>
<li>Memory-optimized</li>
<li>Storage-optimized</li>
<li>GPU</li>
<li>High-performance compute</li>
</ul>
<p>Most of these are self-explanatory as general-purpose has a balanced CPU-to-memory ratio, compute-optimized has more CPU, memory-optimized has more RAM, and storage-optimized has the best IOPS. GPUs are specialized VMs for heavy graphic rendering and video editing. High-performance VMs have at least eight vCPUs and use DDR4 RAM.</p>
<p>The size of the VM also determines the number of NICs that can be attached to your VM.</p>
<p>This can be from one to eight depending on purpose and size.</p>
<p>Options for selecting the VM size can be seen in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-317 image-border" src="Images/ada72268-d797-4cb6-8e9b-ec5d827cfa04.png" style="width:111.83em;height:63.58em;" width="1342" height="763"/> </div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Advanced VM options</h1>
                </header>
            
            <article>
                
<p>The third blade gives us the option to configure a lot of additional settings. In the previous chapter, we focused only on the networking part, but this time we'll explore these options more closely.</p>
<p>The high availability section gives us two options—<span class="packt_screen">Availability zone</span> and <span class="packt_screen">Availability set</span>. </p>
<p>The <span class="packt_screen">Availability zone</span> determines the zones inside the Azure Datacenter. These zones have an independent power source, networking, and cooling, and protect your VM against failures inside the Datacenter. If you have a critical service that will run on multiple <span>VM</span>s, you want to place these VMs in different availability zones so, if there is a failure on the Datacenter level, there is less chance that all your VMs will be impacted.</p>
<p><span class="packt_screen">Availability set</span> does similar things on a host level, ensuring that your <span>VM</span>s are placed across <span>multiple physical servers, compute racks, storage units, and network switches. If hardware failure occurs, there is less chance that all your VMs will be impacted. </span></p>
<p>Note that these availability options can't be changed later. You need to define the <span class="packt_screen">Availability zone</span> and <span><span class="packt_screen">Availability set</span> during the creation process. This is important to remember if you plan to design highly available solutions and services.</span></p>
<p>I'll place this VM in an <span class="packt_screen">Availability set</span> named <span class="packt_screen">(new) </span><span class="packt_screen">WebSet</span> as I intend to use it later. </p>
<p><span class="packt_screen">Storage</span> options allow us to choose between <span class="packt_screen">Disk type</span> and <span class="packt_screen">Use managed disks</span>. The <span class="packt_screen">Disk type</span> option is the same as we had before; we can choose between <span class="packt_screen">HDD</span> and <span class="packt_screen">SSD</span>. Depending on the size of VM chosen, all types of disk may not be available to choose here. If you want to choose a different option that is not available, you need to go back and choose a different size of VM.</p>
<p><span class="packt_screen">Use managed disks</span> are there to make our lives a little easier. This option was available from February 2017 and, prior to this, we need to manage storage on our own. Creating a disk actually creates a storage account and we needed to manage that storage. With a managed disk, we don't have to be <span>concerned with this and it's managed automatically. Storage is still created but, if we choose <span class="packt_screen">Use managed disks</span>, everything is handled in the background and no user action is required. This can be especially useful when scaling our VM (or VM Scale Sets). Managed disks also introduced a few very useful features such as snapshots and backups. I strongly recommend using a managed disk as this helps you get better performance with less management.</span></p>
<p><span>Setting for high availability and disks can be seen in the screenshot shown here:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-318 image-border" src="Images/1ba84a39-99de-4991-a2a5-5700e3d276cc.png" style="width:19.75em;height:22.17em;" width="352" height="396"/> </div>
<p>Networking options were covered in the previous chapter but let's quickly review what our options are here. We can select our VNet, subnet on that VNet, and public IP address for our VM. The last networking option is to select the <strong>network security group</strong> (<strong>NSG</strong>) for our VM. In the following screenshot, you can see that I selected <span class="packt_screen">PacktVNet</span> and the <span class="packt_screen">DMZ (10.1.1.0/24)</span> subnet. A new public IP address is created for my new VM as I intend to use it as a web server. As I have the NSG rule applied on the DMZ subnet, I don't want to separate the NSG on the VM level. This will help me simplify management and keep standardized rules across all my VMs, so I'll leave the NSG field blank as shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-319 image-border" src="Images/bb634969-8f14-4667-acf2-caa0c81a7705.png" style="width:18.50em;height:25.00em;" width="348" height="471"/> </div>
<p><span class="packt_screen">Extensions</span> gives us the option to add additional features to our VM. You can choose from set predefined software or execute a custom script that will install additional software or features.</p>
<p><span class="packt_screen">Auto-shutdown</span> can help you save on computing hours if you don't need the VM to run 24/7. For example, if this is a <kbd>dev</kbd> environment and no one is using it after work hours, you can set <span class="packt_screen">Auto-shutdown</span> to shut down your VM every day at 5 p.m. so you don't pay for it overnight. Of course, if this web or database server is in production, this isn't an option you really want to use.</p>
<p><span class="packt_screen">Monitoring</span> can be <span class="packt_screen">Enabled</span> for boot diagnostics and guest OS monitoring. This is beside the basic monitoring options that are available by default. Both of these options will require a storage account where logs will be stored. Avoid using storage that is used for a VM disk as this can cause performance issues. If your VM is having performance issues on a disk level, this will generate more logs, and these logs will increase the load on storage on top of that. This will cause more disk issues and you will be in an infinite loop where you won't be able to see if the issue is caused by disk or by logs.</p>
<p>The last options are <span class="packt_screen">Managed service identity</span> and <span class="packt_screen">Backup</span>. <span><span class="packt_screen">Managed service identity</span> </span>allows you to use your Azure Active Directory with your VM, and <span class="packt_screen">Backup</span> will create an additional backup service (Azure Backup). Both of these services will be covered in more depth later.</p>
<p>Options for <span class="packt_screen">Extensions</span>, <span class="packt_screen">Auto-shutdown</span>, <span class="packt_screen">Monitoring</span>, <span class="packt_screen">Managed service identity</span>, and <span class="packt_screen">Backup</span> can be seen in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-320 image-border" src="Images/7afa1b96-e018-436e-8a12-fafbe642b7e3.png" style="width:15.92em;height:34.08em;" width="296" height="635"/> </div>
<p>Finally, we can start deployment and after a few minutes we can start using our VM. As I mentioned before, the time taken to create a new VM can depend on the size of the VM and the availability of resources in the Azure Datacenter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Managing Azure Virtual Machines</h1>
                </header>
            
            <article>
                
<p>After deployment is completed, we can see four different resources have been created—<kbd>Virtual machine</kbd>, <kbd>Disk</kbd>, <kbd>Network interface</kbd> and <kbd>Public IP address</kbd>. A <kbd>Public IP address</kbd> is optional and doesn't need to be created if you intend to use and manage the VM only using private IP addresses with the use of VPN. If a managed disk wasn't chosen, there would be a storage account where the disk would be placed here as well, as shown:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-321 image-border" src="Images/4623beb7-47da-4285-8135-5d5d0fc7c3de.png" style="width:98.33em;height:18.58em;" width="1180" height="223"/></div>
<p>Every one of these resources has different options for management. We have already seen options for IP addresses and NICs; we'll explore disk and storage in later chapters. For now, let us focus on the VM and what options are available to us for administration and management. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">VM settings</h1>
                </header>
            
            <article>
                
<p>Under the <span class="packt_screen">Virtual Machine</span> blade, we have various options such as <span class="packt_screen">SETTINGS</span>, <span class="packt_screen">OPERATIONS</span>, <span class="packt_screen">MONITORING</span>, and <span class="packt_screen">SUPPORT</span>. Under <span><span class="packt_screen">SETTINGS</span></span>, we have multiple choices as well: <span class="packt_screen">Networking</span>, <span class="packt_screen">Disks</span>, <span class="packt_screen">Size</span>, <span class="packt_screen">Security</span>, <span class="packt_screen">Extensions</span>, <span class="packt_screen">Availability set</span> and <span class="packt_screen">Configuration</span>. <span class="packt_screen">Properties</span>, <span class="packt_screen">Locks</span> and <span class="packt_screen">Automation script</span> are available as for all other Azure resources as well. Note that we have <span class="packt_screen">Continuous delivery (Preview)</span> here as well. Preview features are still in development and they aren't intended for production purposes. It's fine to test but avoid depending on these features until they are officially released. In this instance, <span class="packt_screen">Continuous delivery (Preview) </span><span>allows us to connect to VSTS projects and make easier CI/CD. </span></p>
<p>Some options here are similar to options in the VM creation process. <span class="packt_screen">Size</span> will allow us to open the blade to choose a different size for our VM at any time. Note that to complete this process, a restart of the VM is required. <span class="packt_screen">Extensions</span> can be used to add software or execute custom scripts, the same as before. <span class="packt_screen">Availability set</span> is only for information purposes as this setting needs to be defined during VM creation. <span class="packt_screen">Security</span> and <span class="packt_screen">Configuration</span> will be our focus in chapters to come and we'll leave these settings as defaults for now.</p>
<p>The <span class="packt_screen">Networking</span> option gives us an overview of all network information regarding our VM. We can see NIC information, what addresses are associated with our VM, the network security group associated with the VM and all NSG rules. We can attach additional NICs here and add additional NSG rules. Note that in the following screenshot, the NSG is applied on the subnet level. If changes are made to the NSG, these will be applied to all VMs on this subnet so you need to be careful. For example, if this subnet had multiple VMs and we wanted to allow RDP access to a single one, creating this rule would result in all VMs being accessible over RDP:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-323 image-border" src="Images/2204e568-b80d-45e0-a6bf-0d450f733157.png" style="width:108.83em;height:60.08em;" width="1306" height="721"/></div>
<p>Under the disk blade, we can see all disks associated with our <span>VM</span>. The OS disk can't be changed, data disks can be added or removed. An example of the disk blade can be seen in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-324 image-border" src="Images/e77ab337-1867-48a3-b7f4-4eafdd91080e.png" style="width:107.33em;height:34.08em;" width="1288" height="409"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Virtual Machine operation and monitoring</h1>
                </header>
            
            <article>
                
<p><span><span class="packt_screen">OPERATIONS </span></span>and <span class="packt_screen">MONITORING</span> give us more administration and managing options for our Azure Virtual Machines. In <span class="packt_screen">OPERATIONS</span>, we have <span class="packt_screen">Auto-shutdown</span>, <span class="packt_screen">Backup</span>, <span class="packt_screen">Disaster recovery</span>, <span class="packt_screen">Update management</span>, <span class="packt_screen">Inventory</span>, <span class="packt_screen">Change tracking</span>, and the <span class="packt_screen">Run command</span>. We will explain <span class="packt_screen">Auto-shutdown</span> and the <span class="packt_screen">Run command</span> now but the rest of these features require additional services that we'll cover later.</p>
<p>We have a similar situation with <span><span class="packt_screen">MONITORING </span></span>, we'll cover <span class="packt_screen">M</span><span class="packt_screen">etrics</span> and <span class="packt_screen">Alerts (classic)</span> now and the rest of the services will be explained in the chapters to come.</p>
<p class="mce-root CDPAlignLeft CDPAlign">The <span class="packt_screen">Auto-shutdown</span> option enables you to schedule the shutdown of your <span>VM</span> in Azure. As I mentioned before, this option allow us to save money if we don't need the VM to run all the time. The feature is intended to be used in <kbd>dev/test</kbd> environments and isn't for production.</p>
<p class="mce-root CDPAlignLeft CDPAlign">However, I've seen people using it for applications that are needed only during working hours. In that case, <span class="packt_screen">Auto-shutdown</span> is used to turn the VM off at specific times and use Azure Automation for starting it before work hours begin. Other than for scheduled time, we have options to send a notification when the VM is going to be turned off. This allows us to notify people using the VM that shutdown will occur. We can use email or webhooks for these notifications. The following screenshot shows the <kbd>run</kbd> script option. We can use various prepared scripts such as <kbd>EnableAdminAcount</kbd>, <kbd>SetRDPPort</kbd>, <kbd>ResetAccountPaasword</kbd>, and so on. Or we can execute a custom script against our VM. Options for script execution can be seen in following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-327 image-border" src="Images/c4f403d6-fde6-4601-8ea4-9f5232475398.png" style="width:47.50em;height:24.75em;" width="760" height="396"/></div>
<p>The running command can be done directly through the portal. This can be really useful when we can't access the VM any other way (for example, from a mobile device or machine that doesn't have PowerShell). An example is shown in the following screenshot where the script to enable <kbd>PSRemoting</kbd> is executed:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-865 image-border" src="Images/51fc783d-335b-499a-ba91-145be37d7cd5.png" style="width:52.50em;height:33.33em;" width="630" height="400"/><br/>
 </div>
<p>Here is also the script to enable <kbd>PSRemote</kbd> on the Azure Virtual Machine:</p>
<pre class="mce-root">Enable-PSRemoting -Force<br/>New-NetFirewallRule -Name "Allow WinRM HTTPS" -DisplayName "WinRM HTTPS" -Enabled True -Profile Any -Action Allow -Direction Inbound -LocalPort 5986 -Protocol TCP<br/>$thumbprint = (New-SelfSignedCertificate -DnsName $env:COMPUTERNAME -CertStoreLocation Cert:\LocalMachine\My).Thumbprint<br/>$command = "winrm create winrm/config/Listener?Address=*+Transport=HTTPS @{Hostname=""$env:computername""; CertificateThumbprint=""$thumbprint""}"<br/>cmd.exe /C $command</pre>
<p>Monitoring your Azure resources is important on many levels. It gives you the ability to see your resource consumption and plan the pricing tier accordingly. If monitoring shows that your resources are under a certain percentage of workload, it's probably a good idea to lower the resource tier. If it's another way around and you have a high percentage all the time, it's probably a good idea to change to a higher tier. A lot of different metrics are available but not for CPU and memory monitoring, you need to enable guest-level monitoring. Metrics gives us the option to change different metrics over different time periods. An e<span>xample is show in the screenshot here where you can see graphs on disk <kbd>read</kbd> and <kbd>write</kbd> operations over the last hour:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-863 image-border" src="Images/50694a93-185e-44c2-afd6-a6ef62bdc8ca.png" style="width:90.17em;height:48.75em;" width="1082" height="585"/></div>
<p>Alerts are an essential part of your Azure resource management and can be real lifesavers. In alerts, you can create custom rules that will notify you if a defined trigger is activated. For example, you can set up alerts that will notify you if the CPU reaches a threshold of 90% utilization over a period of more than 5 minutes. Similar to auto-shutdown, you can send notifications via email or webhooks.</p>
<p class="mce-root"/>
<p>This example is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-864 image-border" src="Images/f7baf9a3-0b9b-4099-a3cf-2882166e2225.png" style="width:30.25em;height:54.25em;" width="426" height="764"/></div>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Beside sending a notification, alerts can be set to trigger a custom action with the use of runbooks or logic apps. Both are powerful tools to perform custom actions when needed. The logic app is easy to use with workflow diagrams that enable you to drag and drop actions that need to be taken, in order to perform some maintenance tasks or resolve issues. Runbooks require an Azure Automation account and can perform actions based on predefined plans or use custom scripts. Most administrators find runbooks more useful as they allow you to perform any type of action using PowerShell. In my opinion, both are very useful but administrators find runbooks more familiar as they can use PowerShell, which is the tool they used for on-premises administration:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-331 image-border" src="Images/cf66f9de-c614-4550-837e-1f54c3979c51.png" style="width:43.50em;height:11.50em;" width="623" height="164"/> </div>
<p>If we select to perform an action via runbooks, we can select either a user-defined or <span>built-in action. With a user-defined action, you need to select an automation account and select a custom runbook in that account to be executed. This can be any type of script that will be executed on your Azure VM.</span> </p>
<p><span class="packt_screen">Built-in</span> action offers you five options: <span class="packt_screen">Restart VM</span>, <span class="packt_screen">Stop VM</span>, <span class="packt_screen">Scale Up VM</span>, <span class="packt_screen">Scale Down VM</span>, and <span class="packt_screen">Remove VM.</span> An example of a runbook configuration is shown here with <span class="packt_screen">Built-in</span> runbooks listed:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-332 image-border" src="Images/07fffd74-9c90-4a0e-944e-c622591f7b28.png" style="width:19.00em;height:26.50em;" width="352" height="491"/></div>
<p><span>Most of these actions are self-explanatory, but note that you have <span class="packt_screen">Scale Up VM</span> and <span class="packt_screen">Scale Down VM</span>. This allows us to create a scaling up or scaling down of our resources based on demand. One of the cloud's benefits is to pay for what you use, when you use it. So, if our VM can handle workloads 90% of the time but we have peaks in workload only occasionally, we try to avoid paying more to satisfy only peaks. If we scale up permanently only to handle peak workloads, we pay more and now have a VM that isn't fully utilized 90% of the time, as a lower price VM could handle everything but peak periods. Setting up a <span class="packt_screen">Scale Up VM</span> rule allows you to change your VM size to a higher tier in case 90% CPU is reached. This will enable your VM to handle workloads when the threshold is reached and increase the VM size on demand. To make the most out of what Microsoft Azure is offering, you need to create a similar rule in the other direction, to scale down once workload decreases. Having only a rule to scale up will increase the price of your VM and you will end up paying more. To prevent this, you can create a rule that when the CPU falls below 40%, a <span class="packt_screen">Scale Down VM</span> action is performed and the VM is reverted to its original size. This way you will pay for more only when workload demands, and pay less for periods when workload isn't high.</span></p>
<p>The <span class="packt_screen">SUPPORT + TROUBLESHOOTING</span> section give us a few additional options. <span class="packt_screen">Resource health</span> and <span class="packt_screen">New support request</span> are options present for all Azure resources. The first one gives you information if there is an issue with your VM on the Azure Datacenter level, and the second one takes you to the form to submit an Azure support ticket. <span class="packt_screen">Resource health</span> can be useful to check when your resource isn't performing as usual. This can save you time troubleshooting and trying to figure out what went wrong when in fact there is a large issue at the Datacenter level you can't do anything about. Luckily, this isn't a common occurrence.</p>
<p><span class="packt_screen">Boot diagnostics</span> gives you the ability to see the current screen of your VM and serial log. It can be very helpful when the VM is unresponsive in order to check the current state.</p>
<p>With the <span class="packt_screen">Reset password</span> option, you can reset the password for the VM but only if you know the correct username. Once you log in to the VM, you'll need to reset the password again as the password used here is only temporary. <span class="packt_screen">Reset password</span> also has the option to reset the r<span>emote desktop service configuration. </span></p>
<p><span class="packt_screen">Serial console (Preview)</span> gives you access to Windows serial console through your browser. However, this feature is still in preview so you shouldn't rely on it too much.</p>
<p><span class="packt_screen">Redeploy</span> is a very interesting feature. If your VM is unresponsive and you can't connect, you can use this feature. Redeploying the VM will migrate your VM to a new host in the Azure Datacenter to try to fix your issue. Migration will cause the reboot of your VM, which is unresponsive to begin with, so this isn't really an issue and may resolve the problem you have.<br/>
Features and options listed here are management options specific to Azure Virtual Machines. Managing the VM continues with the use of standard administrator tools. We can connect to the VM via RDP and perform any kind of task we want. We can install roles and features to our VM, add any kind of third-party software or our custom software. Other administration tools such as <strong>Remote Server Administration Tools</strong> (<strong><span>RSAT</span></strong>) or PowerShell are also options.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Load Balancers</h1>
                </header>
            
            <article>
                
<p>Deploying Azure Virtual Machines is the first step but what about business critical services and applications. For these, we'll probably want to design highly available solutions that will have the best possible <strong>service level agreement</strong> (<strong><span>SLA</span></strong>) and uptime. </p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The first step for this must be performed during VM creation with the setting up of an <span class="packt_screen">Availability zone</span> and <span class="packt_screen">Availability set</span>. Then we add another VM to our solution with a different <span class="packt_screen">Availability zone</span> and the same <span class="packt_screen">Availability set</span>. This will ensure that the VMs are placed in different zones in the Azure Datacenter and don't depend on the same power source, networking, and cooling. If there is an issue within the Azure Datacenter, there is less chance that both VMs will be impacted. </p>
<p>Setting up the same <span class="packt_screen">Availability set</span> will insure that VMs are placed on different <span>physical servers, compute racks, storage units, and network switches.</span> If hardware failure occurs, there is less chance both VMs will be affected. Another thing availability set takes care of is that Microsoft will never perform maintenance that will impact both VMs at the same time. To keep Azure Datacenters secure and performing in the best possible way, maintenance tasks must be performed periodically to install updates to hosts, or upgrade firmware on hardware. Placing VMs in an availability set informs Microsoft that these VMs are set up to achieve high availability, and maintenance will be performed keeping this in mind and never affecting all VMs at the same time.</p>
<p>So, to achieve high availability, we need at least two VMs set up. But what about traffic? How do we direct whether something goes to the first or the second VM? If the first VM isn't available, how do we direct traffic to the second one?</p>
<p>This is where Azure Load Balancers come into play. <span>This is one of Azure's network services that we skipped before and will explain when the time is right. We will have similar situations in later chapters as well. </span>Azure Load Balancers distribute incoming traffic from frontend to backend pool instances. They can support both inbound and outbound scenarios with <span>low latency and high throughput. In this scenario, incoming traffic would come to the Load Balancer IP and the Load Balancer would distribute traffic to VMs configured in the backend pool. Azure Load Balancer can be internal or public, depending on what kind of traffic we need to distribute. For web server roles, we probably want public Load Balancers. But in the case of a database server, we probably want to use an internal one as we don't want databases exposed over the internet.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Load Balancer</h1>
                </header>
            
            <article>
                
<p>To create a new Azure Load Balancer, we need to select to create a new resource and select Azure Load Balancer from the list. This will open the create load Balancer blade where we need to provide basic information. </p>
<p>The information that is the same for all resources are <span class="packt_screen">Name</span>, <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource group</span>, and <span class="packt_screen">Location</span>.</p>
<p>Options specific to Azure Load Balancer are <span class="packt_screen">Type</span>, <span class="packt_screen">SKU</span>, and <span class="packt_screen">Public IP address</span>.</p>
<p>The <span class="packt_screen">Type</span> of Load Balancer can be internal or external, depending on what kind of traffic you want to route. A <span class="packt_screen">Public</span> type must have the public IP address configured and I recommend you place static for this IP address. Optionally, you can enable Public IPv6 for your Azure Load Balancer while Public IPv4 is the default. </p>
<p>The <strong>stock keeping unit</strong> (<strong><span>SKU</span></strong>) can be <span class="packt_screen">Basic</span> or <span class="packt_screen">Standard</span>. <span class="packt_screen">Standard</span> has more options and features available but comes at a price that is formed based on the number of load-balancing rules. On the other hand, <span class="packt_screen">Basic</span> is free of charge and the only fee associated with it comes from reserving public IP addresses and outbound traffic.</p>
<p>An example of the information needed to create a new Azure Load Balancer is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-334 image-border" src="Images/3e75172d-09fe-4df3-8579-5e84925d8ac3.png" style="width:33.42em;height:38.17em;" width="682" height="779"/> </div>
<p>Deployment of most Azure Network features is done in under one minute. Azure Load Balancer is no different and deployment should complete very quickly.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Configuring the Azure Load Balancer</h1>
                </header>
            
            <article>
                
<p>After the deployment of the Azure Load Balancer is completed, we can go to the resource and find different options. <span class="packt_screen">SETTINGS</span> is of most interest to us and we'll need it to configure our Load Balancer. We can find standard Azure resource settings such as <span class="packt_screen">Properties</span>, <span class="packt_screen">Locks</span>, and <span class="packt_screen">Automation script</span> that can be found for all Azure resources. Frontend IP configuration gives us the ability to manage IP addresses associated with our Load Balancer, add new IP addresses, or remove existing ones. Other settings will be needed to configure our Load Balancer to distribute incoming traffic and to configure where that traffic should be directed to.</p>
<p>First, we need to configure the <span class="packt_screen">Backend pools</span> for our Load Balancer. I'll select my Load Balancer to be associated to an <span class="packt_screen">Availability set</span>. Previously in this chapter, I created a VM named <kbd>WebSrv1</kbd> with an <span class="packt_screen">Availability set</span> named <kbd>WebSet</kbd>. Then I added an identical VM named <kbd>WebSrv2</kbd> and added it to the same <span class="packt_screen">Availability set</span>. So, I have two identical VMs in the same <span class="packt_screen">Availability set</span> and I have associated my Azure Load Balancer to this set. Finally, we have to define the network IP configuration that will be used and set it up to use both VMs in this availability set. If we had more VMs in this <span class="packt_screen">Availability set</span>, we could set up more IP configurations to be targeted. An example of how to set up a backend pool is shown in this screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-336 image-border" src="Images/4abd8206-2a47-4604-a6ce-b34f733f36b8.png" style="width:42.08em;height:44.67em;" width="720" height="764"/> </div>
<p>The second step is to set up health probes. We need to define the <span class="packt_screen">Protocol</span>, <span class="packt_screen">Port</span>, <span class="packt_screen">Interval</span>, and <span class="packt_screen">Unhealthy threshold</span>. <span class="packt_screen">Protocol</span> and <span class="packt_screen">Port</span> will define what needs to be monitored. As I intend to use <kbd>WebSrv1</kbd> and <kbd>WebSrv2</kbd> as web servers, I'll set up monitoring on port <kbd>80</kbd>. <span class="packt_screen">Interval</span> will define how often a check needs to be performed in order to make sure the server is responsive. The threshold defines how many consecutive intervals must probe and fail to contact the server in order to declare it unresponsive. An example of how to set up a health probe on port <kbd>80</kbd> is shown in this screenshot: </p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-337 image-border" src="Images/c915be24-918e-4423-a05c-55067b47026b.png" style="width:42.00em;height:42.33em;" width="761" height="768"/></div>
<p class="mce-root"/>
<p class="mce-root"/>
<p><span>As I want to use the web server role, I'll repeat the same thing for port <kbd>443</kbd>. In the screenshot here, we can see both probes are created but the <span class="packt_screen">USED BY</span> information is empty:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-338 image-border" src="Images/cf31447c-8b5f-400e-ac4a-92d4c462fc67.png" style="width:99.42em;height:12.08em;" width="1193" height="145"/></div>
<p>In the third step, we create a load-balancing rule. We need to provide a <span class="packt_screen">Name</span>, <span class="packt_screen">IP Version</span>, <span class="packt_screen">Frontend IP address</span>, <span class="packt_screen">Protocol</span>, <span class="packt_screen">Frontend port</span>, <span class="packt_screen">Backend port</span>, <span class="packt_screen">Backend pool</span>, <span class="packt_screen">Health probe</span>, <span class="packt_screen">Session persistence</span>, and <span class="packt_screen">Idle timeout (minutes)</span>. <span class="packt_screen">Name</span> and <span class="packt_screen">IP Version</span> are self-explanatory options, so let's jump on the rest of them. </p>
<p>For the <span class="packt_screen">Frontend IP address</span>, you can choose any of the Load Balancer IP addresses as it can be associated with multiple IP addresses. There is a restriction on what IP address you can choose based on the IP version selected. If the <span class="packt_screen">IP Version</span> is set to <span class="packt_screen">IPv4</span>, you can select only the <span class="packt_screen">IPV4</span> IP address. If <span class="packt_screen">IPv6</span> is selected, only the IP addresses of the same version associated with the Load Balancer can be selected.</p>
<p><span class="packt_screen">Protocol</span> and <span class="packt_screen">Port</span> are connected, with this option you select what protocol needs to be forwarded from the defined port to the defined <span class="packt_screen">Backend port</span>. For example, TCP on port <kbd>80</kbd> should be forwarded to port <kbd>80</kbd>.</p>
<p>With the <span class="packt_screen">Backend pool</span>, we define where traffic is forwarded to. As you can have multiple backend pools in a single Azure Balancer, you can select any of these pools. </p>
<p><span class="packt_screen">Health probe</span> needs to be selected in order to have a check on the VM state. You need to select the probe that performs a check on the backend port used in the rule you are creating.</p>
<p>Options for <span class="packt_screen">Sessions persistence</span> and <span class="packt_screen">Idle timeout <span>(minutes)</span></span><span> </span>are related to how client connections should be handled. As you have at least two VMs in your <span class="packt_screen">Backend pool</span>, you need to set traffic to be handled by the same VM for the duration of one session. If you select that traffic coming from the same client IP over the same protocol, this should keep the session alive. The client will be directed to the same VM as long as the session is active.</p>
<p><span class="packt_screen">Idle timeout<span> </span><span>(minutes)</span></span> determines how long the session will stay active if no action is taken. The default value is <span class="packt_screen">4</span> minutes but it can be changed to up to <span class="packt_screen">30</span> minutes. With this setting, you determine how long the session will be active if the client isn't using the application, and isn't sending any messages in order to keep the session alive.</p>
<p>The option for a Floating IP (direct server return) address is <span class="packt_screen">Disabled</span> by default and should only be used with <span class="packt_screen">SQL AlwaysOn Availability Listener</span>.</p>
<p>In the screenshot here, you can see the options to set up the load-balancing rule, <span class="packt_screen">HTTP</span>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-339 image-border" src="Images/361606ca-297e-4c2b-8034-8a978c421af1.png" style="width:37.75em;height:52.67em;" width="562" height="785"/></div>
<p>I'll create another rule named <span class="packt_screen">HTTPS</span> for port <kbd>443</kbd>. Note in the screenshot here, that probes created earlier are now used by load-balancing rules:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-340 image-border" src="Images/729b8657-8a15-4fe2-92e0-70e2efd081f2.png" style="width:106.00em;height:11.08em;" width="1272" height="133"/></div>
<p>The last option in the Load Balancer settings is the inbound NAT rule. It has similar options as the load-balancing rule with one exception. Traffic, in this case, isn't forwarded to the backend pool but to a single <span>VM</span>. In the screenshot here, you can see how to set up an inbound NAT rule that will forward traffic coming over port <kbd>5589</kbd> (<span class="packt_screen">WinRM</span>) to <span class="packt_screen">WebSrv1</span>:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-341 image-border" src="Images/bd281842-088e-4403-8c24-9458d1c5afad.png" style="width:29.92em;height:36.75em;" width="631" height="776"/></div>
<p class="mce-root"/>
<p><span>So, let's review what was achieved with setting the Load Balancer and availability set. We have two VMs acting as web servers in the backend pool. VMs are placed in different availability zones and the same availability set in order to increase the chance that at least one of the VMs is running. Health probes are checking if VMs are available on the defined port. If any of the VMs is unresponsive to two consecutive checks, it will be declared as failed. A load-balancing rule is set up to forward traffic that is coming over the Load Balancer public IP address to the backend pool. If both VMs in the backend pool are healthy, traffic will be forwarded on the round-robin rule. If the health probe declares any of the VMs unresponsive, all traffic will be forwarded to the VM that is in a healthy state. Sessions are kept alive based on the client IP, protocol, and idle timeout. Sessions from the same IP address over the same protocol will be forwarded to the same VM as long as a keep-alive signal is sent at least every 4 minutes.</span></p>
<p>This will ensure our application is up and running, even if a single VM fails. Failures can be caused by hardware or network errors in the Azure Datacenter (the a<span>vailability </span>zone and availability set ensure that both VMs are not affected). Placing more VMs in the a<span>vailability set and backend pool increases the chances that at least one VM is up and running. </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Load Balancer ARM template</h1>
                </header>
            
            <article>
                
<p>Here is the ARM template for creating a new Azure Load Balancer:</p>
<div>
<pre>{<br/>"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",<br/>"contentVersion": "1.0.0.0",<br/>"parameters": {<br/>"name": {<br/>"type": "string"<br/>},<br/>"location": {<br/>"type": "string"<br/>},<br/>"sku": {<br/>"type": "string"<br/>},<br/>"publicIPAddressName": {<br/>"type": "string"<br/>}<br/>},<br/>"resources": [<br/>{<br/>"apiVersion": "2017-08-01",<br/>"name": "[parameters('name')]",<br/>"type": "Microsoft.Network/loadBalancers",<br/>"location": "[parameters('location')]",<br/>"sku": {<br/>"name": "[parameters('sku')]"<br/>},<br/>"dependsOn": [<br/>"[concat('Microsoft.Network/publicIPAddresses/', parameters('publicIPAddressName'))]"<br/>],<br/>"properties": {<br/>"frontendIPConfigurations": [<br/>{<br/>"name": "LoadBalancerFrontEnd",<br/>"properties": {<br/>"publicIPAddress": {<br/>"id": "[resourceId('test', 'Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"<br/>}<br/>}<br/>}<br/>]<br/>}<br/>},<br/>{<br/>"apiVersion": "2017-08-01",<br/>"type": "Microsoft.Network/publicIPAddresses",<br/>"name": "[parameters('publicIPAddressName')]",<br/>"location": "[parameters('location')]",<br/>"sku": {<br/>"name": "[parameters('sku')]"<br/>},<br/>"properties": {<br/>"publicIPAllocationMethod": "Dynamic",<br/>"publicIPAddressVersion": "IPv4"<br/>}<br/>}<br/>]<br/>}</pre></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Virtual Machine Scale Set</h1>
                </header>
            
            <article>
                
<p>Elasticity is one of the big benefits of cloud computing. We have the ability to scale up and down based on our workloads and demand. If we have increased workload, we scale up. If workload decreases, we scale back down. With a pricing model of paying for what you use and billing by the minute, this allow us to save money. </p>
<p>We have already explained how to set up scale up and scale down <span>VM</span>s in Microsoft Azure. Scaling up and down means to change the size of the VM to a bigger or smaller instance. This is called vertical scaling. This can be very useful, but this approach has one consequence—every time a VM size is changed, reboot occurs. So, vertical scaling can be helpful as it can increase the size of the VM to handle more workload, but it will always cause downtime in the period when the VM is rebooting.</p>
<p>The solution for this is horizontal scaling, and for Azure Virtual Machines we can use Azure Virtual Machine Scale Set. Instead of changing the size of the VM, scale set creates additional instances of the VM and spreads the workload across instances using Azure Load Balancer. This is called horizontal scaling. The approach is similar to the high availability scenario but, instead of having multiple VMs in the availability set, scale set starts VMs based on workload and starts them only when needed. Another difference is that in the availability set, VMs are independent and an issue on one VM will not cause an issue on others. In scale set, all VMs take a copy of the primary VM, and if the primary VM is compromised, the issue will reflect across the scale set. We need to outline that the scale set is not a high availability solution but horizontal scaling based on workloads.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Virtual Machine Scale Set</h1>
                </header>
            
            <article>
                
<p>Let's create a new Azure Virtual Machine Scale Set and explain all the details as we go.</p>
<p>To create a new <span>Azure Virtual Machine Scale Set, all information is provided in a single screen. In order to make it more visible, I have separated the screen into three images—basic and instances, autoscale, and networking.</span></p>
<p>The basic information for Scale Set is very similar to the basic information for <span>VM</span>s. This is only logical as scale set creates a primary VM and then clones this VM in order to scale out. We need to provide a <span class="packt_screen">Virtual machine scale set name</span>, <span class="packt_screen">Operating system disk image</span>, <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource group</span>, <span class="packt_screen">Location</span>, <span class="packt_screen">Username</span>, <span class="packt_screen">Password</span>, and optionally add an <span class="packt_screen">Availability zone</span>.</p>
<p>Next, we create the instance rules. This will determine the size of VMs in Scale Set and how many instances scale set is allowed to create. The maximum number of instances allowed is 1,000 for Azure-provided OS images and 300 for custom OS images. If you have an issue on the application and the application itself is causing high CPU or memory, it will cause scale set to scale out and create new instances. As new instances are an identical replica of the primary VM, the issue will persist on these VMs and scaling out will continue until you reach the maximum instance count. It's important to set up an instance count to something you are actually ready to pay for, as spinning 1,000 VMs can cause significant financial impact, even for a short period of time.</p>
<p>Deploying scale set VMs as low-priority can save you up to 80% in prices. Low-priority VMs are created using allocated and unused resources in the Azure Datacenter but these resources can be claimed by higher priority resources and can be unavailable at any time. So, even if this option can help you save a lot of money, resources may not be available when needed. This option shouldn't be used for services that are required to be available at any time, or for critical services. The recommendation is to use lower priority only for low-priority services or batch processing.</p>
<p>Scale Set creates multiple instances of a VM and all these VMs have a separate disk. Managing these disk and storage accounts in a scale-out process, especially when we spin up 1,000 instances, can prove to be very challenging. I recommend using a managed disk that will be managed by Azure automatically so you don't need to worry about this part.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>An example of basic and instance settings is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-342 image-border" src="Images/71462f2b-fd3d-4bb9-a355-caf8117293ce.png" style="width:62.58em;height:65.67em;" width="751" height="788"/></div>
<p>Auto-scale creates a set of rules on how your scale set is going to scale in and out. We need to set a minimum and maximum number of VMs in our scale set. A maximum number is automatically collected from the instance count previously set, but it doesn't have to be the same. The <span class="packt_screen">Instance count</span> determines how many VMs are going to be created initially but the maximum number determines how many VMs can be created in total.</p>
<p>We create scale-out and scale-in rules that will increase and decrease the number of VMs in our scale set. For example, if the threshold reaches <kbd>75</kbd>% of CPU utilization, it will spin up additional VM(s). If utilization falls below <kbd>25</kbd>%, it will decrease the number of <span>VM(s) in the scale set. The number of VMs that will be added/removed can be set as a separate value.</span></p>
<p>Let's say that we set a minimum number of VMs to <kbd>1</kbd>, the instance count to <kbd>10</kbd> and the maximum number of VMs to <kbd>100</kbd>. When the scale set is created, it will create <kbd>10</kbd> copies of the VM and start only one of them, the primary copy. When the scale-out threshold is reached, it will add a new VM to Scale Set. This VM is one of <kbd>10</kbd> initially created. If utilization continues to rise, it will add new VMs until we reach 10 VMs. If the maximum number of VMs is different from the instance count, new VMs will be created and started. The difference between the first <kbd>10</kbd> VMs and later ones is that initial VMs are already created and only need to be started. Additional VMs need to be provisioned before being started and this makes the process of scaling out slower. However, initial VM comes with a cost even when not running, as you pay for the disk even when the VM is turned off. It's good to find a balance between the initial number and maximum number <span>of VMs . <span class="packt_screen">AUTOSCALE</span> is shown in the following screenshot:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-343 image-border" src="Images/016cc75a-1afb-4c65-83c3-57a003b762a0.png" style="width:62.58em;height:31.58em;" width="751" height="379"/></div>
<p>The <span class="packt_screen">NETWORKING</span> part gives us the option to choose between the <span class="packt_screen">Application Gateway</span> and <span class="packt_screen">Load balancer</span>. Whatever you choose, this will be used as the endpoint for your users and it will automatically disperse traffic across the Azure Virtual Machine Scale Set. The <span class="packt_screen">Load balancer</span> in Azure Virtual Machines is free and <span><span class="packt_screen">Application Gateway</span> is billed per hour but supports many additional features. </span><span><span class="packt_screen">Application Gateway</span> supports SSL termination, URL-based routing, multisite routing, cookie-based session affinity, web application firewalls, and routable IP addresses. </span></p>
<p>When using the <span class="packt_screen">Load balancer</span>, the difference between one used in the availibility set and scale set is that for scale set no additional management is needed (you have the option to set additional rules and settings, but it's not required). Load-balancing rules and adding VMs to the backend pool is done automatically and no user action is required. An example of network settings with the Azure Load Balancer is shown in the screenshot here:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-344 image-border" src="Images/50396904-101b-40e4-80d5-10eb715eaf66.png" style="width:62.42em;height:34.50em;" width="749" height="414"/></div>
<p>Deployment of Azure Virtual Machine Scale Set depends on many different parameters. Network services needed for scale set must be deployed prior to the VMs, but this process is done very quickly. Then, VMs are deployed and this can take time depending on the instance count and VM size. Deploying a few large instances can be done relatively quickly, but if we deploy hundreds of small VMs, it can take up to an hour.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Managing Azure Virtual Machine Scale Sets</h1>
                </header>
            
            <article>
                
<p>After deployment is finished, multiple resources are created in our resource group and we can see <span class="packt_screen">Virtual machine scale set</span> and a set of network-related resources. Network resources created are a <span class="packt_screen">Load balancer</span>, <span class="packt_screen">Public IP address</span> (used by the <span>Load Balancer</span>), <span class="packt_screen">Virtual network</span>, and <span class="packt_screen">Network security group</span>. NSG is applied on the subnet level and NSG rules will be effective on all VMs in scale set. This makes sense as all VMs are identical, are used by the same application, and have the same purpose. <span>We can see in the screenshot here all the resources created for our scale set:</span></p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-345 image-border" src="Images/f8c23c8a-bdcf-4340-95d1-671ee9866cda.png" style="width:106.67em;height:19.50em;" width="1280" height="234"/></div>
<p>As we have already discussed all the networking features in question, we are going to concentrate on Virtual Machine Scale Set and options that are provided to manage it. A lot of options are identical to the VM settings such as <span class="packt_screen">Size</span>, <span class="packt_screen">Continuous delivery (Preview)</span>, <span class="packt_screen">Configuration</span>, <span class="packt_screen">Properties</span>, <span class="packt_screen">Locks</span>, and <span class="packt_screen">Automation script</span>. <span class="packt_screen">SETTINGS</span> that are unique to scale set are <span class="packt_screen">Instances</span>, <span class="packt_screen">Scaling</span>, <span class="packt_screen">Storage</span>, and <span class="packt_screen">Operating system</span>. <span class="packt_screen">Operating system</span> is only informational and we can see only information such as the image and OS version used to create a scale set.</p>
<p><span class="packt_screen">Storage</span> settings also gives us information on the type of storage and disks used with only one option to choose—<span class="packt_screen">C</span><span class="packt_screen">aching</span>. Options available are <span class="packt_screen">None</span>, <span class="packt_screen">Read-only</span>, and <span class="packt_screen">Read/write</span>.</p>
<p>The <span class="packt_screen">Instance</span> blade shows us all VMs in our scale set and their state. We can see which VMs are running and perform different operations such as <span class="packt_screen">S</span><span class="packt_screen">tart</span>, <span class="packt_screen">Stop</span>, <span class="packt_screen">De-allocate</span> and <span class="packt_screen">Delete</span>. Specially interesting options are <span class="packt_screen">Reimage</span> and <span class="packt_screen">Upgrade</span>. <span class="packt_screen">Reimage</span> will reset all settings on a selected VM and restore it to the default version. <span class="packt_screen">Upgrade</span> will perform a manual upgrade for a selected VM to the latest changes. All VMs in scale set are an identical replica of the primary VM and, if changes are made on the primary, they will be replicated to all instances in time. The <span class="packt_screen">Upgrade</span> option gives us the ability to perform upgrades manually and force changes immediately. This can be useful when we have a large number of VMs in scale set, as replicating changes will take time and change might be critical to be applied as soon as possible. However, both the <span class="packt_screen">Reimage</span> and <span class="packt_screen">Upgrade</span> options will reboot the VM in the process, so take that into consideration as well. The last option unique to the Azure Virtual Machine Scale Set is scaling, but it will take time to explain this option further.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The scaling blade shows us all the rules for scaling out and scaling in that are effective on our scale set. If rules are created during the deployment process, they will be shown here and we can edit them or delete them. Additional rules can be created as well and we can monitor multiple parameters for our VMs. For example, we can create separate rules for CPU, memory, and disk utilization. If any of these rules are triggered, it will perform scaling out or scaling in processes, accordingly. Creating more scale rules gives us better flexibility and performance as we don't depend on a single point. If we monitor CPU but have issues with memory, scaling out will not happen and performance will decrease. If we monitor memory but have high disk utilization, again we don't have automatic scaling out and performance will decrease:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-347 image-border" src="Images/2fe5643c-5389-4b97-a3b3-8c399b47d153.png" style="width:96.33em;height:53.67em;" width="1156" height="644"/></div>
<p>It's important to outline two things when speaking about Azure Virtual Machine Scale Set. A scale set is very different to an availability set. In an availability set, we have a constant number of VMs in order to increase the chances of at least one VM being available at all times and achieving high availability. Scale set monitors workload and increases the number of VMs based on demand, but all VMs are replicas and an issue can cause all VMs to replicate issue. </p>
<p class="mce-root"/>
<p>Another thing we need to outline is scenarios where we can use Azure Virtual Machine Scale Set. As all VMs in scale set are replicas of the initial image, changes are made from the initial image to all other VMs. But the process is not done the other way around, and changes on additional instances are not applied anywhere. For this reason, Azure Virtual Machine Scale Set is not good for roles like SQL Server or Exchange Server where changes must be applied across all instances. Rather use scale set for application scenarios where changes are not made by user sessions and data persists over time.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Virtual Machine Scale Set ARM template</h1>
                </header>
            
            <article>
                
<p>In addition, here is the ARM template to deploy a new Azure Virtual Machine Scale Set:</p>
<pre>{<br/> "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",<br/> "contentVersion": "1.0.0.0",<br/> "parameters": {<br/> "vmSku": {<br/> "type": "string",<br/> "defaultValue": "Standard_D1",<br/> "metadata": {<br/> "description": "Size of VMs in the VM Scale Set."<br/> }<br/> },<br/> "vmssName": {<br/> "type": "string",<br/> "metadata": {<br/> "description": "String used as a base for naming resources. Must be 3-61 characters in length and globally unique across Azure. A hash is prepended to this string for some resources, and resource-specific information is appended."<br/> },<br/> "maxLength": 61<br/> },<br/> "instanceCount": {<br/> "type": "int",<br/> "metadata": {<br/> "description": "Number of VM instances (100 or less)."<br/> },<br/> "defaultValue": 2,<br/> "maxValue": 100<br/> },<br/> "adminUsername": {<br/> "type": "string",<br/> "metadata": {<br/> "description": "Admin username on all VMs."<br/> }<br/> },<br/> "adminPassword": {<br/> "type": "securestring",<br/> "metadata": {<br/> "description": "Admin password on all VMs."<br/> }<br/> }<br/> },<br/> "variables": {<br/> "vnetName": "vnet",<br/> "subnetName": "subnet",<br/> "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]",<br/> "publicIPAddressName": "pip",<br/> "loadBalancerName": "loadBalancer",<br/> "loadBalancerFrontEndName": "loadBalancerFrontEnd",<br/> "loadBalancerBackEndName": "loadBalancerBackEnd",<br/> "loadBalancerProbeName": "loadBalancerHttpProbe",<br/> "loadBalancerNatPoolName": "loadBalancerNatPool"<br/> },<br/> "resources": [<br/> {<br/> "type": "Microsoft.Compute/virtualMachineScaleSets",<br/> "name": "[parameters('vmssName')]",<br/> "location": "[resourceGroup().location]",<br/> "apiVersion": "2017-03-30",<br/> "dependsOn": [<br/> "[concat('Microsoft.Network/virtualNetworks/', variables('vnetName'))]",<br/> "[resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName'))]"<br/> ],<br/> "sku": {<br/> "name": "[parameters('vmSku')]",<br/> "capacity": "[parameters('instanceCount')]"<br/> },<br/> "properties": {<br/> "overprovision": "true",<br/> "upgradePolicy": {<br/> "mode": "Manual"<br/> },<br/> "virtualMachineProfile": {<br/> "storageProfile": {<br/> "osDisk": {<br/> "createOption": "FromImage",<br/> "caching": "ReadWrite"<br/> },<br/> "imageReference": {<br/> "publisher": "MicrosoftWindowsServer",<br/> "offer": "WindowsServer",<br/> "sku": "2016-Datacenter",<br/> "version": "latest"<br/> }<br/> },<br/> "osProfile": {<br/> "computerNamePrefix": "[parameters('vmssName')]",<br/> "adminUsername": "[parameters('adminUsername')]",<br/> "adminPassword": "[parameters('adminPassword')]"<br/> },<br/> "networkProfile": {<br/> "networkInterfaceConfigurations": [<br/> {<br/> "name": "nic",<br/> "properties": {<br/> "primary": true,<br/> "ipConfigurations": [<br/> {<br/> "name": "ipconfig",<br/> "properties": {<br/> "subnet": {<br/> "id": "[variables('subnetRef')]"<br/> },<br/> "loadBalancerBackendAddressPools": [<br/> {<br/> "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/backendAddressPools/', variables('loadBalancerBackEndName'))]"<br/> }<br/> ],<br/> "loadBalancerInboundNatPools": [<br/> {<br/> "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/inboundNatPools/', variables('loadBalancerNatPoolName'))]"<br/> }<br/> ]<br/> }<br/> }<br/> ]<br/> }<br/> }<br/> ]<br/> }<br/> }<br/> }<br/> },<br/> {<br/> "type": "Microsoft.Network/virtualNetworks",<br/> "name": "[variables('vnetName')]",<br/> "location": "[resourceGroup().location]",<br/> "apiVersion": "2017-04-01",<br/> "properties": {<br/> "addressSpace": {<br/> "addressPrefixes": [<br/> "10.0.0.0/16"<br/> ]<br/> },<br/> "subnets": [<br/> {<br/> "name": "[variables('subnetName')]",<br/> "properties": {<br/> "addressPrefix": "10.0.0.0/24"<br/> }<br/> }<br/> ]<br/> }<br/> },<br/> {<br/> "type": "Microsoft.Network/publicIPAddresses",<br/> "name": "[variables('publicIPAddressName')]",<br/> "location": "[resourceGroup().location]",<br/> "apiVersion": "2017-04-01",<br/> "properties": {<br/> "publicIPAllocationMethod": "Dynamic",<br/> "dnsSettings": {<br/> "domainNameLabel": "[toLower(parameters('vmssName'))]"<br/> }<br/> }<br/> },<br/> {<br/> "type": "Microsoft.Network/loadBalancers",<br/> "name": "[variables('loadBalancerName')]",<br/> "location": "[resourceGroup().location]",<br/> "apiVersion": "2017-04-01",<br/> "dependsOn": [<br/> "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"<br/> ],<br/> "properties": {<br/> "frontendIPConfigurations": [<br/> {<br/> "name": "[variables('loadBalancerFrontEndName')]",<br/> "properties": {<br/> "publicIPAddress": {<br/> "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"<br/> }<br/> }<br/> }<br/> ],<br/> "backendAddressPools": [<br/> {<br/> "name": "[variables('loadBalancerBackendName')]"<br/> }<br/> ],<br/> "loadBalancingRules": [<br/> {<br/> "name": "roundRobinLBRule",<br/> "properties": {<br/> "frontendIPConfiguration": {<br/> "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', variables('loadBalancerFrontEndName'))]"<br/> },<br/> "backendAddressPool": {<br/> "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/', variables('loadBalancerBackendName'))]"<br/> },<br/> "protocol": "Tcp",<br/> "frontendPort": 80,<br/> "backendPort": 80,<br/> "enableFloatingIP": false,<br/> "idleTimeoutInMinutes": 5,<br/> "probe": {<br/> "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/probes/', variables('loadBalancerProbeName'))]"<br/> }<br/> }<br/> }<br/> ],<br/> "probes": [<br/> {<br/> "name": "[variables('loadBalancerProbeName')]",<br/> "properties": {<br/> "protocol": "Tcp",<br/> "port": 80,<br/> "intervalInSeconds": "5",<br/> "numberOfProbes": "2"<br/> }<br/> }<br/> ],<br/> "inboundNatPools": [<br/> {<br/> "name": "[variables('loadBalancerNatPoolName')]",<br/> "properties": {<br/> "frontendIPConfiguration": {<br/> "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', variables('loadBalancerFrontEndName'))]"<br/> },<br/> "protocol": "Tcp",<br/> "frontendPortRangeStart": 50000,<br/> "frontendPortRangeEnd": 50019,<br/> "backendPort": 3389<br/> }<br/> }<br/> ]<br/> }<br/> }<br/> ]<br/>}</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>We have covered the basic IaaS concepts and how to set up Azure Virtual Machines. The logical step to expand IaaS scenarios was to cover high availability and we succeeded in achieving this goal with Azure Load Balancers and availability sets. </p>
<p>One of the key concepts of cloud computing is elasticity and on-demand resources. We showed how to achieve both vertical scaling (with alerts and custom actions) and horizontal scaling (with Azure Virtual Machine Scale Sets).</p>
<p>In the next chapter, we will progress to the PaaS model and explore the Azure App Service as a more abstract model compared to Azure Virtual Machines. The app service gives us some unique options that will help us progress in our cloud journey but gives us less control over infrastructure than VMs. We'll compare how IaaS features relate to PaaS and how we can achieve scaling and high availability with app service.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>What is the oldest Windows Server version supported for Azure VMs?
<ol>
<li>Windows Server 2003</li>
<li>Windows Server 2008 R2 SP1</li>
<li>Windows Server 2012 R2 </li>
</ol>
</li>
<li>What do basic-tier <span>VM</span>s support?
<ol>
<li>Lower IOPS</li>
<li><span>Load Balancer</span>s</li>
<li>Auto-scaling</li>
</ol>
</li>
<li>What are low-priority <span>VM</span>s intended to be used for?
<ol>
<li>High availability</li>
<li>Batch processing</li>
<li>Balanced workloads</li>
</ol>
</li>
<li>Size setting in the Azure Virtual Machine blade is used to...?
<ol>
<li>Scale up</li>
<li>Scale down</li>
<li>Both</li>
</ol>
</li>
<li>Runbooks can be used to perform?
<ol>
<li>Maintenance tasks</li>
<li>Scaling up and down <span>VM</span>s</li>
<li>Both</li>
</ol>
</li>
<li>Azure Load Balancer is used...?
<ol>
<li>To distribute traffic across <span>VM</span>s in the backend pool</li>
<li>To isolate traffic and stop attacks on the <span>VM</span></li>
<li>Both</li>
</ol>
</li>
<li><span>Placing VMs in the same availability set will result in...</span>?
<ol>
<li><span>VM</span>s will be created in different Azure Datacenters</li>
<li><span>VM</span>s will be placed in a different rack</li>
<li><span>VM</span>s will be placed in the same rack</li>
</ol>
</li>
<li>Scaling by creating additional instances of <span>VM</span> is called...? 
<ol>
<li>Scaling up</li>
<li>Scaling down</li>
<li>Scaling out</li>
</ol>
</li>
</ol>
<ol start="9">
<li>Scaling out is an example of...?
<ol>
<li>Vertical scaling</li>
<li>Horizontal scaling</li>
<li>Diagonal scaling</li>
</ol>
</li>
<li>For scaling out of Azure <span>VM</span>s we use...?
<ol>
<li>Availability zone</li>
<li>Availability set</li>
<li>Scale set</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  </body></html>