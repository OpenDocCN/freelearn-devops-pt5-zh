<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">AWS CloudFormation Security</h1>
                
            
            <article>
                
<p class="calibre2">Designing and deploying infrastructure need some care when it comes to security issues. In this chapter, we explore how to build IaC with security compliances. Some security best practices and recommendations are explored in order to apply secure AWS CloudFormation.</p>
<p class="calibre2">The following is a list of topics that we will explore:</p>
<ul class="calibre11">
<li class="calibre12">Security threads and models for AWS CloudFormation</li>
<li class="calibre12">Best practices for AWS security</li>
<li class="calibre12">Managing all AWS resource securities</li>
<li class="calibre12">Reducing security accesses to CloudFormation Stacks</li>
<li class="calibre12">Stack Policies</li>
<li class="calibre12">IAM conditions for CloudFormation</li>
<li class="calibre12">AWS security checklist</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Security threats and models for AWS CloudFormation</h1>
                
            
            <article>
                
<p class="calibre2">Amazon AWS consists of AWS services. The more you use AWS services on your system, the more security risks your system will have. Each AWS service needs special attention to address security problems.</p>
<p class="calibre2">Understanding security threats and models from our system can take advantages to address security issues. Amazon AWS provides AWS security resources to help us to harden our system. Refer to <a href="https://aws.amazon.com/security/security-resources/" class="calibre10">https://aws.amazon.com/security/security-resources/</a>. </p>
<p class="calibre2"/>
<p class="calibre2">AWS security operates on a Shared Security Responsibility model. This means that Amazon secures its infrastructure while you have your own security controls in place for the data and applications you deploy and store in the cloud. You can find details of the AWS Security Responsibility model on this link, <a href="https://aws.amazon.com/compliance/shared-responsibility-model/" class="calibre10">https://aws.amazon.com/compliance/shared-responsibility-model/</a>. </p>
<p class="calibre2">AWS protects the infrastructure running all the services offered in the AWS Cloud. This infrastructure is composed of the hardware, software, networking, and facilities that run AWS Cloud services. Otherwise, customers take responsibility for meeting AWS configuration security requirements on each AWS resource that deploys into their system. We describe this model in <em class="calibre17">Figure 6-1</em>. As customers, we should give more attention to our system implementation such as data and configurations/settings.</p>
<p class="cdpaligncenter1"><img class="alignnone92" src="../images/00150.jpeg"/></p>
<div class="packt_figref">Figure 6-1: A simple of <span>AWS Security Responsibility model</span></div>
<p class="calibre2">We also review some security threat modeling in order to understand your system risks. A simple security threat modeling example is STRIDE, created by Microsoft. Technically, this model is applied to computer systems but we can apply this model for our AWS security threat model. A brief STRIDE model is described in the following table. Further information about STRIDE is available from<a href="https://docs.microsoft.com/en-us/previous-versions/commerce-server/ee823878(v=cs.20)" class="calibre10"> https://docs.microsoft.com/en-us/previous-versions/commerce-server/ee823878(v=cs.20)</a>.</p>
<table border="1" class="calibre45">
<tbody class="calibre29">
<tr class="calibre46">
<td class="calibre47"><strong class="calibre1">Security Threat</strong></td>
<td class="calibre48"><strong class="calibre1">Mitigation</strong></td>
<td class="calibre49"><strong class="calibre1">Mitigation Samples</strong></td>
</tr>
<tr class="calibre50">
<td class="calibre51">Spoofing </td>
<td class="calibre52">Authentication</td>
<td class="calibre53">Passwords<br class="title-page-name"/>
Multi-factor authentication<br class="title-page-name"/>
Digital signatures</td>
</tr>
<tr class="calibre54">
<td class="calibre55">Tampering</td>
<td class="calibre56">Integrity</td>
<td class="calibre57">Permission/ACLs<br class="title-page-name"/>
Digital signatures</td>
</tr>
<tr class="calibre54">
<td class="calibre55">Repudiation</td>
<td class="calibre56">Non-Repudiation</td>
<td class="calibre57">Secure logging and auditing<br class="title-page-name"/>
Digital signatures</td>
</tr>
<tr class="calibre54">
<td class="calibre55">Information disclosure</td>
<td class="calibre56">Confidentiality</td>
<td class="calibre57">Encryption<br class="title-page-name"/>
Permissions/ACLs</td>
</tr>
<tr class="calibre50">
<td class="calibre51">Denial of service (DoS)</td>
<td class="calibre52">Availability</td>
<td class="calibre53">Permission/ACLs<br class="title-page-name"/>
Filtering<br class="title-page-name"/>
Quotas</td>
</tr>
<tr class="calibre54">
<td class="calibre55">Elevation of privilege</td>
<td class="calibre56">Authorization</td>
<td class="calibre57">Permissions/ACLs<br class="title-page-name"/>
Input validation</td>
</tr>
</tbody>
</table>
<p class="calibre2"> </p>
<p class="calibre2">Amazon AWS also provides security services to help you to investigate your system implementation. They can analyze your system to identify security threats and risks. They can perform penetration testing on your AWS platform. If you are interested, you should request this service on this site, <a href="https://aws.amazon.com/security/penetration-testing/" class="calibre10">https://aws.amazon.com/security/penetration-testing/</a>.  </p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">The following is a list of AWS resources on which AWS can help you to perform penetration testing.</p>
<ul class="calibre11">
<li class="calibre12">EC2</li>
<li class="calibre12">RDS</li>
<li class="calibre12">Aurora</li>
<li class="calibre12">CloudFront</li>
<li class="calibre12">API Gateway</li>
<li class="calibre12">Lambda</li>
<li class="calibre12">Lightsail</li>
<li class="calibre12">DNS Zone Walking</li>
</ul>
<p class="calibre2"><span class="calibre7">Some third-party local and global companies also can help you to investigate your security threats. For instance, ThreatModeler provides tools to find your security threats and then build its AWS threat model. You can read a summary report from ThreatModeler about the AWS threat model for web application on this link,</span> <a href="https://threatmodeler.com/wp-content/uploads/2018/04/AWS-Basic-Web-App-Hosting-Summary-Report.pdf" class="calibre10">https://threatmodeler.com/wp-content/uploads/2018/04/AWS-Basic-Web-App-Hosting-Summary-Report.pdf</a><span class="calibre7">.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Best practices for AWS security</h1>
                
            
            <article>
                
<p class="calibre2">The easier method to reduce security risks on our AWS system is to follow best practices. In general, best practices consist of security recommendations from security experts based on their experience in addressing security.</p>
<p class="calibre2">Amazon AWS provides AWS security best practices to help their customers harden security problems while deploying their systems on the AWS platform. You can read it on <a href="https://d1.awsstatic.com/whitepapers/Security/AWS_Security_Best_Practices.pdf" class="calibre10">https://d1.awsstatic.com/whitepapers/Security/AWS_Security_Best_Practices.pdf</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Managing all AWS resource securities</h1>
                
            
            <article>
                
<p class="calibre2">AWS Amazon provides a security central to manage security accesse to all AWS resources. We can review our users, roles, and their permissions while accessing AWS resources using AWS IAM. Check this out on <a href="https://console.aws.amazon.com/iam/" class="calibre10">https://console.aws.amazon.com/iam/</a><a href="https://console.aws.amazon.com/iam/" class="calibre10">.</a></p>
<p class="calibre2"><em class="calibre17">Figure 6-2</em> show one IAM user. We can configure its permissions and policies to ensure the user is safe. If you think this user is not used, you should remove it from AWS IAM.</p>
<p class="cdpaligncenter1"><img class="alignnone93" src="../images/00151.jpeg"/></p>
<div class="packt_figref">Figure 6-2: Managing role permissions on AWS IAM</div>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">You also should pay attention to your IAM roles. You should review all role permissions. Remove permissions if IAM roles do not use them. <em class="calibre17">Figure 6-3</em> shows an IAM role with its permissions:</p>
<p class="cdpaligncenter1"><img src="../images/00152.jpeg" class="calibre58"/></p>
<div class="packt_figref"><span>Figure 6-3. Managing user permissions on AWS IAM</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Reducing security access to CloudFormation stacks</h1>
                
            
            <article>
                
<p class="calibre2">All AWS resources can be managed through AWS IAM, including policies and users or roles. AWS CloudFormation uses IAM to control its security for template deployment. We can use an IAM policy on our CloudFormation template. A CloudFormation policy can be defined as follows.</p>
<pre class="calibre19">{<br class="title-page-name"/>  "Statement" : [<br class="title-page-name"/>    {<br class="title-page-name"/>      "Effect" : "Deny_or_Allow",<br class="title-page-name"/>      "Action" : "update_actions",<br class="title-page-name"/>      "Principal" : "*",<br class="title-page-name"/>      "Resource" : "LogicalResourceId/resource_logical_ID",<br class="title-page-name"/>      "Condition" : {<br class="title-page-name"/>        "StringEquals_or_StringLike" : {<br class="title-page-name"/>          "ResourceType" : [resource_type, ...]<br class="title-page-name"/>        }<br class="title-page-name"/>      }<br class="title-page-name"/>    } <br class="title-page-name"/>  ]<br class="title-page-name"/>}</pre>
<p class="calibre2">It's recommended you limit security access on your resources on CloudFormation. This method applies the principle of least privilege. For instance, we remove updating and deleting access on CloudFormation stacks from IAM users or roles. A template sample is as follows.</p>
<pre class="calibre19">{<br class="title-page-name"/>    "Version":"2012-10-17",<br class="title-page-name"/>    "Statement":[{<br class="title-page-name"/>        "Effect":"Allow",<br class="title-page-name"/>        "Action":[ <br class="title-page-name"/>            "cloudformation:*"<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource":"*"<br class="title-page-name"/>    },<br class="title-page-name"/>    {<br class="title-page-name"/>        "Effect":"Deny",<br class="title-page-name"/>        "Action":[ <br class="title-page-name"/>            "cloudformation:UpdateStack",<br class="title-page-name"/>            "cloudformation:DeleteStack"<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource":"arn:aws:cloudformation:us-east-1:123456789012:stack/MyStack/*"<br class="title-page-name"/>    }]<br class="title-page-name"/>}</pre>
<p class="calibre2">This CloudFormation template allows access to all CloudFormation APIs, but denies <kbd class="calibre13">UpdateStack</kbd> and <kbd class="calibre13">DeleteStack</kbd> APIs access on your MyStack stack.</p>
<p class="calibre2">You should investigate all resource usages and analyze what kind of security access to be applied on the template. With regard to CloudFormation actions, we can use the following actions and apply the <span class="calibre7">least privilege principle.</span></p>
<ul class="calibre11">
<li class="calibre12">CancelUpdateStack</li>
<li class="calibre12">ContinueUpdateRollback</li>
<li class="calibre12">CreateStack</li>
<li class="calibre12">DeleteStack</li>
<li class="calibre12">DescribeStackEvents</li>
<li class="calibre12">DescribeStackResource</li>
<li class="calibre12">DescribeStackResources</li>
<li class="calibre12">DescribeStacks</li>
<li class="calibre12">EstimateTemplateCost</li>
<li class="calibre12">GetStackPolicy</li>
<li class="calibre12">GetTemplate</li>
<li class="calibre12">GetTemplateSummary</li>
<li class="calibre12">ListExports</li>
<li class="calibre12">ListImports</li>
<li class="calibre12">ListStackResources</li>
<li class="calibre12">ListStacks</li>
<li class="calibre12">SetStackPolicy</li>
<li class="calibre12">UpdateStack</li>
<li class="calibre12">UpdateTerminationProtection</li>
<li class="calibre12">ValidateTemplate</li>
</ul>
<p class="calibre2">You can review each action on this site, <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/Welcome.html" class="calibre10">https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/Welcome.html</a>.</p>
<p class="calibre2"> </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Stack policies</h1>
                
            
            <article>
                
<p class="calibre2">In some cases the you likely get framework down because of accidental changes to assets. Your group perform to change CloudFormation which makes your framework shaky. CloudFormation gives stack approaches which keep stack assets from unexpectedly being refreshed or erased amid stack refreshes. We can incorporate with IAM and stack arrangements to address accidental and malevolent changes to your stack assets.</p>
<p class="calibre2">You should perform to set or refresh the strategy, your IAM clients or parts ought to be able to call the <kbd class="calibre13">cloudformation:SetStackPolicy</kbd> activity. As a matter of course, setting a stack strategy secures all stack assets with a Deny to deny any updates except if you indicate an express Allow. For example, we shield a specific asset from refreshes activity after the framework go live. You can see the accompanying CloudFormation format.</p>
<pre class="calibre19">{<br class="title-page-name"/>  "Statement" : [<br class="title-page-name"/>    {<br class="title-page-name"/>      "Effect" : "Deny",<br class="title-page-name"/>      "Action" : "Update:*",<br class="title-page-name"/>      "Principal": "*",<br class="title-page-name"/>      "Resource" : "&lt;certain_resource&gt;"<br class="title-page-name"/>    },<br class="title-page-name"/>    {<br class="title-page-name"/>      "Effect" : "Allow",<br class="title-page-name"/>      "Action" : "Update:*",<br class="title-page-name"/>      "Principal": "*",<br class="title-page-name"/>      "Resource" : "*"<br class="title-page-name"/>    }<br class="title-page-name"/>  ]<br class="title-page-name"/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">IAM conditions for CloudFormation</h1>
                
            
            <article>
                
<p class="calibre2">We can perform creation or delation of particular AWS resources through CloudFormation if we have IAM policies to do those tasks. Sometimes you do not need a creation task from CloudFormation operations. We can implement IAM conditions to apply this scenario.</p>
<p class="calibre2">In general, CloudFormation provides IAM policies related to IAM conditions. The following is a list of IAM condition policies:</p>
<ul class="calibre11">
<li class="calibre12"><kbd class="calibre13">cloudformation:TemplateURL</kbd></li>
<li class="calibre12"><kbd class="calibre13">cloudformation:ResourceTypes</kbd></li>
<li class="calibre12"><kbd class="calibre13">cloudformation:StackPolicyURL</kbd></li>
</ul>
<p class="calibre2">When you apply IAM conditions, you can ensure that API calls for stack actions, for instances creating, updating, on specific template or are limited to specific resources.</p>
<p class="calibre2"><kbd class="calibre13">cloudformation:TemplateURL</kbd> is one CloudFormation attribute that shows a CloudFormation template file location. It could be the .json, .yaml, and .template file formats. For instance, we apply an IAM condition on the CloudFormation template as follows.</p>
<pre class="calibre19">{<br class="title-page-name"/>    "Version":"2012-10-17",<br class="title-page-name"/>    "Statement":[{<br class="title-page-name"/>        "Effect": "Deny",<br class="title-page-name"/>        "Action": [<br class="title-page-name"/>            "cloudformation:CreateStack",<br class="title-page-name"/>            “cloudformation:UpdateStack”<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource": "*",<br class="title-page-name"/>        "Condition": {<br class="title-page-name"/>            "StringNotEquals": {<br class="title-page-name"/>                "cloudformation:TemplateURL": [<br class="title-page-name"/>                    "https://s3.amazonaws.com/cloudformation-templates-us-east-1/IAM_Users_Groups_and_Policies.template"<br class="title-page-name"/>                ]<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    },<br class="title-page-name"/>    {<br class="title-page-name"/>        "Effect": "Deny",<br class="title-page-name"/>        "Action": [<br class="title-page-name"/>            "cloudformation:CreateStack",<br class="title-page-name"/>            "cloudformation:UpdateStack"<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource": "*",<br class="title-page-name"/>        "Condition": {<br class="title-page-name"/>            "Null": {<br class="title-page-name"/>                "cloudformation:TemplateURL": "true"<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    }]<br class="title-page-name"/>}</pre>
<p class="calibre2">This template ensures that, for all <kbd class="calibre13">CreateStack</kbd> or <kbd class="calibre13">UpdateStack</kbd> API calls, users must use the specified template. Otherwise, the operation will be denied.</p>
<p class="calibre2"><kbd class="calibre13">Condition:StackPolicyURL</kbd> enables your CloudFormation to apply a stack policy with it upon creation with the <kbd class="calibre13">StackPolicyURL</kbd> condition. The following is a CloudFormation template from AWS to use cloudformation:StackPolicyUrl in the template.</p>
<pre class="calibre19">{<br class="title-page-name"/>    "Version":"2012-10-17",<br class="title-page-name"/>    "Statement":[<br class="title-page-name"/>    {<br class="title-page-name"/>            "Effect": "Deny",<br class="title-page-name"/>            "Action": [<br class="title-page-name"/>                "cloudformation:SetStackPolicy"<br class="title-page-name"/>            ],<br class="title-page-name"/>            "Resource": "*",<br class="title-page-name"/>            "Condition": {<br class="title-page-name"/>                "ForAnyValue:StringNotEquals": {<br class="title-page-name"/>                    "cloudformation:StackPolicyUrl": [<br class="title-page-name"/>                        "https://s3.amazonaws.com/samplebucket/sampleallowpolicy.json"<br class="title-page-name"/>                    ]<br class="title-page-name"/>                }<br class="title-page-name"/>            }<br class="title-page-name"/>        }, <br class="title-page-name"/>       {<br class="title-page-name"/>        "Effect": "Deny",<br class="title-page-name"/>        "Action": [<br class="title-page-name"/>            "cloudformation:CreateStack",<br class="title-page-name"/>            "cloudformation:UpdateStack"<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource": "*",<br class="title-page-name"/>        "Condition": {<br class="title-page-name"/>            "ForAnyValue:StringNotEquals": {<br class="title-page-name"/>                "cloudformation:StackPolicyUrl": [<br class="title-page-name"/>                    “https://s3.amazonaws.com/samplebucket/sampledenypolicy.json”<br class="title-page-name"/>                ]<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    },<br class="title-page-name"/>    {<br class="title-page-name"/>        "Effect": "Deny",<br class="title-page-name"/>        "Action": [<br class="title-page-name"/>            "cloudformation:CreateStack",<br class="title-page-name"/>            "cloudformation:UpdateStack",<br class="title-page-name"/>            “cloudformation:SetStackPolicy”<br class="title-page-name"/>        ],<br class="title-page-name"/>        "Resource": "*",<br class="title-page-name"/>        "Condition": {<br class="title-page-name"/>            "Null": {<br class="title-page-name"/>                "cloudformation:StackPolicyUrl": "true"<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    }]<br class="title-page-name"/>}</pre>
<p class="calibre2"> </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">AWS security checklist</h1>
                
            
            <article>
                
<p class="calibre2">After you design a system via CloudFormation and deploy it to the AWS platform, the last task is to ensure your system complies with AWS Security. AWS provides a security checklist that consists of security checking actions. You can learn about the security checklist in the following document, <a href="https://d1.awsstatic.com/whitepapers/Security/AWS_Security_Checklist.pdf" class="calibre10">https://d1.awsstatic.com/whitepapers/Security/AWS_Security_Checklist.pdf</a>. This document consists of the following three security checklists on various AWS resources:</p>
<ul class="calibre11">
<li class="calibre12">General security checklist</li>
<li class="calibre12">Security checklist for EC2/VPC/EBS</li>
<li class="calibre12">Security checklist for S3</li>
</ul>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">With using AWS security checklist, your system probably has low security risks. But again, it's better to perform penetration testing regularly.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we learned how we can go about <span class="calibre7">securing resources that are deployed using AWS CloudFormation. Finally, we delved into understanding the security threats and models for CloudFormation.</span></p>


            </article>

            
        </section>
    </body></html>