<html><head></head><body>
  <div><h1 class="chapterNumber">12</h1>
    <h1 id="_idParaDest-176" class="chapterTitle">Fixing Mistakes</h1>
    <p class="normal">The most common reaction to making a mistake in Git is to panic. What if you have just lost all your work? Worse, what if you have broken the master branch?</p>
    <p class="normal">This chapter will review a number of common Git mistakes and how to fix them. The first rule, of course, is stay calm, or as Douglas Adams said, <em class="italic">Don't Panic!</em></p>
    <p class="normal">The problems we'll review are:</p>
    <ul>
      <li class="bullet">You wrote the wrong message in a commit.</li>
      <li class="bullet">You forgot to add changed files from your last commit.</li>
      <li class="bullet">Problems with the order of commits or their messages.</li>
      <li class="bullet">You need to undo changes made in a commit.</li>
      <li class="bullet">You misnamed your branch.</li>
      <li class="bullet">You committed to the wrong branch.</li>
      <li class="bullet">You trashed a file in a previous commit.</li>
      <li class="bullet">You messed up the remote by pushing a broken branch.</li>
    </ul>
    <p class="normal">To see the answers at work, let's mirror <code class="Code-In-Text--PACKT-">Panofy</code> into <code class="Code-In-Text--PACKT-">ErrorsDemo</code>. Here are the steps we'll be doing:</p>
    <ol>
      <li class="numbered">On the remote, create <code class="Code-In-Text--PACKT-">ErrorsDemo</code> and get its URL.</li>
      <li class="numbered">Go to the local branch you want to mirror (in our case, <code class="Code-In-Text--PACKT-">Panofy</code>).</li>
      <li class="numbered">Push that up to the server with the mirror command, using <code class="Code-In-Text--PACKT-">ErrorsDemo</code>'s URL.</li>
      <li class="numbered">Clone the new branch (be sure to clone it in the directory you want it).</li>
      <li class="numbered">Change directory to the new (cloned) directory (<code class="Code-In-Text--PACKT-">ErrorsDemo</code>).</li>
    </ol>
    <p class="normal">You can see this walked through in <em class="chapterRef">Chapter 10</em>, <em class="italic">Important Git Commands &amp; Metadata</em>.</p>
    <h1 id="_idParaDest-177" class="title">You wrote the wrong message in the last commit</h1>
    <p class="normal">Let's start with the log so that we can see the change:</p>
    <figure class="mediaobject"><img src="img/B17441_12_01.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.1: Log of initial state</p>
    <p class="normal">This one <a id="_idIndexMarker273"/>is easy; all you need do is enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git commit --amend
</code></pre>
    <p class="normal">Your editor will open and allow you to change the message. To change the wording of the message just change the "pick" to "reword."</p>
    <p class="normal">After you save your file, the message of the last commit will be changed as shown in <em class="italic">Figure 12.2</em>:</p>
    <figure class="mediaobject"><img src="img/B17441_12_02.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.2: Log after amend (changed message in the last commit)</p>
    <h1 id="_idParaDest-178" class="title">You forgot to add changed files from your last commit</h1>
    <p class="normal">You solve <a id="_idIndexMarker274"/>this problem in the exact same way you solved the problem of fixing the message in your last commit: with <code class="Code-In-Text--PACKT-">--amend</code>.</p>
    <p class="normal">First, stage your new or changed files. Then enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git --amend
</code></pre>
    <p class="normal">If you don't <a id="_idIndexMarker275"/>want to edit the message when you add the files, enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git --amend --no-edit
</code></pre>
    <h1 id="_idParaDest-179" class="title">Problems with the order of commits or their messages</h1>
    <p class="normal">If the problem is not with the last commit (in which case you'd use <code class="Code-In-Text--PACKT-">--amend</code>), it's time to break out <a id="_idIndexMarker276"/>interactive rebase as shown in <em class="chapterRef">Chapter 8</em>, <em class="italic">Interactive Rebasing</em>. If you haven't pushed yet, Interactive Rebase will let you do all this and more.</p>
    <h1 id="_idParaDest-180" class="title">You need to undo changes made in a commit</h1>
    <p class="normal">All you need <a id="_idIndexMarker277"/>to do here is to call the log, get the ObjectID of the commit you want to undo and call:</p>
    <pre class="programlisting con"><code class="hljs-con">git revert ObjectID
</code></pre>
    <p class="normal">Let's go back to the log:</p>
    <figure class="mediaobject"><img src="img/B17441_12_03.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.3: Log, starting point</p>
    <p class="normal">Now let's revert the commit that added the hello message:</p>
    <pre class="programlisting con"><code class="hljs-con">git revert c507abf
</code></pre>
    <p class="normal">Because I reverted a change in the middle of the branch, it's no surprise that I run into a merge conflict:</p>
    <figure class="mediaobject"><img src="img/B17441_12_04.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.4: Merge conflict</p>
    <p class="normal">To solve <a id="_idIndexMarker278"/>this I will call <code class="Code-In-Text--PACKT-">git mergetool</code>, invoking the tool I set up in <em class="chapterRef">Chapter 4</em>, <em class="italic">Merging, Pull Requests, and Handling Merge Conflicts</em>. Kdiff3 is smart enough to fix all the conflicts without my help:</p>
    <figure class="mediaobject"><img src="img/B17441_12_05.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.5: Kdiff3 fixes the conflicts for me</p>
    <p class="normal">Sure enough, when we open <code class="Code-In-Text--PACKT-">Program.cs</code> the Hello World is gone:</p>
    <figure class="mediaobject"><img src="img/B17441_12_06.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.6: Program.cs after revert</p>
    <h1 id="_idParaDest-181" class="title">You misnamed your branch</h1>
    <p class="normal">Checkout the branch in question and enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git branch -m &lt;currentName&gt; &lt;desiredName&gt;
</code></pre>
    <p class="normal">Here's what we get:</p>
    <figure class="mediaobject"><img src="img/B17441_12_07.png" alt=""/></figure>
    <p class="packt_figref">Figure 12.7: Renaming branch foo to bar</p>
    <p class="normal">In <em class="italic">Figure 12.7</em> you create the branch foo and then check it out. Finally, you rename it as shown above and your branch name is changed.</p>
    <h1 id="_idParaDest-182" class="title">You committed to the wrong branch</h1>
    <p class="normal">The way this plays out for me (again and again!) is that I forget to create a new branch and so <a id="_idIndexMarker279"/>make my changes on the develop branch or to main. To fix this, enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git branch &lt;new branch&gt;
git reset HEAD~ --hard
</code></pre>
    <p class="normal">You are creating the new branch, then removing the check-in from main (<code class="Code-In-Text--PACKT-">HEAD~</code>) but leaving the files in the new branch.</p>
    <h1 id="_idParaDest-183" class="title">You trashed a file in a previous commit</h1>
    <p class="normal">You ruin a file but you only find out about it after a number of other commits. Ouch. Use <code class="Code-In-Text--PACKT-">git log</code> to <a id="_idIndexMarker280"/>find the ObjectID for a commit from <em class="italic">before</em> the problem commit. Now we want to get only that file from the commit. For this, we enter:</p>
    <pre class="programlisting con"><code class="hljs-con">git checkout ObjectID --&lt;path to file&gt; 
</code></pre>
    <p class="normal">(The path to the file is relative to the root of the project.)</p>
    <p class="normal">You now have the earlier version in the staging area. You can "unstage" it and edit it from the work area.</p>
    <p class="normal">An alternative to using the ObjectID is to count back from <code class="Code-In-Text--PACKT-">HEAD</code>, such as:</p>
    <pre class="programlisting con"><code class="hljs-con">git checkout HEAD~4 --&lt;path to file&gt;
</code></pre>
    <p class="normal">This just says "go back 4 commits and get the file from there." The two approaches work equally well.</p>
    <h1 id="_idParaDest-184" class="title">You messed up the remote by pushing a broken branch</h1>
    <p class="normal">If (and when) you break the Master branch by pushing an incomplete and broken local copy, dry your tears, take heart! This can be fixed.</p>
    <p class="normal">Note, this <a id="_idIndexMarker281"/>should not be possible. If you are using Azure DevOps (or something similar) your pipeline should not accept any merge that doesn't compile (and arguably pass a set of unit tests). But I digress…</p>
    <p class="normal">The first command you want is:</p>
    <pre class="programlisting con"><code class="hljs-con">git reset --hard &lt;remoteRepository&gt; / &lt;Yourbranch&gt;@{1}
</code></pre>
    <p class="normal">That resets your local copy of <code class="Code-In-Text--PACKT-">&lt;Yourbranch&gt;</code> to the last synchronized version of <code class="Code-In-Text--PACKT-">&lt;remoteRepo&gt;</code>. Thus, if your branch is Feature1 and it is on origin, you would write:</p>
    <pre class="programlisting con"><code class="hljs-con">git reset --hard origin/Feature1@{1}
</code></pre>
    <p class="normal">Now you want to restore the remote repo to its state before you broke it:</p>
    <pre class="programlisting con"><code class="hljs-con">git push -f &lt;remoteRepository&gt;&lt;Yourbranch&gt;
</code></pre>
    <h1 id="_idParaDest-185" class="title">Quiz</h1>
    <p class="normal">The challenge for this chapter consists of a quiz. The answers are all at the end of the quiz.</p>
    <ol>
      <li class="numbered" value="1">What do you do if you left out a changed file in the last commit?</li>
      <li class="numbered">What do you do if you committed to the wrong branch?</li>
      <li class="numbered">What do you do if you corrupted a file in a previous commit?</li>
      <li class="numbered">What do you do if you need to undo changes made in a commit?</li>
      <li class="numbered">What do you do if you trash Master by pushing a broken branch?</li>
    </ol>
    <h1 id="_idParaDest-186" class="title">Answers</h1>
    <h2 id="_idParaDest-187" class="title">What do you do if you left out a changed file in the last commit?</h2>
    <p class="normal">You solve this with the same command you use to modify the message in the last commit, using <code class="Code-In-Text--PACKT-">--amend</code>, but you need to indicate that you do not want to edit the message (make sure your files are staged):</p>
    <pre class="programlisting con"><code class="hljs-con">git --amend --no-edit
</code></pre>
    <h2 id="_idParaDest-188" class="title">What do you do if you committed to the wrong branch?</h2>
    <p class="normal">Checkout or create the branch you want to have committed to and then use reset to remove the change from the remote branch, but leave your files in the index (staging area) to be committed to the new branch:</p>
    <pre class="programlisting con"><code class="hljs-con">git branch &lt;new branch&gt;
git reset HEAD~ --hard
</code></pre>
    <h2 id="_idParaDest-189" class="title">What do you do if you corrupted a file in a previous commit?</h2>
    <p class="normal">First, use <code class="Code-In-Text--PACKT-">git log</code> to find a commit before the corruption. Get the ObjectID of that commit. Next, get the problem file (and only that file) from the good commit:</p>
    <pre class="programlisting con"><code class="hljs-con">git checkout ObjectID --&lt;path to file&gt; 
</code></pre>
    <p class="normal">Remember: The path to the file is relative to the root of the project.</p>
    <p class="normal">You now have the healthy version of the file in the staging area. If that file needs editing you can unstage it, but the more likely case is that you can use this older version as is. In that case, you can just commit it.</p>
    <h2 id="_idParaDest-190" class="title">What do you do if you need to undo changes made in a commit?</h2>
    <p class="normal">In this case, open the log and get the ObjectID of the commit you want to undo. You can now call <code class="Code-In-Text--PACKT-">revert</code> on that ObjectID:</p>
    <pre class="programlisting con"><code class="hljs-con">git revert ObjectID
</code></pre>
    <h2 id="_idParaDest-191" class="title">What do you do if you trashed Master by pushing a broken branch?</h2>
    <p class="normal">If your DevOps system allowed you to push a broken branch to Master, fix this immediately. In fact, if you can, tell the rest of your team not to commit to Master until you fix it. After they stop yelling at you, do this:</p>
    <pre class="programlisting con"><code class="hljs-con">git reset --hard &lt;remoteRepository&gt; / &lt;Yourbranch&gt;@{1}
</code></pre>
    <p class="normal">That resets your local copy of <code class="Code-In-Text--PACKT-">&lt;Yourbranch&gt;</code> to the last synchronized version of <code class="Code-In-Text--PACKT-">&lt;remoteRepo&gt;</code>. Thus, if your branch is <code class="Code-In-Text--PACKT-">myFeature</code> and it is on origin, you would write:</p>
    <pre class="programlisting con"><code class="hljs-con">git reset --hard origin/myFeature@{1}
</code></pre>
    <p class="normal">Now you need to restore the remote repo to its state before you broke it:</p>
    <pre class="programlisting con"><code class="hljs-con">git push -f &lt;remoteRepository&gt;&lt;Yourbranch&gt;
</code></pre>
    <p class="normal">Master should now be fixed.</p>
    <p class="normal">Great job with the quiz! Keep this chapter around for the inevitable day you will need it.</p>
  </div>
</body></html>