<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Extending Confluence</h1></div></div></div><p>Not every feature might be available in Confluence out of the box or as add-ons in the marketplace. Confluence is very extendable with custom plugins, and if you are a developer, you can even create your own plugin using the <a id="id836" class="indexterm"/>
<strong>Atlassian Software Development Kit</strong> (<strong>SDK</strong>).</p><p>By the end of this chapter, you will have learned about:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up your development environment</li><li class="listitem" style="list-style-type: disc">Using the Atlassian Plugin SDK</li><li class="listitem" style="list-style-type: disc">The different extensions points</li><li class="listitem" style="list-style-type: disc">How to release your plugin</li></ul></div><p>If you are not a developer yourself, this chapter will probably be difficult to read, but it could give you an insight into what is possible with extending Confluence.</p><div><div><div><div><h1 class="title"><a id="ch10lvl1sec63"/>The Atlassian Plugin SDK</h1></div></div></div><p>Atlassian provides <a id="id837" class="indexterm"/>plugin developers with a Software Development Kit (SDK). By using this SDK, developers can create plugins that extend the functionality of all Atlassian products. The SDK allows you to quickly connect and use the plugin development platform.</p><p>The <a id="id838" class="indexterm"/>Atlassian Plugin SDK<a id="id839" class="indexterm"/> makes your life easier by helping to do the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Build plugins for any Atlassian application with a single tool.</li><li class="listitem" style="list-style-type: disc">Create a plugin skeleton, specific to the Atlassian application you are developing for.</li><li class="listitem" style="list-style-type: disc">Download the application binaries, install your plugin, and start the application.</li><li class="listitem" style="list-style-type: disc">Dynamically re-install your plugin after changes during development. No restart required.</li><li class="listitem" style="list-style-type: disc">Write quality unit tests and integration tests.</li><li class="listitem" style="list-style-type: disc">Speed up the<a id="id840" class="indexterm"/> all-important code-<a id="id841" class="indexterm"/>deploy-test cycle.</li></ul></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec125"/>Installing the Atlassian Plugin SDK</h2></div></div></div><p>Before we can start building<a id="id842" class="indexterm"/> our first plugin, we have to install the <a id="id843" class="indexterm"/>Atlassian Plugin SDK. We will go through the steps required to install the SDK on a Windows system.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec113"/>Prerequisites</h3></div></div></div><p>First we have to make <a id="id844" class="indexterm"/>sure our Windows system has the prerequisite software and is configured correctly. The Atlassian SDK relies on Version 1.6.x or higher of the Oracle JDK.</p><p>To install the <a id="id845" class="indexterm"/>Oracle JDK, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest JDK from <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a>.<div><div><h3 class="title"><a id="note50"/>Note</h3><p>At the time of writing the latest version is JDK 7 update 17.</p></div></div></li><li class="listitem">Double-click the downloaded installation file to start the installation wizard.</li><li class="listitem">Select where you would like to install Java, or simply accept the default values. The location where you install the JDK will be referred to as <code class="literal">JAVA_HOME</code>.</li><li class="listitem">Right-click the Computer icon.</li><li class="listitem">Select <strong>Advanced system settings</strong> from the left-hand side menu.</li><li class="listitem">Click on the <strong>Environment Variables</strong> button.</li><li class="listitem">Create a new environmental variable name <code class="literal">JAVA_HOME</code> with the value of where you just installed Java as shown:<div><img src="img/9526EN_10_01.jpg" alt="Prerequisites"/></div></li></ol></div><p>Now that you have the JDK installed on your system, add the JAVA <code class="literal">bin</code> directory to your path to ensure that you can use Java from the command prompt. Again, we assume a <a id="id846" class="indexterm"/>Windows setup.</p><p>To add<a id="id847" class="indexterm"/> <code class="literal">JAVA_HOME</code> to your path, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Right-click the Computer icon.</li><li class="listitem">Select <strong>Advanced system settings</strong> from the left-hand side menu.</li><li class="listitem">Click on the <strong>Environment Variables</strong> button.</li><li class="listitem">Locate the <strong>Path</strong> variable under the System variables and click on <strong>Edit...</strong>.</li><li class="listitem">Add <code class="literal">;%JAVA_HOME%\bin</code> to the end of variable value.</li><li class="listitem">Save the changes and close all dialogs.</li></ol></div><p>Before we continue, we have to make sure the JDK is installed correctly so that the Atlassian SDK is able to use it.</p><p>To verify your JDK installation, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open a command prompt window in Windows.</li><li class="listitem">Type the following command to verify that the <code class="literal">JAVA_HOME</code> variable is set:<div><pre class="programlisting">
<strong>echo %JAVA_HOME%</strong>
</pre></div></li><li class="listitem">This should return a path, that is <code class="literal">C:\Program Files (x86)\Java\jdk1.7.0_17</code>.</li><li class="listitem">When the variable is set, verify that your <strong>Path</strong> includes the JDK bin directory. Type the following command:<div><pre class="programlisting">
<strong>java –version</strong>
</pre></div><p>This should display the version of Java installed, that is:</p><div><pre class="programlisting">
<strong>java version "1.7.0_17"</strong>
<strong>Java(TM) SE Runtime Environment (build 1.7.0_17-b02)</strong>
<strong>Java HotSpot(TM) Client VM (build 23.7-b01, mixed mode, sharing)</strong>
</pre></div></li><li class="listitem">If you have the JDK installed and your <strong>Path</strong> is configured correctly, you can move forward to the next step.</li></ol></div><p>When building a plugin for Confluence, the application will be running on your desktop. For Confluence to be able to start, it assumes <strong>port 1990</strong> is available. On most machines this would not be an issue.</p><p>Verify your port numbers by performing the following step:</p><div><ol class="orderedlist arabic"><li class="listitem">Open a command prompt window and type the following command:<div><pre class="programlisting">
<strong>netstat –a | find /I "1990"</strong>
</pre></div></li></ol></div><p>If the <a id="id848" class="indexterm"/>preceding command doesn't return anything, the port is available. If the preceding command does return something, port 1990 is already being used by another application. The Atlassian SDK will notice this during startup and assign a different port to Confluence. We will go into this in the <em>Building, installing, and running your plugin</em> section.</p><div><div><h3 class="title"><a id="note51"/>Note</h3><p>If you are developing your plugin on a Linux or Mac, you can follow the online guide for installing the JDK at <a class="ulink" href="https://developer.atlassian.com/display/DOCS/Set+up+the+SDK+Prerequisites+for+Linux+or+Mac">https://developer.atlassian.com/display/DOCS/Set+up+the+SDK+Prerequisites+for+Linux+or+Mac</a>.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec114"/>Setting up the Atlassian SDK</h3></div></div></div><p>With all the<a id="id849" class="indexterm"/> prerequisites installed, we can download and set up the Atlassian SDK.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest version of the SDK via: <a class="ulink" href="https://marketplace.atlassian.com/download/plugins/atlassian-plugin-sdk-windows">https://marketplace.atlassian.com/download/plugins/atlassian-plugin-sdk-windows</a> (direct download link).</li><li class="listitem">Locate the downloaded installer and double-click on the EXE file.<div><img src="img/9526EN_10_02.jpg" alt="Setting up the Atlassian SDK"/></div></li><li class="listitem">Click on <strong>Next</strong> and select a location to install the SDK.</li><li class="listitem">Follow the next screens to install the SDK.</li></ol></div><p>The <a id="id850" class="indexterm"/>Atlassian Plugin SDK is now installed and we are ready to create our first plugin.</p><p>To verify that the SDK is configured correctly, perform the following step:</p><div><ol class="orderedlist arabic"><li class="listitem">Open a command prompt window and run the following command:<div><pre class="programlisting">
<strong>atlas-version</strong>
</pre></div><p>The system should respond with similar information as follows:</p><div><pre class="programlisting">
<strong>ATLAS Version:    4.1.7</strong>
<strong>ATLAS Home:       C:\atlassian-plugin-sdk</strong>
<strong>ATLAS Scripts:    C:\atlassian-plugin-sdk\bin</strong>
<strong>ATLAS Maven Home: C:\atlassian-plugin-sdk\apache-maven</strong>
<strong>--------</strong>
<strong>Executing: "C:\atlassian-plugin-sdk\apache-maven\bin\mvn.bat" --version -gs C:\atlassian-plugin-sdk\apache-maven/conf/settings.xml</strong>
<strong>Apache Maven 2.1.0 (r755702; 2009-03-18 20:10:27+0100)</strong>
<strong>Java version: 1.7.0_17</strong>
<strong>Java home: C:\Program Files (x86)\Java\jdk1.7.0_17\jre</strong>
<strong>Default locale: en_US, platform encoding: Cp1252</strong>
<strong>OS name: "windows server 2008 r2" version: "6.1" arch: "x86" Family: "windows"</strong>
</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec126"/>Commands</h2></div></div></div><p>The <a id="id851" class="indexterm"/>Atlassian Plugin SDK provides a set of shell scripts for <a id="id852" class="indexterm"/>creating, installing, and building plugins for Atlassian products. Let's take a look at some typical tasks and examples of commands in the SDK.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec115"/>Creating a new plugin</h3></div></div></div><p>When you want to build a<a id="id853" class="indexterm"/> new plugin, you need to create a plugin skeleton. Open a command prompt and run the following command in the location where you want to create the plugin.</p><div><pre class="programlisting">
<strong>atlas-create-confluence-plugin</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec116"/>Adding a new module to your plugin</h3></div></div></div><p>If you want to<a id="id854" class="indexterm"/> add a new module to your plugin, you could do this via the command line too. Open your command prompt and browse to the location of your plugin. Within your plugin directory run:</p><div><pre class="programlisting">
<strong>atlas-create-confluence-plugin-module</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec117"/>Running a plugin in an application</h3></div></div></div><p>If you want to <a id="id855" class="indexterm"/>run your plugin in its target application, go to the plugin directory using the command prompt and type:</p><div><pre class="programlisting">
<strong>atlas-run</strong>
</pre></div><p>The preceding command will start the application specified in your plugin (Confluence, JIRA, and so on) and automatically install your plugin.</p></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec118"/>Running a specific version of an application</h3></div></div></div><p>If you are building a <a id="id856" class="indexterm"/>plugin that should work for a specific version, or you just want to test your plugin against a new version of the application, you can specify this while starting the application. Run the following commands in your plugin directory:</p><div><pre class="programlisting">
<strong>atlas-clean</strong>
<strong>atlas-run –-version 5.0.1</strong>
</pre></div><p>The <code class="literal">atlas-clean</code> command will clear any previously run version of the plugin. This is only needed if the previous run was a different version.</p></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec119"/>Using the Maven Command Line Interface (CLI) plugin</h3></div></div></div><p>The SDK bundles the <a id="id857" class="indexterm"/>Maven CLI plugin, allowing you to run a command against a development Confluence <a id="id858" class="indexterm"/>installation. To use it with your plugin's host application, go to the plugin's project directory (where you created the plugin) and type:</p><div><pre class="programlisting">
<strong>atlas-cli</strong>
</pre></div><p>When the command-line interface is started you can use the command <code class="literal">pi</code> to package your plugin and install it into the running Confluence installation.</p></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec120"/>Running a standalone application</h3></div></div></div><p>If you want to quickly <a id="id859" class="indexterm"/>test a new version of an application, you can use the standalone command to start that application. You can run this command from anywhere, as there is no plugin required:</p><div><pre class="programlisting">
<strong>atlas-run-standalone-–product confluence --version 5.0.1</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec121"/>The help command</h3></div></div></div><p>There are <a id="id860" class="indexterm"/>more <a id="id861" class="indexterm"/>commands available, but these are the most used. If you are ever in doubt how a command is used and which are available, run the following command:</p><div><pre class="programlisting">
<strong>atlas-help</strong>
</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec122"/>Maven</h3></div></div></div><p>When you are building a plugin, you will be using Maven<a id="id862" class="indexterm"/> as an underlying library dependency management and build tool. Maven is already bundled with the Atlassian Plugin SDK, so there is no need to install it on your machine. Even if you already have a Maven version installed, you should use the bundled version, as the SDK requires a specific Maven version.</p><p>The Atlassian SDK Maven comes with configured settings so that building an Atlassian plugin will be as easy as possible. Using Maven and building your plugin does require an active Internet connection, as Maven will resolve and download all dependencies needed during the build process.</p><p>If you are <a id="id863" class="indexterm"/>behind a company proxy, make sure to configure Maven accordingly:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">%USERPROFILE%/.m2/settings.xml</code> in a text editor. If the file doesn't exist, you can create it.</li><li class="listitem">Add the following section to your file and make sure to replace the settings with your proxy settings:<div><pre class="programlisting">&lt;settings&gt;
  &lt;proxies&gt;
    &lt;proxy&gt;
      &lt;active&gt;true&lt;/active&gt;
      &lt;protocol&gt;http&lt;/protocol&gt;
      &lt;host&gt;proxy.somewhere.com&lt;/host&gt;
      &lt;port&gt;8080&lt;/port&gt;
      &lt;username&gt;proxyuser&lt;/username&gt;
      &lt;password&gt;somepassword&lt;/password&gt;
      &lt;nonProxyHosts&gt;
www.google.com|*.somewhere.com
&lt;/nonProxyHosts&gt;
    &lt;/proxy&gt;
  &lt;/proxies&gt;
&lt;/settings&gt;</pre></div></li><li class="listitem">Save the file.</li></ol></div><p>With a normal Maven installation, or if you have multiple installations, <code class="literal">mvn</code> would be available via your command prompt. To ensure you use the Atlassian provided version, Maven uses <code class="literal">atlas-mvn</code> instead.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec21"/>The pom.xml file</h4></div></div></div><p>In the root of <a id="id864" class="indexterm"/>your plugin, there is a <a id="id865" class="indexterm"/>
<code class="literal">pom.xml</code> file; this file is the core of a project's configuration in Maven. In this file, you can define dependencies on other libraries and specify which Confluence version you want to run, but it also holds the name and description of your plugin.</p><p>The <code class="literal">pom.xml</code> file is what is being used when you start your plugin with <code class="literal">atlas-run</code>.</p></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec123"/>The plugin descriptor</h3></div></div></div><p>Every plugin must have a<a id="id866" class="indexterm"/> plugin descriptor file. The file, <code class="literal">atlassian-plugin.xml</code>, describes your plugin to the target application. The Atlassian SDK generates the <code class="literal">atlassian-plugin.xml</code> file when you create your plugin for the first time. The descriptor is also updated when you use <code class="literal">atlassian-create-confluence-plugin-module</code> to add a new module.</p><p>At some point during the development of you plugin, you will have to update the file manually, so it's a good idea to have a bit of understanding as to what is in the plugin descriptor. The plugin descriptor is located in the directory <code class="literal">&lt;plugin_home&gt;/src/main/resources/</code>.</p><p>A very minimal plugin descriptor's built looks as follows:</p><div><pre class="programlisting">&lt;atlassian-plugin key="${project.groupId}.${project.artifactId}" 
  name="${project.name}" plugins-version="2"&gt;
&lt;plugin-info&gt;
&lt;description&gt;${project.description}&lt;/description&gt;
&lt;version&gt;${project.version}&lt;/version&gt;
&lt;vendor name="${project.organization.name}" 
  url="${project.organization.url}" /&gt;
&lt;/plugin-info&gt;
&lt;/atlassian-plugin&gt;</pre></div><p>This descriptor file<a id="id867" class="indexterm"/> mostly contains variables; these are Maven variables and will be replaced with the values from your <code class="literal">pom.xml</code> file when you build your plugin. The rest of the descriptor file is empty; this plugin does not contain any components, which is very unlikely for a plugin.</p><p>We will be adding more modules to this file across this chapter, if you want an overview of the available modules, skip ahead to the <em>Plugin module types</em> section.</p></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec124"/>Using a development environment</h3></div></div></div><p>When developing<a id="id868" class="indexterm"/> your plugin, it is a good idea to use an IDE, short for integrated development environment. A development environment will help you to make fewer mistakes, and can come in very handy when trying to debug your plugin.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec22"/>Installing Eclipse on Windows</h4></div></div></div><p>We will be using <a id="id869" class="indexterm"/>Eclipse, but if you have a <a id="id870" class="indexterm"/>different <a id="id871" class="indexterm"/>preference, use your own IDE.</p><div><ol class="orderedlist arabic"><li class="listitem">Download Eclipse for JAVA EE developers from <a class="ulink" href="http://www.eclipse.org/downloads/">http://www.eclipse.org/downloads/</a>.</li><li class="listitem">Extract the downloaded ZIP file onto the root of you hard drive. When you are done, if your hard drive root is <code class="literal">C:\</code>, you will have the following folder on your hard drive:<div><img src="img/9526EN_10_03.jpg" alt="Installing Eclipse on Windows"/></div></li></ol></div><p>In the next step, <a id="id872" class="indexterm"/>we are making sure Eclipse uses the JDK we just<a id="id873" class="indexterm"/> installed; this is done by editing the Eclipse<a id="id874" class="indexterm"/> initialization file.</p><div><ol class="orderedlist arabic"><li class="listitem">Make a copy of the original <code class="literal">eclipse.ini</code> and name it <code class="literal">eclipse.ini.original</code>.</li><li class="listitem">Open the <code class="literal">eclipse.ini</code> file in Notepad.</li><li class="listitem">Add a <code class="literal">–vm</code> entry before any <code class="literal">-vmargs</code> entry in the file. The entry should point to the value of your <code class="literal">%JAVA_HOME%/bin</code>. Eclipse requires that you reverse the slashes to forward slashes. Your file should look similar to this:<div><pre class="programlisting">-startup
plugins/org.eclipse.equinox.launcher_1.3.0.v20120522-1813.jar
--launcher.library
plugins/org.eclipse.equinox.launcher.win32.win32.x86_1.1.200.v20120913-144807
-product
org.eclipse.epp.package.jee.product
--launcher.defaultAction
openFile
--launcher.XXMaxPermSize
256M
-showsplash
org.eclipse.platform
--launcher.XXMaxPermSize
256m
--launcher.defaultAction
openFile
<strong>-vm</strong>
<strong>C:/Program Files/Java/jdk1.7.0_17/bin</strong>
-vmargs
-Dosgi.requiredJavaVersion=1.5
-Dhelp.lucene.tokenizer=standard
-Xms40m
-Xmx512m</pre></div></li><li class="listitem">Close and save the file.</li><li class="listitem">Start <a id="id875" class="indexterm"/>Eclipse and choose a location where <a id="id876" class="indexterm"/>Eclipse will store you <a id="id877" class="indexterm"/>workspaces.</li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec23"/>Installing the Maven Eclipse plugin</h4></div></div></div><p>We will be <a id="id878" class="indexterm"/>using the <a id="id879" class="indexterm"/>Maven Eclipse <a id="id880" class="indexterm"/>plugin, which will help us with getting the dependencies needed for our Confluence plugins.</p><div><ol class="orderedlist arabic"><li class="listitem">Select <strong>Help</strong> | <strong>Install</strong> new Software. Click on the <strong>Add</strong> button to add a new repository.</li><li class="listitem">Enter <code class="literal">Sonatype M2Eclipse</code> in the <strong>Name</strong> field.</li><li class="listitem">Enter <code class="literal">http://m2eclipse.sonatype.org/sites/m2e</code> in the <strong>Location</strong> field.</li><li class="listitem">Click on <strong>OK</strong> to close the dialog. The system searches the site for the plugin. After a moment, the <strong>Name</strong> field fills with the <strong>Maven Integration for Eclipse</strong> software as the following:<div><img src="img/9526EN_10_04.jpg" alt="Installing the Maven Eclipse plugin"/></div></li><li class="listitem">Check the checkbox and click on <strong>Next</strong>.</li><li class="listitem">Accept <a id="id881" class="indexterm"/>the terms of the license agreements <a id="id882" class="indexterm"/>and click on <strong>Finish</strong>.</li><li class="listitem">Restart <a id="id883" class="indexterm"/>Eclipse when prompted.</li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec24"/>Configuring the Maven plugin</h4></div></div></div><p>After Eclipse has <a id="id884" class="indexterm"/>restarted, ensure that the Maven plugin is <a id="id885" class="indexterm"/>configured correctly.</p><div><ol class="orderedlist arabic"><li class="listitem">Choose <a id="id886" class="indexterm"/><strong>Window</strong> | <strong>Preferences</strong> from the eclipse menu bar.</li><li class="listitem">Type <code class="literal">Maven</code> in the filter text field and select <strong>Installations</strong>.</li><li class="listitem">Click on the <strong>Add</strong> button to add a new Maven installation.</li><li class="listitem">Browse to your Atlassian SDK installation and select the <code class="literal">apache-maven</code> folder.</li><li class="listitem">Click on <strong>OK</strong>.<div><img src="img/9526EN_10_05.jpg" alt="Configuring the Maven plugin"/></div></li><li class="listitem">Click on <a id="id887" class="indexterm"/><strong>Apply</strong>.</li><li class="listitem">Click <a id="id888" class="indexterm"/>on the Maven root.</li><li class="listitem">Uncheck <a id="id889" class="indexterm"/><strong>Download repository index updates on startup</strong>. This prevents Maven from updating on Eclipse startup, which can be time consuming. The <code class="literal">atlas-</code> commands will update the repositories for you.</li><li class="listitem">Click on <strong>OK</strong> to close the dialog.</li></ol></div></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec64"/>Building your first plugin</h1></div></div></div><p>When you have installed the <a id="id890" class="indexterm"/>Atlassian SDK, you can start building your first plugin. We will be building a new Confluence macro, which can be used to format content.</p><p>We will take a look at:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The macro interface, which is the base of all macros</li><li class="listitem" style="list-style-type: disc">The<a id="id891" class="indexterm"/> <code class="literal">xhtml-macro</code> module</li><li class="listitem" style="list-style-type: disc">Adding resources, such as a stylesheet, to your plugin</li></ul></div><p>We will be building a macro that displays links as buttons.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec127"/>Creating the plugin project</h2></div></div></div><p>First, we have to create our <a id="id892" class="indexterm"/>plugin skeleton using the Atlassian SDK and load our new project into Eclipse.</p><div><ol class="orderedlist arabic"><li class="listitem">Open a command prompt and navigate to the location for you new plugin.</li><li class="listitem">Enter the following command to create a new Confluence plugin:<div><pre class="programlisting">
<strong>atlas-create-confluence-plugin</strong>
</pre></div></li><li class="listitem">When prompted, enter the following information to identify your plugin:<div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">groupId</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">com.example.confluence</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">artifactId</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">button-macro</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">version</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">1.0-snapshot</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">package</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">com.example.confluence.button</code>
</p>
</td></tr></tbody></table></div></li><li class="listitem">Confirm your entries when prompted.</li><li class="listitem">Start Eclipse.</li><li class="listitem">Select <strong>File</strong> | <strong>Import...</strong> from the Eclipse menu.</li><li class="listitem">Type <code class="literal">Maven</code> in the filter text field and select <strong>Existing Maven Projects</strong>:<div><img src="img/9526EN_10_06.jpg" alt="Creating the plugin project"/></div></li><li class="listitem">Click on <a id="id893" class="indexterm"/><strong>Browse</strong> and browse to the location where you created the plugin.</li><li class="listitem">Select the <code class="literal">pom.xml</code> file and click on <strong>Finish</strong>. Eclipse will now import your project and download all dependencies if needed. This can take a while.</li><li class="listitem">Sometimes an error will occur during this process, if so:<div><ol class="orderedlist arabic"><li class="listitem">Right-click on the imported project (in the project explorer).</li><li class="listitem">Select <strong>Maven</strong> | <strong>Update Project Configuration</strong>.</li></ol></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec128"/>Updating the generated code</h2></div></div></div><p>When you have just generated a <a id="id894" class="indexterm"/>new plugin skeleton, you have to make sure all the details, like the plugin name or description, are correct. In this section, we'll check the Confluence version value and tweak some settings. Open your plugin project in Eclipse and follow along.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec125"/>Adding plugin metadata to the POM file</h3></div></div></div><p>The metadata in your <a id="id895" class="indexterm"/>POM file will be used when your plugin is built. This<a id="id896" class="indexterm"/> would be the place to add your company details and description of the plugin.</p><div><ol class="orderedlist arabic"><li class="listitem">Edit the <code class="literal">pom.xml</code> file in the root of your plugin.</li><li class="listitem">Add your company or organization details to the <code class="literal">&lt;organization&gt;</code> element:<div><pre class="programlisting">&lt;organization&gt;
&lt;name&gt;Stefan Kohler&lt;/name&gt;
&lt;url&gt;http://www.stefankohler.nl/&lt;/url&gt;
&lt;/organization&gt;</pre></div></li><li class="listitem">Update <a id="id897" class="indexterm"/>the <code class="literal">&lt;name&gt;</code> and<a id="id898" class="indexterm"/> <code class="literal">&lt;description&gt;</code> elements:<div><pre class="programlisting">&lt;name&gt;Confluence Button Macro&lt;/name&gt;
&lt;description&gt;Display a link using a nicely formatted button.&lt;/description&gt;</pre></div></li><li class="listitem">Save the file.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec126"/>Verifying your Confluence version</h3></div></div></div><p>When you generated a new plugin skeleton, a default <a id="id899" class="indexterm"/>Confluence version was included in your <code class="literal">pom.xml</code> file. Before you start building your plugin, make sure this version is up-to-date.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">pom.xml</code> file in Eclipse.</li><li class="listitem">Scroll to the bottom of the file.</li><li class="listitem">Find the <code class="literal">&lt;properties&gt;</code> element. This section lists the version of Confluence and other properties of your plugin.</li><li class="listitem">Change the Confluence version to <code class="literal">5.1.2</code>, or a more recent one if available.</li><li class="listitem">Save the <code class="literal">pom.xml</code> file. Eclipse will automatically download the new dependencies for you.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec127"/>Cleaning up the plugin skeleton</h3></div></div></div><p>We are building a<a id="id900" class="indexterm"/> new macro, and most of the generated code is for a different component. Therefore, we have no use for the generated code. Before we start, let's clean up first.</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">src/main/resources/atlassian-plugin.xml</code> in Eclipse.</li><li class="listitem">Remove the <code class="literal">&lt;web-resource&gt;</code>, <code class="literal">&lt;component-import&gt;</code>, and <code class="literal">&lt;component&gt;</code> sections.</li><li class="listitem">Also remove the corresponding files:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MyPluginComponent.java</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">MyPluginComponentImpl.java</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">MyComponentWiredTest.java</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">MyComponentUnitTest.java</code></li></ul></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec129"/>Adding a new macro module</h2></div></div></div><p>With our plugin <a id="id901" class="indexterm"/>skeleton ready for development, we will be adding some new modules to our plugin descriptor.</p><div><ol class="orderedlist arabic"><li class="listitem">Open your <code class="literal">atlassian-plugin.xml</code> file in Eclipse.</li><li class="listitem">Add the <code class="literal">xhtml-macro</code> component to the file:<div><pre class="programlisting">&lt;xhtml-macroname="link-button"
  class="com.example.confluence.button.LinkButton"
  key="link-button"&gt;
  
  &lt;parameters/&gt;
&lt;/xhtml-macro&gt;</pre></div></li><li class="listitem">The <code class="literal">Class</code> argument is pointing to an implementation of our macro.</li></ol></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec128"/>Implementing the macro interface</h3></div></div></div><p>The macro module we<a id="id902" class="indexterm"/> just defined will call the <code class="literal">execute</code> method of our Java class <code class="literal">com.example.confluence.button.LinkButton</code>. That class doesn't exist yet, so let's create it.</p><div><ol class="orderedlist arabic"><li class="listitem">Right-click on the <code class="literal">com.example.confluence.button</code> package (folder) in your project.</li><li class="listitem">Select <strong>New</strong> | <strong>Class</strong> and enter the following details:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Package</strong> – <code class="literal">com.example.confluence.button</code></li><li class="listitem" style="list-style-type: disc"><strong>Name</strong> – <code class="literal">LinkButton</code></li><li class="listitem" style="list-style-type: disc"><strong>Interfaces</strong> – Add <code class="literal">com.atlassian.confluence.macro.Macro</code></li></ul></div></li><li class="listitem">Click on <strong>Finish</strong>.</li></ol></div><p>Your new Java class will be generated, and you might notice we have to implement three methods.</p></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec129"/>Implementing the getBodyType and getOutputType methods</h3></div></div></div><p>These two methods specify <a id="id903" class="indexterm"/>whether the macro has a body (and the type of body if it does have one) and the output type, be it block or inline. The <a id="id904" class="indexterm"/>macro we implement will have a body and will have the block output type.</p><div><pre class="programlisting">@Override
publicBodyTypegetBodyType() {
  returnBodyType.RICH_TEXT;
}

@Override
publicOutputTypegetOutputType() {
  returnOutputType.BLOCK;
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec130"/>Implementing the execute method</h3></div></div></div><p>The execute <a id="id905" class="indexterm"/>method will determine what the output of our macro will be. I have included an easy template with some HTML to style our button. We will be using the body of our macro and use that as input for our button.</p><div><pre class="programlisting">  @Override
  public String execute(Map&lt;String, String&gt; parameters,
      String body, ConversionContext context) throws MacroExecutionException {

    String template = "&lt;div class=\"aui-button aui-button-primary link-button\"&gt;%s&lt;/div&gt;";
    
    returnString.format(template, body);
  }</pre></div><p>The template we are using makes use of the <a id="id906" class="indexterm"/>
<strong>Atlassian User Interface</strong> (<strong>AUI</strong>), a library with JavaScript, stylesheets, and templates that is included in all Atlassian products. If you use the AUI in your plugin, it will have the same look and feel as Confluence.</p><p>More information about the AUI can be found online at <a class="ulink" href="https://developer.atlassian.com/display/AUI/">https://developer.atlassian.com/display/AUI/</a>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec130"/>Building, installing, and running your plugin</h2></div></div></div><p>When we have the <a id="id907" class="indexterm"/>basics set for our <a id="id908" class="indexterm"/>plugin, it is time to build and run the plugin in Confluence.</p><div><ol class="orderedlist arabic"><li class="listitem">Save all the changes to your code.</li><li class="listitem">Open a command prompt and navigate to the location of your plugin.</li><li class="listitem">Run the following command:<div><pre class="programlisting">
<strong>atlas-run</strong>
</pre></div><p>This command will build your plugin, start a Confluence installation, and install your plugin in that Confluence installation. This may take a while. When the process is completed, the last lines of the output should look as follows:</p><div><pre class="programlisting">
<strong>[INFO] confluence started successfully in 225s at http://localhost:1990/confluence</strong>
<strong>[INFO] Type Ctrl-D to shutdown gracefully</strong>
<strong>[INFO] Type Ctrl-C to exit</strong>
</pre></div><p>If Confluence couldn't use port 1990 because another application is using it, Confluence will start on a different port and will mention it in these lines.</p></li><li class="listitem">Open <a id="id909" class="indexterm"/>your browser at <code class="literal">http://localhost:1990/confluence</code>.</li><li class="listitem">At the<a id="id910" class="indexterm"/> Confluence login, enter a username <code class="literal">admin</code> with the password <code class="literal">admin</code>.</li><li class="listitem">Create a new page with your new macro.<div><ol class="orderedlist arabic"><li class="listitem">Click on <strong>Create</strong> in the navigation bar.</li><li class="listitem">Select <strong>Insert</strong> | <strong>Other macros</strong>.</li><li class="listitem">Search for <code class="literal">Link Button</code>.</li><li class="listitem">Insert your macro.<div><img src="img/9526EN_10_07.jpg" alt="Building, installing, and running your plugin"/></div></li><li class="listitem">Add a link in the body of your macro as you would normally do in Confluence.</li><li class="listitem">Save the page.</li></ol></div></li><li class="listitem">Watch how your new macro has formatted your link:<div><img src="img/9526EN_10_08.jpg" alt="Building, installing, and running your plugin"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec131"/>Adding resources</h2></div></div></div><p>What the preceding screenshot displays is not very user-readable; it would be better if the link itself is white. For this we have to add resources, a CSS file, to our plugin.</p><p>In the <code class="literal">atlassian-plugin.xml</code> file, add the <code class="literal">&lt;web-resources&gt;</code> element to the file:</p><div><pre class="programlisting">&lt;web-resource key="link-button-resources" 
name="Link Button Resources"&gt;

&lt;resource type="download" name="button-macro.css"
location="css/button-macro.css" /&gt;

&lt;context&gt;atl.general&lt;/context&gt;

&lt;/web-resource&gt;</pre></div><p>The <code class="literal">&lt;resource&gt;</code> element determines which file will be included with our plugin. The location is relative to the <code class="literal">src/main/resources</code> folder.</p><p>The <code class="literal">&lt;context&gt;</code> element will tell Confluence when to load these extra resources. In our case, the resources are loaded on every page except for administrative screens.</p><p>The following CSS has to be added to our <code class="literal">button-macro.css</code> class:</p><div><pre class="programlisting">.aui-button.link-button a {
  color: #ffffff !important;
}</pre></div><p>After reloading our plugin, the button should now look like this:</p><div><img src="img/9526EN_10_09.jpg" alt="Adding resources"/></div><div><div><h3 class="title"><a id="tip18"/>Tip</h3><p>
<strong>Reloading your plugin with FastDev</strong>
</p><p>FastDev is a feature of Atlassian SDK that speeds up plugin development. FastDev will scan your plugin directory for changes, and is able to package and reinstall your plugin directly from Confluence. More information on FastDev at <a class="ulink" href="https://developer.atlassian.com/display/DOCS/Automatic+Plugin+Reinstallation+with+FastDev">https://developer.atlassian.com/display/DOCS/Automatic+Plugin+Reinstallation+with+FastDev</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec132"/>Releasing your plugin</h2></div></div></div><p>At a<a id="id911" class="indexterm"/> certain point, you are done developing your plugin and you want to deliver the end result to your company or maybe even to the rest of world. The first thing we have to do is release your plugin.</p><p>The release process relies heavily on you to have a revision control system for your plugin, like Subversion or GIT. If you don't have such a system in place, you could consider taking a look at <a class="ulink" href="http://bitbucket.org">http://bitbucket.org</a>, which is an online Atlassian tool that offers free source hosting.</p><p>Before we can release our plugin, we have to make sure that our <code class="literal">pom.xml</code> file has all the requirements to do so.</p><p>To set the SCM properties, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">pom.xml</code> file in your plugin.</li><li class="listitem">Add the following lines to the file with your SCM information:<div><pre class="programlisting">&lt;scm&gt;
&lt;connection&gt;
scm:git:git@bitbucket.org:stefankohler/plugin-example-button.git
&lt;/connection&gt;
&lt;developerConnection&gt;
scm:git:file:///${basedir}
&lt;/developerConnection&gt;
url&gt;
https://bitbucket.org/stefankohler/plugin-example-button
&lt;/url&gt;
&lt;/scm&gt;</pre></div></li><li class="listitem">Save the <code class="literal">pom.xml</code> file.</li></ol></div><p>The <code class="literal">connection</code> and <code class="literal">developerConnection</code> tell Maven how to connect to your repository. While <code class="literal">connection</code> requires read access for Maven to be able to find the source code (for example, an update), <code class="literal">developerConnection</code> requires a connection that will give write access.</p><p>The <code class="literal">url</code> element is <a id="id912" class="indexterm"/>not required, but can be used for a publicly accessible URL to your repository.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec131"/>Setting distributionManagement</h3></div></div></div><p>The release process <a id="id913" class="indexterm"/>will upload your plugin to a specified location defined by the <code class="literal">distributionManagement</code> section in your <code class="literal">pom.xml</code> file. This location can be anything from a remote server to your local filesystem. For now, we will set this location to a temp directory on your local machine, as the process requires this setting.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">pom.xml</code> file in your plugin.</li><li class="listitem">Add the following lines to the file:<div><pre class="programlisting">  &lt;distributionManagement&gt;
  &lt;repository&gt;
  &lt;id&gt;local-repository&lt;/id&gt;
  &lt;url&gt;file:///${basedir}/target&lt;/url&gt;
  &lt;/repository&gt;
  &lt;/distributionManagement&gt;</pre></div></li><li class="listitem">The variable will be replaced with your own local settings.</li><li class="listitem">Save the file.</li></ol></div><p>The next step is to release your plugin:</p><div><ol class="orderedlist arabic"><li class="listitem">Make sure all changes have been committed.</li><li class="listitem">Open a command prompt and navigate to the location of your plugin and run the following command:<div><pre class="programlisting">
<strong>atlas-mvn release:prepare</strong>
</pre></div></li><li class="listitem">This command will update your <code class="literal">pom.xml</code> file with the required version and will make a new tag for the release. During the process you will be asked the release version and the next development version.</li><li class="listitem">After the command has finished run the following command:<div><pre class="programlisting">
<strong>atlas-mvn release:perform</strong>
</pre></div><p>This command will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Check out the just created tag.</li><li class="listitem" style="list-style-type: disc">Run all tests.</li><li class="listitem" style="list-style-type: disc">Compile the code and package it.</li><li class="listitem" style="list-style-type: disc">Upload your binary to a defined location.</li></ul></div></li><li class="listitem">After the command is finished, you can find your released plugin in the target directory in your plugin folder. This should be a <code class="literal">.jar</code> file, named for your plugin and version, that is <code class="literal">button-macro-1.0.jar</code>.</li></ol></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec25"/>Releasing your plugin without revision control</h4></div></div></div><p>If you don't have any <a id="id914" class="indexterm"/>revision control, the release process of your plugin involves some manual steps.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">pom.xml</code> file in your plugin.</li><li class="listitem">Change the <code class="literal">&lt;version&gt;&lt;/version&gt;</code> parameter to your release version, that is <code class="literal">1.1</code>.</li><li class="listitem">Save the file.</li><li class="listitem">Open a command prompt and go to your plugin location.</li><li class="listitem">Run the <code class="literal">atlas-package</code> command. This command will compile, test, and build your plugin.</li><li class="listitem">After the command is finished, you can find your released plugin in the target directory in your plugin folder. This should be a <code class="literal">.jar</code> file, named for your plugin and version, that is <code class="literal">button-macro-1.1.jar</code>.</li></ol></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec65"/>Plugin module types</h1></div></div></div><p>An Atlassian plugin can <a id="id915" class="indexterm"/>specify one or more plugin modules to affect the underlying Atlassian applications. Plugin modules are elements you can add to your plugin and which will be translated by the SDK and the application architecture to something Confluence understands.</p><p>We already used the <code class="literal">xhtml-macro</code> and <code class="literal">web-resource</code> modules in our first plugin, but there are many more.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec133"/>Generic module types</h2></div></div></div><p>These are module <a id="id916" class="indexterm"/>types that are available in every application, not <a id="id917" class="indexterm"/>just Confluence. If you are building a plugin for multiple applications, stick to only these types.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Module type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">component</code>
<a id="id918" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds components to the component system for reuse and autowiring. Think of your own services.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">component-import</code>
<a id="id919" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Imports components from other add-ons so that they are available in your own add-on.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">module-type</code>
<a id="id920" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds new plugin modules to the plugin framework. Useful when building for, or on top of other add-ons.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">path-converter</code>
<a id="id921" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Enables you to create custom URL schemes for your add-on, that is you can have SEO-friendly URL schemes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rest</code>
<a id="id922" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Makes services and resources available as REST API.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">servlet</code>
<a id="id923" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Deploys a standard Java servlet within a Confluence add-on.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">servlet-context-listener</code>
<a id="id924" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Deploys a <a id="id925" class="indexterm"/>Java servlet context listener as a part of your add-on.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">servlet-context-param</code>
<a id="id926" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds parameters in the Java Servlet context shared by your add-on's servlets, filters, and listeners.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">servlet-filter</code>
<a id="id927" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a Java servlet filter to your add-on. Don't forget to specify the location and ordering of your filter.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">velocity-context-item</code>
<a id="id928" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds helper objects to your Velocity context, which can be used in templates.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">web-item</code>
<a id="id929" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds links and tabs to the Confluence UI.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">web-resource</code>
<a id="id930" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Enables you to include stylesheets and JavaScript to your add-on.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">web-resource-transformer</code>
<a id="id931" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Allows you to manipulate web resources before they are send to the browser.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">web-section</code>
<a id="id932" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds sections of links to the Confluence UI.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec134"/>Confluence-specific module types</h2></div></div></div><p>Each Atlassian application <a id="id933" class="indexterm"/>has it own modules, as does Confluence. The following are the module types supported by Confluence:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Module type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">codeformatter</code>
<a id="id934" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds new code languages to the <code class="literal">{code}</code> macro.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">colour-scheme</code>
<a id="id935" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a color scheme to a theme.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">decorator</code>
<a id="id936" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a decorator (layout) to your add-on for usage without a theme.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">device-type-renderer</code>
<a id="id937" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a renderer for a specified (mobile) device type.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">extractor</code>
<a id="id938" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Allows you to extract data and put this in the Confluence indexer.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">job</code>
<a id="id939" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a repeatable job, like a scheduled service to Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">keyboard-shortcut</code>
<a id="id940" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Defines a new keyboard shortcut within Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">language</code>
<a id="id941" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Provides a new language translation to Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">layout</code>
<a id="id942" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a layout (decorator) to your add-on for usage with a theme.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">lifecycle</code>
<a id="id943" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Can be used to schedule tasks during application startup and shutdown.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">listener</code>
<a id="id944" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>A special component that will respond to certain events in Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xhtml-macro</code>
<a id="id945" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a new macro to the WYSIWYG editor. Should output HTML that can be embedded in a page.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpc-soap</code>
<a id="id946" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds a SOAP service to Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">rpc-xmlrpc</code>
<a id="id947" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds an XML-RPC service to Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">theme</code>
<a id="id948" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Creates a new theme (look and feel) for Confluence or a single space.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">trigger</code>
<a id="id949" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds <a id="id950" class="indexterm"/>a trigger that schedules jobs.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xwork</code>
<a id="id951" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds new actions and views to an add-on, enabling user interaction.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec135"/>The plugin module types in detail</h2></div></div></div><p>The preceding list is pretty comprehensive and there is so much to choose from. In this section, I will explain in detail some plugin module types that you will almost certainly use in most of your plugins.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec132"/>XWork</h3></div></div></div><p>If you want to add <a id="id952" class="indexterm"/>an action or screen to Confluence, like a<a id="id953" class="indexterm"/> configuration screen, there are two options. The first is building a standard Java servlet, the second is making use of XWork/WebWork.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec26"/>The module descriptor</h4></div></div></div><p>The syntax of an <a id="id954" class="indexterm"/>XWork module is as follows</p><div><pre class="programlisting">&lt;xwork name="plugin-actions" key="plugin-actions"&gt;
&lt;package name="configure" extends="default"
namespace="/plugins/config"&gt;

&lt;default-interceptor-ref name="defaultStack" /&gt;

&lt;action name="alpha"
class="com.example.action.AlphaConfigAction"
method="view"&gt;

&lt;result name="success"type="velocity"&gt;
        /templates/alpha-config-action.vm
&lt;/result&gt;

&lt;/action&gt;
&lt;/package&gt;
&lt;/xwork&gt;</pre></div><p>Let's go <a id="id955" class="indexterm"/>quickly over the XML to explain what we just defined:</p><div><pre class="programlisting">&lt;xwork name="plugin-actions" key="plugin-actions"&gt;</pre></div><p>defines the XWork module, both the <code class="literal">name</code> and <code class="literal">key</code> attributes are for identification only.</p><div><pre class="programlisting">&lt;package name="configure" extends="default"
namespace="/plugins/config"&gt;</pre></div><p>Packages are used to group actions, and your XWork module can have more than one. <code class="literal">name</code> is the only required attribute and identifies the package. <code class="literal">extends</code> specifies if the package inherits behavior from other packages; in this case we use the Confluence default. With <code class="literal">namespace</code>, you can define under which URL the actions are available.</p><div><pre class="programlisting">&lt;action name="alpha"
class="com.example.action.AlphaConfigAction"
method="view"&gt;</pre></div><p>The <code class="literal">action</code> element is the basic unit of work and defines an action, which in most cases is a URL. The name attribute completes the URL, as the preceding action is available at <code class="literal">/plugins/config/alpha.action</code>. An action always has a class, which will extend <code class="literal">ConfluenceActionSupport</code>. With <code class="literal">method</code>, it is possible to specify the method in the class responsible for this action.</p><div><pre class="programlisting">&lt;result name="success"type="velocity"&gt;
/templates/alpha-config-action.vm
&lt;/result&gt;</pre></div><p>The <code class="literal">result</code> element will map the result of an action to a template. In the preceding example, the velocity template <code class="literal">alpha-config-action.vm</code> will be rendered if our <code class="literal">AlphaConfigAction</code> returns <code class="literal">success</code>.</p></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec27"/>The action class</h4></div></div></div><p>Every action should <a id="id956" class="indexterm"/>have an implementation that extends the <code class="literal">ConfluenceActionSupport</code> class. Actions can use the same implementation if that makes sense for your plugin.</p><p>Our <code class="literal">AlphaConfigAction</code> class should look something like this:</p><div><pre class="programlisting">public class AlphaConfigAction extends ConfluenceActionSupport {

public String view() {
if (condition == true) return SUCCESS;
  return ERROR;
    }

public String getViewMessage() {
return "Don't forget a towel";
    }

}</pre></div><p>Based on our <a id="id957" class="indexterm"/>action configuration, the method <code class="literal">view()</code> is called and based upon the return the success or error template is rendered.</p><p>This is of course a simple example, but you can do much more in this action class. The action class is also available in your template, so if you want to render certain information via that template, make sure there is a <code class="literal">get</code> method available, just like <code class="literal">#getViewMessage()</code>.</p></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec133"/>Web Sections</h3></div></div></div><p>Web Sections <a id="id958" class="indexterm"/>allows your plugin to add new <a id="id959" class="indexterm"/>sections to existing menus; each section can contain one or more links, which are defined as Web Items. We can use Web Sections to add a new section to the Confluence administration for our plugin configuration.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec28"/>The module descriptor</h4></div></div></div><p>The syntax of a Web <a id="id960" class="indexterm"/>Section is as follows:</p><div><pre class="programlisting">&lt;web-section key="plugin-admin-section" location="system.admin" 
weight="1000"&gt;

&lt;label key="plugin.menu.section" /&gt;

&lt;condition class="com.atlassian.confluence.plugin.descriptor.web.conditions.SystemAdministratorCondition" /&gt;

&lt;/web-section&gt;</pre></div><p>Let's break down this definition:</p><div><pre class="programlisting">&lt;web-section key="plugin-admin-section" location="system.admin" 
weight="1000"&gt;</pre></div><p>A web-section element requires a <code class="literal">key</code>, which is a unique identifier for this component. <code class="literal">location</code> relates to the menu this section needs to be added to and the <code class="literal">weight</code> determines at which position it needs to be added to.</p><p>
<code class="literal">location</code> menus can be difficult to find if you are not familiar with the source code of Confluence itself. More <code class="literal">location</code> menus are documented on <a class="ulink" href="https://developer.atlassian.com/display/CONFDEV/Web+UI+Modules">https://developer.atlassian.com/display/CONFDEV/Web+UI+Modules</a>. A few that are commonly used are:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Location</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">system.profile</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The tabs above the user profile view.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">system.user</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The drop-down menu when you click the user avatar in the top-right corner.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">system.admin</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The links in the left-hand side menu in the Administrator Console.</p>
</td></tr></tbody></table></div><p>The<a id="id961" class="indexterm"/> <code class="literal">label</code> element is the only required element in the web-section plugin. It looks up for the <code class="literal">label</code> in your plugin properties file and uses it in the menu section header.</p><div><pre class="programlisting">&lt;label key="plugin.menu.section" /&gt;</pre></div><p>You can add one or more conditions to a web panel or item. The implementation of these conditions must return <code class="literal">true</code> in order for the section to display in the interface. This can be used the make sure the links are only available for administrators.</p><div><pre class="programlisting">  &lt;condition class="com.atlassian.confluence.plugin.descriptor.web.conditions.SystemAdministratorCondition" /&gt;</pre></div></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec134"/>Web Items</h3></div></div></div><p>With Web Items you can <a id="id962" class="indexterm"/>add links to Confluence via your<a id="id963" class="indexterm"/> plugin. If you build a screen you probably want users to find it; adding a web items to your plugin should make this possible.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec29"/>The module descriptor</h4></div></div></div><p>A common <a id="id964" class="indexterm"/>Web Item will be configured similar to this:</p><div><pre class="programlisting">&lt;web-item key="config-link" name="Plugin Configuration" 
section="system.admin/plugin-admin-section" weight="10"&gt;

&lt;label key="plugin.menu.config" /&gt;

&lt;linklinkId="config-link"&gt;/plugins/config/alpha.action&lt;/link&gt;

&lt;icon height="16" width="16"&gt;
&lt;link&gt;/images/icons/config.gif&lt;/link&gt;
&lt;/icon&gt;
&lt;/web-item&gt;</pre></div><p>I'll explain this example a bit more in detail:</p><div><pre class="programlisting">&lt;web-item key="config-link" name="Plugin Configuration" 
section="system.admin/plugin-admin-section" weight="10"&gt;</pre></div><p>The <code class="literal">web-item</code> attribute knows a <code class="literal">section</code> argument instead of a location, as Web Items must be placed in sections. In our example, I'm placing this Web Item in the section we have defined earlier.</p><div><pre class="programlisting">&lt;linklinkId="config-link"&gt;/plugins/config/alpha.action&lt;/link&gt;</pre></div><p>The <code class="literal">link</code> element will determine where the user will go after clicking on the menu item. The <code class="literal">linkId</code> argument is optional and will provide an HTML ID when rendered. The link can either be relative to the Confluence server or absolute, pointing to any website you wish.</p><div><pre class="programlisting">  &lt;icon height="16" width="16"&gt;
  &lt;link&gt;/images/icons/config.gif&lt;/link&gt;
  &lt;/icon&gt;</pre></div><p>Web Items can <a id="id965" class="indexterm"/>contain icons that will be placed before the their <code class="literal">label</code> elements. The icon can have a <code class="literal">width</code> and a <code class="literal">height</code> attribute. The location of the image is defined by the <code class="literal">link</code> element.</p><p>Just like Web Sections can, Web Items can contain conditions to determine when a link is shown and to who.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec66"/>Online resources</h1></div></div></div><p>This chapter <a id="id966" class="indexterm"/>gives you only a small insight into the possibilities on extending Confluence and writing your own plugins. There are many online resources available to move you forward from this point.</p><p>All developer documentation is bundled and located at <a class="ulink" href="https://developer.atlassian.com">https://developer.atlassian.com</a>.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>The Confluence module types</strong>: For <a id="id967" class="indexterm"/>more details about the available modules and which arguments and elements <a id="id968" class="indexterm"/>they accept, visit <a class="ulink" href="https://developer.atlassian.com/display/CONFDEV/Confluence+Plugin+Module+Types">https://developer.atlassian.com/display/CONFDEV/Confluence+Plugin+Module+Types</a>.</li><li class="listitem" style="list-style-type: disc"><strong>Confluence Plugin Tutorials</strong>: Various<a id="id969" class="indexterm"/> Confluence <a id="id970" class="indexterm"/>tutorials from beginner to advanced developer are available at <a class="ulink" href="https://developer.atlassian.com/display/CONFDEV/Confluence+Tutorials">https://developer.atlassian.com/display/CONFDEV/Confluence+Tutorials</a>.</li><li class="listitem" style="list-style-type: disc"><strong>Atlassian Design Guidelines and User Interface</strong>: Atlassian provides a toolkit for you to <a id="id971" class="indexterm"/>help you <a id="id972" class="indexterm"/>create beautiful features for their products at <a class="ulink" href="https://developer.atlassian.com/display/AUI/">https://developer.atlassian.com/display/AUI/</a>.</li><li class="listitem" style="list-style-type: disc"><strong>The Marketplace</strong>: Everything <a id="id973" class="indexterm"/>you need to get your plugin <a id="id974" class="indexterm"/>Marketplace-ready is available at <a class="ulink" href="https://developer.atlassian.com/display/MARKET/Atlassian+Marketplace">https://developer.atlassian.com/display/MARKET/Atlassian+Marketplace</a>.</li></ul></div><div><div><h3 class="title"><a id="tip19"/>Tip</h3><p>
<strong>Get the sources</strong>
</p><p>If you have a valid license for Confluence, you can download the sources via <a class="ulink" href="https://my.atlassian.com">https://my.atlassian.com</a>. If you are building your plugin, these sources are sometimes the best documentation available. When you are stuck, search the source code for similar situations and take a look at how Atlassian solved those problems.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec67"/>Summary</h1></div></div></div><p>We have taken a look at how to extend Confluence with a plugin. We have learned how to set up our IDE and build our first plugin, creating a new Confluence macro.</p><p>We have also seen that Confluence has over 30 extension points that you can use enhancing Confluence with your features. This chapter should give you a head start when you start building your own plugin and a general sense about the possibilities.</p><p>With that, you have all the essentials to work with Confluence and make the tool essential to your company. If you are ever stuck, you'll find me, and many others in the community, on Atlassian Answers (<a class="ulink" href="https://answers.atlassian.com">https://answers.atlassian.com</a>).</p></div></body></html>