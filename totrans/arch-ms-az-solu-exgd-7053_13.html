<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Implementing Messaging Solutions</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered how to design solutions using the various artificial i</span><span>ntelligence services that Azure offers. We covered Azure Machine Learning, IoT features, and Azure Media Services.</span></p>
<p>In this chapter, you will learn how to design effective messaging architectures using the Azure Service Bus, Azure Queues, Notification Hubs, Azure Event Grid, and services that were covered throughout the previous chapters, such as Logic Apps and Event Hubs.</p>
<p>The following topics will be covered:</p>
<ul>
<li><span>Azure Storage Queues</span></li>
<li><span>Azure Service Bus</span></li>
<li>Azure Event Grid</li>
<li>Notification Hubs</li>
<li>Designing an effective messaging architecture</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for the examples:</p>
<ul>
<li>Azure PowerShell: <a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1">https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1</a></li>
</ul>
<p><span>The source code for this chapter can be downloaded from the following link:</span></p>
<ul>
<li><a href="https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%2013">https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%2013</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Queue Storage</h1>
                </header>
            
            <article>
                
<p>We've briefly discussed Azure Queue Storage in <a href="a9ce7cfc-00db-4859-9109-c78dda2ab0c5.xhtml" target="_blank">Chapter 7</a>, <em>Using Storage Solutions</em>, in the <em>Storage</em> section. <span>Queue </span>Storage offers <span>asynchronous processing of messages</span>. It provides a reliable and persistent messaging mechanism. It offers a REST API, which supports GET/PUT/PEEK operations. The message queue can be used to <span>decouple applications, which enables independent scaling between the different application components.</span></p>
<p>Azure Queue Storage offers the following capabilities:</p>
<ul>
<li>Single queue messages can be up to 64 KB in size. The maximum time that a message can remain in the queue is 7 days.</li>
<li>A Message can become invisible for other readers when it is requested from the queue. The message is locked for other applications and can't be processed by other applications during the time that it is invisible. By default, this will last for 30 seconds.</li>
<li>Messages should be deleted from the queue when they are processed. If the message is not deleted from the application that requested the message, it will be visible again after the 30 seconds of invisibility.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Service Bus</h1>
                </header>
            
            <article>
                
<p>Azure Service Bus is a <span>highly reliable, brokered messaging system for integration scenarios and IoT solutions. It is aimed at enterprise applications, and it offers middleware technologies such as message queueing and publish/subscribe messaging. It decouples the communication between applications and services.</span></p>
<p>Azure Service Bus offers the following key capabilities:</p>
<ul>
<li><strong>Queues</strong>: This offers <span>asynchronous, decoupled message communication between applications and services. It offers<strong> </strong>First In, First Out (FIFO) message delivery, and each message is received by one consumer. Messages are stored in the queue, so senders and consumers don't have to be connected to the queue at the same time. Service Bus Queues also offers <strong>Sessions</strong>, where messages can be grouped using a session ID. This way, the messages can be isolated and processed by dedicated clients.</span></li>
<li><strong>Topics and Subscriptions</strong>: This offers the same functionalities as Queues, except there can be multiple consumers. This uses the <span>publish/subscribe pattern, where the message is sent to a <strong>Topic</strong></span>. <span>Applications don't connect to that topic directly, but they connect to the <strong>Subscription</strong>. The Subscription then connects to the Topic. These subscriptions can have filters that only subscribe to a subset of messages, named </span><strong>Filter Expressions</strong>.</li>
<li><strong>WCF Relays</strong>: <span>WCF Relays </span>offers a gateway to connect your on-premises WCF Services to Azure, without having to open a firewall connection on your network. Azure Relay Services has already been covered in detail in <a href="1563876d-91c8-4cbb-a73d-3cc436ac4acc.xhtml" target="_blank">Chapter 6</a>, <em>Connecting Hybrid Applications</em>.</li>
</ul>
<div class="packt_infobox">For an overview of examples of the capabilities of Azure Service Bus, you can refer to the following GitHub page: <a href="https://github.com/Azure/azure-service-bus/tree/master/samples">https://github.com/Azure/azure-service-bus/tree/master/samples</a>.</div>
<p>Across the different key capabilities, Azure Service Bus offers transaction capabilities. This offers the ability for all operations against messages to either succeed or fail.</p>
<p>Azure Service Bus offers the following tiers:</p>
<ul>
<li><strong>Basic</strong>: This offers Queues and scheduled messages. The message size can be up to 256 KB.</li>
<li><strong>Standard</strong>: On top of the Basic offering, the Standard tier offers Topics and Subscriptions; Transactions, Sessions, and De-duplication are included.</li>
<li><strong>Premium</strong>: On top of the Standard tier, the Premium tier offers a maximum message size of 1 MB.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Event Grid</h1>
                </header>
            
            <article>
                
<p>Azure Event Grid is a service in Azure that enables event management across different Azure resources. Instead of creating a polling mechanism in your application that polls for changes, the apps get notified when an event happens automatically.</p>
<p>Azure Event Grid offers throughput of millions of events per second and a 24-hour retrying mechanism. You can filter events based on publishing paths, so you can receive only the events that are relevant for your application or resource. Events can be created without using code and are named built-in events by configuring them in the Azure Portal. <span>You can create custom events as well, which can be created in your custom applications, PowerShell, or CLI.</span></p>
<p>Azure Event Grid offers the following built-in publishers: Azure Subscriptions, Event Hubs, Custom Topics, IoT Hub, Azure Resources Groups, Blob Storage, Service Bus, and V2 Storage accounts. For Event Handlers, Event Grid currently offers Webhooks, Azure Automation, Azure Functions, Logic Apps, Event Hubs, and Microsoft Flow:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1050 image-border" src="Images/ca4f1fbd-23f7-4c4c-a91e-136c6bc14f03.png" style="width:64.00em;height:36.75em;" width="1654" height="949"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Azure Event Grid</span></span></div>
<div class="packt_tip packt_infobox">New publishers and event handlers are added rapidly to Azure Event Grid, so keep an eye on <a href="https://docs.microsoft.com/en-us/azure/event-grid/overview">https://docs.microsoft.com/en-us/azure/event-grid/overview</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Routing Events with Azure Event Grid</h1>
                </header>
            
            <article>
                
<p>In this example, we are going to route events from Event Grid to an Azure Function.</p>
<p>First, we need to create a new Event Grid Topic in Azure. To create this, follow these steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span> <span>and type</span> <kbd>Event Grid Topic</kbd> <span>in the search bar. Create a new Event Grid Topic.</span></li>
<li><span>Enter the following settings and click on</span> <span class="packt_screen">OK</span><span>:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1051 image-border" src="Images/1188aeed-f9e1-4b80-93ec-562d56110eb0.png" style="width:25.25em;height:30.25em;" width="1149" height="1383"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating the Event Grid Topic</div>
<ol start="4">
<li>Next, create a new Azure Function with the following configurations:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1052 image-border" src="Images/2a937afc-6fde-423f-a0b5-a460e3c94aff.jpg" style="width:22.00em;height:49.50em;" width="623" height="1403"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating Azure Function</div>
<ol start="5">
<li>When the Azure Function is created, navigate to the settings and click on the Function file:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1054 image-border" src="Images/b57a125d-334a-4217-9448-284680818f9b.jpg" style="width:54.83em;height:33.92em;" width="1742" height="1081"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Selecting Azure Function file</div>
<ol start="6">
<li class="mce-root"><span>Click the</span> <span class="packt_screen">+</span> <span>button and select</span> <span class="packt_screen">Custom function</span><span>:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1056 image-border" src="Images/efdb1347-ebb5-4748-a1d0-2c69b995de2c.jpg" style="width:55.33em;height:33.92em;" width="1414" height="869"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating Custom Function</div>
<ol start="7">
<li class="mce-root"><span>In the next blade, scroll down and select</span> <span class="packt_screen">Event Grid trigger</span><span>:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1057 image-border" src="Images/ea20cb92-13c2-4163-afd6-f1860e64c547.png" style="width:55.67em;height:40.33em;" width="1265" height="1084"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Selecting the Event Grid trigger template</div>
<ol start="8">
<li>Add the following settings and click on <span class="packt_screen">Create</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1058 image-border" src="Images/c98c7464-051a-4b94-bfe2-31d567980b07.png" style="width:27.42em;height:44.08em;" width="673" height="1091"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating trigger</div>
<ol start="9">
<li class="mce-root"><span>When the trigger is created, the</span> <kbd>run.csx</kbd> <span>file is opened by default. Click on the</span> <span class="packt_screen">Add Event Grid subscription</span> <span>link</span> <span>in the top menu:</span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1060 image-border" src="Images/ab828ebb-ee7f-42db-9646-268b28e6d5b1.png" style="width:59.00em;height:36.17em;" width="1621" height="672"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Selecting Event Grid subscription</div>
<ol start="10">
<li>Name the Event Subscription and select the Event Grid, which we created earlier:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1061 image-border" src="Images/fadd670f-d483-4f2e-a58e-0cf09be0f1bc.jpg" style="width:30.58em;height:43.75em;" width="1160" height="1659"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Creating Event Subscription</div>
<ol start="11">
<li>Click on <span class="packt_screen">Create</span>; this will create a new event subscription that subscribes to the Event Grid Topic.</li>
<li class="mce-root"><span>Open PowerShell and run the following script from your desktop. This will create a custom event. You can check the Azure Function logs for the result:</span></li>
</ol>
<pre style="color: black;padding-left: 60px"><strong>Login-AzureRmAccount</strong><br/><strong>Select-AzureRmSubscription -SubscriptionId "********-****-****-****-***********"</strong><br/><br/><strong>$endpoint = (Get-AzureRmEventGridTopic -ResourceGroupName PacktEventGrid -Name PacktEventGridTopic).Endpoint</strong><br/><strong>$keys = Get-AzureRmEventGridTopicKey -ResourceGroupName PacktEventGrid -Name PacktEventGridTopic</strong><br/><br/><strong>$eventID = Get-Random 99999</strong><br/><br/><strong>#Date format should be SortableDateTimePattern (ISO 8601)</strong><br/><strong>$eventDate = Get-Date -Format s</strong><br/><br/><strong>#Construct body using Hashtable</strong><br/><strong>$htbody = @{</strong><br/><strong>    id= $eventID</strong><br/><strong>    eventType="recordInserted"</strong><br/><strong>    subject="myapp/packtpub/books"</strong><br/><strong>    eventTime= $eventDate </strong><br/><strong>    data= @{</strong><br/><strong>        title="Architecting Microsoft Solutions"</strong><br/><strong>        eventtype="Ebook"</strong><br/><strong>    }</strong><br/><strong>    dataVersion="1.0"</strong><br/><strong>}</strong><br/><br/><strong>#Use ConvertTo-Json to convert event body from Hashtable to JSON Object</strong><br/><strong>#Append square brackets to the converted JSON payload since they are expected in the event's JSON payload syntax</strong><br/><strong>$body = "["+(ConvertTo-Json $htbody)+"]"</strong><br/><br/><strong>Invoke-WebRequest -Uri $endpoint -Method POST -Body $body -Headers @{"aeg-sas-key" = $keys.Key1}</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Notification Hubs</h1>
                </header>
            
            <article>
                
<p>Notification Hubs in Azure offers a push notification service to send notifications from backends to mobile devices. Push notifications on mobile devices are usually displayed to a user in a <span>popup or a</span> dialog box. Users can then decide if they want to view or dismiss the message. <span>You can use push notifications for various scenarios, such as sending codes for MFA, sending notifications from social media, and sending news.</span></p>
<p>Notification Hubs offers cross-platform notifications by offering a set of SDKs and APIs for IoS, Android, and Windows devices. Normally, applications will use Platform Notification Systems (PNSes), which are dedicated infrastructure platforms. Apple has the <span>Apple Push Notification Service and Windows has the Windows Notification Service, for instance. Notification Hubs</span> removes all the complexity that comes with calling the different PNSes manually in your applications because it offers <span>platform independency by offering a single API,</span> massive scaling, various delivery patterns, rich telemetry, and more.</p>
<p>Notification Hubs offers the following tiers:</p>
<ul>
<li><strong>Free</strong>: This offers a maximum of 1 <span>million</span> push messages per month and 100 namespaces with 500 active devices per namespace and total 100 hubs.</li>
<li><strong>Basic</strong>: In addition to the Free tier, the Basic tier <span>offers a maximum of 10</span> <span>million</span> <span>push messages per month and 100 namespaces with 200,000 active devices per namespace. SLA is covered for this plan, and it also offers limited telemetry.</span></li>
<li><strong>Standard</strong>: <span>In addition to the Basic tier, the Standard tier</span> <span>offers</span> <span>a maximum of 10</span> <span>million</span> <span><span>push messages per month, unlimited namespaces with 10,000,000 active devices per namespace. It also offers rich telemetry, scheduled push capabilities, bulk import, and multitenancy.</span></span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Designing an effective messaging architecture</h1>
                </header>
            
            <article>
                
<p>Azure offers various features and capabilities in order to design and implement messaging solutions. In order to create successful application and solution architectures on the Azure platform, an effective messaging architecture is key. This will result in robust solutions and applications, that can fully benefit from the scaling capabilities that the Azure platform has to offer. It will also result in high performance for your applications and decoupled applications.</p>
<p>Throughout this book, multiple Azure resources are described and you should know by now what each resource is capable of. In the following section, some of them will be covered again from a messaging and integration perspective. This will give an overview and help you make the right decision when designing your messaging and IoT solutions on the Azure platform:</p>
<ul>
<li><strong>Azure Functions versus Logic Apps</strong>: You can think of Logic Apps as workflows that are triggered by an event and Azure Functions as code that is triggered by an event. So, when your solution requires custom code or custom transformations, choose Azure Functions. Use Logic Apps when your solution needs to connect to other SaaS solutions, such as Office 365, Azure Storage, and SalesForce. It offers a huge amount of connectors to connect using HTTPS out-of-the-box. Also, when a graphical editor is required, choose Logic Apps.</li>
<li><strong>Azure IoT Hub versus Azure Event Hubs</strong>: Azure IoT Hub offers two-way communication from devices to Azure and Azure to devices. It can process millions of events per second and supports multiple device protocols, such as <span>MQTT, MQTT over WebSockets, AMQP, AMQP over WebSockets, and HTTPS, MQTT, MQTT over WebSockets, AMQP, AMQP over WebSockets and file upload</span>. So, if your solution requires massive event processing and bi-directional communication, choose Azure IoT Hub. Event Hubs only allow one-way communication from devices to Azure. So, when your solution requires only data ingest, Event Hubs can be a more appropriate and cost-effective solution.</li>
<li><strong>Azure Service Bus versus Azure Storage Queues</strong>: Azure Service Bus is a brokering message solution at enterprise scale. It offers more enterprise messaging capabilities, such as transactions and sessions. It also provides support for bigger messages. Azure Service Bus supports messages up to 1 MB for the premium tier. Azure Queue Storage supports messages up to 64 KB.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered the different messaging solutions that Azure provides for various types of applications and solutions. You have also learned, when to use the right messaging solutions in your applications. This concludes the last chapter of the design solutions for platform services objective.</p>
<p>Next, we will look at the Design for Operations Objective, which will be the last objective of this book. It will start with the different application monitoring and alerting strategies.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book.</span></p>
<ol>
<li>You are designing a global mobile application for your organization that needs to process approximately <span>10</span> <span>million</span> <span>push messages per month</span>. Your administrators have a monitoring requirement. Is the Basic tier the appropriate tier for your application?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You are designing a serverless solution for your organization and need to call an external SDK in your solution for image processing. Is Azure Logic Apps the appropriate solution for this?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You are designing a messaging <span>solution for your organization and have a requirement for messages that are approximately 1 MB big. Should you use Azure Storage Queue for this solution?</span>
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><strong>Notification Hubs Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/notification-hubs/">https://docs.microsoft.com/en-us/azure/notification-hubs/</a></li>
<li><strong>Azure Event Grid Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/event-grid/">https://docs.microsoft.com/en-us/azure/event-grid/</a></li>
<li><strong>Azure Logic Apps Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/logic-apps/">https://docs.microsoft.com/en-us/azure/logic-apps/</a></li>
<li><strong>Get started with Azure Queue storage using .NET</strong>: <a href="https://docs.microsoft.com/en-us/azure/storage/queues/storage-dotnet-how-to-use-queues">https://docs.microsoft.com/en-us/azure/storage/queues/storage-dotnet-how-to-use-queues</a></li>
<li><strong>Add push notifications to your Android app</strong>: <a href="https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-android-get-started-push">https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-android-get-started-push</a></li>
<li><strong>Add Push Notifications to your iOS App</strong>: <a href="https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-ios-get-started-push">https://docs.microsoft.com/en-us/azure/app-service-mobile/app-service-mobile-ios-get-started-push</a></li>
<li><strong>Azure Logic Apps Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/logic-apps/">https://docs.microsoft.com/en-us/azure/logic-apps/</a></li>
<li><strong>Azure Functions Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/">https://docs.microsoft.com/en-us/azure/azure-functions</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>