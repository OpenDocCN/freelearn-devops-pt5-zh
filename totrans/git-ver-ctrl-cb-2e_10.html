<html><head></head><body>
        

                            
                    <h1 class="header-title">Patching and Offline Sharing</h1>
                
            
            
                
<p>n this chapter, we will cover the following recipes:</p>
<ul>
<li>Creating patches</li>
<li>Creating patches from branches</li>
<li>Applying patches</li>
<li>Sending patches</li>
<li>Creating Git bundles</li>
<li>Using a Git bundle</li>
<li>Creating archives from a tree</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>With the distributed nature of Git and the many existing hosting options available for it, it's very easy to share history between machines when they are connected through a network. In cases where the machines that need to share history are not connected or can't use the supported transport mechanisms, Git provides other methods to share history.</p>
<p>Git provides an easy way to format patches from existing history, sending them in an email and applying them to another repository. Git also has a bundle concept, where a bundle that contains only part of the history of a repository can be used as a remote for another repository. Finally, Git provides a simple and easy way to create an archive for a snapshot of the folder/subfolder structure of a given reference.</p>
<p>With the different methods provided by Git, it is easy to share history between repositories, especially where the normal push/pull methods are not available.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating patches</h1>
                
            
            
                
<p>In this recipe, we'll learn how to make patches out of commits. Patches can be sent via email for quick sharing or can be copied to sneakernet devices (USB sticks, memory cards, external hard disk drives, and so on) if they need to be applied to an offline computer or suchlike. Patches can be useful methods to review code, as the reviewer can apply a patch to their repository, investigate the difference, and check the program. If the reviewer decides that the patch is good, they can publish (<kbd>push</kbd>) it to a public repository, given that the reviewer is the maintainer of the repository. If the reviewer rejects the patch, they can simply reset their branch to the original state and inform the author of the patch that more work is needed before it can be accepted.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>In this example, we'll clone and use a new repository. The repository is just an example repository for Git commands and only contains some example commits:</p>
<pre><strong>$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git<br/></strong><strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing<br/></strong><strong>$ git checkout master</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>Let's see the history of the repository, as shown by <kbd>gitk</kbd>:</p>
<pre><strong>$ git log --graph --all --oneline<br/>*</strong> 4bc2b08 <strong>(master)</strong> Calculate pi with more digits<br/><strong>| *</strong> 971ac91 <strong>(doc)</strong> Adds Documentation folder<br/><strong>| *</strong> 2a0c8d6 Add build information<br/><strong>| *</strong> 9d00fcc Update readme<br/><strong>| | *</strong> 583225a <strong>(HEAD -&gt; develop)</strong> Adds functionality to prime-test a range of numbers<br/><strong>| | *</strong> f6c5713 Adds Makefile for easy building<br/><strong>| | *</strong> d00ffc0 Move print functionality of is_prime<br/><strong>| |/</strong><br/><strong>|/|</strong><br/><strong>* |</strong> 6e46ff8 Adds checker for prime number<br/><strong>|/</strong><br/><strong>*</strong> 8bddff2 Adds math, pi calculation<br/><strong>*</strong> 6de7cef Offline sharing, patch, bundle and archive</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>There are three branches in the repository: <kbd>master</kbd>, <kbd>develop</kbd>, and <kbd>doc</kbd>. All of them differ from the others by one or more commits. On the <kbd>master</kbd> branch, we can now create a patch file for the latest commit on the <kbd>master</kbd> branch and store it in the <kbd>latest-commit</kbd> folder, as shown in the following command:</p>
<pre><strong>$ git format-patch -1 -o latest-commit</strong>
<strong>latest-commit/0001-Calculate-pi-with-more-digits.patch</strong></pre>
<p>If we look at the file created by the <kbd>patch</kbd> command, we will see the following:</p>
<pre><strong>$ cat latest-commit/0001-Calculate-pi-with-more-digits.patch<br/><br/></strong><strong>From 4bc2b08517141c2b84ae76ccaab3a380c19de8a6 Mon Sep 17 00:00:00 2001</strong><br/><strong>From: John Doe &lt;john.doe@example.com&gt;</strong><br/><strong>Date: Thu, 10 Apr 2014 09:19:29 +0200</strong><br/><strong>Subject: [PATCH] Calculate pi with more digits</strong><br/><br/><strong>Dik T. Winter style</strong><br/><br/><strong>Build: gcc -Wall another_pi.c -o pi</strong><br/><strong>Run: ./pi</strong><br/><strong>---</strong><br/><strong> another_pi.c | 21 +++++++++++++++++++++</strong><br/><strong> 1 file changed, 21 insertions(+)</strong><br/><strong> create mode 100644 another_pi.c</strong><br/><br/><strong>$ diff --git a/another_pi.c b/another_pi.c</strong><br/><strong>new file mode 100644</strong><br/><strong>index 0000000..86df41b</strong><br/><strong>--- /dev/null</strong><br/><strong>+++ b/another_pi.c</strong><br/><strong>@@ -0,0 +1,21 @@</strong><br/><strong>+/* Pi with 800 digits</strong><br/><strong>+ * Dik T. Winter style, but modified sligthly</strong><br/><strong>+ * https://crypto.stanford.edu/pbc/notes/pi/code.html</strong><br/><strong>+ */</strong><br/><strong>+ #include &lt;stdio.h&gt;</strong><br/><strong>+</strong><br/><strong>+void another_pi (void) {</strong><br/><strong>  + printf("800 digits of pi:\n");</strong><br/><strong>  + int a=10000, b=0, c=2800, d=0, e=0, f[2801], g=0;</strong><br/><strong>  + for ( ;b-c; )f[b++]=a/5;</strong><br/><strong>  + for (;d=0,g=c*2;c-=14,printf("%.4d",e+d/a),e=d%a)</strong><br/><strong>  + for (b=c; d+=f[b]*a, f[b]=d%--g,d/=g--,--b; d*=b);</strong><br/><strong>  +</strong><br/><strong>  + printf("\n");</strong><br/><strong>+}</strong><br/><strong>+</strong><br/><strong>+int main (void){</strong><br/><strong>+ another_pi();</strong><br/><strong>+</strong><br/><strong>+ return 0;</strong><br/><strong>+}</strong><br/><strong>--</strong><br/><strong>2.14.0<br/></strong></pre>
<p>The previous snippet is the contents of the produced patch file. It contains a header much like an email with the <kbd>From</kbd>, <kbd>Date</kbd>, and <kbd>Subject</kbd> fields, a body with the commit message, and, after the three dashes (<kbd>---</kbd>), the actual patch, followed finally by two dashes (<kbd>--</kbd>),  and the Git version used to generate the patch. The patch generated by <kbd>git format-patch</kbd> is in the <strong>UNIX</strong> mailbox format, but with a magic fixed timestamp to identify that it comes from <kbd>git format-patch</kbd> rather than a real mailbox. You can see the timestamp in the first line after the <kbd>sha-1</kbd> ID Mon Sep 17 00:00:00 2001.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>When generating the patch, Git will <kbd>diff</kbd> the commit at <kbd>HEAD</kbd> with its parent commit and use this <kbd>diff</kbd> as the patch. The <kbd>-1</kbd> option tells Git to only generate patches for the last commit, and <kbd>-o latest-commit</kbd> tells Git to store the patch in the <kbd>latest-commit</kbd> folder. The folder will be created if it does not already exist.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>If you want to create patches for several commits, say the last three commits, you just pass on <kbd>-3</kbd> to <kbd>git format-patch</kbd> instead of <kbd>-1</kbd>.</p>
<p>Format the latest three commits as patches in the <kbd>latest-commits</kbd> folder:</p>
<pre><strong>$ git format-patch -3 -o latest-commits<br/></strong><strong>latest-commits/0001-Adds-math-pi-calculation.patch<br/></strong><strong>latest-commits/0002-Adds-checker-for-prime-number.patch<br/></strong><strong>latest-commits/0003-Calculate-pi-with-more-digits.patch<br/><br/></strong><strong>$ ls -1 latest-commits<br/></strong><strong>0001-Adds-math-pi-calculation.patch<br/></strong><strong>0002-Adds-checker-for-prime-number.patch<br/></strong><strong>0003-Calculate-pi-with-more-digits.patch</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating patches from branches</h1>
                
            
            
                
<p>Instead of counting the number of commits you need to make patches for, you can create patches by specifying the target branch when running the <kbd>format-patch</kbd> command.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll use the same repository as in the previous example:</p>
<pre><strong>$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git<br/></strong><strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing</strong></pre>
<p>Make sure we have the <kbd>develop</kbd> branch checked out:</p>
<pre><strong>$ git checkout develop</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>We'll pretend that we have been working on the <kbd>develop</kbd> branch and have made some commits. Now, we need to format patches for all those commits so that we can send them to the repository maintainer or carry them to another machine.</p>
<p>Let's see the commits on <kbd>develop</kbd>, not on <kbd>master</kbd>:</p>
<pre><strong>$ git log --oneline master..develop<br/></strong><strong>583225a (HEAD -&gt; develop) Adds functionality to prime-test a range of numbers</strong><br/><strong>f6c5713 Adds Makefile for easy building</strong><br/><strong>d00ffc0 Move print functionality of is_prime<br/></strong></pre>
<p>Now, instead of running <kbd>git format-patch -3</kbd> to get patches made for these three commits, we'll tell Git to create patches for all of the commits that are not on the <kbd>master</kbd> branch:</p>
<pre><strong>$ git format-patch -o not-on-master master<br/></strong><strong>not-on-master/0001-Move-print-functionality-of-is_prime.patch<br/></strong><strong>not-on-master/0002-Adds-Makefile-for-easy-building.patch<br/></strong><strong>not-on-master/0003-Adds-functionality-to-prime-test-a-range-of-numbers.patch</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>Git makes a list of commits from <kbd>develop</kbd> that are not on the <kbd>master</kbd> branch, much like we did before creating the patches, and makes patches for these. We can check the contents of the <kbd>not-on-master</kbd>folder, which we specified as the output folder (<kbd>-o</kbd>) and verify that it contains the patches as expected:</p>
<pre><strong>$ ls -1 not-on-master<br/></strong><strong>0001-Move-print-functionality-of-is_prime.patch<br/></strong><strong>0002-Adds-Makefile-for-easy-building.patch<br/></strong><strong>0003-Adds-functionality-to-prime-test-a-range-of-numbers.patch</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>The <kbd>git format-patch</kbd> command has many options besides the <kbd>-&lt;n&gt;</kbd> option to specify the number of commits in order to create patches for the <kbd>-o &lt;dir&gt;</kbd> for the target directory. Some useful options are as follows:</p>
<ul>
<li><kbd>-s</kbd>, <kbd>--signoff</kbd>: Adds a <kbd>Signed-off-by</kbd> line to the commit message in the patch file with the name of the committer. This is often required when mailing patches to the repository maintainers. This line is required for patches to be accepted when they are sent to the Linux kernel mailing list and the Git mailing list.</li>
<li><kbd>-n</kbd>, <kbd>--numbered</kbd>: Numbers the patch in the subject line as <kbd>[PATCH n/m]</kbd>.</li>
<li><kbd>--suffix=.&lt;sfx&gt;</kbd>: Sets the suffix of the patch; it can be empty and does not have to start with a dot.</li>
<li><kbd>-q</kbd>, <kbd>--quiet</kbd>: Suppresses the printing of patch filenames when generating patches.</li>
<li><kbd>--stdout</kbd>: Prints all commits to the standard output instead of creating files.</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Applying patches</h1>
                
            
            
                
<p>Now we know how to create patches from commits, it's time to learn how to apply them.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll use the repository from the previous examples, along with the generated patches, as follows:</p>
<p class="mce-root"/>
<pre><strong>$ cd Git-Version-Control-Cookbook-Second-Edition_offline-sharing </strong>
<strong>$ git checkout master</strong>
<strong>$ ls -1a</strong>
<strong>.</strong>
<strong>..</strong>
<strong>.git</strong>
<strong>Makefile</strong>
<strong>README.md</strong>
<strong>another_pi.c</strong>
<strong>latest-commit</strong>
<strong>math.c</strong>
<strong>not-on-master</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>First, we'll check out the <kbd>develop</kbd> branch and apply the patch generated from the <kbd>master</kbd> branch (<kbd>0001-Calculate-pi-with-more-digits.patch</kbd>) in the first example.</p>
<p>We use the Git <kbd>am</kbd> command to apply the patches; <kbd>am</kbd> is short for <kbd>apply from mailbox</kbd>:</p>
<pre><strong>$ git checkout develop</strong>
<strong>Your branch is up-to-date with 'origin/develop'.</strong>
<strong>$ git am latest-commit/0001-Calculate-pi-with-more-digits.patch</strong>
<strong>Applying: Adds functionality to prime-test a range of numbers</strong><br/><strong>error: patch failed: math.c:47</strong><br/><strong>error: math.c: patch does not apply</strong><br/><strong>Patch failed at 0001 Adds functionality to prime-test a range of numbers</strong><br/><strong>The copy of the patch that failed is found in: .git/rebase-apply/patch</strong><br/><strong>When you have resolved this problem, run "git am --continue".</strong><br/><strong>If you prefer to skip this patch, run "git am --skip" instead.</strong><br/><strong>To restore the original branch and stop patching, run "git am --abort".</strong></pre>
<p>We can resolve the conflict in line 47 (an empty line to be removed) and continue:</p>
<pre><strong>$ git add math.c</strong><br/><strong>$ git am --continue</strong><br/>Applying: Adds functionality to prime-test a range of numbers</pre>
<p>We can also apply the <kbd>master</kbd> branch to the series of patches that was generated from the <kbd>develop</kbd> branch, as follows:</p>
<pre><strong>$ git checkout master</strong>
<strong>Switched to branch 'master'</strong>
<strong>Your branch is up-to-date with 'origin/master'.</strong>
<strong>$ git am not-on-master/*</strong>
<strong>Applying: Move print functionality of is_prime</strong>
<strong>Applying: Adds Makefile for easy building</strong>
<strong>Applying: Adds functionality to prime-test a range of numbers</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The <kbd>git am</kbd> command takes the mailbox file specified in the input and applies the patch in the file to the files needed. Then, a commit is recorded using the commit message and author information from the patch. The committer identity of the commit will be the identity of the person performing the <kbd>git am</kbd> command. We can see the author and committer information with <kbd>git log</kbd>, but we need to pass the <kbd>--pretty=fuller</kbd> option to also view the committer information:</p>
<pre><strong>$ git log -1 --pretty=fuller</strong>
<strong>commit 45e49d0c4fcd44b73e11d61e025a62ab2655e42d (HEAD -&gt; master)</strong><br/><strong>Author: John Doe &lt;john.doe@example.com&gt;</strong><br/><strong>AuthorDate: Wed Apr 9 21:50:18 2014 +0200</strong><br/><strong>Commit: John Doe &lt;john.doe@example.com&gt;</strong><br/><strong>CommitDate: Sun Jun 3 21:58:46 2018 +0200</strong><br/><br/><strong>Adds functionality to prime-test a range of numbers<br/></strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>The <kbd>git am</kbd> command applies the patches in the files specified and records the commits in the repository. However, if you only want to apply the patch to the working tree or the staging area and not record a commit, you can use the <kbd>git apply</kbd> command.</p>
<p>We can try to apply the patch from the <kbd>master</kbd> branch to the <kbd>develop</kbd> branch once again; we just need to reset the <kbd>develop</kbd> branch first:</p>
<pre><strong>$ git checkout develop</strong>
<strong>Switched to branch 'develop'</strong>
<strong>Your branch is ahead of 'origin/develop' by 1 commit.</strong>
    <strong>  (use "git push" to publish your local commits)</strong>
<strong>$ git reset --hard origin/develop</strong>
<strong>HEAD is now at c131c8b Adds functionality to prime-test a range of numbers</strong>
<strong>$ git apply latest-commit/0001-Calculate-pi-with-more-digits.patch</strong></pre>
<p>We can check the state of the repository with the <kbd>status</kbd> command:</p>
<pre><strong>$ git status</strong>
<strong>On branch develop</strong>
<strong>Your branch is up-to-date with 'origin/develop'.</strong>
    
<strong>Untracked files:</strong>
  <strong>(use "git add &lt;file&gt;..." to include in what will be committed)</strong>
    
  <strong>another_pi.c</strong>
  <strong>latest-commit/</strong>
  <strong>not-on-master/</strong>
    
<strong>nothing added to commit but untracked files present (use "git add" to track)</strong></pre>
<p>We successfully applied the patch to the working tree. We can also apply it to the staging area and the working tree using the <kbd>--index</kbd> option, or only to the staging area using the <kbd>--cached</kbd> option.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Sending patches</h1>
                
            
            
                
<p>In the previous example, you saw how to create and apply patches. You can, of course, attach these patch files directly to an email, but Git provides a way to send patches directly as emails with the <kbd>git send-email</kbd> command. The command requires some setting up, but how you do that is heavily dependent on your general mail and SMTP configuration. A general guide can be found in the Git help pages or by visiting: <a href="http://git-scm.com/docs/git-send-email">http://git-scm.com/docs/git-send-email</a><a href="http://git-scm.com/docs/git-send-email">.</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll set up the same repository as in the previous example:</p>
<pre><strong>$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git</strong>
<strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>First, we'll send the same patch as the one we created in the first example. We'll send it to ourselves using the email address we specified in our Git configuration. Let's create the patch again with <kbd>git format-patch</kbd> and send it with <kbd>git send-email</kbd>:</p>
<pre><strong>$ git format-patch -1 -o latest-commit</strong>
<strong>latest-commit/0001-Calculate-pi-with-more-digits.patch</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p>Save the email address from the Git configuration to a variable as follows:</p>
<pre><strong>$ emailaddr=$(git config user.email)</strong></pre>
<p>Send the patch using the email address in both the <kbd>--to</kbd> and <kbd>--from</kbd> fields:</p>
<pre><strong>$ git send-email --to $emailaddr --from $emailaddr latest-commit/0001-Calculate-pi-with-more-digits.patch</strong>
<strong>latest-commit/0001-Calculate-pi-with-more-digits.patch</strong>
<strong>(mbox) Adding cc: John Doe &lt;john.doe@example.com&gt; from line 'From: John Doe &lt;john.doe@example.com&gt;'</strong>
  <strong>OK. Log says:</strong>
  <strong>Server: smtp.gmail.com</strong>
  <strong>MAIL FROM:&lt;john.doe@example.com&gt;</strong>
  <strong>RCPT TO:&lt;john.doe@example.com&gt;</strong>
  <strong>From: john.doe@example.com</strong>
  <strong>To: john.doe.example.com</strong>
  <strong>Subject: [PATCH] Calculate pi with more digits</strong>
  <strong>Date: Mon, 14 Apr 2014 09:00:11 +0200</strong>
  <strong>Message-Id: &lt;1397458811-13755-1-git-send-email-john.doe@example.com&gt;</strong>
  <strong>X-Mailer: git-send-email 1.9.1</strong> </pre>
<p>Checking your email will reveal a new email in your inbox.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>As we saw in the previous examples, <kbd>git format-patch</kbd> creates the patch files in the Unix mbox format, so only a little extra effort is required to allow Git to send the patch as an email. When sending emails with <kbd>git send-email</kbd>, make sure your <strong>Mail User Agent</strong> (<strong>MUA</strong>) does not break the lines in the patch files, replace tabs with spaces, and so on. You can test this easily by sending a patch to yourself and checking whether it can be applied cleanly to your repository.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>The <kbd>send-email</kbd> command can, of course, be used to send more than one patch at a time. If a directory is specified instead of a single patch file, all the patches in that directory will be sent. We don't even have to generate the patch files before sending them; we can just specify the same range of revisions we want to send as we would have specified for the <kbd>format-patch</kbd> command. Then, Git will create the patches on the fly and send them. When we send a series of patches this way, it is good practice to create a cover letter with a bit of explanation about the patch series that follows. A cover letter can be created by passing <kbd>--cover-letter</kbd> to the <kbd>send-email</kbd> command. We'll try sending patches for the commits on <kbd>develop</kbd>, since it is branched from <kbd>master</kbd> (the same patches as in the second example), as follows:</p>
<pre><strong>$ git checkout develop</strong>
<strong>Switched to branch 'develop'</strong>
<strong>Your branch is up-to-date with 'origin/develop'.</strong>
<strong>$ git send-email --to john.doe@example.com --from  <br/> john.doe@example.com --cover-letter --annotate origin/master</strong>
   <strong>/tmp/path/for/patches/0000-cover-letter.patch</strong>
   <strong>/tmp/path/for/patches/0001-Move-print-functionality-of-is_prime.patch</strong>
   <strong>/tmp/path/for/patches/0002-Adds-Makefile-for-easy-building.patch</strong>
   <strong>/tmp/path/for/patches/0003-Adds-functionality-to-prime-test-a-range-of-numbers.patch</strong>
   <strong>(mbox) Adding cc: John Doe &lt;john.doe@example.com&gt; from line 'From: John Doe &lt;john.doe@example.com&gt;'</strong>
   <strong>OK. Log says:</strong>
   <strong>Server: smtp.gmail.com</strong>
   <strong>MAIL FROM:&lt;john.doe@example.com&gt;</strong>
   <strong>RCPT TO:&lt;john.doe@exmample.com&gt;</strong>
   <strong>From: john.doe@example.com</strong>
   <strong>To: john.doe@example.com</strong>
   <strong>Subject: [PATCH 0/3] Cover Letter describing the patch series</strong>
   <strong>Date: Sat, 14 Jun 2014 23:35:14 +0200</strong>
   <strong>Message-Id: &lt;1397459884-13953-1-git-send-email-john.doe@example.com&gt;</strong>
   <strong>X-Mailer: git-send-email 1.9.1</strong>
   <strong>...</strong></pre>
<p>We can check our email inbox and see the four emails we sent: the cover letter and the three patches.</p>
<p class="mce-root"/>
<p>Before sending the patches, the cover letter is filled out and, by default, has <kbd>[PATCH 0/3] </kbd>(if sending three patches) in the subject line. A cover letter with only the default template subject and body won't be sent as default. In the scripts that come with this chapter, the <kbd>git send-email</kbd> command invokes the <kbd>--force</kbd> and <kbd>--confirm=never</kbd> options. This was done for script automation to force Git to send the mails even though the cover letter has not been changed from the default. You can try to remove these options, put in the <kbd>--annotate</kbd> option, and run the scripts again. You should then be able to edit the cover letter and emails that contain the patches before sending them.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating Git bundles</h1>
                
            
            
                
<p>Another method for sharing repository history between repositories is to use the <kbd>git bundle</kbd> command. A Git bundle is a series of commits that can work as a remote repository, but without having the full history of a repository included in the bundle.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll use a fresh clone of the <kbd>offline-sharing</kbd> repository, as follows:</p>
<pre><strong>$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git</strong>
<strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing<br/></strong><strong>$ git checkout master</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>First, we'll create a root bundle, as shown in the following command, so that the history in the bundle forms a complete history and the initial commit is also included:</p>
<pre><strong>$ git bundle create myrepo.bundle master</strong>
<strong>Counting objects: 12, done.</strong>
<strong>Delta compression using up to 8 threads.</strong>
<strong>Compressing objects: 100% (11/11), done.</strong>
<strong>Writing objects: 100% (12/12), 1.88 KiB | 0 bytes/s, done.</strong>
<strong>Total 12 (delta 1), reused 0 (delta 0)</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p class="mceNonEditable"/>
<p>We can verify the bundle content with <kbd>git bundle verify</kbd>:</p>
<pre><strong>$ git bundle verify myrepo.bundle</strong>
<strong>The bundle contains this ref:</strong>
<strong>1e42a2dfa3a377d412efd27a77b973c75935c62a refs/heads/master</strong>
<strong>The bundle records a complete history.</strong>
<strong>myrepo.bundle is okay</strong> </pre>
<p>To make it easy to remember which commit we included as the latest commit in the bundle, we create a <kbd>tag</kbd> that points to this commit; the commit is also pointed to by the <kbd>master</kbd> branch:</p>
<pre><strong>$ git tag bundleForOtherRepo master</strong></pre>
<p>We have created the root bundle that contains the initial commits of the repository history. We can now create a second bundle that contains the history from the tag we just created to the tip of the <kbd>develop</kbd> branch. Note that, in the following command, we use the same name for the bundle file, <kbd>myrepo.bundle</kbd>, and this will overwrite the old bundle file:</p>
<pre><strong>$ git bundle create myrepo.bundle bundleForOtherRepo..develop</strong>
<strong>Counting objects: 12, done.</strong>
<strong>Delta compression using up to 8 threads.</strong>
<strong>Compressing objects: 100% (9/9), done.</strong>
<strong>Writing objects: 100% (9/9), 1.47 KiB | 0 bytes/s, done.</strong>
<strong>Total 9 (delta 2), reused 0 (delta 0)</strong> </pre>
<p>It might seem strange to overwrite the bundle file just after creating it, but there is some sense in giving bundle files the same name. As you will also see in the next recipe, when using a bundle file, you add it to your repository as a remote, the URL being the file path of the bundle. The first time you do this is with the root bundle file and the URL. The file path of the bundle file will be stored as the URL of the remote repository. So, the next time you need to update the repository, you just overwrite the bundle file and perform <kbd>fetch</kbd> from the repository.</p>
<p>If we verify the bundle, we can see which commit needs to exist in the target repository before the bundle can be used:</p>
<pre><strong>$ git bundle verify myrepo.bundle</strong>
<strong>The bundle contains this ref:</strong>
<strong>c131c8bb2bf8254e46c013bfb33f4a61f9d4b40e refs/heads/develop</strong>
<strong>The bundle requires this ref:</strong>
<strong>ead7de45a504ee19cece26daf45d0184296f3fec</strong>
<strong>myrepo.bundle is okay</strong></pre>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p>We can check the history and see that the <kbd>ead7de4</kbd> commit is where <kbd>develop</kbd> is branched off, so it makes sense that this commit is the basis for the bundle we have just created:</p>
<pre><strong>$ gitk master develop</strong></pre>
<p>The previous command gives the following output:</p>
<div><img class="alignnone size-full wp-image-352 image-border" src="img/f99b9719-e249-4d17-99bd-cce29e881308.png" style="width:55.67em;height:14.58em;"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The <kbd>bundle</kbd> command creates a binary file with the history of the specified commit range included. When creating the bundle as a range of commits that do not include the initial commit in the repository (for example, <kbd>bundleForOtherRepo..develop</kbd>), it's important to make sure that the range matches the history in the repository in which the bundle is going to be used.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using a Git bundle</h1>
                
            
            
                
<p>In the last example, we saw how we could create bundles from the existing history, which contains a specified range of history. Now, we'll learn how to use these bundles either to create a new repository or to add a history to an existing one.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll use the same repository and methods as in the last example to create bundles, but we'll recreate them in this example to be able to use them one at a time. First, we'll prepare the repository and the first bundle, as shown in the following commands:</p>
<pre><strong>$ rm -rf offline-sharing</strong>
<strong>$ git clone https://github.com/PacktPublishing/</strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git<br/></strong><strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_offline-sharing</strong> <br/><strong>$ git checkout master</strong> <br/><strong>Branch master set up to track remote branch master from origin by rebasing.</strong> <br/><strong>Switched to a new branch 'master'</strong> <br/><strong>$ git bundle create myrepo.bundle master</strong> <br/><strong>Counting objects: 12, done.</strong> <br/><strong>Delta compression using up to 8 threads.</strong> <br/><strong>Compressing objects: 100% (11/11), done.</strong> <br/><strong>Writing objects: 100% (12/12), 1.88 KiB | 0 bytes/s, done.</strong> <strong>Total 12 (delta 1), reused 0 (delta 0) </strong> <br/><strong>$ git tag bundleForOtherRepo master</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>Now, let's create a new repository from the bundle file we just created. We can do that with the <kbd>git clone</kbd> command and by specifying the URL to the remote repository as the path to the bundle. We'll see how to do that in the following code snippet:</p>
<pre><strong>$ cd ..</strong>
<strong>$ git clone -b master Git-Version-Control-Cookbook-Second-Edition_offline-sharing/myrepo.bundle offline-other</strong>
<strong>Cloning into 'offline-other'...</strong>
<strong>Receiving objects: 100% (12/12), done.</strong>
<strong>Resolving deltas: 100% (1/1), done.</strong>
<strong>Checking connectivity... done.</strong></pre>
<p>The new repository is created in the <kbd>offline-other</kbd> folder. Let's check the history of that repository by using the following command:</p>
<pre><strong>$ cd offline-other</strong>
<strong>$ git log --oneline --decorate --all</strong>
<strong>1e42a2d (HEAD, origin/master, master) Calculate pi with more digits</strong>
<strong>ead7de4 Adds checker for prime number</strong>
<strong>337bfd0 Adds math, pi calculation</strong>
<strong>7229805 Offline sharing, patch, bundle and archive</strong></pre>
<p>The repository contains, as expected, all the history of the <kbd>master</kbd> branch in the original repository. We can now create a second bundle, the same as in the previous example, that contains history from the tag we created (<kbd>bundleForOtherRepo</kbd>) to the tip of the <kbd>develop</kbd> branch:</p>
<pre><strong>$ cd ..</strong>
<strong>$ cd Git-Version-Cookbook-Second-Edition_offline-sharing</strong>
<strong>$ git bundle create myrepo.bundle bundleForOtherRepo..develop</strong>
<strong>Counting objects: 12, done.</strong>
<strong>Delta compression using up to 8 threads.</strong>
<strong>Compressing objects: 100% (9/9), done.</strong>
<strong>Writing objects: 100% (9/9), 1.47 KiB | 0 bytes/s, done.</strong>
<strong>Total 9 (delta 2), reused 0 (delta 0)</strong>
<strong>$ git bundle verify myrepo.bundle</strong>
<strong>The bundle contains this ref:</strong>
<strong>c131c8bb2bf8254e46c013bfb33f4a61f9d4b40e refs/heads/develop</strong>
<strong>The bundle requires this ref:</strong>
<strong>ead7de45a504ee19cece26daf45d0184296f3fec</strong>
<strong>myrepo.bundle is okay</strong></pre>
<p>As we also saw in the previous example, the bundle requires the <kbd>ead7de45a504ee19cece26daf45d0184296f3fec</kbd> commit to already exist in the repository we'll use with the bundle. Let's check the repository we created from the first bundle for this commit by using the following command:</p>
<pre><strong>$ cd ..</strong>
<strong>$ cd offline-other</strong>
<strong>$ git show -s ead7de45a504ee19cece26daf45d0184296f3fec</strong>
<strong>  commit ead7de45a504ee19cece26daf45d0184296f3fec</strong>
<strong>  Author: John Doe &lt;john.doe@example.com&gt;</strong>
<strong>  Date:   Wed Apr 9 21:28:51 2014 +0200</strong>
    
  <strong>Adds checker for prime number</strong></pre>
<p>The commit exists. Now we can use the new bundle file as it has the same filename and path as the first bundle we created. We can just use <kbd>git fetch</kbd> in the <kbd>offline-other</kbd> repository as follows:</p>
<pre><strong>$ git fetch</strong>
  <strong>Receiving objects: 100% (9/9), done.</strong>
  <strong>Resolving deltas: 100% (2/2), done.</strong>
  <strong>From /path/to/repo/offline-sharing/myrepo.bundle</strong>
  <strong>* [new branch]      develop    -&gt; origin/develop</strong></pre>
<p>We can now <kbd>checkout develop</kbd>, and verify that the history for the <kbd>develop</kbd> and <kbd>master</kbd> branches matches the one in the original repository:</p>
<pre><strong>$ git checkout develop</strong>
  <strong>Branch develop set up to track remote branch develop from origin by rebasing.</strong>
  <strong>Switched to a new branch 'develop'</strong>
<strong>$ gitk --all</strong></pre>
<p>The previous command gives the following output:</p>
<div><img src="img/f262370a-2f5c-4afc-b0dd-0bc0e4b8497a.jpg"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>The bundle is useful for updating the history of repositories on machines where the normal transport mechanisms can't be used due to missing network connections between the machines, firewall rules, and so on. There are, of course, other methods than the Git bundle for transporting history to remote machines. A bare repository on a USB stick could also be used, or even plain patches can be applied to a repository. The advantage of the Git bundle is that you don't have to write the entire history to a bare repository each time you need to update a remote, but only the part of history that is missing.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating archives from a tree</h1>
                
            
            
                
<p>Sometimes, it's useful to have a snapshot of the directory structure, as specified by a particular commit, but without the corresponding history. This can, of course, be done by checking the particular commit followed by deleting/omitting the <kbd>.git</kbd> folder when creating an archive. But with Git, there is a better way to do this, which is built in so it is possible to create an archive from a particular commit or reference. When using Git to create the archive, you also make sure that the archive only contains the files tracked by Git and not any untracked files or folders you might have in your working directory.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We'll use the same <kbd>offline-sharing</kbd> repository as was used in the previous examples in this chapter:</p>
<pre><strong>$ git clone https://github.com/PacktPublishing/Git-Version-Control-Cookbook-Second-Edition_offline-sharing.git</strong>
<strong>$ cd </strong><strong>Git-Version-Control-Cookbook-Second-Edition_</strong><strong>offline-sharing</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>We'll start by creating an archive of the directory structure on the latest commit on the <kbd>master</kbd> branch. The <kbd>offline-sharing</kbd> repository is checked out on the <kbd>develop</kbd> branch by default, so we'll use the reference <kbd>origin/master</kbd> to specify the ref for the archive:</p>
<pre><strong>$ git archive --prefix=offline/ -o offline.zip origin/master</strong></pre>
<p>The <kbd>--prefix</kbd> option prepends the specified prefix to each file in the archive, effectively adding an <kbd>offline</kbd> directory as a root directory for the files in the repository, and the <kbd>-o</kbd> option tells Git to create the archive in the <kbd>offline.zip</kbd> file, which of course, is compressed in the ZIP format. We can investigate the ZIP archive to check whether the files contain the following:</p>
<pre><strong>$ unzip -l offline.zip</strong>
  <strong>Archive:  offline.zip</strong>
  <strong>1e42a2dfa3a377d412efd27a77b973c75935c62a</strong>
  <strong>  Length     Date   Time    Name</strong>
  <strong> --------    ----   ----    ----</strong>
  <strong>      0  04-10-14 09:19   offline/</strong>
  <strong>    162  04-10-14 09:19   offline/README.md</strong>
  <strong>    485  04-10-14 09:19   offline/another_pi.c</strong>
  <strong>    672  04-10-14 09:19   offline/math.c</strong>
  <strong> --------                   -------</strong>
   <strong>  1319                   4 files</strong></pre>
<p>If we look in the Git repository in the <kbd>origin/master</kbd> commit, we can see that the files are the same; the <kbd>-l</kbd> option tells Git to specify each file's size, as follows:</p>
<pre><strong>$ git ls-tree -l origin/master</strong>
<strong>100644 blob c79cad47938a25888a699142ab3cdf764dc99193 162    README.md</strong>
<strong>100644 blob 86df41b3a8bbfb588e57c7b27742cf312ab3a12a 485    another_pi.c</strong>
<strong>100644 blob d393b41eb14561e583f1b049db716e35cef326c3 672    math.c</strong></pre>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>The <kbd>archive</kbd> command can also be used to create an archive for a subdirectory of the repository. We can use this on the <kbd>doc</kbd> branch of the repository to ZIP the content of the <kbd>Documentation</kbd> folder:</p>
<pre><strong>$ git archive --prefix=docs/ -o docs.zip origin/doc:Documentation</strong></pre>
<p>Again, we can list the contents of the ZIP file and the <kbd>Documentation</kbd> tree at <kbd>origin/doc</kbd>, as follows:</p>
<pre><strong>$ unzip -l docs.zip</strong>
  <strong>Archive:  docs.zip</strong>
  <strong> Length     Date   Time    Name</strong>
  <strong>--------    ----   ----    ----</strong>
  <strong>      0  04-13-14 21:14   docs/</strong>
  <strong>     99  04-13-14 21:14   docs/README.md</strong>
  <strong>    152  04-13-14 21:14   docs/build.md</strong>
  <strong>--------                   -------</strong>
  <strong>    251                   3 files</strong>
  <strong>$ git ls-tree -l origin/doc:Documentation</strong>
  <strong>100644 blob b65b4fc78c0e39b3ff8ea549b7430654d413159f 99  README.md</strong>
  <strong>100644 blob f91777f3e600db73c3ee7b05ea1b7d42efde8881 152  build.md</strong></pre>
<p>There are other format options besides the ZIP format for the archive, for example, <kbd>tar</kbd>, <kbd>tar.gz</kbd>, and so on. The format can be specified with the <kbd>--format=&lt;format&gt;</kbd> option or as a suffix to the output filename with the <kbd>-o</kbd> option. The following two commands will produce the same output file:</p>
<pre><strong>$ git archive --format=tar.gz HEAD &gt; offline.tar.gz</strong>
<strong>$ git archive -o offline.tar.gz HEAD</strong></pre>
<p class="mce-root"/>
<p class="mce-root"/>
<p>The Git archive command behaves a bit differently if a commit/tag ID or a tree ID is passed as an identifier. If a commit or tag ID is given, the ID will be stored in a global extended pax header for the TAR format, and as a file comment for the ZIP format. If only the tree ID is given, no extra information will be stored. You can actually see this in the previous examples, where the first ID was given a branch as a reference. As the branch points to a commit, the ID of this commit was written as a comment on the file and we can actually see it in the output of the archive listing:</p>
<pre><strong>$ unzip -l offline.zip</strong>
  <strong>Archive:  offline.zip</strong>
  <strong>1e42a2dfa3a377d412efd27a77b973c75935c62a</strong>
  <strong>  Length     Date   Time    Name</strong>
  <strong> --------    ----   ----    ----</strong>
 <strong>        0  04-10-14 09:19   offline/</strong>
 <strong>      162  04-10-14 09:19   offline/README.md</strong>
 <strong>      485  04-10-14 09:19   offline/another_pi.c</strong>
 <strong>      672  04-10-14 09:19   offline/math.c</strong>
  <strong> --------                   -------</strong>
 <strong>     1319                   4 files</strong> </pre>
<p>In the second example, we also passed a branch as a reference, but furthermore, we specified the <kbd>Documentation</kbd> folder as the subfolder we wanted to create an archive from. This corresponds to passing the ID of the tree to the archive command; hence, no extra information will be stored in the archive.</p>


            

            
        
    </body></html>