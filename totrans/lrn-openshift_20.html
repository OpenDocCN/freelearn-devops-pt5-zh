<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Network Design for OpenShift HA</h1>
                
            
            <article>
                
<p class="calibre2">In the previous chapter, <span class="calibre11">we talked about OpenShift</span> <span class="calibre11">scenarios in single and multiple data centers and explained how to properly design OpenShift in a</span><span class="calibre11"> </span><span class="calibre11">distributed</span><span class="calibre11"> and redundant </span><span class="calibre11">configuration across one or more data centers</span>.  </p>
<p class="calibre2">In this chapter, we are going to cover the main network aspects while designing OpenShift clusters in one or across multiple data centers. We will also cover commonly made mistakes, solutions, and overall guidance from a networking point of view.</p>
<p class="calibre2"/>
<p class="calibre2"><span class="calibre11">After reading this chapter, you will have an understanding of the following topics:</span></p>
<ul class="calibre9">
<li class="calibre10">Common network topologies for OpenShift deployments </li>
<li class="calibre10">Commonly made mistakes while designing networks for OpenShift</li>
<li class="calibre10">General network requirements and design guidelines for OpenShift deployments</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Common network topologies for OpenShift deployments</h1>
                
            
            <article>
                
<p class="calibre2">Though each and every network infrastructure is unique in one way or other, all of these networks have a lot in common and can be split into two different types:</p>
<ul class="calibre9">
<li class="calibre10">Physical or data center networks</li>
<li class="calibre10">Virtual or cloud networks</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Data center networks</h1>
                
            
            <article>
                
<p class="calibre2">Most of the physical and data center networks have a similar structures and components, such as the following:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Core/spine layer switches</strong>: To interconnect different parts of the network, including aggregation/leaf switches, as well as, edge of the network and/or even Data Center Interconnect links</li>
<li class="calibre10"><strong class="calibre1">Access/leaf switches</strong>: To connect physical servers to the revenue-generating network </li>
<li class="calibre10"><strong class="calibre1">Edge firewalls</strong>: To filter the external traffic to the inside of the network</li>
<li class="calibre10"><strong class="calibre1">Border routers</strong>: To connect to the internet or any other external network</li>
<li class="calibre10"><strong class="calibre1">Load balancers</strong>: To load balance the incoming traffic between groups of application servers</li>
</ul>
<p class="calibre2">This is depicted on the following diagram:</p>
<p class="cdpaligncenter"><img class="alignnone80" src="../images/00104.jpeg"/></p>
<p class="calibre2">Some of these components can be collapsed, such as firewalls and border routers. Some components are optional, such as load balancers. There may be additional components, but these are the essential building blocks for every data center.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Access layer switches</h1>
                
            
            <article>
                
<p class="calibre2">The Network Access Layer is an essential but critical network component that usually has several features configured, such as:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1"><span>Multi-Chassis Link Aggregation (</span>MC-LAG)</strong>:<strong class="calibre1"> </strong>Allows server links to be connected to different access layer switches with bonding enabled in active/active mode</li>
<li class="calibre10"><strong class="calibre1">Virtual LAN (VLAN)</strong>: A very old but solid technology that separates one broadcast domain from another</li>
<li class="calibre10"><strong class="calibre1">L3 gateway</strong>: An IP Gateway to allow VLAN traffic in and out</li>
<li class="calibre10"><strong class="calibre1">Dynamic routing protocol</strong>: <strong class="calibre1">Interior </strong><span><strong class="calibre1">Gateway Protocol</strong> (<strong class="calibre1">IGP</strong>)</span>/<strong class="calibre1">Border Gateway Protocol</strong> (<strong class="calibre1"><span>BGP</span></strong>) allows server IP addresses/subnets to be exchanged dynamically and failover from one <span>transit link</span> to another without any downtime</li>
<li class="calibre10"><strong class="calibre1">Control Plane Policing<span><strong class="calibre1"> </strong>(</span>CoPP)</strong>:<strong class="calibre1"> </strong>This is a common way to protect management access to/from the equipment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Core layer switches</h1>
                
            
            <article>
                
<p class="calibre2">The network core layer is the heart of the network of all other data center components and has a very limited number of features configured, such as the following:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Dynamic routing protocol</strong>: <span>I</span><span>GP/BGP </span>allows server IP addresses/subnets to be exchanged dynamically and failover from one transit link to another without any downtime</li>
<li class="calibre10"><strong class="calibre1">CoPP</strong>: This is a common way to protect management access to/from the equipment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Edge firewalls</h1>
                
            
            <article>
                
<p class="calibre2">Edge firewalls are a first-level defense against attacks from the internet. Edge firewalls also logically separate different network segments from one another and usually have the following features enabled:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Stateful inspection</strong>: Keeps track of the traffic coming in and out, dynamically opening and closing requested ports to the servers inside the data center</li>
<li class="calibre10"><strong class="calibre1">Application firewall</strong>: Allows you to dynamically identify the application by checking application signatures and take a proper action, such as permit or deny</li>
<li class="calibre10"><strong class="calibre1">Distributed denial-of-service (DDoS) protection</strong>: Identifies and blocks malicious traffic while enabling legitimate traffic to be processed and reached out to by the applications running inside the data center</li>
<li class="calibre10"><strong class="calibre1">Intrusion Prevention System (IPS) and Intrusion Detection System (IDS)</strong>: These p<span>rovide protection techniques against exploit attacks regarding data center applications, using their vulnerabilities</span></li>
<li class="calibre10"><strong class="calibre1">Network Address Translation (NAT)</strong>: NAT allows hosts inside the data center network to access the internet by changing the source IP address to a publicly available IP address</li>
<li class="calibre10"><strong class="calibre1">CoPP</strong>: This is a common way to protect management access to/from the equipment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Load balancers</h1>
                
            
            <article>
                
<p class="calibre2">Load balancers are one of the optional network components that have additional features that keep track of application availability and dynamically load balance the requests from the internet <span class="calibre11">across the servers inside the data center. Load balancers have a specific set of</span> features configured, such as the following:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Destination Network Address Translation (DNAT)</strong>: DNAT allows hosts from the outside of the data center network to access the servers inside the data center network by changing the destination IP address from a publicly available IP address to a private IP address of an appropriate server from the pool</li>
<li class="calibre10"><strong class="calibre1">Load balancing</strong>: Works in conjunction with DNAT to dynamically track application availability and dynamically remove servers from the server groups</li>
<li class="calibre10"><strong class="calibre1">SSL offloading</strong>: Takes care of web traffic encryption/decryption going to/from unsecured networks by terminating SSL traffic on the load balancer</li>
<li class="calibre10"><strong class="calibre1">CoPP</strong>: This is a common way to protect management access to/from the equipment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Border routers</h1>
                
            
            <article>
                
<p class="calibre2">A border router is a point of communication between the data center network and the internet, and has a very limited number of features configured, such as the following:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Dynamic Routing Protocol</strong>: <span>BGP</span> holds the whole internet-routing table to calculate the optimal path to the final destination as well as advertise the data center public IP address pool to the internet</li>
<li class="calibre10"><strong class="calibre1">CoPP</strong>: This is a common way to protect management access to/from the equipment</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Cloud networks</h1>
                
            
            <article>
                
<p class="calibre2">Similar to physical and data center networks, cloud networks have their own structure and components, such as the following:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Software-Defined Networking (SDN)</strong>: SDN replaces traditional network architectures by implementing networks on demand by using popular SDN transport and encapsulation protocols</li>
<li class="calibre10"><strong class="calibre1">Security groups</strong>: Flexible and programmable firewall filters that allow traffic control at scale, avoiding a single point of failure</li>
<li class="calibre10"><strong class="calibre1">NAT gateways</strong>: To efficiently route traffic in and out of the cloud network, providing NAT services when necessary </li>
<li class="calibre10"><strong class="calibre1">Load balancers</strong>: To load balance the incoming traffic <span>between groups of application servers</span></li>
</ul>
<p class="calibre2">Though different cloud providers use different protocols and implementations of one or another component, the main functionality stays the same and works similarly from one cloud provider to another:</p>
<p class="cdpaligncenter"><img class="alignnone81" src="../images/00105.jpeg"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">SDN</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre11">SDN allows applications to be abstracted and completely independent of underlying network implementations by using modern and popular communication and transport protocols, such as the following:</span></p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">OpenFlow</strong>: This is a protocol that allows access to the forwarding plane of a network switch or router over the network. OpenFlow <span>allows network controllers to calculate a packet path across the network.</span> Many products and companies are using OpenFlow to build their SDN networks, including OpenStack. OpenFlow is supported by leading network manufacturers, including Cisco Systems, Juniper Networks, Alcatel-Lucent, Dell, Arista, and others.</li>
<li class="calibre10"><strong class="calibre1">Virtual Extensible LAN (VXLAN)</strong>: This is an encapsulation protocol that allows running an overlay network on existing routing networks. VXLAN is one of the most popular protocols that is being used to interconnect different network segments of SDN into a single solution.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Security groups</h1>
                
            
            <article>
                
<p class="calibre2">Security groups are the main security method for controlling the traffic going in and out of <strong class="calibre4">Virtual Machines</strong> (<strong class="calibre4">VMs</strong>) that are running applications, and they have one main function—<strong class="calibre4">stateful inspection</strong>. This keeps track of the traffic going in and out, dynamically opening and closing requested ports to the applications inside the VMs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Load balancers</h1>
                
            
            <article>
                
<p class="calibre2">If data center networks quite often use physical load balancers, then cloud networks tend to use software load balancers, providing the same functionaly at a high level, including DNAT, load balancing, and even SSL offloading.</p>
<p class="calibre2">So, the power of cloud networks must not be underestimated.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Network Address Translation (NAT) gateways</h1>
                
            
            <article>
                
<p class="calibre2">A NAT gateway is a point of communication between applications inside a cloud provider and the internet, and has a very limited number of features configured, such as—NAT.<strong class="calibre4"> </strong>This allows hosts inside the data center network to access the internet by changing the source IP address to a publicly available IP address.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Commonly made mistakes while designing networks for OpenShift</h1>
                
            
            <article>
                
<p class="calibre2">While network design is generally simple, there are many ways to make a mistake that will make the whole network a single point of failure. The most commonly made mistakes are as follows:</p>
<ul class="calibre9">
<li class="calibre10">On access and core network layers, people often use static <strong class="calibre1">Link Aggregation</strong> (<strong class="calibre1">LAG</strong>) methods instead of dynamic link control, such as <strong class="calibre1">Link Aggregation Control Protocol</strong> (<strong class="calibre1">LACP</strong>) 802.3ad. MTU values are not properly set throughout the network and <span>CoPP filters block protocol communication between networking equipment, which causes failover not to work in case of a failure.</span></li>
<li class="calibre10">When using load balancers, quite often active/passive deployments cannot failover properly from one node to the other. This is usually caused by inconsistent configuration between load balancer cluster nodes.</li>
<li class="calibre10">Firewalls and security groups are quite often a bottleneck, and <span>a single firewall cluster consisting of two and more nodes can be a single point of failure if a single control plane is used. We have seen</span> stateless filters used instead of stateful filters, which causes bidirectional traffic to be blocked. And finally, when failover  preemption is used, it causes the firewall cluster to flap indefinitely.</li>
<li class="calibre10">On border routers, having one of several full internet-routing tables takes a lot of time for BGP to reconverge, which often causes traffic to be blackholed. The only default gateway causes BGP to not take the most optimal route and the <strong class="calibre1">Equal-Cost Multi-Path</strong> (<strong class="calibre1">ECMP</strong>) causes asymmetric routing and packet loss.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">General network requirements and design guidelines for OpenShift deployments</h1>
                
            
            <article>
                
<p class="calibre2">The network is a critical component for OpenShift because every piece of OpenShift solution is dependent on network availability, performance, scalability, and stability. Both control and data plane traffic uses different parts of the network to talk to one another. In order to make OpenShift solutions available most of the time and to avoid unplanned network outages, several things have to be considered:</p>
<ul class="calibre9">
<li class="calibre10">All the physical hosts running OpenShift require having redundant physical connectivity to access-level switches using MC-LAG or a similar technology</li>
<li class="calibre10">A set of load balancers implemented in a redundant fashion with separate data and control planes</li>
<li class="calibre10">A set of firewalls implemented in a redundant fashion with separate data and control planes</li>
<li class="calibre10">A dedicated management network to be used where applicable for security reasons</li>
<li class="calibre10">VIP with <strong class="calibre1">keepalived</strong> is implemented if no external load balancer is used on both infrastructure nodes and the upstream network has no single point of failure</li>
<li class="calibre10">AnyCast IPs if several Data Centers</li>
<li class="calibre10">Network convergence is taken care of by additional mechanisms such as <strong class="calibre1"><span>Bidirectional Forwarding Detection</span></strong> (<strong class="calibre1">BFD</strong>), additional tuning settings such as PortFast in the case of the <strong class="calibre1">Spanning Tree Protocol</strong> (<strong class="calibre1">STP</strong>), and tuning protocol timers in routing protocols</li>
<li class="calibre10">The MTU parameter is properly set on OpenShift nodes and aligned with the network to make sure that no packet fragmentation is happening</li>
<li class="calibre10">Proper ports are opened for the communication to and from any OpenShift component if isolated with a firewall or any type of <strong class="calibre1">Access Control List</strong> (<strong class="calibre1">ACL</strong>) on a network device</li>
</ul>
<p class="calibre2">Taking in mind all of the preceding considerations will help you avoid 99% of all the issues that you may face while designing your OpenShift cluster.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we covered the main network aspects while designing an OpenShift cluster in one or across multiple data centers. We also discussed commonly made mistakes, solutions, and overall guidance from a networking point of view.</p>
<p class="calibre2">In the next chapter, we are going to give a brief overview of new OpenShift 3.9 features that we have and have not covered in this book. We are going to briefly discuss what to expect from the following OpenShift releases later this year (2018).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<ol class="calibre13">
<li value="1" class="calibre10">Which network component in the standard data center deployment is optional?<span> </span>choose one:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">Firewall</li>
<li value="2" class="calibre10">Load balancer</li>
<li value="3" class="calibre10">Core switch</li>
<li value="4" class="calibre10">Border router</li>
</ol>
</li>
</ul>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">What are the two commonly made mistakes on a firewall? choose two:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">Failover preemption</li>
<li value="2" class="calibre10">Stateless filters</li>
<li value="3" class="calibre10">Stateful filters</li>
<li value="4" class="calibre10">Having one or several full internet tables</li>
</ol>
</li>
</ul>
<ol start="3" class="calibre13">
<li value="3" class="calibre10"> Physical data center and cloud networks have exactly the same components:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">True</li>
<li value="2" class="calibre10">False</li>
</ol>
</li>
</ul>
<ol start="4" class="calibre13">
<li class="calibre10" value="4">What command can be used to backup and restore application data in OpenShift? choose one: </li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10"><strong class="calibre1"><kbd class="calibre12">oc<span> </span>rsync</kbd></strong></li>
<li value="2" class="calibre10"><kbd class="calibre12">oc backup</kbd></li>
<li value="3" class="calibre10"><kbd class="calibre12">oc save</kbd></li>
<li value="4" class="calibre10"><kbd class="calibre12">oc load </kbd></li>
</ol>
</li>
</ul>
<ol start="5" class="calibre13">
<li class="calibre10" value="5">Which network component is responsible for letting the application out to the internet in cloud networks? choose one:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">Load balancer</li>
<li value="2" class="calibre10">NAT gateway</li>
<li value="3" class="calibre10">Border router</li>
<li value="4" class="calibre10">Edge Firewall</li>
</ol>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Further reading</h1>
                
            
            <article>
                
<p class="calibre2">Here is a list of topics with links related to this chapter that you might want to deep dive into:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Network Design and Architecture Center: Data Center Networks at</strong> <span><a href="https://www.juniper.net/documentation/en_US/design-and-architecture/data-center/" target="_blank" class="calibre8">https://www.juniper.net/documentation/en_US/design-and-architecture/data-center/</a>.</span></li>
<li class="calibre10"><strong class="calibre1">AWS Single VPC Design at </strong><a href="https://aws.amazon.com/answers/networking/aws-single-vpc-design/" target="_blank" class="calibre8">https://aws.amazon.com/answers/networking/aws-single-vpc-design/</a>.</li>
</ul>


            </article>

            
        </section>
    </body></html>