<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Building Lambda Functions Using AWS CloudFormation</h1>
                
            
            <article>
                
<p class="calibre2">A serverless solution is a problem-solving technique to address issues regarding dynamic infrastructure. In this chapter, we'll explore how to use AWS Lambda to apply a serverless solution. We will <span class="calibre7">build an</span> AWS Lambda through the use of AWS CloudFormation.</p>
<p class="calibre2">The following topics will be covered in this chapter:</p>
<ul class="calibre11">
<li class="calibre12">Introducing AWS Lambda</li>
<li class="calibre12">Building AWS Lambda</li>
<li class="calibre12">Creating a CloudFormation template for AWS Lambda functions</li>
<li class="calibre12">Deploying AWS Lambda through CloudFormation</li>
<li class="calibre12"><span>Deploying</span> AWS Lambda and DynamoDB with <span>CloudFormation</span></li>
<li class="calibre12"><span>Deploying</span> AWS Lambda to specific regions through <span>CloudFormation</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introducing AWS Lambda</h1>
                
            
            <article>
                
<p class="calibre2">AWS Lambda is an AWS service that provides a serverless compute service. We can build functions with various programming languages, then AWS Lambda will take care of our infrastructure and its scaling.</p>
<p class="calibre2">We can access other AWS resources from Lambda function. In the following diagram, you can see how a Lambda function accesses AWS resources. Client apps, such as on browser, mobile, or CLI, can invoke our Lambda functions:</p>
<div class="cdpaligncenter"><img src="../images/00108.jpeg" class="calibre23"/></div>
<div class="packt_figref">Figure 5.1: Lambda functions in an internet environment</div>
<p class="calibre2">In this chapter, we'll explore Lambda functions with CloudFormation. We'll also combine other AWS resources inside the Lambda function.</p>
<p class="calibre2">Next, we'll build a simple Lambda function in order to understand how the Lambda function works.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Building AWS Lambda </h1>
                
            
            <article>
                
<p class="calibre2">Before we build AWS Lambda through CloudFormation, we'll develop the AWS Lambda application. The objective is to understand AWS Lambda development, especially for readers with no experience of AWS Lambda.</p>
<p class="calibre2">AWS Lambda works in various AWS regions. Visit the AWS Lambda Management Console at <a href="https://console.aws.amazon.com/lambda/" target="_blank" class="calibre10">https://console.aws.amazon.com/lambda/</a>.  A sample of the AWS <span class="calibre7">Lambda</span> Management Console window can be seen in <em class="calibre17">Figure 5.2</em>. Then, select your region for AWS Lambda development.</p>
<p class="calibre2">For testing, we build a simple AWS Lambda application. We use Node.js for the Lambda function. To implement the AWS Lambda function, we do the following three tasks:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Creating the IAM role</li>
<li value="2" class="calibre12">Developing the AWS Lambda function</li>
<li value="3" class="calibre12">Testing AWS Lambda</li>
</ol>
<p class="calibre2">These steps will be followed in the next sections. The <span class="calibre7">AWS Lambda Management Console is shown as follows:</span></p>
<div class="cdpaligncenter"><img class="alignnone57" src="../images/00109.jpeg"/></div>
<div class="packt_figref">Figure 5.2: <span>AWS Lambda Management Console</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the IAM role</h1>
                
            
            <article>
                
<p class="calibre2">Amazon AWS applies security policies on AWS resources. To access the AWS Lambda resources, we should apply a policy in order to create and execute AWS Lambda. In this section, we create a role on IAM roles section.</p>
<p class="calibre2">To create an IAM role, we can follow these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open a browser and navigate to <a href="https://console.aws.amazon.com/iam/" target="_blank" class="calibre10">https://console.aws.amazon.com/iam/</a>.</li>
<li value="2" class="calibre12">Open a list of IAM roles by clicking on the <span>Roles</span> menu; you should see the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone58" src="../images/00110.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.3: </span><span>AWS IAM Management Console</span></div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">To create a role, click on the <span>Create role</span> button to get the screen shown in the <em class="calibre24">Figure 5.4.</em></li>
<li value="4" class="calibre12">Select the <span>Lambda</span> option for the AWS service and then click on the <span>Next: Permissions</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone59" src="../images/00111.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.4: </span><span>Selecting a trusted entity</span></div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">After you click the button, you should get the screenshot shown in <em class="calibre24">Figure 5.5. </em>You will be asked to select permission policies.</li>
<li value="6" class="calibre12">Select the <span>AWSLambdaFullAccess</span> policy for full access to AWS Lambda resources and then click on the <span>Next: Review</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone60" src="../images/00112.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.5: </span><span>Attaching permission policies on the IAM role</span></div>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">You get a review screen, which is shown in <em class="calibre24">Figure 5.6. </em>Review your input.</li>
<li value="8" class="calibre12">Fill in your new role, for instance, <kbd class="calibre13">my-simple-lambda-role</kbd>. Once done, click on the <span>Create role</span> button to create the IAM role:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone61" src="../images/00113.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.6: </span><span>Reviewing the created role</span></div>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">Once done, you can check your new role on IAM Roles. For instance, here is my IAM role, <kbd class="calibre13">my-simple-lambda-role</kbd>:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone62" src="../images/00114.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.7: </span><span>A list of IAM roles on IAM Management Console</span></div>
<p class="calibre2">You have successfully created an IAM role. In the next section, you will develop AWS Lambda.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Developing AWS Lambda using Web Management Console (WMC)</h1>
                
            
            <article>
                
<p class="calibre2">We have created an IAM role that will be applied on AWS Lambda. In this section, we'll develop a simple AWS Lambda function. We use the Node.js application. We receive a message input, <kbd class="calibre13">msg</kbd>, and then send it to the caller.</p>
<p class="calibre2">Execute the following steps to develop the AWS Lambda function:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to the AWS Lambda Management Console at <a href="https://console.aws.amazon.com/lambda/" target="_blank" class="calibre10">https://console.aws.amazon.com/lambda/</a>.</li>
<li value="2" class="calibre12">Click on the <span>Create function</span> button to create a new Lambda function. Once done, you will get the following screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone63" src="../images/00115.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.8: Creating AWS Lambda</span></div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Fill the the Lambda function name, for instance, <kbd class="calibre13">my-simple-lambda</kbd>.</li>
<li value="4" class="calibre12">Select Node.js from <span>Runtime</span> drop-down. In this demo, I use <span>Node.js 6.10</span>. You can use the latest Node.js version.</li>
<li value="5" class="calibre12">In the <span>Role</span> drop-down, select the <span>Choose an existing role</span> option, then select the IAM role you created.</li>
<li value="6" class="calibre12">Once done, click on the <span>Create function</span> button to create your Lambda function.</li>
<li value="7" class="calibre12">You should get a Lambda function with a web editor, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone64" src="../images/00116.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.9: </span><span>Writing code for Lambda function</span></div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">We write our Node.js program inside the web editor. Write the following scripts:</li>
</ol>
<pre class="calibre26">exports.handler = (event, context, callback) =&gt; {<br class="title-page-name"/>    var data = event['msg'];<br class="title-page-name"/>    callback(null, 'Received: ' + data);<br class="title-page-name"/>};</pre>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">Save your function by clicking on the <span>Save</span> button and then publish your Lambda function.</li>
<li value="10" class="calibre12">Click on <span>Publish new version</span> on the <span>Actions</span> drop-down list. You will be asked to fill in a version description, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00117.jpeg" class="calibre23"/></div>
<div class="packt_figref"><span>Figure 5.10: </span><span>Providing a release note on publishing AWS Lambda</span></div>
<p class="calibre2">Now, your AWS Lambda has been published. Next, we'll test our AWS Lambda.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Testing AWS Lambda</h1>
                
            
            <article>
                
<p class="calibre2">In the previous section, we created and published AWS Lambda using WMC. In this section, we will perform testing for our AWS Lambda function. We are going to test with two methods:</p>
<ul class="calibre11">
<li class="calibre12">A test-event tool from AWS Lambda Management Console</li>
<li class="calibre12">The AWS CLI</li>
</ul>
<p class="calibre2">The first approach is to use <span class="calibre7">AWS Lambda Management Console. Follow these steps:</span></p>
<ol class="calibre14">
<li value="1" class="calibre12"><span>Open your browser and navigate to <span>AWS Lambda Management Console.</span></span></li>
<li value="2" class="calibre12"><span>Open your Lambda function, then click on the </span><span>Test</span> <span>button (see <em class="calibre24">Figure 5.9</em>). </span><span>You should get the following screen:</span></li>
</ol>
<div class="cdpaligncenter"><img src="../images/00118.jpeg" class="calibre23"/></div>
<div class="packt_figref"><span>Figure 5.11: Creating the test event</span></div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Select the <span>Create new test event</span> option and fill in your event name.</li>
<li value="4" class="calibre12">On the code form, you can write the following script:</li>
</ol>
<pre class="calibre26">{<br class="title-page-name"/>  "msg": "testing value"<br class="title-page-name"/>}</pre>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Once done, click on the <span>Create</span> button.</li>
<li value="6" class="calibre12">Test your Lambda function by clicking on the <span>Test</span> button. If successful, you should get a response from the Lambda, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone65" src="../images/00119.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.12: </span><span>Showing a test result</span></div>
<p class="calibre2">You have finished testing the Lambda function through the management console.</p>
<p class="calibre2">Next, we can perform testing using the AWS CLI. To install the AWS CLI, read the instructions at <a href="https://aws.amazon.com/cli/" target="_blank" class="calibre10">https://aws.amazon.com/cli/</a>. For Windows, you can download it from <a href="https://s3.amazonaws.com/aws-cli/AWSCLI64.msi" target="_blank" class="calibre10">https://s3.amazonaws.com/aws-cli/AWSCLI64.msi</a> for 64-bit, and <a href="https://s3.amazonaws.com/aws-cli/AWSCLI32.msi" target="_blank" class="calibre10">https://s3.amazonaws.com/aws-cli/AWSCLI32.msi</a> for 32-bit:</p>
<ol class="calibre14">
<li value="1" class="calibre12">If you run with Linux or macOS, you can install the AWS CLI using <kbd class="calibre13">pip</kbd>. You can type the following command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ pip install awscli</strong></pre>
<ol start="2" class="calibre14">
<li value="2" class="calibre12">Now, we can perform testing for AWS Lambda; the Lambda function name is <kbd class="calibre13">my-simple-lambda</kbd>. Type the following command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ aws lambda invoke --invocation-type RequestResponse --function-name my-simple-lambda --payload '{"msg": "this is AWS CLI"}' output.txt<br class="title-page-name"/></strong></pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Once successful, you should see the following response output:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone66" src="../images/00120.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.13:  </span><span>Testing AWS Lambda from the AWS CLI</span></div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Open the output file, <kbd class="calibre13">output.txt</kbd>, using your text editor. For instance, I use <kbd class="calibre13">nano</kbd> and type the following command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ nano output.txt</strong></pre>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">You should see the contents of the output file, which is a response from AWS Lambda. For instance, here is my output file:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone67" src="../images/00121.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.14: </span><span>Opening the output file by invoking the Lambda</span></div>
<p class="calibre2">You have finished testing the AWS Lambda function. Next, we'll build AWS Lambda through AWS CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">CloudFormation template for AWS Lambda functions</h1>
                
            
            <article>
                
<p class="calibre2">AWS CloudFormation provides an <span class="calibre7"><strong class="calibre5">Infrastructure as Code</strong> (</span><strong class="calibre5">IaC</strong>) solution to build a dynamic infrastructure. In the previous section, we learned how to build AWS Lambda. Now, we continue our journey with CloudFormation. We will build AWS Lambda through AWS CloudFormation.</p>
<p class="calibre2">The CloudFormation template for AWS Lambda can be found at <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" target="_blank" class="calibre10">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html</a>. The template can be described in JSON as follows:</p>
<pre class="calibre19">{<br class="title-page-name"/>  "Type" : "AWS::Lambda::Function",<br class="title-page-name"/>  "Properties" : {<br class="title-page-name"/>    "Code" : Code,<br class="title-page-name"/>    "DeadLetterConfig" : DeadLetterConfig,<br class="title-page-name"/>    "Description" : String,<br class="title-page-name"/>    "Environment" : Environment,<br class="title-page-name"/>    "FunctionName" : String,<br class="title-page-name"/>    "Handler" : String,<br class="title-page-name"/>    "KmsKeyArn" : String,<br class="title-page-name"/>    "MemorySize" : Integer,<br class="title-page-name"/>    "ReservedConcurrentExecutions" : Integer,<br class="title-page-name"/>    "Role" : String,<br class="title-page-name"/>    "Runtime" : String,<br class="title-page-name"/>    "Timeout" : Integer,<br class="title-page-name"/>    "TracingConfig" : TracingConfig,<br class="title-page-name"/>    "VpcConfig" : VPCConfig,<br class="title-page-name"/>    "Tags" : [ Resource Tag, ... ]<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">For YAML, we can define the CloudFormation template for AWS Lambda as follows:</p>
<pre class="calibre19">Type: "AWS::Lambda::Function"<br class="title-page-name"/>Properties: <br class="title-page-name"/>  Code:<br class="title-page-name"/>    Code<br class="title-page-name"/>  DeadLetterConfig:<br class="title-page-name"/>    DeadLetterConfig<br class="title-page-name"/>  Description: String<br class="title-page-name"/>  Environment:<br class="title-page-name"/>    Environment<br class="title-page-name"/>  FunctionName: String<br class="title-page-name"/>  Handler: String<br class="title-page-name"/>  KmsKeyArn: String<br class="title-page-name"/>  MemorySize: Integer<br class="title-page-name"/>  ReservedConcurrentExecutions: Integer<br class="title-page-name"/>  Role: String<br class="title-page-name"/>  Runtime: String<br class="title-page-name"/>  Timeout: Integer<br class="title-page-name"/>  TracingConfig:<br class="title-page-name"/>    TracingConfig<br class="title-page-name"/>  VpcConfig:<br class="title-page-name"/>    VPCConfig<br class="title-page-name"/>  Tags: <br class="title-page-name"/>    Resource Tag</pre>
<p class="calibre2">Not all attributes from the CloudFormation template of the Lambda are required. The following are required attributes:</p>
<ul class="calibre11">
<li class="calibre12"><kbd class="calibre13">Code</kbd>: The contents of the source code from your Lambda function. You can put the source code as inline text. You also can put it into Amazon S3.</li>
<li class="calibre12"><kbd class="calibre13">Handler</kbd>:  The name of the Lambda function (within your source code) that the Lambda calls to start running your code.</li>
<li class="calibre12"><kbd class="calibre13">Role</kbd>: An IAM role that is applied to execute the AWS Lambda function. It's the <strong class="calibre1">Amazon Resource Name</strong> (<strong class="calibre1">ARN</strong>) of the AWS Identity. Make sure your IAM role has access rights to execute the Lambda function, including your other required resources.</li>
<li class="calibre12"><kbd class="calibre13">Runtime</kbd>: A runtime environment for the Lambda function that you are uploading. For instance, it could be Python or Node.js.</li>
</ul>
<p class="calibre2">Next, we'll deploy AWS Lambda using CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying Lambda functions using AWS CloudFormation</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we'll learn how to deploy Lambda functions using AWS CloudFormation. Our Lambda function scenario is similar to the <kbd class="calibre13">my-simple-lambda</kbd> function from the previous demo.</p>
<p class="calibre2">First, we make a CloudFormation template to create AWS Lambda. Then, we upload the template to CloudFormation. Then, we get AWS Lambda <span class="calibre7">running</span>. We'll perform these tasks in the next sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a CloudFormation template for the Lambda function</h1>
                
            
            <article>
                
<p class="calibre2">Before we deploy the Lambda function through CloudFormation, we should prepare the CloudFormation template. We can write the template in JSON or YAML.</p>
<p class="calibre2">In this demo, we create the Lambda function as in the previous demo. Our Lambda function receives the <kbd class="calibre13">msg</kbd> input and then passes it to the function output. We also define a parameter, <kbd class="calibre13">LambdaFunctionName</kbd>, to get the Lambda function name. For the IAM role, we create a new IAM role, called <kbd class="calibre13">TestLambdaExecutionRole</kbd>, that will be passed to the Lambda function.</p>
<p class="calibre2">The following is a complete CloudFormation template in JSON:</p>
<pre class="calibre19">{<br class="title-page-name"/>    "Description" : "This is a simple Lambda function is Node.js",<br class="title-page-name"/>    "Parameters": { <br class="title-page-name"/>        "LambdaFunctionName":{<br class="title-page-name"/>            "Description": "AWS Lambda function name",<br class="title-page-name"/>            "Type": "String"<br class="title-page-name"/>        }<br class="title-page-name"/>      },<br class="title-page-name"/>    "Resources":{<br class="title-page-name"/>        "TestLambdaFunction" : {<br class="title-page-name"/>            "Type" : "AWS::Lambda::Function",<br class="title-page-name"/>            "Properties" : {<br class="title-page-name"/>                "FunctionName" : {<br class="title-page-name"/>                    "Ref": "LambdaFunctionName"<br class="title-page-name"/>                },<br class="title-page-name"/>                "Handler" : "index.handler",<br class="title-page-name"/>                "Role" : { "Fn::GetAtt" : ["TestLambdaExecutionRole", "Arn"] },<br class="title-page-name"/>                "Code" : {<br class="title-page-name"/>                    "ZipFile" : { "Fn::Join" : [ "\n", [ <br class="title-page-name"/>                        "exports.handler = (event, context, callback) =&gt; {",<br class="title-page-name"/>                        " var data = event['msg'];",<br class="title-page-name"/>                        " callback(null, 'Received: ' + data);", <br class="title-page-name"/>                        "}"<br class="title-page-name"/>                    ]]}<br class="title-page-name"/>                },<br class="title-page-name"/>                "Timeout" : "10", <br class="title-page-name"/>                "Runtime" : "nodejs6.10"<br class="title-page-name"/>            }<br class="title-page-name"/>        },<br class="title-page-name"/>        "TestLambdaExecutionRole": {<br class="title-page-name"/>            "Type": "AWS::IAM::Role",<br class="title-page-name"/>            "Properties": {<br class="title-page-name"/>                "AssumeRolePolicyDocument": {<br class="title-page-name"/>                    "Version": "2012-10-17",<br class="title-page-name"/>                    "Statement": [<br class="title-page-name"/>                        {<br class="title-page-name"/>                            "Effect": "Allow",<br class="title-page-name"/>                            "Principal": {<br class="title-page-name"/>                                "Service": [<br class="title-page-name"/>                                    "lambda.amazonaws.com"<br class="title-page-name"/>                                ]<br class="title-page-name"/>                            },<br class="title-page-name"/>                            "Action": [<br class="title-page-name"/>                                "sts:AssumeRole"<br class="title-page-name"/>                            ]<br class="title-page-name"/>                        }<br class="title-page-name"/>                    ]<br class="title-page-name"/>                },<br class="title-page-name"/>                "Path": "/"<br class="title-page-name"/>            }<br class="title-page-name"/>        }<br class="title-page-name"/>    }<br class="title-page-name"/>}</pre>
<p class="calibre2"><span class="calibre7">Save these scripts into a file called </span><span class="calibre7"><kbd class="calibre13">Lambda-CloudFormation.json</kbd>.</span></p>
<p class="calibre2">Here is the CloudFormation template in YAML:</p>
<pre class="calibre19">Description: This is a simple Lambda function is Node.js<br class="title-page-name"/>Parameters:<br class="title-page-name"/>  LambdaFunctionName:<br class="title-page-name"/>    Description: AWS Lambda function name<br class="title-page-name"/>    Type: String<br class="title-page-name"/>Resources:<br class="title-page-name"/>  TestLambdaFunction:<br class="title-page-name"/>    Type: AWS::Lambda::Function<br class="title-page-name"/>    Properties:<br class="title-page-name"/>      FunctionName:<br class="title-page-name"/>        Ref: LambdaFunctionName<br class="title-page-name"/>      Handler: index.handler<br class="title-page-name"/>      Role:<br class="title-page-name"/>        Fn::GetAtt:<br class="title-page-name"/>        - TestLambdaExecutionRole<br class="title-page-name"/>        - Arn<br class="title-page-name"/>      Code:<br class="title-page-name"/>        ZipFile:<br class="title-page-name"/>          Fn::Join:<br class="title-page-name"/>          - "\n"<br class="title-page-name"/>          - - exports.handler = (event, context, callback) =&gt; {<br class="title-page-name"/>            - " var data = event['msg'];"<br class="title-page-name"/>            - " callback(null, 'Received: ' + data);"<br class="title-page-name"/>            - "}"<br class="title-page-name"/>      Timeout: '10'<br class="title-page-name"/>      Runtime: nodejs6.10<br class="title-page-name"/>  TestLambdaExecutionRole:<br class="title-page-name"/>    Type: AWS::IAM::Role<br class="title-page-name"/>    Properties:<br class="title-page-name"/>      AssumeRolePolicyDocument:<br class="title-page-name"/>        Version: '2012-10-17'<br class="title-page-name"/>        Statement:<br class="title-page-name"/>        - Effect: Allow<br class="title-page-name"/>          Principal:<br class="title-page-name"/>            Service:<br class="title-page-name"/>            - lambda.amazonaws.com<br class="title-page-name"/>          Action:<br class="title-page-name"/>          - sts:AssumeRole<br class="title-page-name"/>      Path: "/"</pre>
<p class="calibre2">Save these scripts into a file called <kbd class="calibre13">Lambda-CloudFormation.yaml</kbd>. After we have created the CloudFormation template file, we will deploy it to CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying AWS Lambda to CloudFormation</h1>
                
            
            <article>
                
<p class="calibre2">We continue to deploy the AWS Lambda function to CloudFormation. We upload the <span class="calibre7"><kbd class="calibre13">Lambda-CloudFormation.json</kbd> or <kbd class="calibre13">CloudFormation.yaml</kbd> file for the CloudFormation template. In this section, we'll create a CloudFormation stack and then put the template file into the stack.</span></p>
<p class="calibre2">To implement our demo, perform the following steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to AWS CloudFormation at <a href="https://console.aws.amazon.com/cloudformation/home" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/home</a>. You should get the following screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone68" src="../images/00122.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.15: </span><span>A form from the CloudFormation management console</span></div>
<ol start="2" class="calibre14">
<li value="2" class="calibre12">To create a new stack, click on the <span>Create new stack</span> button; you'll get the screen shown in <em class="calibre24">Figure 5.16</em>.</li>
<li value="3" class="calibre12">Select the <span>Upload a template to Amazon S</span><span>3</span> option.</li>
<li value="4" class="calibre12">Select our CloudFormation template file, which has already been created, and then click on the <span>Nex</span>t button:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone69" src="../images/00123.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.16: </span><span>Selecting the CloudFormation template</span></div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">You should get the screen shown in <em class="calibre24">Figure 5.17</em>. Fill in the stack name and function name. For instance, I set my stack name as <kbd class="calibre13">test-lambda</kbd> and my function name as <kbd class="calibre13">my-lambda-cloudformation</kbd>. Once done, click on the <span>Next</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone70" src="../images/00124.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.17: </span><span>Filling in the stack and Lambda function names</span></div>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">You should get the following screen. We don't do anything on this screen. Just click on the <span>Next</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone58" src="../images/00125.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.18: </span><span>Setting the CloudFormation parameters</span></div>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">You should get the following review screen. Review all input and then click on the <span>Create</span> button to create a stack:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone71" src="../images/00126.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.19: </span><span>Review for creating a stack</span></div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">After you have clicked the <span>Create</span> button, you should get the CloudFormation dashboard. Ensure your stack has already been created with the <span>CREATE_COMPLETE</span> status. The following screenshot confirms my stack was created:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone72" src="../images/00127.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.20: </span><span>Showing the stack status</span></div>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">You also can verify your Lambda function on AWS Lambda Management Console.</li>
<li value="10" class="calibre12">Open your browser and navigate to <a href="https://console.aws.amazon.com/lambda/home" target="_blank" class="calibre10">https://console.aws.amazon.com/lambda/home</a>. You should see your Lambda function that was created through CloudFormation:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone73" src="../images/00128.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.21: </span><span>Showing a list of AWS Lambda</span></div>
<p class="calibre2">Now we can test using the AWS CLI. For instance, the Lambda function name is <kbd class="calibre13">my-lambda-cloudformation</kbd>. We can perform this test by typing the following command:</p>
<pre class="calibre19"><strong class="calibre1">$ aws lambda invoke --invocation-type RequestResponse --function-name my-lambda-cloudformation --payload '{"msg": "this is AWS CLI"}' output-lambda.txt</strong></pre>
<p class="calibre2">If successful, you get the following response output:</p>
<div class="cdpaligncenter"><img class="alignnone74" src="../images/00129.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.22: Calling the AWS Lambda function from the AWS CLI</span></div>
<p class="calibre2">If you have security problems when invoking the Lambda function from the AWS CLI, verify your account permissions. You can check on the IAM management console at <a href="https://console.aws.amazon.com/iam/" target="_blank" class="calibre10">https://console.aws.amazon.com/iam/</a>. Your account should have <span class="calibre7">AWSLambdaExecute</span> and/or <span class="calibre7">AWSLambdaRole</span> permissions.</p>
<p class="calibre2">After invoking the Lambda function, o<span class="calibre7">pen the output file so you get the contents of the output file. Type the following command:</span></p>
<pre class="calibre19"><strong class="calibre1">$ nano output-lambda.txt</strong></pre>
<p class="calibre2">You should see the following response output:</p>
<div class="cdpaligncenter"><img class="alignnone75" src="../images/00130.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.23: </span><span>Opening the output file, output-lambda.txt</span></div>
<p class="calibre2">You have learned how to build AWS Lambda using CloudFormation. Next, we'll explore the AWS Lambda function with the DynamoDB database through the CloudFormation template.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">CloudFormation for AWS Lambda and DynamoDB</h1>
                
            
            <article>
                
<p class="calibre2">Sometimes we want to build a Lambda function with storage capabilities. Amazon AWS provides storage services that we can integrate with AWS Lambda. In this section, we'll explore how to use DynamoDB in AWS Lambda.</p>
<p class="calibre2">AWS DynamoDB is a storage service from AWS. It's storage based on NoSQL. You can review DynamoDB's features on its official website at <a href="https://aws.amazon.com/dynamodb/" target="_blank" class="calibre10">https://aws.amazon.com/dynamodb/</a>. AWS DynamoDB provides various SDK APIs to enable you to access DynamoDB in your own programs, such as Java, JavaScript, Node.js, .NET, PHP, Python, and Ruby.</p>
<p class="calibre2">Technically, DynamoDB can be operated easily. You can use the DynamoDB Management Console at <a href="https://console.aws.amazon.com/dynamodb/" target="_blank" class="calibre10">https://console.aws.amazon.com/dynamodb/</a>. Then, you can create a table with key attributes. You can deploy DynamoDB in various regions. It takes benefits in accessibility from your customers.</p>
<p class="calibre2">In this section, we'll build a Lambda function to insert data into DynamoDB. We implement a Lambda function using Node.js through CloudFormation for the deployment method:</p>
<div class="cdpaligncenter"><img src="../images/00131.jpeg" class="calibre23"/></div>
<div class="packt_figref">Figure 5.24: Lambda and DynamoDB interaction</div>
<p class="calibre2">To implement our demo, we will perform the following tasks:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Creating a CloudFormation template for Lambda and DynamoDB</li>
<li value="2" class="calibre12">Deploying the CloudFormation template</li>
<li value="3" class="calibre12">Configuring the Lambda-invoking policy</li>
<li value="4" class="calibre12">Testing the Lambda function</li>
</ol>
<p class="calibre2">These tasks will be explored in the next sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the CloudFormation template for AWS DynamoDB</h1>
                
            
            <article>
                
<p class="calibre2">The CloudFormation template for AWS DynamoDB can be found at <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html" target="_blank" class="calibre10">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html</a>. The template can be described in JSON as follows:</p>
<pre class="calibre19">{<br class="title-page-name"/>  "Type" : "AWS::DynamoDB::Table",<br class="title-page-name"/>  "Properties" : {<br class="title-page-name"/>    "AttributeDefinitions" : [ AttributeDefinition, ... ],<br class="title-page-name"/>    "GlobalSecondaryIndexes" : [ GlobalSecondaryIndexes, ... ],<br class="title-page-name"/>    "KeySchema" : [ KeySchema, ... ],<br class="title-page-name"/>    "LocalSecondaryIndexes" : [ LocalSecondaryIndexes, ... ],<br class="title-page-name"/>    "PointInTimeRecoverySpecification" : PointInTimeRecoverySpecification,<br class="title-page-name"/>    "ProvisionedThroughput" : ProvisionedThroughput,<br class="title-page-name"/>    "SSESpecification" : SSESpecification,<br class="title-page-name"/>    "StreamSpecification" : StreamSpecification,<br class="title-page-name"/>    "TableName" : String,<br class="title-page-name"/>    "Tags" : [ Resource Tag, ... ],<br class="title-page-name"/>    "TimeToLiveSpecification" : TimeToLiveSpecification<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">We can define the template in YAML as follows:</p>
<pre class="calibre19">Type: "AWS::DynamoDB::Table"<br class="title-page-name"/>Properties:<br class="title-page-name"/>  AttributeDefinitions:<br class="title-page-name"/>    - AttributeDefinition<br class="title-page-name"/>  GlobalSecondaryIndexes:<br class="title-page-name"/>    - GlobalSecondaryIndexes<br class="title-page-name"/>  KeySchema:<br class="title-page-name"/>    - KeySchema<br class="title-page-name"/>  LocalSecondaryIndexes:<br class="title-page-name"/>    - LocalSecondaryIndexes<br class="title-page-name"/>  PointInTimeRecoverySpecification: <br class="title-page-name"/>    PointInTimeRecoverySpecification<br class="title-page-name"/>  ProvisionedThroughput:<br class="title-page-name"/>    ProvisionedThroughput<br class="title-page-name"/>  SSESpecification:<br class="title-page-name"/>    SSESpecification<br class="title-page-name"/>  StreamSpecification:<br class="title-page-name"/>    StreamSpecification<br class="title-page-name"/>  TableName: String<br class="title-page-name"/>  Tags: <br class="title-page-name"/>    - Resource Tag<br class="title-page-name"/>  TimeToLiveSpecification: <br class="title-page-name"/>    TimeToLiveSpecification</pre>
<p class="calibre2">You should define three required attributes—<kbd class="calibre13">AttributeDefinitions</kbd><span class="calibre7">, <kbd class="calibre13">KeySchema</kbd>, and <kbd class="calibre13">ProvisionedThroughput</kbd>:</span></p>
<ul class="calibre11">
<li class="calibre12"><kbd class="calibre13">AttributeDefinitions</kbd>: This consists of a list of attributes that describe the key schema for the table and indexes.</li>
<li class="calibre12"><kbd class="calibre13">KeySchema</kbd>: This consists of attributes that make up the primary key for the table. You can define the KeySchema type in <kbd class="calibre13">HASH</kbd> or <kbd class="calibre13">RANGE</kbd>.</li>
<li class="calibre12"><kbd class="calibre13">ProvisionedThroughput</kbd>: This describes the throughput values, which are values for the <kbd class="calibre13">ReadCapacityUnits</kbd> and <kbd class="calibre13">WriteCapacityUnits</kbd> attributes.</li>
</ul>
<p class="calibre2">Next, we'll create a CloudFormation template to build Lambda and DynamoDB resources.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Building a CloudFormation template for Lambda and DynamoDB</h1>
                
            
            <article>
                
<p class="calibre2">To build a CloudFormation template for Lambda and DynamoDB, we can modify our previous CloudFormation template for Lambda. We add DynamoDB resources and a policy. We replace our Lambda function in order to access DynamoDB. </p>
<p class="calibre2">Next, we'll start to create the Lambda function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Accessing DynamoDB from Lambda functions</h1>
                
            
            <article>
                
<p class="calibre2">Our scenario in the Lambda function is to get JSON data from the parameter input of the Lambda function, and then insert it into DynamoDB.</p>
<p class="calibre2">We can use the <kbd class="calibre13">DynamoDB</kbd> object from our Node.js application through the AWS SDK. After we get data from the Lambda function, we can insert the data into DynamoDB using the <kbd class="calibre13">putItem()</kbd> API. You can read more about this API at <a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_PutItem.html" target="_blank" class="calibre10">https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_PutItem.html</a>.</p>
<p class="calibre2"/>
<p class="calibre2">For instance, we insert data into the DynamoDB table, called <kbd class="calibre13">mydynamodb</kbd>. We can implement our Lambda function as follows:</p>
<pre class="calibre19">var AWS = require('aws-sdk');<br class="title-page-name"/>var ddb = new AWS.DynamoDB();<br class="title-page-name"/>exports.handler = (event, context, callback) =&gt; {<br class="title-page-name"/>    var params = {<br class="title-page-name"/>        TableName: 'mydynamodb',<br class="title-page-name"/>        Item: {<br class="title-page-name"/>           'id': {S:new Date().getTime().toString()},<br class="title-page-name"/>           'email': {S:event.email},<br class="title-page-name"/>           'name': {S:event.name},<br class="title-page-name"/>           'country' : {S:event.country},<br class="title-page-name"/>           'age' : {N:event.age},<br class="title-page-name"/>        }<br class="title-page-name"/>    };<br class="title-page-name"/>    ddb.putItem(params, function(err, data) {<br class="title-page-name"/>       if (err) {<br class="title-page-name"/>          callback(err, 'Error');<br class="title-page-name"/>       } else {<br class="title-page-name"/>          callback(null, 'Insert data was successful');<br class="title-page-name"/>       }<br class="title-page-name"/>    });<br class="title-page-name"/>}</pre>
<p class="calibre2">This Lambda function will return the <kbd class="calibre13">Insert data was successful</kbd> message in the event of a successful operation. Otherwise, we get an <kbd class="calibre13">Error</kbd> message with a detailed error description.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the CloudFormation template</h1>
                
            
            <article>
                
<p class="calibre2">We modify our CloudFormation template for the Lambda from the previous section. We replace the content of the <kbd class="calibre13">Code</kbd> attribute with our Lambda function code. We also define the DynamoDB resource, called <kbd class="calibre13">myDynamoDBTable</kbd>.</p>
<p class="calibre2">Since our Lambda function accesses DynamoDB, we should configure an additional policy inside <kbd class="calibre13">TestLambdaExecutionRole</kbd>. We add the <kbd class="calibre13">ManagedPolicyArns</kbd> attribute, which gives access rights to call the <kbd class="calibre13">dynamodb:PutItem</kbd> action.</p>
<p class="calibre2"/>
<p class="calibre2">The following is our modified CloudFormation template for Lambda and DynamoDB in JSON (<kbd class="calibre13">lambda-dynamodb.json</kbd>):</p>
<pre class="calibre19">{ <br class="title-page-name"/>  .....<br class="title-page-name"/>                <br class="title-page-name"/>        },<br class="title-page-name"/>        "myDynamoDBTable" : {<br class="title-page-name"/>            "Type" : "AWS::DynamoDB::Table",<br class="title-page-name"/>            "Properties" : {<br class="title-page-name"/>                "TableName": "mydynamodb",<br class="title-page-name"/>                "AttributeDefinitions": [ <br class="title-page-name"/>                  {"AttributeName" : "id", "AttributeType" : "S"}<br class="title-page-name"/>                ],<br class="title-page-name"/>                "KeySchema": [<br class="title-page-name"/>                  { "AttributeName": "id", "KeyType": "HASH" }<br class="title-page-name"/>                ],<br class="title-page-name"/>                "ProvisionedThroughput" : {<br class="title-page-name"/>                   "ReadCapacityUnits" : "5",<br class="title-page-name"/>                   "WriteCapacityUnits" : "5"<br class="title-page-name"/>                } <br class="title-page-name"/>            }<br class="title-page-name"/>        },<br class="title-page-name"/>        "TestLambdaExecutionRole": {<br class="title-page-name"/>...                <br class="title-page-name"/>                            "Resource": [<br class="title-page-name"/>                                {"Fn::Join" : ["", ["arn:aws:dynamodb:", {"Ref": "AWS::Region"}, ":", {"Ref": "AWS::AccountId"}, ":table/mydynamodb"]]}<br class="title-page-name"/>                            ]<br class="title-page-name"/>                        }]<br class="title-page-name"/>                    }<br class="title-page-name"/>                }],<br class="title-page-name"/>...<br class="title-page-name"/>        }<br class="title-page-name"/>    }<br class="title-page-name"/>  }</pre>
<p class="calibre2">The following is the CloudFormation template in YAML (<kbd class="calibre13">lambda-dynamodb.yaml</kbd>):</p>
<pre class="calibre19">...<br class="title-page-name"/>Resources:<br class="title-page-name"/>  ...<br class="title-page-name"/>      Code:<br class="title-page-name"/>        ZipFile:<br class="title-page-name"/>          Fn::Join:<br class="title-page-name"/>          - "\n"<br class="title-page-name"/>          -<br class="title-page-name"/>      Timeout: '10'<br class="title-page-name"/>      Runtime: nodejs6.10<br class="title-page-name"/>  myDynamoDBTable:<br class="title-page-name"/>    Type: AWS::DynamoDB::Table<br class="title-page-name"/>    Properties:<br class="title-page-name"/> ...<br class="title-page-name"/>      - AttributeName: id<br class="title-page-name"/>        KeyType: HASH<br class="title-page-name"/>      ProvisionedThroughput:<br class="title-page-name"/>        ReadCapacityUnits: '5'<br class="title-page-name"/>        WriteCapacityUnits: '5'<br class="title-page-name"/>  TestLambdaExecutionRole:<br class="title-page-name"/>...<br class="title-page-name"/>      ManagedPolicyArns:<br class="title-page-name"/>      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole<br class="title-page-name"/>      Policies:<br class="title-page-name"/>      - PolicyName: dynamodb<br class="title-page-name"/>        PolicyDocument:<br class="title-page-name"/>          Version: '2012-10-17'<br class="title-page-name"/>...</pre>
<p class="calibre2">Save all CloudFormation template files, <kbd class="calibre13">lambda-dynamodb.json</kbd>, and/or <kbd class="calibre13">lambda-dynamodb.yaml</kbd>.</p>
<p class="calibre2">Next, we'll deploy our the template file to AWS CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying the CloudFormation template</h1>
                
            
            <article>
                
<p class="calibre2">After we prepare our CloudFormation template file, we can continue to deploy the template in AWS CloudFormation. In this section, we'll use CloudFormation Management Console.</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">We use the same method to upload the CloudFormation template file to AWS CloudFormation. Perform the following steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to <span>CloudFormation Management Console at <a href="https://console.aws.amazon.com/cloudformation" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation</a>.</span></li>
<li value="2" class="calibre12">Upload the CloudFormation template file that we have created to access the Lambda and DynamoDB resources.</li>
<li value="3" class="calibre12">You can upload <span><kbd class="calibre13">lambda-dynamodb.json</kbd> or <kbd class="calibre13">lambda-dynamodb.yaml</kbd>.</span></li>
<li value="4" class="calibre12">Once done, you will be asked to fill in the stack name and the Lambda function name:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone76" src="../images/00132.jpeg"/></div>
<div class="packt_figref">Figure 5.25: Creating a new CloudFormation stack</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Click on the <span>Next</span> button and follow the instructions until the end of the upload process.</li>
<li value="6" class="calibre12">Once the process is complete, check your CloudFormation status on the CloudFormation dashboard:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone77" src="../images/00133.jpeg"/></div>
<div class="packt_figref">Figure 5.26: The CloudFormation stack was created</div>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">Make sure your CloudFormation stack has the <span>CREATE_COMPLETE</span> status in order to continue to the next step.</li>
</ol>
<p class="calibre2"> </p>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">You can verify the DynamoDB table with the name <kbd class="calibre13">mydynamodb</kbd> on DynamoDB Management Console at <a href="https://console.aws.amazon.com/dynamodb/" target="_blank" class="calibre10">https://console.aws.amazon.com/dynamodb/</a>. You should see your DynamoDB table, <kbd class="calibre13">mydynamodb</kbd>, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone78" src="../images/00134.jpeg"/></div>
<div class="packt_figref">Figure 5.27: The DynamoDB table, mydynamodb, was created from CloudFormation</div>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">Verify your Lambda function on the Lambda Management Console at <a href="https://console.aws.amazon.com/lambda/" target="_blank" class="calibre10">https://console.aws.amazon.com/lambda/</a>. You should see your Lambda function, <span>lambda-dynamodb-func</span>, in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone79" src="../images/00135.jpeg"/></div>
<div class="packt_figref">Figure 5.28: The <span>Lambda function, lambda-dynamodb-func was created from CloudFormation</span></div>
<p class="calibre2">Now, you have finished deploying your Lambda function with the DynamoDB resource through CloudFormation.</p>
<p class="calibre2">Next, we'll configure the user policy in order to invoke the Lambda function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Configuring the Lambda invocation policy</h1>
                
            
            <article>
                
<p class="calibre2">We'll continue to invoke our Lambda function through the AWS CLI. To enable invoking the Lambda function, your AWS CLI user should have the access policy to access Lambda and DynamoDB.</p>
<p class="calibre2">In this section, we add DynamoDB permissions to access this resource. Follow these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to IAM Management Console at <a href="https://console.aws.amazon.com/iam/" target="_blank" class="calibre10">https://console.aws.amazon.com/iam/</a>.</li>
<li value="2" class="calibre12">Open your account, from the <span>Users</span> menu, and add permissions.</li>
<li value="3" class="calibre12">Add <span>AmazonDynamoDBFullAccess</span> permission:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone80" src="../images/00136.jpeg"/></div>
<div class="packt_figref">Figure 5.29: Adding permission to the IAM user</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Once done, click on the <span>Next: Review</span> button. You should get the following review screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone81" src="../images/00137.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.30: Adding AmazonDynamoDBFullAccess</span></div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">If you think it's finished, click on the <span>Add permissions</span> button. Your account should have DynamoDB permission:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone82" src="../images/00138.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.31: The AmazonDynamoDBFullAccess permission was added to an IAM user</span></div>
<p class="calibre2">You have finished adding permissions to invoke the Lambda function from the AWS CLI. Next, we'll test invoking the Lambda function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Testing our Lambda function</h1>
                
            
            <article>
                
<p class="calibre2">To test our Lambda function using the AWS CLI, open the Terminal. We send JSON data as follows:</p>
<pre class="calibre19">{"email": "user1@email.com", "name":"hessa", "country":"DE", "age":"32"}</pre>
<p class="calibre2">We pass this data while invoking the AWS Lambda function. The Lambda function is <kbd class="calibre13">lambda-dynamodb-func</kbd>. We also set the output file with <kbd class="calibre13">lambda-dynamodb.txt</kbd>.</p>
<p class="calibre2">You can type this command to invoke our Lambda function:</p>
<pre class="calibre19"><strong class="calibre1">$ aws lambda invoke --invocation-type RequestResponse --function-name lambda-dynamodb-func --payload '{"email": "user1@email.com", "name":"hessa", "country":"DE", "age":"32"}' lambda-dynamodb.txt</strong></pre>
<p class="calibre2">If successful, you should get the following <kbd class="calibre13">200</kbd> status code:</p>
<div class="cdpaligncenter"><img class="alignnone83" src="../images/00139.gif"/></div>
<div class="packt_figref">Figure 5.32: Invoking the Lambda function</div>
<p class="calibre2">You also get an output file, <kbd class="calibre13">lambda-dynamodb.txt</kbd>. You can open it using the <kbd class="calibre13">nano</kbd> command:</p>
<pre class="calibre19"><strong class="calibre1">$ nano lambda-dynamodb.txt</strong></pre>
<p class="calibre2">Then, you should see a response message from our Lambda function. For instance, here is my output file:</p>
<div class="cdpaligncenter"><img src="../images/00140.jpeg" class="calibre43"/></div>
<div class="packt_figref">Figure 5.33: Displaying the output file, <span>lambda-dynamodb.txt</span></div>
<p class="calibre2">You can verify the data was inserted into the DynamoDB table. You can open DynamoDB Management Console at <a href="https://console.aws.amazon.com/dynamodb/" target="_blank" class="calibre10">https://console.aws.amazon.com/dynamodb/</a>. You should see the data. You can see my data output in the following screenshot:</p>
<div class="cdpaligncenter"><img class="alignnone84" src="../images/00141.jpeg"/></div>
<div class="packt_figref">Figure 5.34: Displaying data on the DynamoDB Management Console</div>
<p class="calibre2">You have finished building the Lambda function <span class="calibre7">with access to</span> DynamoDB through CloudFormation.</p>
<p class="calibre2">Next, we'll deploy the Lambda function on various regions through CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying the Lambda function to multiple regions</h1>
                
            
            <article>
                
<p class="calibre2">We have learned how to deploy Lambda functions through CloudFormation. We also accessed DynamoDB resources inside the Lambda function. In this section, we'll deploy a Lambda function to various regions with CloudFormation.</p>
<p class="calibre2">You can follow the next steps to implement our demo and deploy the Lambda function to multiple regions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Preparation</h1>
                
            
            <article>
                
<p class="calibre2">To work with certain regions on CloudFormation, we can use a CloudFormation StackSet. You learned about this in <a target="_blank" href="part0070.html#22O7C0-ff9c6455e1444393ad97060c22881bf4" class="calibre10">Chapter 4</a>, <em class="calibre17">AWS CloudFormation StackSets</em>. In this demo, we'll build a Lambda function to be deployed to certain regions.</p>
<p class="calibre2">To follow this demo, you should have already configured security policies for CloudFormation StackSet. You did that in <a target="_blank" href="part0070.html#22O7C0-ff9c6455e1444393ad97060c22881bf4" class="calibre10">Chapter 4</a>, <em class="calibre17">AWS CloudFormation StackSets</em>. You should deploy these template files to CloudFormation Stack in the <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole.yml</kbd> and <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole.yml</kbd> files.</p>
<p class="calibre2">Please read <a target="_blank" href="part0070.html#22O7C0-ff9c6455e1444393ad97060c22881bf4" class="calibre10">Chapter 4</a>, <em class="calibre17">AWS CloudFormation StackSets</em> to learn how to deploy them to CloudFormation template files. In the following screenshot, you can see that the <span class="calibre7"><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole.yml</kbd> and </span><span class="calibre7"><kbd class="calibre13">AWSCloudFormationStackSetExecutionRole.yml</kbd> CloudFormation template files were deployed:</span></p>
<div class="cdpaligncenter"><img class="alignnone85" src="../images/00142.jpeg"/></div>
<div class="packt_figref">Figure 5.35: Applying security permissions for CloudFormation StackSet</div>
<p class="calibre2">Next, we'll develop a CloudFormation template for the Lambda function that targets multiple regions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Developing a CloudFormation template for the Lambda function</h1>
                
            
            <article>
                
<p class="calibre2">In this demo, we'll modify our CloudFormation template file <kbd class="calibre13">Lambda-CloudFormation.json</kbd>/<kbd class="calibre13">Lambda-CloudFormation.yaml</kbd>.</p>
<p class="calibre2">The following is our Lambda function code:</p>
<pre class="calibre19">var region = process.env.AWS_REGION; <br class="title-page-name"/>exports.handler = (event, context, callback) =&gt; {<br class="title-page-name"/>     var data = event['msg'];<br class="title-page-name"/>     callback(null, 'Received: ' + data + ' . Region: ' + region); <br class="title-page-name"/>}</pre>
<p class="calibre2">This function returns a message with the region information included. It's done by calling the <kbd class="calibre13">process.env.AWS_REGION</kbd> API. Save the CloudFormation template file as <kbd class="calibre13">Lambda-multi-regions.json</kbd> or <kbd class="calibre13">Lambda-multi-regions.yaml</kbd>.</p>
<p class="calibre2">Next, we'll deploy this CloudFormation template to a CloudFormation StackSet.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying the Lambda function to multiple regions</h1>
                
            
            <article>
                
<p class="calibre2">Once we've prepared a CloudFormation StackSet and created the CloudFormation template file, we can continue to deploy the template to StackSet.</p>
<p class="calibre2">In this demo, we use the CloudFormation StackSet Management Console. Follow these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to the <span>CloudFormation StackSet Management Console at <a href="https://console.aws.amazon.com/cloudformation/stacksets/" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/stacksets/</a>.</span></li>
<li value="2" class="calibre12">Click on the <span>Create StackSet</span> button and you should get the following screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone86" src="../images/00143.jpeg"/></div>
<div class="packt_figref">Figure 5.36: Selecting a template for CloudFormation StackSet</div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Select the <span>Upload a template to Amazon S3</span> option and upload <span><kbd class="calibre13">Lambda-multi-regions.json</kbd> or </span><span><kbd class="calibre13">Lambda-multi-regions.yaml</kbd> by clicking on the </span><span>Browse</span> <span><span>button.</span></span></li>
</ol>
<p class="calibre2"> </p>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Click on the <span>Next</span> button to get the following screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone87" src="../images/00144.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.37: Filling in the StackSet and Lambda function names</span></div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Fill in the StackSet and Lambda function names and click on the <span>Next</span> button. You will get the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone88" src="../images/00145.jpeg"/></div>
<div class="packt_figref"><span><span>Figure 5.38: Setting the account and target regions</span></span></div>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">Fill in the ARN code from your account in the <span>Deploy stacks in accounts</span> option. You will also be asked to fill in regions for deployment targets. In this demo, I selected three regions—<span>US East (N.Virginia)</span>, <span>Asia Pacific (Singapore)</span>, and <span>EU (Frankfurt)</span>.</li>
<li value="7" class="calibre12">Click on the <span>Next</span> button until you get the following screen:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone89" src="../images/00146.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.39: Reviewing the CloudFormation StackSet</span></div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">Review all input and, after completing the review, click on the <span>Create</span> button.</li>
<li value="9" class="calibre12">CloudFormation provisions your template for the targeted regions. If successful, you should see <span>SUCCEEDED</span> in your StackSet:</li>
</ol>
<div class="cdpaligncenter"><img class="alignnone90" src="../images/00147.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.40: CloudFormation StackSet was created with three regions</span></div>
<p class="calibre2">Now you have finished deploying an AWS CloudFormation StackSet with the Lambda function. Next, we will invoke this function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Invoking the Lambda function</h1>
                
            
            <article>
                
<p class="calibre2">Now, you can invoke your Lambda function. In this demo, I use the AWS CLI. We send this data as follows:</p>
<pre class="calibre19">{"msg": "this is AWS CLI"}</pre>
<p class="calibre2">The Lambda function is <kbd class="calibre13">lambda-multiregions-func</kbd>. You can invoke this Lambda function from the AWS CLI as follows:</p>
<pre class="calibre19"><strong class="calibre1">$ aws lambda invoke --invocation-type RequestResponse --function-name lambda-multiregions-func --payload '{"msg": "this is AWS CLI"}' output-multiregion.txt</strong></pre>
<p class="calibre2">If successful, you'll get a status code of <kbd class="calibre13">200</kbd>, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img class="alignnone91" src="../images/00148.jpeg"/></div>
<div class="packt_figref"><span>Figure 5.41: Invoking the Lambda function with the US East region</span></div>
<p class="calibre2">Open your output file to get a response from the AWS Lambda function:</p>
<pre class="calibre19"><strong class="calibre1">$ nano output-multiregion.txt</strong></pre>
<p class="calibre2">The sample output is shown as follows:</p>
<div class="cdpaligncenter"><img src="../images/00149.jpeg" class="calibre44"/></div>
<div class="packt_figref"><span>Figure 5.42: Opening the output file</span></div>
<p class="calibre2">You have finished deploying the Lambda function in certain regions through CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre7">We learned how to deploy Lambda functions through CloudFormation. Then, we included DynamoDB resources inside Lambda function codes. Finally, we deployed a Lambda function to various regions with CloudFormation.</span></p>
<p class="calibre2">In the next chapter, we'll learn how to work with an AWS IoT deployment through CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre7">Use these questions to test your understanding of this chapter:</span></p>
<ol class="calibre14">
<li value="1" class="calibre12">List the steps to deploy the AWS Lambda function with CloudFormation.</li>
<li value="2" class="calibre12">How do you develop a CloudFormation template for the Lambda function?</li>
<li value="3" class="calibre12">How do you deploy the Lambda function tocertain regions using CloudFormation?</li>
</ol>


            </article>

            
        </section>
    </body></html>