<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Releasing Your Application" id="aid-26I9K1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Releasing Your Application</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Continuous Deployment can be thought of as an extension to Continuous Integration, aiming at minimizing lead time"</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Agile Allianz</em></span></span></td></tr></table></div><p>In this chapter, we will cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Creating a release definition in Team Web Portal</li><li class="listitem">Mapping artifacts to a release definition</li><li class="listitem">Configuring a release definition for the continuous deployment</li><li class="listitem">Adding and configuring environments in a release definition</li><li class="listitem">Configuring security for release definitions</li><li class="listitem">Configuring global and local variables for a release</li><li class="listitem">Deploying an Azure website using release management</li><li class="listitem">Deploying the IIS Web Application using release management</li><li class="listitem">Tracking a release in release management</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec67"/>Introduction</h1></div></div></div><p>So far in the book, we have talked about planning, developing, testing, and building software. Software teams spend weeks and months developing and testing software; however, software can only reap its worth when it reaches the hands of the people it's meant for. Release management is an enabler for that:</p><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Release management is the process of managing, planning, scheduling, and controlling a software build through different stages and environments; including testing and deploying software releases."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Wikipedia</em></span></span></td></tr></table></div><p>On June 3rd, 2013, Microsoft acquired the InRelease product from InCycle software. The InRelease product was rebranded as Microsoft Release Management and integrated into Team Foundation Server 2013. Microsoft Release Manager gave Microsoft a position in the growing release management market. While Release Manager shipped along with Team Foundation Server, it required separate installation and setup. Though various improvements were made to improve the integration between the two products, they still felt disjointed at several places. The WPF-based desktop client was clunky and limiting. Release Manager did not support non-.NET applications and could not be used on non-Windows platforms. It was clear that Release Manager was only a stop-gap solution and would need to be replaced by a proper solution.</p><p>Microsoft has recently released the web-based Release Management solution in Visual Studio Team Services. While the new solution has not been released in Team Foundation Server 2015 Update 1, it is expected to debut in TFS 2015 in either Update 2 or Update 3. No further investment is expected to be made in the old Release Management Solution, and it will inevitably be replaced by the new web-based Release Management Solution. With this in mind, this chapter is entirely focused on the new web-based Release Management Solution. To try out the recipes in this chapter, you'll need to create a Visual Studio Team Services account; follow the instructions at <a class="ulink" href="http://bit.ly/1N50I7j">http://bit.ly/1N50I7j</a>.</p><div class="note" title="Note"><h3 class="title"><a id="note40"/>Note</h3><p>Recipes in this chapter are based on the new web-based Release Management Solution. The new web-based Release Management Solution is expected to be available in Team Foundation Server in Update 2 or Update 3. To try out the recipes in this chapter, create a Visual Studio Team Services account (<a class="ulink" href="http://bit.ly/1N50I7j">http://bit.ly/1N50I7j</a>).</p></div><p>The new web-based Release Management Solution is very well integrated into the product. No separate installation or configuration is required to start using the new Release Management Solution. The security infrastructure of the Release Manager is different from the previous version, in that it did not manage its own groups and permissions. New permissions are introduced in VSTS for release management, such as <span class="strong"><strong>Create release definitions</strong></span>, <span class="strong"><strong>Create releases</strong></span>, and <span class="strong"><strong>Manage approvers</strong></span>. Default values for these permissions are set for specific groups at the Team Project level. These permissions can then be overridden for the groups or individual users, for a specific release definition or for a specific environment within a release definition.</p><p>Both Team build and release management share the same agent—pool and queue infrastructure. Unified agent infrastructure reduces administration and setup overhead. The tasks used to orchestrate the actions are also shared between build and release. This significantly reduces the learning curve for release management. The new solution is web based, open, extensible, and fully cross-platform. The underlying framework between Team build and release management is the same, so you get the same real-time console output in release management as you get with Team build. The release definitions support change revision and different functionality similar to that in the build definitions. Release management supports draft releases similar to the draft build functionality in Team build. With so much in common between build and release management, the only difference is the build also has access to deployment tasks, you may ask how are the build and release management different?</p><p>The line between build and release management is blurred because both share so much in common. The key difference is that deployment is just one of the activities performed in the release management. As illustrated in the following image, the new release management solution allows creating release pipelines. A release pipeline can consist of one or more environments. Each environment can have one or more physical or virtual deployment targets. Environments provide pre-release and post-release approval workflow as well as tasks for testing and deployment:</p><div class="mediaobject"><img src="../Images/image00722.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>The software deployed through Release Manager can be injected from Team build, Jenkins, Team City, FTP, and so on. With artifacts shared across all environments in the release pipeline, it truly lets you build once and deploy everywhere.</p><p>To lower the entry barrier, Release Manager provides out-of-the-box Deployment Templates. The Deployment Template adds the set of tasks required for the type of deployment in an environment. You still need to configure the tasks, but pre-adding the tasks gives you a head start in your release configuration. The framework also allows you to clone or save your configured environments as templates. Again, the intention is to speed up release configuration and maximize reuse across release definitions. Release management is expected to soon supplement the REST API gallery with Release Management REST APIs. This will allow you to integrate release management into other parts of the release workflow used in your organization or simply extend the release management capabilities where you find them lacking.</p><p>You will kick off the chapter by learning the different capabilities in the new web-based release management solution; in the later recipes, we'll cover deployment scenarios for Azure and on-premise web applications. Last but not least, we'll understand the release tracking and reporting capabilities available in release management.</p></div></div>
<div class="section" title="Creating a release definition in Team Web Portal"><div class="titlepage" id="aid-27GQ62"><div><div><h1 class="title"><a id="ch06lvl1sec68"/>Creating a release definition in Team Web Portal</h1></div></div></div><p>In this recipe, you'll<a id="id698" class="indexterm"/> learn how to create a new release <a id="id699" class="indexterm"/>definition using an empty Deployment Template. You'll also learn about the different functions available in a release definition.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec187"/>Getting ready</h2></div></div></div><p>To create a new release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec188"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Release</strong></span> hub in FabrikamTFVC Team Project:<div class="mediaobject"><img src="../Images/image00723.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> icon to create a new release definition. There are preconfigured Deployment Templates to choose from. In this recipe, we'll start with the <span class="strong"><strong>Empty</strong></span> template. Unlike the other templates, the <span class="strong"><strong>Empty</strong></span> template creates a blank release definition without any pre-added tasks:<div class="mediaobject"><img src="../Images/image00724.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Name the<a id="id700" class="indexterm"/> release <a id="id701" class="indexterm"/>definition <code class="literal">FabrikamTFVC Web Release</code>:<div class="mediaobject"><img src="../Images/image00725.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the <span class="strong"><strong>General</strong></span> tab and change the release number format from <code class="literal">Release-$(rev:r)</code> to <code class="literal">Rel-$(System.TeamProject)-$(rev:r)</code>. The releases generated from this definition will have a release name in the format <code class="literal">Rel-FabrikamTFVC-1</code>:</li><li class="listitem">Click on the <span class="strong"><strong>Save</strong></span> button to save the release definition. In this recipe, we've created a blank release definition. We'll walk through the different functions of a release definition in the next <span class="emphasis"><em>How it works…</em></span> section.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec189"/>How it works…</h2></div></div></div><p>In this recipe, we <a id="id702" class="indexterm"/>started off from an empty release<a id="id703" class="indexterm"/> template. The Deployment Template window provides an option to start from a pre-configured release template. The pre-configured Deployment Template adds an environment and all necessary release tasks to the default environment, only leaving the task configuration to you. As illustrated in the following screenshot, the <span class="strong"><strong>Azure Website Deployment</strong></span> template adds a default environment and two tasks, namely, <span class="strong"><strong>Azure Web App Deployment</strong></span> and <span class="strong"><strong>Visual Studio Test</strong></span>. In the long term, you'll start seeing more pre-configured Deployment Templates being made available out of the box:</p><div class="mediaobject"><img src="../Images/image00726.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>Let's now understand the functions in the <span class="strong"><strong>Environments</strong></span> tab of the FabrikamTFVC Web release definition:</p><div class="mediaobject"><img src="../Images/image00727.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Add environments</strong></span>: This is the collection of server(s) where your application needs to be deployed. Clicking on the <span class="strong"><strong>Add environments</strong></span> icon also launches the Deployment Template window. The deployment window gives you the ability to add an environment and related tasks for deploying the application in that environment.</li><li class="listitem"><span class="strong"><strong>Default Environment</strong></span>: This is a logical container holding the tasks required to release an<a id="id704" class="indexterm"/> application in <a id="id705" class="indexterm"/>the environment. As illustrated in the following screenshot, an environment supports a level of configuration. We'll be covering the functions supported by an environment in detail in the <span class="emphasis"><em>Adding and configuring environments in a release definition</em></span> recipe:<div class="mediaobject"><img src="../Images/image00728.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><span class="strong"><strong>Add tasks</strong></span>: This is simply a step in the release process to an environment. A set of pre-created tasks are already available out of the box. The gallery also provides scripting tasks to enable you to perform operations that may not necessarily be available in the pre-created tasks. The framework is fully extensibility; refer to the <span class="emphasis"><em>Creating a new build task using the TFBuild Extensibility framework</em></span> recipe in <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span>, to learn how you can add your own tasks. Both build and release hub shared a common task gallery. This allows you to use the tasks from the build process in the release process too. You'll learn more about tasks as we start configuring them in the later recipes in this chapter.</li></ul></div><p>Navigate to the <span class="strong"><strong>General</strong></span> tab. This tab allows you to specify the release name format. The names of releases for a release definition are, by default, sequentially numbered. The first release is named <code class="literal">Release-1</code>, the next release is <code class="literal">Release-2</code>, and so on. You can change this naming scheme by editing the release name format mask. The field supports the use of predefined (listed in the following table). You can also use custom variables; we'll be covering more on variables in the <span class="emphasis"><em>Configuring global and local variables for a release</em></span> recipe:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Variable</p>
</th><th valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td valign="top">
<p><code class="literal">Rev:rr</code></p>
</td><td valign="top">
<p>An auto-incremented number with at least the specified number of digits.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Date</code>/<code class="literal">Date:MMddyy</code></p>
</td><td valign="top">
<p>The current date, with the default format MMddyy. Any combinations of M/MM/MMM/MMMM, d/dd/ddd/dddd, y/yy/yyyy/yyyy, h/hh/H/HH, m/mm, s/ss are supported.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">System.TeamProject</code></p>
</td><td valign="top">
<p>The name of the Team Project to which this build belongs.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Release.ReleaseId</code></p>
</td><td valign="top">
<p>The<a id="id706" class="indexterm"/> ID <a id="id707" class="indexterm"/>of the release is unique across all releases in the project.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Release.DefinitionName</code></p>
</td><td valign="top">
<p>The name of the release definition to which the current release belongs.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Build.BuildNumber</code></p>
</td><td valign="top">
<p>The number of the build contained in the release. If a release has multiple builds, this is the number of the build that triggered the release in the case of continuous deployment or the number of the first build in the case of a manual trigger.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Build.DefinitionName</code></p>
</td><td valign="top">
<p>The definition name of the build contained in the release. If a release has multiple builds, this is the definition name of the build that triggered the release in the case of continuous deployment or the definition name of the first build in the case of a manual trigger.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Artifact.ArtifactType</code></p>
</td><td valign="top">
<p>The type of the artifact source linked with the release. For example, this can be Team build or Jenkins.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Build.SourceBranch</code></p>
</td><td valign="top">
<p>The branch for which the build in the release was queued. For Git, this is the name of the branch in the form <code class="literal">refs/heads/master</code>. For Team Foundation Version Control, this is the root server path for the workspace in the <code class="literal">form$/teamproject/branch</code>. This variable is not set in the case of Jenkins artifact sources.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">Custom variable</code></p>
</td><td valign="top">
<p>The value of a global configuration property defined in the release definition.</p>
</td></tr></tbody></table></div><p>The <span class="strong"><strong>History</strong></span> <a id="id708" class="indexterm"/>tab shows you the list of changes<a id="id709" class="indexterm"/> made to a release definition since its creation. You also have the ability to differentiate the changes between the two revisions of changes to a release definition. The <span class="strong"><strong>Artifacts</strong></span> tab allows you to map the different artifacts that need to be deployed as part of the release definition; you'll be learning about the functions of the <span class="strong"><strong>Artifacts</strong></span> tab in the <span class="emphasis"><em>Mapping artifacts to a release definition</em></span> recipe. The <span class="strong"><strong>Configuring</strong></span> tab allows you to configure variables for your release definitions; you'll learn about the functions of the <span class="strong"><strong>Configuration</strong></span> tab in the <span class="emphasis"><em>Adding and configuring environments in a release definition</em></span> recipe. The <span class="strong"><strong>Triggers</strong></span> tab enables you to configure the release as a continuous deployment by setting the trigger as a continuous integration. This configuration triggers the release process whenever there is a change to the underlying artifacts mapped to the release definition. You'll learn more about this in the <span class="emphasis"><em>Configuring a release definition for a continuous deployment</em></span> recipe.</p></div></div>
<div class="section" title="Mapping artifacts to a release definition"><div class="titlepage" id="aid-28FAO2"><div><div><h1 class="title"><a id="ch06lvl1sec69"/>Mapping artifacts to a release definition</h1></div></div></div><p>The<a id="id710" class="indexterm"/> release definition allows you to deploy <a id="id711" class="indexterm"/>an application into multiple environments. The files and installers required to deploy an application are referred to as artifacts. At present, release management understands artifacts from Team build, Jenkins, and on-premises TFS. A release definition can have one or more artifacts. This flexibility is extremely useful for Teams building software in modules that are pulled together to form a release. In this recipe, you'll learn how to map the output from a Team build definition into a release definition.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec190"/>Getting ready</h2></div></div></div><p>To edit a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p><p>Scenario: FabrikamTFVC Team has two build definitions, namely, <code class="literal">FabrikamTFVC.Website</code> and <code class="literal">FabrikamTFVC.Services</code>. Website and services are two components of the same application; these components need to be rolled out together in the release. To enable this scenario, the FabrikamTFVC Team needs to map the installers from <code class="literal">FabrikamTFVC.Website</code> and <code class="literal">FabrikamTFVC.Services</code> into the release definition FabrikamTFVC Web:</p><div class="mediaobject"><img src="../Images/image00729.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>You can follow the steps in the <span class="emphasis"><em>Creating a continuous integration build definition in TFBuild</em></span> recipe of <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span>. Follow the <a id="id712" class="indexterm"/>steps in the <span class="emphasis"><em>Creating a release definition in Team Web Portal</em></span> <a id="id713" class="indexterm"/>recipe, to create the FabrikamTFVC Web release definition.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec191"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Release</strong></span> hub in FabrikamTFVC Team Project and edit the release definition FabrikamTFVC Web. As illustrated in the following screenshot, the release definition prompts you to link a build definition to this release:<div class="mediaobject"><img src="../Images/image00730.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the link to build definition hyperlink, set the artifact type as <span class="strong"><strong>Build</strong></span>, and choose the <span class="strong"><strong>FabrikamTFVC.Services</strong></span> build definition. The text at the bottom tells you the artifacts being published by this build definition. Click on <span class="strong"><strong>OK</strong></span> to finish mapping the <code class="literal">FabrikamTFVC.Services</code> build definition to FabrikamTFVC Web release definition:<div class="mediaobject"><img src="../Images/image00731.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, navigate<a id="id714" class="indexterm"/> to the <span class="strong"><strong>Artifacts</strong></span> tab; you'll <a id="id715" class="indexterm"/>see that the <span class="strong"><strong>FabrikamTFVC.Services</strong></span> build definition shows up as an artifact source for this release definition:<div class="mediaobject"><img src="../Images/image00732.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Link an artifact source</strong></span> to map the build definition of <span class="strong"><strong>FabrikamTFVC.Website</strong></span> to this release definition. Once done, you'll see both <span class="strong"><strong>FabrikamTFVC.Services</strong></span> and <span class="strong"><strong>FabrikamTFVC.Website</strong></span> show up as an artifact source for this release definition. Click on <span class="strong"><strong>Save</strong></span> to commit the changes to the build definition:<div class="mediaobject"><img src="../Images/image00733.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec192"/>How it works...</h2></div></div></div><p>The artifacts<a id="id716" class="indexterm"/> in a release definition allow you to truly build <a id="id717" class="indexterm"/>once and deploy everywhere. The artifacts are mapped at the release definition level and are available to all environments in a release definition.</p><p>When queuing a release, you have an option to select the version of the build to be used in the release. As illustrated in the following screenshot, you can choose the version of the builds used in this release. These artifacts are available across all selected environments. The version of the artifact cannot be changed once a release has been triggered from a release definition:</p><div class="mediaobject"><img src="../Images/image00734.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>As illustrated in the preceding screenshot, you can directly trigger a release from a build. Choosing release from the build opens up the queue release option allowing you to choose the version of other artifacts and the environments that the build needs to be deployed to. You can enjoy this truly integrated experience when you choose Team build as the artifact for the release definition:</p><div class="mediaobject"><img src="../Images/image00735.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>When a release <a id="id718" class="indexterm"/>is triggered, the selected versions of the <a id="id719" class="indexterm"/>artifacts are downloaded into the agent working directory. Tasks running within that environment can then deploy the artifacts. The artifact download behavior can be customized; you can skip the download of the artifact to the agent for a particular environment. This can be done by setting the <span class="strong"><strong>Skip artifacts download</strong></span> flag in the <span class="strong"><strong>General</strong></span> settings of an environment:</p><div class="mediaobject"><img src="../Images/image00736.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="There is more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec193"/>There is more...</h2></div></div></div><p>Release management currently supports Team build, Jenkins, on-premises TFS, and other sources as valid artifact sources. The source needs to be added as a service endpoint from the Team Administration Console. As illustrated in the following screenshot, you must create a service endpoint for Jenkins using the Jenkins endpoint and specifying connectivity details. Once the Jenkins connection endpoint has been successfully added, you can choose Jenkins as an artifact type in the release definition:</p><div class="mediaobject"><img src="../Images/image00737.jpeg" alt="There is more..."/></div><p style="clear:both; height: 1em;"> </p><p>Release <a id="id720" class="indexterm"/>management also supports adding other <a id="id721" class="indexterm"/>artifact sources. This option is suitable if you want to connect to sources such as Team City, NuGet repository, or file share.</p></div></div>
<div class="section" title="Configuring a release definition for a continuous deployment" id="aid-29DRA1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec70"/>Configuring a release definition for a continuous deployment</h1></div></div></div><p>A continuous deployment <a id="id722" class="indexterm"/>is a software<a id="id723" class="indexterm"/> engineering approach in which Teams deploy incremental changes to software as they are committed to a repository. It aims at building, testing, and releasing software faster and more frequently. A release definition already stores details of systems generating the artifacts that need to be deployed. A release definition can be configured to trigger a release when a new version of the artifact is available. In this recipe, you'll learn how to configure the release definition to trigger a new release when a new artifact version is available.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec194"/>Getting ready</h2></div></div></div><p>To edit a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p><p>Scenario: The FabrikamTFVC Team has mapped <span class="strong"><strong>FabrikamTFVC.Website</strong></span> and <span class="strong"><strong>FabrikamTFVC.Services</strong></span> to the release definition of FabrikamTFVC Web. The Team now wants the FabrikamTFVC release definition to automatically trigger a new release when a new successful build is available for <span class="strong"><strong>FabrikamTFVC.Services</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec195"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Release</strong></span> hub in the FabrikamTFVC Team Project and edit the release definition FabrikamTFVC Web. Click on the <span class="strong"><strong>Triggers</strong></span> tab to configure the triggers for this release definition:<div class="mediaobject"><img src="../Images/image00738.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Check the <a id="id724" class="indexterm"/><span class="strong"><strong>Continuous deployment</strong></span> checkbox and select <span class="strong"><strong>FabrikamTFVC.Services</strong></span> as the trigger for <a id="id725" class="indexterm"/>artifact source label. Also select the environments you would like the release to be automatically deployed to. It is a common scenario to continuously deploy all changes to a selected environment; however, release management gives you the option to select one or more environments for continuous deployment. Click on <span class="strong"><strong>Save</strong></span> to commit the changes:<div class="mediaobject"><img src="../Images/image00739.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the <span class="strong"><strong>Build</strong></span> hub and queue a new build for <span class="strong"><strong>FabrikamTFVC.Services</strong></span>. Once <span class="strong"><strong>FabrikamTFVC.Services</strong></span> is completed successfully, a release from the release definition FabrikamTFVC Web is triggered. A new release will not trigger if the <span class="strong"><strong>FabrikamTFVC.Services</strong></span> option fails:<div class="mediaobject"><img src="../Images/image00740.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec196"/>How it works…</h2></div></div></div><p>The FabrikamTFVC<a id="id726" class="indexterm"/> release definition is <a id="id727" class="indexterm"/>now configured to detect when a new artifact is available in the <span class="strong"><strong>FabrikamTFVC.Services</strong></span> build definition. Under the hood, this configuration sets up a queue between the build and release definition. A successful built-in <span class="strong"><strong>FabrikamTFVC.Services</strong></span> generates an event; as soon as the receiver in FabrikamTFVC Web release definition receives this event, it triggers a new release.</p><p>The release will trigger sequentially in all the selected environments. At present, you cannot set up triggers to automatically deploy to multiple environments in parallel. It is expected that in future, REST APIs will be available to trigger releases remotely from other systems.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec197"/>There's more...</h2></div></div></div><p>While <span class="strong"><strong>FabrikamTFVC.Services</strong></span> does not need to be a continuous integration build, even if it is manually triggered, as long as a new successful build artifact is produced by the build the release will be trigged. You can optionally set the build as continuous integration from the <span class="strong"><strong>Build</strong></span> hub as illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00741.jpeg" alt="There's more..."/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Adding and configuring environments in a release definition"><div class="titlepage" id="aid-2ACBS2"><div><div><h1 class="title"><a id="ch06lvl1sec71"/>Adding and configuring environments in a release definition</h1></div></div></div><p>A release definition <a id="id728" class="indexterm"/>is composed of a collection of <a id="id729" class="indexterm"/>environments. An environment is a <a id="id730" class="indexterm"/>logical container that holds information on <a id="id731" class="indexterm"/>where a release needs to be deployed and how it needs to be deployed. The environment can be a collection of server(s) on premises, in the cloud, multiple clouds, or an app store. The steps used to deploy the application on each environment can be the same or different. The deployment steps in an environment are described using tasks. In this recipe, you'll learn how to add and configure environments.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec198"/>Getting ready</h2></div></div></div><p>To edit a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p><p>Scenario: The FabrikamTFVC Team has a collection of servers categorized as development, QA, staging, and production environments. The Team wants the ability to deploy the application across all environments in a single release process. Each environment has different owners and approvers. The Team wants the release definition to be configured such that developers can approve the release into the development environment; the QA approves all releases in the QA environment. Both the QA and Release Manager approve releases in staging (pre-production). The Release Manager approves production releases:</p><div class="mediaobject"><img src="../Images/image00742.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec199"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id732" class="indexterm"/> to the <span class="strong"><strong>Release</strong></span> hub in<a id="id733" class="indexterm"/> FabrikamTFVC<a id="id734" class="indexterm"/> Team Project and edit <a id="id735" class="indexterm"/>the release definition FabrikamTFVC Web. Rename the default environment to <span class="strong"><strong>Development</strong></span>:<div class="mediaobject"><img src="../Images/image00743.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Launch the context menu by clicking on the ellipsis to configure the development environment. From the context menu, choose <span class="strong"><strong>Assign approvers...</strong></span>:<div class="mediaobject"><img src="../Images/image00744.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">This window allows you to configure the approvers for pre-deployment and post-deployment approval as well as set up an overall environment owner and choose to enable e-mail notifications. Click on <span class="strong"><strong>OK</strong></span> to save the configured changes. This screen allows adding both individual user accounts as well as groups as approvers and owners:<div class="mediaobject"><img src="../Images/image00745.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You can<a id="id736" class="indexterm"/> now click on the <span class="strong"><strong>+</strong></span> icon to <a id="id737" class="indexterm"/>add deployment<a id="id738" class="indexterm"/> tasks to the development<a id="id739" class="indexterm"/> environment. Adding and configuring tasks will be covered in future recipes.</li><li class="listitem">From the development environment, launch the context menu by clicking on the ellipsis. From the context menu, choose <span class="strong"><strong>Save as template...</strong></span>:<div class="mediaobject"><img src="../Images/image00746.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Give the Deployment Template a name and description as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00747.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <a id="id740" class="indexterm"/>the <span class="strong"><strong>+</strong></span> icon to add an<a id="id741" class="indexterm"/> environment. This will launch<a id="id742" class="indexterm"/> the Deployment <a id="id743" class="indexterm"/>Template window. As illustrated in the following screenshot, you'll see a new <span class="strong"><strong>Custom</strong></span> tab. This tab will list all Custom Templates saved by the Team. Select and add this template; it will add a new environment with the approval configuration setup in step 3:<div class="mediaobject"><img src="../Images/image00748.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, add a new environment for QA, staging, and production, and set the approvers as indicated in the diagram in the <span class="emphasis"><em>Getting ready</em></span> section of this recipe. As illustrated in the following screenshot, each environment has symbols that provide useful information:<div class="mediaobject"><img src="../Images/image00749.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">This<a id="id744" class="indexterm"/> shows the <a id="id745" class="indexterm"/>count <a id="id746" class="indexterm"/>of tasks in <a id="id747" class="indexterm"/>an environment. At present, there are 0 tasks in this QA environment.</li><li class="listitem">This shows the count of approvers in an environment. At present, there are four approvers set up for the staging environment.</li><li class="listitem">This shows the count of variables in an environment. At present, there are 0 variables set up for the production environment.</li></ul></div></li><li class="listitem">Click on the ellipsis in the environment to launch the context menu. From the context menu, select <span class="strong"><strong>Clone Environment</strong></span>. This will clone the selected environment into a new environment. This is great when you want to copy an existing environment without saving it as a template.</li><li class="listitem">Security can also be configured at the environment level. Select an environment and launch the security configuration from the context menu. This screen allows you to configure permissions specific to the environment such as which groups can delete a release environment, edit a release environment, manage release approvers, and administer the release permissions:<div class="mediaobject"><img src="../Images/image00750.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The<a id="id748" class="indexterm"/> agent used for deploying <a id="id749" class="indexterm"/>an environment<a id="id750" class="indexterm"/> can also be configured at<a id="id751" class="indexterm"/> the environment level. Select <span class="strong"><strong>Agent options...</strong></span> from the environment context menu:<div class="mediaobject"><img src="../Images/image00751.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>The <span class="strong"><strong>Agent options</strong></span> window has various configuration options such as whether artifacts should be downloaded, which agent to use, and agent demands. The <span class="strong"><strong>Variables</strong></span> tab allows you to specify the variables for this environment:</p><div class="mediaobject"><img src="../Images/image00752.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>Having<a id="id752" class="indexterm"/> the ability to <a id="id753" class="indexterm"/>configure the agent per <a id="id754" class="indexterm"/>environment<a id="id755" class="indexterm"/> is extremely useful if the environment you are trying to deploy the application to is in a secure network that is only accessible to a special agent. You can use the configure queue option to select the queue that has the agent you need to use for this deployment.</p></li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span> to commit the changes. Queue a new release for this release definition by clicking on the <span class="strong"><strong>+</strong></span> icon:<div class="mediaobject"><img src="../Images/image00753.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec200"/>How it works...</h2></div></div></div><p>This queues a new release for the release definition FabrikamTFVC Web. As illustrated in the <span class="strong"><strong>Environments</strong></span> column, the release represents each environment with a line. The icon pre-fixed before the first gray line shows that the release in this environment is pending approval:</p><div class="mediaobject"><img src="../Images/image00754.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>Double-click on the release to navigate to the log <span class="strong"><strong>Summary</strong></span> tab for this release. You can see that the release is pending approval for deployment into the <span class="strong"><strong>Development</strong></span> environment:</p><div class="mediaobject"><img src="../Images/image00755.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>The <span class="strong"><strong>Development</strong></span> <a id="id756" class="indexterm"/>environment was configured for <a id="id757" class="indexterm"/>pre-approval before deploying the <a id="id758" class="indexterm"/>application. The environment was also<a id="id759" class="indexterm"/> configured to send out e-mail notification. As per the configuration, the environment sends out an e-mail notification:</p><div class="mediaobject"><img src="../Images/image00756.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>The release is kicked off once the release pre-approval is granted:</p><div class="mediaobject"><img src="../Images/image00757.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>When multiple <a id="id760" class="indexterm"/>approvers are specified, each of <a id="id761" class="indexterm"/>the approvers will be notified in<a id="id762" class="indexterm"/> sequence. All the listed approvers must<a id="id763" class="indexterm"/> approve the deployment before it continues. If you specify a group as an approver, the entire group is notified when there is a pending approval. However, only one user in the group needs to approve or reject the deployment.</p><p>The summary view gives you an overall summary of the release:</p><div class="mediaobject"><img src="../Images/image00758.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>The <span class="strong"><strong>Logs</strong></span> view gives you a full break down of all actions performed in an environment:</p><div class="mediaobject"><img src="../Images/image00759.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>This is great for<a id="id764" class="indexterm"/> identifying the bottlenecks in your<a id="id765" class="indexterm"/> release process. We'll cover<a id="id766" class="indexterm"/> release tracking in more detail in the<a id="id767" class="indexterm"/> <span class="emphasis"><em>Tracking a release i</em></span>
<span class="emphasis"><em>n release management</em></span> recipe.</p></div></div>
<div class="section" title="Configuring security for release definitions" id="aid-2BASE1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec72"/>Configuring security for release definitions</h1></div></div></div><p>Like other<a id="id768" class="indexterm"/> modules in TFS, release management<a id="id769" class="indexterm"/> also uses the role-based permission model for security. Permissions define the authorizations that can be granted or denied to users and groups. In this recipe, you'll learn about the different levels at which security can be applied for release management.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec201"/>Getting ready</h2></div></div></div><p>To administer the permissions for release management, you need to have <span class="strong"><strong>Administer release permissions</strong></span> set to <span class="strong"><strong>Allow</strong></span>. This is, by default, set to <span class="strong"><strong>Allow</strong></span> for members of the Project Administrators and Release Administrators Group:</p><div class="mediaobject"><img src="../Images/image00760.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec202"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Release</strong></span> hub in FabrikamTFVC Team Project. From the <span class="strong"><strong>All release definitions</strong></span> context menu, choose <span class="strong"><strong>Security...</strong></span> to open the permission dialog. This will allow you to administer the permissions for all release definitions in the Team Project:<div class="mediaobject"><img src="../Images/image00761.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>The permissions dialog shows groups, users, and permissions. The permission dialog can be used to change permissions for groups as well as add new users and groups to these groups:</p><div class="mediaobject"><img src="../Images/image00762.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the <a id="id770" class="indexterm"/>previous step, we saw how to <a id="id771" class="indexterm"/>manage security for <span class="strong"><strong>All release definitions</strong></span>. To manage the security for a specific release definition, open the context menu for this release definition and choose <span class="strong"><strong>Security...</strong></span> from the context menu:<div class="mediaobject"><img src="../Images/image00763.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>The permissions dialog allows you to manage the permissions for existing, new users, and groups for this specific release definition.</p></li><li class="listitem">So far, we <a id="id772" class="indexterm"/>have seen how to apply <a id="id773" class="indexterm"/>security to all release definitions and a specific release definition. Release management also allows applying security on environments within a release definition. Edit FabrikamTFVC Web release definition from the <span class="strong"><strong>Environment</strong></span> context menu and select <span class="strong"><strong>Security...</strong></span>:<div class="mediaobject"><img src="../Images/image00764.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p>The permissions dialog allows you to manage the permissions for existing, new users, and groups for this specific environment.</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec203"/>How it works…</h2></div></div></div><p>Release <a id="id774" class="indexterm"/>management contains a hierarchical<a id="id775" class="indexterm"/> role-based permission model. The following table summarizes the permissions and the hierarchy to which it can be applied:</p><div class="informaltable"><table border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th valign="bottom">
<p>Permission</p>
</th><th valign="bottom">
<p>Description</p>
</th><th valign="bottom">
<p>Scope</p>
</th></tr></thead><tbody><tr><td valign="top">
<p>Administer release permissions</p>
</td><td valign="top">
<p>Can change any of the other permissions</p>
</td><td valign="top">
<p>Project, release definition, and environment</p>
</td></tr><tr><td valign="top">
<p>Delete release definition</p>
</td><td valign="top">
<p>Can delete release definition(s)</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr><tr><td valign="top">
<p>Delete release environment</p>
</td><td valign="top">
<p>Can delete environment(s) in release definition(s)</p>
</td><td valign="top">
<p>Project, release definition, and environment</p>
</td></tr><tr><td valign="top">
<p>Edit release definition</p>
</td><td valign="top">
<p>Can create and edit release definition(s), configuration variables, triggers, and artifacts</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr><tr><td valign="top">
<p>Edit release environment</p>
</td><td valign="top">
<p>Can edit environment(s) in release definition(s)</p>
</td><td valign="top">
<p>Project, release definition, and environment</p>
</td></tr><tr><td valign="top">
<p>Manage release approvers</p>
</td><td valign="top">
<p>Can add or edit approvers for environment(s) in release definition(s)</p>
</td><td valign="top">
<p>Project, release definition, and environment</p>
</td></tr><tr><td valign="top">
<p>Manage releases</p>
</td><td valign="top">
<p>Can edit the configuration in releases, and can start, stop, or restart release deployments</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr><tr><td valign="top">
<p>Queue releases</p>
</td><td valign="top">
<p>Can create new releases</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr><tr><td valign="top">
<p>View release definition</p>
</td><td valign="top">
<p>Can view release definition(s)</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr><tr><td valign="top">
<p>View releases</p>
</td><td valign="top">
<p>Can view releases belonging to release definition(s)</p>
</td><td valign="top">
<p>Project and release definition</p>
</td></tr></tbody></table></div><p>The default values for all of these permissions are set for all Team Project collection and Team Project groups. For example, Project Collection Administrators, Project Administrators, and Release Administrators are given all of the preceding permissions by default. Project Contributors are given all permissions except <span class="strong"><strong>Administer release permissions</strong></span>. Project Readers, by default, are denied all permissions except <span class="strong"><strong>View release definitions</strong></span> and <span class="strong"><strong>View releases</strong></span>.</p></div></div>
<div class="section" title="Configuring global and local variables for a release"><div class="titlepage" id="aid-2C9D02"><div><div><h1 class="title"><a id="ch06lvl1sec73"/>Configuring global and local variables for a release</h1></div></div></div><p>Variables are used to<a id="id776" class="indexterm"/> store values that need to be passed into<a id="id777" class="indexterm"/> tasks during the release. There are <a id="id778" class="indexterm"/>various advantages of using variables over<a id="id779" class="indexterm"/> hardcoding these values directly in tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Variables support encrypting values in a way that they cannot be seen or changed by users of a release definition</li><li class="listitem">Storing values in variables helps avoid duplication</li><li class="listitem">Variables can be shared across all environments</li><li class="listitem">Variables can be shared across all tasks within a specific environment</li></ul></div><p>In this recipe, you'll learn how to configure release and environment variables for a release definition.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec204"/>Getting ready</h2></div></div></div><p>To edit a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p><p>Scenario: The FabrikamTFVC Team uses Azure blob storage for storing files that are needed by the FabrikamTFVC Web release definition. The Team would like the ability to access the blob storage connection details from across the release definition. The Team also need to store the connection string details that are required by one of the tasks in the environment. The value for the connection string is different per environment. The Team would like to store these values securely so that the connection string details are not available in plain text:</p><div class="mediaobject"><img src="../Images/image00765.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec205"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <a id="id780" class="indexterm"/><span class="strong"><strong>Release</strong></span> hub in FabrikamTFVC<a id="id781" class="indexterm"/> Team Project and<a id="id782" class="indexterm"/> edit the release definition <a id="id783" class="indexterm"/>FabrikamTFVC Web. Click on the <span class="strong"><strong>Configuration</strong></span> tab. The <span class="strong"><strong>Configuration</strong></span> tab allows you add variables that can be shared across the release definition:<div class="mediaobject"><img src="../Images/image00766.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> icon to add a variable. Add the connection details for the Azure blob storage as illustrated in the following screenshot. Click on the padlock icon next to the property. The values of such properties are stored securely and cannot be viewed by users once they are saved. During a deployment, the release management service decrypts those values that are referenced by the tasks and passes them to the agent over a secure HTTPS channel:<div class="mediaobject"><img src="../Images/image00767.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to<a id="id784" class="indexterm"/> the <span class="strong"><strong>Environment</strong></span><a id="id785" class="indexterm"/> tab, click on the ellipsis in the <a id="id786" class="indexterm"/><span class="strong"><strong>Development</strong></span> environment, and <a id="id787" class="indexterm"/>select <span class="strong"><strong>Configure variables...</strong></span> from the context menu:<div class="mediaobject"><img src="../Images/image00768.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> icon to add a variable. Add the connection string details and click on the padlock icon to hide the connection string. Add another variable for storing the database name. Follow this step to configure these variables for all other environments:<div class="mediaobject"><img src="../Images/image00769.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, navigate to the <span class="strong"><strong>Configuration</strong></span> tab and change the variable type from the top right-hand side to <span class="strong"><strong>Environment variables</strong></span>:<div class="mediaobject"><img src="../Images/image00770.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">This <a id="id788" class="indexterm"/>shows a list of all the <a id="id789" class="indexterm"/>environment variables and their values<a id="id790" class="indexterm"/> for <a id="id791" class="indexterm"/>all environments:<div class="mediaobject"><img src="../Images/image00771.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You can filter out the environments that you do not want to see the environment variables for by selecting the checklist next to the view list:<div class="mediaobject"><img src="../Images/image00772.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec206"/>How it works…</h2></div></div></div><p>In this recipe, we configured variables at release and environment levels. Variables that are defined at the release level are available to all tasks across all environments in the release definition. Variables that are defined at the environment level are only available to tasks within this environment; these variables cannot be accessed by other environments. Using the view type option in the configuration view, you can view both release as well as environment variables. You can click the padlock icon next to the property to hide the value of the property. The values of such properties are stored securely and cannot be viewed by users once they are saved. During a deployment, the release management service decrypts the values that are referenced by the tasks and passes them to the agent over a secure HTTPS channel. You can reference the variables in the task using the <code class="literal">$(variablename)</code> format. Apart from using custom variables, you can also use the <a id="id792" class="indexterm"/>built-in variables; a full list of built-in<a id="id793" class="indexterm"/> variables <a id="id794" class="indexterm"/>can <a id="id795" class="indexterm"/>be found at <a class="ulink" href="http://bit.ly/1ON0Usg">http://bit.ly/1ON0Usg</a>.</p></div></div>
<div class="section" title="Deploying an Azure website using release management"><div class="titlepage" id="aid-2D7TI2"><div><div><h1 class="title"><a id="ch06lvl1sec74"/>Deploying an Azure website using release management</h1></div></div></div><p>In this recipe, you'll <a id="id796" class="indexterm"/>learn how to deploy an Azure <a id="id797" class="indexterm"/>website from a release definition.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec207"/>Getting ready</h2></div></div></div><p>To create a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p><p>Scenario: The <span class="strong"><strong>FabrikamTFVC.Website</strong></span> build definition produces a web package as an artifact. The FabrikamTFVC Team wants to deploy the web package to an Azure website:</p><div class="mediaobject"><img src="../Images/image00773.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Ensure you have an active Azure Cloud subscription. Download your Azure publish settings file from <a class="ulink" href="https://manage.windowsazure.com/publishsettings">https://manage.windowsazure.com/publishsettings</a>. Set up an Azure website. In this recipe, we'll be using <code class="literal">https://fabrikamTFVC-dev.azurewebsites.net/</code>.</p><p>Navigate to the<a id="id798" class="indexterm"/> FabrikamTFVC <a id="id799" class="indexterm"/>Team Administration Console. Click on the <span class="strong"><strong>Services</strong></span> tab and create a new endpoint. From the services endpoint context menu, select <span class="strong"><strong>Azure</strong></span>. Change the connection type to <span class="strong"><strong>Certificate Based</strong></span>. Copy the details from the Azure publish settings file and populate the Azure endpoint connection details. Click on <span class="strong"><strong>Save</strong></span> to create the Azure endpoint:</p><div class="mediaobject"><img src="../Images/image00774.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Navigate to the <span class="strong"><strong>Build</strong></span> hub in the FabrikamTFVC Team Project. Edit the FabrikamTFVC build definition, if you don't already have this build definition refer to the <span class="emphasis"><em>Creating a continuous integration build definition in TFBuild</em></span> recipe in <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span> to learn how to create a build definition. In the Visual Studio Build Task, configure the following <code class="literal">MSBuild Arguments</code>:</p><div class="informalexample"><pre class="programlisting">/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true</pre></div><p>Configure the <span class="strong"><strong>Copy and Publish Build Artifacts</strong></span> task to publish the contents of the web deployment package. This can be done by setting the following configuration:</p><div class="mediaobject"><img src="../Images/image00775.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Save the changes and queue a build. Once the build successfully completes, you can see the web deployment package from the artifact explorer:</p><div class="mediaobject"><img src="../Images/image00776.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Now, we have a working Azure subscription and an Azure website (<a class="ulink" href="https://fabrikamTFVC-dev.azurewebsites.net">https://fabrikamTFVC-dev.azurewebsites.net</a>). We have an Azure service endpoint as well as a build definition generating a web deployment package as an artifact.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec208"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id800" class="indexterm"/> to the <span class="strong"><strong>Release</strong></span> hub<a id="id801" class="indexterm"/> for the FabrikamTFVC Team. Click on the <span class="strong"><strong>+</strong></span> icon to create a new release definition. Select the <span class="strong"><strong>Azure Website Deployment</strong></span> Template:<div class="mediaobject"><img src="../Images/image00777.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The <span class="strong"><strong>Azure Website Deployment</strong></span> templates adds a default environment with the <span class="strong"><strong>Azure Web App Deployment*</strong></span> and <span class="strong"><strong>Visual Studio Test</strong></span> tasks:<div class="mediaobject"><img src="../Images/image00778.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select <a id="id802" class="indexterm"/><span class="strong"><strong>Azure Web App Deployment*</strong></span> task and configure the values as illustrated in the following <a id="id803" class="indexterm"/>screenshot. Select the Azure subscription configured as a service endpoint. Select the location where the web app <code class="literal">FabrikamTFVC-dev</code> was created. Specify the path to the web deployment package within the artifact repository:<div class="mediaobject"><img src="../Images/image00779.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span> to commit the changes to this release definition. Create a new release.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec209"/>How it works…</h2></div></div></div><p>The release agent uses the Azure service endpoint to securely publish the web deployment package to the <code class="literal">FabrikamTFVC-dev</code> website. The log tab in the release shows the full summary of processing:</p><div class="mediaobject"><img src="../Images/image00780.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The service <a id="id804" class="indexterm"/>endpoint has two permission<a id="id805" class="indexterm"/> groups, namely, <span class="strong"><strong>Endpoint Administrators</strong></span> and <span class="strong"><strong>Endpoint Readers</strong></span>. Individuals who need to manage this build definition should also be part of the Endpoint Administrators Group, others can be part of the Endpoint Readers Group:</p><div class="mediaobject"><img src="../Images/image00781.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Deploying the IIS Web Application using release management"><div class="titlepage" id="aid-2E6E42"><div><div><h1 class="title"><a id="ch06lvl1sec75"/>Deploying the IIS Web Application using release management</h1></div></div></div><p>In this recipe, you'll learn <a id="id806" class="indexterm"/>how to deploy the IIS <a id="id807" class="indexterm"/>Web Application using release management.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec210"/>Getting ready</h2></div></div></div><p>Scenario: The FabrikamTFVC Team has a collection of servers in the <code class="literal">Fabrikam.lab</code> domain that they need to perform IIS Web Application Deployment on.</p><div class="section" title="Where does it need to be installed?"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Where does it need to be installed?</h3></div></div></div><p>As illustrated in the following figure, the servers are in the same domain <code class="literal">Fabrikam.lab</code>. The IIS Web Application Deployment needs to take place on two servers, namely, <code class="literal">QA-Web1.Fabrikam.lab</code> and <code class="literal">QA-Web2.Fabrikam.lab</code>:</p><div class="mediaobject"><img src="../Images/image00782.jpeg" alt="Where does it need to be installed?"/></div><p style="clear:both; height: 1em;"> </p><p>The agent uses WinRM protocol to connect to the machines in the Machine Groups. WinRM needs to be enabled on a machine as a prerequisite before it can be added into the Machine Group. Follow the <span class="emphasis"><em>Creating and setting up a Machine Group</em></span> recipe in <a class="link" title="Chapter 5. Testing Your Application" href="part0062.xhtml#aid-1R42S1">Chapter 5</a>, <span class="emphasis"><em>Testing Your Application</em></span>, to set up the Fabrikam-QA Machine Group. The machines in the Machine Group the website will be deployed to need to meet the following prerequisites:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Web Deploy 3.5 or higher</li><li class="listitem">IIS Web should already be installed and configured</li><li class="listitem">.NET 2 and .NET 4 should be registered with IIS using <code class="literal">aspnet_iisreg -i</code></li></ul></div></div><div class="section" title="What needs to be installed?"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec13"/>What needs to be installed?</h3></div></div></div><p>To deploy a <a id="id808" class="indexterm"/>web application on <a id="id809" class="indexterm"/>IIS, the Web Deployment Package needs to be available locally on the destination machines. You can either manually copy the Web Deployment Package on the destination machine or make it available on a UNC that is reachable from the destination machines. In this recipe, we will configure the build definition to generate the Web Deployment Package and copy it across to all destination machines.</p><p>Navigate to the <span class="strong"><strong>Build</strong></span> hub in the FabrikamTFVC Team Project. Edit the <code class="literal">FabrikamTFVC.Website</code> build definition. If you don't already have this build definition, refer to the <span class="emphasis"><em>Creating a continuous integration build definition in TFBuild</em></span> recipe in <a class="link" title="Chapter 4. Building Your Application" href="part0050.xhtml#aid-1FLS42">Chapter 4</a>, <span class="emphasis"><em>Building Your Application</em></span>, to learn how to create a build definition.</p><p>As illustrated in the following screenshot in the Visual Studio Build task, configure the following MSBuild arguments:</p><div class="informalexample"><pre class="programlisting">/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.StagingDirectory)"</pre></div><p>We will now use the <span class="strong"><strong>Copy And Publish Build Artifacts</strong></span> task to upload the contents of <code class="literal">$(build.stagingDirectory)</code> as an artifact. The copy root is being set to <code class="literal">$(build.stagingDirectory)</code> since the Visual Studio Build task has MSBuild arguments specifying the Web Deployment Package to be copied to the <code class="literal">$(build.stagingDirectory)</code>. The <code class="literal">**\*</code> search pattern is used to copy all the contents of <code class="literal">$(build.stagingdirectory)</code>:</p><div class="mediaobject"><img src="../Images/image00783.jpeg" alt="What needs to be installed?"/></div><p style="clear:both; height: 1em;"> </p><p>We will now<a id="id810" class="indexterm"/> use the Windows Machine<a id="id811" class="indexterm"/> File Copy task to copy the contents of the <code class="literal">$(build.stagingDirectory)</code> to the target machines too. The machine names specified in the machine file need to have been configured for WinRM. Specify either a local folder on the destination server or a UNC that's accessible from the destination server. Check the option <span class="strong"><strong>Clean Target</strong></span> to have the older binaries in the destination folder location overwritten with new binaries. Also, check the <span class="strong"><strong>Copy Files in Parallel</strong></span> option to speed up the copy operations across multiple machines. From the <span class="strong"><strong>Variables</strong></span> tab, add two variables, namely, <code class="literal">machine.username</code> and <code class="literal">machine.password</code> for holding the login details for the machines you intend to have the files copied on to:</p><div class="mediaobject"><img src="../Images/image00784.jpeg" alt="What needs to be installed?"/></div><p style="clear:both; height: 1em;"> </p><p>Queue a build; once<a id="id812" class="indexterm"/> the build is successfully<a id="id813" class="indexterm"/> completed, navigate to the Artifacts Explorer. You should see the website binaries as illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00785.jpeg" alt="What needs to be installed?"/></div><p style="clear:both; height: 1em;"> </p><p>The same files should now be available locally on the destination machines in the <code class="literal">C:\Temp\FabrikamTFVC.Website</code> folder.</p><p>In this recipe, we'll create a new release definition specifically for deploying IIS Web Application and App Pool. To create a release definition, you need to be a member of the Release Administrators Group. These permissions are also available to the Project Administrators Group.</p></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec211"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id814" class="indexterm"/> to the <span class="strong"><strong>Release</strong></span><a id="id815" class="indexterm"/> hub in the FabrikamTFVC Team Project. Add a new release definition. Select an empty Deployment Template and name the definition FabrikamTFVC Web Server release definition. Rename the default environment to QA and add the IIS Web Application Deployment task to this environment:<div class="mediaobject"><img src="../Images/image00786.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the <span class="strong"><strong>QA</strong></span> environment, click on the ellipsis and select <span class="strong"><strong>Configure variables...</strong></span> from the context menu:<div class="mediaobject"><img src="../Images/image00787.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Add two variables, namely, <code class="literal">machine.username</code> and <code class="literal">machine.password</code> for this environment holding the login details for the machines where IIS needs to be deployed:<div class="mediaobject"><img src="../Images/image00788.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now to <a id="id816" class="indexterm"/>configure the IIS Web Application Deployment task, first specify the machines and the login details. We'll use the <code class="literal">machine.username</code> and <code class="literal">machine.password</code> variables defined in the previous step. Since we are in a closed domain group where WinRM is configured to use HTTP, select <span class="strong"><strong>HTTP</strong></span>:<div class="mediaobject"><img src="../Images/image00789.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, specify<a id="id817" class="indexterm"/> the location of the web deployment package. Since the web deployment package was copied using the machine file, copy the task using the build definition. You can directly specify the local destination machine location here. Optionally, you can specify the web deploy parameter file and override parameters to replace the website properties such as application name, connection string, database details, and so on, in the web configuration. Alternatively, you can also use the PowerShell script after the deployment to carry out the value replacements:<div class="mediaobject"><img src="../Images/image00790.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Check the <span class="strong"><strong>Create or Update Application Pool</strong></span> option and specify the application pool name, .NET version, pipeline mode, and identity for the application pool:<div class="mediaobject"><img src="../Images/image00791.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <a id="id818" class="indexterm"/><span class="strong"><strong>Save</strong></span> and<a id="id819" class="indexterm"/> trigger a release for this release definition. Wait for the release to complete. The summary view will show you the result of the release execution:<div class="mediaobject"><img src="../Images/image00792.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec212"/>How it works…</h2></div></div></div><p>First, let's check the results of the deployment on the destination machines. As illustrated in the following screenshot, <span class="strong"><strong>FabrikamAppPool</strong></span> has been created as per the specifications in the configuration:</p><div class="mediaobject"><img src="../Images/image00793.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The web deployment package has also been installed under the default website with the website binaries copied in the <code class="literal">C:\inetpub</code> folder:</p><div class="mediaobject"><img src="../Images/image00794.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The task <a id="id820" class="indexterm"/>uses the standard web <a id="id821" class="indexterm"/>deployment package functionality to deploy to IIS. Using WinRM allows the release management agent to orchestrate this workflow remotely. You can read more about the parameters and functionality of web deployment at <a class="ulink" href="http://bit.ly/1XT0yTq">http://bit.ly/1XT0yTq</a>.</p></div><div class="section" title="There is more"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec213"/>There is more</h2></div></div></div><p>The IIS Web Application Deployment task also has a <span class="strong"><strong>Create or Update Website</strong></span> section. This gives you far more granular control on specifying how the website is structured. You can use this to change the physical path of the website, configure the bindings to be used, as well as the protocol and ports along with host names:</p><div class="mediaobject"><img src="../Images/image00795.jpeg" alt="There is more"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Tracking a release in release management" id="aid-2F4UM1"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec76"/>Tracking a release in release management</h1></div></div></div><p>It is common to <a id="id822" class="indexterm"/>want to see the list of releases by status, check <a id="id823" class="indexterm"/>the status of a current release, track the approvals for a release, investigate the failures in logs, and view the details of the agent processing the release. In this recipe, you'll learn about all the release tracking features available in release management.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec214"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Release</strong></span> hub for the FabrikamTFVC Team. The landing page shows you a list of all release definitions. This is a quick way to see the status of releases. The view surfaces information about the status as well as the release definition, environments, build, branch, start time, and created by. Releases triggered using the continuous deployment configuration have an icon in the first column:<div class="mediaobject"><img src="../Images/image00796.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">This view can be filtered by the status of the releases. From the top-right corner, change the <span class="strong"><strong>State</strong></span> dropdown to <span class="strong"><strong>Rejected</strong></span>; this will narrow the list down to rejected releases:<div class="mediaobject"><img src="../Images/image00797.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Switch over<a id="id824" class="indexterm"/> to the <span class="strong"><strong>Overview</strong></span> tab. This <a id="id825" class="indexterm"/>will help you visualize the status of all the release definitions. As illustrated in the following screenshot, the last release for the <span class="strong"><strong>Fabrikam Website Release Pipeline</strong></span> definition failed while FabrikamTFVC Web Release was successful in the <span class="strong"><strong>Development</strong></span> environment, it failed in the <span class="strong"><strong>QA</strong></span> environment and no deployments have been attempted in <span class="strong"><strong>Staging</strong></span> and <span class="strong"><strong>Production</strong></span> using this pipeline. You can click on the ellipsis next to the release definition name to queue a new release, edit the definition, or manage the security for the release definition:<div class="mediaobject"><img src="../Images/image00798.jpeg" alt="How to do it…"/><div class="caption"><p>Fabrikam Website Release Pipeline showing the status of the Release-21 in the QA environment; FabrikamTFVC Web Release Pipeline showing the status of the Rel-FabrikamTFVC-3 across the environments</p></div></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Locate <span class="strong"><strong>Release-11</strong></span> and double-click on it to view the release. This opens the release summary view by default. The summary view shows you the details of the release, environments, issues, work Items, and test results. You can also restart or abandon the release from this view:<div class="mediaobject"><img src="../Images/image00799.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To dig<a id="id826" class="indexterm"/> into the issue further, either click<a id="id827" class="indexterm"/> on the error message or navigate to the log view. The log view lets you browse the logs by environment and task making it easier to investigate reasons for failure:<div class="mediaobject"><img src="../Images/image00800.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">You can hide the logs and narrow down the view to approvals or tasks only by changing the options from the top right:<div class="mediaobject"><img src="../Images/image00801.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The <span class="strong"><strong>Commits</strong></span> and <span class="strong"><strong>Work Items</strong></span> views in the release show you information about the code changes and Work Items associated to the artifacts processed as part of this release:<div class="mediaobject"><img src="../Images/image00802.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, navigate to the <span class="strong"><strong>Team Project Collection Administration</strong></span> page in Team Portal. Click on <span class="strong"><strong>Agents</strong></span> queues to see a list of builds and agents grouped by queue. The following screenshot illustrates all the builds and releases processed by the Fabrikam CI01 agent queue. You can directly browse to the failing builds and releases by clicking on the definition or name of the hyperlink:<div class="mediaobject"><img src="../Images/image00803.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec215"/>How it works…</h2></div></div></div><p>Release <a id="id828" class="indexterm"/>management gives you the ability to <a id="id829" class="indexterm"/>track the releases and narrow down the reasons for failure by drilling in through the various levels of hierarchy. Though there is no charting capability to pin the release status to the Dashboard yet, this area is set to review a good amount of investment over the next few releases; hopefully, enhancements to visualize the release pipelines will be taken care of as part of these investments.</p></div></div></body></html>