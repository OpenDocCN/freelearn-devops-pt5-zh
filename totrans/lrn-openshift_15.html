<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Building PHP Applications from Source Code</h1>
                
            
            <article>
                
<p class="calibre2">In the previous chapter, you learned how to build<span class="calibre11"> applications from Dockerfile, how to use</span><span class="calibre11"> <kbd class="calibre12">oc new-app</kbd> to initiate a Docker build, and finally, how to use</span><span class="calibre11"> <kbd class="calibre12">oc start-build</kbd> to start a new build from an existing build config.</span></p>
<p class="calibre2">In this chapter, we will discuss the most frequently used application images that are already available on Docker Hub. Every now and then, it is required to build a custom image that contains custom software or is aligned with company security policy/standards. You will learn how OpenShift automates the build process through a <strong class="calibre4">Source-to-Image</strong> (<strong class="calibre4">S2I</strong>) build strategy, which is one of its main advantages. You will also learn how it allows you to build an image from your application's source code and then run it as a container.</p>
<p class="calibre2">We will cover the following topics in this chapter:</p>
<ul class="calibre9">
<li class="calibre10">PHP S2I</li>
<li class="calibre10">Building a simple PHP application</li>
<li class="calibre10">Understanding the PHP build process</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Technical requirements</h1>
                
            
            <article>
                
<p class="calibre2">This chapter doesn't have strict requirements when it comes to the lab environment, so any OpenShift installation and development environment is supported—Minishift, <kbd class="calibre12">oc cluster up</kbd>, or a standard production-ready deployment based on Ansible. It is up to you which flavor to use. However, this chapter will focus on the <kbd class="calibre12">oc cluster up</kbd> method. The following Vagrantfile can be used to deploy our virtual lab:</p>
<pre class="calibre18">Vagrant.configure(2) do |config| <br class="title-page-name"/>  config.vm.define "openshift" do |conf| <br class="title-page-name"/>    conf.vm.box = "centos/7" <br class="title-page-name"/>    conf.vm.network "private_network", ip: "172.24.0.11" <br class="title-page-name"/>    conf.vm.hostname = 'openshift.example.com' <br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 80, host: 980<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 443, host: 9443<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 8080, host: 8080<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 8443, host: 8443<br class="title-page-name"/>    conf.vm.provider "virtualbox" do |v| <br class="title-page-name"/>      v.memory = 4096 <br class="title-page-name"/>      v.cpus = 2 <br class="title-page-name"/>    end<br class="title-page-name"/>    conf.vm.provision "shell", inline: $lab_main <br class="title-page-name"/>  end <br class="title-page-name"/><br class="title-page-name"/>$lab_main = &lt;&lt;SCRIPT<br class="title-page-name"/>cat &lt;&lt;EOF &gt;&gt; /etc/hosts<br class="title-page-name"/>172.24.0.11 openshift.example.com openshift<br class="title-page-name"/>172.24.0.12 storage.example.com storage nfs<br class="title-page-name"/>EOF<br class="title-page-name"/>systemctl disable firewalld<br class="title-page-name"/>systemctl stop firewalld<br class="title-page-name"/>yum update -y<br class="title-page-name"/>yum install -y epel-release git<br class="title-page-name"/>yum install -y docker<br class="title-page-name"/>cat &lt;&lt; EOF &gt;/etc/docker/daemon.json<br class="title-page-name"/>{<br class="title-page-name"/>   "insecure-registries": [<br class="title-page-name"/>     "172.30.0.0/16"<br class="title-page-name"/>   ]<br class="title-page-name"/>}<br class="title-page-name"/>EOF<br class="title-page-name"/>systemctl start docker<br class="title-page-name"/>systemctl enable docker<br class="title-page-name"/>yum -y install centos-release-openshift-origin39<br class="title-page-name"/>yum -y install origin-clients<br class="title-page-name"/>oc cluster up<br class="title-page-name"/>SCRIPT</pre>
<p class="calibre2">The environment can be deployed by running a single command:</p>
<pre class="calibre18"><strong class="calibre1">$ vagrant up</strong></pre>
<p class="calibre2">Once the virtual machine is deployed, you can connect to it as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ vagrant ssh</strong></pre>
<p class="calibre2">Finally, log in as the <kbd class="calibre12">developer</kbd>, to be able to perform unprivileged operations: </p>
<pre class="calibre18"><strong class="calibre1">$ oc login -u developer</strong><br class="title-page-name"/>Server [https://localhost:8443]:<br class="title-page-name"/>The server uses a certificate signed by an unknown authority.<br class="title-page-name"/>You can bypass the certificate check, but any data you send to the server could be intercepted by others.<br class="title-page-name"/>Use insecure connections? (y/n): <strong class="calibre1">y</strong><br class="title-page-name"/><br class="title-page-name"/>Authentication required for https://localhost:8443 (openshift)<br class="title-page-name"/>Username: <strong class="calibre1">developer</strong><br class="title-page-name"/>Password: <strong class="calibre1">&lt;ANY PASSWORD&gt;</strong><br class="title-page-name"/>Login successful.<br class="title-page-name"/><br class="title-page-name"/>You have one project on this server: "myproject"<br class="title-page-name"/><br class="title-page-name"/>Using project "myproject".<br class="title-page-name"/>Welcome! See 'oc help' to get started.</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">PHP S2I</h1>
                
            
            <article>
                
<p class="calibre2">OpenShift supports S2I builds for PHP, and also for many other runtimes. The S2I process<span class="calibre11"> produces a ready-to-run image by combining the source code of an application with a base builder image, which prepares the application. The builder is a special image that is able to handle application installation and configuration for a particular programming language/framework. For example, the PHP builder can only handle PHP source code, and it doesn't support Java by default. Most of the frequently used programming languages, like Python, Ruby, Java, and Node.js, are already covered by OpenShift built-in builders. </span><span class="calibre11">The S2I process involves the following steps:</span></p>
<ol class="calibre13">
<li value="1" class="calibre10">Determining the correct base builder image. This process relies on complex heuristics and primarily involves looking for specific files and file extensions, like <kbd class="calibre12">Gemfile</kbd> for Ruby on Rails, or <kbd class="calibre12">requirements.txt</kbd> for Python. The runtime environment that the builder image is determined by can also be overriden by the user from CLI</li>
<li value="2" class="calibre10">Creating a <kbd class="calibre12">BuildConfig</kbd> pointing to the application source code's repository and to the ImageStream for the builder image</li>
<li value="3" class="calibre10"><span>Starting a</span> <kbd class="calibre12">build</kbd> p<span>od from the builder image</span></li>
<li value="4" class="calibre10"><span>Downloading the application's source code</span></li>
<li value="5" class="calibre10"><span>Streaming the scripts and the application's source code into the builder image container, using the <kbd class="calibre12">tar</kbd></span> utility <span>for images that support it</span></li>
<li value="6" class="calibre10"><span>Running the</span><span> </span><kbd class="calibre12">assemble</kbd> sc<span>ript (the one provided by the builder image has the highest priority)</span></li>
<li value="7" class="calibre10"><span>Saving the final image to the internal registry</span></li>
<li value="8" class="calibre10">Creating resources necessary to support the application. They include, but not limited to, <kbd class="calibre12">DeploymentConfig</kbd>, <kbd class="calibre12">Service</kbd>, and <kbd class="calibre12">Pod</kbd>.</li>
</ol>
<div class="title-page-name">
<p class="calibre2">The PHP builder supports changing the default PHP configuration by using a number of environment variables. They are described on the web page for each particular builder.</p>
<p class="calibre2">The build process can be initiated by running the <kbd class="calibre12">oc new-app</kbd>. This command takes the repository URL/local path as an argument, and creates all required OpenShift entities to support the S2I build and application deployment at the same time.</p>
<p class="calibre2">The following OpenShift entities are created by default:</p>
<table border="1" class="calibre22">
<tbody class="calibre23">
<tr class="calibre24">
<td class="calibre35"><strong class="calibre1">Type</strong></td>
<td class="calibre39"><strong class="calibre1">Name</strong></td>
<td class="calibre40"><strong class="calibre1">Description</strong></td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Pod</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;application name&gt;-&lt;build sequential number&gt;-build</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Builder pod that builds your application, producing the application image and possibly some artifacts to be used in future builds along the way</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Pod</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;-&lt;build sequential number&gt;-&lt;id&gt;</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Application pod produced by the build process</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Service</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Application service</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Replication controller</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;-<span>&lt;build sequential number&gt;</span></kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Application replication controller, maintaining only one replica <span class="calibre11">by default</span></p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Deployment config</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Deployment configuration containing all information on how to deploy the application</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Image stream</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Path to the image built</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Build config</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12">&lt;name&gt;</kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Build configuration containing all required information on how to build the application</p>
</td>
</tr>
<tr class="calibre24">
<td class="calibre35">
<p class="calibre2">Build</p>
</td>
<td class="calibre39">
<p class="calibre2"><kbd class="calibre12"><span><span>&lt;name&gt;-</span></span><span>&lt;build sequential number&gt;</span></kbd></p>
</td>
<td class="calibre40">
<p class="calibre2">Particular build; can be run multiple times</p>
</td>
</tr>
</tbody>
</table>
<div class="packt_infobox">OpenShift doesn't create a route automatically. If you need to expose your application, a route should be created by running <kbd class="calibre26">oc<span> </span>expose svc &lt;name&gt;</kbd>.</div>
</div>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Building a simple PHP application</h1>
                
            
            <article>
                
<p class="calibre2">The first S2I lab will use a very simple PHP application that displays the PHP configuration using a standard PHP function—<kbd class="calibre12">phpinfo()</kbd>. It's composed of a single <kbd class="calibre12">index.php</kbd> file, with the following content:</p>
<pre class="calibre18"><strong class="calibre1">$ cat index.php</strong><br class="title-page-name"/>&lt;?php<br class="title-page-name"/>phpinfo();<br class="title-page-name"/>?&gt;</pre>
<p class="calibre2">This application is enough to demonstrate a basic S2I build. We have already prepared a Git repository on GitHub, which contains the code of our application. The repository is located at <a href="https://github.com/neoncyrex/phpinfo.git" target="_blank" class="calibre8">https://github.com/neoncyrex/phpinfo.git</a>, and is going to be used in this lab.</p>
<p class="calibre2">First, we need to create a separate project for our new lab, as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ oc new-project phpinfo</strong><br class="title-page-name"/>Now using project "phpinfo" on server "https://localhost:8443".<br class="title-page-name"/>&lt;OMITTED&gt;</pre>
<p class="calibre2">The <kbd class="calibre12">oc new-app</kbd> command can build an application from its source code, using either a local or remote Git repository.</p>
<p class="calibre2">Let's clone the repository locally, to be able to make changes to it. This will create the <kbd class="calibre12">phpinfo</kbd> directory, with repository files:</p>
<pre class="calibre18"><strong class="calibre1">$ git clone https://github.com/neoncyrex/phpinfo.git</strong><br class="title-page-name"/>Cloning into 'phpinfo'...<br class="title-page-name"/>remote: Counting objects: 6, done.<br class="title-page-name"/>remote: Compressing objects: 100% (3/3), done.<br class="title-page-name"/>remote: Total 6 (delta 0), reused 3 (delta 0), pack-reused 0<br class="title-page-name"/>Unpacking objects: 100% (6/6), done.</pre>
<p class="calibre2">The build and application deployment processes can be initiated by running the <kbd class="calibre12">oc new-app</kbd> command. This basic S2I strategy can be triggered as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ oc new-app phpinfo</strong><br class="title-page-name"/>--&gt; Found image 23e49b6 (17 hours old) in image stream "openshift/php" under tag "7.0" for "php"<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>--&gt; Success<br class="title-page-name"/>    Build scheduled, use 'oc logs -f bc/phpinfo' to track its progress.<br class="title-page-name"/>    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:<br class="title-page-name"/>     'oc expose svc/phpinfo'<br class="title-page-name"/>    Run 'oc status' to view your app.</pre>
<p class="calibre2">The preceding command does the following:</p>
<ul class="calibre9">
<li class="calibre10">Uses <kbd class="calibre12">phpinfo</kbd> as a path to the application's source code</li>
<li class="calibre10">Automatically detects the programming language—PHP</li>
<li class="calibre10">Initiates the build process</li>
<li class="calibre10">Creates a number of OpenShift resources</li>
</ul>
<p class="calibre2">The build process takes some time. During the first phase, you can see a container with <kbd class="calibre12">-build</kbd> in its name. <span class="calibre11">This container is deployed from the PHP builder image and is responsible for build operations:</span></p>
<pre class="calibre18"><strong class="calibre1">$ oc get pod</strong><br class="title-page-name"/>NAME             READY  STATUS    RESTARTS  AGE<br class="title-page-name"/>phpinfo-1-build  1/1    Running   0         23s</pre>
<p class="calibre2">After some time, the application will be available. That means that the application's pod should be in a <kbd class="calibre12">Running</kbd> state:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get pod</strong><br class="title-page-name"/>NAME              READY  STATUS     RESTARTS  AGE<br class="title-page-name"/>phpinfo-1-build   0/1    Completed  0         39s<br class="title-page-name"/>phpinfo-1-h9xt5   1/1    Running    0         4s</pre>
<p class="calibre2">OpenShift built and deployed the <kbd class="calibre12">phpinfo</kbd> application, which is now available by using its service IP. Let's try to access our application using the <kbd class="calibre12">curl</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get svc</strong><br class="title-page-name"/>NAME    CLUSTER-IP    EXTERNAL-IP PORT(S)            AGE<br class="title-page-name"/>phpinfo 172.30.54.195 &lt;none&gt;      8080/TCP,8443/TCP  1h<br class="title-page-name"/><br class="title-page-name"/>$ <strong class="calibre1">curl -s http://172.30.54.195:8080 | head -n 10</strong><br class="title-page-name"/>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd"&gt;<br class="title-page-name"/>&lt;html &gt;&lt;head&gt;<br class="title-page-name"/>&lt;style type="text/css"&gt;<br class="title-page-name"/>body {background-color: #fff; color: #222; font-family: sans-serif;}<br class="title-page-name"/>pre {margin: 0; font-family: monospace;}<br class="title-page-name"/>a:link {color: #009; text-decoration: none; background-color: #fff;}<br class="title-page-name"/>a:hover {text-decoration: underline;}<br class="title-page-name"/>table {border-collapse: collapse; border: 0; width: 934px; box-shadow: 1px 2px 3px #ccc;}<br class="title-page-name"/>.center {text-align: center;}<br class="title-page-name"/>.center table {margin: 1em auto; text-align: left;}</pre>
<div class="packt_infobox">The <kbd class="calibre26">phpinfo()</kbd> function displays the PHP configuration as an HTML table.</div>
<p class="calibre2">A summary of the build process can be displayed by running the <kbd class="calibre12">oc status</kbd> or <kbd class="calibre12">oc status -v</kbd> commands:</p>
<pre class="calibre18"><strong class="calibre1">$ oc status -v</strong><br class="title-page-name"/>In project phpinfo on server https://localhost:8443<br class="title-page-name"/><br class="title-page-name"/>svc/phpinfo - 172.30.54.195 ports 8080, 8443<br class="title-page-name"/>  dc/phpinfo deploys istag/phpinfo:latest &lt;-<br class="title-page-name"/>    bc/phpinfo source builds https://github.com/neoncyrex/phpinfo.git#master on openshift/php:7.0<br class="title-page-name"/>    deployment #1 deployed about an hour ago - 1 pod<br class="title-page-name"/><br class="title-page-name"/>Info:<br class="title-page-name"/>  * pod/phpinfo-1-build has no liveness probe to verify pods are still running.<br class="title-page-name"/>    try: oc set probe pod/phpinfo-1-build --liveness ...<br class="title-page-name"/>  * dc/phpinfo has no readiness probe to verify pods are ready to accept traffic or ensure deployment is successful.<br class="title-page-name"/>    try: oc set probe dc/phpinfo --readiness ...<br class="title-page-name"/>  * dc/phpinfo has no liveness probe to verify pods are still running.<br class="title-page-name"/>    try: oc set probe dc/phpinfo --liveness ...<br class="title-page-name"/>View details with 'oc describe &lt;resource&gt;/&lt;name&gt;' or list everything with 'oc get all'.</pre>
<p class="calibre2">The preceding command shows that deployment <kbd class="calibre12">#1</kbd> has been rolled out. It can also contain some useful information for troubleshooting the build, in case something goes wrong.</p>
<p class="calibre2">There is another way to display build logs with low-level details—using the <kbd class="calibre12">oc logs</kbd> command. We need to show the log for the <kbd class="calibre12">buildconfig</kbd> (or just <kbd class="calibre12">bc</kbd>) entity, which can be displayed, as follows, by using the <kbd class="calibre12">oc logs bc/phpinfo</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1">$ oc logs bc/phpinfo</strong><br class="title-page-name"/>Cloning "https://github.com/neoncyrex/phpinfo.git" ...<br class="title-page-name"/>  Commit: 638030df45052ad1d9300248babe0b141cf5dbed (initial commit)<br class="title-page-name"/>  Author: vagrant &lt;vagrant@openshift.example.com&gt;<br class="title-page-name"/>  Date: Sat Jun 2 04:22:59 2018 +0000<br class="title-page-name"/>---&gt; Installing application source...<br class="title-page-name"/>=&gt; sourcing 20-copy-config.sh ...<br class="title-page-name"/>---&gt; 05:00:11 Processing additional arbitrary httpd configuration provided by s2i ...<br class="title-page-name"/>=&gt; sourcing 00-documentroot.conf ...<br class="title-page-name"/>=&gt; sourcing 50-mpm-tuning.conf ...<br class="title-page-name"/>=&gt; sourcing 40-ssl-certs.sh ...<br class="title-page-name"/>Pushing image 172.30.1.1:5000/phpinfo/phpinfo:latest ...<br class="title-page-name"/>Pushed 0/10 layers, 23% complete<br class="title-page-name"/>Pushed 1/10 layers, 30% complete<br class="title-page-name"/>Pushed 2/10 layers, 21% complete<br class="title-page-name"/>Pushed 3/10 layers, 30% complete<br class="title-page-name"/>Pushed 4/10 layers, 40% complete<br class="title-page-name"/>Pushed 5/10 layers, 51% complete<br class="title-page-name"/>Pushed 6/10 layers, 60% complete<br class="title-page-name"/>Pushed 7/10 layers, 76% complete<br class="title-page-name"/>Pushed 8/10 layers, 87% complete<br class="title-page-name"/>Pushed 9/10 layers, 95% complete<br class="title-page-name"/>Pushed 10/10 layers, 100% complete<br class="title-page-name"/>Push successful</pre>
<p class="calibre2">The preceding output gives us some insight into how builds work.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding the PHP build process</h1>
                
            
            <article>
                
<p class="calibre2">Now that we know that the <kbd class="calibre12">phpinfo</kbd> application works as expected, let's focus on the low-level details that are required to understand the build process. OpenShift created a number of API resources to make the build possible. Some of them are related to the deployment process, which we learned about in previous chapters. We can display all entities as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get all</strong><br class="title-page-name"/>NAME                 TYPE   FROM       LATEST<br class="title-page-name"/>buildconfigs/phpinfo Source Git@master 1<br class="title-page-name"/><br class="title-page-name"/>NAME            TYPE    FROM       STATUS    STARTED           DURATION<br class="title-page-name"/>builds/phpinfo-1 Source Git@638030d Complete About an hour ago 34s<br class="title-page-name"/><br class="title-page-name"/>NAME                 DOCKER REPO                     TAGS                      UPDATED<br class="title-page-name"/>imagestreams/phpinfo 172.30.1.1:5000/phpinfo/phpinfo latest <br class="title-page-name"/>About an hour ago<br class="title-page-name"/><br class="title-page-name"/>NAME                     REVISION DESIRED CURRENT TRIGGERED BY<br class="title-page-name"/>deploymentconfigs/phpinfo 1       1       1 config,image(phpinfo:latest)<br class="title-page-name"/><br class="title-page-name"/>NAME                READY  STATUS     RESTARTS  AGE<br class="title-page-name"/>po/phpinfo-1-build  0/1    Completed  0         1h<br class="title-page-name"/>po/phpinfo-1-h9xt5  1/1    Running    0         1h<br class="title-page-name"/><br class="title-page-name"/>NAME         DESIRED  CURRENT READY  AGE<br class="title-page-name"/>rc/phpinfo-1 1        1       1      1h<br class="title-page-name"/><br class="title-page-name"/>NAME        CLUSTER-IP    EXTERNAL-IP PORT(S)           AGE<br class="title-page-name"/>svc/phpinfo 172.30.54.195 &lt;none&gt;      8080/TCP,8443/TCP 1h</pre>
<p class="calibre2">Most of the entities (the pod, service, replication controller, and deployment configuration) in the preceding output are already familiar to you, from previous chapters. </p>
<p class="calibre2">The S2I build strategy uses the following additional entities—<strong class="calibre4">build configuration, build,</strong> and <strong class="calibre4">image stream</strong>. The build config has all of the information necessary to build the application. As with the rest of the OpenShift API resources, its configuration can be gathered using the <kbd class="calibre12">oc get</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get bc phpinfo -o yaml</strong><br class="title-page-name"/>apiVersion: v1<br class="title-page-name"/>kind: BuildConfig<br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/><strong class="calibre1">&lt;output omitted&gt;</strong><br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/>spec:<br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/><strong class="calibre1">&lt;output omitted&gt;</strong><br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/>  source:<br class="title-page-name"/>    git:<br class="title-page-name"/>      ref: master<br class="title-page-name"/>      uri: https://github.com/neoncyrex/phpinfo.git<br class="title-page-name"/>    type: Git<br class="title-page-name"/>  strategy:<br class="title-page-name"/>    sourceStrategy:<br class="title-page-name"/>      from:<br class="title-page-name"/>        kind: ImageStreamTag<br class="title-page-name"/>        name: php:7.0<br class="title-page-name"/>        namespace: openshift<br class="title-page-name"/>    type: Source<br class="title-page-name"/>  successfulBuildsHistoryLimit: 5<br class="title-page-name"/>  triggers:<br class="title-page-name"/>  - github:<br class="title-page-name"/>      secret: 5qFv8z-J1me1Mj7Q27rY<br class="title-page-name"/>    type: GitHub<br class="title-page-name"/>  - generic:<br class="title-page-name"/>      secret: -g6nTMasd6TRCMxBvKWz<br class="title-page-name"/>    type: Generic<br class="title-page-name"/>  - type: ConfigChange<br class="title-page-name"/>  - imageChange:<br class="title-page-name"/>      lastTriggeredImageID: centos/php-70-centos7@sha256:eb2631e76762e7c489561488ac1eee966bf55601b6ab31d4fbf60315d99dc740<br class="title-page-name"/>    type: ImageChange<br class="title-page-name"/>status:<br class="title-page-name"/>  lastVersion: 1</pre>
<p class="calibre2">The following fields are especially important:</p>
<ul class="calibre9">
<li class="calibre10"><kbd class="calibre12">spec.source.git</kbd>: Repository URL for the application source code</li>
<li class="calibre10"><kbd class="calibre12">spec.strategy.sourceStrategy</kbd>: Contains information on which builder will be used.</li>
</ul>
<p class="calibre2">In our case, OpenShift uses a built-in builder from image stream <kbd class="calibre12">php:7.0</kbd>, in the <kbd class="calibre12">openshift</kbd> namespace. Let's look at its configuration:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get is php -o yaml -n openshift</strong><br class="title-page-name"/>apiVersion: v1<br class="title-page-name"/>kind: ImageStream<br class="title-page-name"/><strong class="calibre1">&lt;OMITTED&gt;</strong><br class="title-page-name"/>spec:<br class="title-page-name"/>  lookupPolicy:<br class="title-page-name"/>    local: false<br class="title-page-name"/>  tags:<br class="title-page-name"/><strong class="calibre1">&lt;OMITTED&gt;</strong><br class="title-page-name"/>  - annotations:<br class="title-page-name"/><strong class="calibre1">&lt;OMITTED&gt;</strong><br class="title-page-name"/>      openshift.io/display-name: PHP 7.0<br class="title-page-name"/>      openshift.io/provider-display-name: Red Hat, Inc.<br class="title-page-name"/>      sampleRepo: https://github.com/openshift/cakephp-ex.git<br class="title-page-name"/>      supports: php:7.0,php<br class="title-page-name"/>      tags: builder,php<br class="title-page-name"/>      version: "7.0"<br class="title-page-name"/>    <strong class="calibre1">from:</strong><br class="title-page-name"/><strong class="calibre1">      kind: DockerImage</strong><br class="title-page-name"/><strong class="calibre1">      name: centos/php-70-centos7:latest</strong><br class="title-page-name"/><strong class="calibre1">&lt;OMITTED&gt;</strong></pre>
<p class="calibre2">The PHP builder image used to build our application is <kbd class="calibre12">centos/php-70-centos7:latest</kbd>.</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">We now have all the information on how to build an application from source code. OpenShift puts together all the information (provided by you and inferred from the source code) and starts a new build. Each build has a sequential number, starting from <kbd class="calibre12">1</kbd>. You can display all builds by running the following command:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get build</strong><br class="title-page-name"/>NAME      TYPE   FROM        STATUS   STARTED     DURATION<br class="title-page-name"/>phpinfo-1 Source Git@638030d Complete 2 hours ago 34s</pre>
<p class="calibre2">This build is reported as <kbd class="calibre12">Complete</kbd>, as our application is already up and running.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Starting a new build</h1>
                
            
            <article>
                
<p class="calibre2">If an application's source code was updated, you can trigger the rebuild process by running the <kbd class="calibre12">oc start-build</kbd> command. The build itself is managed by the build configuration.</p>
<p class="calibre2">First, we need to gather information on all available build configurations:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get bc</strong><br class="title-page-name"/>NAME    TYPE   FROM       LATEST<br class="title-page-name"/>phpinfo Source Git@master 1</pre>
<p class="calibre2">As you can see, we only have one build, <kbd class="calibre12">phpinfo</kbd>, and it was deployed only once; hence, the number <kbd class="calibre12">1</kbd>.</p>
<p class="calibre2">Let's start a new build, as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ oc start-build phpinfo</strong><br class="title-page-name"/>build "phpinfo-2" started<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">$ oc get pod</strong><br class="title-page-name"/>NAME             READY  STATUS    RESTARTS AGE<br class="title-page-name"/>phpinfo-1-build  0/1    Completed 0        2h<br class="title-page-name"/>phpinfo-1-h9xt5  1/1    Running   0        2h<br class="title-page-name"/>phpinfo-2-build  0/1    Init:0/2  0        3s</pre>
<p class="calibre2">OpenShift started a new build, versioned as <span class="calibre11"><span class="calibre11"><kbd class="calibre12">2</kbd>,</span></span> which is present in the names of the pods spawned by the new build. Once everything is complete, your application will be redeployed:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get pod</strong><br class="title-page-name"/>NAME             READY  STATUS     RESTARTS AGE<br class="title-page-name"/>phpinfo-1-build  0/1    Completed  0        2h<br class="title-page-name"/>phpinfo-2-build  0/1    Completed  0        32s<br class="title-page-name"/>phpinfo-2-zqtj6  1/1    Running    0        23s</pre>
<p class="calibre2">The latest version of the build is now <kbd class="calibre12">2</kbd>:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get bc</strong><br class="title-page-name"/>NAME    TYPE   FROM       LATEST<br class="title-page-name"/>phpinfo Source Git@master 2</pre>
<p class="calibre2">A list of all builds is kept by OpenShift for future inspection:</p>
<pre class="calibre18"><strong class="calibre1">$ oc get build</strong><br class="title-page-name"/>NAME      TYPE   FROM        STATUS   STARTED            DURATION<br class="title-page-name"/>phpinfo-1 Source Git@638030d Complete 2 hours ago        34s<br class="title-page-name"/>phpinfo-2 Source Git@638030d Complete About a minute ago 7s</pre>
<p class="calibre2">This example is not close to production, as the build was triggered manually, not by changes to the source code. However, it gives you a general idea of how to use builds. </p>
<p class="calibre2"><span class="calibre11">Use the following code to clean everything up for the next lab:</span></p>
<pre class="calibre18"><strong class="calibre1">$ oc delete all --all<br class="title-page-name"/></strong>deploymentconfig "phpinfo" deleted<br class="title-page-name"/>buildconfig "phpinfo" deleted<br class="title-page-name"/>imagestream "phpinfo" deleted<br class="title-page-name"/>pod "phpinfo-2-fbd8l" deleted<br class="title-page-name"/>service "phpinfo" deleted<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">$ oc delete project phpinfo</strong><br class="title-page-name"/>project "phpinfo" deleted<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">$ oc project myproject</strong><br class="title-page-name"/>Now using project "myproject" on server "https://127.0.0.1:8443".</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, you learned about the build entities created by <span class="calibre11">OpenShift, and </span><span class="calibre11">how to deploy a simple PHP application from source code. We showed you </span><span class="calibre11">how to start a new build and h</span>ow to customize a build process.</p>
<p class="calibre2">In the following chapter, you will build and deploy a WordPress application from a custom template. You will also <span class="calibre11">learn how to create and deploy OpenShift templates, and how to </span>deploy applications from OpenShift templates.</p>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<ol class="calibre13">
<li value="1" class="calibre10">Which of the following OpenShift entities controls how to build a particular application from source code? choose two:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">Pod</li>
<li value="2" class="calibre10">Route</li>
<li value="3" class="calibre10">Replication controller </li>
<li value="4" class="calibre10">Build config </li>
<li value="5" class="calibre10">Build </li>
<li value="6" class="calibre10">Deployment config</li>
</ol>
</li>
</ul>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Which of the following commands starts a new build? choose one:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10"><kbd class="calibre12">oc new-app</kbd></li>
<li value="2" class="calibre10"><kbd class="calibre12">oc new build</kbd></li>
<li value="3" class="calibre10"><kbd class="calibre12">oc start-build</kbd></li>
<li value="4" class="calibre10"><kbd class="calibre12">oc get build</kbd></li>
</ol>
</li>
</ul>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Which of the following commands display information on a build? choose three:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10"><kbd class="calibre12">oc status -v</kbd></li>
<li value="2" class="calibre10"><kbd class="calibre12">oc status</kbd></li>
<li value="3" class="calibre10"><kbd class="calibre12">oc logs build/phpdemo-2</kbd></li>
<li value="4" class="calibre10"><kbd class="calibre12">oc show logs</kbd></li>
</ol>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Further reading</h1>
                
            
            <article>
                
<p class="calibre2">S2I is one of the most important features of OpenShift. You may want to have more deep knowledge of this process. The following links provide additional information:</p>
<ul class="calibre9">
<li class="calibre10">Builds and Image Streams at <a href="https://docs.openshift.org/latest/architecture/core_concepts/builds_and_image_streams.html#builds" target="_blank" class="calibre8">https://docs.openshift.org/latest/architecture/core_concepts/builds_and_image_streams.html#builds</a>.</li>
<li class="calibre10">PHP at <a href="https://docs.openshift.com/online/using_images/s2i_images/php.html" target="_blank" class="calibre8">https://docs.openshift.com/online/using_images/s2i_images/php.html/</a>.</li>
</ul>


            </article>

            
        </section>
    </body></html>