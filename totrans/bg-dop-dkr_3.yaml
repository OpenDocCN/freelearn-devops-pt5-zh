- en: Chapter 3. Orchestration and Delivery
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第3章 编排与交付
- en: The main motivation behind creating a cluster of Docker hosts is designing for
    high availability. Most, if not all, clustering and orchestration tools, such
    as Docker Swarm and Kubernetes, take advantage of clustering by creating a master-slave
    kind of relationship. This ensures that there is always a node to fall back to
    in case any one node goes down in the environment. While deploying a cluster to
    a cloud provider, there are a couple of technologies you can leverage to ensure
    that your environment is highly available, for example Consul, and also take advantage
    of the native fault-tolerant design of the cloud by deploying masters and nodes
    in separate availability zones.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 创建Docker主机集群的主要动机是为了设计高可用性。大多数，甚至所有的集群和编排工具，如Docker Swarm和Kubernetes，都通过创建主从关系来利用集群的优势。这确保了当某一节点在环境中宕机时，始终有其他节点可以回退使用。在将集群部署到云服务提供商时，有几种技术可以帮助确保环境的高可用性，例如Consul，并且可以通过将主节点和从节点部署到不同的可用区，利用云平台的原生容错设计。
- en: Lesson Objectives
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 课程目标
- en: 'By the end of this lesson, you will be able to:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本课程结束后，你将能够：
- en: Obtain an overview of the Docker Swarm mode
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 获取Docker Swarm模式的概览
- en: Use Docker engine to create a swarm of Docker engines
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用Docker引擎创建Docker引擎的集群
- en: Manage services and applications in a swarm
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 管理服务和应用程序在集群中
- en: Scale services up and down to handle more requests on your application
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 向上或向下扩展服务以处理应用程序的更多请求
- en: Load balance a Docker Swarm deployment
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 负载均衡Docker Swarm部署
- en: Secure Docker containers and deployments
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 保护Docker容器和部署
- en: Orchestration
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 编排
- en: Running containers on our local environment is easy and does not require a lot
    of our effort; when it comes to the cloud, we need a different kind of mindset
    and tools to aid us in achieving this. Our environment should be **highly available,
    fault tolerant**, and **easily scalable**. This process of coordinating resources
    and/or containers, resulting in a consolidated workflow, is orchestration.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的本地环境中运行容器是简单的，不需要很多努力；但在云环境中，我们需要一种不同的心态和工具来帮助我们实现这一目标。我们的环境应该是**高可用的、容错的**，并且**易于扩展**。协调资源和/或容器的过程，形成一个统一的工作流，这就是编排。
- en: 'First, let''s get familiarized with some of the terms used when it comes to
    orchestration:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，让我们熟悉一些在编排中常用的术语：
- en: '`docker-engine`: This refers to the Docker bundle or installation we currently
    have on our computers'
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-engine`：指我们目前在计算机上安装的Docker捆绑包或安装。'
- en: '`docker-machine`: A tool that helps us install Docker on virtual hosts'
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-machine`：帮助我们在虚拟主机上安装Docker的工具'
- en: '`Virtual hosts`: These are virtual servers that run under physical hosts'
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`虚拟主机`：这些是运行在物理主机下的虚拟服务器'
- en: '`docker-swarm`: A clustering tool for Docker'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-swarm`：Docker的集群工具'
- en: '`docker host`: A host or server that has Docker set up or installed'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker主机`：已设置或安装Docker的主机或服务器'
- en: '`Node`: A Docker host that is connected to a swarm cluster'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`节点`：连接到集群的Docker主机'
- en: '`Cluster`: A group of Docker hosts or nodes'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`集群`：一组Docker主机或节点'
- en: '`Replica`: A duplicate or number of duplicates of an instance'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`副本`：实例的副本或多个副本'
- en: '`Task`: A defined operation to be run on nodes'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`任务`：在节点上运行的定义操作'
- en: '`Service`: A group of tasks'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`服务`：一组任务'
- en: Note
  id: totrans-23
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'Here are the most common terms throughout the lesson:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是本课程中最常见的术语：
- en: '`docker-engine`: running Docker on our computers;'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-engine`：在我们的计算机上运行Docker。'
- en: '`docker-machine`: A tool or CLI that helps us install Docker'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-machine`：帮助我们安装Docker的工具或命令行接口（CLI）'
- en: '`Virtual hosts`: A host or server running on a physical host.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`虚拟主机`：在物理主机上运行的主机或服务器。'
- en: '`docker-swarm:`A clustering tool for Docker'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`docker-swarm`：Docker的集群工具'
- en: '`Docker host`: Any server or host running Docker'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`Docker主机`：任何运行Docker的服务器或主机'
- en: '`Node`: This refers to any host bound to a swarm cluster.'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`节点`：指任何绑定到集群的主机。'
- en: '`Cluster`: A group of managed and controlled hosts.'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`集群`：一组受管理和控制的主机。'
- en: '`Replica`: A duplicate of other running hosts for various tasks'
  id: totrans-32
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`副本`：其他运行主机的复制，用于不同的任务'
- en: '`Task`: Operations like install, upgrade, or remove.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`任务`：如安装、升级或删除等操作。'
- en: '`Service`: Multiple tasks define a service.'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`服务`：多个任务定义一个服务。'
- en: Now that we are at least conversant with the terms above, we are ready to implement
    a Docker Swarm orchestration flow using `docker-machine`.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，既然我们至少了解了上述术语，我们准备使用`docker-machine`实现一个Docker Swarm编排流程。
- en: An Overview of Docker Swarm
  id: totrans-36
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Docker Swarm概览
- en: Docker Swarm is a **clustering** tool for Docker containers. It allows you to
    establish and manage a cluster of Docker **nodes** as a single **virtual system**.
    This means we get to run Docker on multiple hosts on our computers.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: Docker Swarm是一个为Docker容器设计的**集群**工具。它允许你将多个Docker**节点**作为一个单一的**虚拟系统**来建立和管理Docker集群。这意味着我们可以在多个主机上运行Docker。
- en: We control the swarm cluster through a manager which primarily **handles** and
    **controls** containers. With the swarm manager, you can create a primary manager
    instance and multiple **replica** instances in case the primary fails. This means
    you can have more than one manager in a swarm!
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 我们通过一个管理器来控制swarm集群，管理器主要**处理**和**控制**容器。使用swarm管理器，你可以创建一个主管理实例和多个**副本**实例，以防主实例失败。这意味着在一个swarm中，你可以拥有多个管理器！
- en: Note
  id: totrans-39
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: A swarm is created from a manager node, and other Docker machines join the cluster,
    either as worker nodes or manager nodes.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: swarm是从一个管理节点创建的，其他Docker机器加入集群，作为工作节点或管理节点。
- en: Clustering is important because it creates a group of cooperating systems that
    provide redundancy, creating a fault-tolerant environment. For example, if one
    or more of the nodes goes down, Docker Swarm will fail over to another working
    node.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 集群很重要，因为它创建了一个协作系统的组，提供冗余，从而创建一个容错环境。例如，如果一个或多个节点发生故障，Docker Swarm会切换到另一个正常运行的节点。
- en: 'The **Swarm manager** carries out the following roles:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '**Swarm管理器**执行以下角色：'
- en: Accepts `docker` commands
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接受`docker`命令
- en: Executes commands against the cluster
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对集群执行命令
- en: Supports high availability; deploys a primary and secondary instance which can
    take over in the event of the primary instance going down
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 支持高可用性；部署主实例和备份实例，以便在主实例发生故障时可以接管
- en: Docker Swarm uses **scheduling** to optimize resources and ensure efficiency
    in the environment. It **assigns containers** to the most appropriate **nodes**.
    This means Docker Swarm will assign containers to the most healthy node.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: Docker Swarm使用**调度**来优化资源，并确保环境中的效率。它**分配容器**到最合适的**节点**。这意味着Docker Swarm会将容器分配到最健康的节点。
- en: Note
  id: totrans-47
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Remember, a node is a **host running Docker**, not a **container.**
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 请记住，节点是**运行Docker的主机**，而不是**容器**。
- en: 'Swarm can be configured to use any of the following scheduling strategies:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: Swarm可以配置为使用以下任何调度策略：
- en: '**Random**: Deploys a new container to a random node.'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**随机**：将一个新容器部署到随机节点。'
- en: '**Spread**: Swarm deploys a new container to the node with the least number
    of containers.'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**扩展**：Swarm将一个新容器部署到容器数量最少的节点。'
- en: '**Binpack**: The binpack strategy involves deploying a new container to the
    node with the highest number of containers.'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Binpack**：binpack策略涉及将一个新容器部署到容器数量最多的节点。'
- en: 'You can download VirtualBox at: [https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads):'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在以下地址下载VirtualBox：[https://www.virtualbox.org/wiki/Downloads](https://www.virtualbox.org/wiki/Downloads)：
- en: '![An Overview of Docker Swarm](img/image03_01.jpg)'
  id: totrans-54
  prefs: []
  type: TYPE_IMG
  zh: '![Docker Swarm概览](img/image03_01.jpg)'
- en: Note
  id: totrans-55
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: To simulate a Docker Swarm cluster, we need to install a hypervisor (a hypervisor
    type 2 is a virtual machine manager that is installed as a software application
    on an existing operating system) locally, in this case VirtualBox, that will allow
    us to create multiple hosts running Docker locally via `docker-machine` and then
    add them to the swarm cluster. While deploying to a cloud vendor, this is achieved
    using their compute service, for instance EC2 on AWS.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 为了模拟Docker Swarm集群，我们需要在本地安装一个虚拟化管理程序（虚拟化管理程序类型2是一个安装在现有操作系统上的软件应用程序，用于管理虚拟机），在这种情况下是VirtualBox，它将允许我们通过`docker-machine`创建多个本地运行Docker的主机，并将它们添加到swarm集群中。部署到云服务商时，通常通过其计算服务来实现，例如AWS上的EC2。
- en: For Windows operating systems, select your OS distribution and you should get
    a download immediately. Run the executable and install VirtualBox.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Windows操作系统，选择你的操作系统发行版，你应该会立即开始下载。运行可执行文件并安装VirtualBox。
- en: Using Docker Engine to Create a Swarm
  id: totrans-58
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用Docker引擎创建Swarm
- en: 'Before we create our swarm, let''s get a quick overview of the `docker-machine
    cli`. Typing `docker-machine` on your terminal should give you this output:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们创建swarm之前，先快速了解一下`docker-machine cli`。在终端输入`docker-machine`应该会显示以下输出：
- en: '![Using Docker Engine to Create a Swarm](img/image03_03.jpg)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
  zh: '![使用Docker引擎创建Swarm](img/image03_03.jpg)'
- en: 'Just below that, we have our list of commands:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在此下方，我们列出了命令列表：
- en: '![Using Docker Engine to Create a Swarm](img/image03_04.jpg)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![使用Docker引擎创建Swarm](img/image03_04.jpg)'
- en: Note
  id: totrans-63
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Remember to always use the `help` option when you need to clarify something,
    that is, `docker-machine stop --help`
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 记住当你需要澄清某些问题时，始终使用`help`选项，即`docker-machine stop --help`
- en: To create our first Docker Swarm cluster, we are going to use `docker-machine`
    to create our manager and worker nodes first.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 为了创建我们的第一个Docker Swarm集群，我们将首先使用`docker-machine`来创建我们的管理节点和工作节点。
- en: 'Before creating the first machine, a quick overview of our objectives gives
    us the following: we are going to have four docker-machines, one manager, and
    three workers; they are all running on VirtualBox, thus there are four **virtual
    machines**.'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建第一台机器之前，快速回顾一下我们的目标：我们将拥有四台docker-machine，一台管理节点和三台工作节点；它们都运行在VirtualBox上，因此有四台**虚拟机**。
- en: Creating Docker Machines
  id: totrans-67
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建Docker机器
- en: 'This command is used to create a new virtual Docker host:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于创建一个新的虚拟Docker主机：
- en: '[PRE0]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This means our Docker host will be running on **VirtualBox**, but managed and
    controlled by `docker-machine`. The `--driver` option specifies the driver to
    create the machine with. In this case, our driver is **VirtualBox**.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 这意味着我们的Docker主机将在**VirtualBox**上运行，但由`docker-machine`进行管理和控制。`--driver`选项指定用于创建机器的驱动程序。在本例中，我们的驱动程序是**VirtualBox**。
- en: Our command will be `docker-machine create --driver virtualbox manager1`.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的命令将是`docker-machine create --driver virtualbox manager1`。
- en: Note
  id: totrans-72
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: We require the driver in the command because that is our host's foundation,
    meaning our `manager1` machine will be running on VirtualBox as a virtual host.
    There are multiple drivers available from different vendors, but this is the best
    one for demo purposes.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在命令中需要指定驱动程序，因为它是我们主机的基础，这意味着我们的`manager1`机器将在VirtualBox上作为虚拟主机运行。有多个供应商提供的驱动程序，但这是演示目的下最好的选择。
- en: '![Creating Docker Machines](img/image03_05.jpg)'
  id: totrans-74
  prefs: []
  type: TYPE_IMG
  zh: '![创建Docker机器](img/image03_05.jpg)'
- en: Listing Created Machines
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出已创建的机器
- en: 'This command will provide a listing of all the Docker Machines currently on
    your host and more information such as the state, driver, and so on of the machine:
    `docker-machine ls`'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 这个命令将列出当前主机上的所有Docker机器，并显示更多信息，比如机器的状态、驱动程序等：`docker-machine ls`
- en: '![Listing Created Machines](img/image03_06.jpg)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![列出已创建的机器](img/image03_06.jpg)'
- en: Note
  id: totrans-78
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Listing our machine is very important as it gives us an update of our machine
    status. We don't really get notified of errors, which at times could build up
    to a fateful event. Before doing some work on a machine, this will give a brief
    overview. A more detailed check can be run through the `docker-machine status`
    command.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 列出我们的机器非常重要，因为它可以更新我们的机器状态。我们并不会收到错误通知，而错误有时可能积累成灾难性事件。在对机器进行操作之前，这可以提供一个简短的概览。可以通过`docker-machine
    status`命令进行更详细的检查。
- en: Worker Machine Creation
  id: totrans-80
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作节点创建
- en: 'We will follow the same process to create three worker machines for our swarm
    cluster, in other words, running `docker-machine create --driver virtualbox <machine_name>`
    three times, passing `worker1, worker2,` and `worker3` as the value for `<machine_name>`
    on each subsequent run:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将遵循相同的过程为我们的Swarm集群创建三台工作节点，换句话说，运行`docker-machine create --driver virtualbox
    <machine_name>`三次，并在每次运行时将`worker1`、`worker2`和`worker3`作为`<machine_name>`的值：
- en: '![Worker Machine Creation](img/image03_07.jpg)![Worker Machine Creation](img/image03_08.jpg)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
  zh: '![工作节点创建](img/image03_07.jpg)![工作节点创建](img/image03_08.jpg)'
- en: 'Finally, the last worker node will be displayed as follows:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，最后一个工作节点将显示如下：
- en: '![Worker Machine Creation](img/image03_09.jpg)'
  id: totrans-84
  prefs: []
  type: TYPE_IMG
  zh: '![工作节点创建](img/image03_09.jpg)'
- en: 'After doing so, run `docker-machine ls` and if the creation was successful,
    you will see an output similar to the following:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后，运行`docker-machine ls`，如果创建成功，您将看到类似以下的输出：
- en: '![Worker Machine Creation](img/image03_10.jpg)'
  id: totrans-86
  prefs: []
  type: TYPE_IMG
  zh: '![工作节点创建](img/image03_10.jpg)'
- en: Note
  id: totrans-87
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Naming the machines according to their purpose helps us avoid unexpected calls
    to the wrong hosts.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 根据机器的用途命名可以帮助我们避免错误地调用到错误的主机。
- en: Initializing our Swarm
  id: totrans-89
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 初始化我们的Swarm
- en: 'Now that we have our machines running, it''s time to create our swarm. This
    will be done through the manager node, `manager1`. The following are the steps
    we will take to achieve a full-fledged swarm:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们的机器已经运行，接下来是创建我们的Swarm。这将通过管理节点`manager1`来完成。以下是我们实现完整Swarm的步骤：
- en: Connect to the manager node.
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 连接到管理节点。
- en: Declare the `manager1` node as the manager and advertise its address.
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将`manager1`节点声明为管理节点，并宣传其地址。
- en: Get the invite address for nodes to join the swarm.
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 获取节点加入Swarm的邀请地址。
- en: We will be using `ssh` for our connection. `ssh` is a secure network protocol
    used to access or connect to hosts or servers.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用`ssh`进行连接。`ssh`是一种安全的网络协议，用于访问或连接主机或服务器。
- en: Note
  id: totrans-95
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Docker Machines are controlled via the `docker-machine cli.` Docker Swarm runs
    as a service that bonds all the Docker Machines and unifies them under a manager
    machine, or node. This doesn't mean the machines in a swarm cluster are equal
    or similar in any way, they could all be running different services or operations,
    for example, a database host and a web server. Docker Swarm comes in to help orchestrate
    the hosts.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: Docker机器通过`docker-machine cli`进行控制。Docker Swarm作为一个服务运行，将所有的Docker机器结合起来，并将它们统一在一个管理机器或节点下。这并不意味着swarm集群中的所有机器在任何方面都是平等或相似的，它们可能正在运行不同的服务或操作，例如数据库主机和Web服务器。Docker
    Swarm的作用是帮助编排这些主机。
- en: 'This command is used to get the IP address of one or more Docker machines:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于获取一台或多台Docker机器的IP地址：
- en: '[PRE1]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'This command is used to get the IP address of one or more Docker machines.
    The `<machine_name>` is the name or names of the machines whose IP addresses we
    need. In our case, we will use it to get the IP address of the `manager1` node
    as we will need it when initializing swarm mode:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于获取一台或多台Docker机器的IP地址。`<machine_name>`是我们需要获取IP地址的机器的名称。在我们的例子中，我们将用它来获取`manager1`节点的IP地址，因为初始化swarm模式时需要它：
- en: '![Initializing our Swarm](img/image03_11.jpg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![初始化我们的Swarm](img/image03_11.jpg)'
- en: Connecting to a Machine
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 连接到一台机器
- en: This command is used to log into a machine using `SSH:`
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于通过`SSH:`登录到一台机器。
- en: '[PRE2]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'After a successful connection to our `manager1`, we should get an output that
    looks like the following:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 成功连接到我们的`manager1`后，我们应该获得如下所示的输出：
- en: '![Connecting to a Machine](img/image03_12.jpg)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
  zh: '![连接到一台机器](img/image03_12.jpg)'
- en: Note
  id: totrans-106
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Using the `ssh protocol` on cloud vendors will require authentication and/or
    authorization through usernames and passwords or `ssh keys`. We will not be going
    deeper into this because this is a demo.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 在云服务商上使用`ssh协议`将需要通过用户名和密码或`ssh密钥`进行身份验证和/或授权。由于这是一个演示，我们不会深入讨论这一部分。
- en: Initializing Swarm Mode
  id: totrans-108
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 初始化Swarm模式
- en: 'Here is the command to initialize the swarm mode:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 这是初始化swarm模式的命令：
- en: '[PRE3]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Let's run this command inside the manager node to initialize a swarm. The `advertise-addr`
    option is used to specify the address that will be advertised to other members
    of the swarm for API access and networking.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们在管理节点内部运行此命令来初始化一个swarm。`advertise-addr`选项用于指定将被广播给swarm中其他成员的地址，以便进行API访问和网络连接。
- en: 'In this case, its value is the `manager IP address` whose value we got from
    running the `docker-machine ip manager1` earlier:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，它的值是`manager IP地址`，该值是我们之前通过运行`docker-machine ip manager1`获得的：
- en: Note
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: We mentioned earlier that Docker Swarm is a service that bonds and orchestrates
    all machines through a manager node. For this to happen, Docker Swarm lets us
    advertise the cluster through the address of the manager, by including `advertise-addr`
    in the `docker swarm init` command.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前提到过，Docker Swarm是一个通过管理节点将所有机器连接和编排在一起的服务。为了实现这一点，Docker Swarm允许我们通过管理节点的地址来广播集群，在`docker
    swarm init`命令中包含`advertise-addr`。
- en: '![Initializing Swarm Mode](img/image03_13.jpg)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![初始化Swarm模式](img/image03_13.jpg)'
- en: The output of running the command shows us that our node is now a manager!
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 运行该命令的输出显示我们的节点现在是一个管理节点！
- en: 'Notice we also have two commands: one should allow us to invite other nodes
    to the cluster and the other to add another manager to the cluster.'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，我们还拥有两个命令：一个应该允许我们邀请其他节点加入集群，另一个用于将另一个管理节点添加到集群中。
- en: Note
  id: totrans-118
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: When designing for high availability, it is recommended to have more than one
    manager node that will take over in the case of a failure on the primary manager
    node.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在设计高可用性时，建议拥有多个管理节点，以便在主管理节点发生故障时，其他节点可以接管。
- en: Note
  id: totrans-120
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Ensure you save two commands listed in the output as they will be useful in
    adding other hosts in the swarm.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 确保保存输出中列出的两个命令，因为它们将在将其他主机添加到swarm时非常有用。
- en: Adding Workers to our Swarm
  id: totrans-122
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将Worker节点添加到我们的Swarm
- en: This command is used to add swarm workers`:`
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于添加swarm工作节点`：`
- en: '[PRE4]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Before we can add our workers to the swarm, we will need to connect to them,
    through `ssh.`
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们将工作节点添加到swarm之前，我们需要通过`ssh`连接到它们。
- en: We achieve this by running `docker-machine ssh <node_name>` and then running
    the invite command we got from the `manager1 node.`
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 我们通过运行`docker-machine ssh <node_name>`来实现这一点，然后运行我们从`manager1节点`获得的邀请命令。
- en: Note
  id: totrans-127
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The `docker-machine` command can be run from any directory and will always work
    with the created machines.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: '`docker-machine` 命令可以从任何目录运行，并始终与已创建的机器配合使用。'
- en: 'First, we will exit the manager node, using the `exit` command:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们将使用 `exit` 命令退出管理节点：
- en: '![Adding Workers to our Swarm](img/image03_14.jpg)'
  id: totrans-130
  prefs: []
  type: TYPE_IMG
  zh: '![向我们的 Swarm 添加工作节点](img/image03_14.jpg)'
- en: 'Then, we connect to a worker node via `ssh`:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们通过 `ssh` 连接到工作节点：
- en: '![Adding Workers to our Swarm](img/image03_15.jpg)'
  id: totrans-132
  prefs: []
  type: TYPE_IMG
  zh: '![向我们的 Swarm 添加工作节点](img/image03_15.jpg)'
- en: 'Finally, we add the node to the cluster:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们将节点添加到集群中：
- en: '![Adding Workers to our Swarm](img/image03_16.jpg)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
  zh: '![向我们的 Swarm 添加工作节点](img/image03_16.jpg)'
- en: Viewing a Cluster's Status
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 查看集群状态
- en: 'We use this command to view the status of our cluster:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用此命令查看集群状态：
- en: '[PRE5]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'We use this command to view the status of our cluster. This command is run
    on the manager node and displays all the nodes in our cluster and their status
    and availability. Running this on our manager node shows output similar to that
    of the following:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用此命令查看集群状态。此命令在管理节点上运行，并显示我们集群中所有节点的状态和可用性。在管理节点上运行此命令时，输出类似于以下内容：
- en: '![Viewing a Cluster''s Status](img/image03_17.jpg)'
  id: totrans-139
  prefs: []
  type: TYPE_IMG
  zh: '![查看集群状态](img/image03_17.jpg)'
- en: Activity 1 — Adding Nodes to a Cluster
  id: totrans-140
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动 1 — 向集群添加节点
- en: Ensure you have a manager node and the node invite command.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 确保您有一个管理节点和节点邀请命令。
- en: To get you conversant with `ssh` and cluster management.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 让您熟悉 `ssh` 和集群管理。
- en: You have been asked to connect to at least two nodes and add them to the cluster.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要连接到至少两个节点并将它们添加到集群中。
- en: '`Ssh` into your first node:![Activity 1 — Adding Nodes to a Cluster](img/image03_18.jpg)'
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`Ssh` 连接到您的第一个节点：![活动 1 — 向集群添加节点](img/image03_18.jpg)'
- en: Run the invite command on the node to join the cluster. Remember, we got this
    command when we first initialized our manager node:![Activity 1 — Adding Nodes
    to a Cluster](img/image03_19.jpg)
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在节点上运行邀请命令以加入集群。记住，我们在首次初始化管理节点时获得了此命令：![活动 1 — 向集群添加节点](img/image03_19.jpg)
- en: Exit the node, `ssh` into another, and run the command:![Activity 1 — Adding
    Nodes to a Cluster](img/image03_20.jpg)
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 退出节点，`ssh` 连接到另一个节点并运行命令：![活动 1 — 向集群添加节点](img/image03_20.jpg)
- en: '`Ssh` into the manager node to check the cluster status through `docker node
    ls:`![Activity 1 — Adding Nodes to a Cluster](img/image03_21.jpg)'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 `Ssh` 连接到管理节点，通过 `docker node ls` 检查集群状态：![活动 1 — 向集群添加节点](img/image03_21.jpg)
- en: Managing Services and Applications in a Swarm
  id: totrans-148
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 Swarm 中管理服务和应用程序
- en: Now that our cluster is ready, it's time to schedule some services on our cluster.
    As mentioned earlier, the role of the manager node is to accept Docker commands
    and apply them against the cluster. Therefore, we will create the services on
    the manager node.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们的集群已准备好，是时候在集群上安排一些服务了。如前所述，管理节点的作用是接受 Docker 命令并将其应用到集群中。因此，我们将在管理节点上创建服务。
- en: Note
  id: totrans-150
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: At this point, there really isn't much one can do on worker nodes as they are
    fully under the control of the manager.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，工作节点几乎不能做什么，因为它们完全受管理节点控制。
- en: Creating a Service
  id: totrans-152
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建服务
- en: 'This command is used to create a service:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于创建服务：
- en: '[PRE6]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: We run this on the manager as earlier alluded to. We are going to be using the
    WordPress example we built in the previous lesson. Since we already have this
    image locally, there will be no hassle pulling it from the hub.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 我们像之前提到的那样在管理节点上运行此命令。我们将使用前一节中构建的 WordPress 示例。由于我们本地已有该镜像，因此无需从 Hub 拉取。
- en: Our replica count is going to be three because we currently have three worker
    nodes; confirm your node number by running `docker node ls`.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的副本数量将设置为三，因为我们目前有三个工作节点；通过运行 `docker node ls` 确认您的节点数量。
- en: Note
  id: totrans-157
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'We do not create a replica count; this introduces the following topics.The
    `-p <host_port>:<container_port>` maps the container to be built on our computer''s
    defined port, against the container port. We do not need to have an equal number
    of replicas as our node number. Other nodes can handle different application layers,
    for example, the database:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 我们没有创建副本数量；这引入了以下主题。`-p <host_port>:<container_port>` 将容器映射到我们计算机定义的端口，对应容器端口。我们不需要副本数量与节点数量相等。其他节点可以处理不同的应用层，例如数据库：
- en: '![Creating a Service](img/image03_22.jpg)'
  id: totrans-159
  prefs: []
  type: TYPE_IMG
  zh: '![创建服务](img/image03_22.jpg)'
- en: We created a web, based on the WordPress image, and mapped the host port `80`
    to the container port `80`.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 我们基于 WordPress 镜像创建了一个 web，并将主机端口 `80` 映射到容器端口 `80`。
- en: Listing Services
  id: totrans-161
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出服务
- en: 'This command is used to view the currently running services:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于查看当前正在运行的服务：
- en: '[PRE7]'
  id: totrans-163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This command is used to view the currently running services and more information,
    such as the replicas, image, ports, and so on.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于查看当前正在运行的服务及更多信息，如副本、镜像、端口等。
- en: 'From the following output, we can see the service we just started and the associated
    information:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 从以下输出中，我们可以看到刚启动的服务及其相关信息：
- en: '![Listing Services](img/image03_23.jpg)'
  id: totrans-166
  prefs: []
  type: TYPE_IMG
  zh: '![列出服务](img/image03_23.jpg)'
- en: Service Status
  id: totrans-167
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 服务状态
- en: 'This command is used to know whether our services are operational:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令用于检查我们的服务是否在运行：
- en: '[PRE8]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Viewing the service listing will not provide us with all the information we
    need, such as what nodes our service is deployed on. However, we get to know whether
    our services are operational and the errors encountered, if any. When we run this
    on our manager, we get the following output:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 查看服务列表无法提供我们所需的所有信息，例如服务部署在哪些节点上。然而，我们可以知道服务是否在运行以及是否遇到任何错误。当我们在管理节点上运行此命令时，我们会看到以下输出：
- en: '![Service Status](img/image03_24.jpg)'
  id: totrans-171
  prefs: []
  type: TYPE_IMG
  zh: '![服务状态](img/image03_24.jpg)'
- en: Note
  id: totrans-172
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Viewing the status is very important. In a situation where we are running upgrades
    or updates on our nodes, running `docker ps` would inform us on the status of
    our nodes. In an ideal Docker Swarm setup, when a node goes down, the manager
    would reallocate traffic to the available nodes, thus it would be a little hard
    noticing downtime, unless monitoring is available. Before working with the nodes,
    always run this to check on the status of the nodes.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 查看状态非常重要。在我们对节点进行升级或更新的情况下，运行`docker ps`可以告知我们节点的状态。在理想的Docker Swarm设置中，当某个节点宕机时，管理节点会将流量重新分配到可用节点，因此很难察觉到停机，除非有监控系统。在与节点交互之前，务必先运行此命令检查节点的状态。
- en: How Do We Know Our Site is Running?
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 我们如何知道网站是否正在运行？
- en: 'We can verify WordPress is running by opening any of the workers'' IP addresses
    on our browser:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过在浏览器中打开任何一个工作节点的IP地址来验证WordPress是否正在运行：
- en: '![How Do We Know Our Site is Running?](img/image03_25.jpg)'
  id: totrans-176
  prefs: []
  type: TYPE_IMG
  zh: '![我们如何知道网站是否正在运行？](img/image03_25.jpg)'
- en: 'Here is a screenshot of how WordPress would appear on our browser:'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是WordPress在浏览器中显示的截图：
- en: '![How Do We Know Our Site is Running?](img/image03_26.jpg)'
  id: totrans-178
  prefs: []
  type: TYPE_IMG
  zh: '![我们如何知道网站是否正在运行？](img/image03_26.jpg)'
- en: Note
  id: totrans-179
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Opening any of the IP addresses running the WordPress web service, including
    the manager node, will open the same address.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 打开运行WordPress Web服务的任何IP地址，包括管理节点，将打开相同的地址。
- en: Activity 2 — Running Services on a Swarm
  id: totrans-181
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动 2 — 在Swarm上运行服务
- en: Ensure you have a manager node running.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 确保你有一个正在运行的管理节点。
- en: To get you conversant with service management in a swarm.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 让你熟悉在Swarm中管理服务。
- en: You have been asked to add a new `postgres` service to the swarm.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 你被要求将一个新的`postgres`服务添加到Swarm中。
- en: 'Create a new node and name it `dbworker`:'
  id: totrans-185
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新节点并命名为`dbworker`：
- en: '[PRE9]'
  id: totrans-186
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '![Activity 2 — Running Services on a Swarm](img/image03_27.jpg)'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![活动 2 — 在Swarm上运行服务](img/image03_27.jpg)'
- en: Add the new worker to the swarm:![Activity 2 — Running Services on a Swarm](img/image03_28.jpg)
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将新工作节点添加到Swarm：![活动 2 — 在Swarm上运行服务](img/image03_28.jpg)
- en: 'Create a new database service and name it `db`, using the postgres image as
    the base:'
  id: totrans-189
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的数据库服务并命名为`db`，使用postgres镜像作为基础：
- en: '[PRE10]'
  id: totrans-190
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Here is a screenshot of the output:'
  id: totrans-191
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 以下是输出的截图：
- en: '![Activity 2 — Running Services on a Swarm](img/image03_29.jpg)'
  id: totrans-192
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![活动 2 — 在Swarm上运行服务](img/image03_29.jpg)'
- en: 'Verify `postgres` is running through the following steps:'
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下步骤验证`postgres`是否在运行：
- en: 'Map the `postgres` container running in `dbworker node` to your computer:'
  id: totrans-194
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将运行在`dbworker node`中的`postgres`容器映射到你的计算机：
- en: '[PRE11]'
  id: totrans-195
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: '![Activity 2 — Running Services on a Swarm](img/image03_30.jpg)'
  id: totrans-196
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_IMG
  zh: '![活动 2 — 在Swarm上运行服务](img/image03_30.jpg)'
- en: Run `docker ps` to list running containers; this should have our `postgres`
    container and the status should be `UP`:![Activity 2 — Running Services on a Swarm](img/image03_31.jpg)
  id: totrans-197
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 运行`docker ps`列出正在运行的容器；这应该显示我们的`postgres`容器，并且状态应为`UP`：![活动 2 — 在Swarm上运行服务](img/image03_31.jpg)
- en: Exit and stop the container through the following:![Activity 2 — Running Services
    on a Swarm](img/image03_32.jpg)
  id: totrans-198
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下方式退出并停止容器：![活动 2 — 在Swarm上运行服务](img/image03_32.jpg)
- en: Scaling Services Up and Down
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 扩展服务
- en: As the number of requests coming into your application increases or decreases,
    there will be a need to scale the infrastructure. We have recently worked with
    node replicas running the same WordPress installation we made.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 随着请求量的增加或减少，需要扩展基础设施。我们最近使用节点副本运行了我们所安装的同一个WordPress。
- en: Note
  id: totrans-201
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: That is a very basic example of a production-level setup. Ideally, we would
    need a few more manager nodes and replicas, but since we are running a demo, this
    will be sufficient.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个非常基础的生产级设置示例。理想情况下，我们需要更多的管理节点和副本，但由于我们正在运行一个演示，这就足够了。
- en: Scaling involves both the increase and decrease of resources depending on an
    application's traffic.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 扩展涉及根据应用程序的流量增加和减少资源。
- en: Scaling Our Database Service
  id: totrans-204
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 扩展我们的数据库服务
- en: 'We will scale our database service as an example of how to scale services.
    In a real-world scenario, cloud services such as Google Cloud Platform and Amazon
    Web Services may have automatic scaling services defined, where a number of replicas
    are created and traffic is distributed across the replicas through a service known
    as **load balancing**. We will dig deeper into that in the next activity. First,
    we understand how scaling works from the basics. The command for scaling the database
    is in the following format:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将以数据库服务为例，展示如何扩展服务。在实际场景中，像Google Cloud Platform和Amazon Web Services这样的云服务可能会定义自动扩展服务，创建多个副本并通过名为**负载均衡**的服务在副本之间分配流量。我们将在下一个活动中深入探讨这一点。首先，我们从基础开始，了解扩展是如何工作的。扩展数据库的命令格式如下：
- en: '[PRE12]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: To scale the service, pass in the service name we provided when creating the
    service and the number of replicas you want to increase it to.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 要扩展服务，传入我们创建服务时提供的服务名称和希望扩展到的副本数。
- en: Note
  id: totrans-208
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The `--detach=false` allows us to view the replication progress.The command
    is `docker service scale <service_name>=<count>:`
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: '`--detach=false` 让我们查看复制进度。命令是 `docker service scale <service_name>=<count>:`'
- en: '![Scaling Our Database Service](img/image03_33.jpg)'
  id: totrans-210
  prefs: []
  type: TYPE_IMG
  zh: '![扩展我们的数据库服务](img/image03_33.jpg)'
- en: From the output above, we can see that our `db` service has been replicated.
    We now have two database services running on the `dbworker` node.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 从上面的输出中，我们可以看到我们的`db`服务已被复制。现在我们在`dbworker`节点上运行了两个数据库服务。
- en: How Does Swarm Know Where to Schedule a Service?
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Swarm如何知道在哪里调度服务？
- en: 'We covered scheduling modes earlier; they include the following:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前已经讨论过调度模式，包括以下几种：
- en: Random
  id: totrans-214
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 随机
- en: Spread
  id: totrans-215
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 扩展
- en: Binpack
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Binpack
- en: The default scheduling strategy for Docker Swarm is `spread`, which assigns
    a new service to the node with the **least** resources.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: Docker Swarm的默认调度策略是`spread`，它将新服务分配给资源**最少**的节点。
- en: Note
  id: totrans-218
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you don't have extra unassigned nodes on the swarm, the service you want
    to scale will be replicated on the currently running nodes.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Swarm中没有额外的未分配节点，则您想要扩展的服务将会在当前运行的节点上复制。
- en: The swarm manager will use the spread strategy and allocate according to resources.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: Swarm管理器将使用扩展策略，并根据资源分配。
- en: 'We can then verify that the action was indeed successful using the `docker
    service ls` command and we can see that the number of replicas is two:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们可以使用 `docker service ls` 命令验证操作是否成功，我们可以看到副本数为二：
- en: '![How Does Swarm Know Where to Schedule a Service?](img/image03_34.jpg)'
  id: totrans-222
  prefs: []
  type: TYPE_IMG
  zh: '![Swarm如何知道在哪里调度服务？](img/image03_34.jpg)'
- en: 'Scaling down is pretty similar to scaling up, only we pass a lower replica
    count than we had before. From the following output, we scale down to one replica
    and verify that the replica count is one:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 缩容与扩容非常相似，唯一的区别是我们传递的副本数比之前少。从以下输出中，我们将副本数缩减为一个，并验证副本数确实为一：
- en: '![How Does Swarm Know Where to Schedule a Service?](img/image03_35.jpg)'
  id: totrans-224
  prefs: []
  type: TYPE_IMG
  zh: '![Swarm如何知道在哪里调度服务？](img/image03_35.jpg)'
- en: How Does Swarm Load Balance Requests between Replicas?
  id: totrans-225
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Swarm如何在副本之间负载均衡请求？
- en: A load balancer helps in handling and managing requests in an application. In
    cases where an application handles a lot of requests, which could be 1,000 in
    less than 5 minutes, we would need to have multiple replicas and a load balancer
    on our application, specifically the logical (backend) section. The load balancer
    helps distribute requests and prevent overloading of an instance, eventually leading
    to downtime.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 负载均衡器有助于处理和管理应用程序中的请求。在一个应用程序处理大量请求的情况下（例如在5分钟内处理1,000个请求），我们需要在应用程序上（特别是逻辑部分，即后台）配置多个副本和负载均衡器。负载均衡器有助于分配请求，防止实例过载，从而避免停机。
- en: When deploying to production on a cloud platform such as **Google Cloud Platform**
    or **Amazon Web Services**, you can make use of an external load balancer to route
    requests to your swarm hosts.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 当部署到像**Google Cloud Platform**或**Amazon Web Services**这样的云平台时，您可以使用外部负载均衡器将请求路由到您的Swarm主机。
- en: Docker Swarm includes a built-in routing service that enables each node in the
    swarm to accept incoming connections to a published port, even if there is no
    service running on the node. `postgres` service uses port `5432` by default.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: Docker Swarm 包含一个内置的路由服务，使得即使某个节点上没有服务运行，群集中的每个节点也能接受对公开端口的传入连接。默认情况下，`postgres`
    服务使用端口 `5432`。
- en: Activity 3 — Scaling Services on a Swarm
  id: totrans-229
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动 3 — 在 Swarm 中扩展服务
- en: Ensure you have a swarm with at least one manager, two services, and three worker
    nodes.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 确保你的 Swarm 至少包含一个管理节点、两个服务和三个工作节点。
- en: To get you conversant with scaling services and replicating nodes.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 让你熟悉扩展服务和复制节点的操作。
- en: You have been asked to scale the web service to four replicas and the database
    service to two replicas.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 你被要求将 Web 服务扩展到四个副本，并将数据库服务扩展到两个副本。
- en: Create three new worker nodes, two for the web service and one for the database
    service.
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建了三个新的工作节点，其中两个用于 Web 服务，一个用于数据库服务。
- en: Connect to the manager node and scale the web and database services.
  id: totrans-234
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 连接到管理节点并扩展 Web 和数据库服务。
- en: 'Confirm the service replica count using docker service ls; the final result
    should be as follows:'
  id: totrans-235
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 docker service ls 确认服务副本数量；最终结果应该如下：
- en: The WordPress web service should have two replica counts
  id: totrans-236
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: WordPress Web 服务应该有两个副本
- en: The Postgres database service should have four replica counts
  id: totrans-237
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: Postgres 数据库服务应该有四个副本
- en: Summary
  id: totrans-238
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: 'In this lesson, we have done the following:'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 本课中，我们完成了以下内容：
- en: Talked about orchestration and mentioned a few example tools
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 讨论了编排，并提到了一些示例工具
- en: Discussed clustering and why it's important, especially in production-level
    setups
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 讨论了集群及其重要性，尤其是在生产环境中
- en: Learned about virtual hosts by running Docker Machines on VirtualBox
  id: totrans-242
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过在 VirtualBox 上运行 Docker Machines 学习了虚拟主机
- en: Walked through Docker Swarm and how to create and manage a cluster of nodes
  id: totrans-243
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 详细了解了 Docker Swarm 以及如何创建和管理一个节点集群
- en: Introduced example services including Wordpress running on our swarm
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 介绍了示例服务，包括在我们的集群中运行的 Wordpress
- en: Gained a high-level understanding of working with the `docker-machine cli`
  id: totrans-245
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 获得了关于使用 `docker-machine cli` 的高级理解
- en: Talked about load balancing and how Docker Swarm manages this
  id: totrans-246
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 讨论了负载均衡以及 Docker Swarm 如何管理这一过程
- en: Congratulations for getting to the finish line! Here's a recap of the knowledge
    we have gained through the lessons.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 恭喜你顺利完成！以下是我们通过课程所获得的知识回顾。
- en: 'In this book, we have covered the following:'
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 本书中，我们涵盖了以下内容：
- en: Talked about DevOps and how Docker contributes to the workflow
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 讨论了 DevOps 以及 Docker 如何促进工作流
- en: Understood how to template applications on Dockerfiles
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解了如何在 Dockerfile 中创建应用程序模板
- en: Built images and containers and pushed them to Docker Hub
  id: totrans-251
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建了镜像和容器并推送到 Docker Hub
- en: Managed containers through `docker-compose`
  id: totrans-252
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过 `docker-compose` 管理容器
- en: Learned how we can orchestrate our applications through Docker Swarm
  id: totrans-253
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 学习了如何通过 Docker Swarm 协调我们的应用程序
