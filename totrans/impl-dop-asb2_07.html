<html><head></head><body>
        

                            
                    <h1 class="header-title">Ansible Vault</h1>
                
            
            
                
<p>Modern day encryption solutions have come a long way since the initial concepts of encryption were invented and implemented back in the early days of computer science. Encryption and security are both hotbed topics within modern mainstream news outlets, as notable security breaches have initiated a heightened awareness of security fallacies and there has been an increase in guarding of sensitive data. With applications and customer's sensitive data moving toward the cloud, the necessity for an increased level of control and security is now greater than ever.</p>
<p>Modern <strong>Infrastructure as Code</strong> (<strong>IaC</strong>) solutions have paved the way for configuration management solutions to be stored within modern source control solutions. Managing and tracking infrastructure changes via a source control solution is highly valuable as it provides the ability for teams to ensure that IaC solutions are tracked through version control, and revisions are notated and backed up. In addition to these value points storing Ansible playbook's and related automation version control ensures teams can collaborate to create useful automation, Configuration Management solutions, and deployment tasks.</p>
<p>Creating playbook's and storing them within a modern source control solution makes a lot of sense and is a best practice. What does not make a lot of sense is storing sensitive data within source control. This is because it allows ANYONE with access to the source control solution to pry into potentially confidential information. Enter Ansible vault. It promises the ability to hide such sensitive data, to encrypt what is meant to be encrypted, and continues to allow playbook developers to store their playbooks in source control. Awesome right?</p>
<p>In this chapter, we will discover the Ansible vault. It provides us with a secure, easy-to-use solution to encrypt and store sensitive data within our playbook's or in a variables vault file. Specifically, in this chapter, we will cover the following subjects:</p>
<ul>
<li>The Ansible vault architecture</li>
<li>Basic vault usage</li>
<li>How data can be encrypted with Ansible vault</li>
<li>How to create, edit, and encrypt variable files</li>
<li>How to decrypt files in a secure manner</li>
<li>How to embed encrypted data within a YAML playbook</li>
<li>Running a playbook and decrypting data on the fly</li>
<li>Tips and tricks to best use Ansible vault</li>
</ul>
<p>Let's get started!</p>


            

            
        
    

        

                            
                    <h1 class="header-title">The Ansible Vault Architecture</h1>
                
            
            
                
<p>Ansible vault is designed for playbook developers, system administrators, and related personnel to store sensitive data within a playbook, variable file, or directory structure. The encryption system employed by Ansible vault is based on the <strong>Symmetrical Key Advanced Encryption System</strong> or <strong>AES Symmetrical Key</strong> solution. The AES Symmetrical Key encryption provides us with an easy-to-use way of using the same key to encrypt data as well as decrypt data. The following diagram provides an illustration of <strong>AES Symmetrical Key Encryption</strong>:</p>
<div><img height="253" width="742" class="image-border" src="img/5e2f1f6c-e41f-41e2-b20b-883dfb0b29b4.png"/></div>
<p>The Ansible vault solution has been designed to provide encryption services for any structured data file supported by Ansible. This means we can encrypt <kbd>group_vars/, AND host_vars/..</kbd> inventory variable directories. It also means we can encrypt variable files loaded within the <kbd>include_vars/vars_files</kbd>. As we can see from the preceding, the supported supported by Ansible's vault solution is vast. Basically in the end it means we can encrypt ANY and ALL data we want using the vault EXCEPT playbook's themselves.</p>
<p>Version 2.3 of Ansible includes a feature that supports encrypting single variable values within an Ansible YAML file. This is accomplished using the <kbd>!vault</kbd> tag. The result of this special tag allows us to inform Ansible to decrypt the value when processing the facts of the file.</p>
<p>In addition to the ability to encrypt variables and variable files, the entire playbook can be encrypted. More so, Ansible also supports the encryption of binary files, data files, and much more. These files can then be decrypted on the fly using <kbd>copy_file</kbd>. In addition to the copy file option, there are many others that are supported by Ansible vault. In the next sections, we will look at some examples of how to encrypt, decrypt, and rekey vault files on the fly and how we can leverage Ansible's vault later in the chapter. Before we dig into that, let's take a look at how to use the basic implementation of the Ansible vault and how to encrypt, decrypt, and rekey vault files.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Basic Vault Usage</h1>
                
            
            
                
<p>Ansible vault's most basic implementation is a simple AES Symmetric Key encryption solution (as we discussed earlier). The implementation of this is managed through the command-line interface, specifically the <kbd>ansible-vault</kbd> command. Using this command, we have the ability to encrypt, decrypt, rekey, and edit vault specific files. The syntax of each of these commands along with a description and example is provided next.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Encrypting an Ansible vault YAML file</h1>
                
            
            
                
<p>This command syntax allows us to encrypt the contents of a YAML file. Upon executing, it will prompt the user for the key they wish to use in order to encrypt it.</p>
<p>The content of the <kbd>my_vault.yml</kbd> file is shown here:</p>
<pre>
integer: 25<br/>string: "Hello Ansible Users"<br/>float: 25.0<br/>boolean: Yes
</pre>
<p>Then, in order to encrypt the file, execute the following command:</p>
<pre>
<strong>#&gt; ansible-vault encrypt my_vault.yml</strong>
</pre>
<p>The output of the command execution is shown next:</p>
<pre>
<strong>New Vault password: </strong><br/><strong>Confirm New Vault password:</strong><br/><strong>#&gt;</strong>
</pre>
<p>Once the file is encrypted, we can see the encryption via the <kbd>cat</kbd> command, as shown next:</p>
<div><img class="image-border" src="img/86931c42-81c4-4ca8-8f6a-0915ca447659.png"/></div>
<p>This example shows a simple way to encrypt and decrypt data using Ansible vault. This tactic is useful from a command line and manual input perspective, but it adds a human element to our automation execution that we may not always want. Encrypting files can also be done via a single command-line entry, as shown here:</p>
<pre>
<strong>$&gt; ansible-vault encrypt my_vault.yml --vault-password-file vault_pass.txt</strong><br/>Encryption successful
</pre>
<p>In this example, we can see that Ansible vault has the option of taking in a password file. The <kbd>vault_pass.txt</kbd> is simply a flat text file that contains the Ansible vault password. This command-line instructs Ansible to use the password in the text file instead of prompting for a password. This option makes automating the vault a lot easier as there is no required human intervention.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">To decrypt</h1>
                
            
            
                
<p>The <kbd>decrypt</kbd> option of Ansible vault decrypts the contents of a previously encrypted YAML vault file. Upon executing it, Ansible vault will prompt the user for the vault password to decrypt the file. Once the password has been inputted, Ansible uses AES Symmetric Key encryption to decrypt the file (if the correct key was entered). Let's look at an example.</p>
<p>First, let's start with our encrypted file that we created in the previous section on encrypting using Ansible vault. A screenshot of the encrypted vault file is provided next:</p>
<div><img class="image-border" src="img/7d9ba786-67ee-4b23-bb4d-07561b6111b9.png"/></div>
<p class="mce-root">Then, decrypt the file using the following command:</p>
<pre>
<strong>#&gt; ansible-vault decrypt my_vault.yml</strong>
</pre>
<p>The output of the execution of this command would be the following:</p>
<pre>
<strong>#&gt; Vault password:</strong><br/>Decryption successful
</pre>
<p>Once the file is decrypted, we can see the decrypted file as such:</p>
<div><img class="image-border" src="img/3228a93f-5ea3-4e09-950c-7bd95ab3ece6.png"/></div>
<p>Similar to the encryption mechanism we talked about earlier, we can also specify the vault key in the keyfile form on the command line. This will help us better automate things and remove the need for us to manually type the password. An example is shown next:</p>
<pre>
<strong>$&gt; ansible-vault decrypt my_vault.yml --vault-password-file vault_pass.txt</strong><br/>Encryption successful
</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">To rekey an Ansible vault file</h1>
                
            
            
                
<p>Changing the key that Ansible vault uses to encrypt/decrypt a vault file is a fairly simplistic task. It simply involves using the <kbd>rekey</kbd> operator within the Ansible vault command-line context. In the following example, the <kbd>rekey</kbd> command syntax is shown:</p>
<pre>
<strong>#&gt; ansible-vault rekey &lt;file.yml&gt;</strong>
</pre>
<p>Upon running the previous command, we will be prompted for the existing key and a new key. The output (if the <kbd>rekey</kbd> was a success) should look something like the following:</p>
<div><img class="image-border" src="img/dfb00d6b-d17e-4c16-af3e-fb9dc56df8ae.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Editing in place</h1>
                
            
            
                
<p>The Ansible vault solution provides a handy way of editing vault encrypted information on the fly using the default system editor. Within the context of a Linux operating system, the default editor can be set on the command line using the following command syntax:</p>
<pre class="p1">
export EDITOR='vi'
</pre>
<p>In the previous code, we set the editor to be <kbd>vi</kbd>; however, you can set it to any editor of your preference [<kbd>nano</kbd>, <kbd>pico</kbd>, <kbd>vi</kbd>, <kbd>vim</kbd>, and so on).</p>
<p>Usually on Linux systems, the default editor is usually set to <kbd>vi</kbd>.</p>
<p>Now that we have the default editor in place, we can edit our Ansible vault data by issuing the <kbd>edit</kbd> command option in conjunction with the <kbd>ansible-vault</kbd> command. Let's look at an example:</p>
<pre class="p1">
<strong>#&gt; ansible-vault edit my_vault.yml</strong>
</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Decrypting the vault when running a playbook</h1>
                
            
            
                
<p>Encrypting, decrypting, and rekeying Ansible vault data manually is one thing; using this information on the fly within the context of playbook execution is what we really want to achieve. In this section, we will cover how to decrypt the Ansible vault encrypted data within the context of playbook execution.</p>
<p>There are two ways to automatically decrypt the vault data embedded within a playbook or variables file. The first is by storing the vault key within a flat text file and then passing this key file to the <kbd>ansible-playbook</kbd> command. The second is to use the <kbd>--ask-vault-pass</kbd> command-line option to prompt the user for the vault password. Let's take a look at how each of these options works.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Automatically decrypting using password files</h1>
                
            
            
                
<p>The most desirable way to decrypt Ansible vaulted data is to do so without user intervention. This option opens the door for a more flexible automation approach (initiating it through Jenkins, CircleCI, Bamboo, or whatever). To implement this solution, the trick is to store the Ansible vault password within a password file. For example, if we were to have a <kbd>vars</kbd> file, we would encrypt it using the <kbd>encrypt</kbd> option and then store the key we used to encrypt it in the flat text file. Then, when running the <kbd>ansible-playbook</kbd> command, we could pass the <kbd>vault-password-file</kbd> directly. The syntax of this is shown next:</p>
<pre class="p1">
<strong>$&gt; ansible-playbook -i inventory/qa.hosts playbooks/example.yml --vault-password-file ~/.vault_pass.txt</strong>
</pre>
<p>The password should be a string stored as a single line in the file.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Manually decrypting vault data</h1>
                
            
            
                
<p>The alternative approach to decrypting Ansible vaulted data would be to have Ansible prompt the user for the password upon executing the playbook. This can be accomplished in a simple manner as well. The following command syntax shows how to instruct Ansible to prompt the user for the vault password prior to executing a playbook:</p>
<pre class="p1">
<strong>$&gt; ansible-playbook -i inventory/qa.hosts playbooks/example.yml --ask-vault-pass</strong>
</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Real-world Ansible Vault Workflow</h1>
                
            
            
                
<p>The Ansible vault implementation is a really robust solution designed to provide security for sensitive information. The implementation (as you learned already) allows us to encrypt, decrypt, rekey, and edit private data with ease. As easy as the vault is to use, finding a maintainable way to utilize the Ansible vault is not always easily apparent. As such, within this section, we will discuss some tips and tricks that can make your Ansible vault experience a bit more enjoyable.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Ansible vault with roles</h1>
                
            
            
                
<p>The Ansible vault implementation is best leveraged in conjunction with roles. Roles (as we discussed earlier) allow us to modularize our playbooks and reuse functionality within them. The specific area of the roles implementation we are going to look at would be the vars folder. The vars folder is where we define our variables and data points that are then used by the tasks and plays.</p>
<p>To begin with this tutorial, let's start by creating an Ansible playbook with the following folder and file structure (the contents of the files can be blank for now, as we will fill in the details in just a moment):</p>
<div><img class="image-border" src="img/1f088786-a35a-48ac-ab46-9551d3790482.png"/></div>
<p>Once created, there are a few things that should become immediately apparent. The first is that the playbook we are creating is a simple vault test with a single role and a <kbd>sensitive_data</kbd> variable's implementation. Also, as you may have guessed, we will be using the <kbd>sensitive_data.yml</kbd> file to store our super secret information. The contents of this file should reflect the following:</p>
<pre class="p1">
---<br/>secret_text: |<br/>  The contents of this message are secret. This tape will explode in 5 seconds.
</pre>
<p class="p1">As we can see from the provided file content, we have a simple vars file with a variable defined within, titled <kbd>secret_text</kbd>.</p>
<p>The YAML syntax supports multi-line variable implementations. This is accomplished via the <kbd>|</kbd> or pipe character, which is provided at the end of the line.</p>
<p class="p1">Now that sensitive data has been created, let's encrypt our vars file using the Ansible vault encrypt command. This is accomplished via the following command-line entry:</p>
<pre class="p1">
<strong>#&gt; ansible-vauult encrypt sensitive_data.yml</strong>
</pre>
<p>Now that the file is encrypted, we can create our role file, call it the <kbd>main.yml</kbd> file, and populate our role information. The contents of <kbd>main.yml</kbd> should look like the following:</p>
<pre class="p1">
---<br/>- include_vars: sensitive_data.yml<br/>- name: Copy sensitive data file from Ansible control server to target hosts<br/>  copy:<br/>    content="{{secret_text}}"<br/>    dest=/tmp/secret_text.txt
</pre>
<p class="p1">Finally, let's create our <kbd>playbook.yml</kbd> file. These files are going to be really simple and only point to a single role (<kbd>vaulttest</kbd>). Let's take a look at the contents of these files:</p>
<pre class="p1">
---<br/># File: playbook.yml<br/>- hosts: all<br/><br/>roles:<br/> - { role: vaulttest }
</pre>
<p class="p1">Now that we have all our files created, let's go ahead and <kbd>commit</kbd> our code to source control (if applicable) and test it out. The command to run the solution is provided next:</p>
<pre class="p1">
<strong>#&gt; ansible-playbook -i 'localhost,' -c local playbook.yml --ask-vault-pass</strong>
</pre>
<p class="p1">The following is the output you should see when running it:</p>
<div><img class="image-border" src="img/16b8d073-ba3b-4b9e-a8fa-ba245ac6b060.png"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, you learned about Ansible vault. You also learned how to encrypt files, decrypt them, rekey an encrypted file, edit them on the fly, and use the data within a playbook. Ansible vault provides us with a really simple way to encrypt and store encrypted data. As we saw through examples, the encrypting and decrypting of files within the ansible vault architecture does not need to be complex or complicated. The techniques we discussed within this chapter have wide applicable use within an IT operations- or DevOps-oriented organization.</p>
<p>In the next chapter, we will talk about Ansible's wide arrange of module and libraries. This chapter will help us identify some of the more popular modules and libraries that Ansible provides to integrate it with other tools. Let's proceed.</p>
<p class="p1"/>


            

            
        
    </body></html>