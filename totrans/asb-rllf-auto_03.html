<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-53"><a id="_idTextAnchor052"/>3</h1>
<h1 id="_idParaDest-54"><a id="_idTextAnchor053"/>Automating Your Daily Jobs</h1>
<p>Are you struggling to find automation use cases to start with Ansible automation? Your workplace is a great place to start your search for automation use cases. Track the most repeated jobs that you or your team are doing every day and you will see the opportunity to automate these tasks. This can be simple server information gathering, collecting operating system versions, or a simple weekly reboot job. </p>
<p>In this chapter, you will learn how to use the Jinja2 template to create reports and emails with the help of Ansible. You will also learn how to develop Ansible artifacts in a modular way and include tasks and variables dynamically. </p>
<p>In this chapter, we will cover the following topics: </p>
<ul>
<li>Using Ansible to collect server details</li>
<li>Collecting system information</li>
<li>System scanning and remediation using Ansible</li>
<li>Automated weekly system reboot using Ansible</li>
<li>Automating notifications</li>
</ul>
<p>We will start with <code>ansible_facts</code> and learn how to extract the data for your system reports. The chapter will explain how to collect data, insert it into an HTML report, and store it on web servers. Then, you will learn how to configure standard system files and automate a server reboot with an email notification.</p>
<h1 id="_idParaDest-55"><a id="_idTextAnchor054"/>Technical requirements</h1>
<p>The following are the technical requirements for this chapter:</p>
<ul>
<li>A Linux machine for the Ansible control node</li>
<li>Two or more Linux machines with Red Hat repositories configured (if you are using other Linux operating systems instead of <strong class="bold">Red Hat Enterprise Linux</strong> (<strong class="bold">RHEL</strong>) machines, then make sure you have the appropriate repositories configured to get packages and updates)</li>
</ul>
<p>All the Ansible configurations, playbooks, commands, and snippets for this chapter can be found in this book’s GitHub repository at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-03">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-03</a>. </p>
<h1 id="_idParaDest-56"><a id="_idTextAnchor055"/>Using Ansible to collect server details</h1>
<p>In the previous <a id="_idIndexMarker144"/>chapter, you learned how to use Ansible for basic automation by using simple playbooks and tasks. In this chapter, you will learn more by automating the simple day-to-day jobs in your workplace. </p>
<p>An up-to-date system inventory with easy access is the dream of every system engineer and IT team. In large enterprises, it is <a id="_idIndexMarker145"/>common to use <strong class="bold">configuration management database</strong> (<strong class="bold">CMDB</strong>) software. However, engineers must maintain their spreadsheets to keep the server and device information they are managing. When you have software-defined infrastructures such as virtual machines and virtual appliances, verifying and updating these local spreadsheets will become a tedious task.</p>
<p>Maintaining such information can be automated using Ansible, as shown in the following diagram:</p>
<div><div><img alt="Figure 3.1 – Maintaining a system information database using Ansible " height="627" src="img/B18383_03_01.jpg" width="1167"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – Maintaining a system information database using Ansible</p>
<p>Ansible <a id="_idIndexMarker146"/>and <code>ansible_facts</code> can be used to create and update your system inventory database or your own CMDB. <code>ansible_facts</code> provides detailed and informative data that’s gathered from the target nodes (managed nodes) and stored in <code>setup</code> module at the beginning of each play in the playbook. If you remember the <code>chrony</code> package installation playbook, check the <code>TASK [Gathering Facts]</code> line, which shows the <code>setup</code> module running in the background:</p>
<div><div><img alt="Figure 3.2 – An Ansible fact-gathering task by the setup module " height="297" src="img/B18383_03_02.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2 – An Ansible fact-gathering task by the setup module</p>
<p><code>ansible_facts</code> can be used to make decisions inside the playbook, such as skipping the task if the system memory is less than the required value or installing specific packages, depending on the operating system version of the target node.</p>
<h2 id="_idParaDest-57"><a id="_idTextAnchor056"/>Ansible roles</h2>
<p>An Ansible role is a <a id="_idIndexMarker147"/>collection of tasks, handlers, templates, and variables for configuring the target system so that it meets the desired state. Ansible roles enable content sharing without much trouble as we can include the required variables, tasks, templates, and other files in the role directory itself. Ansible roles are meant for reusability and collaborative support in such a way that the same roles can be distributed to teams or the public. Other users can use the roles to achieve the same task:</p>
<ul>
<li>With Ansible roles, we can easily share a playbook’s content with other teams by sharing the entire role directory. For example, it is possible to write a role for <code>install_dbserver</code> or <code>setup_webserver</code> and later share it with the public/other teams.</li>
<li>Larger projects can be created in a modular way.</li>
<li>Different users can create different roles in parallel and share the same project. For example, developer 1 writes a role for <code>install_dbserver</code> and developer 2 focuses on the <code>setup_webserver</code> role.</li>
</ul>
<p>Let us learn about the directory structure of Ansible roles in the next section.</p>
<h3>Roles directory structure</h3>
<p>The content <a id="_idIndexMarker148"/>of Ansible roles is arranged in an organized way. The top-level directory defines the name of the role itself, as shown in the following screenshot (we will create these roles and their content later in this chapter):</p>
<div><div><img alt="Figure 3.3 – Sample project directory with roles " height="846" src="img/B18383_03_03.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Sample project directory with roles</p>
<p>In the preceding <a id="_idIndexMarker149"/>screenshot, I have two roles named <code>deploy-web-server</code> and <code>security-baseline-rhel8</code> under <a id="_idTextAnchor057"/>my <code>roles</code> directory. Some of the directories contain <code>main.yml</code>, which contains tasks, variables, or handlers:</p>
<ul>
<li><code>Defaults/main.yml</code>: This contains variables for the role that can be overwritten when the role is used.</li>
<li><code>tasks/main.yml</code>: This contains the main list of tasks to be executed when using the role.</li>
<li><code>vars/main.yml</code>: This contains internal variables for the role.</li>
<li><code>files</code>: This contains static files that can be referenced from this role.</li>
<li><code>templates</code>: This is the jinja2 templates that can be used via this role.</li>
<li><code>handlers/main.yml</code>: This contains the handler definitions.</li>
<li><code>meta/main.yml</code>: This defines some metadata for this role, such as the author, license, platform, and dependencies.</li>
<li><code>tests</code>: This is an inventory. <code>test.yml</code> file that can be used to test this role.</li>
</ul>
<p>The default variables<a id="_idIndexMarker150"/> can be defined under <code>defaults/main.yml</code>; additional role variables can be defined inside <code>vars/main.yml</code>. However, depending on the location of your variable and variable precedence, Ansible will apply the appropriate value for the variable. Refer to <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#understanding-variable-precedence">https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#understanding-variable-precedence</a> to learn and understand more about variable precedence.</p>
<p class="callout-heading">Ansible Roles</p>
<p class="callout">There are over 10,000 roles available in <a id="_idIndexMarker151"/>Ansible Galaxy (<a href="https://galaxy.ansible.com">https://galaxy.ansible.com</a>) that have been contributed by the community. Users can freely download and use them for their Ansible automation process. If the organization is looking for certified content collections (collections and roles), then we can find them by going to Red Hat Automation Hub (at the <a href="http://console.redhat.com">console.redhat.com</a> portal). Read <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.xhtml</a> to learn more about Ansible roles. Find the official Red Hat roles at <a href="https://galaxy.ansible.com/RedHatOfficial">https://galaxy.ansible.com/RedHatOfficial</a>.</p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor058"/>Ansible Jinja2 templates</h2>
<p><code>template</code> module (or the Ansible <code>template</code> filter) to convert the Jinja2 template into actual content or a file. Ansible will replace the variable with values as needed.</p>
<p>For example, a standard <code>/etc/motd</code> file can be deployed to your servers by using the appropriate values dynamically. Your Jinja2 template will look as follows (it may look different, based on your customization):</p>
<div><div><img alt="Figure 3.4 – Jinja2 template for the motd file " height="405" src="img/B18383_03_04.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4 – Jinja2 template for the motd file</p>
<p>Inside the <a id="_idIndexMarker154"/>playbook, you will <code>template</code> the file and transfer it to the target machine using the <code>template</code> module (do not use the <code>copy</code> module as the templating will not work):</p>
<div><div><img alt="Figure 3.5 – Using template module in playbook " height="219" src="img/B18383_03_05.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5 – Using template module in playbook</p>
<p>On the target machine, the variables inside the Jinja2 template will be replaced with values, as follows:</p>
<div><div><img alt="Figure 3.6 – The /etc/motd file that was created using the Jinja2 template " height="405" src="img/B18383_03_06.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6 – The /etc/motd file that was created using the Jinja2 template</p>
<p>Any level of complexity and loops can be used inside the template to create dynamic output files. Some <a id="_idIndexMarker155"/>of the use cases generate reports, web server configuration (HTTPS, Nginx), system configuration files (<code>/etc/hosts</code>, <code>/etc/motd</code>, and <code>/etc/fstab</code>), and more.</p>
<p class="callout-heading">Ansible Jinja2 Templating</p>
<p class="callout">Read more <a id="_idIndexMarker156"/>about Ansible Jinja2 templating at <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.xhtml">https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.xhtml</a>.</p>
<p>In this use case, you will extract the required information using <code>ansible_facts</code> from <code>node1</code> (and other machines if you have some) and store it as an HTML report inside a web server (<code>node2</code>), as shown in the following diagram:</p>
<div><div><img alt="Figure 3.7 – Machines for the Ansible CMDB use case " height="557" src="img/B18383_03_07.jpg" width="1095"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7 – Machines for the Ansible CMDB use case</p>
<p>For the following use case, we need to deploy a web server. We will use Ansible to deploy and configure the web server on <code>node2</code>.</p>
<p>Follow these steps to deploy a web server using an Ansible role:</p>
<ol>
<li>On your Ansible control node, create a new directory called <code>Chapter-03</code> and create an <code>ansible.cfg</code> file, as follows:</li>
</ol>
<div><div><img alt="Figure 3.8 – The ansible.cfg file " height="378" src="img/B18383_03_08.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8 – The ansible.cfg file</p>
<ol>
<li value="2">Create<a id="_idIndexMarker157"/> a <code>hosts</code> file in the same directory as the <code>node-1</code> managed node (use the correct IP address as per your lab or environment):</li>
</ol>
<div><div><img alt="Figure 3.9 – The Ansible inventory (hosts) file " height="282" src="img/B18383_03_09.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9 – The Ansible inventory (hosts) file</p>
<p>In the preceding screenshot, <code>[nodes:vars]</code> is the group variable. The variables will be available for all managed nodes under the <code>nodes</code> host group. </p>
<ol>
<li value="3">Now, create an Ansible role to deploy a web server on <code>node2</code> using Apache:<pre>[ansible@ansible Chapter-03]$ mkdir roles
[ansible@ansible Chapter-03]$ cd roles/</pre></li>
<li>Once you have created the <code>roles</code> directory, initiate a new Ansible role using the <code>ansible-galaxy</code> command. The <code>ansible-galaxy</code> command will initiate and <a id="_idIndexMarker158"/>create the skeleton directory structure for the role:</li>
</ol>
<div><div><img alt="Figure 3.10 – Initializing the Ansible role with the ansible-galaxy command " height="113" src="img/B18383_03_10.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10 – Initializing the Ansible role with the ansible-galaxy command</p>
<ol>
<li value="5">Verify the content of the <code>roles</code> directory:</li>
</ol>
<div><div><img alt="Figure 3.11 – The roles directory’s content " height="546" src="img/B18383_03_11.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11 – The roles directory’s content</p>
<ol>
<li value="6">Add the following tasks to the <code>roles/deploy-web-server/tasks/main.yml</code> file to install the <code>firewalld</code> and <code>httpd</code> packages:</li>
</ol>
<div><div><img alt="Figure 3.12 – Installing httpd and firewalld " height="496" src="img/B18383_03_12.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12 – Installing httpd and firewalld</p>
<ol>
<li value="7">Add <a id="_idIndexMarker159"/>more tasks to the role to enable the firewall service and permit the <code>httpd</code> service in the firewall, as follows:</li>
</ol>
<div><div><img alt="Figure 3.13 – Ansible web deploy role – enabling the firewalld service and permitting httpd in the firewall " height="494" src="img/B18383_03_13.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13 – Ansible web deploy role – enabling the firewalld service and permitting httpd in the firewall</p>
<ol>
<li value="8">Finally, add the task for enabling and starting the <code>httpd</code> service, as follows:</li>
</ol>
<div><div><img alt="Figure 3.14 – Ansible web deploy role – enabling and starting httpd " height="309" src="img/B18383_03_14.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14 – Ansible web deploy role – enabling and starting httpd</p>
<p>The <code>tasks/main.yml</code> file will create the <code>/var/www/html</code> directory and install the <code>httpd</code> and <code>firewalld</code> packages. Then, it will start the <code>httpd</code> and <code>firewalld</code> services and open <code>httpd</code> ports in the firewall.</p>
<p>Remove <a id="_idIndexMarker160"/>other unwanted directories and files (automatically generated) inside the <code>deploy-web-server</code> role directory. In this case, leave it as-is and proceed with the next step.</p>
<ol>
<li value="9">Create a playbook called <code>Chapter-03/deploy-web.yml</code> so that you can deploy the web server (remember to go back to the main directory – that is, <code>Chapter-03</code>):</li>
</ol>
<div><div><img alt="Figure 3.15 – Ansible playbook to call the role " height="309" src="img/B18383_03_15.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15 – Ansible playbook to call the role</p>
<p>Now, your directory will contain the following contents:</p>
<div><div><img alt="Figure 3.16 – The project directory’s content " height="255" src="img/B18383_03_16.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16 – The project directory’s content</p>
<ol>
<li value="10">Execute <a id="_idIndexMarker161"/>the <code>deploy-web.yml</code> playbook to deploy the web server on <code>node2</code>:</li>
</ol>
<div><div><img alt="Figure 3.17 – Executing the web server deployment playbook " height="777" src="img/B18383_03_17.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.17 – Executing the web server deployment playbook</p>
<p>The same playbook can be executed multiple times and Ansible will execute or skip the operation in the backend based on the desired status. This feature is called <strong class="bold">idempotency</strong> in<a id="_idIndexMarker162"/> Ansible, by which the Ansible module will check the desired status (for example, installing packages or copying files) and execute the operation only if required. </p>
<p class="callout-heading">Ansible Idempotency</p>
<p class="callout"><em class="italic">“An operation is idempotent if the result of performing it once is the same as the result of performing it repeatedly without any intervening actions.”</em> – Ansible Glossary (<a href="https://docs.ansible.com/ansible/latest/reference_appendices/glossary.xhtml">https://docs.ansible.com/ansible/latest/reference_appendices/glossary.xhtml</a>)</p>
<p>Let’s execute the<a id="_idIndexMarker163"/> same playbook again and check the difference. Here, we can see the <code>ok</code> status instead of <code>changed</code> (<em class="italic">Figure 3.17</em>) since Ansible has not executed the operation. This is because the <code>firewalld</code> and <code>httpd</code> packages have been installed and the services have been started already (the desired state has already been met):</p>
<div><div><img alt="Figure 3.18 – Executing the deployment playbook again and noticing the ok status instead of changed " height="536" src="img/B18383_03_18.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.18 – Executing the deployment playbook again and noticing the ok status instead of changed</p>
<p>Now, verify the web server by visiting the server IP or <strong class="bold">Fully Qualified Domain Name</strong> (<strong class="bold">FQDN</strong>) in a web browser (you may see different or similar pages, depending on the operating system and version):</p>
<div><div><img alt="Figure 3.19 – Default Apache web page " height="644" src="img/B18383_03_19.jpg" width="861"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.19 – Default Apache web page</p>
<p>Log in to <code>node2</code> and remove the default <code>welcome.conf</code> file so that you can see the directory content of <code>/var/www/html</code>:</p>
<pre class="source-code">
[root@node-2 ~]# mv /etc/httpd/conf.d/welcome.conf .</pre>
<p>This is not <a id="_idIndexMarker164"/>the best practice in production, and you need to configure your web server with adequate permissions and directory listing options. The preceding step was mentioned to explain the demo and web server functionality.</p>
<p>With that, you have deployed a web server using an Ansible role to keep the systems information reports or CMDB.</p>
<p class="callout-heading">Note</p>
<p class="callout">There are many open source projects that can be used to implement CMDB, such as using Ansible facts such as Ansible-CMDB (<a href="https://ansible-cmdb.readthedocs.io/en/latest/">https://ansible-cmdb.readthedocs.io/en/latest/</a>). Refer to the project documentation and repository for detailed information.</p>
<h1 id="_idParaDest-59"><a id="_idTextAnchor059"/>Collecting system information</h1>
<p>In this section, you <a id="_idIndexMarker165"/>will extract the required information from <code>ansible_facts</code> and generate HTML reports inside the web server that you created in the previous section.</p>
<p><code>ansible_facts</code> contains a lot of information about nested dictionaries and lists. Search and go through the content and find the important information you need for your report.</p>
<p>To see the content of <code>ansible_facts</code>, execute the following ad hoc command:</p>
<div><div><img alt="Figure 3.20 – Ansible facts output after using an ad hoc command " height="573" src="img/B18383_03_20.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.20 – Ansible facts output after using an ad hoc command</p>
<p>Using the <code>less</code> or <code>more</code> commands after the pipe (<code>|</code>) symbol will keep the output on top without you having to scroll to the bottom. It is possible to scroll down or up using the arrow keys or find the text by searching for it (<code>/</code> + <code>&lt;text&gt;</code>).</p>
<p>Find sample <code>ansible_facts</code> details for a Linux machine at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-03/node1-ansible-facts">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-03/node1-ansible-facts</a>.</p>
<p>Follow these steps <a id="_idIndexMarker166"/>to use some of the variables from the preceding <code>setup</code> output:</p>
<ol>
<li value="1">Create a role called <code>Chapter-03/roles/system-report</code> to generate the HTML reports, as follows:</li>
</ol>
<div><div><img alt="Figure 3.21 – Creating a new Ansible role for the system report " height="149" src="img/B18383_03_21.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.21 – Creating a new Ansible role for the system report</p>
<ol>
<li value="2">Create a Jinja2 template file called <code>roles/system-report/templates/system-information.xhtml.j2</code> and add the HTML header and other details inside the template file:</li>
</ol>
<div><div><img alt="Figure 3.22 – Jinja2 template for HTML report " height="1156" src="img/B18383_03_22.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.22 – Jinja2 template for HTML report</p>
<p>Find the <a id="_idIndexMarker167"/>full Jinja2 template at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/blob/main/Chapter-03/roles/system-report/templates/system-information.xhtml.j2">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/blob/main/Chapter-03/roles/system-report/templates/system-information.xhtml.j2</a>. You may have already noticed the variables that are being used inside the Jinja2 template, as follows:</p>
<ul>
<li><code>{{ ansible_hostname }}</code>: The hostname of the managed node.</li>
<li><code>{{ ansible_all_ipv4_addresses }}</code>: The IP address list.</li>
<li><code>{{ ansible_architecture }}</code>: The architecture of the target machine.</li>
<li><code>{{ ansible_distribution }}</code> and <code>{{ ansible_distribution_version }}</code>: The operating system’s distribution and version.</li>
<li><code>{{ report_admin_email }}</code>: This is a custom variable you need to define in the playbook.</li>
</ul>
<ol>
<li value="3">Create <a id="_idIndexMarker168"/>the <code>roles/system-report/tasks/main.yml</code> file with the following content:</li>
</ol>
<div><div><img alt="Figure 3.23 – The task file for the system report role " height="255" src="img/B18383_03_23.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.23 – The task file for the system report role</p>
<p>In the preceding example, the <code>template</code> module will convert the template into the target HTML file with variables replaced with values. Since the report needs to be saved in the web server path, the task will be delegated to <code>node2</code> (the web server).</p>
<ol>
<li value="4">Create the <code>Chapter-03/system-info.yml</code> playbook and include the <code>system-report </code>role:</li>
</ol>
<div><div><img alt="Figure 3.24 – The Ansible playbook for collecting system information " height="378" src="img/B18383_03_24.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.24 – The Ansible playbook for collecting system information</p>
<ol>
<li value="5">Execute <a id="_idIndexMarker169"/>the playbook and verify its output:</li>
</ol>
<div><div><img alt="Figure 3.25 – Collecting system information " height="442" src="img/B18383_03_25.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.25 – Collecting system information</p>
<ol>
<li value="6">Check the web server to view the report, as follows:</li>
</ol>
<div><div><img alt="Figure 3.26 – The report that was generated on the web server " height="355" src="img/B18383_03_26.jpg" width="634"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.26 – The report that was generated on the web server</p>
<ol>
<li value="7">Click on <code>node1.xhtml</code> to see <a id="_idIndexMarker170"/>its content, as follows:</li>
</ol>
<div><div><img alt="Figure 3.27 – System information report generated by Ansible " height="370" src="img/B18383_03_27.jpg" width="861"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.27 – System information report generated by Ansible</p>
<p>This is a very basic HTML report template that explains the capability of the Jinja2 template and <code>ansible_facts</code>. Expand the template with additional items, CSS styles, or even different formats such as Markdown, CSV, or JSON. Also, it is possible to keep the report in alternate locations such as a GitHub server or web server with authentication.</p>
<h1 id="_idParaDest-60"><a id="_idTextAnchor060"/>System scanning and remediation using Ansible</h1>
<p>Security scanning <a id="_idIndexMarker171"/>and remediation are critical, and organizations are spending more time and money on this area every year. When there are new features and <a id="_idIndexMarker172"/>changes in the operating system and applications, you will have more configurations to check and validate to ensure the best security practices are in place. With the help of Ansible, it is possible to automate the security scanning and remediation tasks for your systems and devices.</p>
<p>In this section, you will automate a few basic security and compliance configurations based on the CIS Red Hat Enterprise Linux 8 Benchmark. </p>
<p class="callout-heading">CIS Benchmark</p>
<p class="callout">CIS provides the best practices and configurations for systems and platforms to ensure security and compliance. Refer to <a href="https://www.cisecurity.org/cis-benchmarks">https://www.cisecurity.org/cis-benchmarks</a> to learn more about CIS Benchmarks.</p>
<p>When we have several tasks in a playbook or role, then we can split the tasks into multiple files and call them using the <code>include_tasks</code> module dynamically. For example, different parts of security remediation tasks can be split into different tasks files so that they can be called from <code>main.yaml</code>, as shown in the following diagram:</p>
<div><div><img alt="Figure 3.28 – Splitting tasks into multiple files " height="563" src="img/B18383_03_28.jpg" width="889"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.28 – Splitting tasks into multiple files</p>
<p>Such methods can help us develop, test, and execute the tasks dynamically and in a modular way. </p>
<p>Follow these steps to develop a <a id="_idIndexMarker173"/>security remediation use case:</p>
<ol>
<li value="1">Create a new role called <code>Chapter-03/roles/security-baseline-rhel8</code>:</li>
</ol>
<div><div><img alt="Figure 3.29 – Creating a new role for security baselining " height="168" src="img/B18383_03_29.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.29 – Creating a new role for security baselining</p>
<ol>
<li value="2">Add the necessary security baseline configurations to <code>roles/security-baseline-rhel8/tasks/main.yml</code>.</li>
</ol>
<p>As I mentioned at the beginning of this section (<em class="italic">Figure 3.28</em>), in this example, you will learn how to split the tasks into multiple files and develop playbooks in a modular way. Add the following content to <code>roles/security-baseline-rhel8/tasks/main.yml</code>:</p>
<div><div><img alt="Figure 3.30 – The main task file for the security baselining role " height="353" src="img/B18383_03_30.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.30 – The main task file for the security baselining role</p>
<p>You have two <a id="_idIndexMarker174"/>tasks and both are calling other tasks files via the <code>include_tasks</code> module. There is an important line you need to take note of, as follows:</p>
<ul>
<li><code>when: “’01.01’ not in baseline_exclusions”</code>: This is a mechanism we are adding to the task to control the execution of specific baseline rule using the <code>when</code> statement. Ansible will check the condition and execute or skip the tasks based on this condition. In this case, you need to define a list variable called <code>baseline_exclusions</code> and add the specific item to exclude from execution. (Use any other string or numbering system; this is just a sample list for this demonstration.)</li>
</ul>
<ol>
<li value="3">Create a file called <code>roles/security-baseline-rhel8/tasks/part-01.yml</code> that contains the following content to install <code>sudo</code> and enable <code>sudo</code> logging:</li>
</ol>
<div><div><img alt="Figure 3.31 – part-01.yml for the sudo configuration " height="458" src="img/B18383_03_31.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.31 – part-01.yml for the sudo configuration</p>
<p>The first <a id="_idIndexMarker175"/>task will install the <code>sudo</code> package, while the second will enable <code>sudo</code> logging. There is an important line you need to take note of, as follows:</p>
<ul>
<li><code>line: ‘Defaults logfile=”{{ sudo_log }}”’</code>: You need to define this <code>sudo_log</code> variable in the playbook.</li>
</ul>
<ol>
<li value="4">Create another task file called <code>roles/security-baseline-rhel8/tasks/part-02.yml</code> with the following content to deploy the default <code>/etc/motd</code> and <code>/etc/issue</code> files:</li>
</ol>
<div><div><img alt="Figure 3.32 – part-02.yml for the motd configuration " height="536" src="img/B18383_03_32.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.32 – part-02.yml for the motd configuration</p>
<p>The first task<a id="_idIndexMarker176"/> will deploy default content to <code>/etc/motd</code>, while the second will deploy content to the <code>/etc/issue</code> file.</p>
<ol>
<li value="5">Create the following default content for the <code>motd</code> and <code>issue</code> files under the <code>roles/security-baseline-rhel8/files/</code> directory:</li>
</ol>
<div><div><img alt="Figure 3.33 – The default motd and issue files " height="219" src="img/B18383_03_33.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.33 – The default motd and issue files</p>
<ol>
<li value="6">Verify the files of your Ansible role to ensure all the content is in place, as shown in the following screenshot:</li>
</ol>
<div><div><img alt="Figure 3.34 – The content of the security baseline role " height="695" src="img/B18383_03_34.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.34 – The content of the security baseline role</p>
<p>You can<a id="_idIndexMarker177"/> remove other unwanted directories that are not in use. However, in this case, keep everything as-is.</p>
<ol>
<li value="7">The variables can be kept in your playbook or even inside the inventory file, but it will not be easy to manage the content when you have more variables to maintain. Create a directory to keep the variables in, as follows:<pre>[ansible@ansible Chapter-03]$ mkdir vars</pre></li>
<li>Create a variable file called <code>vars/common.yml</code> to keep the common variables in and add <code>sudo_log</code> and other variables there (remember to add the variables and values as needed inside the file):</li>
</ol>
<div><div><img alt="Figure 3.35 – Creating a variable file " height="194" src="img/B18383_03_35.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.35 – Creating a variable file</p>
<ol>
<li value="9">Create another variable file called <code>vars/baseline_exclusions.yml</code> to keep the <code>baseline_exclusions</code> variable in:</li>
</ol>
<div><div><img alt="Figure 3.36 – Creating a variable file for baseline exclusions " height="405" src="img/B18383_03_36.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.36 – Creating a variable file for baseline exclusions</p>
<p>We can disable <a id="_idIndexMarker178"/>the security check by uncommenting the line (for example, <code>‘01.01’</code>) so that Ansible will check before executing the task.</p>
<ol>
<li value="10">As a best practice, you need to keep the default values for all variables that are used inside the Ansible role in a file. The <code>roles/security-baseline-rhel8/defaults/main.yml</code> file can be used for this purpose:</li>
</ol>
<div><div><img alt="Figure 3.37 – Default variables for the security-baseline-rhel8 role " height="219" src="img/B18383_03_37.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.37 – Default variables for the security-baseline-rhel8 role</p>
<ol>
<li value="11">Now, create the main playbook, <code>security-compliance-rhel8.yml</code>, and ensure it contains the following content:</li>
</ol>
<div><div><img alt="Figure 3.38 – The main playbook – security-compliance-rhel8.yml " height="484" src="img/B18383_03_38.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.38 – The main playbook – security-compliance-rhel8.yml</p>
<p>Note that <a id="_idIndexMarker179"/>in the preceding playbook, we are not hardcoding the hosts. Instead, we are using a variable called <code>NODES</code>. This variable will be passed to the playbook using the <code>hosts</code> to avoid the playbook being executed accidentally on the incorrect servers. (More about <code>extra-vars</code> will be covered in the next section.)</p>
<p>Also, note <code>vars_files</code> where we included the two variable files we created earlier. Here, the playbook is calling the <code>security-baseline-rhel8</code> role.</p>
<ol>
<li value="12">Execute the playbook and pass the <code>NODES</code> details as an extra variable:</li>
</ol>
<div><div><img alt="Figure 3.39 – Executing the security baseline playbook and ensuring the subtasks are executed " height="565" src="img/B18383_03_39.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.39 – Executing the security baseline playbook and ensuring the subtasks are executed</p>
<ol>
<li value="13">Log in to <code>node1</code> and <a id="_idIndexMarker180"/>verify the implemented items (note the login prompt):</li>
</ol>
<div><div><img alt="Figure 3.40 – Verifying the content of motd on the login screen for node1 " height="194" src="img/B18383_03_40.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.40 – Verifying the content of motd on the login screen for node1</p>
<p>Enhance your playbook by adding more validations and verifications to the tasks. Also, create reports while executing the job and send or save them for later auditing purposes.</p>
<p class="callout-heading">Ansible Integration with Third-Party Security Tools</p>
<p class="callout">It is possible to integrate Ansible with other third-party platforms and tools such as OpenSCAP or Red Hat Insight. In such cases, you need to develop playbooks to control scanning and remediation instead of manually scanning and fixing the configurations on the systems directly. Refer to <a href="https://www.ansible.com/use-cases/security-and-compliance">https://www.ansible.com/use-cases/security-and-compliance</a> and <a href="https://www.open-scap.org/">https://www.open-scap.org/</a> for more information.</p>
<h2 id="_idParaDest-61"><a id="_idTextAnchor061"/>Ansible --extra-vars</h2>
<p><code>extra-vars</code> contains<a id="_idIndexMarker181"/> the variables that will override all other variables. Using a dynamic extra variable will help you control the playbook based on the values and is also useful when you are using survey forms in Ansible AWX or Ansible Automation Controller, where variables can be defined in the GUI method (survey forms). <code>--extra-vars</code> can be passed as a single value, multiple key-value pairs, in JSON format, or read from a variable file, as follows:</p>
<div><div><img alt="Figure 3.41 – Ansible extra-vars examples " height="219" src="img/B18383_03_41.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.41 – Ansible extra-vars examples</p>
<p class="callout-heading">Ansible --extra-vars</p>
<p class="callout">Read more about runtime variables at <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#defining-variables-at-runtime">https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.xhtml#defining-variables-at-runtime</a>. Also check out the automation controller survey forms at <a href="https://docs.ansible.com/automation-controller/latest/html/userguide/job_templates.xhtml#surveys">https://docs.ansible.com/automation-controller/latest/html/userguide/job_templates.xhtml#surveys</a>.</p>
<p>In the next section, you will learn how to automate scheduled reboot jobs using Ansible.</p>
<h1 id="_idParaDest-62"><a id="_idTextAnchor062"/>Automated weekly system reboot using Ansible</h1>
<p>A scheduled and <a id="_idIndexMarker182"/>planned system reboot is a standard process in an IT environment to ensure the servers and applications are working well and the environment is stable with service restart operations. The <code>reboot</code> command might be simple when it executes but the reboot process and its formalities are not straightforward. </p>
<p>A generic server reboot activity involves multiple steps, as shown in the following diagram:</p>
<div><div><img alt="Figure 3.42 – Typical system reboot job workflow " height="1000" src="img/B18383_03_42.jpg" width="1031"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.42 – Typical system reboot job workflow</p>
<p>Imagine that <a id="_idIndexMarker183"/>you have hundreds of servers to reboot every week and your team is too small to handle such critical operations on weekends. It is possible to automate the entire workflow using Ansible by using backup operations before reboot and service verifications after reboot.</p>
<p>The Ansible <code>reboot</code> module was introduced in Ansible 2.7 (2018). At the time of writing, this module is part of <code>ansible-core</code> and included in all Ansible installations.</p>
<p>Create an <a id="_idIndexMarker184"/>Ansible playbook to reboot the machine as follows:</p>
<ol>
<li value="1">Create the <code>Chapter-03/system-reboot.yml</code> playbook with the following content:</li>
</ol>
<div><div><img alt="Figure 3.43 – Ansible playbook for the reboot job " height="642" src="img/B18383_03_43.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.43 – Ansible playbook for the reboot job</p>
<ol>
<li value="2">Execute the playbook:<pre>[ansible@ansible Chapter-03]$ ansible-playbook system-reboot.yml -e “NODES=nodes”</pre></li>
<li>Verify the reboot status on <code>node1</code>, as follows:</li>
</ol>
<div><div><img alt="Figure 3.44 – Verifying the reboot status on node1 " height="141" src="img/B18383_03_44.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.44 – Verifying the reboot status on node1</p>
<p>Enhance the playbook with the snapshot jobs (for example, a VMWare or OpenStack backup) or file backup (for example, <code>/etc/hosts</code>, <code>/etc/motd</code>, or <code>/etc/fstab</code>) before rebooting the system. Also, create additional tasks to verify the required services are running<a id="_idIndexMarker185"/> on the server, such as the <code>httpd</code> or <code>mysql</code> services. If you are using an automation controller or Ansible AWS, then schedule these automation tasks as weekly or daily jobs; the tasks will be executed based on the schedule without any user interaction (refer to <a href="B18383_12.xhtml#_idTextAnchor213"><em class="italic">Chapter 12</em></a>, <em class="italic">Integrating Ansible with Your Tools</em>, for more details).</p>
<p class="callout-heading">Ansible reboot Module</p>
<p class="callout">For more information about the Ansible <code>reboot</code> module, refer to <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/reboot_module.xhtml">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/reboot_module.xhtml</a>.</p>
<h1 id="_idParaDest-63"><a id="_idTextAnchor063"/>Automating notifications</h1>
<p>It is very<a id="_idIndexMarker186"/> important to notify the administrators and end users about the changes you are making in the environment. Whether it’s a simple package installation or a system reboot, the end user should be aware of the downtime and changes that are occurring. Instead of sending emails manually, the Ansible <code>mail</code> module can be used to automate email notifications. The Ansible <code>mail</code> module is powerful and can support most email features, including custom headers, attachments, and security.</p>
<h2 id="_idParaDest-64"><a id="_idTextAnchor064"/>Encrypting sensitive data using Ansible Vault</h2>
<p>If the <a id="_idIndexMarker187"/>email server (<strong class="bold">SMTP</strong>) is not <strong class="bold">open</strong> (configured to send email without authentication), then you need to authenticate the SMTP server with a username and password (app password or secret key). Keeping such sensitive information in plain text is not a best<a id="_idIndexMarker188"/> practice, so you need to store it in a safe method. To store such sensitive information, use key vault tools, in which the information will be saved in an encrypted format. Fortunately, there’s an built-in feature in Ansible for storing and managing encrypted content called <strong class="bold">Ansible Vault</strong>.</p>
<p>Ansible Vault will encrypt the files with the password (vault secret) you are providing and make the sensitive data unreadable to normal users. When Ansible wants to read the data, Ansible will ask for the vault password; you need to provide the password by keystrokes or via a secret file.</p>
<p>Create a vault file using the <code>ansible-vault create</code> command. Do not forget the vault <a id="_idIndexMarker189"/>password <a id="_idIndexMarker190"/>as you will not be able to decrypt the content otherwise:</p>
<div><div><img alt="Figure 3.45 – Creating a secret variable file using Ansible Vault " height="168" src="img/B18383_03_45.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.45 – Creating a secret variable file using Ansible Vault</p>
<p>Once you’ve done this, a text editor (for example, <code>vim</code>) will open so that you can enter the content of your sensitive file. Add your content and save the file:</p>
<pre>mysecretusername: username 
mysecretpassword: password</pre>
<p>If you try to read the file, you will see the encrypted content, as follows:</p>
<div><div><img alt="Figure 3.46 – The Ansible Vault file after being encrypted " height="328" src="img/B18383_03_46.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.46 – The Ansible Vault file after being encrypted</p>
<p>View the content of the file using the <code>ansible-vault view</code> command; Ansible will ask for the vault password, as follows:</p>
<div><div><img alt="Figure 3.47 – Viewing the content of the Ansible Vault file " height="194" src="img/B18383_03_47.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.47 – Viewing the content of the Ansible Vault file</p>
<p>You will be <a id="_idIndexMarker191"/>using this Ansible Vault in the upcoming<a id="_idIndexMarker192"/> exercise to keep the SMTP server username and password safe.</p>
<p>We will discuss Ansible Vault in more detail in <a href="B18383_13.xhtml#_idTextAnchor241"><em class="italic">Chapter 13</em></a>, <em class="italic">Using Ansible for Secret Management</em>.</p>
<p class="callout-heading">Encrypting Content with Ansible Vault</p>
<p class="callout">You have more options with Ansible Vault, such as edit, encrypt, decrypt, rekey, and more. Refer to <a href="B18383_13.xhtml#_idTextAnchor241"><em class="italic">Chapter 13</em></a>, <em class="italic">Using Ansible for Secret Management</em><em class="italic">,</em> for more details. Check out the documentation at <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.xhtml">https://docs.ansible.com/ansible/latest/user_guide/vault.xhtml</a> for more details about Ansible Vault.</p>
<p>In this exercise, you will enhance the previous <strong class="bold">weekly reboot</strong> playbook by adding email notifications before and after the system reboot:</p>
<ol>
<li value="1">Create a new role called <code>Chapter-03/roles/send-email</code>:</li>
</ol>
<div><div><img alt="Figure 3.48 – Creating an Ansible role for sending emails " height="168" src="img/B18383_03_48.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.48 – Creating an Ansible role for sending emails</p>
<ol>
<li value="2">Add a task inside <code>roles/send-email/tasks/main.yml</code>:</li>
</ol>
<div><div><img alt="Figure 3.49 – The task file for the send-email role " height="618" src="img/B18383_03_49.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.49 – The task file for the send-email role</p>
<p class="callout-heading">Note </p>
<p class="callout">The <code>delegate_to: localhost</code> line of the <code>mail</code> module needs to be executed on the localhost (the Ansible control node here) rather than the managed node.</p>
<p>Skip the <code>username</code> and <code>password</code> variables if your SMTP server has been configured <a id="_idIndexMarker193"/>as <a id="_idIndexMarker194"/>open and no authentication is required. In this case, you need to create a secret file to keep the username and password in. (The <code>cc</code> and <code>attach</code> options have been kept here as comments for demonstration purposes. It is possible to enhance the use case by adding those features.)</p>
<ol>
<li value="3">Create a new variable file called <code>vars/smtp_secrets.yml</code> using Ansible Vault (remember the vault password):</li>
</ol>
<div><div><img alt="Figure 3.50 – Creating a secret variable file using Ansible Vault " height="168" src="img/B18383_03_50.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.50 – Creating a secret variable file using Ansible Vault</p>
<ol>
<li value="4">Add<a id="_idIndexMarker195"/> the content of the secret file and save it:</li>
</ol>
<div><div><img alt="Figure 3.51 – Adding a variable to the vault file and saving it (:wq) " height="353" src="img/B18383_03_51.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.51 – Adding a variable to the vault file and saving it (:wq)</p>
<ol>
<li value="5">Create a new<a id="_idIndexMarker196"/> playbook called <code>Chapter-03/system-reboot-with-email.yml</code> with the following content (alternatively, copy the previous <code>system-reboot.yml</code> file and rename it):</li>
</ol>
<div><div><img alt="Figure 3.52 – Ansible playbook for rebooting with an email notification (1) " height="591" src="img/B18383_03_52.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.52 – Ansible playbook for rebooting with an email notification (1)</p>
<ol>
<li value="6">Add tasks<a id="_idIndexMarker197"/> for<a id="_idIndexMarker198"/> the reboot and email, as follows:</li>
</ol>
<div><div><img alt="Figure 3.53 – Ansible playbook for rebooting with an email notification (2) " height="907" src="img/B18383_03_53.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.53 – Ansible playbook for rebooting with an email notification (2)</p>
<p>Note <a id="_idIndexMarker199"/>that <a id="_idIndexMarker200"/>different values should be used for <code>email_report_body</code> and <code>email_smtp_subject</code> based on the job (pre-reboot or post-reboot).</p>
<p>With that, you have all required variables in the playbook for the <code>send-email</code> role except <code>email_smtp_username</code> and <code>email_smtp_password</code>. This is because they are sensitive and you cannot store them as plain text here; instead, you should include them in your secret variable file (<code>vars/smtp_secrets.yml</code>) that’s being encrypted by Ansible Vault.</p>
<ol>
<li value="7">Execute the playbook:</li>
</ol>
<div><div><img alt="Figure 3.54 – Executing the Ansible playbook without the vault password " height="141" src="img/B18383_03_54.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.54 – Executing the Ansible playbook without the vault password</p>
<p>Ansible is trying to<a id="_idIndexMarker201"/> decrypt the secret file, but no vault secret (vault password) has been provided. Execute the same playbook but <a id="_idIndexMarker202"/>add the <code>--ask-vault-password</code> switch at the end (Ansible will not ask or prompt for vault secrets by default):</p>
<div><div><img alt="Figure 3.55 – Executing the Ansible playbook with the vault password " height="458" src="img/B18383_03_55.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.55 – Executing the Ansible playbook with the vault password</p>
<ol>
<li value="8">Check your inbox (your <code>email_smtp_to_address</code>) for an automated email from Ansible:</li>
</ol>
<div><div><img alt="Figure 3.56 – Email notification " height="193" src="img/B18383_03_56.jpg" width="861"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.56 – Email notification</p>
<p>As an exercise, enhance the playbook by sending consolidated emails for all servers rather than sending an<a id="_idIndexMarker203"/> individual email or attaching a job summary<a id="_idIndexMarker204"/> report in the email.</p>
<p class="callout-heading">Send an Email Using Ansible</p>
<p class="callout">For more information about the Ansible mail module, refer to <a href="https://docs.ansible.com/ansible/latest/collections/community/general/mail_module.xhtml">https://docs.ansible.com/ansible/latest/collections/community/general/mail_module.xhtml</a>.</p>
<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Summary</h1>
<p>In this chapter, you learned how to create Ansible roles, Jinja2 templates, and Ansible Vault secrets. You also learned how to collect system information from Ansible facts and use the Jinja2 template to create reports and configurations. The use cases you have practiced were very generic, such as collecting system information, configuring standard system files, rebooting servers, and sending email notifications. As an exercise, enhance the use cases by adding more tasks and validation (such as validating the reboot activity before sending an email and so on).</p>
<p>In the next chapter, you will learn about the importance of <strong class="bold">version control systems</strong> (<strong class="bold">VCSs</strong>) in Ansible, the best practices to keep your Ansible artifacts safe, and how to enable collaboration and sharing to improve the quality of Ansible artifacts.</p>
<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li><em class="italic">How to pass extra variables to an Ansible playbook</em>: <a href="https://www.redhat.com/sysadmin/extra-variables-ansible-playbook">https://www.redhat.com/sysadmin/extra-variables-ansible-playbook</a></li>
<li><em class="italic">Ansible for Security and Compliance</em>: <a href="https://www.ansible.com/use-cases/security-and-compliance">https://www.ansible.com/use-cases/security-and-compliance</a></li>
</ul>
</div>
</div></body></html>