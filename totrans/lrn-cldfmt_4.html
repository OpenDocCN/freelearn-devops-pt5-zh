<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">AWS CloudFormation StackSets</h1>
                
            
            <article>
                
<p class="calibre2">Serving worldwide customers from various regions needs more attention in designing applications and infrastructure. Sometimes, deploying infrastructure to some regions is not easy. Moreover, we should perform infrastructure changes on various regions. This chapter will explore how to design and build infrastructure in various regions by applying CloudFormation StackSets.</p>
<p class="calibre2">The following topics will be covered in this chapter:</p>
<ul class="calibre11">
<li class="calibre12">Introduction to AWS CloudFormation StackSets</li>
<li class="calibre12">Preparing CloudFormation StackSets</li>
<li class="calibre12">Implementing StackSets using the management console</li>
<li class="calibre12">Creating StackSets using the AWS CLI</li>
<li class="calibre12">Editing CloudFormation StackSets</li>
<li class="calibre12">Deleting CloudFormation StackSets</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Introduction to AWS CloudFormation StackSets</h1>
                
            
            <article>
                
<p class="calibre2">A company with worldwide customers probably encounters problems when serving their customers. We should be able to provide services that are close to a customer's location. In an IT problem context, we should deploy our applications and services in various regions to address network latency. </p>
<p class="calibre2">We can describe our problem to serve worldwide customers as shown in <em class="calibre17">Figure 4.1</em>.  We have customers from the US, Asia, and Europe. We have applications and services that should be deployed in those regions. Sometimes, each region has unique features on applications and services. Problems will become more complex if we change our applications and services and deploy them on various servers:</p>
<div class="cdpaligncenter"><img src="../images/00070.jpeg" class="calibre23"/></div>
<div class="packt_figref">Figure 4.1: Infrastructure design with regional features</div>
<p class="calibre2">To address this issue, we can apply the AWS CloudFormation template to build a dynamic infrastructure. We could also deploy the <span class="calibre7">AWS CloudFormation template to various regions. Some CloudFormation templates can  be deployed in certain regions.</span></p>
<p class="calibre2">In this chapter, we'll explore how to use AWS CloudFormation StackSets to deploy CloudFormation stacks in certain regions.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Preparing CloudFormation StackSets</h1>
                
            
            <article>
                
<p class="calibre2">We should perform some tasks in order to work with CloudFormation StackSets. These tasks are part of the security rules from AWS CloudFormation. <span class="calibre7">To get started with CloudFormation StackSets, let's first perform the following tasks:</span></p>
<ol class="calibre14">
<li value="1" class="calibre12">Getting the user ID from the IAM user as the <span>AWS CloudFormation administrator</span></li>
<li value="2" class="calibre12">Creating an IAM role, <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd></li>
<li value="3" class="calibre12">Creating a service role, <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole</kbd></li>
</ol>
<p class="calibre2">We'll go through these tasks in the next sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Getting the user ID from the IAM user</h1>
                
            
            <article>
                
<p class="calibre2">First, you should have an administrator account on AWS IAM. Copy your ARN user from your IAM account on the AWS IAM Management Console at <a href="https://console.aws.amazon.com/iam/" target="_blank" class="calibre10">https://console.aws.amazon.com/iam/</a>. For instance, you could  have an ARN user account as follows:</p>
<pre class="calibre19">arn:aws:iam::123456789012:user/myusername</pre>
<p class="calibre2">Pick up your user ID from the account number of the ARN user. From the preceding ARN user, we have <kbd class="calibre13">123456789012</kbd> as the user ID. We will use this user ID to attach to a CloudFormation policy.</p>
<p class="calibre2">Next, we will create the IAM role, called <span class="calibre7"><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd>, on the IAM management console.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the AWSCloudFormationStackSetAdministrationRole IAM role</h1>
                
            
            <article>
                
<p class="calibre2">To build CloudFormation StackSets, we should create an IAM role, <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd>. This is required by AWS. If we don't, we will obtain an error when creating a CloudFormation StackSet.</p>
<p class="calibre2">We can create an IAM role, named <span class="calibre7"><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd>, using CloudFormation Stack. First, we create the CloudFormation template. In this case, we use the following YAML format:</span></p>
<pre class="calibre19">AWSTemplateFormatVersion: 2010-09-09<br class="title-page-name"/>Description: Configure the AWSCloudFormationStackSetAdministrationRole to enable use of AWS CloudFormation StackSets.<br class="title-page-name"/><br class="title-page-name"/>Resources:<br class="title-page-name"/>  AdministrationRole:<br class="title-page-name"/>    Type: AWS::IAM::Role<br class="title-page-name"/>    Properties:<br class="title-page-name"/>      RoleName: AWSCloudFormationStackSetAdministrationRole<br class="title-page-name"/>      AssumeRolePolicyDocument:<br class="title-page-name"/>        Version: 2012-10-17<br class="title-page-name"/>        Statement:<br class="title-page-name"/>          - Effect: Allow<br class="title-page-name"/>            Principal:<br class="title-page-name"/>              Service: cloudformation.amazonaws.com<br class="title-page-name"/>            Action:<br class="title-page-name"/>              - sts:AssumeRole<br class="title-page-name"/>      Path: /<br class="title-page-name"/>      Policies:<br class="title-page-name"/>        - PolicyName: AssumeRole-AWSCloudFormationStackSetExecutionRole<br class="title-page-name"/>          PolicyDocument:<br class="title-page-name"/>            Version: 2012-10-17<br class="title-page-name"/>            Statement:<br class="title-page-name"/>              - Effect: Allow<br class="title-page-name"/>                Action:<br class="title-page-name"/>                  - sts:AssumeRole<br class="title-page-name"/>                Resource:<br class="title-page-name"/>                  - "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole"</pre>
<p class="calibre2">You can save these scripts into a file called <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole.yaml</kbd>.</p>
<p class="calibre2">Now, you can navigate to the AWS CloudFormation dashboard at <a href="https://console.aws.amazon.com/cloudformation/" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/</a>  and create a new CloudFormation stack. Upload the<strong class="calibre5"> </strong><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole.yaml</kbd> <span class="calibre7">file. Give it a stack name, for instance </span><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd>, <span class="calibre7">as shown in the following screenshot:</span></p>
<div class="cdpaligncenter"><img class="aligncenter" src="../images/00071.jpeg"/></div>
<div class="packt_figref">Figure 4.2: Adding CloudFormation stack to create an IAM role, AWSCloudFormationStackSetAdministrationRole</div>
<p class="calibre2">When you're done, click on the <span class="calibre7">Next</span> button until you complete this task. Read <a target="_blank" href="part0032.html#UGI00-ff9c6455e1444393ad97060c22881bf4" class="calibre10">Chapter 2</a>, <em class="calibre17"><span class="calibre7"><span class="calibre7">Building Your First AWS CloudFormation Project</span></span></em> and <a target="_blank" href="part0048.html#1DOR00-ff9c6455e1444393ad97060c22881bf4" class="calibre10">Chapter 3</a>, <em class="calibre17">Developing AWS CloudFormation Templates</em> for details on how to work with CloudFormation stacks. After you've created a CloudFormation stack, you should see your CloudFormation stack on the CloudFormation stacks dashboard, as shown in the following screenshot:</p>
<p class="cdpaligncenter1"><img class="aligncenter1" src="../images/00072.jpeg"/></p>
<div class="packt_figref">Figure 4.3: Creation of the<span> </span><span>AWSCloudFormationStackSetAdministrationRole role was com</span><span>pleted</span></div>
<p class="calibre2">If you see the stack status as <span class="calibre7">CREATE_COMPLETE</span>, it means your CloudFormation stack has already been created. Now, you can verify it by opening the IAM AWS Management Console. Open a browser and navigate to <a href="https://console.aws.amazon.com/iam/" target="_blank" class="calibre10">https://console.aws.amazon.com/iam/</a>.</p>
<p class="calibre2">On the m<span class="calibre7">anagement console, click on th</span>e <span class="calibre7">Roles</span> in <span class="calibre7">the left menu. You should see <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd> on the role list:</span></p>
<p class="cdpaligncenter1"><img class="aligncenter2" src="../images/00073.jpeg"/></p>
<div class="packt_figref">Figure 4.4: Checking the <span>AWSCloudFormationStackSetAdministrationRole </span>IAM roles dashboard</div>
<p class="calibre2">You have created the <span class="calibre7"><kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd> role on AWS IAM. Next, we should create a service role named <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole</kbd>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a service role – AWSCloudFormationStackSetExecutionRole</h1>
                
            
            <article>
                
<p class="calibre2">Now that we've created the <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd> role on IAM Roles, we'll create a service role named <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole</kbd>.</p>
<p class="calibre2">We can create a service role using CloudFormation. You can write these scripts for the CloudFormation template:</p>
<pre class="calibre19">AWSTemplateFormatVersion: 2010-09-09<br class="title-page-name"/>Description: Configure the AWSCloudFormationStackSetExecutionRole to enable use of your account as a target account in AWS CloudFormation StackSets.<br class="title-page-name"/><br class="title-page-name"/>Parameters:<br class="title-page-name"/>  AdministratorAccountId:<br class="title-page-name"/>    Type: String<br class="title-page-name"/>    Description: AWS Account Id of the administrator account (the account in which StackSets will be created).<br class="title-page-name"/>    MaxLength: 12<br class="title-page-name"/>    MinLength: 12<br class="title-page-name"/><br class="title-page-name"/>Resources:<br class="title-page-name"/>  ExecutionRole:<br class="title-page-name"/>    Type: AWS::IAM::Role<br class="title-page-name"/>    Properties:<br class="title-page-name"/>      RoleName: AWSCloudFormationStackSetExecutionRole<br class="title-page-name"/>      AssumeRolePolicyDocument:<br class="title-page-name"/>        Version: 2012-10-17<br class="title-page-name"/>        Statement:<br class="title-page-name"/>          - Effect: Allow<br class="title-page-name"/>            Principal:<br class="title-page-name"/>              AWS:<br class="title-page-name"/>                - !Ref AdministratorAccountId<br class="title-page-name"/>            Action:<br class="title-page-name"/>              - sts:AssumeRole<br class="title-page-name"/>      Path: /<br class="title-page-name"/>      ManagedPolicyArns:<br class="title-page-name"/>        - arn:aws:iam::aws:policy/AdministratorAccess</pre>
<p class="calibre2">Save these scripts into a file called <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole.yaml</kbd>.</p>
<p class="calibre2">This service needs an administrator account to enable it to run a service on CloudFormation. We have prepared the IAM user and copied the ARN of the user. Now, you can open a browser and navigate to the CloudFormation dashboard. Upload the <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole.yaml</kbd> file to AWS CloudFormation stacks. Fill in your stack name and the ARN user from your IAM user, for instance, <kbd class="calibre13">123456789012</kbd>.</p>
<p class="calibre2">You can see the stack screen in the following screenshot:</p>
<p class="cdpaligncenter1"><img class="aligncenter3" src="../images/00074.jpeg"/></p>
<div class="packt_figref">Figure 4.5: Creating a service role, AWSCloudFormationStackSetExecutionRole</div>
<p class="calibre2">You can follow created stacks instructions. Once done, you can check your stack creation status. Make sure your stack completes:</p>
<p class="cdpaligncenter1"><img class="aligncenter4" src="../images/00075.jpeg"/></p>
<div class="packt_figref">Figure 4.6: <span>AWSCloudFormationStackSetExecutionRole service role was completed</span></div>
<p class="calibre2">We have created a service role, <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole</kbd>. Now, we are ready to create a StackSet. Next, we will create a StackSet using the management console and the AWS CLI.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Implementing StackSets using management console</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will create a StackSet using the <strong class="calibre5">Web Management Console</strong> (<strong class="calibre5">WMC</strong>). You should have created the IAM role, <kbd class="calibre13">AWSCloudFormationStackSetAdministrationRole</kbd>, and a service role, <kbd class="calibre13">AWSCloudFormationStackSetExecutionRole</kbd>.</p>
<p class="calibre2">Now, you can open a browser and navigate to the CloudFormation StackSet dashboard at <a href="https://console.aws.amazon.com/cloudformation/stacksets/home" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/stacksets/home</a>. You should see the dashboard shown in <em class="calibre17">Figure 4.7</em>:</p>
<p class="cdpaligncenter1"><img class="aligncenter5" src="../images/00076.jpeg"/></p>
<div class="packt_figref">Figure 4.7: CloudFormation StackSets dashboard</div>
<p class="calibre2">By default, the CloudFormation management console shows the <span class="calibre7">Stacks</span> dashboard. You can select the StackSets dashboard by clicking on the <span class="calibre7">StackSets</span> menu from the main menu, as shown in <em class="calibre17">Figure 4.8</em>:</p>
<div class="cdpaligncenter"><img class="aligncenter6" src="../images/00077.jpeg"/></div>
<div class="packt_figref"><span>Figure 4.8: Opening the CloudFormation StackSets dashboard from the main menu</span></div>
<p class="calibre2">In this section, we will perform the following tasks:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Creating a new StackSet</li>
<li value="2" class="calibre12">Adding a CloudFormation stack into a StackSet</li>
<li value="3" class="calibre12">Deleting a <span>CloudFormation stack from a StackSet</span></li>
</ol>
<p class="calibre2">We'll perform these tasks in the next sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a new StackSet</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we'll create a StackSet using the management console. A StackSet consists of stacks that are deployed in one or more regions.</p>
<p class="calibre2">Some steps should be followed to create a StackSet. Perform these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to the <span>CloudFormation StackSets dashboard at <a href="https://console.aws.amazon.com/cloudformation/stacksets/home" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/stacksets/home</a>. </span></li>
<li value="2" class="calibre12"><span>You should see the </span><span>CloudFormation StackSets dashboard, shown in <em class="calibre24">Figure 4.7</em>.</span></li>
<li value="3" class="calibre12"><span>To create a new StackSet, click on the </span><span>Create</span> <span>StackSet</span> <span>button.</span></li>
<li value="4" class="calibre12"><span>Once you've clicked it, you should see the screen shown in <em class="calibre24">Figure 4.9</em>:</span></li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter7" src="../images/00078.jpeg"/></div>
<div class="packt_figref">Figure 4.9: Creating StackSet by selecting template</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Choose the <span>Select a sample template from the following templates</span> option.</li>
<li value="6" class="calibre12">Click on the <span>Enable AWS Config</span> template. Once done, click on the <span>Next</span> button.</li>
<li value="7" class="calibre12">You should see the screen, shown in <em class="calibre24">Figure 4.10</em>:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter8" src="../images/00079.jpeg"/></div>
<div class="packt_figref">Figure 4.10: Filling StackSet name and attributes</div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">Fill in your StackSet name, for instance, <kbd class="calibre13">my-stackset</kbd>. Once done, click on the <span>Next</span> button.</li>
<li value="9" class="calibre12">You should see the screen shown in <em class="calibre24">Figure 4.11</em>. Select the <span>Deploy stacks in accounts</span> option.</li>
<li value="10" class="calibre12">Enter your ARN user in the textbox. You can fill in some accounts on this StackSet:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter9" src="../images/00080.jpeg"/></div>
<div class="packt_figref">Figure 4.11: Setting up accounts for StackSet</div>
<ol start="11" class="calibre14">
<li value="11" class="calibre12">Scroll down so you see the screen shown in <em class="calibre24">Figure 4.12</em>. Select one or a few regions for your accounts.</li>
<li value="12" class="calibre12">For our demo, I've selected the <span>US East (N.Virginia)</span> and <span>Asia Pacific (Singapore)</span> regions.</li>
<li value="13" class="calibre12">Once done, click on the <span>Next</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter10" src="../images/00081.jpeg"/></div>
<div class="packt_figref">Figure 4.12: Setting targeted regions</div>
<ol start="14" class="calibre14">
<li value="14" class="calibre12">You should get the screen shown in <em class="calibre24">Figure 4.13</em>. In this form, we'll do nothing. Click on the <span>Next</span> button to continue:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter11" src="../images/00082.jpeg"/></div>
<div class="packt_figref">Figure 4.13: Setting up options for StackSet</div>
<ol start="15" class="calibre14">
<li value="15" class="calibre12">You will get the review screen, shown in <em class="calibre24">Figure 4.14</em>. Review your input. Click on the <span>Create</span> button to start to create a StackSet:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter12" src="../images/00083.jpeg"/></div>
<div class="packt_figref">Figure 4.14: Confirmation for creating StackSet</div>
<ol start="16" class="calibre14">
<li value="16" class="calibre12">You should get the screen shown in <em class="calibre24">Figure 4.15</em>. You should see your <span>StackSet with Enable AWS Config</span> template:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter13" src="../images/00084.jpeg"/></div>
<div class="packt_figref">Figure 4-15. StackSet was created</div>
<ol start="17" class="calibre14">
<li value="17" class="calibre12">To see whether your StackSet was created successfully or not, scroll down to view the <span>Operations</span> and <span>Stacks</span> statuses. You should see the screen shown in <em class="calibre24">Figure 4.16</em>. You can see your operation and region stack status. If the StackSet operation status is <span>SUCCEEDED</span>, your StackSet was created successfully. You also should see all Stacks statuses are <span>CURRENT</span>, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter14" src="../images/00085.jpeg"/></div>
<div class="packt_figref">Figure 4.16: Checking the status on Operations and Stacks</div>
<p class="calibre2">Some status information for the <span class="calibre7">Operations</span> and <span class="calibre7">Stacks</span> sections can be found in <em class="calibre17">Table 4.1</em> and <em class="calibre17">Table 4.2</em>:</p>
<table border="1" class="calibre28">
<tbody class="calibre29">
<tr class="calibre30">
<td class="calibre38"><strong class="calibre1">StackSets operation status</strong></td>
<td class="calibre38"><strong class="calibre1">Operation</strong></td>
</tr>
<tr class="calibre30">
<td class="calibre39"><span>RUNNING</span></td>
<td class="calibre40">The operation is currently in progress</td>
</tr>
<tr class="calibre30">
<td class="calibre39"><span>SUCCEEDED</span></td>
<td class="calibre40">The operation finished without exceeding the failure tolerance for the operation</td>
</tr>
<tr class="calibre30">
<td class="calibre39"><span>FAILED</span></td>
<td class="calibre40">The number of stacks on which the operation could not be completed exceeded the user-defined failure tolerance</td>
</tr>
<tr class="calibre30">
<td class="calibre39"><span>STOPPING</span></td>
<td class="calibre40">The operation is in the process of stopping, at the user's request</td>
</tr>
<tr class="calibre30">
<td class="calibre39"><span>STOPPED</span></td>
<td class="calibre40">The operation has been stopped, at the user's request</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><span>Table 4.1: A list of status information for StackSets operations</span></div>
<table border="1" class="calibre28">
<tbody class="calibre29">
<tr class="calibre30">
<td class="calibre38"><strong class="calibre1">Stack instance status</strong></td>
<td class="calibre38"><strong class="calibre1">Operation</strong></td>
</tr>
<tr class="calibre30">
<td class="calibre41"><span>CURRENT</span></td>
<td class="calibre42">The stack is currently up-to-date with the stack set</td>
</tr>
<tr class="calibre30">
<td class="calibre41"><span>OUTDATED</span></td>
<td class="calibre42">The stack is not currently up-to-date</td>
</tr>
<tr class="calibre30">
<td class="calibre41"><span>INOPERABLE</span></td>
<td class="calibre42">A <span>DeleteStackInstances</span> operation has failed and left the stack in an unstable state</td>
</tr>
</tbody>
</table>
<div class="packt_figref"><span>Table 4.2: A list of status information for the Stack instance</span></div>
<p class="calibre2">Now that you have created StackSet on CloudFormation through management console. Next, we'll create one or more stacks on StackSet.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding a new CloudFormation Stack</h1>
                
            
            <article>
                
<p class="calibre2">You can add additional stacks on an existing StackSet. In this case, you can't use a new CloudFormation stack template. You should use an existing stack template from StackSet that has been already deployed. We can use cross accounts and regions.</p>
<p class="calibre2">In this demo, I'll add a new region for my existing StackSet. Perform the following tasks to add a CloudFormation stack into a StackSet:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open a browser and navigate to the CloudFormation StackSets dashboard at <a href="https://console.aws.amazon.com/cloudformation/stacksets/home" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/stacksets/home</a>.</li>
<li value="2" class="calibre12">You should see the screen shown in <em class="calibre24">Figure 4.17</em>:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter15" src="../images/00086.jpeg"/></div>
<div class="packt_figref">Figure 4.17: A list of CloudFormation StackSets </div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Select a StackSet that will be added to stacks. Click on the <span>Actions</span> button so you get the menu shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter16" src="../images/00087.jpeg"/></div>
<div class="packt_figref">Figure 4.18: Actions menu on StackSets dashboard</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Click on the <span>Manage stacks in StackSet</span> menu. You should get the screen shown in <em class="calibre24">Figure 4.19</em>. Select the <span>Create stacks</span> option:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter17" src="../images/00088.jpeg"/></div>
<div class="packt_figref">Figure  4.19: Select an option to add stacks</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">Once done, click on the <span>Nex</span><span>t</span> button. You should get the screen shown in <em class="calibre24">Figure 4.20</em>. Select the <span>Create stacks in accounts</span> option. Fill in your AWS IAM accounts. You also should specify the regions that will be used for targeted deployment:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter18" src="../images/00089.jpeg"/></div>
<div class="packt_figref">Figure 4.20: Set accounts and their regions</div>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">Once you've filled in the data, click on the <span>Next</span> button. You should get the screen shown in <em class="calibre24">Figure 4.21</em>. Set stack parameters. Once done, click on the <span>Next</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter19" src="../images/00090.jpeg"/></div>
<div class="packt_figref">Figure 4.21: Set StackSet parameters</div>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">You will get a confirmation screen, which is shown in <em class="calibre24">Figure 4.22</em>. Check your input data. Once done, click on the <span>Create</span> button to provision your stack:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter20" src="../images/00091.jpeg"/></div>
<div class="packt_figref">Figure 4.22: A confirmation for adding stacks</div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">Once clicked, CloudFormation will perform this task. You should see your stack on the StackSet properties:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter21" src="../images/00092.jpeg"/></div>
<div class="packt_figref">Figure 4.23: A new stack on an existing StackSet</div>
<p class="calibre2">This is the end of adding stacks. You can add more stacks as you need them. Next, you will learn how to delete stacks from StackSets.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deleting CloudFormation stacks</h1>
                
            
            <article>
                
<p class="calibre2">You can delete stacks from StackSets if you think they're not going to be used. In this section, we'll learn how to remove stacks from StackSets.</p>
<p class="calibre2">Follow these steps to delete stacks:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open a browser and navigate to CloudFormation StackSets (see <em class="calibre24">Figure 4.17</em>). Select and open your StackSet.</li>
<li value="2" class="calibre12">Click on the <span>Manage StackSet</span> button, and you will get the screen shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter22" src="../images/00093.jpeg"/></div>
<div class="packt_figref">Figure 4.24: Select a deletion option for existing Stacks</div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Select the <span>Delete stack</span><span>s</span> option. Click on the <span>Next</span> button. Once clicked, you should see the screen shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter23" src="../images/00094.jpeg"/></div>
<div class="packt_figref">Figure 4.25: Fill in accounts and the regions that will be deleted</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Fill in your accounts and their region details. Click on the <span>Next</span> button to continue.</li>
<li value="5" class="calibre12">You should see the confirmation screen shown in <em class="calibre24">Figure 4.26</em>. Click on the <span>Delete stacks</span> button to confirm deletion:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter24" src="../images/00095.jpeg"/></div>
<div class="packt_figref">Figure 4.26: Confirming deletion of stack accounts and regions</div>
<p class="calibre2">You can continue to delete other stacks. This is the end of deleting stacks. Next, you can perform StackSets operations using the AWS CLI.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating StackSets using the AWS CLI</h1>
                
            
            <article>
                
<p class="calibre2">In the previous section, we built StackSets using the CloudFormation management console. In this section, we'll use the AWS CLI to manage CloudFormation StackSets. A list of AWS CLI commands for CloudFormation can be found here at <a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/index.html#cli-aws-cloudformation" target="_blank" class="calibre10">https://docs.aws.amazon.com/cli/latest/reference/cloudformation/index.html#cli-aws-cloudformation</a>.</p>
<p class="calibre2">We'll use the AWS CLI to create a StackSet. Follow these steps:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Configure your working region. A list of AWS regions can be found at <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html" target="_blank" class="calibre10">https://docs.aws.amazon.com/general/latest/gr/rande.html</a>.</li>
<li value="2" class="calibre12">For instance, I changed my region to the <kbd class="calibre13">us-east-1</kbd> region. You can type the following commands at the Terminal:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ aws configure get region</strong><br class="title-page-name"/><strong class="calibre1">$ aws configure set region us-east-1</strong></pre>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">Once executed, you can verify using the <kbd class="calibre13">aws configure get region</kbd> command. You can see my program output in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter25" src="../images/00096.jpeg"/></div>
<div class="packt_figref">Figure 4.27: Configure the working region on the AWS CLI</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Create a StackSet using the <span>Enable AWS Config</span> template. This template is available at <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/EnableAWSConfig.yml" target="_blank" class="calibre10">https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/EnableAWSConfig.yml</a>.</li>
<li value="5" class="calibre12">Create a StackSet named <kbd class="calibre13">my-stackset</kbd>. You can use the <kbd class="calibre13">create-stack-set</kbd> command. Type this command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ aws cloudformation create-stack-set --stack-set-name my-stackset --template-url https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/EnableAWSConfig.yml --capabilities CAPABILITY_IAM</strong></pre>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">Once executed, you should obtain <span>StackSetId</span>, which can be used to retrieve your StackSet information. You can see my <span>StackSetId</span> <span>in the following screenshot when I created a StackSet:</span></li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter26" src="../images/00097.jpeg"/></div>
<div class="packt_figref">Figure 4.28: Creating a StackSet through the AWS CLI</div>
<ol start="7" class="calibre14">
<li value="7" class="calibre12">To get a creation status from your StackSet, use the <kbd class="calibre13">list-stack-sets</kbd> command.</li>
<li value="8" class="calibre12">If your StackSet has been created successfully, you should see your StackSet status as <span>ACTIV</span><span>E</span>:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter27" src="../images/00098.jpeg"/></div>
<div class="packt_figref">Figure 4.29: Getting a list of StackSets through the AWS CLI</div>
<ol start="9" class="calibre14">
<li value="9" class="calibre12">We can continue to create stack instances. We define accounts and their regions.</li>
<li value="10" class="calibre12">Use the <kbd class="calibre13">create-stack-instances</kbd> command when passing your StackSet name, accounts, and regions.</li>
<li value="11" class="calibre12">I created a stack instance on my StackSet name—<kbd class="calibre13">my-stackset</kbd>. I set one account, <kbd class="calibre13">123456789012</kbd>, with target regions <kbd class="calibre13">us-east-1</kbd> and <kbd class="calibre13">us-east-2</kbd>. You can type this command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ aws cloudformation create-stack-instances --stack-set-name my-stackset --accounts '["123456789012"]' --regions '["us-east-1","us-east-2"]' --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1</strong></pre>
<ol start="12" class="calibre14">
<li value="12" class="calibre12">Once executed, you should get the <span>OperationId</span> field. It will be used to check your execution. You can see my program output in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter28" src="../images/00099.jpeg"/></div>
<div class="packt_figref">Figure 4.30: Creating stacks instances</div>
<ol start="13" class="calibre14">
<li value="13" class="calibre12">To check and verify your operation status, use the <kbd class="calibre13">describe-stack-set-operation</kbd> command, passing the name of the StackSet and <kbd class="calibre13">operation-id</kbd>.</li>
<li value="14" class="calibre12">For instance, I want to check the StackSet named <kbd class="calibre13">my-stackset</kbd> with the <kbd class="calibre13">7c5d3b1e-844c-4e02-9cb2-ad42e3e4d53d</kbd> Operation ID. I type the following command:</li>
</ol>
<pre class="calibre26"><strong class="calibre1">$ aws cloudformation describe-stack-set-operation --stack-set-name my-stackset --operation-id 7c5d3b1e-844c-4e02-9cb2-ad42e3e4d53d</strong></pre>
<ol start="15" class="calibre14">
<li value="15" class="calibre12">You can see my program output sample in <em class="calibre24">Figure 4.31</em>. If you see your Operation ID status as <span>SUCCEEDED</span>, it means your stack instance was created:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter29" src="../images/00100.jpeg"/></div>
<div class="packt_figref">Figure 4.31: Checking operation status</div>
<p class="calibre2">This is the end of creating a CloudFormation StackSet using the AWS CLI. You can practice more with CloudFormation StackSet development.</p>
<p class="calibre2">Next, we will learn how to edit CloudFormation StackSets.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Editing CloudFormation StackSets</h1>
                
            
            <article>
                
<p class="calibre2">Sometimes, you want to edit your StackSet parameters. You can perform this task. In this section, we'll explore how to modify StackSets using the CloudFormation management console.</p>
<p class="calibre2">You can perform the following steps to edit a StackSet:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to the StackSets dashboard, as shown in <em class="calibre24">Figure 4.17</em>. Select the StackSet you want to edit.</li>
<li value="2" class="calibre12">Click on the <span>Actions</span> button and select the <span>Manage stacks in StackSet</span> menu (see <em class="calibre24">Figure 4.18</em>).</li>
<li value="3" class="calibre12">You should get the screen shown in <em class="calibre24">Figure 4.32</em>:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter30" src="../images/00101.jpeg"/></div>
<div class="packt_figref">Figure 4.32: Opting to edit a StackSet</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">Select the <span>Edit StackSet</span> option. Once done, click on the <span>Next</span> button.</li>
<li value="5" class="calibre12">You should see the screen shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter31" src="../images/00102.jpeg"/></div>
<div class="packt_figref">Figure 4.33: Selecting a StackSet template to be edited</div>
<ol start="6" class="calibre14">
<li value="6" class="calibre12">In this case, we'll modify the current template, so select the <span>Current template: Update my-stackset</span> option. Once done, click on the <span>Next</span> button.</li>
<li value="7" class="calibre12">You should get a screen showing your template. For instance, the <span>Enable AWS Config</span> template is shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter32" src="../images/00103.jpeg"/></div>
<div class="packt_figref">Figure 4.34: Configure StackSet parameters</div>
<ol start="8" class="calibre14">
<li value="8" class="calibre12">Click on the <span>Next</span> button. Follow the next step to confirm and execute your StackSet changes. Once done, your StackSet is modified.</li>
</ol>
<p class="calibre2">You have learned how to modify your StackSet template. Next, we'll learn how to delete StackSets.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deleting CloudFormation StackSets</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will learn how to delete StackSets. To delete a StackSet, you should delete all stacks from the StackSet first. If you don't, you will get errors when deleting StackSets.</p>
<p class="calibre2">You can perform the following steps to delete a StackSet:</p>
<ol class="calibre14">
<li value="1" class="calibre12">Open your browser and navigate to the CloudFormation StackSets dashboard at <a href="https://console.aws.amazon.com/cloudformation/stacksets/home" target="_blank" class="calibre10">https://console.aws.amazon.com/cloudformation/stacksets/home</a>. Select the StackSet you want to delete.</li>
<li value="2" class="calibre12">Click on the <span>Actions</span> button, and you should get the menu shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter33" src="../images/00104.jpeg"/></div>
<div class="packt_figref">Figure 4.35: A menu for deleting StackSet</div>
<ol start="3" class="calibre14">
<li value="3" class="calibre12">You should get the confirmation dialog shown in <em class="calibre24">Figure 4.36</em>. Click on the <span>Yes, Delete</span> button:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter34" src="../images/00105.jpeg"/></div>
<div class="packt_figref">Figure 4.36: Confirmation for deleting a StackSet</div>
<ol start="4" class="calibre14">
<li value="4" class="calibre12">If you have stacks within the StackSet, you should delete these stacks before deleting the StackSet. If you don't, you'll get errors, as shown in the following screenshot:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter35" src="../images/00106.jpeg"/></div>
<div class="packt_figref">Figure 4.37: Getting errors on deleting a StackSet</div>
<ol start="5" class="calibre14">
<li value="5" class="calibre12">You can set accounts and target regions to be removed. You can see the account and regions that are being deleted in <em class="calibre24">Figure 4.38</em>. Once done, you can back to perform actions on step 2:</li>
</ol>
<div class="cdpaligncenter"><img class="aligncenter36" src="../images/00107.jpeg"/></div>
<div class="packt_figref">Figure 4.38: Removing all stacks from a StackSet</div>
<p class="calibre2">You have deleted a StackSet from CloudFormation. I recommend you delete StackSets that you no longer use. I also recommend you learn best practices related to CloudFormation StackSets, which you can find at <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-bestpractices.html" target="_blank" class="calibre10">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-bestpractices.html</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">You learned how to create CloudFormation StackSets using the WMC and the AWS CLI. You also learned how to add stacks into a StackSet by attaching accounts and target regions. Then, you learned how to manage stacks from a StackSet, for instance, by editing and deleting them. Finally, you learned how to modify and delete the current StackSet.</p>
<p class="calibre2">In the next chapter, we'll learn how to build AWS Lambda functions using AWS CloudFormation.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<p class="calibre2">Answer the following questions to evaluate your learning:</p>
<ol class="calibre14">
<li value="1" class="calibre12">What is a CloudFormation StackSet?</li>
<li value="2" class="calibre12">What is the maximum number of stacks in a StackSet?</li>
</ol>


            </article>

            
        </section>
    </body></html>