<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Iterative Control Structures – Loops</h1></div></div></div><p>You learned about conditional controls in the previous chapter. Our journey into Ansible's world of control structures continues with iterative controls. Often, we need to create a list of directories, install a bunch of packages, or define and walk over nested hashes or dictionaries. Traditional programming languages use the <code class="literal">for</code> or <code class="literal">while</code> loops for iteration. Ansible replaces them with the <code class="literal">with</code> statements.</p><p>In this chapter, we are going to learn about:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to use iterative controls using the <code class="literal">with</code> statements</li><li class="listitem" style="list-style-type: disc">How to loop arrays to create multiple objects at once</li><li class="listitem" style="list-style-type: disc">How to define nested hashes and walk over them to create data-driven roles</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec47"/>The omnipotent with statement</h1></div></div></div><p>Iterating plain <a id="id184" class="indexterm"/>lists, parsing dictionaries, looping a sequence of numbers, parsing through a path and selectively copying files, or just picking up a random item from a list could be achieved using the "Swiss knife" utility, <code class="literal">with</code> statement. The <code class="literal">with</code> statements take the following form:</p><div><pre class="programlisting">with_xxx</pre></div><p>Here, the <code class="literal">xxx</code> parameter is the type of data that needs to be looped, for example, items, dictionaries, and so on.</p><p>The following table lists the types of data that the <code class="literal">with</code> statement can iterate:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Construct</p>
</th><th style="text-align: left" valign="bottom">
<p>Data type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_items</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Array</p>
</td><td style="text-align: left" valign="top">
<p>This is used to loop array items. For example, this is used to create a group of users, directories, or to install a list of packages.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_nested</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Nested loops</p>
</td><td style="text-align: left" valign="top">
<p>This is used to parse multidimensional arrays. For example, to create a list of MySQL users and grant them access to a group of databases.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_dict</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Hashes</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id185" class="indexterm"/>is used to parse a dictionary of key-value pairs and create virtual hosts.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_fileglobs</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Files with pattern match</p>
</td><td style="text-align: left" valign="top">
<p>This is used to parse a path and copy only those files that match a certain pattern.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_together</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sets</p>
</td><td style="text-align: left" valign="top">
<p>This is used to join two arrays as a set and to loop over it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_subelements</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Hash subelement</p>
</td><td style="text-align: left" valign="top">
<p>This is used to parse a subelement of a hash. For example, to walk over the list of SSH keys and distribute them to a user.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_sequence</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Integer sequence</p>
</td><td style="text-align: left" valign="top">
<p>This is used to loop a sequence of numbers.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_random_choice</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Random choice</p>
</td><td style="text-align: left" valign="top">
<p>This is used to pick up items from the array in a random order.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">with_indexed_items</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Array with index</p>
</td><td style="text-align: left" valign="top">
<p>This is an array with an index and is useful when an index for items is required.</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Configuring WordPress requisites</h1></div></div></div><p>While creating <a id="id186" class="indexterm"/>a role to install WordPress in <a class="link" href="ch04.html" title="Chapter 4. Bringing In Your Code – Custom Commands and Scripts">Chapter 4</a>, <em>Bringing In Your Code – Custom Commands and Scripts</em>, we created tasks to download, extract, and copy the WordPress application. However, that's not enough to launch WordPress, which has the following prerequisites:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A web server</li><li class="listitem" style="list-style-type: disc">PHP bindings for a web server</li><li class="listitem" style="list-style-type: disc">The MySQL database and MySQL users</li></ul></div><p>An Nginx web server and MySQL service have already been installed in our case. We still need to install and configure PHP along with the MySQL database and a user required for our WordPress application. To handle PHP requests, we choose to implement the PHP5-FPM handler, which is an alternative to the traditional FastCGI implementation.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec49"/>The PHP5-FPM role</h1></div></div></div><p>In <strong>PHP5-FPM</strong>, <strong>FPM</strong> stands for <strong>FastCGI Process Manager</strong>. PHP5-FPM comes with advanced features over <strong>fastcgi</strong>, which are useful for managing high-traffic sites. It is suitable for serving our <a id="id187" class="indexterm"/>fifanews site, which is expected to get a few million hits a day. Following our design tenet of creating a modular code, we would keep PHP functionality <a id="id188" class="indexterm"/>in its own role. Let's initialize the PHP5-FPM role using the Ansible-Galaxy command, as follows:</p><div><pre class="programlisting">
<strong>$ ansible-galaxy init --init-path roles/ php5-fpm</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec40"/>Defining an array</h2></div></div></div><p>PHP installation <a id="id189" class="indexterm"/>will involve the installation of multiple packages, including <code class="literal">php5-fpm</code>, <code class="literal">php5-mysql</code>, and a few others. So far, we have been writing tasks one at a <a id="id190" class="indexterm"/>time. For example, let's take a look at the following code snippet:</p><div><pre class="programlisting">  - name: install php5-fpm
    apt: name: "php5-fpm" 
  - name: install php5-mysql
    apt: name: "php5-mysql"</pre></div><p>However, this could become repetitive when we want to install multiple packages, also causing redundant code. Being committed to writing data-driven roles, we would drive the installation of packages through a variable, which takes a list of packages and then iterates the list. Let's <a id="id191" class="indexterm"/>begin defining the parameters required <a id="id192" class="indexterm"/>to list the packages, as follows:</p><div><pre class="programlisting">---
#filename: roles/php5-fpm/defaults/main.yml
#defaults file for php5-fpm
php5:
  packages:
    - php5-fpm
    - php5-common
    - php5-curl
    - php5-mysql
    - php5-cli
    - php5-gd
    - php5-mcrypt
    - php5-suhosin
    - php5-memcache
  service:
    name: php5-fpm</pre></div><p>Here is the analysis of the preceding code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">php5</code> variable is a variable dictionary, which would contain all the parameters that we pass to the <code class="literal">php5-fpm</code> role.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">php5.packages</code> parameter is an array of packages, one defined on each line in the code. This will be passed to a task that will iterate each item and install it.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">php5.service</code> parameter defines the name of the service, which would be referred to from the service task.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec41"/>Looping an array</h2></div></div></div><p>Let's now create <a id="id193" class="indexterm"/>tasks for the <code class="literal">php5-fpm</code> role. We need to install packages <a id="id194" class="indexterm"/>from the array and then start the service. We will split the package's functionalities in to two separate task files and call it from the <code class="literal">main.yml</code> file, as follows:</p><div><pre class="programlisting">---
#filename: roles/php5-fpm/tasks/main.yml
# tasks file for php5-fpm
- include_vars: "{{ ansible_os_family }}.yml"
  when: ansible_os_family != 'Debian'

- include: install.yml
- include: service.yml

#filename: roles/php5-fpm/tasks/install.yml
  - name: install php5-fpm and family
    apt:
      name: "{{ item }}"
    with_items: php5.packages
    notify:
     - restart php5-fpm service

#filename: roles/php5-fpm/tasks/service.yml
# manage php5-fpm service
- name: start php5-fpm service
  service:
    name: "{{ php5['service']['name'] }}"
    state: started</pre></div><p>Along with tasks, the <a id="id195" class="indexterm"/>handler to restart the <code class="literal">php5-fpm</code> role can be <a id="id196" class="indexterm"/>written, as follows:</p><div><pre class="programlisting">---
# filename: roles/php5-fpm/handlers/main.yml
# handlers file for php5-fpm
- name: restart php5-fpm service
  service: name="{{ php5['service']['name'] }}" state=restarted</pre></div><p>Let's analyze the preceding code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Main</strong>: The <code class="literal">main.yml</code> file includes variables based on the <code class="literal">ansible_os_family</code> fact for non-Debian systems. This is useful for overriding variables that are platform-specific. After including the <code class="literal">vars</code> file, the main task goes on to include the <code class="literal">install.yml</code> and <code class="literal">service.yml</code> files.</li><li class="listitem" style="list-style-type: disc"><strong>Install</strong>: The <code class="literal">install.yml</code> file is where we iterate an array of packages that were defined earlier. Since the file contains an array, we use the <code class="literal">with.items</code> construct with the <code class="literal">php5.packages</code> variable and pass the <code class="literal">{{ item }}</code> parameter as the name of the package to be installed. We could have alternatively passed the array directly, as follows:<div><pre class="programlisting">  with_items:
    - php5-fpm
    - php5-mysql</pre></div></li><li class="listitem" style="list-style-type: disc"><strong>Service and handler</strong>: The <code class="literal">service.yml</code> file and the handler <code class="literal">main.yml</code> file manage the start and <a id="id197" class="indexterm"/>restart of the <code class="literal">php5-fom</code> service. It <a id="id198" class="indexterm"/>takes a dictionary variable <code class="literal">php5['service']['name']</code> to determine the service name.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec50"/>Creating MySQL databases and user accounts</h1></div></div></div><p>WordPress is a <a id="id199" class="indexterm"/>content management system that requires a MySQL DB to <a id="id200" class="indexterm"/>be available to store data, such as posts, users, and so on. Additionally, it also requires a MySQL user with appropriate privileges to connect to the database from a WordPress application. We get one admin user while installing MySQL, however, it's a good practice to create an additional user account and grant privileges to the user as and when required.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec42"/>Creating a hash</h2></div></div></div><p>A <strong>hash</strong>, an abbreviation of <a id="id201" class="indexterm"/>hash table, is a dictionary of key-value pairs. It's a useful data structure to create a multilevel variable, which can then be programmatically to create multiple objects, each having their own values. We will define the databases and users as dictionary items in the <code class="literal">group_vars</code>/<code class="literal">all</code> file, as follows:</p><div><pre class="programlisting">#filename: group_vars/all
mysql_bind:  "{{ ansible_eth0.ipv4.address }}"
mysql:
  databases:
    fifalive:
      state: present
    fifanews:
      state: present
  users:
    fifa:
      pass: supersecure1234
      host: '%'
      priv: '*.*:ALL'
      state: present</pre></div><p>Here is the analysis of the preceding code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We defined this <a id="id202" class="indexterm"/>variable hash in the <code class="literal">group_vars</code>/<code class="literal">all</code> file instead of in the role. This is because we would like to keep roles generic and shareable, without adding data specific to our respective environments.</li><li class="listitem" style="list-style-type: disc">We defined the databases and user configurations as multilevel dictionaries, or hashes.</li></ul></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Nested hashes</h3></div></div></div><p>This multilevel hash is <a id="id203" class="indexterm"/>explained through the following diagram:</p><div><img src="img/B03800_06_01.jpg" alt="Nested hashes"/></div><p>The following is the description of how this nested hash is structured:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A MySQL variable is a hash with two keys: databases and users. For example:<div><pre class="programlisting">mysql:
    databases: value
     users: value</pre></div></li><li class="listitem" style="list-style-type: disc">The values for each of these two keys are in turn hashes, or dictionaries of information, about the <a id="id204" class="indexterm"/>databases and users that are to be created. For example:<div><pre class="programlisting">databases:
    fifalive: value
    fifanews: value</pre></div></li><li class="listitem" style="list-style-type: disc">Each database in turn is a dictionary of keys and values. For example, for the MySQL user <code class="literal">fifalive</code>, the key-value pairs are "state:present".</li></ul></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec43"/>Iterating a hash</h2></div></div></div><p>Creating databases and <a id="id205" class="indexterm"/>user accounts would typically require the creation of custom scripts with templates, which would then be called using command modules. Ansible instead comes with batteries, and staying true to this statement, it provides us with ready-made modules to perform MySQL-related tasks, that is, the <code class="literal">mysql_db</code> and <code class="literal">mysql_user</code> parameters. Using the <code class="literal">with_dict</code> statement, we will walk through the dictionaries of databases and users that we defined earlier, as follows:</p><div><pre class="programlisting"># filename: roles/mysql/tasks/configure.yml
 - name: create mysql databases
    mysql_db:
      name: "{{ item.key }}"
      state: "{{ item.value.state }}"
    with_dict: "{{ mysql['databases'] }}"

 - name: create mysql users
    mysql_user:
      name: "{{ item.key }}"
      host: "{{ item.value.host }}"
      password: "{{ item.value.pass }}"
      priv: "{{ item.value.priv }}"
      state: "{{ item.value.state }}"
    with_dict: "{{ mysql['users'] }}"</pre></div><p>Here is the analysis of the preceding code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">mysql['databases']</code> and <code class="literal">mysql['users']</code> parameters are dictionaries that are passed to a task using the <code class="literal">with_dict</code> statements</li><li class="listitem" style="list-style-type: disc">Each dictionary, or hash, has a key-value pair that is passed as the <code class="literal">{{ item.key }}</code> and <code class="literal">{{ item.value }}</code> parameters</li><li class="listitem" style="list-style-type: disc">The <code class="literal">{{ item.value }}</code> parameter is a dictionary. Each key in this dictionary is then referred to as <code class="literal">{{ item.value.&lt;key&gt; }}</code>. For example, the <code class="literal">{{ item.value.state }}</code> parameter</li></ul></div><p>The following diagram <a id="id206" class="indexterm"/>explains how this nested hash is parsed:</p><div><img src="img/B03800_06_02.jpg" alt="Iterating a hash"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec51"/>Creating Nginx virtual hosts</h1></div></div></div><p>After installing the <code class="literal">php5-fpm</code> manager and creating the MySQL databases and user accounts, the last <a id="id207" class="indexterm"/>bit of configuration that is left is to create a virtual host with Nginx to serve our WordPress application. The Nginx web server that we installed earlier serves a simple HTML page and is not aware of the existence of the WordPress application or how to serve it. Let's start by adding these configurations.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec44"/>Defining the PHP site information</h2></div></div></div><p>In addition to the <code class="literal">fifanews.com</code> site that we are setting up, we may also launch a few more sites related to <a id="id208" class="indexterm"/>soccer in future. Hence, we need to have the ability to programmatically add multiple sites with the same Nginx server. Creating a dictionary to define site information and embedding it into a template sounds like a good choice for this. Since site information is specific to us, we will add the variable hash to the <code class="literal">group_vars</code> file, as follows:</p><div><pre class="programlisting">#filename: group_vars/all
nginx:
  phpsites:
    fifanews:
      name: fifanews.com
      port: 8080
      doc_root: /var/www/fifanews</pre></div><p>We learned how to parse this dictionary from the Ansible task. Let's add a task that will allow us to walk through this <a id="id209" class="indexterm"/>dictionary, pass the values to templates, and create virtual host configurations:</p><div><pre class="programlisting">#filename: roles/nginx/tasks/configure.yml
- name: create php virtual hosts
    template:
      src: php_vhost.j2
      dest: /etc/nginx/conf.d/{{ item.key }}.conf
    with_dict: "{{ nginx['phpsites'] }}"
    notify:
      - restart nginx service</pre></div><p>Each item in this dictionary is passed to the template, in this case, to the <code class="literal">php_vhost.j2</code> parameter. This in turn reads the hash and creates a virtual host template, which configures a PHP application, as follows:</p><div><pre class="programlisting">#filename: roles/nginx/templates/php_vhost.j2
#{{ ansible_managed }}

server {
    listen {{ item.value.port }};

  location / {
    root {{ item.value.doc_root }};
    index index.php;
  }

  location ~ .php$ {
    fastcgi_split_path_info ^(.+\.php)(.*)$;
    fastcgi_pass   backend;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  {{ item.value.doc_root }}$fastcgi_script_name;
    include fastcgi_params;
  }
}
upstream backend {
  server 127.0.0.1:9000;
}</pre></div><p>Here is the <a id="id210" class="indexterm"/>analysis of the preceding code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">{{ ansible_managed }}</code> parameter is a special variable that adds a comment notifying the server that this file is being managed by Ansible, with the path to this file in the Ansible repository, last modification time, and the user who modified it.</li><li class="listitem" style="list-style-type: disc">The template gets a dictionary item and parses its values since it's a nested hash. This template has configuration for creating a php virtual hosts for Nginx using dictionary values set with <code class="literal">nginx.phpsites</code>.</li><li class="listitem" style="list-style-type: disc">Configuration parameters provided with the dictionary include doc root, port, backend to use  which make Nginx aware of how to handle incoming PHP requests, which backend to use, which port to listen on, and so on.</li></ul></div><p>Finally, we add the new role to the <code class="literal">www.yaml</code> file, as follows:</p><div><pre class="programlisting"># www.yml
roles:
     - { role: nginx, when: ansible_os_family == 'Debian' }
     - php5-fpm
     - wordpress</pre></div><p>Run the playbook using the following command:</p><div><pre class="programlisting">
<strong>$ ansible-playbook -i customhosts site.yml</strong>
</pre></div><p>After the run is complete, it's time to test our work. Let's load the following URL in the browser:</p><p>
<code class="literal">http://&lt;web_server_ip&gt;:8080</code>
</p><p>Congratulations!! We've successfully created a WordPress PHP application with the Nginx web server and MySQL backend, fully configured. Now, we are ready to set up our fifanews site:</p><div><img src="img/B03800_06_03.jpg" alt="Defining the PHP site information"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec52"/>Review questions</h1></div></div></div><p>Do you think you've understood this chapter well enough? Try answering the following questions to test your understanding:</p><div><ol class="orderedlist arabic"><li class="listitem">Which statement in Ansible replaces the <code class="literal">for</code> loop?</li><li class="listitem">How is the <code class="literal">with_____</code> statement used to iterate dictionaries?</li><li class="listitem">How would you add a statement to a template that prints when, and by whom, it was modified?</li><li class="listitem">How would you print the values of a nested hash?</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec53"/>Summary</h1></div></div></div><p>In this chapter, you learned how to create multiple objects iteratively. We started with an overview of the omnipotent <code class="literal">with</code> statement and its various forms. Then, we dove deeper into iterating the two most essential data structures, which are, arrays and hashes. The <code class="literal">php5-fpm</code> role takes an array with a list of packages and creates a task to install those in a loop. To create MySQL databases and users, we defined variable dictionaries or hashes and iterated them. Finally, we added Nginx template configurations to create multiple virtual hosts serving PHP applications by iterating a nested dictionary.</p><p>In the next chapter, you will learn how to discover information about other nodes using magic variables.</p></div></body></html>