<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Building Your Application"><div class="titlepage" id="aid-1FLS42"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Building Your Application</h1></div></div></div><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"Measuring programming progress by lines of code is like measuring aircraft building progress by weight."</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td colspan="2" align="right" valign="top" style="text-align: center">--<span class="attribution"><span class="emphasis"><em>Bill Gates</em></span></span></td></tr></table></div><p>TFS has introduced a new build system in TFS 2015 called TFBuild. In this chapter, you'll learn the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Configuring TFBuild Agent, Pool, and Queues</li><li class="listitem">Setting up a TFBuild Agent using an unattended installation</li><li class="listitem">Creating a continuous integration build definition in TFBuild</li><li class="listitem">Pinning a build badge to the welcome page in Team Portal</li><li class="listitem">Managing build resources using role-based access</li><li class="listitem">Using the build retention policy to automate build deletion</li><li class="listitem">Using user capabilities to identify a build agent in a pool</li><li class="listitem">Version DLLs in build output with build number</li><li class="listitem">Creating a new build task using the TFBuild Extensibility framework</li><li class="listitem">Integrating SonarQube with TFBuild to manage technical debt</li><li class="listitem">Building GitHub code repositories with TFBuild</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Introduction</h1></div></div></div><p>As a developer, compiling code and running unit tests gives you an assurance that your code changes haven't had an impact on the existing codebase. Integrating your code changes into the source control repository enables other users to validate their changes with yours. As a best practice, Teams integrate changes into the shared repository several times a day to reduce the risk of introducing breaking changes or worse, overwriting each other's.</p><div class="note" title="Note"><h3 class="title"><a id="tip09"/>Tip</h3><p><span class="strong"><strong>Continuous integration</strong></span> (<span class="strong"><strong>CI</strong></span>)<a id="id418" class="indexterm"/> is a development practice that requires developers to integrate code into a shared repository several times a day. Each check-in is verified by an automated build, allowing Teams to detect problems early.</p></div><p>The automated build that runs as part of the CI process is often referred to as the CI build. There isn't a clear definition of what the CI build should do, but at the very minimum, it is expected to compile code and run unit tests. Running the CI build on a non-developer remote workspace helps identify the dependencies that may otherwise go unnoticed into the release process. We can talk endlessly about the benefits of CI; the key here is that it enables you to have potentially deployable software at all times.</p><div class="note" title="Note"><h3 class="title"><a id="tip10"/>Tip</h3><p>Deployable software is the most tangible asset to customers.</p></div><p>Moving from concept to application, in this chapter, you'll learn how to leverage the build tooling in TFS to set up a quality-focused CI process. But first, let's have a little introduction to the build system in TFS. The following image illustrates the three generations of build systems in TFS:</p><div class="mediaobject"><img src="../Images/image00544.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>TFS has gone through three generations of build systems. The very first was MSBuild using XML for configuration; the next one was XAML using Windows Workflow Foundation for configuration, and now, there's TFBuild using JSON for configuration. The XAML-based build system will continue to be supported in TFS 2015. No automated migration path is available from XAML build to TFBuild. This is generally because of the difference in the architecture between the two build systems.</p><p>The new build system in TFS is <a id="id419" class="indexterm"/>called <span class="strong"><strong>Team Foundation Build</strong></span> (<span class="strong"><strong>TFBuild</strong></span>). It is an extensible task-based execution system with a rich web interface that allows authoring, queuing, and monitoring builds. TFBuild is fully cross platform with the underlying build agents that are capable of running natively on both Windows and non-Windows platforms. TFBuild provides out-of-the-box integration with Centralized Version Control such as TFVC and Distributed Version Controls such as Git and GitHub. TFBuild supports building .NET, Java, Android, and iOS applications. All the recipes in this chapter are based on TFBuild.</p><p>TFBuild is <a id="id420" class="indexterm"/>a task orchestrator that allows you to run any build engine, such as Ant, CMake, Gradle, Gulp, Grunt, Maven, MSBuild, Visual Studio, Xamarin, XCode, and so on. TFBuild supports Work Item integration, publishing drops, and publishing test execution results into the TFS that is independent of the build engine that you choose. The build agents are xCopyable and do not require any installation. The agents are auto-updating in nature; there's no need to update every agent in your infrastructure:</p><div class="mediaobject"><img src="../Images/image00545.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>TFBuild offers a rich web-based interface. It does not require Visual Studio to author or modify a build definition. From simple to complex, all build definitions can easily be created in the web portal. The web interface is accessible from any device and any platform:</p><div class="mediaobject"><img src="../Images/image00546.jpeg" alt="Introduction"/><div class="caption"><p>The build definition can be authored from the web portal directly</p></div></div><p style="clear:both; height: 1em;"> </p><p>A build definition<a id="id421" class="indexterm"/> is a collection of tasks. A task is simply a build step. Build definition can be composed by dragging and dropping tasks. Each task supports <span class="strong"><strong>Enabled</strong></span>, <span class="strong"><strong>Continue on error</strong></span>, and <span class="strong"><strong>Always run</strong></span> flags making it easier to manage build definitions as the task list grows:</p><div class="mediaobject"><img src="../Images/image00547.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>The build system<a id="id422" class="indexterm"/> supports invoking PowerShell, batch, command line, and shell scripts. All out-of-the-box tasks are open source. If a task does not satisfy your requirements, you can download the task<a id="id423" class="indexterm"/> from GitHub at <a class="ulink" href="https://github.com/Microsoft/vso-agent-tasks">https://github.com/Microsoft/vso-agent-tasks</a> and customize it. If you can't find a task, you can easily create one. You'll learn more about custom tasks in this chapter.</p><p>Changes to build definitions can be saved as drafts. Build definitions maintain a history of all changes in the <span class="strong"><strong>History</strong></span> tab. A side-by-side comparison of the changes is also possible. Comments entered when changing the build definition show up in the change history:</p><div class="mediaobject"><img src="../Images/image00548.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>Build definitions can be saved as templates. This helps standardize the use of certain tasks across new build definitions:</p><div class="mediaobject"><img src="../Images/image00549.jpeg" alt="Introduction"/><div class="caption"><p>An existing build definition can be saved as a template</p></div></div><p style="clear:both; height: 1em;"> </p><p>Multiple triggers can be set for the same build, including CI triggers and multiple scheduled triggers:</p><div class="mediaobject"><img src="../Images/image00550.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>Rule-based retention policies support the setting up of multiple rules. Retention can be specified by "days" or "number" of the builds:</p><div class="mediaobject"><img src="../Images/image00551.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>The build output logs are displayed in web portal in real time. The build log can be accessed from the console even after the build gets completed:</p><div class="mediaobject"><img src="../Images/image00552.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>The build reports<a id="id424" class="indexterm"/> have been revamped to offer more visibility into the build execution, and among other things, the test results can now directly be accessed from the web interface. The <code class="literal">.trx</code> file does not need to be downloaded into Visual Studio to view the test results. We'll be covering this in detail in <a class="link" title="Chapter 5. Testing Your Application" href="part0062.xhtml#aid-1R42S1">Chapter 5</a>, <span class="emphasis"><em>Testing Your Application</em></span>:</p><div class="mediaobject"><img src="../Images/image00553.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>The old build system had restrictions on one Team Project Collection per build controller and one controller per build machine. TFBuild removes this restriction and supports the reuse of queues across multiple Team Project Collections. The following image illustrates the architecture of the new build system:</p><div class="mediaobject"><img src="../Images/image00554.jpeg" alt="Introduction"/></div><p style="clear:both; height: 1em;"> </p><p>In the preceding diagram, we observe the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Multiple agents can be configured on one machine</li><li class="listitem">Agents from across different machines can be grouped into a pool</li><li class="listitem">Each pool can have only one queue</li><li class="listitem">One queue can be used across multiple Team Project Collections</li></ul></div><p>To demonstrate the capabilities of TFBuild, we'll use the FabrikamTFVC and FabrikamGit Team Projects. If you don't already have these Team Projects, follow the <span class="emphasis"><em>Creating a Team Project using the Scrum Template</em></span> recipe, in <a class="link" title="Chapter 1. Team Project Setup" href="part0016.xhtml#aid-F8901">Chapter 1</a>, <span class="emphasis"><em>Team Project Setup</em></span>.</p></div></div>
<div class="section" title="Configuring TFBuild Agent, Pool, and Queues"><div class="titlepage" id="aid-1GKCM2"><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Configuring TFBuild Agent, Pool, and Queues</h1></div></div></div><p>In this recipe, you'll learn how to configure agents and create pools and queues. You'll also learn how a queue can be used across multiple Team Project Collections.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec117"/>Getting ready</h2></div></div></div><p>Scenario: At <a id="id425" class="indexterm"/>Fabrikam, the FabrikamTFVC and FabrikamGit <a id="id426" class="indexterm"/>Team Projects need their own build queues. The FabrikamTFVC <a id="id427" class="indexterm"/>Teams build process can be executed on a Windows Server. The FabrikamGit Team build process needs both Windows and OS X. The Teams want to set up three build agents on a Windows Server; one build agent on an OS X machine. The Teams want to group two Windows Agents into a Windows Pool for FabrikamTFVC Team and group one Windows and one Mac Agent into another pool for the FabrikamGit Team:</p><div class="mediaobject"><img src="../Images/image00555.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Permission: To configure a build agent, you should be in the Build Administrators Group.</p><p>The prerequisites for setting up the build agent on a Windows-based machine are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The build agent should have a supporting version of Windows. The list of supported versions<a id="id428" class="indexterm"/> is listed at <a class="ulink" href="https://msdn.microsoft.com/en-us/Library/vs/alm/TFS/administer/requirements#Operatingsystems">https://msdn.microsoft.com/en-us/Library/vs/alm/TFS/administer/requirements#Operatingsystems</a>.</li><li class="listitem">The build agent should have Visual Studio 2013 or 2015.</li><li class="listitem">The build agent should have PowerShell 3 or a newer version.</li></ul></div><p>A build agent is configured for your TFS as part of the server installation process if you leave the <span class="strong"><strong>Configure the build service to start automatically</strong></span> option selected:</p><div class="mediaobject"><img src="../Images/image00556.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>For the <a id="id429" class="indexterm"/>purposes of this recipe, we'll configure the agents from <a id="id430" class="indexterm"/>scratch. Delete the default pool or any other pool you have by <a id="id431" class="indexterm"/>navigating to the <span class="strong"><strong>Agent pools</strong></span> option in the TFS Administration Console <code class="literal">http://tfs2015:8080/tfs/_admin/_AgentPool</code>:</p><div class="mediaobject"><img src="../Images/image00557.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec118"/>How to do it</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into the Windows machine that you desire to set the agents upon. Navigate to the <span class="strong"><strong>Agent pools</strong></span> in the TFS Administration Console by browsing to <code class="literal">http://tfs2015:8080/tfs/_admin/_AgentPool</code>. Click on <span class="strong"><strong>New Pool</strong></span>, enter the pool name as <code class="literal">Pool 1</code>, and uncheck <span class="strong"><strong>Auto-Provision Queue in Project Collections</strong></span>:<div class="mediaobject"><img src="../Images/image00558.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <span class="strong"><strong>Download agent</strong></span> icon. Copy the downloaded folder into <code class="literal">E:\</code> and unzip it into <code class="literal">E:\Win-A1</code>. You can use any drive; however, it is recommended to use the non-operating system drive:<div class="mediaobject"><img src="../Images/image00559.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Run the<a id="id432" class="indexterm"/> PowerShell console as an <a id="id433" class="indexterm"/>administrator<a id="id434" class="indexterm"/> and change the current path in PowerShell to the location of the agent in this case <code class="literal">E:\Win-A1</code>. Call the <code class="literal">ConfigureAgent.ps1</code> script in the PowerShell console and click on <span class="emphasis"><em>Enter</em></span>. This will launch the Build Agent Configuration utility:<div class="mediaobject"><img src="../Images/image00560.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Enter the configuration details as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00561.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p><div class="note" title="Note"><h3 class="title"><a id="tip11"/>Tip</h3><p>It is recommended to install the build agent as a service; however, you have an option to run the agent as an interactive process. This is great when you want to debug a build or want to temporarily use a machine as a build agent.</p></div><p>The<a id="id435" class="indexterm"/> configuration process creates a JSON <a id="id436" class="indexterm"/>settings<a id="id437" class="indexterm"/> file; it creates the working and diagnostics folders:</p><div class="mediaobject"><img src="../Images/image00562.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Refresh the <span class="strong"><strong>Agent pools</strong></span> page in the TFS Administration Console. The newly configured agent shows up under <span class="strong"><strong>Pool 1</strong></span>:<div class="mediaobject"><img src="../Images/image00563.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Repeat steps 2 to 5 to configure <span class="strong"><strong>Win-A2</strong></span> in <span class="strong"><strong>Pool 1</strong></span>. Repeat steps 1 to 5 to configure <span class="strong"><strong>Win-A3</strong></span> in <span class="strong"><strong>Pool 2</strong></span>. It is worth highlighting that each agent runs from its individual folder:<div class="mediaobject"><img src="../Images/image00564.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, log into the Mac machine and launch terminal:<div class="mediaobject"><img src="../Images/image00565.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Install <a id="id438" class="indexterm"/>the agent installer globally by running the<a id="id439" class="indexterm"/> commands illustrated here. You will be required to enter the <a id="id440" class="indexterm"/>machine password to authorize the install:<div class="mediaobject"><img src="../Images/image00566.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p><p>This will download the agent in the user profile, shown as follows:</p><div class="mediaobject"><img src="../Images/image00567.jpeg" alt="How to do it"/><div class="caption"><p>The summary of actions performed when the agent is downloaded</p></div></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Run the following command to install the agent installer globally for the user profile:<div class="mediaobject"><img src="../Images/image00568.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Running the following command will create a new directory called <code class="literal">osx-A1</code> for the agent; create the agent in the directory:<div class="mediaobject"><img src="../Images/image00569.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The agent installer has been copied from the user profile into the agent directory, shown as follows:<div class="mediaobject"><img src="../Images/image00570.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Pass the<a id="id441" class="indexterm"/> following<a id="id442" class="indexterm"/> illustrated parameters to configure<a id="id443" class="indexterm"/> the agent:<div class="mediaobject"><img src="../Images/image00571.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">This completes the configuration of the xPlatform agent on the Mac. Refresh the <span class="strong"><strong>Agent pools</strong></span> page in the TFS Administration Console to see the agent appear in <span class="strong"><strong>Pool 2</strong></span>:<div class="mediaobject"><img src="../Images/image00572.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The build agent has been configured at the Team Foundation Server level. In order to use the build agent for a Team Project Collection, a mapping between the build agent and Team Project Collection needs to be established. This is done by creating queues. To configure queues, navigate to the Collection Administration Console by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/_admin/_BuildQueue</code>. From the <span class="strong"><strong>Build</strong></span> tab, click on <span class="strong"><strong>New queue</strong></span>; this dialog allows you to reference the pool as a queue:<div class="mediaobject"><img src="../Images/image00573.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Map <span class="strong"><strong>Pool 1</strong></span> as <span class="strong"><strong>Queue 1</strong></span> and <span class="strong"><strong>Pool 2</strong></span> as <span class="strong"><strong>Queue 2</strong></span> as shown here:<div class="mediaobject"><img src="../Images/image00574.jpeg" alt="How to do it"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The<a id="id444" class="indexterm"/> TFBuild Agent, Pools, and Queues are now <a id="id445" class="indexterm"/>ready to use. The green bar before the agent name and <a id="id446" class="indexterm"/>queue in the administration console indicates that the agent and queues are online.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec119"/>How it works...</h2></div></div></div><p>To test the setup, create a new build definition by navigating to the FabrikamTFVC Team Project Build hub by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/FabrikamTFVC/_build</code>. Click on the <span class="strong"><strong>Add a new build definition</strong></span> icon. In the <span class="strong"><strong>General</strong></span> tab, you'll see that the queues show up under the <span class="strong"><strong>Queue</strong></span> dropdown menu. This confirms that the queues have been correctly configured and are available for selection in the build definition:</p><div class="mediaobject"><img src="../Images/image00575.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>Pools can be <a id="id447" class="indexterm"/>used across multiple Team Project Collections. As<a id="id448" class="indexterm"/> illustrated in the following screenshot, in Team Project Collection 2, clicking <a id="id449" class="indexterm"/>on the <span class="strong"><strong>New queue...</strong></span> shows that the existing pools are already mapped in the default collection:</p><div class="mediaobject"><img src="../Images/image00576.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Setting up a TFBuild Agent using an unattended installation" id="aid-1HIT81"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec45"/>Setting up a TFBuild Agent using an unattended installation</h1></div></div></div><p>The new <a id="id450" class="indexterm"/>build framework allows<a id="id451" class="indexterm"/> the unattended setup of build agents by injecting a set of parameter values via script. This technique can be used to spin up new agents to be attached into an existing agent pool. In this recipe, you'll learn how to configure and unconfigure a build agent via script.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec120"/>Getting ready</h2></div></div></div><p>Scenario: The <a id="id452" class="indexterm"/>FabrikamTFVC Team wants the ability to install, configure, and unconfigure a build agent directly via script without having to perform this operation using the Team Portal.</p><p>Permission: To configure a build agent, you should be in the Build Administrators Group.</p><p>Download the build agent as discussed in the earlier recipe <span class="emphasis"><em>Configuring TFBuild Agent, Pool, and Queues</em></span>. Copy the folder to <code class="literal">E:\Agent</code>. The script refers to this <code class="literal">Agent</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec121"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch <a id="id453" class="indexterm"/>PowerShell in the elevated mode and execute the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>.\Agent\VsoAgent.exe /Configure /RunningAsService /ServerUrl:"http://tfs2015:8080/tfs" /WindowsServiceLogonAccount:svc_build /WindowsServiceLogonPassword:xxxxx /Name:WinA-10 /PoolName:"Pool 1" /WorkFolder:"E:\Agent\_work" /StartMode:Automatic</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip12"/>Tip</h3><p>Replace the value of the username and password accordingly.</p></div><p>Executing the script will result in the following output:</p><div class="mediaobject"><img src="../Images/image00577.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The script installs an agent by the name <span class="strong"><strong>WinA-10</strong></span> as Windows Service running as <code class="literal">svc_build</code>. The agent is added to <span class="strong"><strong>Pool 1</strong></span>:<div class="mediaobject"><img src="../Images/image00578.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To unconfigure <span class="strong"><strong>WinA-10</strong></span>, run the following command in an elevated PowerShell prompt:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>.\Agent\VsoAgent.exe /Unconfigure "vsoagent.tfs2015.WinA-10"</strong></span>
</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip13"/>Tip</h3><p>To unconfigure, script needs to be executed from outside the scope of the <code class="literal">Agent</code> folder. Running the script from within the <code class="literal">Agent</code> folder scope will result in an error message.</p></div><div class="mediaobject"><img src="../Images/image00579.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec122"/>How it works...</h2></div></div></div><p>The new build<a id="id454" class="indexterm"/> agent natively allows <a id="id455" class="indexterm"/>configuration via script. A new capability called <a id="id456" class="indexterm"/>
<span class="strong"><strong>Personal Access Token</strong></span> (<span class="strong"><strong>PAT</strong></span>) is due for release in the future updates of TFS 2015. PAT allows you to generate a personal OAuth token for a specific scope; it replaces the need to key in passwords into configuration files.</p></div></div>
<div class="section" title="Creating a continuous integration build definition in TFBuild"><div class="titlepage" id="aid-1IHDQ2"><div><div><h1 class="title"><a id="ch04lvl1sec46"/>Creating a continuous integration build definition in TFBuild</h1></div></div></div><p>In this recipe, you'll learn how to author a continuous integration build definition.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec123"/>Getting ready</h2></div></div></div><p>Scenario: The <a id="id457" class="indexterm"/>FabrikamTFVC <a id="id458" class="indexterm"/>Team wants to set up a build definition that is executed on every code check-in. The Team wants to run this build definition using <span class="strong"><strong>Pool 1</strong></span>, which has the required frameworks installed to compile the code and execute unit tests.</p><p>To create a new build definition, you need to have the build definition author or builder's permissions. This permission can be granted by adding yourself to the Build Administrators Security Group.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec124"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Build</strong></span> hub in FabrikamTFVC Team Portal by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/FabrikamTFVC/_build</code>. Click on the <span class="strong"><strong>+</strong></span> icon to create a new build definition. Select <span class="strong"><strong>Visual Studio</strong></span> from the <span class="strong"><strong>DEFINITION TEMPLATES</strong></span> window:<div class="mediaobject"><img src="../Images/image00580.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>This loads <a id="id459" class="indexterm"/>an <a id="id460" class="indexterm"/>empty build definition called <span class="strong"><strong>New Visual Studio definition 1</strong></span>:</p><div class="mediaobject"><img src="../Images/image00581.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the <span class="strong"><strong>General</strong></span> tab, set the fields as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00582.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>A build job<a id="id461" class="indexterm"/> timeout<a id="id462" class="indexterm"/> allows you to enter the minimum time a build job requires to execute, before it is cancelled by the server. An empty or <code class="literal">0</code> value in this field signifies an infinite timeout.</p><p>The default value of <span class="strong"><strong>Build job authorization scope</strong></span> is <span class="strong"><strong>Project Collection</strong></span>. You should only use Project Collection if the build definition needs to access resources outside the scope of the Team Project.</p><p>The default value of <span class="strong"><strong>Build number format</strong></span> is <code class="literal">$(date:yyyyMMdd)$(rev:.r)</code>. As a development best practice, it is always advisable to stamp the DLLs of the build output with the build number. This approach won't work with the default build number format. Change the build number format to an assembly version format such as <code class="literal">1.0.$(date:yyyyMMdd)$(rev:.r)</code>. A complete list of build number macros<a id="id463" class="indexterm"/> can be found at <a class="ulink" href="https://msdn.microsoft.com/en-us/library/hh190719.aspx">https://msdn.microsoft.com/en-us/library/hh190719.aspx</a>.</p></li><li class="listitem">Navigate to the <span class="strong"><strong>Repository</strong></span> tab. It allows you to specify source control settings for the build. Set the fields as illustrated in the following screenshot. The <span class="strong"><strong>Clean</strong></span> field forces the server workspace to be recreated for each build. In general, cleaning the workspace prior to building will take more time to build a solution. To only pull incremental changes into the build workspace, set the value to <span class="strong"><strong>false</strong></span>. Label sources labels the version of the code build by the build definition. The <span class="strong"><strong>Label format</strong></span> field specified here will create the label names as <code class="literal">BuildDefinitionName_BuildNumber</code>:<div class="mediaobject"><img src="../Images/image00583.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the <a id="id464" class="indexterm"/><span class="strong"><strong>Triggers</strong></span> tab and<a id="id465" class="indexterm"/> check CI. Configure the filters as illustrated in the screenshot here. The batch changes setting allows multiple check-ins queued for the same build to be bundled together into a single CI build:<div class="mediaobject"><img src="../Images/image00584.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>At least one filter needs to be applied when configuring CI. Any check-ins done under the path set as included will trigger the build definition. The <span class="strong"><strong>Exclude</strong></span> filter is used to exclude check-ins from under the specified path to trigger the build definition. In this case, any check-ins under the <code class="literal">$/FabrikamTFVC/Main/Source/lib</code> folder will not trigger this build definition. Navigate to the <span class="strong"><strong>Options</strong></span> tab and set the fields as illustrated in the following screenshot. <span class="strong"><strong>MultiConfiguration</strong></span> allows you to build more than one configuration as a part of the same pass. It is recommended to build multiple configurations as a part of the same build definition specifically if the code being built has platform dependencies. Checking <span class="strong"><strong>Parallel</strong></span> allows the build for multiple configurations to be executed in parallel:</p><div class="mediaobject"><img src="../Images/image00585.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, navigate to the<a id="id466" class="indexterm"/> <span class="strong"><strong>Build</strong></span> tab. The <a id="id467" class="indexterm"/>new build engine manifests itself as an orchestrator. The steps orchestrated need to be specified in the <span class="strong"><strong>Build</strong></span> tab. As you can see in the <span class="strong"><strong>Build</strong></span> tab, four build steps namely <span class="strong"><strong>Visual Studio Build</strong></span>, <span class="strong"><strong>Visual Studio Test</strong></span>, <span class="strong"><strong>Index Sources And Publish Symbols</strong></span>, and <span class="strong"><strong>Publish Build Artifacts</strong></span> are pre-added for you through the chosen template. Click on <span class="strong"><strong>Visual Studio Build</strong></span> and update the fields as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00586.jpeg" alt="How to do it..."/><div class="caption"><p>The Build tab includes the Visual Studio Build, Visual Studio Test, Index Sources And Publish Symbols, and Publish Build Artifact tasks. These tasks are pre added on creating a new build definition using the Visual Studio Build Template.</p></div></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the path to the solution that you wish to compile. Leaving it to the default value of <code class="literal">**/*.sln</code> will build all solutions under the path specified in the <span class="strong"><strong>Repositories</strong></span> tab.</li><li class="listitem">The <span class="strong"><strong>MSBuild Arguments</strong></span> textbox allows you to pass additional MS Build Arguments. A complete list of MS Build Arguments<a id="id468" class="indexterm"/> can be found at <a class="ulink" href="https://msdn.microsoft.com/en-us/library/ms164311.aspx">https://msdn.microsoft.com/en-us/library/ms164311.aspx</a>.</li><li class="listitem">You'll notice that the platform and configuration are preconfigured with a variable. Variables provide you with the ability to centrally manage values rather than hard coding them into the build definition. Variables also provide you with the ability to overwrite the values at run time. The values for these variables are specified in the <span class="strong"><strong>Variables</strong></span> tab; you can optionally navigate to the <span class="strong"><strong>Variables</strong></span> tab to overwrite the default values injected by the template.</li><li class="listitem">Selecting the <span class="strong"><strong>Restore NuGet Packages</strong></span> checkbox allows the build system to download any dependant NuGet packages during the build execution time.<div class="note" title="Note"><h3 class="title"><a id="tip14"/>Tip</h3><p>The auto restore of NuGet packages is quite a useful feature; this allows you to avoid having to check-in dependency packages into TFS.</p></div></li><li class="listitem">The <span class="strong"><strong>Advanced</strong></span> <a id="id469" class="indexterm"/>settings allow <a id="id470" class="indexterm"/>you to specify a specific version of MSBuild or Visual Studio to compile against your code. The default is x86.</li><li class="listitem">The <span class="strong"><strong>Control Options</strong></span> textarea allows you to disable a specific build definition; this option also allows you to specify the behavior on build errors. You can choose to stop the build process on encountering the first build error.</li><li class="listitem">Next, click on the <span class="strong"><strong>Visual Studio Test</strong></span> step; you will see the list of configurable variables on the left panel. Similar to the build step, this step also offers you the ability to choose the version of VS Test Runner to use for executing the tests. The <span class="strong"><strong>Advanced</strong></span> section also allows you to specify the path to custom test adapters. This is extremely useful if you are planning to use a non-VS Test Runner to execute the tests. Check the <span class="strong"><strong>Code Coverage Enabled</strong></span> checkbox, and leave the defaults in the other fields:<div class="mediaobject"><img src="../Images/image00587.jpeg" alt="How to do it..."/><div class="caption"><p>Check the code coverage enabled checkbox, and leave the defaults in other fields</p></div></div><p style="clear:both; height: 1em;"> </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Test Assembly</strong></span>: The <span class="strong"><strong>Test Assembly</strong></span> field should be used to specify the path to the test projects that you want the VS Test Runner to execute. The field accepts wildcards; as per the default, all the projects that have <code class="literal">*test*.dll</code> as an output will be picked up by the test runner for execution.</li><li class="listitem"><span class="strong"><strong>Test Filter criteria</strong></span>: This field allows you to run selective tests using a specific filter. A run settings file can be passed in the <span class="strong"><strong>Run Settings File</strong></span> field. This is useful if the Development Team wants to execute the tests using the same test settings on developer machines and build servers. Test run parameters specified in the test settings file can be overwritten using the <span class="strong"><strong>Override TestRun Parameters</strong></span> field.</li></ul></div></li><li class="listitem">Next, click on<a id="id471" class="indexterm"/> <span class="strong"><strong>Index Sources And Publish Symbols</strong></span>. During the source code compilation process, the<a id="id472" class="indexterm"/> build engine generated symbol files. The symbol files are the <code class="literal">.PDB</code> files that match a particular assembly and contain information used by debugging tools. The symbol files for the .NET assemblies contain source file names, line numbers, and local variable names. The build definition is capable of publishing the symbols to the symbol server. The developers can point to this symbol server in Visual Studio; this automatically downloads the correct symbols during debugging. Follow the instructions here to set up a<a id="id473" class="indexterm"/> file share-based symbol server if you don't already have one: <a class="ulink" href="https://msdn.microsoft.com/en-us/library/windows/hardware/mt146873(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/mt146873(v=vs.85).aspx</a>.<div class="mediaobject"><img src="../Images/image00588.jpeg" alt="How to do it..."/><div class="caption"><p>Set the artifact name as Symbols_$(BuildConfiguration)</p></div></div><p style="clear:both; height: 1em;"> </p><p>Last but not least, navigate to the <span class="strong"><strong>Publish Build Artifacts</strong></span> task. This task allows you to specify the settings where the build artifacts are published. Choose the server to store the artifact on your TFS. This is the best and simplest option in most cases:</p><div class="mediaobject"><img src="../Images/image00589.jpeg" alt="How to do it..."/><div class="caption"><p>In the Publish Artifact, set the Artifact Type as Server</p></div></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on<a id="id474" class="indexterm"/> <span class="strong"><strong>Save</strong></span> and give the<a id="id475" class="indexterm"/> build definition a name; add a comment as illustrated in the following screenshot:<div class="mediaobject"><img src="../Images/image00590.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Queue Build</strong></span> to manually trigger a new build for this build definition. The Build Output Console starts to show the build agent activity in real time:<div class="mediaobject"><img src="../Images/image00591.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec125"/>How it works...</h2></div></div></div><p>As you would have noticed, the out-of-the-box experience after selecting the Visual Studio Template preconfigures most of the settings for you giving you the ability to set up your CI process in next to no time.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec126"/>There's more…</h2></div></div></div><p>The build <a id="id476" class="indexterm"/>output has also been revamped <a id="id477" class="indexterm"/>in the new build framework. As illustrated in the following screenshot, the build output includes the test results and code coverage results. The output also includes a separate view for timeline and artifacts for easier access:</p><div class="mediaobject"><img src="../Images/image00592.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Pinning a build badge to the welcome page in Team Portal" id="aid-1JFUC1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec47"/>Pinning a build badge to the welcome page in Team Portal</h1></div></div></div><p>Build badge <a id="id478" class="indexterm"/>is a dynamically generated image showing<a id="id479" class="indexterm"/> the status of the last build for a build<a id="id480" class="indexterm"/> definition. In this recipe, you'll learn how to pin a build badge to a Dashboard in Team Portal.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec127"/>Getting ready</h2></div></div></div><p>To modify a build definition, you need to have the build definition author or builder's permissions. This permission can be granted by adding yourself to the Build Administrators Security Group.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec128"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Build</strong></span> hub for FabrikamTFVC Team Project; browse to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/FabrikamTFVC/_build</code>.</li><li class="listitem">Locate the build <a id="id481" class="indexterm"/>definition <span class="strong"><strong>FabrikamTFVC CI</strong></span> <a id="id482" class="indexterm"/>from under the build<a id="id483" class="indexterm"/> definitions menu in the left panel and choose to edit the build definition.</li><li class="listitem">Navigate to the <span class="strong"><strong>General</strong></span> tab of the build definition and check the option <span class="strong"><strong>Badge enabled</strong></span>:<div class="mediaobject"><img src="../Images/image00593.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span> to update the changes in order to enable the badge build definition. Upon saving the changes, a new hyperlink <span class="strong"><strong>Show url…</strong></span> appears next to the <span class="strong"><strong>Badge enabled</strong></span> field. Click on the <span class="strong"><strong>Show url...</strong></span> hyperlink and copy the hyperlink:<div class="mediaobject"><img src="../Images/image00594.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the <span class="strong"><strong>Welcome</strong></span> page of the FabrikamTFVC Team in Team Portal by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/FabrikamTFVC/_welcome</code>.</li><li class="listitem">Edit <code class="literal">README.md</code> and paste the build badge URL. Save the changes. In the following screenshot, the current status of the FabrikamTFVC build is represented in red as <span class="strong"><strong>Failed</strong></span>. A passing build is represented in green. A partially successful build is in orange:<div class="mediaobject"><img src="../Images/image00595.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><div class="mediaobject"><img src="../Images/image00596.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec129"/>How it works...</h2></div></div></div><p>The Team Foundation <a id="id484" class="indexterm"/>Server Build API exposes a public endpoint<a id="id485" class="indexterm"/> for the status of the last build. The URL<a id="id486" class="indexterm"/> calls into this endpoint by passing the build definition ID requesting for the build definition status to be rendered as a badge <code class="literal">_apis/public/build/definitions/94fb1544-b441-45f5-a54d-466fc5d66817/4/badge</code>.</p></div><div class="section" title="There is more"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec130"/>There is more</h2></div></div></div><p>The build definitions now support saving changes as drafts. This can be done by choosing the <span class="strong"><strong>Save as a draft</strong></span> option, as illustrated in the screenshot here:</p><div class="mediaobject"><img src="../Images/image00597.jpeg" alt="There is more"/></div><p style="clear:both; height: 1em;"> </p><p>The build definitions, which are also saved as a draft, support the queue build function. Builds generated by draft build definitions contain the <code class="literal">DRAFT</code> keyword in the build name:</p><div class="mediaobject"><img src="../Images/image00598.jpeg" alt="There is more"/></div><p style="clear:both; height: 1em;"> </p><p>This gives you a great way to validate build definition changes before sharing them broadly.</p></div></div>
<div class="section" title="Managing build resources using role-based access" id="aid-1KEEU1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec48"/>Managing build resources using role-based access</h1></div></div></div><p>The old build <a id="id487" class="indexterm"/>permissions model for build <a id="id488" class="indexterm"/>resources was flat, meaning you could grant someone permission to manage all or no build resources. In the new build system, the security is a proper hierarchy, so you can control permissions on a queue-by-queue or pool-by-pool basis. The build system provides a "role-based access control" instead of exposing the underlying permissions directly. In this recipe, you'll learn how to permission build resources at the pool and queue levels.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec131"/>Getting ready</h2></div></div></div><p>Scenario: To manage the all pools membership, you need to be a member of the Team Foundation Administrators Group. Membership to Team Project Collection Administrator Group is required to manage permissions for individual pools. In order to manage the permissions for the queues, you need to be a member of the Project Collection Build Administrators Group. Build Definition Administration requires membership to the Build Administrators Group.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec132"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <span class="strong"><strong>Agent</strong></span> tab in the Account Administration Console by browsing to <code class="literal">http://tfs2015:8080/tfs/_admin/_AgentPool</code>. Click on <span class="strong"><strong>All Pools</strong></span> and add build agent service accounts that you intend to use globally across TFS into the <span class="strong"><strong>Agent Pool Service Accounts</strong></span> role:<div class="mediaobject"><img src="../Images/image00599.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>To scope a service account only to <span class="strong"><strong>Pool 1</strong></span>, click on <span class="strong"><strong>Pool 1</strong></span>, select the <span class="strong"><strong>Agent Pool Service Accounts</strong></span> option, and click on <span class="strong"><strong>Add...</strong></span> to add the account:</p><div class="mediaobject"><img src="../Images/image00600.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the<a id="id489" class="indexterm"/> <span class="strong"><strong>Agent queues</strong></span> <a id="id490" class="indexterm"/>tab in the Default Project Collection scope in Administration Console by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/_admin/_AgentQueue</code>. Click on <span class="strong"><strong>All Queues</strong></span>. The role membership for all queues administrators, creators, and users can be set from here:<div class="mediaobject"><img src="../Images/image00601.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Administration, creation, and user roles at the Pool 1 level scope these permissions at the Pool 1 level only. These can be set by clicking on <span class="strong"><strong>Pool 1</strong></span> and adding the users and groups to the relevant roles.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec133"/>How it works...</h2></div></div></div><p>As illustrated in the following figure, the new build system contains a hierarchical role-based access control model. In the next section, we'll go through each of the roles and accesses that they offer:</p><div class="mediaobject"><img src="../Images/image00602.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>All Queues</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Agent Queue Administrators</strong></span>: Users in this role have the ability to manage all the queues within the Project Collection.</li><li class="listitem"><span class="strong"><strong>Agent Queue Creators</strong></span>: Users in this role have the ability to create new<a id="id491" class="indexterm"/> queues. If <a id="id492" class="indexterm"/>there is no pool with the same name as the queue, one will be provisioned at the queue creation time, and the caller will be added as an administrator of both the queue and the corresponding pool. If a pool with the same name already exists, the caller must have the <span class="strong"><strong>Manage</strong></span> permission (must be a pool administrator) on the pool to create a new queue that uses the pool.</li><li class="listitem"><span class="strong"><strong>Agent Queue Users</strong></span>: Users in this role have the ability to use all the queues for the entire collection. Use means they can assign the queues to be used by definitions in the build space.</li></ul></div></li><li class="listitem"><span class="strong"><strong>Individual Queues</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Agent Queue Administrators</strong></span>: This is same as the previous role, but the permissions are restricted to a specific queue.</li><li class="listitem"><span class="strong"><strong>Agent Queue Users</strong></span>: This is same as the previous role, but the permissions are restricted to a specific queue.</li></ul></div></li><li class="listitem"><span class="strong"><strong>All Pools</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Agent Pool Administrators</strong></span>: Users in this role have the ability to manage all the pools within the entire account.</li><li class="listitem"><span class="strong"><strong>Agent Pool Service Accounts</strong></span>: Users in this role have the ability to connect to the pool and receive messages regarding build jobs, including control messages such as "update yourself" and "cancel this job".</li></ul></div></li><li class="listitem"><span class="strong"><strong>Individual Pools</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Agent Pool Administrators</strong></span>: This is same as the previous role, but the <a id="id493" class="indexterm"/>permissions are restricted to the specific pool.</li><li class="listitem"><span class="strong"><strong>Agent Pool Service Accounts</strong></span>: This is same as the previous role, but the <a id="id494" class="indexterm"/>permissions are restricted to the specific pool.</li></ul></div></li></ul></div></div></div>
<div class="section" title="Using the build retention policy to automate build deletion" id="aid-1LCVG1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec49"/>Using the build retention policy to automate build deletion</h1></div></div></div><p>The build retention policy allows you to delete older builds including its output and related artifacts using a set of rules. The build retention policy in the old build system had two drawbacks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The retention policy could only be applied per build definition</li><li class="listitem">The retention was based on the number of builds only</li></ul></div><p>The new build system <a id="id495" class="indexterm"/>allows a global retention<a id="id496" class="indexterm"/> policy; this makes it easier to administer build retention. The new system allows retention by the age of build, making it easier to create meaningful retention rules. In this recipe, you'll learn how to apply the build retention policy both globally at the Team Project Collection level and locally at the build definition level.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec134"/>Getting ready</h2></div></div></div><p>To administer build resources for the collection, you need to be a member of the Project Collection Build Administrators Group.</p><p>Scenario: The Fabrikam Team would like to enforce a default retention policy of 20 days across all build definitions in the Default Team Project Collection. The FabrikamTFVC Team only wants to keep builds from FabrikamTFVC CI build definition for 5 days. At Fabrikam, all the builds older than 45 days that haven't been marked to be retained indefinitely should be deleted.</p><p>The retention policy applies to all builds in a Team Project Collection. There may be a few builds that you would like to retain longer than the maximum retention enforced by the global policy. This can be achieved by marking a build for indefinite retention. Browse to the specific build that you would like to exclude from the retention policy. Then, right-click on the build and set the <span class="strong"><strong>Retain indefinitely</strong></span> flag on the build:</p><div class="mediaobject"><img src="../Images/image00603.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec135"/>How to do it...</h2></div></div></div><p>Navigate to the <span class="strong"><strong>Build</strong></span> tab in the Administration Console for the Default Project Collection by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/_admin/_buildQueue</code>.</p><p>In the <span class="strong"><strong>Maximum Retention Policy</strong></span> section, update the <span class="strong"><strong>Days to keep</strong></span> textbox to <code class="literal">45</code>. This will enforce a <a id="id497" class="indexterm"/>maximum retention<a id="id498" class="indexterm"/> of 45 days for all builds excluding those marked as retain indefinitely. Click on <span class="strong"><strong>Save changes</strong></span> to apply the changes:</p><div class="mediaobject"><img src="../Images/image00604.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>In the <span class="strong"><strong>Default Retention Policy</strong></span> section, update the <span class="strong"><strong>Days to keep</strong></span> textbox to <code class="literal">20</code> days. This setting is cascaded to all the newly created build definitions. Click on <span class="strong"><strong>Save changes</strong></span> to apply the changes:</p><div class="mediaobject"><img src="../Images/image00605.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>Navigate to the FabrikamTFVC CI build definition, and then to the <span class="strong"><strong>Retention</strong></span> tab. Update the value of <span class="strong"><strong>Days to keep</strong></span> to <code class="literal">5</code> days. A retention rule can be deleted by clicking the delete icon; a new retention rule can be added by clicking on the <span class="strong"><strong>Add new rule...</strong></span> icon:</p><div class="mediaobject"><img src="../Images/image00606.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec136"/>How it works...</h2></div></div></div><p>TFS has a<a id="id499" class="indexterm"/> set of background jobs that<a id="id500" class="indexterm"/> are scheduled to run to manage various operations in TFS. The build retention policy is orchestrated by the TFS Agent; only those builds that have been marked as retain indefinitely will be excluded from the deletion process. At the moment, it is not possible to change the global settings for deleting build records and test records, and applying branch filters.</p><p>At the build definition level, it is possible to change the settings for what is deleted as a part of the retention policy. The <span class="strong"><strong>Delete test results</strong></span> setting only deletes test runs, results, and attachments, manual test results are not deleted:</p><div class="mediaobject"><img src="../Images/image00607.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec137"/>There's more…</h2></div></div></div><p>The new build system also has a provision for associating tags within individual builds and filtering builds using tags. Let's start off by tagging a build. Open a build and add a few tags under the <span class="strong"><strong>Tags</strong></span> section as illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00608.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p><p>In the build <a id="id501" class="indexterm"/>list page, enter the tags you <a id="id502" class="indexterm"/>would like to filter the build list by. As illustrated in the following screenshot, the build list is filtered by the <span class="strong"><strong>Bug#1291</strong></span> and <span class="strong"><strong>Investigate</strong></span> tags:</p><div class="mediaobject"><img src="../Images/image00609.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Using user capabilities to identify a build agent in a pool" id="aid-1MBG21"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec50"/>Using user capabilities to identify a build agent in a pool</h1></div></div></div><p>It is not uncommon to have specialized build agents for specific builds. For example, an application may have dependency on SharePoint SDK. A build agent can be stood up to cater for builds that have such dependencies. The new build system introduces the concept of<a id="id503" class="indexterm"/> <span class="strong"><strong>capabilities</strong></span>. Capabilities, in their most basic form, are a collection of key value pairs used to recognize the abilities of a build server. A build that requires a specific ability for its execution can be routed to a relevant build agent by referring to these key/<a id="id504" class="indexterm"/>value pairs. A build <a id="id505" class="indexterm"/>agent supports both system and user capabilities. System capabilities are a list of software frameworks already available on the build agent. They are generated by the build agent. User capabilities can be manually added to a build agent; this is a useful way to tag on a key value pair to recognize a build agent. In this recipe, you'll learn how to add a user capability to a build agent to recognize it in a pool of build agents.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec138"/>Getting ready</h2></div></div></div><p>Scenario: The FabrikamTFVC Team has a solution that has dependency on SharePoint 2016 SDK. It has supplemented Pool 1 with an additional agent that has SharePoint 2016 SDK installed. While other build definitions can use both <span class="strong"><strong>Win-A1</strong></span> and <span class="strong"><strong>Win-A2</strong></span>, all build requests from FabrikamTFVC CI build need to be routed to <span class="strong"><strong>Win-A2</strong></span> only:</p><div class="mediaobject"><img src="../Images/image00610.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>For example, to amend the build agent capabilities, you need to be a member of the Build Administrators Group.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec139"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id506" class="indexterm"/> to the <span class="strong"><strong>Agent pools</strong></span><a id="id507" class="indexterm"/> tab in the Administration Console by browsing to <code class="literal">http://tfs2015:8080/tfs/_admin/_AgentPool</code>.</li><li class="listitem">Click on <span class="strong"><strong>Pool 1</strong></span> and select <span class="strong"><strong>Win-A2</strong></span>. From the <span class="strong"><strong>USER CAPABILITIES</strong></span> section, click on the <span class="strong"><strong>Add capability</strong></span> hyperlink. Add <code class="literal">SharePoint.SDK</code> as the key and <code class="literal">2016</code> as the value:<div class="mediaobject"><img src="../Images/image00611.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the FabrikamTFVC CI build, edit the build definition, and browse to the <span class="strong"><strong>General</strong></span> tab. In the <span class="strong"><strong>Demands</strong></span> section, click on the <span class="strong"><strong>Add demand</strong></span> hyperlink. Add <code class="literal">SharePoint.SDK</code> and set the comparator to <span class="strong"><strong>equals</strong></span> and the <span class="strong"><strong>Value</strong></span> field to <code class="literal">2016</code>. Click on <span class="strong"><strong>Save</strong></span> to apply the changes to the build definition:<div class="mediaobject"><img src="../Images/image00612.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <span class="strong"><strong>Queue build</strong></span> icon. In the launched window, click on the <span class="strong"><strong>Demands</strong></span> tab. You'll see the newly added <code class="literal">SharePoint.SDK</code> demand shows up in this <a id="id508" class="indexterm"/>view. Demands<a id="id509" class="indexterm"/> can be added, removed, or edited directly from this window. Click on <span class="strong"><strong>OK</strong></span> to trigger a build from this build definition:<div class="mediaobject"><img src="../Images/image00613.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec140"/>How it works…</h2></div></div></div><p>The build framework scans <span class="strong"><strong>Pool 1</strong></span> for agents that match the list of demands specified in the build definition. In case no agent fulfils the demands raised by the build definition, a warning message is generated by the queued build indicating that there are no available build agents to process the build request.</p><p>The following screenshot illustrates that the build has successfully been routed to <span class="strong"><strong>Win-A2</strong></span> by matching the build demand and the agent capability:</p><div class="mediaobject"><img src="../Images/image00614.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The prior versions<a id="id510" class="indexterm"/> of TFS have allowed build<a id="id511" class="indexterm"/> routing via build agent and build definition tagging. The new build system enriches the experience by providing an auto-generated list of system capabilities as well as the use of comparators for authoring demands in the build definition.</p></div></div>
<div class="section" title="Version DLLs in build output with build number" id="aid-1NA0K1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec51"/>Version DLLs in build output with build number</h1></div></div></div><p>Traceability is very important<a id="id512" class="indexterm"/> in the software develop lifecycle. Teams strive for traceability between requirements and test cases, code check-ins and builds, and code changes and test runs. Talking of traceability, it would be useful to map the binaries in the build output back to the build. In this recipe, you'll learn how to stamp the DLLs in the build output with the build number they are being generated from.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec141"/>Getting ready</h2></div></div></div><p>Scenario: The FabrikamTFVC Team wants to label the source code used in the build and tag the label and build output using the build number:</p><div class="mediaobject"><img src="../Images/image00615.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Download the <code class="literal">StampBuildNumber.ps1</code> script provided in the course material. Check-in the <code class="literal">StampBuildNumber.ps1</code> script into the <code class="literal">script</code> folder as illustrated in this screenshot:</p><div class="mediaobject"><img src="../Images/image00616.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p><span class="strong"><strong>Permissions</strong></span>: You'll need to edit build definition permissions to execute this recipe; you can get these permissions by being added to the Build Administrators Group.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec142"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the <a id="id513" class="indexterm"/><span class="strong"><strong>Build</strong></span> hub in the FabrikamTFVC Team Project by browsing to <code class="literal">http://tfs2015:8080/tfs/DefaultCollection/FabrikamTFVC/_build</code>. Select the <span class="strong"><strong>FabrikamTFVC CI</strong></span> Build for editing.</li><li class="listitem">Navigate to the <span class="strong"><strong>General</strong></span> tab and change the <span class="strong"><strong>Build number format</strong></span> field to <code class="literal">1.0.$(Year:yy)$(DayOfYear).$(BuildID)</code>.</li><li class="listitem">Navigate to the <span class="strong"><strong>Repository</strong></span> tab in the build definition, select the <span class="strong"><strong>Labeling Of Source</strong></span> option on successful build, and change the <span class="strong"><strong>Label format</strong></span> field to <code class="literal">$(build.buildNumber)</code>.</li><li class="listitem">Navigate to the <span class="strong"><strong>Build</strong></span> tab, click on <span class="strong"><strong>Add build step...</strong></span>, and select the <span class="strong"><strong>PowerShell</strong></span> task:<div class="mediaobject"><img src="../Images/image00617.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Update the script file path in the <span class="strong"><strong>PowerShell</strong></span> task to point to the location of the <code class="literal">StampBuildNumber.ps1</code> script, which in this case is <code class="literal">$/FabrikamTFVC/Main/Source/script/StampBuildNumber.ps1</code>. The script expects build number and agent workspace as input parameters. These values can be injected using the predefined variable <code class="literal">$(Build.BuildNumber) $(Agent.BuildDirectory)\$(Build.Repository.Name)</code>. A complete list of predefined variables can be found at <a class="ulink" href="https://msdn.microsoft.com/Library/vs/alm/Build/scripts/variables">https://msdn.microsoft.com/Library/vs/alm/Build/scripts/variables</a>.<div class="mediaobject"><img src="../Images/image00618.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span> and<a id="id514" class="indexterm"/> enter a comment to apply the changes made to the FabrikamTFVC CI build definition. Queue a build to validate the build number stamping on the DLLs in the build output:<div class="mediaobject"><img src="../Images/image00619.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p><p><span class="strong"><strong>Build 1.0.15289.68</strong></span> successfully executes the <code class="literal">StampBuildNumber.ps1</code> script; a build source label matching the build number is generated as a result of a successful build. The build output can be downloaded from the <span class="strong"><strong>Artifacts</strong></span> view. The <span class="strong"><strong>File version</strong></span> and <span class="strong"><strong>Product version</strong></span> fields have the same values as the build number. This provides an end-to-end mapping of the build number across the different artifacts.</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec143"/>How it works…</h2></div></div></div><p>In order to successfully stamp the build number on to the DLLs, the build number needs to use the assembly version format. There are some interesting recommendations on Semantic Versioning<a id="id515" class="indexterm"/> that you can read more about at <a class="ulink" href="http://semver.org/">http://semver.org/</a>.</p><p>Each C# project contains a file <code class="literal">AssemblyInfo.cs</code>; as illustrated in the following screenshot. This class contains properties for <code class="literal">AssemblyVersion</code> and <code class="literal">AssemblyFileVersion</code>. The <code class="literal">StampBuildNumber.ps1</code> script overwrites the <code class="literal">AssemblyVersion</code> and <code class="literal">AssemblyFileVersion</code> fields with the injected build number:</p><div class="mediaobject"><img src="../Images/image00620.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The PowerShell task<a id="id516" class="indexterm"/> executing <code class="literal">StampBuildNumber</code> script needs to be run before the Visual Studio Build task to ensure the updated values for <code class="literal">AssemblyVersion</code> and <code class="literal">AssemblyFileVersion</code> properties are used during the compilation process.</p><p>The <code class="literal">StampBuildNumber</code> script accepts two parameters as illustrated here. These parameters are injected through predefined variables via the build definition:</p><div class="mediaobject"><img src="../Images/image00621.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The <code class="literal">Set-AssemblyVersion</code> function validates that the build number value abides to the assembly version format. A scan is then performed in the build workspace to locate the <code class="literal">AssemblyInfo.cs</code> class. The <code class="literal">AssemblyVersion</code> and the <code class="literal">AssemblyFileVersion</code> properties in the <code class="literal">AssemblyInfo.cs</code> file are then replaced with the value of the build number:</p><div class="mediaobject"><img src="../Images/image00622.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>The following screenshot<a id="id517" class="indexterm"/> illustrates the processed <code class="literal">AssemblyInfo.cs</code> file from the agent work directory:</p><div class="mediaobject"><img src="../Images/image00623.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Creating a new build task using the TFBuild Extensibility framework" id="aid-1O8H61"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec52"/>Creating a new build task using the TFBuild Extensibility framework</h1></div></div></div><p>The new<a id="id518" class="indexterm"/> build system comes with a <a id="id519" class="indexterm"/>wide range of prepackaged build tasks. Out-of-the-box tasks are complimented with the presence of popular scripting engines. This helps address scenarios that aren't directly covered with the out-of box-tasks. The new build system has been architected from the ground up with a special focus on extensibility. In this recipe, you'll learn how to create a new build task using the extensibility framework available in the new build system.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec144"/>Getting ready</h2></div></div></div><p>The TFS Extensions command-line utility (<code class="literal">tfx-cli</code>) needs to be used for building task management. The utility is based on Node.js. As a prerequisite to using <code class="literal">tfx-cli</code>, download and install Node.js<a id="id520" class="indexterm"/> from <a class="ulink" href="https://nodejs.org/en/download">https://nodejs.org/en/download</a>. The extensibility command-line utility can directly be installed<a id="id521" class="indexterm"/> by launching command<a id="id522" class="indexterm"/> prompt and running the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>npm install -g tfx-cli</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00624.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>To authenticate with TFS, the <code class="literal">tfx-cli</code> utility only accepts <span class="strong"><strong>Personal Access Tokens</strong></span> (<span class="strong"><strong>PAT</strong></span>)<a id="id523" class="indexterm"/> or alternate credentials. Since support for PATs is yet to be released in TFS, alternate credentials need to be used for authentication. Guidance on how to set up alternate credentials<a id="id524" class="indexterm"/> can be found at <a class="ulink" href="https://github.com/Microsoft/tfs-cli/blob/master/docs/configureBasicAuth.md">https://github.com/Microsoft/tfs-cli/blob/master/docs/configureBasicAuth.md</a>.</p><p>The following screenshot illustrates how to authenticate with <code class="literal">tfx-cli</code> by passing the connection details of the Team Project Collection along with alternate credentials:</p><div class="mediaobject"><img src="../Images/image00625.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>To validate that you have performed the setup correctly, try retrieving a list of build tasks by running the command <code class="literal">tfx build tasks list</code>:</p><div class="mediaobject"><img src="../Images/image00626.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec145"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To create a <a id="id525" class="indexterm"/>new task, run<a id="id526" class="indexterm"/> the command <code class="literal">tfx build tasks create</code>, shown as follows:<div class="mediaobject"><img src="../Images/image00627.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>A template task is downloaded to the working folder that is ready for you to start editing:</p><div class="mediaobject"><img src="../Images/image00628.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To upload this task to the library, run <code class="literal">tfx build tasks upload.\MyTask</code>:<div class="mediaobject"><img src="../Images/image00629.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the FabrikamTFVC CI build definition and click on <span class="strong"><strong>Edit</strong></span> to edit the build definition. Select the newly added <span class="strong"><strong>MyTask</strong></span> which shows up in the task list under the <span class="strong"><strong>Utility</strong></span> section. Include this task in the definition by clicking <span class="strong"><strong>Add</strong></span>:<div class="mediaobject"><img src="../Images/image00630.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Update the <a id="id527" class="indexterm"/>message in the <a id="id528" class="indexterm"/><span class="strong"><strong>Message</strong></span> textbox and save the changes. Queue a new build:<div class="mediaobject"><img src="../Images/image00631.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>The build successfully runs <span class="strong"><strong>MyTask</strong></span> and prints the message <code class="literal">Hurray! My First Build Task...</code> in the console output:</p><div class="mediaobject"><img src="../Images/image00632.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec146"/>How it works...</h2></div></div></div><p>On running the <code class="literal">create new task</code> command, a set of template files are downloaded. The <code class="literal">task.json</code> file contains metadata about the task. As illustrated in the following screenshot, the file contains task metadata, agent dependencies, task specific properties, and output behavior. For example, if the default category is <code class="literal">utility</code>, the category that the build task gets uploaded to can be amended by changing the value of the category:</p><div class="mediaobject"><img src="../Images/image00633.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>The other<a id="id529" class="indexterm"/> files also have their <a id="id530" class="indexterm"/>significance:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">The <code class="literal">sample.ps1</code> file contains the PowerShell build task logic that is executed when running on a Windows agent</li><li class="listitem">The <code class="literal">sample.js</code> file contains the JavaScript build task logic that is executed when running on a cross-platform agent (e.g. OS X or Linux)</li><li class="listitem">The <code class="literal">icon.png</code> file is a default icon and should be replaced with a custom 32×32 PNG file with transparencies set appropriately</li></ul></div><p>If you are looking for inspiration, all existing out-of-the-box tasks are open source and can directly be enhanced with contributions on GitHub at <a class="ulink" href="https://github.com/Microsoft/vso-agent-tasks">https://github.com/Microsoft/vso-agent-tasks</a>.</p></div></div>
<div class="section" title="Integrating SonarQube with TFBuild to manage technical debt"><div class="titlepage" id="aid-1P71O2"><div><div><h1 class="title"><a id="ch04lvl1sec53"/>Integrating SonarQube with TFBuild to manage technical debt</h1></div></div></div><p>Technical debt can be <a id="id531" class="indexterm"/>classified as the measure between the <a id="id532" class="indexterm"/>current state and an optimal state of codebases. Technical debt saps productivity by making code hard to understand, easy to break, difficult to validate, and in turn, creating unplanned work ultimately blocking the progress. Technical debt is inevitable! It starts small and grows overtime through rushed changes and lack of context and discipline. Organizations often find that more than 50% of their capacity is sapped by technical debt. As discussed in <a class="link" title="Chapter 2. Setting Up and Managing Code Repositories" href="part0027.xhtml#aid-PNV62">Chapter 2</a>, <span class="emphasis"><em>Setting Up and Managing Code Repositories</em></span>, the biggest challenge is in identifying and managing Technical Debt. SonarQube is an open source platform that is the de facto solution for understanding and managing technical debt. In this recipe, you'll learn how to integrate with SonarQube using TFBuild to analyze .NET-based applications.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec147"/>Getting ready</h2></div></div></div><p>SonarQube is an open<a id="id533" class="indexterm"/> platform for managing code quality. As such, it <a id="id534" class="indexterm"/>covers the seven axes of code quality as illustrated in the following image. Originally famous in the Java community, SonarQube now supports over 20 programming languages. The joint investments made by Microsoft and SonarSource make SonarQube easier to integrate with TFBuild and better at analyzing .NET-based applications. You can read more about the capabilities offered by SonarQube<a id="id535" class="indexterm"/> at <a class="ulink" href="http://www.sonarqube.org/resources/">http://www.sonarqube.org/resources/</a>.</p><div class="mediaobject"><img src="../Images/image00634.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>In this recipe, we'll analyze the technical debt in the FabrikamTFVC codebase using SonarQube. If you don't already have an instance of SonarQube, then set one up by following the instructions at <a class="ulink" href="https://github.com/SonarSource/sonar-.net-documentation/blob/master/doc/installation-and-configuration.md">https://github.com/SonarSource/sonar-.net-documentation/blob/master/doc/installation-and-configuration.md</a>.</p><p>To work through this recipe, you'll need the Sonar database connection string and user account details to connect to SonarQube from TFBuild. This recipe uses the single server setup described in the installation and configuration link shared earlier:</p><div class="informalexample"><pre class="programlisting">Database Connection String - jdbc:jtds:sqlserver://TFS2015:1433/Sonar;instance=SQLEXPRESS;SelectMethod=Cursor
UserName - SonarUser
Password - SonarUser</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec148"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the FabrikamTFVC CI build definition by browsing to the <span class="strong"><strong>Build</strong></span> hub in FabrikamTFVC Team Portal. Click on the <span class="strong"><strong>Edit</strong></span> hyperlink to start editing the FabrikamTFVC CI build definition.</li><li class="listitem">Add a new task by clicking on <span class="strong"><strong>Add Build</strong></span> step. From the <span class="strong"><strong>Build</strong></span> category, choose <span class="strong"><strong>SonarQube for MSBuild - Begin Analysis</strong></span> and <span class="strong"><strong>SonarQube for MSBuild - End Analysis</strong></span>:<div class="mediaobject"><img src="../Images/image00635.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Organize the <a id="id536" class="indexterm"/>begin analysis task before the Visual <a id="id537" class="indexterm"/>Studio Build task and the end analysis task after all the code build and test tasks have been executed:<div class="mediaobject"><img src="../Images/image00636.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the <span class="strong"><strong>SonarQube Begin Analysis</strong></span> task, specify the connection details of your SonarQube instance. The SonarQube endpoint needs to be mapped and added through the endpoint manager as illustrated here:<div class="mediaobject"><img src="../Images/image00637.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Endpoints<a id="id538" class="indexterm"/> provide a role-based access control model similar to the build permission model. Users and groups can directly be set up for endpoint administration and consumption through this access control model:<div class="mediaobject"><img src="../Images/image00638.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the SonarQube <a id="id539" class="indexterm"/>service endpoint and update the database settings:<div class="mediaobject"><img src="../Images/image00639.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Update the project settings as illustrated here:<div class="mediaobject"><img src="../Images/image00640.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Save the<a id="id540" class="indexterm"/> changes to the build definition and queue <a id="id541" class="indexterm"/>a new build. Using the information in the <span class="strong"><strong>SonarQube Start Analysis</strong></span> task, the build agent will connect to the SonarQube instance. It will process the code using the Sonar MSBuild runner performing .NET and JavaScript code analysis, code clone analysis, code coverage analysis, and calculating the metrics for .NET and JavaScript. These results will be published by the <span class="strong"><strong>SonarQube End Analysis</strong></span> task:<div class="mediaobject"><img src="../Images/image00641.jpeg" alt="How to do it…"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec149"/>How it works…</h2></div></div></div><p>The SonarQubeMSBuild runner is used to invoke the SonarQube analysis from TFBuild. Let's see the results of the code analysis performed by the runner. Navigate to the SonarQube Dashboard by browsing to <code class="literal">http://localhost:9000/</code>. The home page shows the <span class="strong"><strong>Fabrikam CallCenter (Main)</strong></span> project as follows:</p><div class="mediaobject"><img src="../Images/image00642.jpeg" alt="How it works…"/></div><p style="clear:both; height: 1em;"> </p><p>By drilling into the Dashboard for the <span class="strong"><strong>Fabrikam CallCenter (Main)</strong></span> project, you can see high-level metrics around various analyses:</p><div class="mediaobject"><img src="../Images/image00643.jpeg" alt="How it works…"/><div class="caption"><p>The dashboard gives you a high-level summary of analysis of code, complexity, duplications, unit test coverage, and debt analysis</p></div></div><p style="clear:both; height: 1em;"> </p><p>The issues <a id="id542" class="indexterm"/>section displays a complete list of issues found across the <a id="id543" class="indexterm"/>codebase using the .NET code analysis ruleset. The issues can be tracked, suppressed, assigned, and planned for releases right from within this view:</p><div class="mediaobject"><img src="../Images/image00644.jpeg" alt="How it works…"/><div class="caption"><p>The issues section shows a list of issues identified in the codebase during the analysis</p></div></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec150"/>There's more…</h2></div></div></div><p>The new build framework provides the ability to create custom variables. Variables provide the means to share common values across multiple fields in a build definition. Unlike values, variables can be dynamically updated during runtime. The framework also allows flagging a variable as secure, in which case its value is not displayed in the build definition not logged during the build execution. In this recipe, the SonarQube connection string and account details were passed directly in the build task. These values can instead be passed through using build variables as illustrated in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00645.jpeg" alt="There's more…"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="Building GitHub code repositories with TFBuild" id="aid-1Q5IA1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec54"/>Building GitHub code repositories with TFBuild</h1></div></div></div><p>The new build<a id="id544" class="indexterm"/> system offers seamless integration <a id="id545" class="indexterm"/>with GitHub. In this recipe, you'll learn how to use TFBuild to build a repository in GitHub.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec151"/>Getting ready</h2></div></div></div><p>If you don't already have a<a id="id546" class="indexterm"/> GitHub repository, create one from <a class="ulink" href="https://help.github.com/articles/create-a-repo">https://help.github.com/articles/create-a-repo</a>.</p><p>For the walkthrough in this recipe, we'll be using the<a id="id547" class="indexterm"/> <code class="literal">VisualStudioGeeks</code> repository available at <a class="ulink" href="https://github.com/visualstudiogeeks/">https://github.com/visualstudiogeeks/</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec152"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log into the GitHub repository from your profile menu, navigate to <span class="strong"><strong>Settings</strong></span>, and select <span class="strong"><strong>Personal access tokens</strong></span>. Click on the <span class="strong"><strong>Generate new token</strong></span> button to create a new personal access token:<div class="mediaobject"><img src="../Images/image00646.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Specify a name and select the access scope for the token. In order to trigger builds, the <code class="literal">admin:repo_hook</code> access level needs to be selected:<div class="mediaobject"><img src="../Images/image00647.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <a id="id548" class="indexterm"/><span class="strong"><strong>Generate token</strong></span><a id="id549" class="indexterm"/> button. Copy the access token and store it in a safe location. Note that you'll not be able to see this token again; should you lose it, you'll have to generate a new token:<div class="mediaobject"><img src="../Images/image00648.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Navigate to the FabrikamTFVC Team Project and browse to the <span class="strong"><strong>Build</strong></span> hub. Click on the <span class="strong"><strong>+</strong></span> icon to create a new build definition. Select the Visual Studio Template, and click on <span class="strong"><strong>OK</strong></span>. Save the build definition as <code class="literal">VisualStudioGeeks</code> CI.</li><li class="listitem">Navigate to the <span class="strong"><strong>Repository</strong></span> tab, and select <span class="strong"><strong>Repository type</strong></span> to <span class="strong"><strong>External Git</strong></span>. Enter the repository name, the URL of the repository, the username, and the personal access token to access this repository:<div class="mediaobject"><img src="../Images/image00649.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">From the <span class="strong"><strong>Triggers</strong></span> tab, select the <span class="strong"><strong>Scheduled</strong></span> option and specify the schedule for triggering the builds from this build definition. Save changes to this build definition and trigger a new build:<div class="mediaobject"><img src="../Images/image00650.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>As illustrated in the previous screenshot, the <code class="literal">Build 20151020.5</code> successfully synchronizes the code from the repository <code class="literal">VisualStudioGeeks</code>.</p></li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec153"/>How it works...</h2></div></div></div><p>The personal token<a id="id550" class="indexterm"/> generated for the Visual Studio <a id="id551" class="indexterm"/>Geeks repository with scope <code class="literal">admin:repo_hook</code> provides full control over the repository hooks. This access permits the listener to subscribe to the commit event generated when the code changes are committed to the repository. While TFBuild provides the capability to build GitHub repositories in TFS 2015, it does not allow the continuous integration flow yet. As indicated in the TFS feature timeline, continuous integration build workflow is expected to be introduced in a future update of TFS 2015: <a class="ulink" href="https://www.visualstudio.com/en-us/news/release-archive-vso.aspx">https://www.visualstudio.com/en-us/news/release-archive-vso.aspx</a>.</p></div></div></body></html>