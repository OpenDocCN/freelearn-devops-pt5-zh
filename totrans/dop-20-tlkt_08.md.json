["```\nvagrant up cd serv-disc-01 --provision\nvagrant ssh serv-disc-01\n\n```", "```\ncurl -L https://github.com/coreos/etcd/releases/\\\ndownload/v2.1.2/etcd-v2.1.2-linux-amd64.tar.gz \\\n    -o etcd-v2.1.2-linux-amd64.tar.gz\ntar xzf etcd-v2.1.2-linux-amd64.tar.gz\nsudo mv etcd-v2.1.2-linux-amd64/etcd* /usr/local/bin\nrm -rf etcd-v2.1.2-linux-amd64*\netcd >/tmp/etcd.log 2>&1 &\n```", "```\netcdctl set myService/port \"1234\"\netcdctl set myService/ip \"1.2.3.4\"\netcdctl get myService/port # Outputs: 1234\netcdctl get myService/ip # Outputs: 1.2.3.4\n```", "```\netcdctl ls myService\netcdctl rm myService/port\netcdctl ls myService\n```", "```\nsudo apt-get install -y jq\n\n```", "```\ncurl http://localhost:2379/v2/keys/myService/newPort \\\n  -X PUT \\\n  -d value=\"4321\" | jq '.'\ncurl http://localhost:2379/v2/keys/myService/newPort \\\n  | jq '.'\n```", "```\n{\n    \"action\": \"set\",\n    \"node\": {\n        \"createdIndex\": 16,\n        \"key\": \"/myService/newPort\",\n        \"modifiedIndex\": 16,\n        \"value\": \"4321\"\n    }\n}\n{\n    \"action\": \"get\",\n    \"node\": {\n        \"createdIndex\": 16,\n        \"key\": \"/myService/newPort\",\n        \"modifiedIndex\": 16,\n        \"value\": \"4321\"\n    }\n}\n```", "```\nNODE_NAME=serv-disc-0$NODE_NUMBER\nNODE_IP=10.100.197.20$NODE_NUMBER\nNODE_01_ADDRESS=http://10.100.197.201:2380\nNODE_01_NAME=serv-disc-01\nNODE_01=\"$NODE_01_NAME=$NODE_01_ADDRESS\"\nNODE_02_ADDRESS=http://10.100.197.202:2380\nNODE_02_NAME=serv-disc-02\nNODE_02=\"$NODE_02_NAME=$NODE_02_ADDRESS\"\nNODE_03_ADDRESS=http://10.100.197.203:2380\nNODE_03_NAME=serv-disc-03\nNODE_03=\"$NODE_03_NAME=$NODE_03_ADDRESS\"\nCLUSTER_TOKEN=serv-disc-cluster\netcd -name serv-disc-1 \\\n -initial-advertise-peer-urls http://$NODE_IP:2380 \\\n -listen-peer-urls http://$NODE_IP:2380 \\\n -listen-client-urls \\\n http://$NODE_IP:2379,http://127.0.0.1:2379 \\\n -advertise-client-urls http://$NODE_IP:2379 \\\n -initial-cluster-token $CLUSTER_TOKEN \\\n -initial-cluster \\\n $NODE_01,$NODE_02,$NODE_03 \\\n -initial-cluster-state new\n\n```", "```\npkill etcd\nexit\nvagrant up serv-disc-02 serv-disc-03\n\n```", "```\n- name: Files are copied\n copy:\n src: \"{{ item.src }}\"\n dest: \"{{ item.dest }}\"\n mode: 0755\n with_items: files\n tags: [etcd]\n\n```", "```\nfiles: [\n  {src: 'etcd', dest: '/usr/local/bin/etcd'},\n  {src: 'etcdctl', dest: '/usr/local/bin/etcdctl'}\n]\n```", "```\n- name: Is running\n  shell: \"nohup etcd -name {{ ansible_hostname }} \\\n    -initial-advertise-peer-urls \\\n    http://{{ ip }}:2380 \\\n    -listen-peer-urls \\\n    http://{{ ip }}:2380 \\\n    -listen-client-urls \\\n    http://{{ ip }}:2379,http://127.0.0.1:2379 \\\n    -advertise-client-urls \\\n    http://{{ ip }}:2379 \\\n    -initial-cluster-token {{ cl_token }} \\\n    -initial-cluster \\\n    {{ cl_node_01 }},{{ cl_node_02 }},{{ cl_node_03 }} \\\n    -initial-cluster-state new \\\n    >/var/log/etcd.log 2>&1 &\"\n  tags: [etcd]\n```", "```\n- hosts: etcd\n remote_user: vagrant\n serial: 1\n sudo: yes\n roles:\n - common\n - etcd\n\n```", "```\n[etcd]\n10.100.194.20[1:3]\n\n```", "```\nvagrant ssh cd\nansible-playbook \\/vagrant/ansible/etcd.yml \\\n    -i /vagrant/ansible/hosts/serv-disc\n```", "```\ncurl http://serv-disc-01:2379/v2/keys/test \\\n  -X PUT \\\n  -d value=\"works\" | jq '.'\ncurl http://serv-disc-03:2379/v2/keys/test \\\n  | jq '.'\n```", "```\n{\n    \"action\": \"set\",\n    \"node\": {\n        \"createdIndex\": 8,\n        \"key\": \"/test\",\n        \"modifiedIndex\": 8,\n        \"value\": \"works\"\n    }\n}\n{\n    \"action\": \"get\",\n    \"node\": {\n        \"createdIndex\": 8,\n        \"key\": \"/test\",\n        \"modifiedIndex\": 8,\n        \"value\": \"works\"\n    }\n}\n```", "```\ndocker run -d --name registrator \\\n    -v /var/run/docker.sock:/tmp/docker.sock \\\n    -h serv-disc-01 \\\n    gliderlabs/registrator \\\n    -ip 10.100.194.201 etcd://10.100.194.201:2379\n```", "```\n- name: Container is running\n  docker:\n    name: \"{{ registrator_name }}\"\n    image: gliderlabs/registrator\n    volumes:\n      - /var/run/docker.sock:/tmp/docker.sock\n    hostname: \"{{ ansible_hostname }}\"\n    command: -ip {{ facter_ipaddress_eth1 }} {{ registrator_protocol }}://{{ facter_ipaddress_eth1 }}:2379\n  tags: [etcd]\n```", "```\n- hosts: all\n  remote_user: vagrant\n  serial: 1\n  sudo: yes\n  vars:\n    - registrator_protocol: etcd\n    - registrator_port: 2379\n  roles:\n    - common\n    - docker\n    - etcd\n    - registrator\n```", "```\nansible-playbook \\\n    /vagrant/ansible/registrator-etcd.yml \\\n    -i /vagrant/ansible/hosts/serv-disc\n```", "```\nexport DOCKER_HOST=tcp://serv-disc-02:2375\ndocker run -d --name nginx \\\n    --env SERVICE_NAME=nginx \\\n    --env SERVICE_ID=nginx \\\n    -p 1234:80 \\\n    nginx\n```", "```\ndocker logs registrator\n\n```", "```\n2015/08/30 19:18:12 added: 5cf7dd974939 nginx\n2015/08/30 19:18:12 ignored: 5cf7dd974939 port 443 not published on host\n\n```", "```\ncurl http://serv-disc-01:2379/v2/keys/ | jq '.'\ncurl http://serv-disc-01:2379/v2/keys/nginx-80/ | jq '.'\ncurl http://serv-disc-01:2379/v2/keys/nginx-80/nginx | jq '.'\n\n```", "```\n{\n  \"node\": {\n    \"createdIndex\": 13,\n    \"modifiedIndex\": 13,\n    \"value\": \"10.100.194.202:1234\",\n    \"key\": \"/nginx-80/nginx\"\n  },\n  \"action\": \"get\"\n}\n```", "```\ndocker rm -f nginx\ndocker logs registrator\n\n```", "```\n...\n2015/08/30 19:32:31 removed: 5cf7dd974939 nginx\n\n```", "```\ncurl http://serv-disc-01:2379/v2/keys/nginx-80/nginx | jq '.'\n\n```", "```\n{\n  \"index\": 14,\n  \"cause\": \"/nginx-80/nginx\",\n  \"message\": \"Key not found\",\n  \"errorCode\": 100\n}\n```", "```\nwget https://github.com/kelseyhightower/confd/releases\\/download/v0.10.0/confd-0.10.0-linux-amd64\nsudo mv confd-0.10.0-linux-amd64 /usr/local/bin/confd\nsudo chmod 755 /usr/local/bin/confd\nsudo mkdir -p /etc/confd/{conf.d,templates}\n\n```", "```\n[template]\nsrc = \"nginx.conf.tmpl\"\ndest = \"/tmp/nginx.conf\"\nkeys = [\n    \"/nginx/nginx\"\n]\n```", "```\nThe address is {{getv \"/nginx/nginx\"}};\n\n```", "```\nconfd -onetime -backend etcd -node 10.100.197.202:2379\n\n```", "```\n- name: Directories are created\n file:\n path: \"{{ item }}\"\n state: directory\n with_items: directories\n tags: [confd]\n- name: Files are copied\n copy:\n src: \"{{ item.src }}\"\n dest: \"{{ item.dest }}\"\n mode: \"{{ item.mode }}\"\n with_items: files\n tags: [confd]\n\n```", "```\ndirectories:\n  - /etc/confd/conf.d\n  - /etc/confd/templates\n\nfiles: [\n  { src: 'example.toml', dest: '/etc/confd/conf.d/example.toml', mode: '0644' },\n  { src: 'example.conf.tmpl', dest: '/etc/confd/templates/example.conf.tmpl', mode: '0644' },\n  { src: 'confd', dest: '/usr/local/bin/confd', mode: '0755' }\n]\n```", "```\n- hosts: confd\n remote_user: vagrant\n serial: 1\n sudo: yes\n roles:\n - common\n - confd\n\n```", "```\nansible-playbook \\\n /vagrant/ansible/confd.yml \\\n -i /vagrant/ansible/hosts/serv-disc\n\n```", "```\nexport DOCKER_HOST=tcp://serv-disc-01:2375\n\ndocker run -d --name nginx \\\n    --env SERVICE_NAME=nginx \\\n    --env SERVICE_ID=nginx \\\n    -p 4321:80 \\\n    Nginx\nconfd -onetime -backend etcd -node 10.100.194.203:2379\n```", "```\ncd confd[15241]: INFO Backend set to etcd\ncd confd[15241]: INFO Starting confd\ncd confd[15241]: INFO Backend nodes set to 10.100.194.203:2379\ncd confd[15241]: INFO Target config /tmp/example.conf out of sync\ncd confd[15241]: INFO Target config /tmp/example.conf has been updated\n\n```", "```\ncat /tmp/example.conf\n\n```", "```\nThe address is 10.100.194.201:4321\n\n```", "```\nsudo apt-get install -y unzip\nwget https://releases.hashicorp.com/consul/0.6.4/consul_0.6.4_linux_amd64.zip\nunzip consul_0.6.4_linux_amd64.zip\nsudo mv consul /usr/local/bin/consul\nrm -f consul_0.6.4_linux_amd64.zip\nsudo mkdir -p /data/consul/{data,config,ui}\n\n```", "```\nsudo consul agent \\\n -server \\\n -bootstrap-expect 1 \\\n -data-dir /data/consul/data \\\n -config-dir /data/consul/config \\\n -node=cd \\\n -bind=10.100.198.200 \\\n -client=0.0.0.0 \\\n -ui \\\n >/tmp/consul.log &\n\n```", "```\ncat /tmp/consul.log\n\n```", "```\n==> Starting Consul agent...\n==> Starting Consul agent RPC...\n==> Consul agent running!\n Node name: 'cd'\n Datacenter: 'dc1'\n Server: true (bootstrap: true)\n Client Addr: 0.0.0.0 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)\n Cluster Addr: 10.100.198.200 (LAN: 8301, WAN: 8302)\n Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false\n Atlas: <disabled>\n==> Log data will now stream in as it occurs:\n[INFO] serf: EventMemberJoin: cd 10.100.198.200\n[INFO] serf: EventMemberJoin: cd.dc1 10.100.198.200\n[INFO] raft: Node at 10.100.198.200:8300 [Follower] entering Follower state\n[WARN] serf: Failed to re-join any previously known node\n[INFO] consul: adding LAN server cd (Addr: 10.100.198.200:8300) (DC: dc1)\n[WARN] serf: Failed to re-join any previously known node\n[INFO] consul: adding WAN server cd.dc1 (Addr: 10.100.198.200:8300) (DC: dc1)\n[ERR] agent: failed to sync remote state: No cluster leader\n[WARN] raft: Heartbeat timeout reached, starting election\n[INFO] raft: Node at 10.100.198.200:8300 [Candidate] entering Candidate state\n[INFO] raft: Election won. Tally: 1\n[INFO] raft: Node at 10.100.198.200:8300 [Leader] entering Leader state\n[INFO] consul: cluster leadership acquired\n[INFO] consul: New leader elected: cd\n[INFO] raft: Disabling EnableSingleNode (bootstrap)\n\n```", "```\ncurl -X PUT -d 'this is a test' \\\n http://localhost:8500/v1/kv/msg1\ncurl -X PUT -d 'this is another test' \\\n http://localhost:8500/v1/kv/messages/msg2\ncurl -X PUT -d 'this is a test with flags' \\\n http://localhost:8500/v1/kv/messages/msg3?flags=1234\n\n```", "```\ncurl http://localhost:8500/v1/kv/?recurse \\\n | jq '.'\n\n```", "```\n[\n    {\n        \"CreateIndex\": 141,\n        \"Flags\": 0,\n        \"Key\": \"messages/msg2\",\n        \"LockIndex\": 0,\n        \"ModifyIndex\": 141,\n        \"Value\": \"dGhpcyBpcyBhbm90aGVyIHRlc3Q=\"\n    },\n    {\n        \"CreateIndex\": 142,\n        \"Flags\": 1234,\n        \"Key\": \"messages/msg3\",\n        \"LockIndex\": 0,\n        \"ModifyIndex\": 147,\n        \"Value\": \"dGhpcyBpcyBhIHRlc3Qgd2l0aCBmbGFncw==\"\n    },\n    {\n        \"CreateIndex\": 140,\n        \"Flags\": 0,\n        \"Key\": \"msg1\",\n        \"LockIndex\": 0,\n        \"ModifyIndex\": 140,\n        \"Value\": \"dGhpcyBpcyBhIHRlc3Q=\"\n    }\n]\n```", "```\ncurl http://localhost:8500/v1/kv/msg1 \\\n | jq '.'\n\n```", "```\n[\n    {\n        \"CreateIndex\": 140,\n        \"Flags\": 0,\n        \"Key\": \"msg1\",\n        \"LockIndex\": 0,\n        \"ModifyIndex\": 140,\n        \"Value\": \"dGhpcyBpcyBhIHRlc3Q=\"\n    }\n]\n```", "```\ncurl http://localhost:8500/v1/kv/msg1?raw\n\n```", "```\nthis is a test\n\n```", "```\ncurl -X DELETE http://localhost:8500/v1/kv/messages/msg2\n\n```", "```\ncurl -X DELETE http://localhost:8500/v1/kv/?recurse\n\n```", "```\nsudo consul agent \\\n -data-dir /data/consul/data \\\n -config-dir /data/consul/config \\\n -node=serv-disc-02 \\\n -bind=10.100.197.202 \\\n -client=0.0.0.0 \\\n >/tmp/consul.log &\n\n```", "```\nconsul join 10.100.198.200\n\n```", "```\n- name: Directories are created\n  file:\n    path: \"{{ item }}\"\n    state: directory\n  with_items: directories\n  tags: [consul]\n- name: Files are copied\n  copy:\n    src: \"{{ item.src }}\"\n    dest: \"{{ item.dest }}\"\n    mode: \"{{ item.mode }}\"\n  with_items: files\n  tags: [consul]\n```", "```\nlogs_dir: /data/consul/logs\ndirectories:\n  - /data/consul/data\n  - /data/consul/config\n  - \"{{ logs_dir }}\"\nfiles: [\n  { src: 'consul', dest: '/usr/local/bin/consul', mode: '0755' },\n  { src: 'ui', dest: '/data/consul', mode: '0644' }\n]\n```", "```\n- name: Is running\n shell: \"nohup consul agent {{ consul_extra }} \\\n -data-dir /data/consul/data \\\n -config-dir /data/consul/config \\\n -node={{ ansible_hostname }} \\\n -bind={{ ip }} \\\n -client=0.0.0.0 \\\n >{{ logs_dir }}/consul.log 2>&1 &\"\n tags: [consul]\n\n```", "```\n[consul]\n10.100.194.201 consul_extra=\"-server -bootstrap\"\n10.100.194.20[2:3] consul_server_ip=\"10.100.194.201\"\n\n```", "```\n- name: Has joined\n  shell: consul join {{ consul_server_ip }}\n  when: consul_server_ip is defined\n  tags: [consul]\n```", "```\n- hosts: consul\n remote_user: vagrant\n serial: 1\n sudo: yes\n roles:\n - common\n - consul\n\n```", "```\nansible-playbook \\\n /vagrant/ansible/consul.yml \\\n -i /vagrant/ansible/hosts/serv-disc\n\n```", "```\ncurl serv-disc-01:8500/v1/catalog/nodes \\\n | jq '.'\n\n```", "```\n[\n    {\n        \"Address\": \"10.100.194.201\",\n        \"Node\": \"serv-disc-01\"\n    },\n    {\n        \"Address\": \"10.100.194.202\",\n        \"Node\": \"serv-disc-02\"\n    },\n    {\n        \"Address\": \"10.100.194.203\",\n        \"Node\": \"serv-disc-03\"\n    }\n]\n```", "```\nexport DOCKER_HOST=tcp://serv-disc-01:2375\ndocker run -d --name registrator-consul-kv \\\n -v /var/run/docker.sock:/tmp/docker.sock \\\n -h serv-disc-01 \\\n gliderlabs/registrator \\\n -ip 10.100.194.201 consulkv://10.100.194.201:8500/services\n\n```", "```\ndocker logs registrator-consul-kv\n\n```", "```\nStarting registrator v6 ...\nForcing host IP to 10.100.194.201\nconsulkv: current leader  10.100.194.201:8300\nUsing consulkv adapter: consulkv://10.100.194.201:8500/services\nListening for Docker events ...\nSyncing services on 1 containers\nignored: 19c952849ac2 no published ports\nignored: 46267b399098 port 443 not published on host\nadded: 46267b399098 nginx\n\n```", "```\ncurl http://serv-disc-01:8500/v1/kv/services/nginx/nginx?raw\n\n```", "```\n10.100.194.201:4321\n\n```", "```\ndocker run -d --name registrator-consul \\\n -v /var/run/docker.sock:/tmp/docker.sock \\\n -h serv-disc-01 \\\n gliderlabs/registrator \\\n -ip 10.100.194.201 consul://10.100.194.201:8500\n\n```", "```\ncurl http://serv-disc-01:8500/v1/catalog/service/nginx-80 | jq '.'\n\n```", "```\n[\n  {\n    \"ModifyIndex\": 185,\n    \"CreateIndex\": 185,\n    \"Node\": \"serv-disc-01\",\n    \"Address\": \"10.100.194.201\",\n    \"ServiceID\": \"nginx\",\n    \"ServiceName\": \"nginx-80\",\n    \"ServiceTags\": [],\n    \"ServiceAddress\": \"10.100.194.201\",\n    \"ServicePort\": 4321,\n    \"ServiceEnableTagOverride\": false\n  }\n]\n```", "```\ndocker run -d --name nginx2 \\\n --env \"SERVICE_ID=nginx2\" \\\n --env \"SERVICE_NAME=nginx\" \\\n --env \"SERVICE_TAGS=balancer,proxy,www\" \\\n -p 1111:80 \\\n nginx\ncurl http://serv-disc-01:8500/v1/catalog/service/nginx-80 | jq '.'\n\n```", "```\n[\n  {\n    \"ModifyIndex\": 185,\n    \"CreateIndex\": 185,\n    \"Node\": \"serv-disc-01\",\n    \"Address\": \"10.100.194.201\",\n    \"ServiceID\": \"nginx\",\n    \"ServiceName\": \"nginx\",\n    \"ServiceTags\": [],\n    \"ServiceAddress\": \"10.100.194.201\",\n    \"ServicePort\": 4321,\n    \"ServiceEnableTagOverride\": false\n  },\n  {\n    \"ModifyIndex\": 202,\n    \"CreateIndex\": 202,\n    \"Node\": \"serv-disc-01\",\n    \"Address\": \"10.100.194.201\",\n    \"ServiceID\": \"nginx2\",\n    \"ServiceName\": \"nginx\",\n    \"ServiceTags\": [\n      \"balancer\",\n      \"proxy\",\n      \"www\"\n    ],\n    \"ServiceAddress\": \"10.100.194.201\",\n    \"ServicePort\": 1111,\n    \"ServiceEnableTagOverride\": false\n  }\n]\n```", "```\n- hosts: registrator\n remote_user: vagrant\n serial: 1\n sudo: yes\n vars:\n - registrator_name: registrator-c\nonsul\n docker\n - consul\n - registrator\n\n```", "```\nansible-playbook \\\n /vagrant/ansible/registrator.yml \\\n -i /vagrant/ansible/hosts/serv-disc\n\n```", "```\nwget https://releases.hashicorp.com/consul-template/0.12.0/\\\nconsul-template_0.12.0_linux_amd64.zip\nsudo apt-get install -y unzip\nunzip consul-template_0.12.0_linux_amd64.zip\nsudo mv consul-template /usr/local/bin\nrm -rf consul-template_0.12.0_linux_amd64*\n\n```", "```\necho '\n{{range service \"nginx-80\"}}\nThe address is {{.Address}}:{{.Port}}\n{{end}}\n' >/tmp/nginx.ctmpl\n\n```", "```\ncurl http://serv-disc-01:8500/v1/catalog/service/nginx-80 | jq '.'\n\n```", "```\n[\n  {\n    \"ModifyIndex\": 185,\n    \"CreateIndex\": 185,\n    \"Node\": \"serv-disc-01\",\n    \"Address\": \"10.100.194.201\",\n    \"ServiceID\": \"nginx\",\n    \"ServiceName\": \"nginx-80\",\n    \"ServiceTags\": [],\n    \"ServiceAddress\": \"10.100.194.201\",\n    \"ServicePort\": 4321,\n    \"ServiceEnableTagOverride\": false\n  },\n  {\n    \"ModifyIndex\": 202,\n    \"CreateIndex\": 202,\n    \"Node\": \"serv-disc-01\",\n    \"Address\": \"10.100.194.201\",\n    \"ServiceID\": \"nginx2\",\n    \"ServiceName\": \"nginx-80\",\n    \"ServiceTags\": [\n      \"balancer\",\n      \"proxy\",\n      \"www\"\n    ],\n    \"ServiceAddress\": \"10.100.194.201\",\n    \"ServicePort\": 1111,\n    \"ServiceEnableTagOverride\": false\n  }\n]\n```", "```\nconsul-template \\\n -consul serv-disc-01:8500 \\\n -template \"/tmp/nginx.ctmpl:/tmp/nginx.conf\" \\\n -once\ncat /tmp/nginx.conf\n\n```", "```\nThe address is 10.100.194.201:4321\nThe address is 10.100.194.201:1111\n\n```", "```\n- name: Directory is created\n file:\n path: /data/consul-template\n state: directory\n tags: [consul-template]\n- name: File is copied\n copy:\n src: consul-template\n dest: /usr/local/bin/consul-template\n mode: 0755\n tags: [consul-template]\n\n```", "```\n- hosts: consul-template\n remote_user: vagrant\n serial: 1\n sudo: yes\n roles:\n - common\n - consul-template\n\n```", "```\nansible-playbook \\\n /vagrant/ansible/consul-template.yml \\\n -i /vagrant/ansible/hosts/serv-disc\n\n```", "```\nexit\nvagrant destroy -f\n\n```"]