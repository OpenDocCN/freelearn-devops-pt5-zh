<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Deploying Multi-Tier Applications Using Templates</h1>
                
            
            <article>
                
<p class="calibre2">Previously, you learned how to run a standalone container in OpenShift. In the real world, almost all applications are composed of multiple interconnected containers. For example, the WordPress container requires access to a database instance. OpenShift provides a facility that lets you pack everything related to your application into a single object, called a <em class="calibre17">template, </em>and deploy everything at once by processing that template. The basic template concept was explained in <a target="_blank" href="part0195.html#5PUTM0-78aafb146b304cdeb9b3261a70edabde" class="calibre8">Chapter 9</a>, <em class="calibre17">Advanced OpenShift Concepts</em>, and it is very similar to Docker Compose. This chapter will be a hands-on lab experiment, illustrating how to use OpenShift templates to deploy applications. <span class="calibre11">The upcoming labs will show you, in detail, how to create a multi-tier application from scratch.</span></p>
<p class="calibre2">In this chapter, we will cover the following topics:</p>
<p class="calibre2"/>
<ul class="calibre9">
<li class="calibre10">An OpenShift template overview</li>
<li class="calibre10">Creating a custom template</li>
<li class="calibre10">Using templates to deploy applications</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Technical requirements</h1>
                
            
            <article>
                
<p class="calibre2">This chapter doesn't have strict environmental restrictions; any OpenShift installations and development environments are supported: MinitShift, <kbd class="calibre12">oc cluster up</kbd>, or standard production-ready deployment based on Ansible. It is up to you which flavor you use. However, this chapter is based on the <kbd class="calibre12">oc cluster up</kbd> running within vagrant. The following <kbd class="calibre12">Vagrantfile</kbd> can be used to deploy the lab:</p>
<pre class="calibre18"><strong class="calibre1">$ cat Vagrantfile</strong><br class="title-page-name"/>Vagrant.configure(2) do |config| <br class="title-page-name"/>  config.vm.define "openshift" do |conf| <br class="title-page-name"/>    conf.vm.box = "centos/7" <br class="title-page-name"/>    conf.vm.network "private_network", ip: "172.24.0.11" <br class="title-page-name"/>    conf.vm.hostname = 'openshift.example.com' <br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 80, host: 1080<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 443, host: 9443<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 8080, host: 8080<br class="title-page-name"/>    conf.vm.network "forwarded_port", guest: 8443, host: 8443<br class="title-page-name"/>    conf.vm.provider "virtualbox" do |v| <br class="title-page-name"/>      v.memory = 4096 <br class="title-page-name"/>      v.cpus = 2 <br class="title-page-name"/>    end<br class="title-page-name"/>    conf.vm.provision "shell", inline: $lab_main <br class="title-page-name"/>  end <br class="title-page-name"/>end<br class="title-page-name"/>$lab_main = &lt;&lt;SCRIPT<br class="title-page-name"/>cat &lt;&lt;EOF &gt;&gt; /etc/hosts<br class="title-page-name"/>172.24.0.11 openshift.example.com openshift<br class="title-page-name"/>172.24.0.12 storage.example.com storage nfs<br class="title-page-name"/>EOF<br class="title-page-name"/>systemctl disable firewalld<br class="title-page-name"/>systemctl stop firewalld<br class="title-page-name"/>yum update -y<br class="title-page-name"/>yum install -y epel-release<br class="title-page-name"/>yum install -y docker<br class="title-page-name"/>cat &lt;&lt; EOF &gt;/etc/docker/daemon.json<br class="title-page-name"/>{<br class="title-page-name"/>   "insecure-registries": [<br class="title-page-name"/>     "172.30.0.0/16"<br class="title-page-name"/>   ]<br class="title-page-name"/>}<br class="title-page-name"/>EOF<br class="title-page-name"/>systemctl restart docker<br class="title-page-name"/>systemctl enable docker<br class="title-page-name"/>yum -y install centos-release-openshift-origin39<br class="title-page-name"/>yum -y install origin-clients<br class="title-page-name"/>oc cluster up<br class="title-page-name"/>SCRIPT</pre>
<p class="calibre2">The environment can be deployed as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ vagrant up</strong></pre>
<p class="calibre2">Once the previously listed vagrant machine is deployed, you may connect to it as follows:</p>
<pre class="calibre18"><strong class="calibre1">$ vagrant ssh<br class="title-page-name"/>$ sudo -i<br class="title-page-name"/>#</strong></pre>
<p class="calibre2">Finally, log in as a <kbd class="calibre12">developer</kbd> user in order to be able to run most commands:</p>
<pre class="calibre18"><strong class="calibre1"># oc login -u developer</strong><br class="title-page-name"/>Server [https://localhost:8443]:<br class="title-page-name"/>The server uses a certificate signed by an unknown authority.<br class="title-page-name"/>You can bypass the certificate check, but any data you send to the server could be intercepted by others.<br class="title-page-name"/>Use insecure connections? (y/n): <strong class="calibre1">y</strong><br class="title-page-name"/><br class="title-page-name"/>Authentication required for https://localhost:8443 (openshift)<br class="title-page-name"/>Username: <strong class="calibre1">developer</strong><br class="title-page-name"/>Password: <strong class="calibre1">&lt;ANY PASSWORD&gt;</strong><br class="title-page-name"/>Login successful.<br class="title-page-name"/><br class="title-page-name"/>You have one project on this server: "myproject"<br class="title-page-name"/><br class="title-page-name"/>Using project "myproject".<br class="title-page-name"/>Welcome! See 'oc help' to get started.</pre>
<div class="packt_infobox">We can use any password, as OpenShift uses the <kbd class="calibre26">AllowAll</kbd> identity provider by default.</div>
<p class="calibre2">Some of the lab items will require a custom DNS record, which can be simulated by setting a record in <kbd class="calibre12">/etc/hosts</kbd>. Both methods are acceptable.</p>
<p class="calibre2">It is also assumed that you have a web browser, such as Mozilla Firefox or Google Chrome.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">OpenShift template overview</h1>
                
            
            <article>
                
<p class="calibre2">An OpenShift template is a set of API resources that can be parameterized and processed to produce a list of objects for creation by OpenShift. A template can be processed to create any desired OpenShift objects (such as deployment configurations, build configurations, and so on). A template can also define a set of<span class="calibre11"> </span>labels<span class="calibre11"> </span>to apply to every object defined in the template. <span class="calibre11">You can apply a template</span><span class="calibre11"> by </span><span class="calibre11">using the CLI</span><span class="calibre11"> </span><span class="calibre11">or the web console. </span><span class="calibre11">For example, a template might contain two pods (an application and a database), a service, and a route. Once the template has been developed, you can reuse it.</span></p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Template syntax</h1>
                
            
            <article>
                
<p class="calibre2">Templates, like any other OpenShift resources, can be created from a raw YAML or JSON definition. An example is as follows:</p>
<pre class="calibre18"><strong class="calibre1"># cat </strong><strong class="calibre1">mytemplate.yaml</strong><br class="title-page-name"/>apiVersion: v1
kind: Template 
metadata:
  name: template1
objects: 
- apiVersion: v1
  kind: Pod
  metadata:
    name: app1
  spec:
    containers:
    - env:
      - name: SHOW_DATA
        value: ${SHOW_DATA} 
      image: example/appimage
      name: app1
      ports:
      - containerPort: 8080
        protocol: TCP
parameters: 
- description: Myapp configuration data
  name: SHOW_DATA
  required: true
labels: 
  mylabel: app1</pre>
<p class="calibre2">The preceding example includes only one resource—a pod named <kbd class="calibre12">app1</kbd>. It also includes a parameter—<kbd class="calibre12">SHOW_DATA</kbd>. Parameters can be used to customize application deployment and accommodate all kinds of use cases.</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">Parameters can also have the following default values: </p>
<pre class="calibre18">parameters: 
- description: Myapp configuration data
  name: SHOW_DATA
  required: true<br class="title-page-name"/>  value: Example value</pre>
<p class="calibre2">In some cases, we may want to generate values according to a certain pattern, as shown here:</p>
<pre class="calibre18"><span>parameters</span><span>:<br class="title-page-name"/>  - </span><span>description: Password used for Redis authentication<br class="title-page-name"/></span><span>    from</span><span>: </span><span>'[A-Z0-9]{8}'<br class="title-page-name"/></span><span>    generate</span><span>: </span><span>expression<br class="title-page-name"/></span><span>    name</span><span>: </span><span>REDIS_PASSWORD</span></pre>
<div class="title-page-name">
<p class="calibre2">In the preceding example, instantiating the template will generate a random password, eight characters long, consisting of all upper and lowercase alphabet letters, as well as numbers. <span class="calibre11">Although that syntax is highly reminiscent of regular expressions, it implements only a small subset of <strong class="calibre4">Perl Compatible Regular Expressions</strong></span> (<span class="calibre11"><strong class="calibre4">PCRE</strong></span>), <span class="calibre11">so you can still</span> use the<span class="calibre11"> <kbd class="calibre12">\w</kbd>, <kbd class="calibre12">\d</kbd>, and <kbd class="calibre12">\a</kbd> modifiers:</span></p>
</div>
<ul class="calibre9">
<li class="calibre10"><kbd class="calibre12">[w]{10}</kbd>: This expands to 10 alphabet characters, numbers, and underscores. This follows the PCRE standard and is the same as <kbd class="calibre12">[a-zA-Z0-9_]{10}</kbd>.</li>
<li class="calibre10"><span><kbd class="calibre12">[\d]{10}</kbd>: This expands to 10 numbers. This is the same as</span><span> <kbd class="calibre12">[0-9]{10}</kbd>.</span></li>
<li class="calibre10"><span> </span><kbd class="calibre12">[\a]{10}</kbd><span>: This expands to 10 alphabetical characters. This is the same as</span> <kbd class="calibre12">[a-zA-Z]{10}</kbd>.</li>
</ul>
<p class="calibre2">This capability is very useful for generating random passwords.</p>
<div class="packt_infobox">It's important to understand that the process of parameter expansion takes place when resources are being created from the template, not when the template itself is created; so, each generated resource gets its own unique value.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Adding templates</h1>
                
            
            <article>
                
<p class="calibre2">Once a template is developed, it can be added to OpenShift like any other YAML or JSON-defined objects, using the <kbd class="calibre12">oc create</kbd> command. It is a common practice to use a separate tenant specifically for templates<span class="calibre11">,</span> which will be shared between multiple projects. A default installation of the Red Hat <strong class="calibre4">OpenShift Container Platform</strong> (<strong class="calibre4">OCP</strong>) provides a number of templates in the<span class="calibre11"> <kbd class="calibre12">openshift</kbd> project. </span>All of an OpenShift cluster's users have read access to the project, but only the cluster admin is able to modify or create templates in the project.</p>
<p class="calibre2">The following example shows how to add a template to your current project:</p>
<pre class="calibre18"><strong class="calibre1"># oc create -f mytemplate.yaml</strong><br class="title-page-name"/>template "template1" created<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1"># oc get template</strong><br class="title-page-name"/>NAME        DESCRIPTION    PARAMETERS    OBJECTS<br class="title-page-name"/>template1                  1 (1 blank)   1</pre>
<p class="calibre2">You will need to become the <kbd class="calibre12">system:admin</kbd> user to create a template in the <kbd class="calibre12">openshift</kbd> tenant:</p>
<pre class="calibre18"><strong class="calibre1"># oc login -u system:admin<br class="title-page-name"/></strong><br class="title-page-name"/><strong class="calibre1"># oc create -f mytemplate.json -n openshift</strong><br class="title-page-name"/>template "template1" created<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1"># oc get template -n openshift|grep temp</strong><br class="title-page-name"/>template1</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Displaying template parameters</h1>
                
            
            <article>
                
<p class="calibre2">The OpenShift community has developed many useful OpenShift templates, to deploy a number of well-known services. Once the template is determined, you will need to understand which parameters it accepts.</p>
<p class="calibre2">There are a couple of ways to list all of the parameters:</p>
<ul class="calibre9">
<li class="calibre10">Using the <kbd class="calibre12">oc process --parameters</kbd><span> </span>command (this is the easiest one)</li>
<li class="calibre10">Looking for the <kbd class="calibre12">parameters</kbd> section in the template's definition</li>
</ul>
<p class="calibre2">Among many others, the OpenShift default installation comes with the <kbd class="calibre12">mariadb-persistent</kbd> template, as shown here:</p>
<pre class="calibre18"><strong class="calibre1"># oc get template mariadb-persistent -n openshift</strong><br class="title-page-name"/>NAME  DESCRIPTION  PARAMETERS OBJECTS<br class="title-page-name"/>mariadb-persistent MariaDB database service, with persistent storage. For more information about... 8 (3 generated) 4</pre>
<p class="calibre2">That template has a number of parameters, listed as follows:</p>
<pre class="calibre18"><strong class="calibre1"># oc process --parameters -n openshift mariadb-persistent</strong><br class="title-page-name"/>NAME DESCRIPTION GENERATOR VALUE<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>VOLUME_CAPACITY Volume space available for data, e.g. 512Mi, 2Gi. 1Gi</pre>
<p class="calibre2">If you don't want to import the template into OpenShift, the same method allows you to display the parameters of a locally stored OpenShift template:</p>
<pre class="calibre18"><strong class="calibre1"># oc process --parameters -f </strong>mytemplate.yaml<br class="title-page-name"/>NAME        DESCRIPTION  GENERATOR    VALUE<br class="title-page-name"/>SHOW_DATA   Myapp configuration data</pre>
<p class="calibre2">Another method is to use the <kbd class="calibre12">oc describe</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1"># oc describe template template1</strong><br class="title-page-name"/>Name:        template1<br class="title-page-name"/>Namespace:    myproject<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>Parameters:<br class="title-page-name"/>    Name:        SHOW_DATA<br class="title-page-name"/>    Description:    Myapp configuration data<br class="title-page-name"/>    Required:        true<br class="title-page-name"/>    Value:        &lt;none&gt;<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Processing a template</h1>
                
            
            <article>
                
<p class="calibre2">The following is a real-life example of deploying an application from a predefined template using <kbd class="calibre12">oc new-app</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1"># oc new-app jenkins-persistent -p JENKINS_SERVICE_NAME=myjenkins</strong><br class="title-page-name"/>--&gt; Deploying template "openshift/jenkins-persistent" to project myproject<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>--&gt; Creating resources ...<br class="title-page-name"/>    route "myjenkins" created<br class="title-page-name"/>    deploymentconfig "myjenkins" created<br class="title-page-name"/>    serviceaccount "myjenkins" created<br class="title-page-name"/>    rolebinding "myjenkins_edit" created<br class="title-page-name"/>    service "jenkins-jnlp" created<br class="title-page-name"/>    service "myjenkins" created<br class="title-page-name"/>--&gt; Success<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>    Access your application via route 'myjenkins-myproject.127.0.0.1.nip.io'<br class="title-page-name"/>    Run 'oc status' to view your app</pre>
<p class="calibre2">In the preceding example, we passed the template's name to the command as a parameter; the <kbd class="calibre12">oc</kbd> utility can also build an application from the template you specify. The following is the list of objects created by the <kbd class="calibre12">oc new-app</kbd> command:</p>
<pre class="calibre18"><strong class="calibre1"># oc get all</strong><br class="title-page-name"/>NAME                         REVISION  DESIRED  CURRENT  TRIGGERED BY<br class="title-page-name"/>deploymentconfigs/myjenkins  1         1         1       config,image(jenkins:latest)<br class="title-page-name"/><br class="title-page-name"/>NAME             HOST/PORT               PATH      SERVICES PORT   TERMINATION <br class="title-page-name"/>WILDCARD<br class="title-page-name"/>routes/myjenkins myjenkins-templates.example.com myjenkins &lt;all&gt;    edge/Redirect <br class="title-page-name"/>None<br class="title-page-name"/><br class="title-page-name"/>NAME                      READY     STATUS    RESTARTS  AGE<br class="title-page-name"/>po/myjenkins-1-h2mxx      1/1       Running   0         1m<br class="title-page-name"/><br class="title-page-name"/>NAME                      DESIRED   CURRENT   READY     AGE<br class="title-page-name"/>rc/myjenkins-1            1         1         1         1m<br class="title-page-name"/><br class="title-page-name"/>NAME                      CLUSTER-IP     EXTERNAL-IP  PORT(S)    AGE<br class="title-page-name"/>svc/jenkins-jnlp          172.30.33.180  &lt;none&gt;       50000/TCP  1m<br class="title-page-name"/>svc/myjenkins             172.30.107.99  &lt;none&gt;       80/TCP     1m</pre>
<p class="calibre2">This easy you can create a fully functional jenkins CI/CD application running within OpenShift.</p>
<p class="calibre2">Clean out your project before we proceed:</p>
<pre class="calibre18"><strong class="calibre1"># oc delete all --all</strong><br class="title-page-name"/>deploymentconfig "myjenkins" deleted<br class="title-page-name"/>route "myjenkins" deleted<br class="title-page-name"/>pod "myjenkins-1-zg4km" deleted<br class="title-page-name"/>service "jenkins-jnlp" deleted<br class="title-page-name"/>service "myjenkins" deleted</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating a custom template</h1>
                
            
            <article>
                
<p class="calibre2">In most cases, developers use the predefined OpenShift templates that come with the OpenShift installation; however, at times they don't suit a particular case, so a customized template has to be developed. In this section, we will provide you with an overview of how to create your own template.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Developing YAML/JSON template definitions</h1>
                
            
            <article>
                
<p class="calibre2">If you are familiar with the template layout, you might want to develop a template from scratch, using a standard YAML or JSON-based file. This method will allow you to create a clean template, without any runtime data.</p>
<p class="calibre2">Some of OpenShift's features may speed up the process of template development. For example, <kbd class="calibre12">oc explain</kbd> allows you to explore the syntax of all OpenShift API objects, serving as a form of documentation.</p>
<p class="calibre2">If given no parameters, <kbd class="calibre12">oc explain</kbd> lists all of the kinds of resources supported by the current version of OpenShift:</p>
<pre class="calibre18"><strong class="calibre1"># oc explain</strong><br class="title-page-name"/>You must specify the type of resource to explain. Valid resource types include:<br class="title-page-name"/><br class="title-page-name"/>    * all<br class="title-page-name"/>    * buildconfigs (aka 'bc')<br class="title-page-name"/>    * builds<br class="title-page-name"/>    * certificatesigningrequests (aka 'csr')<br class="title-page-name"/>    * clusterrolebindings<br class="title-page-name"/>    * clusterroles<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>    error: Required resource not specified.<br class="title-page-name"/>See 'oc explain -h' for help and examples.</pre>
<p class="calibre2">The preceding command accepts the type of a resource as an argument, in order to display its syntax:</p>
<pre class="calibre18"><strong class="calibre1"># oc explain svc</strong><br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>FIELDS:<br class="title-page-name"/>   metadata    &lt;Object&gt;<br class="title-page-name"/>     Standard object's metadata. More info:<br class="title-page-name"/>     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...</pre>
<p class="calibre2">Some OpenShift resources have multilevel structures. Use <kbd class="calibre12">.</kbd> (the dot) as a level separator, to find out the structure of such an attribute:</p>
<pre class="calibre18"><strong class="calibre1"># oc explain svc.metadata</strong><br class="title-page-name"/>RESOURCE: metadata &lt;Object&gt;<br class="title-page-name"/> ...<br class="title-page-name"/> &lt;output omitted&gt;<br class="title-page-name"/> ...<br class="title-page-name"/><br class="title-page-name"/>FIELDS:<br class="title-page-name"/> ...<br class="title-page-name"/> &lt;output omitted&gt;<br class="title-page-name"/> ...<br class="title-page-name"/><br class="title-page-name"/>   uid    &lt;string&gt;<br class="title-page-name"/>     UID is the unique in time and space value for this object. It is typically generated by the server on successful creation of a resource and is not allowed to change on PUT operations. Populated by the system. Read-only. More info: http://kubernetes.io/docs/user-guide/identifiers#uids</pre>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">And you can go even further in this hierarchy:</p>
<pre class="calibre18"><strong class="calibre1">$ oc explain svc.metadata.uid</strong><br class="title-page-name"/>FIELD: uid &lt;string&gt;<br class="title-page-name"/><br class="title-page-name"/>DESCRIPTION:<br class="title-page-name"/>     UID is the unique in time and space value for this object. It is typically generated by the server on successful creation of a resource and is not allowed to change on PUT operations. Populated by the system. Read-only. More info: http://kubernetes.io/docs/user-guide/identifiers#uids</pre>
<p class="calibre2">OpenShift documentation is very good and helpful this way.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Exporting existing resources as templates</h1>
                
            
            <article>
                
<p class="calibre2">Existing OpenShift resources may be exported as templates by using the <kbd class="calibre12">oc export</kbd> command. Let's create a running application using <kbd class="calibre12">oc new-app</kbd> command first.</p>
<pre class="calibre18"><strong class="calibre1">$ oc new-app httpd</strong><br class="title-page-name"/>--&gt; Found image 9fd201d (10 days old) in image stream "openshift/httpd" under tag "2.4" for "httpd"<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>--&gt; Success<br class="title-page-name"/>    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:<br class="title-page-name"/>     'oc expose svc/httpd'<br class="title-page-name"/>    Run 'oc status' to view your app.<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">$ oc get all</strong><br class="title-page-name"/>NAME             READY     STATUS    RESTARTS   AGE<br class="title-page-name"/>httpd-1-dcm2d    1/1       Running   0          2s<br class="title-page-name"/>httpd-1-deploy   1/1       Running   0          3s<br class="title-page-name"/>[root@openshift ~]# oc get all<br class="title-page-name"/>NAME                      REVISION   DESIRED   CURRENT   TRIGGERED BY<br class="title-page-name"/>deploymentconfigs/httpd   1          1         1         config,image(httpd:2.4)<br class="title-page-name"/><br class="title-page-name"/>NAME                 DOCKER REPO                       TAGS      UPDATED<br class="title-page-name"/>imagestreams/httpd   172.30.1.1:5000/myproject/httpd   2.4<br class="title-page-name"/><br class="title-page-name"/>NAME               READY     STATUS    RESTARTS   AGE<br class="title-page-name"/>po/httpd-1-dcm2d   1/1       Running   0          15s<br class="title-page-name"/><br class="title-page-name"/>NAME         DESIRED   CURRENT   READY     AGE<br class="title-page-name"/>rc/httpd-1   1         1         1         17s<br class="title-page-name"/><br class="title-page-name"/>NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE<br class="title-page-name"/>svc/httpd   ClusterIP   172.30.18.224   &lt;none&gt;        8080/TCP,8443/TCP   17s<br class="title-page-name"/><br class="title-page-name"/><strong class="calibre1">$ oc export dc,svc,route --as-template=myhttpd &gt; myhttpd_template.yaml<br class="title-page-name"/></strong></pre>
<p class="calibre2">Once the template is created, you can see its contents:</p>
<pre class="calibre18"><strong class="calibre1">$ cat myhttpd_template.yaml | head -n 20</strong><br class="title-page-name"/>apiVersion: v1<br class="title-page-name"/>kind: Template<br class="title-page-name"/>metadata:<br class="title-page-name"/>  creationTimestamp: null<br class="title-page-name"/>  name: myhttpd<br class="title-page-name"/>objects:<br class="title-page-name"/>- apiVersion: v1<br class="title-page-name"/>  kind: DeploymentConfig<br class="title-page-name"/>  metadata:<br class="title-page-name"/>    annotations:<br class="title-page-name"/>      openshift.io/generated-by: OpenShiftNewApp<br class="title-page-name"/>    creationTimestamp: null<br class="title-page-name"/>    generation: 1<br class="title-page-name"/>    labels:<br class="title-page-name"/>      app: httpd<br class="title-page-name"/>    name: httpd<br class="title-page-name"/>  spec:<br class="title-page-name"/>    replicas: 1<br class="title-page-name"/>    revisionHistoryLimit: 10<br class="title-page-name"/>    selector:</pre>
<div class="packt_infobox">This method of creating a template is fast; however, you have to remove all runtime data from the template. For example, all timestamps and status records should be deleted.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using the oc new-app -o command</h1>
                
            
            <article>
                
<p class="calibre2">By default, the <kbd class="calibre12">oc new-app</kbd> command creates all of the resources required for a project. You can modify this behavior and get the utility to create a resource definition file, instead of creating resources:</p>
<pre class="calibre18"><strong class="calibre1">$ oc new-app httpd -o yaml | head -n 20</strong><br class="title-page-name"/>apiVersion: v1<br class="title-page-name"/>items:<br class="title-page-name"/>- apiVersion: v1<br class="title-page-name"/>  kind: DeploymentConfig<br class="title-page-name"/>  metadata:<br class="title-page-name"/>    annotations:<br class="title-page-name"/>      openshift.io/generated-by: OpenShiftNewApp<br class="title-page-name"/>    creationTimestamp: null<br class="title-page-name"/>    labels:<br class="title-page-name"/>      app: httpd<br class="title-page-name"/>    name: httpd<br class="title-page-name"/>  spec:<br class="title-page-name"/>    replicas: 1<br class="title-page-name"/>    selector:<br class="title-page-name"/>      app: httpd<br class="title-page-name"/>      deploymentconfig: httpd<br class="title-page-name"/>    strategy:<br class="title-page-name"/>      resources: {}<br class="title-page-name"/>    template:<br class="title-page-name"/>      metadata:</pre>
<div class="packt_infobox">This doesn't create an OpenShift template, but it can be used to create a skeleton of the template's structure.</div>
<p class="calibre2">Clear out your your project environment, before we proceed.</p>
<pre class="calibre18"># oc delete all --all<br class="title-page-name"/>deploymentconfig "httpd" deleted<br class="title-page-name"/>imagestream "httpd" deleted<br class="title-page-name"/>pod "httpd-1-dcm2d" deleted<br class="title-page-name"/>service "httpd" deleted</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using templates to deploy a multi-tier application</h1>
                
            
            <article>
                
<p class="calibre2">During this lab, we will deploy <strong class="calibre4">Gogs</strong> (Git repository management software) with a PostgreSQL backend, using all of the knowledge that we have acquired so far.</p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">The Gogs application template</h1>
                
            
            <article>
                
<p class="calibre2">We are going to use a template from the OpenShift demos that are available at <a href="https://raw.githubusercontent.com/OpenShiftDemos/gogs-openshift-docker/master/openshift/gogs-template.yaml" target="_blank" class="calibre8">https://raw.githubusercontent.com/OpenShiftDemos/gogs-openshift-docker/master/openshift/gogs-template.yaml</a>:</p>
<p class="calibre2">Let's download this template locally using the following command:</p>
<pre class="calibre18"><strong class="calibre1"># curl -O https://raw.githubusercontent.com/OpenShiftDemos/gogs-openshift-docker/master/openshift/gogs-template.yaml</strong></pre>
<p class="calibre2">According to the preceding output, most parameters have a default value (except for the <kbd class="calibre12">HOSTNAME</kbd> parameter). If you need to list parameters separately, you can use the following command:</p>
<pre class="calibre18"><strong class="calibre1"><span># oc process --parameters -f gogs-template.yaml<br class="title-page-name"/>NAME DESCRIPTION GENERATOR VALUE<br class="title-page-name"/>APPLICATION_NAME The name for the application. gogs<br class="title-page-name"/>...<br class="title-page-name"/> &lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/></span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating the Gogs application</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have created the template, it's time to use it:</p>
<ol class="calibre13">
<li value="1" class="calibre10">First, we need to create a separate project for this lab:</li>
</ol>
<pre class="calibre19"><strong class="calibre1"># oc new-project gogs</strong><br class="title-page-name"/>Now using project "gogs" on server "https://localhost:8443".</pre>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Let's try to deploy Gogs without specifying a mandatory <kbd class="calibre12">HOSTNAME</kbd> <span>parameter</span>:</li>
</ol>
<pre class="calibre19"><strong class="calibre1"># oc new-app -f gogs-template.yaml</strong><br class="title-page-name"/>error: error processing template "templats/gogs": Template.template.openshift.io "gogs" is invalid: template.parameters[1]: Required value: template.parameters[1]: parameter HOSTNAME is required and must be specified</pre>
<p class="calibre27">OpenShift aborted the processing of the <span class="calibre11">template,</span> as the <kbd class="calibre12">HOSTNAME</kbd> wasn't provided.</p>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Let's try again, with the <kbd class="calibre12">HOSTNAME</kbd> set:</li>
</ol>
<pre class="calibre19"><strong class="calibre1"># oc new-app -f gogs-template.yaml -p HOSTNAME=gogs.example.com</strong><br class="title-page-name"/>--&gt; Deploying template "gogs/gogs" for "gogs-template.yaml" to project gogs<br class="title-page-name"/>...<br class="title-page-name"/>&lt;output omitted&gt;<br class="title-page-name"/>...<br class="title-page-name"/>--&gt; Success<br class="title-page-name"/>    Access your application via route 'gogs.example.com'<br class="title-page-name"/>    Run 'oc status' to view your app.</pre>
<p class="calibre27">The template has been processed by OpenShift. After some time, all of the OpenShift objects specified in the template should be created:</p>
<pre class="calibre19"><strong class="calibre1"># oc get all</strong><br class="title-page-name"/>NAME DOCKER REPO TAGS        UPDATED<br class="title-page-name"/>imagestreams/gogs 172.30.1.1:5000/gogs/gogs 0.9.97 About a minute ago<br class="title-page-name"/><br class="title-page-name"/>NAME REVISION DESIRED CURRENT TRIGGERED BY<br class="title-page-name"/>deploymentconfigs/gogs 1 1 1 config,image(gogs:0.9.97)<br class="title-page-name"/>deploymentconfigs/gogs-postgresql 1 1 1 config,image(postgresql:9.5)<br class="title-page-name"/><br class="title-page-name"/>NAME HOST/PORT PATH SERVICES PORT TERMINATION WILDCARD<br class="title-page-name"/>routes/gogs gogs.example.com gogs &lt;all&gt; None<br class="title-page-name"/><br class="title-page-name"/>NAME READY STATUS RESTARTS AGE<br class="title-page-name"/>po/gogs-1-vc5g5 1/1 Running 1 1m<br class="title-page-name"/>po/gogs-postgresql-1-hfxlf 1/1 Running 0 1m<br class="title-page-name"/><br class="title-page-name"/>NAME DESIRED CURRENT READY AGE<br class="title-page-name"/>rc/gogs-1 1 1 1 1m<br class="title-page-name"/>rc/gogs-postgresql-1 1 1 1 1m<br class="title-page-name"/><br class="title-page-name"/>NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br class="title-page-name"/>svc/gogs 172.30.196.109 &lt;none&gt; 3000/TCP 1m<br class="title-page-name"/>svc/gogs-postgresql 172.30.196.38 &lt;none&gt; 5432/TCP 1m</pre>
<div class="packt_infobox">The route <kbd class="calibre26">gogs</kbd> uses the <kbd class="calibre26">gogs.example.com</kbd> hostname, which we specified when instantiating the template.</div>
<p class="calibre2">Add gogs.example.com record to your hosts file</p>
<pre class="calibre18">echo "127.0.0.1 gogs.example.com" &gt;&gt; /etc/hosts</pre>
<p class="calibre2">Gogs has been successfully deployed. To verify that it works properly, we need to access it through a web browser on <kbd class="calibre12">http://gogs.example.com:1080/</kbd></p>
<div class="cdpaligncenter2"><img class="alignnone57" src="../images/00067.jpeg"/></div>
<p class="calibre2">Clear out your environment.</p>
<pre class="calibre18">$ oc delete all --all<br class="title-page-name"/>deploymentconfig "mariadb" deleted<br class="title-page-name"/>imagestream "mariadb" deleted<br class="title-page-name"/>pod "mariadb-1-9qcsp" deleted<br class="title-page-name"/>service "mariadb" deleted<br class="title-page-name"/><br class="title-page-name"/>$ oc delete project gogs<br class="title-page-name"/>project "gogs" deleted<br class="title-page-name"/><br class="title-page-name"/>$ oc project myproject<br class="title-page-name"/>Now using project "myproject" on server "https://localhost:8443".</pre>
<p class="calibre2">If you are going to continue with the following Chapter, you can leave your OpenShift cluster up, otherwise you can shutdown or delete vagrant VM.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, you learned about <span class="calibre11">OpenShift templates, including how to </span><span class="calibre11">write your own templates and </span><span class="calibre11">deploy applications from templates.</span></p>
<p class="calibre2">In the following chapter, you will learn how OpenShift simplifies Docker image life cycles by providing a Docker build strategy that automates application deployment from the source code, if a Dockerfile is available.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<ol class="calibre13">
<li value="1" class="calibre10">Which of the following OpenShift projects holds default templates?</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">default</li>
<li value="2" class="calibre10">openshift</li>
<li value="3" class="calibre10">openshift-infra</li>
<li value="4" class="calibre10">openshift-node</li>
<li value="5" class="calibre10">templates</li>
</ol>
</li>
</ul>
<p class="calibre2"/>
<p class="calibre2"/>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Which of the following commands can show you a list of parameters for the <kbd class="calibre12">mytemplate</kbd> template? choose three:</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10"><kbd class="calibre12">oc get template mytemplate -n openshift -o yaml</kbd></li>
<li value="2" class="calibre10"><kbd class="calibre12">oc process --parameters -f mytemplate.json</kbd></li>
<li value="3" class="calibre10"><kbd class="calibre12">oc describe template mytemplate -n openshift</kbd></li>
<li value="4" class="calibre10"><kbd class="calibre12">oc get parameters -t mytemplate</kbd></li>
<li value="5" class="calibre10"><kbd class="calibre12">oc get template mytemplate -n openshift</kbd></li>
<li value="6" class="calibre10"><kbd class="calibre12">oc new-app mytrmplate</kbd></li>
</ol>
</li>
</ul>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Which of the following OpenShift entities can be created using templates?</li>
</ol>
<ul class="calibre9">
<li class="front-matter">
<ol class="calibre14">
<li value="1" class="calibre10">Pod</li>
<li value="2" class="calibre10">Service</li>
<li value="3" class="calibre10">Route</li>
<li value="4" class="calibre10">Deployment config</li>
<li value="5" class="calibre10">All of the above</li>
</ol>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Further reading</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre11">Consider the following links for further reading:</span></p>
<ul class="calibre9">
<li class="calibre10">Templates at <a href="https://docs.openshift.org/latest/dev_guide/templates.html" target="_blank" class="calibre8">https://docs.openshift.org/latest/dev_guide/templates.html</a>.</li>
<li class="calibre10">Loading the Default Image Streams and Templates at <a href="https://docs.openshift.org/latest/install_config/imagestreams_templates.html" target="_blank" class="calibre8">https://docs.openshift.org/latest/install_config/imagestreams_templates.html</a>.</li>
</ul>


            </article>

            
        </section>
    </body></html>