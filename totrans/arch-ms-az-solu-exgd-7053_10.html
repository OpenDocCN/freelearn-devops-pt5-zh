<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Securing Your Data</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the securing your resources objective</span><span>. We covered how to design solutions using Azure Active Directory, Azure B2B, and more. We also covered when to use these different Azure services.</span></p>
<p>In this chapter, we will cover how to d<span>esign data security solutions for Azure services</span>, such as using <span>Azure Storage Encryption, Azure Disk Encryption, and Azure Key Vault.</span></p>
<p>By the end of this chapter, you will know how to secure your data using the different security features in Azure.</p>
<p>The following topics will be covered:</p>
<ul>
<li><span>Azure Key Vault</span></li>
<li><span>Azure Storage Encryption</span></li>
<li><span>Azure Disk Encryption</span></li>
<li><span>Azure SQL Database Security</span></li>
<li><span>Azure AD Managed Service Identity</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for the examples:</p>
<ul>
<li>Azure PowerShell: <a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1">https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1</a></li>
</ul>
<p><span>The source code for this chapter can be downloaded from the following link:</span></p>
<ul>
<li><a href="https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%2010">https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%2010</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Key Vault </h1>
                </header>
            
            <article>
                
<p>You can store <span>cryptographic keys and secrets</span> in Azure Key Vault, which can be used by various Azure services and custom applications. Azure uses it for storing keys for Azure Storage Service Encryptions and Azure Disk Encryption, which are covered later in this chapter. <span>However, for instance, you can store your App client ID and secret in there as well and retrieve this inside your custom application. This way, you don't have to store these IDs and secrets in your web.config anymore, and they can be managed from one place, where it is secured and protected, inside the Azure Portal. </span>You can store certificates and other authentication keys in there as well, and it offers a monitoring solution for key usage. Azure Key Vault is integrated with Azure AD, so you can set access policies on different users and groups to access the keys that are stored in there.</p>
<p>Azure Key Vault comes in two service tiers:</p>
<ul>
<li><strong>Standard</strong>: This offers Geographic scaling and available.</li>
<li><strong>Premium</strong>:<strong> </strong>This offers<span> Geo-availability and support for Hardware Security Modules (HSMs), by providing backups for HSM keys. HSMs are special computers that are only used for cryptographic operations. Handling this on the hardware itself offers better performance and security. The keys and secrets are encrypted in Azure Key Vault with adding some extra properties, which makes sure that it can only be used by that particular HSM.</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Key Vault in the Azure Portal</h1>
                </header>
            
            <article>
                
<p><span>To create an Azure Key Vault Service in the Azure Portal and add a key, secret, and certificate to it, take the following steps:</span></p>
<ol start="1">
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li class="mce-root"><span>Click on </span><span class="packt_screen">New</span><span> </span><span>and type</span> <kbd>Key Vault</kbd> <span>in the search bar. Create a new Key Vault:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/bec879c9-902f-4e72-8d48-b3b4b8717fba.jpg" style="width:36.67em;height:51.83em;" width="1157" height="1635"/><br/>
<br/>
Creating a new Azure Key Vault</div>
<ol start="3">
<li class="mce-root"><span>Add the following settings and click on</span><span class="packt_screen"> Create</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/44766a7d-96cf-4ae3-b33f-932255c26a7e.jpg" style="width:19.42em;height:43.83em;" width="618" height="1392"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><span>Adding Azure Key Vault settings</span><br/></div>
<ol start="4">
<li>Once the Key Vault is created, you can add a key and secret from the left menu:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/07f619fa-5a9c-4e3d-a5a1-099a463ee091.jpg" style="width:50.08em;height:37.42em;" width="2282" height="1703"/><br/>
<br/>
Key Vault settings</div>
<ol start="5">
<li>Click on <span class="packt_screen">Keys</span> and then on <span class="packt_screen">Generate/Import</span>.<strong> </strong>Here, you can set a number of settings, such as the key type and key size. Add the following settings and click on <span class="packt_screen">Create</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span><img src="Images/ef02e109-5be9-4809-a1e2-b6987b6dd54a.jpg" style="width:35.83em;height:43.00em;" width="1159" height="1394"/><br/></span></span></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Adding Key</span></span></div>
<ol start="6">
<li class="mce-root"><span>If you click on the</span> <span class="packt_screen">Key</span> <span>and go to the properties of it, you can see that you can use this key for a number of operations; you can</span> <span class="packt_screen">Encrypt</span><span>,</span> <span class="packt_screen">Decrypt</span><span>,</span> <span class="packt_screen">Sign</span><span>, and</span> <span class="packt_screen">Verify</span> <span>data, or you can protect another key using the</span> <span class="packt_screen">Wrap Key</span> <span>and</span> <span class="packt_screen">Unwrap Key</span> <span>operations:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/2a02c646-2ed6-44f3-8fad-7b120c5318f9.jpg" style="width:35.33em;height:42.33em;" width="1157" height="1387"/><br/>
<br/>
Key properties</div>
<ol start="7">
<li class="mce-root"><span>To create a secret, click on </span><span class="packt_screen">Secret</span><strong> </strong><span>in the left menu and click on </span><span class="packt_screen">Generate/Import</span><span>. For instance, you can add an App key and an App secret to this. Add the following settings and click on</span><span class="packt_screen"> Create</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/6deba8d4-ab30-423e-9f4c-f837d39465b1.jpg" style="width:34.17em;height:40.92em;" width="1161" height="1392"/><br/>
<br/>
Add Secret</div>
<ol start="8">
<li class="mce-root"><span>To create or upload a certificate, click on </span><strong><span class="packt_screen">Certificate</span></strong><strong> </strong><span>in the left menu and click on </span><span class="packt_screen">Generate/Import</span><span>. </span><span>You can add Certificate Authorities in here as well and let them issue the certificate. We are now creating a Self-Signed certificate for this example:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/ce664819-91b9-41ab-baf5-6d4f7e5599e0.jpg" style="width:30.92em;height:44.00em;" width="1162" height="1658"/><br/>
<br/>
Creating Certificate</div>
<ol start="9">
<li>Click on <span class="packt_screen">Create</span>.<strong> </strong>It may take some time before the certificate is created.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Key Vault secrets in ARM templates</h1>
                </header>
            
            <article>
                
<p>Besides leveraging the Azure Key Vault in your custom applications, you can also use secrets in ARM templates. You can add the secrets to the parameters JSON file. See the following example to see what your parameter will look like:</p>
<pre>"packtPassword": {<br/>"reference": {<br/>"keyVault": {<br/>    "id": "/subscriptions/&lt;subscription id&gt;/resourceGroups/examplegroup/providers/Microsoft.KeyVault/vaults/&lt;vault-name&gt;"<br/>             },<br/>         "secretName": "packtsecret"<br/>   }<br/>},</pre>
<div class="packt_infobox">This should give you an impression of how to embed secrets in your ARM templates. For a complete tutorial about how to create ARM templates, you can refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-keyvault-parameter">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-keyvault-parameter</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Storage Service Encryption</h1>
                </header>
            
            <article>
                
<p>Azure Storage provides encryption for data at rest by default using Azure Storage Service Encryption (SSE). Data gets secured when it is in transit between the Application and Azure using HTTPS, and it gets encrypted when it is written to the storage account using 256-bit AES encryption. <span>You can use SMB 3.0 or a VPN connection for safely transferring the data to Azure as well. </span>Once the data is accessed again, it get's decrypted, and it is sent back over HTTPS. Azure manages the encryption storage keys inside Azure Key Vault automatically. SSE is used for Table, File, Queue, and B<span>lob Storage, and SSE is available for the Standard and Premium pricing plans, for all redundancy levels, and for all regions. </span></p>
<p>You can set encryption for your storage account in the Azure Portal, PowerShell, CLI, the REST API, and the Azure Storage SDK. It is enabled by default, so you don't have to set this in your PowerShell scripts manually:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/536f8280-9eaf-4fd6-a7bb-3b79e246ab50.jpg" style="width:67.75em;height:41.33em;" width="2275" height="1388"/><br/>
<br/>
Azure Storage Service Encryption settings</div>
<p>You can use client-side encryption in your custom code as well. The Azure Storage Client Library for .NET supports this. This also works in conjunction with the Azure Key Vault. The SDK creates a Content Encryption Key (CEK), which is used to encrypt the data before it is sent to the storage account. The encryption key is then stored in the Azure Key Vault by default, but you can use a custom provider as well. Using client-side encryption will encrypt your data before it is sent to Azure, and at the moment that it is stored inside the storage account.</p>
<p><span>SSE has one limitation, that is, only the data that is created when encryption is turned on will get encrypted. So, if you have disabled encryption for your storage account at some point, data that is stored inside the storage account is not encrypted anymore. When you decide to enable encryption again, the data that was stored earlier does not get encrypted automatically, as data is only encrypted at the time of storing the data. You have to remove and upload this data again to get it encrypted. </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Disk Encryption</h1>
                </header>
            
            <article>
                
<p>Azure Disk Encryption encrypts Windows and Linux VM disks. For Windows disks, it uses Bitlocker, and for Linux, dm-crypt is used, which are both industry standards. Azure Key Vault is used to manage the encryption keys, just like Azure Storage Encryption. </p>
<p><span>For all VM types, Azure Disk Encryption is available in all Azure regions</span> and can be set using PowerShell. You can use the following commands to set the encryption:</p>
<pre><strong>Login-AzureRmAccount</strong></pre>
<p>If necessary, select the right subscription:</p>
<pre><strong><span>Select-AzureRmSubscription -SubscriptionId "********-****-****-****-***********"</span></strong></pre>
<p>We are using the Azure Key Vault <span>to store the encryption keys, </span>which we created earlier. We are using the VM that was created in the first chapter here as well (make sure that the VM is running; otherwise, you get an error running the script). Both are created in the same Resource Group. So, fill in the Key Vault name, the Resource Group of the Key Vault, and the <span><span>VM</span></span> and encrypt the VM. It uses an App in Azure AD, which is used to write the secrets in the Key Vault. You need to create the app first and replace the App ID and secret in the script. It may take some time before it is fully encrypted:</p>
<pre><strong>$RGName = "PacktPub"</strong><br/><strong>$VMName = "W16PacktServer"</strong><br/><strong>$AADClientID = "PacktADApp"</strong><br/><strong>$AADClientSecret = "PacktSecret"</strong><br/><strong>$VaultName= "PacktKeyVault"</strong><br/><br/><strong>$KeyVault = Get-AzureRmKeyVault -VaultName $VaultName -ResourceGroupName $RGName</strong><br/><strong>$DiskEncryptionKeyVaultUrl = $KeyVault.VaultUri</strong><br/><strong>$KeyVaultResourceId = $KeyVault.ResourceId</strong><br/><br/><strong>Set-AzureRmVMDiskEncryptionExtension -ResourceGroupName $RGName -VMName $VMName -AadClientID $AADClientID -AadClientSecret $AADClientSecret -DiskEncryptionKeyVaultUrl $DiskEncryptionKeyVaultUrl -DiskEncryptionKeyVaultId $KeyVaultResourceId</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure SQL Database Security</h1>
                </header>
            
            <article>
                
<p>Azure SQL Database also offers various features for data security. It offers security for data in transit, data in rest, and data in use. To accomplish this, it is using the following features:</p>
<ul>
<li><strong>HTTPS</strong>: This offers security for data in transit. Data is transferred using a secure connection over HTTPS.</li>
<li class="mce-root"><strong>Transparent Data Encryption</strong><span>: This offers security for data at rest. It performs real-time encryption and decryption of the database, backup files, and logs. This is used for Azure Data Warehouse as well. It is using a database encryption key that is stored by Azure by default, but can be stored in Azure Key Vault as well. Newly created databases are encrypted by default. You can disable and enable the encryption inside the settings in the Azure Portal, PowerShell, and the REST API:</span></li>
</ul>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img src="Images/536343af-d967-4bcc-940c-3ec1b250056b.jpg" style="width:68.75em;height:42.17em;" width="2279" height="1397"/><strong><br/></strong></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Transparent Data Encryption in the Azure Portal</div>
<ul>
<li><strong>Always Encrypted</strong>:<strong> </strong>This offers security for data in use. It offers encryption for confidential data inside the database. For instance, social security numbers or credit card numbers are stored encrypted in the database and are decrypted inside the application for those who have permission to access it. You can enable <strong>Always Encrypted</strong> for columns in the database using <span>SQL Server Management Studio or PowerShell. </span>To encrypt sensitive data from the application, you can use the .NET Framework Data Provider for SQL Server.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Managed Service Identity</h1>
                </header>
            
            <article>
                
<p>Azure Active Directory Managed Service Identity is, by the time of writing this book, still in preview. It offers a managed identity for all resources in Azure that are using Azure Active Directory. </p>
<p><span>When you enable MSI on your Azure resource, such as an Azure Virtual Machine, Azure Function, or App, Azure will create a Service Principal and stores the credentials of that Service Principal on to the Azure resource itself. When it is time to authenticate, an MSI endpoint is called, passing your current Azure AD credentials and a reference to the specific resource. MSI then retrieves the stored credentials from the Azure resource, passes it to Azure AD, and retrieves an access token that can be used</span><span> to authenticate to the Azure resource or service.</span></p>
<div class="packt_infobox">You should note that the Service Principal is only known inside the boundaries of the specific Azure resource where it is stored. If it needs permissions toward other resources as well, you should assign the appropriate role <span>using</span> <strong>Role-Based Access Control</strong> <span>(<strong>RBAC</strong>) in Azure AD. </span></div>
<p>You can enable MSI for your Azure resources in the Azure Portal, PowerShell, CLI, and ARM templates:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d749790f-dc19-4258-ac00-4c005e8219b0.png" style="width:46.67em;height:33.50em;" width="1133" height="812"/><span><br/>
<br/>
Managed Service Identity Settings for an App Service</span></div>
<p><span>From your custom code, you can call the MSI endpoint to get an access token to authenticate the Azure resource as well. For .NET applications, you can use the </span><span><kbd>Microsoft.Azure.Services.AppAuthentication</kbd> library to accomplish this. You can do this by calling the REST API as well, but then you have to create the request manually.</span></p>
<div class="packt_tip">You can refer to the following GitHub page at <a href="https://github.com/Azure-Samples/app-service-msi-keyvault-dotnet">https://github.com/Azure-Samples/app-service-msi-keyvault-dotnet</a> for an example of an application that uses MSI.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered how to secure your data using the different services that Azure provides. We covered Azure Key Vault, <span>Azure Storage Service Encryption, </span><span>Azure Disk Encryption, and more. Now you should know when and how to use these technologies in your solutions.</span></p>
<p>The next chapter will be the last chapter on this objective, <em>Governance and Policies</em>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book.</span></p>
<ol>
<li>You want to add an additional layer of security to your applications. Credit card numbers need to be stored encrypted inside Azure SQL Database. Should you use Data Masking?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You are developing a custom application and don't want to add the App ID and App Secret to your web.config. Can you store these credentials in the Azure Key Vault and retrieve them dynamically when the application is executed?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Does Azure Disk Encryption encrypt data at rest and data in transit?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><strong>Key Vault Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/key-vault/">https://docs.microsoft.com/en-us/azure/key-vault/</a></li>
<li><strong>Use Azure Key Vault to pass secure parameter value during deployment</strong>: <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-keyvault-parameter">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-keyvault-parameter</a></li>
<li><strong>Use Azure Key Vault to protect application secrets</strong>: <a href="https://docs.microsoft.com/en-us/azure/architecture/multitenant-identity/key-vault">https://docs.microsoft.com/en-us/azure/architecture/multitenant-identity/key-vault</a></li>
<li><strong>Get started with Azure Key Vault certificates</strong>: <a href="https://blogs.technet.microsoft.com/kv/2016/09/26/get-started-with-azure-key-vault-certificates/">https://blogs.technet.microsoft.com/kv/2016/09/26/get-started-with-azure-key-vault-certificates/</a></li>
<li><strong>Azure Storage Service Encryption for Data at Rest</strong>: <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-service-encryption">https://docs.microsoft.com/en-us/azure/storage/common/storage-service-encryption</a></li>
<li><strong>Securing your SQL Database</strong>: <a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-security-overview">https://docs.microsoft.com/en-us/azure/sql-database/sql-database-security-overview</a></li>
<li><strong>Always Encrypted</strong>: <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/always-encrypted-database-engine">https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/always-encrypted-database-engine</a></li>
<li><strong>Managed Service Identity (MSI) for Azure resources</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview">https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>