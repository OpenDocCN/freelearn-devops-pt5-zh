<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Working with Azure Virtual Machines</h1>
                </header>
            
            <article>
                
<p>This is the first chapter of the book <em>Architecting Azure Solutions</em>. This book will cover all the objectives for the 70-535 exam. When relevant, we will provide you with extra information and further guidance on how to design and architect robust, future-proof, and effective solutions on the Azure platform.</p>
<p class="mce-root">This chapter introduces the Microsoft Azure <strong>Virtual Machine</strong> (<strong>VM</strong>) objective. We will cover information about series and sizes. We will also cover how to design VM deployments using Availability Sets, fault domains, and update domains. In addition, we will show you how to create an Availability Set from the Azure Portal, as well as from Azure PowerShell. Finally, we will cover how to design and manage VM Scale Sets from the Azure Portal.</p>
<p>In this chapter, the following topics will be covered:</p>
<ul>
<li>Designing solutions for virtual machines</li>
<li>Virtual machine s<span>eries and s</span>izes</li>
<li>Availability Sets</li>
<li>Fault domains and update domains</li>
<li>Managed Disks</li>
<li>Creating highly available VMs</li>
<li>VM Scale Sets</li>
<li>Disaster recovery</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for its examples:</p>
<ul>
<li>Azure PowerShell: <a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.6.0&amp;viewFallbackFrom=azurermps-5.1.1">https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.6.0&amp;viewFallbackFrom=azurermps-5.1.1</a></li>
</ul>
<p><span>The source code for this chapter can be downloaded here:</span></p>
<ul>
<li><a href="https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%201">https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%201</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Designing solutions for virtual machines</h1>
                </header>
            
            <article>
                
<p>In Azure, you can run both Windows VMs as well as Linux VMs. Virtual machines come in all sorts of sizes and a variety of prices, ranging from VMs with a small amount of memory and processing power for general purposes to large VMs that can be used for GPU-intensive and high-performance computing <span>workloads</span>.</p>
<p>To create a virtual machine, you can choose from a number of predefined images. There are images available for operating systems such as Windows Server or Kali Linux, as well as predefined applications, such as SQL Server images and complete farms, which consist of multiple VMs that can be deployed at once. An example of a farm is a three-tier SharePoint farm. </p>
<p>VMs can be created and managed either from the Azure Portal, PowerShell, or CLI. If you're planning on using PowerShell, please note that there are multiple versions of Azure PowerShell available, and that there is a notable difference between Azure PowerShell, which supports the classic deployment model, and the <em>new</em> Azure PowerShell. To install and configure Azure PowerShell, please refer to the beginning of this chapter.</p>
<div class="packt_infobox">For the demos in this book, we will be using the Azure PowerShell version that supports the <em>new</em> Azure PowerShell. I strongly advise using this version of PowerShell for all your new deployments and solutions. The classic model should only be used for solutions that have already been deployed using this model previously.</div>
<p>Designing the most effective virtual machine solution depends on a few things, such as deciding which size and series to use, deciding if your VMs need high availability, and if your solution will need to scale up and down easily.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Virtual machine series and sizes</h1>
                </header>
            
            <article>
                
<p>There are a lot of different VM sizes available to choose from in Azure. Note that it is important to know what options there are from a design perspective, because choosing the wrong VM size can have a negative impact on the performance of your VM, or your application installed on the VM. Choosing between the different available options will also have a huge effect on the overall costs. For example, if your company or client wants to reduce costs by migrating data centers to Azure, choosing your VMs wisely will either make your project a success or a failure.</p>
<p>Azure VMs are organized into machine series, starting with the A-series, which are VMs mainly used for general purposes. There are also VM sizes that are optimized for compute, memory, storage, and GPU, as well as high-performance compute VMs. All of the available series and sizes are explained in more detail in the following section.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Available VM series and sizes</h1>
                </header>
            
            <article>
                
<p>At the time of writing this book, the following VM series are available:</p>
<table>
<tbody>
<tr>
<td><strong>Sizes</strong></td>
<td><strong>Type</strong></td>
<td><strong>Description</strong></td>
</tr>
</tbody>
<tbody>
<tr>
<td><span>A0-7, Av2, B, D, DS, Dv2, DSv2, Dv3, Dsv3</span></td>
<td>General purpose</td>
<td>These VMs have<span> a </span><span>balanced CPU-to-memory ratio and </span>are ideal for testing and development scenarios. They are also suitable for small and medium databases and web servers with low to medium traffic.</td>
</tr>
<tr>
<td><span>F, Fs, Fsv2</span></td>
<td>Compute optimized</td>
<td>These VMs have a high CPU-to-memory ratio and are suitable for <span>web servers with medium traffic, application servers, and network appliances for nodes in batch processing.</span></td>
</tr>
<tr>
<td><span>D, DS, Dv2, DSv2, Ev3, Esv3, G, GS, M</span></td>
<td>Memory optimized</td>
<td><span>These VMs have a high memory-to-CPU ratio and are suitable for relational database servers, medium to large caches, and in-memory analytics.</span></td>
</tr>
<tr>
<td>Ls</td>
<td>Storage optimized</td>
<td><span>These VMs have high disk throughput and IO and are suitable for big data, SQL, and NoSQL databases.</span></td>
</tr>
<tr>
<td><span>NC, NCv2, NCv3, ND, NV</span></td>
<td>GPU</td>
<td>These VMs are targeted for heavy graphic rendering and video editing, deep learning applications, and machine learning model training. These VMs are available with single or multiple GPUs. </td>
</tr>
<tr>
<td><span>A8-11, H</span></td>
<td>High-performance compute</td>
<td><span>These are the fastest VMs available. They offer the most powerful CPU with optional high-throughput network interfaces (RDMA).</span></td>
</tr>
</tbody>
</table>
<p> </p>
<div class="packt_tip packt_infobox">VM machine series are updated constantly. New series, types, and sizes are added and removed frequently. To stay up to date with these changes, you can refer to the following site for Windows VM sizes: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes</a>. For Linux VM sizes, you can refer to<span> <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json</a></span>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Availability Sets</h1>
                </header>
            
            <article>
                
<p>To create a reliable infrastructure, adding your virtual machines to an Availability Set is key. There are several scenarios that can have an impact on the availability of your Azure Virtual Machines. These are as follows:</p>
<ul>
<li><strong>Unplanned hardware maintenance event</strong>:<strong> </strong>When hardware is about to fail, Azure fires an unplanned hardware maintenance event. Live migration technology is used, which predicts the failure and then moves the VM, the network connections, <span>memory, and storage</span> to <span>different physical machines without disconnecting the client. When your VM is moved, the performance is reduced for a short time because the VM is paused for 30 seconds. Network connections, memory, and open files are still preserved.</span></li>
<li><strong>Unexpected downtime</strong>:<strong> </strong>The virtual machine is down when this event occurs because Azure needs to heal your VM inside the same data center. A hardware or physical infrastructure failure often causes this event to happen. </li>
<li><strong>Planned hardware maintenance event: </strong>This type of event is a periodic update from Microsoft in Azure to improve the platform. Most of these updates don't have a significant impact on the uptime of VMs, but some of them may require a reboot or restart.</li>
</ul>
<p>To provide redundancy during these types of events, you can group two or more VMs in an Availability Set. By leveraging Availability Sets, VMs are distributed across multiple isolated hardware nodes in a cluster. This way, Azure can ensure that during an event or failure, only a subset of your VMs is impacted and your overall solution will remain operational and available. This way, the <span>99.95% </span>Azure SLA can be met.</p>
<div class="packt_tip">For a detailed overview of when and how the SLA applies, you can refer to the following overview: <a href="https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/v1_6/">https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/v1_6/</a>.<a href="https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/v1_6/"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Fault domains and update domains</h1>
                </header>
            
            <article>
                
<p>When you place your VMs in an A<span>vailability Set, Azure guarantees to spread them across fault and update domains. By default, Azure will assign <strong>three fault domains and five update domains</strong> (which can be increased to a maximum of 20) to the Availability Set.</span></p>
<p class="mce-root">When spreading your VMs over fault domains, your VMs sit over three different racks in the Azure data center. So, in the case of an event or failure on the underlying platform, only one rack gets affected and the other VMs are still accessible.</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/9e1f45dc-0099-4de3-a63a-475bbce23614.jpg" style="width:43.75em;height:22.58em;" width="1229" height="634"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>VMs spread over three fault domains</span></div>
<p>Update domains are useful in the case of an OS or host update. When you spread your VMs across multiple update domains, one domain will be updated and rebooted while the others remain accessible. </p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/f93ad0fd-5a40-408a-9a98-d035d6457e87.jpg" style="width:42.83em;height:34.67em;" width="1229" height="994"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>VMs spread over five update domains and three fault domains</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Managed Disks</h1>
                </header>
            
            <article>
                
<p>Azure Managed Disks are the default disks selected when you create a VM in the Azure Portal. They handle storage for your virtual machines completely. Previously, you would have to manually create storage accounts to store VM hard disks, and when your VM needed to scale up, you have to add additional storage accounts to make sure you didn't exceed the limit of 20,000 IOPS per account.</p>
<p>With Managed Disks, this burden is now handled for you by Azure. You can now create 10,000 VM disks inside a subscription, which can result in thousands of VMs inside a subscription, without the need to copy disks between storage accounts.</p>
<div class="packt_tip packt_infobox">If you are still using Unmanaged Disks, it is highly recommended that you switch to Managed Disks. To convert your disks from Unmanaged to Managed, refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Disaster recovery</h1>
                </header>
            
            <article>
                
<p><span>Business continuity and disaster recovery is still key, even when you are deploying your virtual machines to the cloud. </span>Azure provides two different services for this: the <strong>Azure Backup Service</strong> and the <strong>Azure Site Recovery Service</strong>. Together, they address <span>disaster recovery needs natively in the cloud.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Backup and recovery</h1>
                </header>
            
            <article>
                
<p>Azure uses the Azure Backup Service to back up virtual machines. You can use this service to back up your Azure VMs as well as your on-premises VMs. You can also use it to extend your backup solution in a hybrid configuration or fully replace your on-premises backup solution with Azure Backup. The service can back up files, folders, VMs, applications, workloads, s<span>ystem states, and volumes.</span></p>
<p>Azure Backup consists of the following backup components:</p>
<ul>
<li><span><strong>Azure Backup (MARS) agent</strong>: This agent needs to be installed on a Windows Server VM (there is currently no support for Linux) that runs in Azure or resides on your on-premises infrastructure. You can use it to back up VMs, files, folders, and system states.</span></li>
<li><span><strong>Protection for system center Data Protection Manager (DPM) servers</strong>: You can use Azure Backup for a hybrid setup in conjunction with DPM servers. The DPM server can be deployed inside your on-premises data center or on a virtual machine in Azure. You can use it to store older data in the Azure Recovery Services Vault and use the disks for newer data, for instance.</span></li>
<li><span><strong>Azure Backup Server</strong>: This component is installed on an on-premises Windows server or a Windows VM in Azure. It offers backup support for Windows and Linux servers and it uses the Azure Recovery Services Vault to store backups.</span></li>
<li><span><strong>Azure IaaS VM backup</strong>: This consists of an agent that needs to be installed on your Azure VMs. These can be either Linux or Windows VMs. You cannot use this tool to back up your on-premises servers.</span></li>
</ul>
<p>When using the Azure Backup Service to back up your VM, most of the work will be in preparing the virtual machines. Your VM must meet the prerequisites before the backup can be <span>initiated to take snapshots from the virtual machines. First, you will need to create a <strong>Recovery Services Vault</strong> in Azure to store the backups. Then, the VM agent needs to be installed on the virtual machine. You also need to check your network connectivity at this point. When all the prerequisites have been met, you can back up your VMs to the Recovery Services Vault. These backups are easily created from the Azure Portal, PowerShell, or CLI. The snapshots are then stored inside the Recovery Services Vault, and from there you can also restore the snapshots. When restoring, you can choose to either restore the whole VM or only individual files or folders.</span></p>
<div class="packt_tip">The prerequisites for backing up virtual machines are described in detail in the following article: <a href="https://docs.microsoft.com/en-us/azure/backup/backup-azure-arm-vms-prepare">https://docs.microsoft.com/en-us/azure/backup/backup-azure-arm-vms-prepare</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating highly available virtual machines</h1>
                </header>
            
            <article>
                
<p>VMs can only be added to an an A<span>vailability Set by creation. When you want to add existing VMs to an Availability Set, this will result in recreating your VMs. This is something to be aware of when designing your solutions.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating highly available virtual machines from the Azure Portal</h1>
                </header>
            
            <article>
                
<p>Follow the given steps to create a VM from the Azure Portal:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
</ol>
<ol start="2">
<li>Click on <span class="packt_screen">New</span><span> </span><span>and, on the right-hand side, choose an image (or you can type an image name in the search bar). For this demo, we have selected the Windows Server 2016 VM image:</span></li>
</ol>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img src="Images/dad0756c-36fb-4fa6-a3b8-8ff192f9070b.png" style="width:46.00em;height:44.42em;" width="956" height="924"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Creating an Azure VM</div>
<ol start="3">
<li>A new blade opens up where you can fill in the basic settings of the VM. Add the following details and click on <span class="packt_screen">OK</span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-241 image-border" src="Images/ba6d94ca-70c1-4a46-86aa-ede9764a2205.png" style="width:35.67em;height:48.42em;" width="868" height="1177"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Filling in the basic settings</div>
<ol start="4">
<li>A new blade will open where you can choose the VM type and size. By default, only the recommended VMs are displayed, but you can choose to display all VMs by clicking on<span> </span><span class="packt_screen">View all</span> and then clicking on <span class="packt_screen">Select</span>, as shown in the following screenshot:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img style="text-align: center;color: #333333;font-size: 1em;width:47.50em;height:44.25em;" class="alignnone size-full wp-image-242 image-border" src="Images/5489c2ec-632c-4d8f-ab90-51f26b92405c.png" width="921" height="857"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Choosing your VM size</div>
<ol start="5">
<li class="mce-root"><span>A new blade opens up where you can configure additional options. Here, select <span class="packt_screen">Availability set</span> and then click <span class="packt_screen">Create new</span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/20d4ca89-282e-4ce3-9e72-4b78762ececc.jpg" style="width:48.58em;height:43.50em;" width="1887" height="1690"/>  </div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Creating a high Availability Set</div>
<ol start="6">
<li>By default, your VMs are assigned two fault domains and five update domains. Accept the default settings here and click on <span class="packt_screen">OK</span> twice when prompted.</li>
<li>The last blade opens up, which provides a summary with all the settings you've entered. Check the permission box.</li>
<li>Click on <span class="packt_screen">Create</span><span> </span>and<strong> </strong>your VM is now created. Next to the <span class="packt_screen">Create</span><strong> </strong>button, you should see a link where you can download the ARM template of this virtual machine. </li>
<li>Create the second VM and, instead of creating a new Availability Set, add the second VM to the Availability Set that we have already created using the previous steps.</li>
</ol>
<div class="packt_tip">You can download the ARM template of the configuration of the VM. This template can be used to deploy the second VM as well. There are a lot of templates available on GitHub that have been created by Microsoft and the community: <a href="https://azure.microsoft.com/en-us/resources/templates/">https://azure.microsoft.com/en-us/resources/templates/</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating highly available virtual machines from PowerShell</h1>
                </header>
            
            <article>
                
<p>VMs and Availability Sets can be created using PowerShell as well. Besides the traditional PowerShell, you can also use the <strong>Azure Cloud Shell</strong> to create your A<span>vailability Set</span>. By using the Azure Cloud Shell, you are basically using PowerShell from inside the browser. Inside the Azure Cloud Shell, Windows users can opt for PowerShell and Linux users can opt for Bash. You can open the Azure Cloud Shell from the Azure Portal, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-246 image-border" src="Images/8ac6cef6-b643-4a0f-a8f1-69782161b680.png" style="width:62.58em;height:36.75em;" width="1129" height="663"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span>Azure Cloud Shell<br/></span></div>
<p>To create two VMs and add them to an A<span>vailability Set</span>, add the following PowerShell statements to Azure Cloud Shell or Windows PowerShell (note that when using the Azure Cloud Shell, you don't have to log in):</p>
<pre><strong>Login-AzureRmAccount</strong></pre>
<p>If necessary, select the right subscription, shown as follows:</p>
<pre><span><strong>Select-AzureRmSubscription -SubscriptionId "********-****-****-****-***********"</strong><br/></span></pre>
<p>Create a resource group:</p>
<pre><strong><span class="hljs-pscommand">New-AzureRmResourceGroup</span><span class="hljs-parameter"> -Name</span><span> PacktPubPS</span><span class="hljs-parameter"> -Location</span><span> WestEurope</span></strong></pre>
<p>Now, create an Availability Set:</p>
<pre><strong>New-AzureRmAvailabilitySet -Location WestEurope -Name AvailabilitySet02 -ResourceGroupName PacktPubPS -Sku Aligned -PlatformFaultDomainCount 2 -PlatformUpdateDomainCount 2</strong></pre>
<p>Next, we need to create the two VMs and add them to the A<span>vailability Set. This is done by setting the <kbd>-AvailabilitySetId</kbd> parameter to the ID of the Availability Set. When running this script, you will be prompted for the username and password for your VM, as shown in the following snippet:</span></p>
<pre><strong>$availabilitySet = Get-AzureRmAvailabilitySet -ResourceGroupName PacktPubPS -Name AvailabilitySet02<br/><br/>$cred = Get-Credential -Message "Enter a username and password for the virtual machine."<br/><br/>$subnetConfig = New-AzureRmVirtualNetworkSubnetConfig -Name PacktSubnet -AddressPrefix 192.168.1.0/24<br/>$vnet = New-AzureRmVirtualNetwork -ResourceGroupName PacktPubPS -Location WestEurope -Name PacktVnet -AddressPrefix 192.168.0.0/16 -Subnet $subnetConfig<br/><br/>$nsgRuleRDP = New-AzureRmNetworkSecurityRuleConfig -Name PacktNetworkSecurityGroupRuleRDP -Protocol Tcp -Direction Inbound -Priority 1000 -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 3389 -Access Allow<br/><br/>$nsg = New-AzureRmNetworkSecurityGroup -Location WestEurope -Name PacktSecurityGroup -ResourceGroupName PacktPubPS -SecurityRules $nsgRuleRDP<br/><br/># Apply the network security group to a subnet<br/>Set-AzureRmVirtualNetworkSubnetConfig -VirtualNetwork $vnet -Name PacktSubnet -NetworkSecurityGroup $nsg -AddressPrefix 192.168.1.0/24<br/><br/># Update the virtual network<br/>Set-AzureRmVirtualNetwork -VirtualNetwork $vnet<br/><br/></strong></pre>
<pre><strong>for ($i=1; $i -le 2; $i++)<br/>{<br/> $pip = New-AzureRmPublicIpAddress -ResourceGroupName PacktPubPS -Location WestEurope -Name "$(Get-Random)" -AllocationMethod Static -IdleTimeoutInMinutes 4<br/><br/> $nic = New-AzureRmNetworkInterface -Name PacktNic$i -ResourceGroupName PacktPubPS -Location WestEurope -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id -NetworkSecurityGroupId $nsg.Id<br/><br/> # Specify the availability set<br/> $vm = New-AzureRmVMConfig -VMName PacktVM$i -VMSize Standard_D2_v3 -AvailabilitySetId $availabilitySet.Id<br/><br/> $vm = Set-AzureRmVMOperatingSystem -ComputerName myVM$i -Credential $cred -VM $vm -Windows -EnableAutoUpdate -ProvisionVMAgent<br/> $vm = Set-AzureRmVMSourceImage -VM $vm -PublisherName MicrosoftWindowsServer -Offer WindowsServer -Skus 2016-Datacenter -Version latest<br/> <br/> $vm = Add-AzureRmVMNetworkInterface -VM $vm -Id $nic.Id<br/> New-AzureRmVM -ResourceGroupName PacktPubPS -Location WestEurope -VM $vm<br/>}</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">VM Scale Sets</h1>
                </header>
            
            <article>
                
<p>VM Scale Sets are used for deploying multiple VMs at once without the need for manual actions or using scripts. You can then manage them all at once from a single place. VM Scale Sets are typically used to build large-scale infrastructures, where keeping all of your VMs in sync is key. The maintenance of VMs, including keeping them in sync, is handled by Azure.</p>
<p>VM Scale Sets use Availability Sets under the hood. VMs inside a scale set are automatically spread over the fault and update domains by the underlying platform. VM Scale Sets use Azure autoscale by default. You can, however, add or remove instances yourself instead of using autoscale.</p>
<p>When creating a scale set, a couple of artifacts are created for you automatically. As well as the number of VMs you have specified being added to the set, an <strong>Azure Load Balancer</strong> and <strong>Azure Autoscaling</strong> is added, along with a virtual network and a public IP:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-247 image-border" src="Images/64933d23-99da-41c1-81a5-67c7047b130a.png" style="width:58.25em;height:37.17em;" width="699" height="446"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Azure VM Scale Set architecture</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a VM Scale Set from the Azure Portal</h1>
                </header>
            
            <article>
                
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span><span> </span>and type in <kbd>Scale</kbd> in the search bar. Select <span class="packt_screen">Virtual machine scale set</span>.</li>
<li>In the next screen, click on <span class="packt_screen">Create</span> and add the following settings before clicking the <span class="packt_screen">Create</span> button:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="Images/ee555b4a-e64d-4408-b847-2343246cd6fa.jpg" style="width:43.00em;height:47.67em;" width="1524" height="1690"/><strong><br/></strong></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating a VM Scale Set</div>
<p><span>After creation, you can manage the VM Scale Set from the Azure Portal as well as from PowerShell and CLI.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Accessing your VM Scale Sets</h1>
                </header>
            
            <article>
                
<p>There are a number of ways to access your VM Scale Sets; they are as follows:</p>
<ul>
<li><strong>Connect to VM instances using RDP or SSH</strong>: To connect to VM instances using RDP or SSH, you can configure a scale set to automatically assign a public IP address. This option is turned off by default. The VMs are inside a virtual network, making it impossible to connect to them using RDP or SSH.</li>
<li><strong>Connect to VM instances using a jumpbox</strong>: You can create a standalone VM inside the same virtual network to act as a jumpbox to connect to another scale set instance in the set. The standalone VM gets a public IP address, which can be connected using RDP or SSH. Once connected to the VM, you can use it to connect to other instances using the internal IP address.</li>
<li><strong>Connect to VM instances using NAT rules</strong>: You can also connect to VM instances using NAT rules that are created inside the load balancer. Those NAT rules assign the instances to a different RDP port.</li>
<li><strong><span>Distribute i</span><span>ncoming traffic</span> using load balancing: </strong>Incoming traffic can be distributed across VM instances using the round-robin approach. You can use the Azure Load Balancer and the Azure Application Gateway for this, where the former provides layer-4 load balancing rules, and the latter layer-7 load balancing rules.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">VM Scale Set templates</h1>
                </header>
            
            <article>
                
<p>You can also deploy VM Scale Sets using ARM templates. ARM templates are a great way to deploy solutions automatically, and you can even embed customization and extensions inside the template. You can, for instance, install an application inside a container and deploy it within the VM instances during the deployment process of your scale set. </p>
<p>There are also ARM templates provided by Microsoft and the community that have already been configured for different architectures; these can be downloaded and deployed to create Azure scale sets, with extensions to manage the scale sets included. Some examples of templates are as follows:</p>
<ul>
<li><strong>Simple deployment of a VM Scale Set of Windows VMs behind a load balancer with NAT rules</strong>: <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-nat">https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-nat</a></li>
<li><strong>Simple deployment of a VM Scale Set of Linux VMs behind a load balancer with NAT rules</strong>: <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-nat">https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-nat</a></li>
</ul>
<ul>
<li><strong>Simple deployment of a VM Scale Set of Linux VMs with a jumpbox</strong>: <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-jumpbox">https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-linux-jumpbox</a></li>
<li><strong>Windows VM Scale Set with Application Gateway Integration</strong>: <a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-app-gateway">https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-windows-app-gateway</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Replication</h1>
                </header>
            
            <article>
                
<p><span>Azure Site Recovery Services offers a business continuity and disaster recovery solution from Azure by orchestrating and automating the replication of Azure VMs. It can replicate workloads and applications from a primary to a secondary location so that your VMs or applications are still up and running during a disaster. You can also easily fall back to the primary location when it is up and running again.</span></p>
<p>Azure Site Recovery Services offers the following features and capabilities:</p>
<ul>
<li><strong>Azure VM, on-premises VM, and workload replication</strong>: You can set up the <span>disaster recovery of Azure VMs from a primary region to a secondary region in Azure. You can replicate on-premises VMs and physical servers to Azure</span> <span>or to a secondary on-premises data center. You can replicate any workload from on-premises Hyper-V and VMware VMs, Windows/Linux physical servers, and Azure VMs.</span></li>
<li><strong>Data resilience</strong>: No application data is intercepted during replication. Data is stored in Azure storage, and during failover the VMs are created using data from Azure storage.</li>
<li><strong>Customized recovery plans</strong>: You can create customized recovery plans where you can group VMs together or add custom scripts or tasks.</li>
<li><strong>BDCR integration</strong>: You can integrate <span><span>Azure Recovery Services with other BDCR solutions as well.</span></span></li>
<li><strong>Network integration</strong>: Azure Recovery Services is integrated with networking features in Azure. You can <span>reserve IP addresses, configure load balancers, and integrate Azure Traffic Manager for network switchovers.</span></li>
<li><strong>Consistent apps</strong>: You can keep applications consistent during failovers using <span>recovery points with application-consistent snapshots. These snapshots can capture disk data, all data in memory, and all transactions in process.</span></li>
</ul>
<div class="packt_infobox">For more information about all the features that Azure Recovery Services provides, you can refer to <a href="https://docs.microsoft.com/en-us/azure/site-recovery/site-recovery-overview">https://docs.microsoft.com/en-us/azure/site-recovery/site-recovery-overview</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered the virtual machine objective. We covered the different sizes and series that are available from Azure. We also covered Availability Sets, fault and update domains, and how to create them. We also covered Managed Disks and we showed you how to create highly available VMs. We've talked about VM Scale Sets and when to use them, and finally we covered backup and recovery for your virtual machines.</p>
<p>The next chapter will cover compute-intensive applications using Azure services and Azure Batch. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p>Answer the following questions to test your knowledge of the information found in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book.</p>
<ol>
<li>Are Azure Managed Disks selected by default when creating a new virtual machine?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>If you want your virtual machines to be available when failure occurs in the underlying infrastructure, should you use Availability Sets?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>
<ol start="3">
<li>Are VMs spread over three fault domains, and four update domains when you add them to an Availability Set by default?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics covered in this chapter:</span></p>
<ul>
<li><strong>Managing the availability of Windows virtual machines in Azure</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability</a></li>
<li><strong>Example Azure infrastructure walkthrough for Windows VMs</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/infrastructure-example">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/infrastructure-example</a></li>
<li><strong>Planned maintenance for virtual machines in Azure</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/maintenance-and-updates">https://docs.microsoft.com/en-us/azure/virtual-machines/windows/maintenance-and-updates</a></li>
<li><strong>Virtual Machine Scale Sets Documentation</strong>:<a href="https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/"> https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/</a></li>
<li><strong>Using a custom Docker image for Web App for Containers</strong>: <a href="https://docs.microsoft.com/en-us/azure/app-service/containers/tutorial-custom-docker-image">https://docs.microsoft.com/en-us/azure/app-service/containers/tutorial-custom-docker-image</a></li>
<li><strong>Overview of the features in Azure Backup</strong>: <a href="https://docs.microsoft.com/en-us/azure/backup/backup-introduction-to-azure-backup">https://docs.microsoft.com/en-us/azure/backup/backup-introduction-to-azure-backup</a></li>
<li><strong>Backing up Azure virtual machines to a Recovery Services Vault</strong>: <a href="https://docs.microsoft.com/en-us/azure/backup/backup-azure-arm-vms">https://docs.microsoft.com/en-us/azure/backup/backup-azure-arm-vms</a></li>
<li><strong>Planing your VM backup infrastructure in Azure</strong>: <a href="https://docs.microsoft.com/en-us/azure/backup/backup-azure-vms-introduction">https://docs.microsoft.com/en-us/azure/backup/backup-azure-vms-introduction</a></li>
<li><strong>Site recovery</strong>: <a href="https://docs.microsoft.com/en-us/azure/site-recovery/site-recovery-overview">https://docs.microsoft.com/en-us/azure/site-recovery/site-recovery-overview</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>