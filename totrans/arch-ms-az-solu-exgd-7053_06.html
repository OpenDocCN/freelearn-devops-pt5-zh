<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Connecting Hybrid Applications</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the networking</span><span> objective. We covered how to design virtual networks in Azure and how to design solutions that use virtual networks. We also covered external connectivity for Azure VNets and how to design security strategies for networking solutions.</span></p>
<p class="mce-root">This chapter introduces the <span>designing connectivity for the hybrid applications</span> objective. It starts with how to <span>design connectivity to on-premises data from Azure applications using the different services that Azure provides.  </span></p>
<p>The following topics will be covered:</p>
<ul>
<li>Azure Relay service</li>
<li><span>Azure Data Management Gateway for Data Factory</span></li>
<li><span>Azure On-premises Data Gateway</span></li>
<li><span>Azure App Service H</span><span>ybrid Connections</span></li>
<li>Azure App Service Virtual Network Integration</li>
<li>Azure AD Application Proxy</li>
<li><span>Joining VMs to domains</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Relay service</h1>
                </header>
            
            <article>
                
<p>With Azure Relay services you can connect your on-premises application with a gateway in Azure, without <span>having to open a firewall connection or make any other big adjustments to your on-premises network. </span></p>
<p>You can create an Azure Relay service in the Azure Portal. Inside the Azure Relay service, a secure connection is created by using an outbound port and a bi-directional connection to your on-premises application. This connection is dedicated to one client and encrypted using <strong>Transport Layer Security</strong> (<strong>TLS</strong>). The on-premises application imports the Azure Relay namespace and makes a call to the Azure Relay service in the Azure Portal using access keys for authentication:</p>
<div class="CDPAlignCenter CDPAlign"><span><img class="alignnone size-full wp-image-470 image-border" src="Images/bafda8cd-e262-48a5-99a6-8cef2fe71a1f.png" style="width:37.67em;height:23.08em;" width="1023" height="627"/></span></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Azure Relay services</span></span></div>
<p><span>Azure Relay services support peer-to-peer traffic, one-way, request/response traffic, publish/subscribe scenarios, and bi-directional socket communication for increased point-to-point efficiency.</span></p>
<p>The difference of using Azure Relay services instead of using a VPN to create a hybrid connection, is that the Azure Relay service can be scoped to one application on a single machine instead of using one connection for all sorts of connection types.</p>
<p> Azure Relay services offer two features, hybrid connection and WCF Relays which are different implementations, but both share the same gateway. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Hybrid connections</h1>
                </header>
            
            <article>
                
<p>With hybrid connections a rendezvous point is established in the cloud. An application can then connect to this using HTTP and web sockets. You can use all programming languages that support web sockets, such as .NET Core, JavaScript, and NodeJS and multiple remote procedure models.</p>
<div class="packt_infobox">For more information about the Azure Relay hybrid connections protocol you can refer to the following website: <a href="https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-hybrid-connections-protocol">https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-hybrid-connections-protocol</a>.<br/>
For more information on how to get started with relay hybrid connections, you can refer to the following tutorial: <a href="https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-hybrid-connections-dotnet-get-started">https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-hybrid-connections-dotnet-get-started</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">WCF Relays</h1>
                </header>
            
            <article>
                
<p>WCF Relays (formerly Service Bus Relays) uses the .NET Framework and WCF to establish a connection and sending a message. The on-premises application uses WCF Relay bindings which creates WCF channels that integrate with the Azure Service Bus.</p>
<div class="packt_infobox">For more information on <span class="packt_screen">How to use Azure Relay WCF Relays with .NET</span>, you can refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-wcf-dotnet-get-started">https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-wcf-dotnet-get-started</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Data Management Gateway for Data Factory</h1>
                </header>
            
            <article>
                
<p>Azure Data Factory offers a data-integration service which you can use to create workflows that automate movement and transformation of data. With Data Factory, you can create data workflows <span>that can aggregate data from different data stores and transform and process data using Azure services, such as Azure Machine Learning, Azure HDInsight Hadoop, and Azure Data Lake Analytics and Output data to different data stores.</span></p>
<p><span>Azure Data Management Gateway for Data Factory acts as a bridge to connect your on-premises to the cloud. It consists of a client agent which is installed on the on-premises system and which then connects to Azure Data Factory. This agent copies your data to the cloud. The gateway can be scaled out by installing the agent on multiple on-premises environments and increasing the data movement jobs that can run simultaneously on a node. Data is processed in parallel using the jobs.</span></p>
<p>You don't have to open firewall ports to copy the data. It sends data securely over HTTP using certificates. It also offers a monitoring and management feature from Azure Data Factory in the Azure Portal.</p>
<div class="packt_infobox">Azure Data Management Gateway for Data Factory supports a variety of data sources which are listed here: <a href="https://docs.microsoft.com/en-us/azure/data-factory/v1/data-factory-data-movement-activities#supported-data-stores-and-formats">https://docs.microsoft.com/en-us/azure/data-factory/v1/data-factory-data-movement-activities#supported-data-stores-and-formats</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure On-premises Data Gateway</h1>
                </header>
            
            <article>
                
<p><span>The Azure On-premises Data Gateway acts as a bridge between your on-premises data sources and Azure. It can connect to a number of Azure services, such as </span><span>Azure Analysis Services, </span><span>Azure Logic Apps, Microsoft Flow, Power Apps, and Power BI. For the on-premises side, there are a number of products which can be connected to the gateway, such as SQL Server, SQL Analysis Services, SharePoint, and more.</span></p>
<div class="packt_infobox">For an overview of the on-premises data sources that are supported for the Azure On-premises Data Gateway, you can refer to the following website: <a href="https://docs.microsoft.com/en-us/azure/analysis-services/analysis-services-datasource">https://docs.microsoft.com/en-us/azure/analysis-services/analysis-services-datasource</a>.</div>
<p>To use the <span>Azure On-premises Data Gateway, a client needs to be installed on the on-premises environment. This client consists of a Windows service which is responsible for setting up the connection with Azure. In Azure, a Gateway Cloud Service needs to be created. The client then communicates with the Gateway Cloud Service using the Azure Service Bus.</span></p>
<p>When a request for data is created by one of the Azure services, The c<span>loud g</span>ateway service creates a query and encrypts the on-premises credentials. This query and the credentials are then sent to a queue inside the gateway. The gateway then sends the query to the Azure Service Bus. </p>
<p>The on-premises client polls the Azure Service Bus regularly and when a message is waiting inside the Service Bus, it decrypts the credentials from the on-premises data source and then runs the query on it to retrieve the data.</p>
<p>The data is returned to the Gateway Cloud Service by using the Azure Service Bus again. The Gateway Cloud Service is responsible for routing the data between the different Azure services.</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-471 image-border" src="Images/cd044dac-3e2b-4f75-bcbd-42ff67b33569.png" style="width:30.58em;height:33.75em;" width="1010" height="1116"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Azure On-premises Data Gateway architecture</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure App Service Hybrid Connections</h1>
                </header>
            
            <article>
                
<p>Azure App Service Hybrid Connections is both part of the Azure App Service and is a separate feature in Azure. It uses the Azure Relay service to establish a connection between applications that are hosted in Azure and applications that are hosted in your on-premises environment. It creates an application endpoint in the cloud which your app can connect to. It uses the Azure Relay services to establish the connection.</p>
<p>The hybrid connection manager connects to the Azure Relay service, and the application itself connects to the Azure Relay services as well. Azure Relay services is then responsible for setting up a TCP tunnel over which they both can safely communicate. By using the TCP connection, you don't have to open a firewall port on the on-premises server.</p>
<p>Inside Azure App Service, a hybrid connection is created to access application resources on the on-premises environment. You can create a hybrid connection from the Azure Relay service but it is best to create the connection from within the app settings in Azure:</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-472 image-border" src="Images/facdde79-fe5d-4db6-a379-8b73509a874c.png" style="width:38.50em;height:40.83em;" width="1280" height="1356"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Azure App Service Hybrid Connections settings</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure App Service Virtual Network Integration</h1>
                </header>
            
            <article>
                
<p>You can use the Azure App Service Virtual Network Integration to deploy your application inside a VNet. This enables access from your application to other services, VMs, or databases that are deployed inside the same VNet as well.</p>
<p>To establish the connection from your application to the VNet, Azure App Service VNet integration uses a point-to-site VPN with a dynamic routing gateway. By using the point-to-site type of VPN connection, there is only one connection created for the VM on which your app is hosted. Other resources that are deployed inside the same App Service plan, are not connected. When you want to set up a connection for that resources as well, you have to set up a separate point-to-site VPN connection for each resource that resides in the App Service plan.</p>
<p>This point-to-site VPN connects to an Azure VPN Gateway, which is connected to the VNet. When a VNet is connected to your on-premises network using the Azure VPN Gateway and a site-to-site VPN, you can use the connection to connect the resource with the resources which reside in the on-premises network as well.</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/ce2a7aec-b64c-41fe-9942-609b1e6829c6.jpg" style="width:29.58em;height:24.75em;" width="948" height="794"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><span>Azure App Service VNet Integration.</span></span></div>
<p>App VNet Integration supports communication over UDP and TCP. You can connect to the App by using it's private IP address. Public IP addresses don't have to be created for your App. They can be accessed by their private IP address by all the services that are deployed inside the same VNet. </p>
<p><span>The VNet Integration can be used for apps that use the Basic, Standard, or Isolated App Service plans. Inside the App Service plan, you can create up to five VNets. However, you can only assign your application to one VNet at a time.</span></p>
<p>VNet Integration can be set up from the App Settings in the Azure Portal under <span class="packt_screen">Networking</span>:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/6f4ea2d2-f700-475a-a0b2-c07a72063d92.jpg" style="width:37.75em;height:37.92em;" width="1642" height="1650"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Azure App Service VNet integration from the Azure Portal</span></span></div>
<div class="packt_infobox">Another way for VNet Integration for your App is by using an <strong>Application Service Environment</strong> (<strong>ASE</strong>), which is described in <a href="de2f1b21-edb1-4616-a8ff-8fbf484459a0.xhtml" target="_blank">Chapter 3</a>, <em>Designing Web Applications</em>. An ASE is deployed inside a VNet as well.</div>
<div>
<p>There are some constraints when using VNet Integration for your apps. VNet Integration cannot enable private site access for your app. Private site access makes your app only <span>accessible from resources inside the same virtual network. </span>Private site access can only be accomplished using an Application Service Environment configured with an <strong>Internal Load Balancer</strong> (<strong>ILB</strong>).</p>
</div>
<div class="packt_infobox">
<div>For more information on how to create an ASE with an ILB, you can refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/app-service/environment/create-ilb-ase">https://docs.microsoft.com/en-us/azure/app-service/environment/create-ilb-ase</a>.</div>
</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure AD Application Proxy</h1>
                </header>
            
            <article>
                
<p>With the Azure Active Directory Application Proxy, you can access on-premises web applications from the cloud. It provides <strong>Single Sign On</strong> (<strong>SSO</strong>) and secure remote access for your web applications. Applications are integrated with Azure Active Directory and published through the Azure Portal. You don't have to make any adjustments to your on-premises network or use a VPN connection to use the Azure AD Application Proxy for your applications. </p>
<p>The type of applications that can work with Azure AD Application Proxy, are <span>web APIs, </span>web applications that use integrated Windows Authentication for authentication, use form-based or header-based access, applications <span>integrated with the <strong>Active Directory Authentication Library</strong> (<strong>ADAL</strong>), and applications hosted behind a remote desktop gateway.</span></p>
<p>Azure AD Application Proxy uses two <span>components that need to be configured:</span></p>
<ul>
<li><strong>Connector</strong>: The connector is a lightweight <span><span>agent that needs to be installed inside the on-premises network on a Windows Server. It facilitates the network connection between your on-premises application and the Application Proxy service in Azure. It only uses outbound connections, so you don't have to install it in a DMZ or  open any inbound ports.</span></span></li>
<li><strong>External endpoint</strong>: The external endpoint is how your users access the web application. This can be an direct URL or this can be accessed from the MyApps portal. Users authenticate with Azure AD and then they are routed to the on-premises application, <span>through the connector.</span></li>
</ul>
<div class="packt_infobox">The MyApps portal can be accessed using the following URL: <a href="https://myapps.microsoft.com">https://myapps.microsoft.com</a>. It offers a web portal where all users who have a Azure AD account, can view and launch the applications to which they have been granted access.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Joining VMs to domains</h1>
                </header>
            
            <article>
                
<p>The last way for creating hybrid applications is by joining an Azure VM to an on-premises domain. You can connect an Azure Virtual Machine, which has your application deployed in it for instance, with an on-premises domain using <span>Azure AD Domain Services. To set up this connection, you don't have to install and manage a domain controller in Azure. </span></p>
<p>Azure AD Domain Services is a feature which can be enabled inside your Azure subscription. It creates a managed domain which is fully integrated with the Azure AD tenant and available inside Azure VNets. On-premises VMs and Azure VMs can then join this managed domain and use the usernames, passwords, and group memberships from Azure AD to log in or authenticate. Applications that are deployed inside these VMs can benefit from this as well. </p>
<p>Azure AD Domain Services provides group policies, LDAP and Kerberos/NTLM authentication' which is compatible with Windows Server Active Directory. You can use this feature for cloud-only Azure AD tenants and for hybrid Azure AD tenants, where the on-premises identities are synced with Azure using Azure AD Connect.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Enabling Azure AD Domain Services</h1>
                </header>
            
            <article>
                
<p>To enable Azure AD Domain Services inside your Azure tenant, you can take the following steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span> and type <kbd>Azure AD Domain Services</kbd><strong> </strong>in the search bar.</li>
</ol>
<ol start="3">
<li>Azure AD Domain Services is automatically mapped to your Azure AD tenant, so the only thing you have to specify in the next blade is the resource group and the location and click <span class="packt_screen">OK</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img style="text-align: center;font-size: 1em;width:35.50em;height:41.08em;" class="alignnone size-full wp-image-473 image-border" src="Images/b40624cf-ab90-4549-a100-54908eb6ea3b.png" width="1234" height="1430"/></div>
<div class="CDPAlignCenter CDPAlign">
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Enable Azure AD Domain Services</span></span></div>
</div>
<ol start="4">
<li>In the next blade, you can create a new VNet or associate Azure AD Domain Services with a VNet. Note that it is recommended to create a separate subnet for it and click <span class="packt_screen">OK</span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/2606ae25-bbc8-40d2-9bec-df013a266665.png" style="width:34.75em;height:40.25em;" width="958" height="1111"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Set VNet</div>
<ol start="5">
<li>There is automatically a group created called <span class="packt_screen">AAD DC Administrators</span>. You can add users to this group in here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/73ab4bcb-5b00-4f94-ab6e-46b939c995dc.jpg" style="width:56.83em;height:33.50em;" width="2424" height="1428"/><br/>
<br/>
<span><span>Add administrators</span></span></div>
<ol start="6">
<li class="mce-root"><span>The last blade provides a summary of the settings. Click on </span><span class="packt_screen">OK</span> <span>to create the service:</span></li>
</ol>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img src="Images/d9c47745-58d9-4372-b2ee-b4b7a03e6565.jpg" style="width:46.50em;height:37.00em;" width="1798" height="1432"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Summary</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Adding the VM to the managed domain</h1>
                </header>
            
            <article>
                
<p>Next is to add a VM to the managed domain which is created in the previous step:</p>
<ol>
<li>Open a VM, which was created earlier, from the Azure Portal or create a new VM. Make sure the VM is deployed in the same VNet as the Azure AD Domain Service (but in a separate subnet). </li>
<li>Start the VM, connect to it and log in using the credential you provided when the VM was created.</li>
<li>Open <span class="packt_screen">Server Manager</span> | <span class="packt_screen">Local Server</span> and click on <span class="packt_screen">WORKGROUP</span>, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-475 image-border" src="Images/d7c26ec5-ca3c-4fd1-8096-ef07c9bcd140.png" style="width:166.58em;height:102.92em;" width="1999" height="1235"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Local Server settings</span></div>
<ol start="4">
<li>Add the name of <span>the managed domain of Azure AD Domain Services and add the VM to it.</span></li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered the designing connectivity for hybrid applications objective. We covered the different services that Azure offers for connecting on-premises applications, data, and services with Azure. You should now know, when to use the different features inside your own solutions and architectures. </p>
<p>The next chapter will focus on the different storage solutions that Azure offers.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book.</p>
<ol>
<li><span>You want to use Azure App VNet Integration to secure your application from outside access. Will this work?</span>
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You want to connect your on-premises domain with Azure Active Directory as easy as possible. Can we use Azure Active Directory Domain Services for this without using Azure AD Connect?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Can we add applications deployed in Azure App Services to a VNet?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that are covered in this chapter:</span></p>
<ul>
<li><strong>What is Azure Relay?</strong>: <a href="https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-what-is-it">https://docs.microsoft.com/en-us/azure/service-bus-relay/relay-what-is-it</a></li>
<li><strong>Service Bus Relay Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/service-bus-relay/">https://docs.microsoft.com/en-us/azure/service-bus-relay/<br/></a></li>
<li><strong>Data Management Gateway</strong>: <a href="https://docs.microsoft.com/en-us/azure/data-factory/v1/data-factory-data-management-gateway">https://docs.microsoft.com/en-us/azure/data-factory/v1/data-factory-data-management-gateway</a></li>
<li><strong>Connecting to on-premises data sources with Azure On-premises Data Gateway</strong>: <a href="https://docs.microsoft.com/en-us/azure/analysis-services/analysis-services-gateway">https://docs.microsoft.com/en-us/azure/analysis-services/analysis-services-gateway</a></li>
<li><strong>Azure App Service Hybrid Connections</strong>: <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections">https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections.</a></li>
<li><strong>How to provide secure remote access to on-premises applications</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-application-proxy-get-started">https://docs.microsoft.com/en-us/azure/active-directory/active-directory-application-proxy-get-started</a></li>
<li><strong>Join a Windows Server virtual machine to a managed domain</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-join-windows-vm-portal">https://docs.microsoft.com/en-us/azure/active-directory-domain-services/active-directory-ds-admin-guide-join-windows-vm-portal</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>