<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Robust Networking Implementations</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered the serverless and microservices</span><span> objectives. We covered how to design serverless computing and which features Azure provides for creating them. We also covered microservices-based solutions, and the differences between all the different Azure features and when to use them.</span></p>
<p class="mce-root">This chapter introduces the networking objectives. It starts with how to design Azure Virtual Networks. This consists of designing solutions that use Azure networking services, such as designs for load balancing using Azure Load Balancer and Azure Traffic Manager, defining DNS, DHCP, and IP strategies, determining when to use Azure Application Gateway, and when to use multi-node application gateways, Traffic Manager, and Load Balancers.</p>
<p>After that, it covers designing external connectivity for Azure Virtual Networks. In this chapter, you will learn how to determine when to use Azure VPN, ExpressRoute, virtual network peering architecture, when to use <strong>User Defined Routes</strong> (<strong>UDRs</strong>), and when to use VPN gateway site-to-site failover for ExpressRoute.</p>
<p>Lastly, this chapter covers how to design security strategies by determining when to use network virtual appliances, how to design a perimeter network (DMZ), and determine when to use a <strong>Web Application Firewall</strong> (<strong>WAF</strong>), <strong>Network Security Group</strong> (<strong>NSG</strong>), and virtual network service tunneling.</p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Designing <span>Azure Virtual Networks</span></li>
<li><span>When to use Azure Application Gateway</span></li>
<li><span>When to use multi-node application gateways, Azure Traffic Manager, and Load Balancers</span></li>
<li><span>Designing external connectivity for Azure Virtual Networks</span></li>
<li><span>Designing security strategies</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for the examples:</p>
<ul>
<li>Azure PowerShell: <a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1">https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.1.1</a></li>
</ul>
<p><span>The source code for this chapter can be downloaded here:</span></p>
<ul>
<li><a href="https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%205">https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%205</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Virtual Network</h1>
                </header>
            
            <article>
                
<p>An <strong>Azure Virtual Network</strong> (<strong>VNet</strong>) is a virtual representation of a traditional network, hosted in the cloud. It is totally software-based, where traditional networks use cables, routers, and more. VNets provide a secure and isolated environment and they connect Azure resources with each other. By default, the different resources are not reachable from outside of the virtual network. You can, however, connect multiple VNets to each other or connect a VNet to your on-premises network as well. All the Azure resources that are connected inside the same VNet must reside in the same region and subscription.</p>
<p>When you create a VNet, one subnet is automatically created as well. You can create multiple subnets inside the same VNet (there is a maximum of 1000 subnets allowed per VNet). Connecting multiple VNets to each other is called <strong>virtual network peering</strong>. There is a maximum of 10 peerings allowed per Azure subscription. </p>
<p>The smallest subnet that can be used in Azure is the /29 subnet, which consists of eight addresses and the largest is /8, <span>which consists of 16 million addresses.</span></p>
<div class="packt_tip packt_infobox">For more information on subnetting, you can refer to the Subnet Mask Cheat Sheet: <a href="https://www.aelius.com/njh/subnet_sheet.html">https://www.aelius.com/njh/subnet_sheet.html</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">IP addresses</h1>
                </header>
            
            <article>
                
<p>A virtual network in Azure can have private and public IP addresses. Private IP addresses are only accessible from within the virtual network and public IP addresses can be accessed from the internet as well. You can access private IP addresses from a VPN Gateway or an ExpressRoute connection. Both private and public IP addresses can be static or dynamic, but when you create a new VNet, the IP address is static by default. You can change the IP address to static from the Azure Portal, PowerShell, and CLI.</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-450 image-border" src="Images/bb8a5384-a8a3-4dff-958c-d8a7df199da1.png" style="width:114.42em;height:45.67em;" width="1373" height="548"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Dynamic and static IP address configuration in the Azure Portal</div>
<ul>
<li><strong>Dynamic</strong>: Dynamic IP addresses are assigned by Azure automatically and are selected from the configured subnet's address range from the virtual network where the Azure resource resides. The IP address is assigned to the Azure resource upon creation or start. The IP address will then be released when the resource is stopped and deallocated (when you stop the VM from the Azure Portal, the VM is deallocated automatically as well) and added back to the pool of available addresses inside the subnet by Azure. </li>
<li><strong>Static</strong>: Static IP addresses (private and public) are pre-assigned and will remain the same until you delete the assignment. You can select a static private IP address manually. They can only be assigned to non-internet facing connections, such as an internal Load Balancer. You can assign a private IP address to a connection to your on-premises network or to an ExpressRoute circuit as well. Public static IP addresses are created by Azure automatically and they can be assigned to internet facing connections, such as an external Load Balancer. </li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Public IP address</h1>
                </header>
            
            <article>
                
<p>Public IP addresses can be used for internal communication between Azure services and external communication over the internet. You can use IPv4 and IPv6 for public IP addresses, but the support for IPv6 is limited. At the time of writing, you can only assign IPv6 addresses to external Load Balancers. </p>
<p>Azure assigns the public IP address to the network interface when the Azure resource is started or created. When a outbound connection is initiated, Azure will map the private IP address to the public IP address (SNAT). Return traffic to the resource is allowed as well.</p>
<p><span>Public IP addresses are typically used for VMs, internet-facing Load Balancers, VPN gateways, and application gateways. There is a maximum of 60 dynamic public IP addresses and 20 static public IP addresses per subscription. The first five static IP address are free, the rest have a cost.<br/></span></p>
<div class="packt_tip packt_infobox">The following document is beyond the scope of this book, but definitely interesting—<em>Understanding outbound connections in Azure</em>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections?toc=%2fazure%2fvirtual-network%2ftoc.json">https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections?toc=%2fazure%2fvirtual-network%2ftoc.json</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Private IP address</h1>
                </header>
            
            <article>
                
<p>Private IP addresses support IPv4 and IPv6 as well, but support for IPv6 is also limited. They can only be assigned dynamically and IPv6 addresses cannot communicate with each other inside a VNet. The only way to use IPv6 addresses is by assigning them to an internet-facing Load Balancer, where the frontend IP address is an IPv4 address and the backend is an IPV6 address. </p>
<p><span>Private IP addresses are typically used for VMs, internal Load Balancers, and application gateways. A VPN cannot have a private IP address because it is always internet-facing. </span>There is a maximum of 4096 private IP addresses per VNet. You can, however, create multiple VNets (50 per subscription). </p>
<div class="packt_infobox">These limits are based on the default limits from the following page: <a href="https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits?toc=%2fazure%2fvirtual-network%2ftoc.json#networking-limits">https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits?toc=%2fazure%2fvirtual-network%2ftoc.json#networking-limits</a>. You can open a support request to raise the limits. The limits can't be raised above the maximum limit, as described in the limit table.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a public IP address</h1>
                </header>
            
            <article>
                
<p>In the following example, we are going to create a static public IP address using PowerShell:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Open the Azure Cloud Shell and make sure PowerShell is selected.</li>
<li>Add the following command:</li>
</ol>
<p style="color: black;padding-left: 60px">If necessary, select the right subscription:</p>
<pre style="color: black;padding-left: 60px"><strong>Select-AzureRmSubscription -SubscriptionId "********-****-****-****-***********"</strong></pre>
<p style="padding-left: 60px" class="mce-root"><span>Create the IP address:</span></p>
<pre style="color: black;padding-left: 60px"><strong>New-AzureRmPublicIpAddress -Name PublicPacktIP -ResourceGroupName PacktPub -AllocationMethod Static -Location "West Europe"</strong></pre>
<ol start="4">
<li>This is the easiest way to create a static IP address. However, you still have to assign it to a Azure resource. It is only created now. I've used an existing resource group for this example. If you don't have one, you need to create it before creating the IP address.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">DNS</h1>
                </header>
            
            <article>
                
<p>Besides IP addresses, VMs can also be addressed by using hostnames or <strong>fully qualified domain names</strong> (<strong>FQDN</strong>). You can configure a DNS label for this on a public IP address. For Azure services that are all hosted inside the same VNet, Azure internal DNS can be used for name resolving. If you want to use DNS for multiple VNets, you have to set up your own DNS server. For instance, if you add the DNS label <kbd>packtuniquedns</kbd>, the FQDN will become <span class="packt_screen">packtuniquedns.westeurope.cloudapp.azure.com</span>. This FQDN will then map to the public IP address of the Azure resource.</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/9761561e-d4f5-4a9f-97ee-bd078ea86f83.jpg" style="width:50.00em;height:19.83em;" width="2601" height="1034"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Built-in DNS name resolving</div>
<p class="mce-root">You can point your DNS to the Azure resource by adding a CNAME record as well. So instead of using the default DNS suffix, you can use Azure DNS to assign a custom hostname to the resource. If you want your Azure resource to be reached with a hostname without the <kbd>www</kbd> prefix, you need to add an A record. CNAME will only work with the <kbd>www</kbd> prefix.</p>
<div class="packt_tip packt_infobox">For more information on this, you can refer to the following articles—<em>Create a fully qualified domain name in the Azure Portal for a Linux VM</em>: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/portal-create-fqdn">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/portal-create-fqdn</a> and <em>Use Azure DNS to provide custom domain settings for an Azure service</em>: <a href="https://docs.microsoft.com/en-us/azure/dns/dns-custom-domain?toc=%2fazure%2fvirtual-network%2ftoc.json#public-ip-address">https://docs.microsoft.com/en-us/azure/dns/dns-custom-domain?toc=%2fazure%2fvirtual-network%2ftoc.json#public-ip-address</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a VNet with two subnets</h1>
                </header>
            
            <article>
                
<p class="mce-root CDPAlignLeft CDPAlign">In this example, we are going to create a VNet with two subnets from the Azure Portal. You can use PowerShell, CLI, and an ARM template as well. We are going to create a VNet and subnets according to the following diagram:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/5c3360aa-ebf1-45ef-9bbd-3a52ded71f39.png" style="width:39.83em;height:27.08em;" width="970" height="660"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">A VNet with two subnets</div>
<p>Take the following steps to create the VNet:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span><span> </span><span>and type</span> <kbd>virtual network</kbd> <span>in the search bar to create a new virtual network:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/6eeb8780-d483-40dd-9582-3ab1880f233c.jpg" style="width:34.92em;height:41.92em;" width="1162" height="1395"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Creating a new virtual network</div>
<ol start="3">
<li>A new blade opens up, where you can fill in the settings. Add the following values:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><span><img class="alignnone size-full wp-image-452 image-border" src="Images/b1947b66-332a-400b-a827-803d933934fa.png" style="width:19.42em;height:45.75em;" width="606" height="1429"/></span></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><span>VNet and subnet settings</span></span></div>
<ol start="4">
<li>Click on <span class="packt_screen">Create</span>. You can only create one subnet when creating a VNet from the Azure Portal. So, the second one needs to be added after creating the VNet.</li>
<li>Go to the VNet <span class="packt_screen">Settings</span> and choose <span class="packt_screen">Subnets</span> from the left-hand menu and click <span class="packt_screen">+ Subnet</span> in the top menu, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-453 image-border" src="Images/59ebdf64-0c4b-476f-aeb1-a9d47bd7749a.png" style="width:136.58em;height:76.25em;" width="1639" height="915"/><span><br/></span></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Adding a second subnet</div>
<ol start="6">
<li>A new blade will open up. Enter the following values and click on <span class="packt_screen">OK</span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-454 image-border" src="Images/faf67320-4bd8-4cc3-82d5-c59f8699a03b.png" style="width:31.33em;height:39.17em;" width="989" height="1237"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Second subnet settings</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Load Balancer</h1>
                </header>
            
            <article>
                
<p>Azure Load Balancer is a Load Balancer which can be used for VMs, containers, and apps. It works at the transport layer (layer four in the OSI network reference stack) by distributing network traffic in the same Azure data center. It offers an external and an internal Load Balancer.</p>
<p>The external Load Balancer provides a single endpoint with a public IP address that is called by all client applications and services, and then distributes the incoming traffic over multiple healthy VMs, containers, or apps to provide scaling, high availability, and performance. The internal Load Balancer has the same features as the external, but it uses a private IP address.</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/afbd59bb-d956-4461-98a3-0fec6dce30a7.png" style="width:30.42em;height:20.25em;" width="999" height="665"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>External and internal Load Balancer<br/></span></div>
<p>There are two versions of Azure Load Balancer:</p>
<ul>
<li><strong>Basic</strong>: The basic Load Balancer is free to use. It can be configured as an internet-facing Load Balancer, as an internal Load Balancer, and it can forward traffic to a specific VM. For the internet-facing Load Balancer, the public IP address is mapped to the private IP address by the Load Balancer. When traffic comes in, Azure distributes it to the Azure resource by using the internal IP address.<br/>
It offers hashed-based distribution, port forwarding, automatic <span>reconfiguration when you scale down or up, service monitoring, and source NAT.</span><span><br/></span></li>
<li><strong>Standard</strong>: At<span> the time of writing, the standard Load Balancer is still in preview. On top of all the features that the basic Load Balancer offers, the standard version offers enterprise scale. You can use standalone VMs or VMs up to 1000 instances using the standard Load Balancer. It also offers diagnostic insights for public and internal Load Balancer configurations, high reliability by using HA ports, and rules for individual ports. You can use NSGs (which we will discuss later in this chapter) and availability zones.</span></li>
</ul>
<div class="packt_infobox">For more information on the standard Load Balancer, you can refer to the following article: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-standard-overview">https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-standard-overview</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Probes</h1>
                </header>
            
            <article>
                
<p>The Azure Load Balancer uses probes to define the health of your servers and services that are leveraging the Load Balancer. There are two different types of probes: the HTTP and the TCP Probe.</p>
<p>For cloud services (such as VMs, web apps, APIs, and more), it uses a <strong>guest agent probe</strong>. In this scenario, there is a guest agent installed on your VM that responds with an HTTP 200 OK response. Every 15 seconds, the Load Balancer sends a message to the cloud service to which the agent responds. You can also create a custom HTTP Probe with your own logic that overrrides the  logic of the default guest agent. The TCP Probe uses a three-way handshake to set up the connection.</p>
<p>When health logging is enabled, the data is stored in an Azure storage account. You can view this log data by using different Azure tools, such as PowerShell or CLI, the REST API, or the Azure Portal. You can also use Power BI to visualize and analyze the data using pre-defined dashboards provided by the <em>Azure Audit Logs content pack for Power BI</em>.</p>
<div class="packt_infobox">For more information and to download the Azure Audit Logs content pack for Power BI, you can refer to <a href="https://docs.microsoft.com/en-us/power-bi/service-connect-to-azure-audit-logs">https://docs.microsoft.com/en-us/power-bi/service-connect-to-azure-audit-logs</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Traffic Manager</h1>
                </header>
            
            <article>
                
<p>Azure Traffic Manager spreads the workload over multiple regions and data centers in the world. It will handle the load and locate the <span>closest geographical region or most suitable region at the DNS level. The client makes a DNS request and, based on the location of the </span><span>DNS, Azure Traffic Manager will locate the nearest region in Azure and sends that location back to the client via a DNS response. The client then calls the location directly, without any further interference of Azure Traffic Manager. Traffic Manager also monitors the endpoints, so in case of a failure inside one region, the Traffic Manager will send back the endpoint of a different healthy region.</span></p>
<p><span>This differs from the Azure Load Balancer, where the client calls the IP address of the Load Balancer and the Load Balancer distributes the traffic over multiple cloud services, such as VMs, containers, or web apps. Also, the Azure Load Balancer spreads traffic over multiple instances in the same region and data center, whereas Traffic Manager can span over multiple regions and data centers.</span></p>
<p><span>You can use both the Azure Load Balancer and Azure Traffic Manager in a highly available and high-performing architecture, such as the one shown in the following diagram:</span></p>
<div class="CDPAlignCenter CDPAlign"><span><img class="alignnone size-full wp-image-456 image-border" src="Images/4a3baf05-758b-4913-a977-ee22896a672e.png" style="width:38.17em;height:25.92em;" width="1760" height="1198"/></span></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Azure Traffic Manager</span></div>
<div class="packt_tip"><span>Azure Traffic Manager was also discussed in <a href="de2f1b21-edb1-4616-a8ff-8fbf484459a0.xhtml" target="_blank">Chapter 3</a>, <em>Designing Web Applications</em>, in the section about high availability and performance for your web apps. </span>The different routing methods that are available for Azure Traffic Manager are also described there.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Application Gateway</h1>
                </header>
            
            <article>
                
<p>The Azure Application Gateway offers an <strong>Application Delivery Controller</strong> (<strong>ADC</strong>), which operates on the application layer (layer seven in the OSI network reference stack).</p>
<p>It provides web load balancing, so it provides load balancing on layer seven, which is for HTTP(S) only. It also provides a web application firewall, which can be leveraged to protect your apps from common web-based attacks, such as cross-site scripting, SQL injection, and session-hijacking (this is described in more detail in the <em>Network Security Strategies</em> section in this chapter). It can decrypt HTTPS traffic, so you can install your SSL certificates on the application gateway instead of onto the different web servers. This way, the web servers don't have to take care of this and management will be easier because it is all in one place. Application Gateway will then encrypt the response before it is sent back to the client. It can also provide URL-based content routing, so traffic can be routed to specific backends. For example, a call to a CDN that is hosted on a dedicated backend can be called directly, which reduces unnecessary routing. It also provides health monitoring and advanced diagnostics.</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/1e5bfc48-a3df-49fd-b4f5-f1a46075da6d.png" style="width:31.25em;height:25.33em;" width="781" height="634"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Azure Application Gateway</span></div>
<div class="packt_infobox">For more information on Azure Application Gateway and the different features, you can refer to <a href="https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview">https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview</a>. This page also gives an overview of all the differences between the Azure Load Balancer, Azure Traffic Manager, and the Azure Application Gateway.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">External connectivity for Azure Virtual Networks</h1>
                </header>
            
            <article>
                
<p>The cloud is becoming more popular everyday, but for the next few years, most organizations will still have an on-premises infrastructure that will be used and maintained. In fact, some organizations will never move to the cloud completely because of business requirements or some sort of legacy system that is still in use and cannot be moved for some reason or other. Also, security requirements could be a reason for keeping a part of your data on-premises. So, there will always be a need for hybrid environments. From a networking perspective, Azure offers various features to set up seamless connections from your on-premises infrastructure to Azure and vice versa.  </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure VPN</h1>
                </header>
            
            <article>
                
<p>Azure VPN provides a secure gateway that can be used to connect your on-premises <span>infrastructure with </span>Azure and to connect multiple VNets with each other by sending an encrypted message from one location to the other. Most organizations use VPN connections to let remote workers connect to their private network. </p>
<p>Azure VPN offers multiple ways to set up a secure connection, such as site-to-site VPN, point-to-site VPN, and ExpressRoute. They are described in the following sections. When setting up an Azure network gateway for one of these connection types, you have to choose between the different SKUs that Azure offers. Azure VPN offers the following SKUs:</p>
<ul>
<li><strong>Basic</strong>: Provides a maximum of 10 s<span>ite-to-site</span>/VNet-to-VNet tunnels and a maximum of 128 point-to-site connections. The average bandwidth is <span>100 Mbps.</span></li>
<li><strong>VpnGw1</strong>: Provides a maximum of 30 s<span>ite-to-site</span>/VNet-to-VNet tunnels and a maximum of 128 point-to-site connections. The average bandwidth is 650 Mbps.</li>
<li><strong>VpnGw2</strong>: Provides a maximum of 30 s<span>ite-to-site</span>/VNet-to-VNet tunnels and a maximum of 128 point-to-site connections. The average bandwidth is <span>1 Gbps</span>.</li>
<li><strong>VpnGw3</strong>: Provides a  maximum of 30 s<span>ite-to-site</span>/VNet-to-VNet tunnels and a maximum of 128 point-to-site connections. The average bandwidth is <span>1.25 Gbps</span>.</li>
</ul>
<p><span>You can set up route-based or policy-based VPN types. Which one to use depends on the compatibility of your VPN device and the VPN connection type you want to use.</span></p>
<p><span>Policy-based means that you have to write your own routing-table entries. This can be suitable for small organizations, but most will rather do this dynamically. </span><span>Policy-based routing also has some restrictions; you can only set up one site-to-site VPN tunnel using IKEv1 and no point-to-site tunnel. </span></p>
<p>Route-based means that the <span>routing-table entries are added dynamically and that you can use all the VPN connection types and IKEv2.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Site-to-site VPN</h1>
                </header>
            
            <article>
                
<p>A <strong>site-to-site</strong> <span>(<strong>S2S</strong>) </span>VPN  is designed to create secure connections between a location, such as an office for instance, and Azure over the internet. You can then connect from every server or computer from that location using the same VPN connection. It requires a compatible VPN device or <strong>Routing and Remote Access Service</strong> (<strong>RRAS</strong>) and a public IP address for your VPN device. The RRAS can be deployed on a Windows server by activating the remote access server role. </p>
<p>The S2S VPN gateway creates a connection over a IPsec/IKE (IKEv1 or IKEv2) VPN tunnel. <strong>Internet Protocol Security</strong> (<strong>IPSec</strong>) is an open standard for securing connections over the internet and <strong>Internet Key Exchange</strong> (<strong>IKE</strong>) is a key management protocol standard used in conjunction with IPSec. It is a method for exchanging keys for encryption and authentication.</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/7715e2d5-e331-4673-ab5d-58ed4755e6ea.png" style="width:42.25em;height:20.17em;" width="1117" height="533"/><span><br/></span></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span>Site-to-site VPN connection</span></div>
<div class="packt_tip packt_infobox">For a list of compatible VPN devices and the supported VPN types, you can refer to the following overview: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">VNet-to-VNet VPN</h1>
                </header>
            
            <article>
                
<p><span>VNet-to-VNet is a connection type that can be set up as well. In this case, you are creating a connection between multiple Azure VNets. A typical reason for setting up this type of connection, could be for geo-redundancy. This connection type is the same as the S2S connection type.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Point-to-site VPN</h1>
                </header>
            
            <article>
                
<p>A <strong>point-to-site</strong> <span>(<strong>P2S</strong>) </span><span>VPN is designed to create secure connections between an individual client computer over IKEv2 or SSTP. The connection is established by starting it from the client computer using a script. These connections are used for remote workers that log on to the private network from a different location or they can be used when you have a few clients that need to connect to the VPN. </span></p>
<p><span><strong>Secure Socket Tunneling Protocol</strong> (</span><strong>SSTP</strong><span>) is a</span> <span>VPN tunnel that creates a connection through an SSL/</span><span>TLS channel. By using SSL/TLS over port <kbd>443</kbd>, the connection can pass through all firewalls and proxy servers.</span></p>
<p>P2S connections don't require a VPN device or a public IP address for the client computer. They can be used in conjunction with the S2S connection as well as through the same VPN gateway, as long as the requirements for both the connections are the same.</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-459 image-border" src="Images/8ec66b5d-7f4c-42d2-95fb-2eb83b0fb1f6.png" style="width:47.58em;height:22.33em;" width="1178" height="553"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Point-to-site VPN connection</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">ExpressRoute </h1>
                </header>
            
            <article>
                
<p>ExpressRoute is the most advanced type of VPN connection. It offers a fast connection from your on-premises infrastructure to the Azure via your internal WAN, unlike S2S connections, which go over the internet. By using your WAN, ExpressRoute can provide faster speeds, lower latency, and higher security than an S2S connection. The maximum <span>bandwidth </span>that can be provided per ExpressRoute circuit is 10 GBps. With ExpressRoute, you can also set up hybrid connections with Office 365 and Dynamics 365. <span>ExpressRoute also guarantees a connection uptime SLA, whereas S2S doesn't.</span></p>
<p>ExpressRoute offers the following connection models:</p>
<ul>
<li><strong>Any-to-any (IPVPN)</strong>: With this type of connection, you integrate your WAN with Azure using an IPVPN provider. The provider is then responsible for setting up the secure connection between your on-premises network and Azure. WAN providers typically offer a layer three connection.</li>
<li><strong>Point-to-point Ethernet</strong>: With this type of connection, you connect <span><span>through point-to-point Ethernet links. Point-to-point providers typically provide a layer two connection.</span></span></li>
<li><strong>Co-located at a Cloud Exchange</strong>: With this type of connection, you can order connections through the provider's Ethernet exchange. These providers <span>typically offer layer two cross-connections and managed layer three cross-connections.<br/></span></li>
</ul>
<div class="CDPAlignCenter CDPAlign"><img src="Images/f52f570a-b378-4990-9ad2-7c8c647e3726.jpg" style="width:50.17em;height:25.08em;" width="1240" height="620"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>ExpressRoute VPN connection</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Network security strategies</h1>
                </header>
            
            <article>
                
<p>With all the hacking incidents nowadays, a strong network security strategy is key. It is not secure to just create a public IP address and expose your Azure resource to the internet. This will make you vulnerable for attacks. Design your networks with security in mind and reduce what is exposed to the internet. You can use the features that Azure provides for securing your networks. Azure offers support for different security strategies, which are described in the following section. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">DMZ</h1>
                </header>
            
            <article>
                
<p>A <strong>demilitarized zone</strong> (<strong>DMZ</strong>) or perimeter network is a physical or logical boundary between the internal and the external network of an organization. The external network can be the internet. The purpose is to add an additional security layer to the internal network. You don't open any ports from the internal network to the internet, but only to the DMZ. Azure offers multiple features that you can use to create a DMZ, such as <strong>Network Security Groups</strong> (<strong>NSGs</strong>), firewalls, and <strong>User Defined Routes</strong> (<strong>UDRs</strong>).</p>
<p>The following diagram shows an example of a physical DMZ created using a frontend VNet with two VMs in it. Only this VNet is connected to the internet.</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/a4b47dfc-600c-4445-ad0a-941547a2a2bf.png" style="width:33.25em;height:21.83em;" width="1048" height="689"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Simple DMZ example</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Network Security Groups</h1>
                </header>
            
            <article>
                
<p>A NSG is an access control list inside Azure where you can add inbound and outbound rules. When a connection is established between VMS, VNets, or other cloud services, this list is checked to see whether the connection is allowed or denied.</p>
<p>NSGs can be applied to one or more subnets or <span>individual <strong>network interfaces</strong> (<strong>NIC</strong>)</span>. This means that all resources that are associated with this subnet or NIC will automatically have all the rules applied.</p>
<p>NSG rules are processed <span>in </span>priority<span> order, with lower numbers before higher numbers, and they can be applied to inbound or outbound traffic.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a NSG</h1>
                </header>
            
            <article>
                
<p>Follow these steps to create a NSG:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click <span class="packt_screen">New</span>, type <kbd>Network Security Group</kbd> in the search bar, and create a new one:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/111c8b2d-105a-434b-a6e2-6bc789b25068.png" style="width:29.75em;height:35.75em;" width="1157" height="1390"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">New NSG</div>
<ol start="3">
<li>A new blade opens up. Add the following settings and click on <span class="packt_screen">Create</span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/cb721549-3fa5-4dc3-ad9d-925983941516.png" style="width:20.58em;height:48.17em;" width="616" height="1439"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">New NSG settings</div>
<ol start="4">
<li>A NSG is created with some default inbound and outbound security rules. They are low-priority rules, as they have a high number, so there is a lot of room to add custom rules. To add a custom rule, click on <span class="packt_screen">Inbound security rules</span> in the left-hand menu:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="Images/33a6dd01-fe7f-42cb-8113-03d65f2dc43b.jpg" style="width:54.33em;height:33.92em;" width="2282" height="1423"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">NSG default Inbound and Outbound rules</div>
<ol start="5">
<li>Click the <span class="packt_screen">Add</span><strong> </strong>button and add the following values to create rules that allow traffic from port <kbd>80</kbd>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/ce8a42ac-82e5-487f-b0e8-764cc59f0db6.jpg" style="width:31.83em;height:46.42em;" width="1164" height="1700"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">New rule</div>
<ol start="6">
<li>You can now associate this NSG with an NIC or a subnet by clicking on <span class="packt_screen">Network Interfaces</span> or <span class="packt_screen">Subnets</span> from the left-hand menu:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/88ea5cb2-4d7f-4061-bffe-c672e2489431.jpg" style="width:40.08em;height:28.00em;" width="2272" height="1585"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Associate the NSG with a NIC or subnet</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">User Defined Routes</h1>
                </header>
            
            <article>
                
<p>When you create subnets, Azure creates system routes that enable all resources in a subnet to communicate with each other. You can override the system routes by creating UDRs. This way, you can force traffic to follow a particular route.</p>
<p>For instance, you have a network that consists of two subnets and you want to add a VM that is used as a DMZ and has a firewall installed on it. You want traffic only to go through the firewall and not between the two subnets.</p>
<p>To create UDRs and enable IP forwarding, you have to create a routing table in Azure. When this table is created and there are custom routes in there, Azure prefers the custom routes over the default system routes.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating User Defined Routes</h1>
                </header>
            
            <article>
                
<p>To create UDRs, follow these steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span>, type <kbd>Routing Table</kbd> in the search bar, and create a new one. </li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/4a1e9208-a18d-405d-ab95-155e7942bfbc.jpg" style="width:36.92em;height:45.17em;" width="1161" height="1420"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span>Create a new routing table</span></span></div>
<ol start="3">
<li>Add the following values:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="Images/90af0ec4-b471-4ee1-932a-bd31e38c31db.jpg" style="width:20.33em;height:47.00em;" width="622" height="1438"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">Route table settings</div>
<ol start="4">
<li class="mce-root"><span>A new and empty route table is created. To add custom routes, click on</span> <span class="packt_screen">Routes</span> <span>in the left-hand menu:</span></li>
</ol>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img src="Images/0deb9af8-7766-4486-ad30-1e910fd7cc09.jpg" style="width:64.50em;height:36.92em;" width="2276" height="1302"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Empty route table</div>
<ol start="5">
<li>Click the <span class="packt_screen">Add</span> button in the top menu and add the following values to create a custom route. In this example, we want all internet traffic to go through the firewall. So, add a <kbd>0.0.0.0/0</kbd> as the <span class="packt_screen">Address prefix</span>. The <span class="packt_screen">Next hop type</span> is a <kbd>Virtual appliance</kbd>; this is the firewall. And last, the <span class="packt_screen">Next hop address</span>; this will be the internal IP address of the firewall:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="Images/a67cdb65-9b8d-41b9-9fb7-b6c54edc7bf1.jpg" style="width:31.58em;height:38.75em;" width="1163" height="1428"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Add custom route</div>
<div class="packt_infobox">For more detailed instructions on how to create UDPs and a virtual appliance, you can refer to the following tutorial: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/create-user-defined-route-portal">https://docs.microsoft.com/en-us/azure/virtual-network/create-user-defined-route-portal</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Virtual network service tunneling</h1>
                </header>
            
            <article>
                
<p><span>With <strong>virtual network service tunneling,</strong> all your external traffic is forced to go through a site-to-site VPN tunnel. Without this, external traffic will always go directly from Azure to the internet. This gives you the opportunity to audit the traffic. </span></p>
<p>Forced tunneling uses the UDRs to define the routing. Instead of choosing the virtual appliance, you now choose the virtual network gateway:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/066341b9-ff33-4598-a2b4-b10da7b19b35.jpg" style="width:32.08em;height:39.50em;" width="1162" height="1431"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><span>Virtual network service tunneling</span></span></div>
<div class="packt_infobox"><span>For more information about virtual network service tunneling and an example on how to create it using PowerShell, you can refer to the following tutorial: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm</a>.</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Web Application Firewall </h1>
                </header>
            
            <article>
                
<p>The WAF is part of the application gateway and it provides a firewall to protect your web apps from hacking attacks. It is based on rules from the OWASP core rule set 3.0. It can protect a maximum of 20 applications behind an application gateway and it provides monitoring for your applications using Azure Monitor (in the future, monitoring will be added to the Azure Security Center as well).</p>
<div class="packt_tip packt_infobox"><span>OWASP is an open standard for application security. For more information on the rule set, you can refer to the OWASP website: </span><a href="https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project">https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project</a><span>.</span></div>
<p>By default, it protects your application from the following: </p>
<ul class="lf-text-block lf-block">
<li><span>From </span>SQL injection attacks</li>
<li><span>From c</span>ross-site scripting attacks</li>
<li>From command injection, HTTP request smuggling, HTTP response splitting, and remote file inclusion attacks</li>
<li>Against HTTP protocol violations and anomalies</li>
<li>Against bots, crawlers, and scanners</li>
<li>It detects common application misconfigurations</li>
</ul>
<div class="packt_infobox">You can also add or customize the rules and rule group to suit the needs of your application. You can refer to the following tutorial to customize rules: <a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-customize-waf-rules-portal">https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-customize-waf-rules-portal</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we have covered the networking objectives. We've covered how to design Azure Virtual Networks. We've discussed IP addresses and Azure DNS. We also covered when to use the Azure Application Gateway, Azure Traffic Manager, and Azure Load Balancer. We then looked at designing external connectivity for Azure VNets using different VPN connections, and finally, we talked about designing different security strategies.</p>
<p>In the next chapter, we will cover hybrid applications.<span> </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>When you create a new routing table in Azure, is the system routing table deleted?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Are NSG rules processed by priority number from high to low?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Does DMZ consist of a firewall?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check out the following links for more information on the topics that are covered in this chapter:</span></p>
<ul>
<li><strong>Azure Virtual Network</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview</a></li>
<li><span><strong>Virtual Network Peering</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview</a></span></li>
<li><strong>Azure Load Balancer overview</strong>: <a href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview">https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview</a></li>
<li><strong>Overview of Traffic Manager</strong>: <a href="https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview">https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview</a></li>
<li><strong>Overview of Application Gateway</strong>: <a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-introduction">https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-introduction</a></li>
<li><strong>About VPN Gateway</strong>: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways</a></li>
<li><strong>ExpressRoute overview</strong>: <a href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction">https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction</a></li>
<li><strong>Filter network traffic with network security groups</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-nsg">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-nsg</a></li>
<li><strong>User Defined Routes</strong>: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#custom-routes">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#custom-routes</a></li>
<li><strong>Web Application Firewall</strong>: <a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-web-application-firewall-overview">https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-web-application-firewall-overview</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>