<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Installing Docker with Puppet</h1></div></div></div><p>In this chapter, we will be setting up our development environment so that we can develop our first container application. To do this, we will use Vagrant. In our first topic, we will look at how to install Vagrant. We will look at how a Vagrantfile is constructed using Puppet as the provisioner. We will also look at how to get Puppet modules from the Puppet Forge using a puppetfile and r10k. In the last topic, we will install Docker on a Centos 7 box with Puppet. The following are the topics that we will cover in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing Vagrant</li><li class="listitem" style="list-style-type: disc">An introduction to Puppet Forge</li><li class="listitem" style="list-style-type: disc">Installing Docker</li></ul></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Installing Vagrant</h1></div></div></div><p>You may ask, why are we using Vagrant for<a id="id0" class="indexterm"/> our development environment?</p><p>Vagrant is a must-have for Puppet development. The idea that you can spin up environments for development locally in minutes was a revolution in Vagrant's early releases. The product has now grown in leaps and bounds, with multiple provisioners such as Chef and Salt. Paired with multiple virtualization backends such as VirtualBox, VMware Workstation/Fusion, KVM, and we are going to use VirtualBox and Puppet as your provisioner.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec07"/>The installation</h2></div></div></div><p>Let's install Vagrant. Firstly, we<a id="id1" class="indexterm"/> will need our virtualization backend, so let's download and install VirtualBox. At the time of writing, we use VirtualBox 5.0.10 r104061. If that's outdated by the time you read this book, just grab the latest version.</p><p>You can download <a id="id2" class="indexterm"/>VirtualBox from <a class="ulink" href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a>. Choose the version for your OS, as shown in the following screenshot:</p><div><img src="img/B05201_01_01.jpg" alt="The installation"/></div><p>Once the package is<a id="id3" class="indexterm"/> downloaded, follow the given installation process for your OS.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec01"/>VirtualBox</h3></div></div></div><p>Follow these steps to install <a id="id4" class="indexterm"/>Vagrant on Mac OSX:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to your <code class="literal">Downloads</code> folder and double-click on <code class="literal">VirtualBox.xxx.xxx.dmg</code>. The following installation box will pop up:<div><img src="img/B05201_01_02.jpg" alt="VirtualBox"/></div></li><li class="listitem">Then, click on <code class="literal">VirtualBox.pkg</code>. Move on to the next step, as shown in the following screenshot:<div><img src="img/B05201_01_03.jpg" alt="VirtualBox"/></div><p>The installer<a id="id5" class="indexterm"/> will then check whether the software is compatible with the Mac OSX version.</p></li><li class="listitem">After this, click on <strong>Continue</strong>. Once the check is successful, we can move on to the next step:<div><img src="img/B05201_01_04.jpg" alt="VirtualBox"/></div></li><li class="listitem">We then choose the<a id="id6" class="indexterm"/> default location for the installation and click on <strong>Install</strong>.</li><li class="listitem">Then, enter your admin password and click on <strong>Install Software</strong>:<div><img src="img/B05201_01_05.jpg" alt="VirtualBox"/></div></li></ol></div><p>The installation is now complete. The following screenshot shows what the screen looks like after completing the installation:</p><div><img src="img/B05201_01_06.jpg" alt="VirtualBox"/></div><p>Now that we have the <a id="id7" class="indexterm"/>virtualization backend, we can install Vagrant:</p><div><img src="img/B05201_01_07.jpg" alt="VirtualBox"/></div><div><div><h3 class="title"><a id="note02"/>Note</h3><p>At the time of<a id="id8" class="indexterm"/> writing this book, we are going to use Vagrant 1.7.4; if that is no longer the latest version, please grab the latest one. You can find this version<a id="id9" class="indexterm"/> of Vagrant at <a class="ulink" href="https://www.vagrantup.com/downloads.html">https://www.vagrantup.com/downloads.html</a>. Again, download the installation package for your OS.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Vagrant</h3></div></div></div><p>Here, we are just going to complete a standard installation. Follow these steps to do so:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to the folder in which you downloaded <code class="literal">vagrant.1.7.4.dmg</code> and double-click on the installer. You will then get the following pop up:<div><img src="img/B05201_01_08.jpg" alt="Vagrant"/></div></li><li class="listitem">Double-click <a id="id10" class="indexterm"/>on <code class="literal">vagrant.pkg</code>.</li><li class="listitem">Then, in the next dialogue box, click on <strong>Continue</strong>:<div><img src="img/B05201_01_09.jpg" alt="Vagrant"/></div></li><li class="listitem">Then, click <a id="id11" class="indexterm"/>on the <strong>Install</strong> button:<div><img src="img/B05201_01_12.jpg" alt="Vagrant"/></div></li><li class="listitem">Enter your admin<a id="id12" class="indexterm"/> password in the given field:<div><img src="img/B05201_01_10.jpg" alt="Vagrant"/></div></li><li class="listitem">Once the installation is complete, open your terminal application. In the command prompt, type <code class="literal">vagrant</code>. After this, you should see the following screenshot:<div><img src="img/B05201_01_11.jpg" alt="Vagrant"/></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Vagrantfile</h2></div></div></div><p>Now that we have a fully working Vagrant environment, we can start with and look at how Vagrant works <a id="id13" class="indexterm"/>and how we are going to provision our machines. As this book is not about Vagrant, we won't be writing a Vagrantfile from scratch. Instead, I have created a Vagrantfile that we will be using throughout the book:</p><div><img src="img/B05201_01_13.jpg" alt="Vagrantfile"/></div><div><div><h3 class="title"><a id="note03"/>Note</h3><p>You can download or <a id="id14" class="indexterm"/>Git pull the repo from <a class="ulink" href="https://github.com/scotty-c/vagrant-template">https://github.com/scotty-c/vagrant-template</a>.</p></div></div><p>Let's<a id="id15" class="indexterm"/> look at the Vagrantfile construct:</p><div><img src="img/B05201_01_14.jpg" alt="Vagrantfile"/></div><p>As you can see from the preceding screenshot, the Vagrantfile is actually a Ruby file. As it is Ruby, it opens up a world of opportunities for us to make our code elegant and efficient. So, in this Vagrantfile, we have extracted all the low-level configurations and replaced them <a id="id16" class="indexterm"/>with a few parameters. Why are we doing this? The reason is to split up our logic from our configuration and also iterate our configuration in order to stop replication of our code. So, where is all the configuration stored? The answer is in the <code class="literal">servers.yaml</code> file. This is where we set the vagrant box that we want to deploy, the number of CPUs for the box, the internal network's IP, the hostname, the forwarded ports between the guest and host, and the RAM and shell provider for bash commands that we need to get the environment ready for Puppet to run, for example, downloading modules and their dependencies from the Puppet Forge:</p><div><img src="img/B05201_01_15.jpg" alt="Vagrantfile"/></div><p>The benefit of this approach is also that any developer using a Vagrantfile does not need to actually modify the logic in the Vagrantfile. They only need to update the configuration in <code class="literal">servers.yaml</code>. As we go through the book, we will work with the other files in the<a id="id17" class="indexterm"/> repository, such as <code class="literal">Puppetfile</code>, <code class="literal">hieradata</code>, and <code class="literal">manifests</code>. Now that we have set up our Vagrant environment, let's look at how to get our Puppet modules from the Puppet Forge.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Welcome to the Puppet Forge</h1></div></div></div><p>In this topic, we<a id="id18" class="indexterm"/> will look at how to find modules from the Puppet Forge. Then, we will see how to pull them with their dependencies using a puppetfile and r10k. This will set us up for our last topic, <em>Installing Docker with Puppet</em>.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>The Puppet Forge</h2></div></div></div><p>One of the great things about puppetlabs and their products is the community. If you ever get a chance to attend PuppetConf or a Puppet Camp, depending on where you live, I would really recommend you to attend it. There will be a wealth of knowledge there and you will meet some really great people.</p><p>The Puppet Forge is a website that puppetlabs runs. It is a place where other Puppet developers publish modules that are ready to use. You might be asking, what about GitHub? Can't you get modules from there? Yes, you can. The difference between the Puppet Forge and GitHub is that the Puppet Forge is the stable, releasable version of the module, whereas GitHub is the place to contribute to the module, that is, a place to create pull requests.</p><div><div><h3 class="title"><a id="note04"/>Note</h3><p>You can<a id="id19" class="indexterm"/> find the Puppet Forge at <a class="ulink" href="https://forge.puppetlabs.com/">https://forge.puppetlabs.com/</a>.</p></div></div><p>The following screenshot shows the home page of Puppet Forge:</p><div><img src="img/B05201_01_16.jpg" alt="The Puppet Forge"/></div><p>Now that we have been<a id="id20" class="indexterm"/> introduced to the Puppet Forge, let's use it to find our Docker module that we will be using to build our environment.</p><div><div><h3 class="title"><a id="note05"/>Note</h3><p>We are going to<a id="id21" class="indexterm"/> use the garethr/docker Docker module, which you can find at <a class="ulink" href="https://forge.puppetlabs.com/garethr/docker">https://forge.puppetlabs.com/garethr/docker</a>.</p></div></div><p>Now that we have selected our module, we can move on to setting up our puppetfile:</p><div><img src="img/B05201_01_17.jpg" alt="The Puppet Forge"/></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Creating our puppetfile</h2></div></div></div><p>In the previous topic, we cloned our Vagrant template using Git. In that repo, there is also a puppetfile. A puppetfile is used as a control file for our modules. It will list all the modules that we need (in this instance, just to install Docker). r10k will then reference the puppetfile and <a id="id22" class="indexterm"/>pull the modules from the Puppet Forge into our environment's directory.</p><p>As modules have dependencies, we need to make sure that we capture them in our puppetfile. For the Docker module, we have three dependencies: <strong>puppetlabs/stdlib (&gt;= 4.1.0)</strong>, <strong>puppetlabs/apt (&gt;= 1.8.0 &lt;= 3.0.0)</strong>, and <strong>stahnma/epel (&gt;= 0.0.6)</strong>, as shown in the following screenshot.</p><p>Now, we know all the modules that we need to build a Docker environment. We just need to add them to our puppetfile.</p><p>The following screenshot is an example of what the puppetfile should look like:</p><div><img src="img/B05201_01_18.jpg" alt="Creating our puppetfile"/></div><p>Now, when we run <code class="literal">vagrant up</code>, r10k will pull the modules from the Puppet Forge. We invoke r10k on line 13 of <code class="literal">servers.yaml</code> with the <code class="literal">r10k puppetfile install—verbose</code> command. The following screenshot shows the output of this command:</p><div><img src="img/B05201_01_19.jpg" alt="Creating our puppetfile"/></div><p>If we are successful, the<a id="id23" class="indexterm"/> terminal will provide the following output:</p><div><img src="img/B05201_01_20.jpg" alt="Creating our puppetfile"/></div><p>Now that we have our puppetfile set up, we can install Docker.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Installing Docker</h1></div></div></div><p>In this topic, we<a id="id24" class="indexterm"/> will put together all the configuration from our Vagrant repo and knowledge of the Puppet Forge to create the Docker environment.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Setting our manifests</h2></div></div></div><p>The first thing that we need to do to install Docker is set our manifest to include the Docker class on our <a id="id25" class="indexterm"/>node. To do this, let's go to our Vagrant repo. In the repo, there is a file in the <code class="literal">manifests</code> directory called <code class="literal">default.pp</code>. We need to edit the file to include the Docker class <code class="literal">node 'node-01' { include docker}</code>. We can now save the file, and we are ready to run our environment.</p><p>The first step is to open our terminal and change to root of the Vagrant repo. Then, we need to enter the <code class="literal">vagrant up</code> command:</p><div><img src="img/B05201_01_21.jpg" alt="Setting our manifests"/></div><p>This will now provide us with our CentOS 7 box. Install r10k and then run Puppet and apply the Docker class. This will take about 4 minutes depending on your laptop and network connection. If the box was provisioned successfully, you will see the following output:</p><div><img src="img/B05201_01_22.jpg" alt="Setting our manifests"/></div><p>We can also verify that the Docker installation was successful by logging in to the box via SSH. We will do that with the <code class="literal">vagrant ssh</code> command. Once we are in, we will sudo up to root (<code class="literal">sudo -i</code>). Now, let's just check whether Docker is installed with the <code class="literal">docker</code> command.</p><p>You will see the following output on the terminal:</p><div><img src="img/B05201_01_23.jpg" alt="Setting our manifests"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Summary</h1></div></div></div><p>In this chapter, we covered how to create a development environment with Docker using Puppet. We looked at how to install Vagrant and VirtualBox. Then, we looked at the Puppet Forge, how to search for modules and their dependencies. We then took the dependencies and mapped them to a puppetfile. We briefly touched on r10k, which is our transport mechanism from the Puppet Forge to our environment. Then, we built our environment with Puppet.</p><p>In the next chapter, we'll take a look at how to access Docker Hub and pull public images.</p></div></body></html>