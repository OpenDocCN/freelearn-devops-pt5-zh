<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Securing Your Resources</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered designing for the Azure Data Services objective</span><span>. We've covered some of the different Azure Data Services as well as relational databases in Azure. We also covered backup and security strategies and designing for high availability and performance.</span></p>
<p>In this chapter, you will learn about the objective of the Design Security and Identity Solutions domains, by covering how to secure your resources, such as using Azure AD Connect, Multi-Factor Authentication (MFA), and more. It also covers how to use the different Identity Providers for your Azure Solutions.</p>
<p>The following topics will be covered:</p>
<ul>
<li>Azure Active Directory (Azure AD)</li>
<li>Azure AD Connect</li>
<li>Active Directory Federation Services (ADFS)</li>
<li>Multi-Factor Authentication</li>
<li>Azure Active Directory Business to Business (Azure AD B2B)</li>
<li>Azure Active Directory Business to Consumer (Azure AD B2C)</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter uses the following tools for the examples:</p>
<ul>
<li>Visual Studio 2017: <a href="https://www.visualstudio.com/downloads/">https://www.visualstudio.com/downloads/</a></li>
</ul>
<p><span>The source code for this chapter can be downloaded from the following link:</span></p>
<ul>
<li><a href="https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%209/">https://github.com/SjoukjeZaal/AzureArchitectureBook/tree/master/Chapter%209/</a></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory</h1>
                </header>
            
            <article>
                
<p>Azure Active Directory (Azure AD) offers directory and identity management from the cloud. It offers traditional username and password identity management and roles and permissions management. On top of that, it offers more enterprise solutions, such as MFA and applications monitoring, solution monitoring, and alerting. <span>Azure AD can easily be integrated with your on-premises Active Directory to create a hybrid infrastructure.</span></p>
<p>Azure AD offers the following pricing plans:</p>
<ul>
<li><strong>Free</strong>: This offers the most basic features, such as support for up to 500,000 objects, SSO, support for Azure AD Connect synchronization, and standard security reports</li>
<li><strong>Basic</strong>: This offers no object limit, SLA of 99.9%, Groups, self-service password reset, and support for the Application Proxy</li>
<li><strong>Premium P1</strong>: This offers Advanced Reporting, MFA, MDM auto-enrollment, Cloud app discovery, and Azure AD Connect Health</li>
<li><strong>Premium P2</strong>:<strong> </strong>Identity protection and <span>Privileged Identity Management</span></li>
</ul>
<div class="packt_tip">For a detailed overview of the different pricing plans and all the features that are offered for each plan, you can refer to the following pricing page: <a href="https://azure.microsoft.com/en-us/pricing/details/active-directory/">https://azure.microsoft.com/en-us/pricing/details/active-directory/</a>.<br/>
Note that Azure AD Premium is part of the Enterprise Mobility + Security Suite.</div>
<p>Azure AD can be leveraged in your custom apps and APIs as well for authorizing your users and securing your resources.<span> It offers support for industry standard protocols such as OAuth2.0 and OpenID Connect and supports authentication for single and multitenant applications, as well as line of business (LOB) applications. </span></p>
<p>It offers two different endpoints that can be leveraged in your custom applications:</p>
<ul>
<li><strong>V1 endpoint</strong>:<strong> </strong>This endpoint offers support for <span>Microsoft work or school accounts only, and it uses the Azure Portal to register the apps in Azure AD. It uses the <strong>Azure Active Directory Library</strong> (<strong>ADAL</strong>) SDK to authenticate users within the application.</span></li>
<li><strong>V2 endpoint</strong>: This offers support for both <span>Microsoft work or school accounts and personal accounts such as Outlook.com. It also offers a new registration portal located at <kbd>apps.dev.microsoft.com</kbd></span>,<span> and that makes it much easier to register your application in Azure AD. It uses the <strong>Microsoft Authentication Library </strong>(<strong>MSAL</strong>) in order to authenticate your users within the application. Using this endpoint, you can create one single App ID for multiplatform apps. If your applications consist of a separate web, Android, and IoS app, they can all use the same App ID. You can use dynamic consent, where you grant permissions only at the time you need them in the application itself and not up front when registering the app in Azure AD.</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Microsoft Graph</h1>
                </header>
            
            <article>
                
<p><span>Microsoft </span>Graph is a set of APIs that connects multiple Azure services together and provides a single endpoint for developers to use in their custom applications.</p>
<p><span>Microsoft Graph is made up of relationships between the various Azure services. By calling the endpoint for a particular user, that is added to Azure AD, you can retrieve the documents where the user is working on, find his/her manager, retrieve the users meetings, get a list of devices, and much more.</span></p>
<p><span>Azure AD is integrated in Microsoft Graph as well, b</span>ut it can be leveraged for more than Azure AD features only. In fact, nearly all SaaS products of Azure use Azure AD, such as Office 365, Intune, Dynamic 365, and Azure SQL. All of those Azure services are integrated in Microsoft Graph and can be leveraged inside your apps and APIs.</p>
<p>Microsoft Graph offers two different endpoints, the V1.0 endpoint, which consists of all the APIs that are general available and the beta endpoint, with the latter providing APIs that can still change over time. </p>
<div class="packt_tip">To get started with the Graph API and to register your App in Azure AD, you can refer to: <a href="https://developer.microsoft.com/en-us/graph">https://developer.microsoft.com/en-us/graph</a>. This is a great starting point, where you can also download secure sample applications for multiple programming languages. <br/>
For an overview of all the Azure services that are integrated in Microsoft Graph, you can refer to this website as well. </div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure AD Connect</h1>
                </header>
            
            <article>
                
<p>Azure AD Connect is a service that you can use to synchronize your on-premises Active Directory identities with Azure. This way, you can use the same identities for authentication on your on-premises environment as well as in the cloud and other SaaS applications.</p>
<p>The Azure AD Connect sync service consists of two parts, the<strong> </strong>Azure AD Connect sync component, which is a tool that is installed on a separate server inside your on-premises environment, and the Azure AD Connect sync service, which is part of Azure AD. <span>The sync component can sync data from Active Directory and SQL Server to Azure. </span>There is also a third component named the <span>Active Directory Federation Services component, which can be used in a scenario where ADFS is involved.</span> To monitor the on-premises identity infrastructure and the different Azure AD components, you can use a tool named <span>Azure AD Connect Health.</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d868326b-9917-4cfb-a551-ca44a36d0a5e.jpg" style="width:45.58em;height:24.00em;" width="1556" height="819"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref">Azure AD Connect architecture</div>
<div class="packt_infobox">For more information about how to install Azure AD Connect and syncing the user accounts and passwords, you can refer to <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-select-installation">https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-select-installation</a><a href="https://docs.microsoft.com/en-us/azure/active-directory/connect-health/active-directory-aadconnect-health">. For more information about monitoring the Health, you can refer to: </a><a href="https://docs.microsoft.com/en-us/azure/active-directory/connect-health/active-directory-aadconnect-health">https://docs.microsoft.com/en-us/azure/active-directory/connect-health/active-directory-aadconnect-health</a><a href="https://docs.microsoft.com/en-us/azure/active-directory/connect-health/active-directory-aadconnect-health">.</a></div>
<p><span>Azure AD Connect offers support for your users to sign in with the same passwords to both on-premises as cloud resources. It provides three different authentication methods for this, the password hash synchronization method, the pass-through authentication method, and the Federated SSO method (in conjunction with Active Directory Federation Services). </span></p>
<p><span>These three different authentication methods are covered in more detail in the upcoming sections. </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory password hash synchronization</h1>
                </header>
            
            <article>
                
<p>Most organizations only have a requirement to <span>enable user sign-in to Office 365, SaaS applications, and other Azure AD-based resources. The password hash synchronization method is well suitable for those scenario's. </span></p>
<p>Using this method, hashes of the user's password are synced between the on-premises Active Directory and Azure Active Directory. When there are any changes to the user's password, the password is synced immediately, so users can always log in with the same credentials on-premises as well as in Azure.</p>
<p>This authentication method also provides <span>Azure AD </span>Seamless <span>Single Sign-On (SSO). This way, users are automatically signed in when they are using a domain-joined device on the corporate network. Users only have to enter their username when using Seamless SSO. To use Seamless SSO, you don't have to install additional software or components on the on-premises network. You can push this capability to your users using group policies.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory pass-through authentication</h1>
                </header>
            
            <article>
                
<div>
<p><span>Azure Active Directory pass-through authentication offers the same capability, such as Azure AD password hash synchronization. Users can log in to their Azure resources as well as on-premises resources using the same credentials. The difference is that passwords aren't synced with Azure AD using pass-through authentication. The passwords are validated using the on-premises Active Directory and are not stored in the Azure Active Directory at all.</span></p>
<p>This method is suitable for organizations that have <span>security and compliance restrictions and aren't allowed to send usernames and passwords outside the on-premises network.</span></p>
<p>Pass-through authentication requires an agent to be installed on a domain-joined Windows Server that resides inside the on-premises environment. This agent then listens for <span>password validation requests and only makes an outbound connection from within your network. It also offers support for MFA and Azure AD Conditional Access policies.</span></p>
<p>Azure AD pass-through authentication offers <span>Azure AD Seamless SSO as well.</span></p>
</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Active Directory Federation Services</h1>
                </header>
            
            <article>
                
<p>Active Directory Federation Services (<span>ADFS) is a standards-based service and a feature of Windows Server that you can enable on a Windows Server machine. It provides an authentication provider for external users to log in to an on-premises environment over the internet. </span></p>
<p><span>ADFS offers the following features: </span></p>
<ul>
<li><strong>Web SSO</strong>: This provides SSO for federated users when they access applications that are installed in the on-premises data center.</li>
<li><span><strong>Web Services (WS) - interoperability</strong></span>: <span>Applications or users that don't use the Windows identity model but are compatible with the WS-Federation specification can still authenticate to the ADFS server and your on-premises applications.</span></li>
<li><strong>No external user account management</strong>:<strong> </strong>External users can authenticate using their own organization or personal credentials. <span>Inside ADFS, a trust is established using the external authentication provider and ADFS. </span>The user can then federate using <span>Security Assertion Markup Language (SAML) claims. </span></li>
</ul>
<p><span>The </span><span>Federated SSO Authentication method uses Azure AD Connect in conjunction with ADFS to offer federated Single Sign On to your users. </span><span>You can deploy ADFS inside your on-premises data center or using Azure VMs. You can use the same Azure AD APIs, such as Microsoft Graph, to connect to your on-premises identities. Azure Active Directory is responsible for connecting to your on-premises environment via ADFS and takes care of the authentication process.<br/></span></p>
<p><span>You can also expand the functionality of Azure AD using ADFS. You can implement custom claims or conditional policies that don't exist in Azure AD, or use you organization login screen with additional notifications or information or use a custom MFA provider. You can also create a trust between different environments using ADFS.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Multi-Factor Authentication</h1>
                </header>
            
            <article>
                
<p>In today's world, securing your data and systems is key. MFA adds a second layer of security to user sign-ins and is now a best practice to secure data. It enables two-step verification, where you first sign in with what you know and then with something you have. </p>
<p>Azure MFA uses the following verification methods:</p>
<ul>
<li><strong>Something you know</strong>: This is like a traditional password.</li>
<li><strong>Something you have</strong>: <span>This is </span>like a phone, by sending a text message, using a verification app, or receiving a phone call. Azure MFA also supports third-party OAUTH tokens.</li>
<li><strong>Something you are</strong>: <span>This is </span>like biometrics, using fingerprints or facial recognition.</li>
</ul>
<p>Azure MFA is part of Office 365 and Azure services. It is easy to set up, and you can select which verification methods you want to use for your users. When you have requirements to add MFA to on-premises applications that are not published to the cloud using the Azure Application Proxy, you can choose to deploy a on-premises MFA server as well.</p>
<div class="packt_infobox">If you want more information about the on-premises MFA Server and which features it offers, you can refer to: <a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication-get-started-server">https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication-get-started-server.</a></div>
<p>Azure MFA is included in the Azure Active Directory Premium Plans and the Enterprise Mobility + Security Suite. You can buy it as a standalone product as well.</p>
<p>You can leverage MFA in your custom applications using the MFA SDK as well. Users can sign in to the app using their existing credentials. The app sends a request to the Azure MFA service, and the Azure MFA service will send a request to a phone or other device. Once the user is authenticated, the Azure MFA service will send the response back to the application so that the user can be signed in. The <span>MFA SDK can be used for multiple programming languages, such as C#, PHP, Ruby, and Java. </span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Enabling MFA in the Azure Portal</h1>
                </header>
            
            <article>
                
<p>To enable MFA in the Azure Portal, take the following steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">Azure Active Directory</span> in the left menu.</li>
</ol>
<p> </p>
<ol start="3">
<li class="mce-root">In the next blade, click on<strong> Users</strong>. Click on <strong>Multi-Factor Authentication</strong> in the top menu:</li>
</ol>
<div style="color: black;font-size: 1em" class="CDPAlignCenter CDPAlign"><img src="Images/afc45c9c-5e47-4b98-a9ce-9485065cb9d1.jpg" style="width:60.17em;height:28.42em;" width="2273" height="1074"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Enabling MFA - Azure Portal</div>
<ol start="4">
<li>The MFA portal is opened where you can enable MFA for each user.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Enabling MFA in Office 365</h1>
                </header>
            
            <article>
                
<p><span>To enable MFA in the Office 365 admin center, take the following steps:</span></p>
<ol>
<li>Navigate to the Office 365 admin center by opening <a href="https://portal.office.com/adminportal/home">https://portal.office.com/adminportal/home</a>.</li>
<li>Go to <span class="packt_screen">Users</span> | <span class="packt_screen">Active Users</span>. <span>Click </span><span class="packt_screen">More</span> <span>|</span> <span class="packt_screen">Setup Azure mult....</span> as shown in the following screenshot<span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/a6a27f28-2b84-49dd-829c-1ee7d6ea1f94.jpg" style="width:68.83em;height:38.67em;" width="2417" height="1358"/><br/>
<br/>
Enabling MFA - Office 365 Admin Center</div>
<ol start="3">
<li>The MFA portal of Office 365 is opened, which looks basically the same as the Azure MFA portal.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Business to Business</h1>
                </header>
            
            <article>
                
<p><span><span class="fontstyle0">Azure Active Directory Business to Business (B2B)</span> is a feature on top of Azure Active Directory, which enables organizations to work safely with external users. To be added to Azure B2B, external users don't need to have an Microsoft work or personal account that is added to an existing Azure AD tenant. All sorts of accounts can be added to Azure B2B. You don't have to configure anything in the Azure Portal to use B2B; this feature is enabled by default for all Azure AD tenants.</span></p>
<p>Azure B2B is integrated with Office 365 for external sharing. It also provides APIs that can be leveraged inside custom applications to let both internal and external users authenticate. </p>
<p>Azure AD Free features are available for external users at no cost. However, if you want external users to use Azure AD Premium features, such as MFA and conditional access, you need to have enough Azure AD Premium licenses with a ratio of 5:1. This means, for every Azure AD Premium license, you can add five external users. So for instance, if your organization wants to add 50 external users to Azure B2B, there should be 10 Azure AD Premium licensed being purchased.</p>
<p>Azure AD B2B offers the following features:</p>
<ul>
<li><strong>Management portal</strong>: Separate portal for the external organization, where administrators can add, manage, and remove users. </li>
<li><strong>Groups</strong>: You can create groups for external users. You can use dynamic groups as well. Administrators can set up rules to populate groups based on user attributes.</li>
<li><strong>Conditional access</strong>: With conditional access, you can set certain conditions for your users. You can enforce external users to use MFA, or give them access to certain applications or only access from certain locations. </li>
<li><strong>Sharing policies</strong>:<strong> </strong>Not only administrators can invite external users. You can use policies to delegate these permissions to other external users. You can add the <span>Guest Invitor role to the user, which is then allowed to send invites.</span></li>
<li><strong>Auditing and reporting</strong>: Just like normal users, there are auditing and reporting capabilities as well. You can look into the invitation history and acceptance details.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Active Directory Business to Consumer</h1>
                </header>
            
            <article>
                
<p><span class="fontstyle0">Azure Active Directory Business to Consumer (B2C)</span> is a cloud identity-management solution for mobile and web applications. It offers out-of-the-box authentication providers that can be leveraged from within your apps and custom APIs using <span>MSAL, which is used in other Azure AD applications as well (using the V2 endpoint). </span></p>
<p>This means that developers don't have to add additional SDKs manually; that is all handled by Microsoft. Next, to the authentication providers that are offered by Microsoft, it also provides the ability to add your own authentication providers.</p>
<p>Azure AD B2C offers the following authentication providers:</p>
<ul>
<li><strong>Social accounts</strong>: They are Facebook, Google, LinkedIn, and more</li>
<li><strong>Enterprise accounts</strong>: They use open standards protocols, such as OpenID Connect or SAML</li>
<li><strong>Local accounts</strong>: They are accounts using email address/username and password</li>
</ul>
<p>Your application needs to be registered inside the Azure B2C tenant. After registration, built-in policies can be configured for the app where you can enable different authentication methods, set claims, enable MFA, or create a password reset policy, that the App can use.</p>
<p>You then add the required configuration settings for the application that is registered in the Azure B2C tenant to your code, and all the earlier-mentioned settings can be used without any further configuration.</p>
<div class="packt_tip packt_infobox">You can refer to the following site for more information about Azure AD B2C: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-overview</a>.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Leveraging Azure AD B2C in your application</h1>
                </header>
            
            <article>
                
<p>In this demo, we are creating an application that leverages the Azure AD B2C features for authentication. This consists of two steps, first is creating an Azure AD B2C tenant in the Azure Portal, and the second is creating the application.</p>
<p>To create the Azure <span>AD B2C tenant in the Azure Portal, follow these steps:</span></p>
<ol>
<li>Navigate to the Azure Portal by opening <a href="https://portal.azure.com/">https://portal.azure.com/</a><span>.</span></li>
<li class="mce-root"><span>Click on </span><span class="packt_screen">New</span><span> </span><span>and type</span> <kbd>Azure Active Directory B2C</kbd> <span>in the search bar. Create a new tenant:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/dbd4030a-c9d0-4dac-924c-ead79b3587b9.jpg" style="width:38.42em;height:46.42em;" width="1164" height="1409"/><br/>
<br/>
Creating Azure B2C tenant</div>
<ol start="3">
<li class="mce-root"><span>Select</span> <span class="packt_screen">Create a new Azure AD B2C Tenant</span><span>, add the following settings, and click on </span><span class="packt_screen">Create</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/98944852-12ea-4de6-b275-efa89ade14e8.jpg" style="width:65.50em;height:29.67em;" width="1797" height="814"/><br/>
<br/>
Adding the settings</div>
<ol start="4">
<li>You can select the tenant by opening the menu in the top-right corner of the Azure Portal:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/02c4a43f-5280-4850-8478-ab4ef88f31ec.jpg" style="width:19.25em;height:21.58em;" width="751" height="841"/><br/>
<br/>
Selecting Azure B2C tenant</div>
<ol start="5">
<li>After creation, you can navigate to the Azure B2C page in the portal.</li>
</ol>
<div class="packt_infobox">You can now set up different authentication providers inside the B2C tenant. For this demo, I've added a Google Identity provider. To add this, you can refer to the tutorial at: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-goog-app">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-goog-app</a>.</div>
<ol start="6">
<li class="mce-root"><span>The next thing to do is to register the application. Click on </span><span class="packt_screen">Applications</span><strong> </strong><span>in the left menu and click on the </span><span class="packt_screen">Add</span> <span>button:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/affc9aca-f58e-4b58-ad18-7615d0520295.jpg" style="width:56.42em;height:29.67em;" width="2277" height="1196"/><br/>
<br/>
Registering the application in Azure B2C</div>
<ol start="7">
<li class="mce-root"><span>We are going to create a Web App that authenticates to Azure B2C. We are using OpenID Connect sign in, so you have to enable</span> <span class="packt_screen">Allow implicit flow</span><span>. You need to add a</span> <span class="packt_screen">Reply URL</span> <span>as well. Add the following settings and click on </span><span class="packt_screen">Create</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/f4ef0274-7beb-4dcb-bf51-3edd56ff4b59.jpg" style="width:36.42em;height:43.58em;" width="1163" height="1392"/><br/>
<br/>
Adding App settings</div>
<ol start="8">
<li class="mce-root"><span>When your app is created, click on the</span> <span class="packt_screen">App</span><span>. Copy the</span> <span class="packt_screen">Application ID</span> <span>to your Notepad. The</span> <span class="packt_screen">Application Key</span> <span>needs to be copied as well. Click on </span><span class="packt_screen">Keys</span> <span>in the left menu and click on</span> <span class="packt_screen">Generate key</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/ebef553c-3a01-4c78-a3b8-c1e4a541b8b5.jpg" style="width:63.67em;height:19.58em;" width="2278" height="701"/><br/>
<br/>
Generating the key</div>
<ol start="9">
<li>Immediately, click on <span class="packt_screen">Save</span> and copy the key to the Notepad.</li>
<li><span>The next thing to do is to create a Google Identity Provider. Open</span> <span class="packt_screen">Identity providers</span> <span>in the left menu and click on the</span> <span class="packt_screen">Add</span> <span>button:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/aa468f6e-aa53-474a-961c-95e71381a565.jpg" style="width:62.50em;height:34.17em;" width="2278" height="1246"/><br/>
<br/>
Adding Google Identity Provider</div>
<ol start="11">
<li class="mce-root">In the next blade, select the following settings:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/e9aa08c8-ee15-4341-86c7-fb6ba8d90561.jpg" style="width:37.08em;height:41.75em;" width="1247" height="1401"/><br/>
<br/>
Selecting Google</div>
<ol start="12">
<li class="mce-root"><span>Open a new browser tab and navigate to: </span><a href="https://console.developers.google.com">https://console.developers.google.com</a><span>. Create a new project and add call it </span><kbd>PacktB2C</kbd><span>.</span><strong> </strong><span>Go back to the API home page and click on </span><span class="packt_screen">Credentials</span> <span>in the left menu:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/23158673-52d7-42d6-822d-61ed69db628e.jpg" style="width:58.33em;height:22.75em;" width="2249" height="877"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Retrieving App Credentials</div>
<ol start="13">
<li class="mce-root"><span>Click on the</span> <span class="packt_screen">OAuth consent screen</span> <span>settings in the top menu, add the following, and click on</span> <span class="packt_screen">Save</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/eaeac997-5a44-4896-9de3-387ff02d1adb.jpg" style="width:50.08em;height:49.58em;" width="1367" height="1355"/><br/>
<br/>
OAuth consent settings</div>
<ol start="14">
<li class="mce-root"><span>Click on the <span class="packt_screen">Credentials</span> consent settings in the top menu and add </span><span>the following settings:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/e88c015a-631a-4211-98ed-ceec55a9bf72.jpg" style="width:56.58em;height:41.00em;" width="1949" height="1411"/><br/>
<br/>
Creating OAuth credentials</div>
<ol start="15">
<li>Add the following settings to create the app:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/f1090aba-10ff-42d6-a1e7-afe40fe183ea.jpg" style="width:44.25em;height:43.08em;" width="1424" height="1387"/><br/>
<br/>
Registering the app</div>
<ol start="16">
<li>A popup appears with the <span class="packt_screen">Client ID</span> and the <span class="packt_screen">Client secret</span>. Copy it to the Notepad.</li>
<li class="mce-root"><span>Go back to the Azure Portal and add the</span> <span class="packt_screen">Client ID</span> <span>and the</span> <span class="packt_screen">Client secret</span> <span>to the blade where we were registering the Identity Provider and click on </span><span class="packt_screen">OK</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/a41fb438-e599-402c-95dc-cb1e915258a5.jpg" style="width:42.00em;height:47.00em;" width="1248" height="1397"/><br/>
<br/>
Adding Client ID and Client Secret</div>
<ol start="18">
<li class="mce-root"><span>Next, you have to add </span><span class="packt_screen">Sign-in Policy</span><span>.</span><strong> </strong><span>Click this in the left menu and click on</span><span> </span><span class="packt_screen">Add</span><span>. Add the following settings:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/2bc5f9ac-babd-40ec-87b8-6ef0d3415ae5.jpg" style="width:50.67em;height:39.75em;" width="1795" height="1405"/><br/>
<br/>
Adding the policy</div>
<ol start="19">
<li class="mce-root"><span>Select the following application claims and click on </span><span class="packt_screen">OK</span>, <span>and then click on</span><span class="packt_screen"> Create</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/4c7efdb8-7a67-46e2-b761-456fa6e179ca.jpg" style="width:59.42em;height:36.33em;" width="2275" height="1390"/><br/>
<br/>
Selecting Google Claims</div>
<ol start="20">
<li><span>The sample application can be downloaded from GitHub. Open the </span><kbd>Web.config</kbd><span> of the application and update the settings with the values that were copied to the Notepad earlier. It will look as follows:</span></li>
</ol>
<pre style="padding-left: 60px">&lt;appSettings&gt;<br/>    &lt;add key="webpages:Version" value="3.0.0.0" /&gt;<br/>    &lt;add key="webpages:Enabled" value="false" /&gt;<br/>    &lt;add key="ClientValidationEnabled" value="true" /&gt;<br/>    &lt;add key="UnobtrusiveJavaScriptEnabled" value="true" /&gt; <br/>    &lt;add key="ida:Tenant" value="packtb2c.onmicrosoft.com" /&gt;<br/>    &lt;add key="ida:ClientId" value="0c321f85-2f11-402a-84d7-0e3823947038" /&gt;<br/>    &lt;add key="ida:ClientSecret" value="3Tc\(J3.A7w1emrm.v4r|Dxj" /&gt;<br/>    &lt;!--&lt;add key="ida:AadInstance" value="https://login.microsoftonline.com/tfp/{0}/{1}/v2.0/.well-known/openid-configuration" /&gt;--&gt;<br/>    &lt;add key="ida:AadInstance" value="https://login.microsoftonline.com/{0}/v2.0/.well-known/openid-configuration?p={1}" /&gt;<br/>    &lt;add key="ida:RedirectUri" value="https://localhost:44316/" /&gt;<br/>    &lt;add key="ida:SignInPolicyId" value="B2C_1_PacktSigninGoogle" /&gt;<br/>  &lt;/appSettings&gt;</pre>
<ol start="21">
<li class="mce-root"><span>Run the application and click on the</span> <span class="packt_screen">Sign in</span><strong> </strong><span>button. Make sure that the application runs on the IP address that you've configured in the</span> <span>Azure Portal</span> <span>as the</span> <span class="packt_screen">Reply URL</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/1ebd0cf2-7871-4299-ab4c-6b00c36b5437.jpg" style="width:60.50em;height:32.58em;" width="2734" height="1472"/><br/>
<br/>
Signing into the application</div>
<ol start="22">
<li>You can now sign in using your Google account.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered how to secure your resources using the different capabilities that Azure provides. We covered Azure Active Directory and how to design a hybrid environment using Azure AD Connect. We covered ADFS, Azure B2B, and Azure B2C.</p>
<p>The next chapter will be about securing your data.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</p>
<ol>
<li>You are creating a meeting application that leverages data from Office 365. Users should be able to log in using their Azure Active Directory credentials. Can you use Microsoft Graph for this?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You want to create a hybrid environment and use single sign-on for both the on-premises applications as well as the cloud applications. Should you use Azure AD Connect for this?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Is Azure AD B2B the appropriate solution for enabling external sharing in your SharePoint Online environment?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that have been covered in this chapter:</span></p>
<ul>
<li><strong>Azure Active Directory Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/">https://docs.microsoft.com/en-us/azure/active-directory/</a> </li>
<li><strong>Azure AD Connect sync</strong>: Understand and customize synchronization: <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnectsync-whatis">https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnectsync-whatis</a></li>
<li><strong>Azure AD Connect user sign-in options</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-user-signin">https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-user-signin</a></li>
<li><strong>Active Directory Federation Services</strong>: <a href="https://msdn.microsoft.com/en-us/library/bb897402.aspx">https://msdn.microsoft.com/en-us/library/bb897402.aspx</a></li>
<li><strong>Deploying Active Directory Federation Services in Azure</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-azure-adfs">https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-azure-adfs</a> <a href="https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-azure-adfs"/></li>
<li><strong>Multi-factor Authentication Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/">https://docs.microsoft.com/en-us/azure/multi-factor-authentication/</a></li>
<li><strong>What is Azure AD B2B collaboration?</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b">https://docs.microsoft.com/en-us/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b</a></li>
<li><strong>Azure Active Directory B2C: Provide sign-up and sign-in to consumers with Microsoft accounts</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-msa-app">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-msa-app</a></li>
<li><strong>Azure Active Directory B2C: Provide sign-up and sign-in to consumers with Facebook accounts</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-fb-app">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-fb-app</a></li>
<li><strong>Azure Active Directory B2C: Provide sign-up and sign-in to consumers with Google+ accounts</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-goog-app">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-setup-goog-app</a></li>
<li><strong>Azure Active Directory B2C: Register your application</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-app-registration">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-app-registration</a></li>
<li><strong>Azure Active Directory B2C: Enable Multi-Factor Authentication in your consumer-facing applications</strong>: <a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-reference-mfa">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-reference-mfa</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>