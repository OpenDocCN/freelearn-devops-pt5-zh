<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Getting Started with Confluence</h1></div></div></div><p>Atlassian<a id="id0" class="indexterm"/> started back in 2002 and they set out to create software that would be inexpensive, easy to use, and would take little effort to install and maintain. Thanks to these principles, the installation process of Confluence<a id="id1" class="indexterm"/> is relatively easy and straightforward; there is even a one-click installation wizard available. In this chapter, we will start with a high-level overview of Confluence, looking at the different components that make the application. We'll take a look at the different deployment options available, including distribution choices, application servers, and databases. Finally, we will install our own Confluence application from scratch.</p><p>By the end of the chapter, you will have learned about:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The overall architecture of Confluence</li><li class="listitem" style="list-style-type: disc">Platforms and applications supported by Confluence</li><li class="listitem" style="list-style-type: disc">Installing Confluence and all of the required software</li><li class="listitem" style="list-style-type: disc">Configuring database connections</li><li class="listitem" style="list-style-type: disc">Running Confluence, safely</li></ul></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Understanding the architecture</h1></div></div></div><p>Installing <a id="id2" class="indexterm"/>Confluence <a id="id3" class="indexterm"/>is simple and straightforward. However, it is important for us to understand the components involved in the installation process and the options that are available to us. This understanding will help you to make informed decisions and be better prepared for troubleshooting and future updates.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec06"/>High-level architecture</h2></div></div></div><p>Atlassian has a <a id="id4" class="indexterm"/>comprehensive overview of the technical components of Confluence, available at <a class="ulink" href="https://developer.atlassian.com/display/CONFDEV/Confluence+Architecture">https://developer.atlassian.com/display/CONFDEV/Confluence+Architecture</a>. However, <a id="id5" class="indexterm"/>this overview is mainly interesting for <a id="id6" class="indexterm"/>those who are developing some custom add-ons and not so much for day-to-day administration and usage of Confluence. For this reason, we have created a high-level overview that highlights the most important components in the architecture, and how our users will connect to Confluence:</p><div><img src="img/9526_01_01.jpg" alt="High-level architecture"/></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Supported browsers</h2></div></div></div><p>Confluence is a <a id="id7" class="indexterm"/>web application, so the only thing our users <a id="id8" class="indexterm"/>need for accessing it is a compatible web browser. This can be on a desktop system, laptop, or even a mobile device such as a smartphone or tablet. The more recent versions of Confluence depend heavily on some new web technologies and standards. For this reason, older versions of Internet Explorer and Firefox are no longer fully compatible.</p><p>The following table summarizes the browser requirements for Confluence 5.1:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Browsers</p>
</th><th style="text-align: left" valign="bottom">
<p>Compatibility</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Microsoft Internet Explorer (Windows)<a id="id9" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>8, 9 (drag-and-drop not completely supported because Internet Explorer doesn't fully support the related HTML5 feature)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Mozilla Firefox (all platforms)<a id="id10" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>10+</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Safari (Windows and Mac)<a id="id11" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>5, 6</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Google Chrome (Windows and Mac)<a id="id12" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>17+</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Mobile Safari (iOS)<a id="id13" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>iOS 5.1, 6.0 (editing is not supported on mobile devices)</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Data storage</h2></div></div></div><p>The<a id="id14" class="indexterm"/> configuration files, <a id="id15" class="indexterm"/>attachments, indexes, and add-ons are stored, by default, in the Confluence Home directory that is configured when Confluence is first installed. All other data resides in the configured database. Optionally, attachments can be configured to be stored in the database instead of the Confluence Home directory.</p><p>You can choose to store the attachments in the database for ease of backup (all data in one single location) or to cope with characters that are invalid on your file system. Be aware: storing your attachments in the database increases the size of your database drastically. In a clustered environment where data is shared between several Confluence installations, you need <a id="id16" class="indexterm"/>to store <a id="id17" class="indexterm"/>the attachments in the database.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Confluence Installation directory</h2></div></div></div><p>The directory where you install Confluence is called the Installation directory<a id="id18" class="indexterm"/>. It contains<a id="id19" class="indexterm"/> all the executable and configuration files of the application server. Confluence does not modify or store any data in this directory. This directory is primarily used for execution. For the remainder of the book we <a id="id20" class="indexterm"/>will be referring to this directory as <code class="literal">CONF_INSTALL</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Confluence Home directory</h2></div></div></div><p>The Confluence <a id="id21" class="indexterm"/>Home directory is the folder where Confluence stores its <a id="id22" class="indexterm"/>configuration, search indexes, attachments, and add-ons, specific to one Confluence installation. This means that every Confluence installation must, and can, have only one Confluence Home directory, and each Confluence Home directory can serve only one Confluence installation. If you're evaluating Confluence and using the embedded HSQLDB database, the database files are also stored in this directory. For the remainder of this book we will refer to this directory<a id="id23" class="indexterm"/> as <code class="literal">CONF_HOME</code>.</p><p>It's recommended that <code class="literal">CONF_HOME</code> is created separately from the Confluence installation. This separation of data and application makes tasks such as maintenance, back ups, and future upgrades easier. Keep in mind that the Confluence Home directory can grow quite large on an intensively used site.</p><p>Within <code class="literal">CONF_HOME</code> there are several important files and subdirectories:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>File/Directory</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">confluence.cfg.xml</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Confluence's <a id="id24" class="indexterm"/>core <a id="id25" class="indexterm"/>configuration file; includes the configuration for connecting to its database and license key.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Attachments/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>All file <a id="id26" class="indexterm"/>attachments <a id="id27" class="indexterm"/>in the Confluence site are stored under this directory. This is the place Confluence keeps attachment files if those are not stored in the database.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Backups/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If Confluence <a id="id28" class="indexterm"/>is configured to produce daily backups, these are stored in this directory. Administrators<a id="id29" class="indexterm"/> should occasionally delete old backups from this directory to prevent it from growing too large.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Bundled-plugins/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Add-ons bundled <a id="id30" class="indexterm"/>with the <a id="id31" class="indexterm"/>Confluence installation are stored here. User-installed plugins are not kept in this directory.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Config/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Miscellaneous <a id="id32" class="indexterm"/>global and <a id="id33" class="indexterm"/>per-space configuration files are kept in this directory.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Index/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The full-text <a id="id34" class="indexterm"/>search index is kept in this <a id="id35" class="indexterm"/>directory. Removing or modifying files in this directory may cause search to no longer function. A re-index operation from the Administration console will rebuild the files in this folder.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Logs/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The<a id="id36" class="indexterm"/> application log file is <a id="id37" class="indexterm"/>kept here.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Plugins-osgi-cache/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Plugins installed <a id="id38" class="indexterm"/>using <a id="id39" class="indexterm"/>the Confluence interface are downloaded and kept in this directory. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Temp/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Confluence <a id="id40" class="indexterm"/>stores temporary files <a id="id41" class="indexterm"/>in this directory, especially during backups and exports. A daily job within Confluence deletes files that are no longer needed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Thumbnails/</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Stores <a id="id42" class="indexterm"/>temporary files for <a id="id43" class="indexterm"/>image thumbnails. The <a id="id44" class="indexterm"/>contents of this directory can be safely deleted, as Confluence will regenerate thumbnails as required.</p>
</td></tr></tbody></table></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Installation options</h1></div></div></div><p>Confluence <a id="id45" class="indexterm"/>is a<a id="id46" class="indexterm"/> Java-based web application, developed using many open standards and libraries. For this reason, it is able to run on many different operating systems, databases, and application servers. We will take a closer look at the options we have, and make an informed decision on what would work best in our situation.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Standalone and WAR distributions</h2></div></div></div><p>First, we need to decide <a id="id47" class="indexterm"/>on the distribution. Confluence comes in<a id="id48" class="indexterm"/> three distributions:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">One-click installer</li><li class="listitem" style="list-style-type: disc">Standalone bundled with Apache Tomcat</li><li class="listitem" style="list-style-type: disc">WAR/EAR distribution</li></ul></div><p>With regard to the application, there is no difference between the three distributions. The installer and standalone distributions are bundled with Apache Tomcat, which means we don't have to install and configure an application server ourselves. These distributions also come with an embedded in-memory database that can be used for evaluation purposes.</p><p>The installer is a very handy wrapper around the standalone bundle, automating all the steps we normally would have to perform manually. This is great when evaluating Confluence, but it doesn't give us much insight into the steps involved in maintaining our installation. For this reason, we will use the standalone distribution later, when we're going to install Confluence ourselves.</p><p>If you already have a running J2EE application server, or are experienced in installing and tuning one, the WAR distribution<a id="id49" class="indexterm"/> could be something for you. Due to differences between application servers, you are required to build the final deployment artifact with the provided build scripts. Once the artifact is built, you can deploy Confluence just like any other Java web application.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Operating systems</h2></div></div></div><p>Confluence officially <a id="id50" class="indexterm"/>supports Microsoft Windows and Linux (all the distributions). Mac OS is supported only as a client platform. The choice of which operating system to run Confluence on is mostly a matter of preference based on expertise, and in most cases, there is an existing IT infrastructure with specific requirements.</p><p>If you do not have any preferences and would like to keep the initial costs down, Linux would be a good choice as there are no license fees involved. If you have more then 4 GB of memory on your server, make sure to pick a 64-bit version.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Databases</h2></div></div></div><p>Confluence stores all its data in a <a id="id51" class="indexterm"/>relational database. The embedded in-memory HSQLDB database<a id="id52" class="indexterm"/> is only available for evaluation purposes, and should never be used in production environments. To limit the risk of data corruption, it's important that we use an enterprise database for production systems.</p><p>Confluence supports most relational databases available today. There will be no noticeable differences during the installation and configuration of Confluence. Just like the operating systems, your choice of database will come down to personal preference or IT standards within your organization. If you are using Windows as your operating system, the most likely choice would be Microsoft SQL Server. If you are using Linux, then you should consider PostgreSQL<a id="id53" class="indexterm"/>, <a id="id54" class="indexterm"/>MySQL, or <a id="id55" class="indexterm"/>Oracle.</p><p>The following table <a id="id56" class="indexterm"/>summarizes the list of databases currently supported by Confluence 5.1. It's worth mentioning that both PostgreSQL and MySQL are available as open source (free) products, making them excellent options if you are looking to minimize your initial investments.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Database</p>
</th><th style="text-align: left" valign="bottom">
<p>Supported version</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>PostgreSQL</p>
</td><td style="text-align: left" valign="top">
<p>8.4, 9.0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>MySQL</p>
</td><td style="text-align: left" valign="top">
<p>5.1, 5.5</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Microsoft SQL Server</p>
</td><td style="text-align: left" valign="top">
<p>2005, 2008, 2008 R2</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Oracle</p>
</td><td style="text-align: left" valign="top">
<p>11.1, 11.2</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>HSQLDB</p>
</td><td style="text-align: left" valign="top">
<p>(for evaluation purposes only)</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec14"/>Application servers</h2></div></div></div><p>Confluence requires<a id="id57" class="indexterm"/> a J2EE-compatible application<a id="id58" class="indexterm"/> server. The only officially-supported application server is Apache Tomcat. Fortunately, Apache Tomcat is an open source product and available for every operating system.</p><p>Confluence 5.1 will only support <a id="id59" class="indexterm"/>Tomcat 6.0.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Installing Confluence</h1></div></div></div><p>Now that we have a good <a id="id60" class="indexterm"/>understanding of the overall architecture of Confluence and the various installation options, we are ready to install our own<a id="id61" class="indexterm"/> Confluence instance.</p><p>In the following exercise, we will be installing and configuring a fresh Confluence instance that will be ready for production. We will be using the standalone bundle, and the installation will be based upon the Windows platform. If you are planning on using a different operating system, please refer to <a class="ulink" href="https://confluence.atlassian.com/display/DOC/Installing+Confluence">https://confluence.atlassian.com/display/DOC/Installing+Confluence</a> for details on installing Confluence on that specific platform.</p><p>In this exercise we will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Install a <a id="id62" class="indexterm"/>fresh instance of Confluence</li><li class="listitem" style="list-style-type: disc">Configure Confluence to use a relational database</li><li class="listitem" style="list-style-type: disc">Configure <a id="id63" class="indexterm"/>Confluence to send e-mail notifications</li><li class="listitem" style="list-style-type: disc">Configure Confluence as an auto-start Windows service so that it starts automatically</li></ul></div><p>We will continue to use this Confluence instance in other chapters and exercises as we prepare Confluence for usage within your own organization.</p><p>For our implementation, we will be using:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Confluence standalone distribution 5.1.0</li><li class="listitem" style="list-style-type: disc">PostgreSQL 9.0</li><li class="listitem" style="list-style-type: disc">Java Development Kit 7 update 9</li><li class="listitem" style="list-style-type: disc">Microsoft Windows Server 2008 R2</li></ul></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Installing Java</h2></div></div></div><p>Confluence requires Java to be installed on the system, so this is our first step. Confluence 5.1 requires the latest update of JDK 7. If you are installing a different version of Confluence, make sure if JDK 7 is supported. Your choice between a 32-bit or 64-bit version depends on the amount of memory you want to allocate to Confluence; if it's more then 4 GB, pick the 64-bit version as 4 GB is the upper limit for the 32-bit version.</p><p>Currently, it is only possible to install Confluence as a Windows service if it is running on a 32-bit Java version.</p><p>Perform the following <a id="id64" class="indexterm"/>steps to<a id="id65" class="indexterm"/> install Java on your system:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest version of 32-bit JDK 7 from <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a>.</li><li class="listitem">Double-click on the downloaded installation file to start the installation wizard.</li><li class="listitem">Select where you would like to install Java; or you can simply accept the default values. The location where you install the JDK will be referred to as <code class="literal">JAVA_HOME</code> for the rest of the book.</li><li class="listitem">Create a new environmental variable named <code class="literal">JAVA_HOME</code> with the path where you just installed Java, as shown in the following screenshot:<div><img src="img/9526_01_02.jpg" alt="Installing Java"/></div></li><li class="listitem">Test if <a id="id66" class="indexterm"/>installation <a id="id67" class="indexterm"/>was successful by typing the following command in the command prompt:<div><pre class="programlisting">
<strong>java –version</strong>
</pre></div><p>This should display the version of Java installed:</p><div><pre class="programlisting">
<strong>C:\&gt;java –version</strong>
<strong>java version "1.7.0_17"</strong>
<strong>Java(TM) SE Runtime Environment (build 1.7.0_17-b02)</strong>
<strong>Java HotSpot(TM) Client VM (build 23.7-b01, mixed mode, sharing)</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Installing PostgreSQL</h2></div></div></div><p>The next step is<a id="id68" class="indexterm"/> to prepare a <a id="id69" class="indexterm"/>database for our Confluence installation.</p><p>To install PostgreSQL, simply perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Download PostgreSQL<a id="id70" class="indexterm"/> from <a class="ulink" href="http://www.postgresql.org/download/windows/">http://www.postgresql.org/download/windows/</a>.<div><div><h3 class="title"><a id="note02"/>Note</h3><p>At the time of writing, the most recent version of PostgreSQL was not supported by Confluence. We will be using PostgreSQL Version 9.0.12.</p></div></div></li><li class="listitem">Double-click on the downloaded installation file to start the installation wizard.</li><li class="listitem">Select where you would like to install PostgreSQL and want to store the data. We'll be using the default settings during this exercise.</li><li class="listitem">Choose a password for the root user; keep in mind that this is not the password for our Confluence database. I used <code class="literal">p0stgre$</code>, to keep it simple and easy to remember during this exercise and confirm to the Windows 2008 password security rules.</li><li class="listitem">If you choose a different port number, please make sure it doesn't conflict with any other services running on your machine. Also remember the port number, as we'll need it later.</li><li class="listitem">Uncheck the checkbox to make sure Stack Builder isn't launched at the completion of the installation process. We don't need it.<div><img src="img/9526_01_03.jpg" alt="Installing PostgreSQL"/></div></li></ol></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Creating a user and a database</h3></div></div></div><p>Now that PostgreSQL is installed on our machine, we need to create a dedicated user and database for Confluence to use. This will prevent other users of the application from accessing Confluence data.</p><p>Perform the following <a id="id71" class="indexterm"/>steps<a id="id72" class="indexterm"/> to create a new user and a database:</p><div><ol class="orderedlist arabic"><li class="listitem">Start the <a id="id73" class="indexterm"/><strong>pgAdmin III</strong> administration tool, which has just been installed by the installer. We will be using this administration tool to create the Confluence user and database.</li><li class="listitem">Connect to the PostgreSQL server running at localhost, by double-clicking on the server name. Enter the root password you just picked, when prompted:<div><img src="img/9526_01_04.jpg" alt="Creating a user and a database"/></div></li><li class="listitem">Create a <a id="id74" class="indexterm"/>new<a id="id75" class="indexterm"/> user, or "login role," as PostgreSQL calls it. Right-click on <strong>Login Roles</strong> in the object browser (on the left) and select <strong>New Login Role...</strong>:<div><img src="img/9526_01_05.jpg" alt="Creating a user and a database"/></div><div><ol class="orderedlist arabic"><li class="listitem">Enter the username: <code class="literal">confluence</code>.</li><li class="listitem">Enter the password: <code class="literal">confluence</code>.</li><li class="listitem">Do not select any role privileges.</li><li class="listitem">Confirm<a id="id76" class="indexterm"/> the<a id="id77" class="indexterm"/> creation of the role.</li></ol></div></li><li class="listitem">Create a new <a id="id78" class="indexterm"/>database; right-click on <strong>Databases</strong> <a id="id79" class="indexterm"/>and select <strong>New Database</strong>.<div><ol class="orderedlist arabic"><li class="listitem">Enter the database name: <strong>confuencedb</strong>.</li><li class="listitem">Set the owner of the database to the user we just created.</li><li class="listitem">Select <strong>UTF-8</strong> for encoding.</li><li class="listitem">Confirm the creation of the database.</li></ol></div></li><li class="listitem">That is it. We<a id="id80" class="indexterm"/> have installed PostgreSQL and <a id="id81" class="indexterm"/>created a user and database for our Confluence installation to use.</li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec17"/>Installing Confluence</h2></div></div></div><p>Now that we have the <a id="id82" class="indexterm"/>JDK and database prepared, we have met all the conditions required to install Confluence on our machine. In order to get Confluence installed we have to:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Unpack Confluence</li><li class="listitem" style="list-style-type: disc">Configure the Confluence Home directory</li><li class="listitem" style="list-style-type: disc">Check the ports Confluence uses</li><li class="listitem" style="list-style-type: disc">Configure e-mail</li></ul></div><p>Optionally, we can configure Confluence to use HTTPS and run as a Windows service.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Unpacking Confluence</h3></div></div></div><p>Perform the following <a id="id83" class="indexterm"/>steps to <a id="id84" class="indexterm"/>unpack Confluence:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest version of Atlassian Confluence from <a class="ulink" href="http://www.atlassian.com/software/confluence/download">www.atlassian.com/software/confluence/download</a>.</li><li class="listitem">The Atlassian website will detect the operating system you are using and will suggest a distribution accordingly. If you intend to install Confluence on a different system than the one you are currently on, make sure you select the correct distribution.</li><li class="listitem">As mentioned before, there are one-click installers available for both Windows and Linux. For the purpose of this exercise we will be using the ZIP archive, as it will provide us with an insight of the steps that are normally hidden by the installation process.</li><li class="listitem">Extract the downloaded ZIP file to <code class="literal">c:/confluence/</code>. It is recommended to use a third-party unzip software, such as 7-Zip or WinZip, as there are known issues with the unzip application provided with Windows. You can choose a different installation path; just make sure that you don't use spaces in your directory path.</li><li class="listitem"><code class="literal">C:\confluence\atlassian-confluence-5.1</code> will now be known as <code class="literal">CONF_INSTALL</code>. Next, we will define the Confluence Home directory.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Configuring Confluence Home</h3></div></div></div><p>Next we have to define and <a id="id85" class="indexterm"/>configure <code class="literal">CONF_HOME</code>. Remember that <a id="id86" class="indexterm"/>we want to<a id="id87" class="indexterm"/> keep our data separated from our installation data.</p><div><ol class="orderedlist arabic"><li class="listitem">Create <code class="literal">c:\confluence\data</code>; this directory will now be known as <code class="literal">CONF_HOME</code>.</li><li class="listitem">Open <code class="literal">CONF_INSTALL</code> and open the file <code class="literal">confluence\WEB-INF\classes\confluence-init.properties</code> in your favorite text editor.</li><li class="listitem">Locate the following line; it's usually at the end of the file.<p>
<code class="literal"># confluence.home=c:/confluence/data</code>
</p></li><li class="listitem">Remove the <code class="literal">#</code> and the space at the beginning of this line, so that Confluence no longer regards it as a comment.</li><li class="listitem">If you have selected a different directory for <code class="literal">CONF_HOME</code>, then change the path accordingly. Please note the following:<div><ol class="orderedlist arabic"><li class="listitem">Avoid spaces in the directory path.</li><li class="listitem">Use forward slashes <code class="literal">/</code> to define the path.</li></ol></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec08"/>Configuring the port</h3></div></div></div><p>By default, <a id="id88" class="indexterm"/>Confluence runs on port 8090 with no context<a id="id89" class="indexterm"/> path. This means that after starting Confluence it will be available at <code class="literal">http://localhost:8090/</code>. If you have another application running on your machine that is using the same ports, you may need to change the port Confluence will use. Changing the context path is useful when you are running your applications behind a proxy and want to access them with the same domain, for example, <code class="literal">http://example.com/jira</code> and <code class="literal">http://example.com/confluence</code>. For this exercise we will be changing the context Confluence is running on to <code class="literal">/confluence</code>.</p><p>To change the ports for Confluence, open the file <code class="literal">conf/server.xml</code> under your <code class="literal">CONF_INSTALL</code> directory. An extract from that file is shown here:</p><div><pre class="programlisting">&lt;Server port="8000" shutdown="SHUTDOWN" debug="0"&gt;
&lt;Connector className="org.apache.coyote.tomcat4.CoyoteConnector" port="8090"…. /&gt;
&lt;Context path="/confluence" docBase="../confluence" debug="0" reloadable="false" useHttpOnly="true"&gt;</pre></div><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p>
<strong>Downloading the example code</strong>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>Line 1: This line specifies the port for the command to shut down Tomcat. By default this port is 8000. If you already have an application running on that port, you can change this to another port.</p><p>Line 2: This line specifies on which port Confluence/Tomcat will be running. By default this is port 8090. If that port is unavailable for some reason, you can change it to another available port.</p><p>Line 3: This line <a id="id90" class="indexterm"/>allows you to change the context path on which <a id="id91" class="indexterm"/>Confluence will be available. By default the path is empty, meaning Confluence will be available on <code class="literal">http://hostname:portnumber/</code>.</p><p>For this exercise we will change the context path to <code class="literal">/confluence</code>, as shown in the previous file.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec09"/>Configuring e-mail JNDI resource</h3></div></div></div><p>In order to use the share and <a id="id92" class="indexterm"/>notification features from <a id="id93" class="indexterm"/>Confluence an e-mail account<a id="id94" class="indexterm"/> has to be set up. Normally, we could do this using the Confluence interface, but there is an exception if you want to use SMTPS, with your Gmail account for example. So for this exercise we will be configuring Confluence to use your Gmail account for sending e-mail notifications to the users.</p><div><ol class="orderedlist arabic"><li class="listitem">Move (<em>don't copy</em>) <code class="literal">activation-1.0.2.jar</code> and <code class="literal">mail-1.4.1.jar</code> from <code class="literal">CONF_INSTALL/confluence/WEB-INF/lib</code> to <code class="literal">CONF_INSTALL/lib</code>.</li><li class="listitem">Add the following resource to your <code class="literal">CONF_INSTALL/conf/server.xml</code>; make sure to add it just before the <code class="literal">&lt;/Context&gt;</code> tag.<div><pre class="programlisting">&lt;Resource name="mail/GmailSMTPServer"
auth="Container"
type="javax.mail.Session"
mail.smtp.host="smtp.gmail.com"
mail.smtp.port="465"
mail.smtp.auth="true"
mail.smtp.user="yourEmailAddress@gmail.com"
password="yourPassword"
  mail.smtp.starttls.enable="true"
  mail.transport.protocol="smtps"
mail.smtp.socketFactory.class="javax.net.ssl.SSLSocketFactory"
/&gt;</pre></div></li><li class="listitem">Replace <code class="literal">yourEmailAddress@gmail.com</code> and <code class="literal">yourPassword</code> with the proper values for your account.</li><li class="listitem">Remember or write down the resource name. When we are configuring Confluence and asked for an e-mail server the JNDI location will be:<p>
<code class="literal">java:comp/env/mail/GmailSMTPServer</code>
</p><p>Note that the name is case-sensitive.</p></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec10"/>Configuring HTTPS</h3></div></div></div><p>By default, Confluence runs<a id="id95" class="indexterm"/> with a standard, non-encrypted HTTP protocol. This is <a id="id96" class="indexterm"/>acceptable if you are running Confluence<a id="id97" class="indexterm"/> in a secured environment, such as an internal network. However, if you are planning to open up access to Confluence via the Internet, you need to tighten the security. We will be doing this by configuring Confluence to run over HTTPS (HTTP over SSL), so that login information and data are encrypted during transport over the Internet.</p><p>For a standalone installation, we need to perform the following tasks:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create or request a new SSL Certificate</li><li class="listitem" style="list-style-type: disc">Enable HTTPS on our application server</li><li class="listitem" style="list-style-type: disc">Redirect traffic to HTTPS</li></ul></div><p>First, we need to get a digital certificate. This can be one from a Certification Authority such as VeriSign or StartSSL (CA certificate), or a self-signed certificate generated by you. A CA certificate will not only encrypt your data, but also identify your copy of Confluence to users. A self-signed certificate is useful when you do not have a valid CA certificate and you are only interested in setting up HTTPS for encryption.</p><p>Because a self-signed certificate is not signed by a Certificate Authority, users may receive a message that the site is not to be trusted and may have to perform several steps to accept the certificate before they can access the site. This usually will only occur the first time they access the site. A self-signed certificate is great for evaluation purposes, but I would recommend a CA certificate<a id="id98" class="indexterm"/> for your production environment.</p><p>For the purpose of this exercise we will create a self-signed certificate. If you already have a CA certificate you can, of course, use that certificate.</p><div><div><div><div><h4 class="title"><a id="ch01lvl4sec01"/>Generating a certificate</h4></div></div></div><p>Follow these steps to <a id="id99" class="indexterm"/>generate a certificate using Java's keytool utility. This tool is included in the JDK and can be found in <code class="literal">JAVA_HOME/bin</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">Run the following command in the command prompt:<div><pre class="programlisting">
<strong>"%JAVA_HOME%/bin/keytool.exe" -genkeypair -alias tomcat -keyalg RSA</strong>
</pre></div></li><li class="listitem">When asked for a password:<div><ol class="orderedlist arabic"><li class="listitem">Specify the password you want to use for the certificate. Note that the password text will not appear as you type.</li><li class="listitem">Make a note of the password you choose; we will need it in the next step when editing the Tomcat configuration.</li><li class="listitem">In this exercise we will be using the default password <code class="literal">changeit</code>.</li></ol></div></li><li class="listitem">Follow the prompts to specify your domain name, organization, and location. This information is used to construct the X.500 Distinguished Name (DN) of the entity. To the question <strong>What is your first and last name?</strong> (CN), don't give your actual name. The CN must match the fully-qualified hostname of the server running Confluence. Tomcat will not be able to use the certificate for SSL otherwise.<p>For example, for our Confluence, running on localhost:</p><p>CN = <code class="literal">localhost</code>, OU = <code class="literal">Confluence Essentials</code>, O = <code class="literal">Packt</code>, C = <code class="literal">UK</code>
</p></li><li class="listitem">Enter <code class="literal">y</code> to<a id="id100" class="indexterm"/> confirm the details.</li><li class="listitem">When asked for the password for <code class="literal">tomcat</code> (the alias you entered in the keytool command), press the <em>Enter</em> key. You <em>must</em> use the same password here as the one that was used for the keystore password. This is a restriction of the Tomcat implementation.</li><li class="listitem">Your certificate is now ready.</li></ol></div><p>Our self-signed certificate is now available in Java's keystore. If you are using a previously generated certificate or a CA certificate, you will need to import that certificate into Java's keystore. This can be done with the following command:</p><div><pre class="programlisting">
<strong>keytool -importcert -alias tomcat -file &lt;MY_CERTIFICATE_FILENAME&gt;</strong>
</pre></div></div><div><div><div><div><h4 class="title"><a id="ch01lvl4sec02"/>Configuring Tomcat</h4></div></div></div><p>To enable HTTPS, open<a id="id101" class="indexterm"/> the <code class="literal">CONF_INSTALL/conf/server.xml</code> file in a text editor. Locate and uncomment the <a id="id102" class="indexterm"/>following lines:</p><div><pre class="programlisting">&lt;Connector port="8443" maxHttpHeaderSize="8192"
    maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
    enableLookups="false" disableUploadTimeout="true"
    acceptCount="100" scheme="https" secure="true"
    clientAuth="false" sslProtocol="TLS" SSLEnabled="true"
    URIEncoding="UTF-8" keystorePass="&lt;MY_CERTIFICATE_PASSWORD&gt;"/&gt;</pre></div><p>This connector will enable HTTPS for Confluence on port 8443. We will have to replace <code class="literal">&lt;MY_CERTIFICATE_PASSWORD&gt;</code> with the password we specified when creating our certificate. In our case this would be <code class="literal">changeit</code>.</p><p>By default, Tomcat expects the keystore file to be named <code class="literal">.keystore</code> and be located in the user home directory under which Tomcat is running. This could be a different account than your own, and therefore, can be another directory. If your certificate is not in the default location, you will have to update the server configuration to include <code class="literal">keystoreFile="&lt;MY_CERTIFICATE_LOCATION&gt;"</code> in the connector element.</p></div><div><div><div><div><h4 class="title"><a id="ch01lvl4sec03"/>Redirecting traffic to HTTPS</h4></div></div></div><p>Although HTTPS is <a id="id103" class="indexterm"/>now active and available, the old HTTP URLs are still<a id="id104" class="indexterm"/> available. We will have to set up Confluence so that it will redirect automatically from an HTTP to an HTTPS request. We will need to do this by adding a security constraint in <code class="literal">web.xml</code>.</p><p>Open <code class="literal">CONF_INSTALL/confluence/WEB-INF/web.xml</code> and add the following snippet to the end of the file, before the <code class="literal">&lt;/web-app&gt;</code> tag:</p><div><pre class="programlisting">&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;Restricted URLs&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;user-data-constraint&gt;
    &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
  &lt;/user-data-constraint&gt;
&lt;/security-constraint&gt;</pre></div><p>This will cause Tomcat to redirect all requests that come in on a non-SSL port. The first part will make sure all URLs are checked by this security constraint. The second part will guarantee that HTTPS is used for transportation.</p></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec11"/>Configuring Confluence as a service</h3></div></div></div><p>Under Windows, Confluence can be configured to run as a Windows service, thus starting up automatically when the operating system reboots. This is recommended, as the alternative is having a console window open on the machine, which could be accidentally closed, thus shutting down Confluence.</p><p>To configure Confluence as a <a id="id105" class="indexterm"/>Windows service, <a id="id106" class="indexterm"/>simply perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Start a new command prompt as administrator, and browse to the <code class="literal">CONF_INSTALL/bin</code> directory.</li><li class="listitem">Run the following command:<div><pre class="programlisting">
<strong>service.bat install Confluence</strong>
</pre></div></li><li class="listitem">This will install Confluence as a Windows service. The service will be called Apache Tomcat Confluence.</li><li class="listitem">Verify the configuration by going to the Services console by going to <strong>Start</strong> | <strong>Administrative Tools</strong> | <strong>Services</strong>.<div><img src="img/9526_01_06.jpg" alt="Configuring Confluence as a service"/></div></li></ol></div><p>You can now start, stop, and restart Confluence from the Windows service panel.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Starting Confluence</h1></div></div></div><p>Everything is in place to <a id="id107" class="indexterm"/>start our installation of Confluence. So let us start Confluence using the Services console in Windows. Once the server is running, you can access Confluence using your Internet browser. The URL to your Confluence is <code class="literal">https://localhost:8443/confluence</code>. If you didn't add the HTTPS or context path to your installation, you can find Confluence at <code class="literal">http://localhost:8090/</code>.</p><p>If you used a self-signed certificate, you will get a prompt that there is a certificate error, similar to the one shown in the following screenshot:</p><div><img src="img/9526_01_07.jpg" alt="Starting Confluence"/></div><p>The first <a id="id108" class="indexterm"/>page you will see is the first step in the configuration wizard, which will finalize your Confluence installation.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Installation wizard</h2></div></div></div><p>The first step in the <a id="id109" class="indexterm"/>wizard is providing a valid license. This can be<a id="id110" class="indexterm"/> either a full license or an evaluation license. If you have already obtained a license from Atlassian, you can cut and paste it into the <strong>License Key</strong> textbox. If you don't have a license, you can generate an evaluation license by clicking on the <strong>generate an evaluation license online</strong> link. Once you have filled in the license key, you have to choose your installation type. We are going to install a <strong>Production Installation</strong>, so choose that option.</p><div><img src="img/9526_01_08.jpg" alt="Installation wizard"/></div><p>Step 2 is to <a id="id111" class="indexterm"/>configure our database connection. Select <strong>PostgreSQL</strong> <a id="id112" class="indexterm"/>from the drop-down list at the bottom and click on <strong>External Database</strong>. You will get the choice on how to connect to the database. This is either through JDNI or Direct JDBC. The difference is that JNDI is configured and managed on the application server, just like the SMTPS e-mail server. Direct JDBC is configured within the application.</p><p>For this exercise, we'll be using the Direct JDBC option.</p><p>On this screen we have to fill out our database configuration:</p><div><img src="img/9526_01_09.jpg" alt="Installation wizard"/></div><p>Enter the details for your <a id="id113" class="indexterm"/>database configuration according to the fields<a id="id114" class="indexterm"/> explained here:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Driver Class Name</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">org.postgresql.Driver</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Database URL</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">jdbc:postgresql://localhost:5432/confluencedb</code>
</p>
<p>If you configured a different port number for PostgreSQL, be sure to also change it in this URL.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>User Name</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">confluence</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Password</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">confluence</code>
</p>
</td></tr></tbody></table></div><p>Click on <strong>Next</strong> to start the initialization of the database. This could take a while, so hold on.</p><p>After the database is initialized, you will get to the next screen (shown in the next screenshot), where you can choose how you would like to load content:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Example Site</strong>: This will load a demonstration space into Confluence, showing some of the features Confluence has to offer. Great if you want to evaluate Confluence.</li><li class="listitem" style="list-style-type: disc"><strong>Empty Site</strong>: A clean Confluence installation, without any space or content. Perfect if you are already familiar with Confluence and want to get started quickly.</li><li class="listitem" style="list-style-type: disc"><strong>Restore From Backup</strong>: If <a id="id115" class="indexterm"/>you already have a Confluence <a id="id116" class="indexterm"/>installation and a backup from that installation, you can import it using this option. Make sure that the backup data is from the same major version as the target Confluence.<div><img src="img/9526_01_10.jpg" alt="Installation wizard"/></div></li></ul></div><p>For our installation we will pick <strong>Example Site</strong>, as this gives us some exposure on how we could use Confluence.</p><p>Once <strong>Example Site</strong> is loaded, it is time to set up user management. Choose to set up user management within Confluence. Connecting user management to an external source is discussed in <a class="link" href="ch02.html" title="Chapter 2. User Management">Chapter 2</a>, <em>User Management</em>.</p><p>Set up the System <a id="id117" class="indexterm"/>Administrator account and make sure you<a id="id118" class="indexterm"/> remember the username/password, because Confluence only stores the hashed value of your password. You will not be able to retrieve it.</p><div><img src="img/9526_01_11.jpg" alt="Installation wizard"/></div><p>Confluence is now ready for use; you can either start using it or continue configuring. As for this exercise, we want to continue and set up the e-mail server, so choose <strong>Continue configuration</strong>. After logging in with your system administrator account, you will see the Confluence Administrator console.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec19"/>Setting up the e-mail server</h2></div></div></div><p>Log in to Confluence and go to the <a id="id119" class="indexterm"/>
<strong>Administration Console</strong> <a id="id120" class="indexterm"/>by going to <strong>Administration</strong> | <strong>Confluence Admin</strong>. You might have to log in another time due to Confluence's <strong>WebSudo</strong>. WebSudo<a id="id121" class="indexterm"/> prevents other people from accessing the administrator console, if you left your machine unattended, for example.</p><p>In <strong>Administration </strong>
<a id="id122" class="indexterm"/>
<strong>Console</strong>, select <strong>Mail Servers</strong> in the left <a id="id123" class="indexterm"/>menu. Select <strong>Add a new SMTP mail server</strong> to add a new SMTP mail server that Confluence will use to send notifications and password resets.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Name</p>
</td><td style="text-align: left" valign="top">
<p>The name of the SMTP server used for reference within Confluence.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>From address</p>
</td><td style="text-align: left" valign="top">
<p>Enter the e-mail address the e-mail is sent from. In most cases this must be the same address as the e-mail account you're using.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>From Name</p>
</td><td style="text-align: left" valign="top">
<p>Enter the name that will be displayed in the <code class="literal">from</code> field for e-mail messages originating from this server. This field accepts the following variables, which reference specific details defined in the relevant Confluence user's profile:</p>
<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">${fullname}</code>, The user's full name</li><li class="listitem" style="list-style-type: disc"><code class="literal">${email}</code>, The user's e-mail address</li><li class="listitem" style="list-style-type: disc"><code class="literal">${email.hostname}</code>, the domain name of the user</li></ul></div>
<p>The default is <code class="literal">${fullname} (Confluence)</code>. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Subject Prefix</p>
</td><td style="text-align: left" valign="top">
<p>Enter some text to appear at the beginning of the subject line.</p>
</td></tr></tbody></table></div><p>Enter <em>either</em> the hostname and credentials of your mail server, or the JDNI resource. As we set up a Gmail account earlier, we will be using that one:</p><div><img src="img/9526_01_12.jpg" alt="Setting up the e-mail server"/></div><p>The <a id="id124" class="indexterm"/>JNDI location will be <strong>java:comp/env/mail/GmailSMTPServer</strong>.</p><p>Submit the configuration, <a id="id125" class="indexterm"/>and try to send a test e-mail to yourself to verify the settings.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Summary</h1></div></div></div><p>We have seen that getting started with Confluence is fairly straightforward; it is also very flexible with regard to options you can choose from, when installing your copy of Confluence. You can mix these options to suit your situation best, or to comply with your IT department's requirements. If you wish to keep initial costs as low as possible, you can install Confluence completely with open source software, such as Linux and Postgresql, which are available for free.</p><p>Now that we have installed Confluence and gone through the set up wizard, we will start to dive deeper into the various aspects of Confluence. In the next chapter, we will go into how to manage your users and groups, as Confluence is not intended to be used alone.</p></div></body></html>