<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Security and Administration</h1>
                </header>
            
            <article>
                
<p>Security is often one of main reasons why many organizations are postponing their move to the cloud. There are too many unknown factors; people don't understand how security is set up and often don't trust anyone with their data. "If it leaves our data center, then I don't know what is happening to it" is something I have heard often over the years.</p>
<p>The truth is that your data is probably far more secure in Azure than it could ever be in your local center. In this chapter, I'll try to explain how security in Azure is set up and remove any doubts about cloud security.</p>
<p><span>The following topics will be covered in this chapter:</span></p>
<ul>
<li>Azure Active Directory multi-factor authentication</li>
<li>Azure Network Security</li>
<li>Azure Firewall</li>
<li>Data encryption</li>
<li>Azure Key Vault</li>
<li>Azure Security Center</li>
<li>Advanced threat protection</li>
<li>Just-in-Time access</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>For this chapter you'll need the following:</p>
<ul>
<li>An Azure subscription</li>
<li>PowerShell</li>
<li>Azure PowerShell</li>
</ul>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Demystifying cloud security</h1>
                </header>
            
            <article>
                
<p>So, how secure is Azure really? Let's start by saying very secure. </p>
<p>Microsoft is investing heavily in Azure, and particularly in Azure Security. Azure has extensive compliance offerings, including HIPAA, FFIEC, PCI DSS, ISO 9001, and ISO 27001, just to name a few.</p>
<p>Azure Security starts with physical security. Data center has dedicated security staff around the clock; everything is covered by cameras and alarms, and there are several layers of perimeter checks.</p>
<p>To enter the Azure data center, you need to pass several checkpoints and provide valid authentication and authorization. Authentication is done on multi-factor levels, and besides providing a PIN or password, you must pass biometric and card reader checks as well.</p>
<p>Everything within data centers is encrypted and secure. All data is encrypted at rest, and even if someone manages to steal a disk containing your data, it would be unusable. All data transferring is also encrypted per industry standards.</p>
<p>Another important part of data security is redundancy to ensure that data is never lost. The default redundancy in Azure is 3 (three). When you create a new resource, Azure VM for example, a disk is created with three copies. This ensures that data is always available, and even if one disk fails, there are an additional two copies. Redundant 3 is present even with backup power generators; if one fails, there are two additional backups.</p>
<p>And even Microsoft is heavily involved in Azure Security; it's not enough to put your data into Azure for it to be safe. The partnership with Microsoft takes care of one part of security and provides various tools and services to help you stay secure. However, you are responsible for how you implement these tools and put them to use.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Securing your identity</h1>
                </header>
            
            <article>
                
<p>Securing your identity is a very important part of IT security. Most data breaches happen as a result of social engineering or phishing attacks. So, in most cases, leaked credentials are responsible for breaches. </p>
<p class="mce-root"/>
<p>Azure Active Directory offers a few tools to improve security, and one that stands up is <strong>multi-factor authentication</strong> (<strong>MFA</strong>). MFA requires users to provide additional security authentication after signing in. <span>After a user provides a username and password, additional action is required to prove their identity. </span>Many different tools can be used for additional checks, like biometric readers or card readers, but the most popular tool is a mobile device. After signing in, a user receives a notification on their mobile device and needs to provide additional confirmation. Notifications can be in the form of a phone call (the user needs to provide a code during the call), a text message (a user receives a code that needs to be provided during login), or an application (connected to the user<span> account and requires confirmation that the user is trying to log in).</span></p>
<p><span>When MFA is enabled, leaked credentials are less of a</span> concern, as stealing a username and password is not enough to access data anymore. Access to a user's mobile device is required to authorize your sign-in attempt, and this makes data breaching much harder.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Enabling multi-factor authentication</h1>
                </header>
            
            <article>
                
<p>Enabling MFA in Azure Active Directory is simple and fast. In Azure Active Directory, under <span class="packt_screen"><span>User manageme</span><span>nt</span></span><span> you need to select <span class="packt_screen">Multi-Factor Authentication</span>. An example is shown in the screenshot:</span></p>
<p> </p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-744 image-border" src="Images/d7072359-f3db-423f-bf95-142b5e799985.png" style="width:111.75em;height:38.33em;" width="1341" height="460"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p>A new window will open in which all MFA is done. Here, you can set up individual user settings or do bulk updates for multiple users. Under <span class="packt_screen">Service settings</span>, you can also edit what options are available for MFA and choose between a phone call, text message, mobile app, or token. To enable a single user for MFA, select the user and click <span class="packt_screen">Enable</span> in the settings on the right side, as shown:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-745 image-border" src="Images/32bbd793-cc46-41ee-9d99-932f4fcadf67.png" style="width:118.08em;height:56.92em;" width="1417" height="683"/></p>
<p>MFA is free for users with the global administrator role. So, there is no excuse for not adding an additional layer of security for admins as a leaked admin account can do far more damage than a regular user. However, if you want to enable MFA for all users, then an additional license is required. MFA comes with Azure Active Directory Premium, but can be licensed as a standalone service per user or per login.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Other identity security options</h1>
                </header>
            
            <article>
                
<p>Azure Active Directory offers other services that can help you increase security.</p>
<p>Other service such as conditional access or privileged identity management can help us increase security and prevent unauthorized access. We can use audit logs and risky sign-ins to review who tried to access services and data and when. There are extensive Azure Active Directory logs that can be used for audits as well. Most of these features come with AAD Premium and aren't available with a basic or free license.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Securing the network</h1>
                </header>
            
            <article>
                
<p>The next step in staying secure is securing our network resources. Leaving a network unprotected can result in data breaches or service denial. Even the Azure networking stack comes with lots of security features, such as default DDOS protection or network security groups; sometimes this is not enough and we need to take additional steps.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Firewall</h1>
                </header>
            
            <article>
                
<p><span>Azure Firewall is a managed, cloud-based network security service that protects Azure Virtual Network resources. It is Firewall as a Service with built-in high availability and scalability.</span></p>
<p><span>With Azure Firewall, you can create, enforce, and log application and network connectivity policies. Static public IP addresses for your virtual network resources allow outside firewalls to identify traffic originating from your virtual network. The service is integrated with Azure Monitor for logging and analytics.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Preparing the environment</h1>
                </header>
            
            <article>
                
<p>Azure Firewall requires you to be connected to a subnet named AzureFirewallSubnet. We can create a new Azure VNet and a new subnet in the process of creating new Azure Firewall. But as I already have the VNet that I want to use, I'll add a new subnet to <kbd>PackVnet</kbd>, which was previously created.</p>
<p>An example of how to add a new subnet for Azure Firewall is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-746 image-border" src="Images/cdefc1e3-463f-436c-869f-04d06174824f.png" style="width:34.75em;height:42.50em;" width="573" height="701"/></p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Firewall</h1>
                </header>
            
            <article>
                
<p>To create a new Azure Firewall, we need to provide a <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource group</span>, <span class="packt_screen">Name</span>, and <span class="packt_screen">Location</span>. Additionally, we need to provide a <span class="packt_screen">Virtual network</span> and <span class="packt_screen">Public IP address</span>. In both cases, we can <span class="packt_screen">Use existing</span> resources or <span class="packt_screen">Create new</span> ones. Note that for the existing virtual network, <kbd>AzureFirewallSubnet</kbd> must exist. Example parameters are shown in the screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-747 image-border" src="Images/009801d9-757d-439e-865c-5506e2448322.png" style="width:75.17em;height:55.67em;" width="902" height="668"/></p>
<p>After the deployment is finished, Azure Firewall is ready for use and we can start the configuration. For now, take note of the <span class="packt_screen">Private IP address</span> (remember it or write it down), as we are going to need it in the next few steps.</p>
<p>The Azure Firewall blade is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-748 image-border" src="Images/bd63d41f-4b2c-40d9-9377-a6b062c8972e.png" style="width:51.42em;height:25.08em;" width="942" height="460"/></p>
<p>To deploy Azure Firewall, we can use ARM templates as well. </p>
<p>Here is the ARM template to deploy a new Azure Firewall:</p>
<pre>{<br/>    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>        "location": {<br/>            "type": "string"<br/>        },<br/>        "resourceGroup": {<br/>           "type": "string"<br/>        },<br/>        "azureFirewallName": {<br/>            "type": "string"<br/>        },<br/>        "vnetName": {<br/>            "type": "string"<br/>        },<br/>        "vnetAddressSpace": {<br/>            "type": "string"<br/>        },<br/>        "subnetAddressSpace": {<br/>            "type": "string"<br/>        },<br/>        "publicIpAddressName": {<br/>            "type": "string"<br/>        },<br/>        "subnetId": {<br/>            "type": "string"<br/>        }<br/>    },<br/>    "variables": {<br/>        "networkApiVersion": "?api-version=2018-08-01"<br/>    },<br/>    "resources": [<br/>        {<br/>            "apiVersion": "2018-08-01",<br/>            "type": "Microsoft.Network/publicIpAddresses",<br/>            "name": "[parameters('publicIpAddressName')]",<br/>            "location": "[parameters('location')]",<br/>            "sku": {<br/>                "name": "Standard"<br/>            },<br/>            "properties": {<br/>                "publicIPAllocationMethod": "Static"<br/>            },<br/>            "tags": {}<br/>        },<br/>        {<br/>            "apiVersion": "2018-07-01",<br/>            "type": "Microsoft.Network/azureFirewalls",<br/>            "name": "[parameters('azureFirewallName')]",<br/>            "location": "[parameters('location')]",<br/>            "dependsOn": [<br/>                "[resourceId(parameters('resourceGroup'), 'Microsoft.Network/publicIpAddresses', parameters('publicIpAddressName'))]"<br/>            ],<br/>            "properties": {<br/>                "ipConfigurations": [<br/>                    {<br/>                        "name": "IpConf",<br/>                        "properties": {<br/>                            "subnet": {<br/>                                "id": "[parameters('subnetId')]"<br/>                            },<br/>                            "publicIPAddress": {<br/>                                "id": "[resourceId(parameters('resourceGroup'), 'Microsoft.Network/publicIpAddresses', parameters('publicIpAddressName'))]"<br/>                            }<br/>                        }<br/>                    }<br/>                ]<br/>            },<br/>            "tags": {}<br/>        }<br/>    ]<br/>}</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Route Table</h1>
                </header>
            
            <article>
                
<p>Now we want to create a route table that will direct all traffic through Azure Firewall. To create a new Azure Route Table, we need to provide a <span class="packt_screen">Name</span>, <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource group</span>, and <span class="packt_screen">Location</span>. Optionally, we can enable or disable <span class="packt_screen">BGP route propagation</span>. An example of how to create a new route table is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-749 image-border" src="Images/2d75d61e-157b-446d-921f-5767afa60650.png" style="width:18.17em;height:34.92em;" width="357" height="686"/></p>
<p>After the route table is created, we need to associate it with a subnet and create a route. Under the <span class="packt_screen">Subnets</span> option in the route table blade, select <span class="packt_screen">Associate</span>, as shown:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-750 image-border" src="Images/47884909-abd2-4f4c-92f3-daf9173e12e5.png" style="width:115.50em;height:48.42em;" width="1386" height="581"/></p>
<p>To associate a route table with a subnet, we need to provide a <span class="packt_screen">Virtual network</span> and <span class="packt_screen">Subnet</span> in that network. In the following example, the <span class="packt_screen">Virtual network PacktVnet</span> is selected and the <span class="packt_screen">Subnet</span> is <span class="packt_screen">default</span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-751 image-border" src="Images/d2cdb8cd-26bc-4e40-a83a-9d5f37aa9a39.png" style="width:23.50em;height:23.83em;" width="443" height="450"/></p>
<p>Finally, we need to add a route. We need to provide a <span class="packt_screen">Route name</span>, <span class="packt_screen">Address prefix</span>, <span class="packt_screen">Next hop type</span>, and <span class="packt_screen">Next hop address</span>. For the <span class="packt_screen">Next hop type</span>, we need to select <span class="packt_screen">Virtual appliance</span>. Azure Firewall is a Firewall as a Service, but it still falls under this category. To create a similar effect, we could use any virtual appliance in which we would use third-party firewalls in IaaS mode. Under <span class="packt_screen">Next hop address</span>, we enter the private IP address of our Azure Firewall (I previously mentioned that you needed to remember this address). An example of route settings is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-752 image-border" src="Images/2945731a-cb3c-444c-8672-18d95d6c0963.png" style="width:42.25em;height:33.33em;" width="687" height="542"/></p>
<p>All traffic from the default subnet in the <kbd>PacktVnet</kbd> virtual network is now routed to our Azure Firewall. We can proceed and create rules on what will be allowed or denied.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Configuring Azure Firewall</h1>
                </header>
            
            <article>
                
<p>Under <span class="packt_screen">Rules</span> in the Azure Firewall blade, we have three options: <span class="packt_screen">NAT rule collection</span>, <span class="packt_screen">Network rule collection</span>, and <span class="packt_screen">Application rule collection</span>. Depending on what we want to achieve, we can use NAT rules to rewrite <span>the </span>source address. We can use network rules to define traffic from what source is allowed to go to what target, or with application rules we can define FQDNs that are allowed or denied. <span>An example of the <span class="packt_screen">Rules</span> blade in Azure Firewall is shown here:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-753 image-border" src="Images/bb40fad8-666f-4a33-b773-1398804379dc.png" style="width:111.17em;height:39.25em;" width="1334" height="471"/></p>
<p>Let's create a rule that will allow for traffic from the default subnet to VSTS. First, we need to provide a <span class="packt_screen">Name</span>, <span class="packt_screen">Priority</span>, and <span class="packt_screen">Action</span> (<span class="packt_screen">Allow</span> or <span class="packt_screen">Deny</span>). Then we need to define <span class="packt_screen">SOURCE ADDRESSES</span>, a <span class="packt_screen">PROTOCOL:PORT</span>, and <span class="packt_screen">TARGET FQDNS</span>. Optionally, we can add tags to our rule. For the <span><span class="packt_screen">SOURCE ADDRESSES</span></span>, I'll add a subnet, as I want VSTS to be reached from anywhere on the subnet. You can use a smaller scope of IP addresses if you want to restrict where FQDN can be reached from.</p>
<p>The protocol will be HTTP and HTTPS and the <span class="packt_screen">TARGET FQDNS </span>is <kbd>*.visualstudio.com</kbd>. An example of a new application rule is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-754 image-border" src="Images/1466506a-541e-47b0-9b46-2241aaa2f216.png" style="width:111.08em;height:37.33em;" width="1333" height="448"/></p>
<p>Note that you can have more than one rule in a collection and you can create all rules that apply to a specific service in a single collection. This makes it easier to manage and maintain Azure Firewall rules.</p>
<p>If everything is configured correctly, you can go to VM, located in the default subnet, and open any browser. You should be able to access any VSTS collection, but nothing else will be allowed.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Other network security options</h1>
                </header>
            
            <article>
                
<p>Besides using default Azure components such as NSG, route tables, or even Azure Firewall, there are a number of third-party firewalls that are available as virtual appliances. Virtual appliances are set up as Azure <span>VM</span>s, and most industry leaders in network security are available in Azure. Managing virtual appliances has two components: managing Azure VM and managing firewalls. We already talked about managing Azure VMs, and managing firewalls depends on the manufacturer and isn't any different than managing those firewalls on-premises.</p>
<p>Other than that, we can collect logs from our network resources with Azure Monitor and Log Analytics to help us audit and troubleshoot Azure Network. There is another tool that can help us monitor Azure Network, which is called <span>Network Watcher</span>. <span>Azure Network Watcher provides tools to monitor, diagnose, view metrics, and enable or disable logs for resources in an Azure virtual network.</span></p>
<p><span>With Azure Network Watcher, we can monitor endpoints, network flow, hops, VPNs, and everything else network-related. </span><span>It's a great tool, as it allows us to graphically display our network schema and locate issues in an easier way.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Encryption</h1>
                </header>
            
            <article>
                
<p>Another important step in security is encryption. We want our data to be encrypted always—in rest and transit. Everything is redundant to ensure there is no data is lost, and even with three copies of that, all of them encrypted, we have the option to create additional redundancy with geo-replication and other settings.</p>
<p>All resources in Azure are encrypted at rest by default. But sometimes we need additional security to ensure data is more protected. For example, disks for our Azure <span>VM</span>s are encrypted inside the Azure data center, and even if the disk was accessed without authorization, no one could read data on that disk. But what if the disk was downloaded? In this case, the disk could be used. Data could be read or attached to another VM, or <span>a VM could be created with that disk</span>.</p>
<p>We can apply additional encryption and make our resources more secure by using <strong>Azure Key Vault</strong>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Key Vault</h1>
                </header>
            
            <article>
                
<p>Azure Key Vault is used to store secrets, keys, and certificates. It's a centralized management solution for holding, distributing, and controlling secrets, keys, and certificates. Secrets in Azure Key Vault can be called during deployment so you can prevent passwords from being shown in plain text. Keys can be used to encrypt storage and disks. You can use certificates in Azure Key Vault and assign them to services during deployment to secure SSL and TLS.</p>
<p>Azure <span>Key Vault greatly reduces the chances that secrets may be accidentally leaked, increases the security of your resources at rest by using keys to encrypt, and increases security in transit by assigning certificates.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Key Vault</h1>
                </header>
            
            <article>
                
<p>To create a new <span>Key Vault</span>, we need to provide a <span class="packt_screen">Name</span>, <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource Group</span>, and <span class="packt_screen">Location</span>. We can optionally change the <span class="packt_screen">Pricing tier</span>, assign <span class="packt_screen">Access policies</span>, and provide <span class="packt_screen">Virtual Network Access</span>. The tier comes with two options: <span class="packt_screen">Standard</span> and <span class="packt_screen">Premium</span>. The only difference is that <span class="packt_screen">Premium</span> supports <strong>hardware security modules</strong> (<strong><span>HSMs</span></strong>). The default policy assigned is to grant all access to the person creating the vault. You can additionally add policies as needed at any time, either during creation or later. <span class="packt_screen">Virtual Network Access</span> is granted to all networks in your subscription by default, but you can edit this and grant access to specific networks only. An example of the default settings is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-756 image-border" src="Images/39e071e3-ae20-4fcd-9102-79c6c7600ce4.png" style="width:18.25em;height:38.50em;" width="355" height="749"/></p>
<p class="mce-root"/>
<p>Creating an Azure Key Vault is relatively fast and should be completed in under one minute. Note the <span class="packt_screen">DNS Name</span>, as this will be used later. An example of an Azure Key Vault blade is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-757 image-border" src="Images/1f76fda4-c3ea-465d-b0ab-854aabef74d2.png" style="width:100.92em;height:57.17em;" width="1211" height="686"/></p>
<p>To deploy Azure Key Vault, you can use the following ARM template:</p>
<pre>{<br/>    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",<br/>    "contentVersion": "1.0.0.0",<br/>    "parameters": {<br/>        "name": {<br/>            "type": "String"<br/>        },<br/>        "location": {<br/>            "type": "String"<br/>        },<br/>        "sku": {<br/>            "defaultValue": "Standard",<br/>            "allowedValues": [<br/>                "Standard",<br/>                "standard",<br/>                "Premium",<br/>                "premium"<br/>            ],<br/>            "type": "String",<br/>            "metadata": {<br/>                "description": "SKU for the vault"<br/>            }<br/>        },<br/>        "accessPolicies": {<br/>            "defaultValue": [],<br/>            "type": "Array",<br/>            "metadata": {<br/>                "description": "The access policies defined for this vault."<br/>            }<br/>        },<br/>        "tenant": {<br/>            "type": "String"<br/>        },<br/>        "enabledForDeployment": {<br/>            "type": "Bool"<br/>        },<br/>        "enabledForTemplateDeployment": {<br/>            "type": "Bool"<br/>        },<br/>        "enabledForDiskEncryption": {<br/>            "type": "Bool"<br/>        },<br/>        "networkAcls": {<br/>            "type": "Object",<br/>            "metadata": {<br/>                "description": "The network firewall defined for this vault."<br/>            }<br/>        }<br/>    },<br/>    "resources": [<br/>        {<br/>            "type": "Microsoft.KeyVault/vaults",<br/>            "name": "[parameters('name')]",<br/>            "apiVersion": "2016-10-01",<br/>            "location": "[parameters('location')]",<br/>            "properties": {<br/>                "enabledForDeployment": "[parameters('enabledForDeployment')]",<br/>                "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",<br/>                "enabledForDiskEncryption": "[parameters('enabledForDiskEncryption')]",<br/>                "accessPolicies": "[parameters('accessPolicies')]",<br/>                "tenantId": "[parameters('tenant')]",<br/>                "sku": {<br/>                    "name": "[parameters('sku')]",<br/>                    "family": "A"<br/>                },<br/>                "networkAcls": "[parameters('networkAcls')]"<br/>            }<br/>        }<br/>    ]<br/>}</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Adding keys and secrets</h1>
                </header>
            
            <article>
                
<p>After the <span>Key Vault</span> is created, we can add secrets and keys.</p>
<p>Let's first add a key that we'll use for encryption later. Keys can be generated, imported, or restored from backup. An example of how to add a new key is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-758 image-border" src="Images/a389addd-9dcc-4658-89db-14797600cd5d.png" style="width:37.75em;height:31.08em;" width="686" height="564"/></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>Secrets can be used to provide passwords when creating resources. When you are creating resources using an ARM template, you need to provide a password. To prevent the password from being shown as plain text, you can use secrets in <span>Key Vault</span> to provide a value for the password and prevent this. Secrets can be manually created or imported from the certificate. In this example, we can see how to add a new secret manually:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-759 image-border" src="Images/15fdf418-7f07-4c14-9ee2-45537e1e730f.png" style="width:38.92em;height:34.83em;" width="681" height="610"/></p>
<p>Similar to these two examples, you can add certificates. Certificates can be generated or imported. Note that if you want to use these certificates for publicly available applications, you must use a valid certificate issued by a public certification authority.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Encrypting the storage account</h1>
                </header>
            
            <article>
                
<p>As mentioned, most resources are encrypted by default, and the same goes with the Azure Storage Account. However, you have the option to use your own key to encrypt storage. To use your own key, you must select <span class="packt_screen">Use your own key</span>, which will allow you to select the <span>Key Vault</span> and the key that will be used for encryption. An example is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-760 image-border" src="Images/52f50779-c14a-44e9-99ae-3892c42b5586.png" style="width:104.17em;height:64.83em;" width="1250" height="778"/></p>
<p>The time it takes to encrypt storage depends on the amount of data in the storage account. For smaller storage, it's a matter of seconds, but with large storage accounts it can take hours until the process is completed. If you are encrypting large storage accounts in a production environment, try doing this outside of working hours as it may impact performance.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Encrypting databases</h1>
                </header>
            
            <article>
                
<p>Azure SQL Databases are encrypted with TDE. This option is now enabled by default when creating a new Azure SQL Database. If you have older databases, created before this became a default option, it's enough to change the option to <span class="packt_screen">ON</span> and save. The <span class="packt_screen">Transparent database encryption</span><span> </span>options in the Azure SQL Database blade are shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-761 image-border" src="Images/4025bb91-4b6a-400f-b00c-d0ee6b89bbb2.png" style="width:84.83em;height:38.50em;" width="1018" height="462"/></p>
<p>When TDE is enabled for Azure SQL Database, data and backups are encrypted at rest. But if you download or export a backup, this will no longer be the case. To have a database encrypted even after leaving Azure data center, we can use our own key for encryption. To do so we'll need to use Azure PowerShell.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing Azure PowerShell</h1>
                </header>
            
            <article>
                
<p>PowerShell is a command-line shell and scripting language based on the .NET Framework. It's used by system administrators to automate tasks and manage operating systems.</p>
<p>Azure PowerShell is a PowerShell module that allows us to automate and manage Azure resources.</p>
<p>To install Azure PowerShell, we need to have Windows PowerShell installed. Luckily, Windows PowerShell comes pre-installed on Microsoft OS from Windows 7 (Client OS) and Windows Server 2012 R2 (Server OS).</p>
<p class="mce-root"/>
<p>To install Azure PowerShell, we need to run the following command:</p>
<pre><strong>Install-Module -Name AzureRM</strong></pre>
<p>Next, we need to import the module:</p>
<pre><strong>Import-Module AzureRM</strong></pre>
<p>If the module is already installed, we can update it with:</p>
<pre><strong>Update-Module -Name AzureRM</strong></pre>
<p>After we have successfully imported the module, we can connect to Azure with:</p>
<pre><strong>Connect-AzureRmAccount</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using your own key for Azure SQL Database encryption</h1>
                </header>
            
            <article>
                
<p>To use our own key for Azure SQL Database TDE, we must execute a few commands.</p>
<p>First, we need to sign our Azure Active Directory identity in to our Azure SQL server:</p>
<pre>$dbRG = 'PacktPaaSDB';<br/>$dbServer = 'packt';<br/>$server = Set-AzureRmSqlServer -ResourceGroupName $dbRG -ServerName $dbServer -AssignIdentity</pre>
<p>Second, we must grant Key Vault permission to our server:</p>
<pre>$dbRG = 'PacktPaaSDB';<br/>$dbServer = 'packt';<br/>$KeyVaultName = 'PacktKV';<br/>Set-AzureRmKeyVaultAccessPolicy -VaultName $KeyVaultName -ObjectId $server.Identity.PrincipalId -PermissionsToKeys get, wrapKey, unwrapKey</pre>
<p>Third, we add the Key Vault key to the server and set the TDE <span>protection level</span>:</p>
<pre>$dbRG = 'PacktPaaSDB';<br/>$dbServer = 'packt';<br/>$rgName = 'PacktKeyVault';<br/>$KeyVaultName = 'PacktKV';<br/>$keyEncryptionKeyName = 'MyKey';<br/>$keyEncryptionKeyUrl = (Get-AzureKeyVaultKey -VaultName $KeyVaultName -Name $keyEncryptionKeyName).Key.kid;<br/><br/>&lt;# Add the key from Key Vault to the server #&gt;<br/>Add-AzureRmSqlServerKeyVaultKey -ResourceGroupName $dbRG -ServerName $dbServer -KeyId $keyEncryptionKeyUrl<br/>&lt;# Set the key as the TDE protector for all resources under the server #&gt;<br/>Set-AzureRmSqlServerTransparentDataEncryptionProtector -ResourceGroupName $dbRG -ServerName $dbServer -Type AzureKeyVault -KeyId $keyEncryptionKeyUrl<br/>&lt;# To confirm that the TDE protector was configured as intended: #&gt;<br/>Get-AzureRmSqlServerTransparentDataEncryptionProtector -ResourceGroupName $dbRG -ServerName $dbServer</pre>
<p class="mce-root">Finally, we turn on the TDE:</p>
<pre>$dbRG = 'PacktPaaSDB';<br/>$dbServer = 'packt';<br/>$dbName = 'Demo'<br/>Set-AzureRMSqlDatabaseTransparentDataEncryption -ResourceGroupName $dbRG -ServerName $dbServer -DatabaseName $dbName -State "Enabled"</pre>
<p>All parameters in Azure PowerShell script can be edited. To execute this on any Azure SQL Database using any <span>Key Vault</span>, change the names of the parameters accordingly.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Encrypting VM disks</h1>
                </header>
            
            <article>
                
<p>A similar thing can be applied to Azure <span>VM</span>s. Disks are encrypted by default and data is protected at rest. But as mentioned, when a disk is exported or downloaded, it's no longer protected. Using <span>Key Vault</span>, we can set additional encryption to our Azure VM disks and protect data in any situation. If we open disks in any of our Azure VMs, we can see that the disk is not encrypted, as shown:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-762 image-border" src="Images/2333194d-b184-46db-9bef-69b8ae2acedd.png" style="width:119.50em;height:29.67em;" width="1434" height="356"/></p>
<p>To enable disk encryption, first we must enable the Key Vault for disk encryption:</p>
<pre>Set-AzureRmKeyVaultAccessPolicy -VaultName 'PacktKV' -ResourceGroupName 'PacktKeyVault' -EnabledForDiskEncryption</pre>
<p>Now we can enable disk encryption:</p>
<pre>$VMRG = 'PacktIaaS';<br/>$VMname= 'DBserver';<br/>$rgName = 'PacktKeyVault';<br/>$KeyVaultName = 'PacktKV';<br/>$KeyVault = Get-AzureRmKeyVault -VaultName $KeyVaultName -ResourceGroupName $rgname;<br/>$diskEncryptionKeyVaultUrl = $KeyVault.VaultUri;<br/>$KeyVaultResourceId = $KeyVault.ResourceId;<br/><br/> Set-AzureRmVMDiskEncryptionExtension -ResourceGroupName $VMRG -VMName $vmName -DiskEncryptionKeyVaultUrl $diskEncryptionKeyVaultUrl -DiskEncryptionKeyVaultId $KeyVaultResourceId;</pre>
<p>The command will run in 5-15 minutes, <span>depending</span><span> on the size of the disk. After we receive a message that it's completed, we can check the disk status again and see that encryption is enabled:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-763 image-border" src="Images/a311bb86-5c5f-41a6-85da-e959bf3e0cae.png" style="width:116.83em;height:27.08em;" width="1402" height="325"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Security Center</h1>
                </header>
            
            <article>
                
<p>Azure Security Center provides a central place for security management and advanced threat protection across Azure and the hybrid cloud. With security center, we can <span>apply security policies across workloads, limit exposure to threats, and detect and respond to attacks.</span> It comes in two tiers, free and standard. The free tier is enabled by default, <span>and it provides a security policy, continuous security assessment, and actionable security recommendations to protect Azure resources. The standard tier extends to private or hybrid cloud workloads and adds advanced threat detection. Advanced threat detection uses built-in behavioral analytics and machine learning to identify attacks and zero-day exploits to reduce exposure to any type of attack.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Security Center overview</h1>
                </header>
            
            <article>
                
<p>The <span class="packt_screen">Overview</span> dashboard in the Azure Security Center blade provides an instant summary of the <span>security status of your Azure and non-Azure workloads, enabling you to discover and assess the security of your workloads and to identify and mitigate risks. We can see different metrics that allow us to instantly identify any security risks and see recommendations on what needs to be improved in our subscription based on best practices. An example of the <span class="packt_screen">Overview</span> dashboard in Azure Security Center is shown in the screenshot:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-764 image-border" src="Images/bf282a44-618d-47ea-82a1-b35c8ecd5f57.png" style="width:111.83em;height:60.00em;" width="1342" height="720"/></p>
<p>Azure Security Center is a complex service<span> with a lot of options. As with many other services, it deserves a book of its own and it would be hard to cover all options in a single chapter. We are going to concentrate on the most important ones that will</span> help<span> you instantly increase your security.</span></p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Security Center recommendations </h1>
                </header>
            
            <article>
                
<p>Azure Security Center analyzes your security settings and compares them to best practices. Based on this, you can see recommended changes that need to be implemented under <span class="packt_screen">Security Center - Recommendations</span>. Recommendations are divided into four categories—<span class="packt_screen">Compute &amp; apps</span>, <span class="packt_screen">Data &amp; storage</span>, <span class="packt_screen">Networking</span>, and <span class="packt_screen">Identity &amp; access (Preview)</span>. All resources can have three statuses: green, orange, and red. Green shows that all security best practices are enabled and that the resource is secure; orange represents recommendations that should be implemented but aren't critical; and red shows recommendations that present high security risks and should be implemented immediately. We can also see our security score based on what is implemented and what remains to be resolved as a possible security risk. The <span class="packt_screen">Security Center - Recommendations</span> blade is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-765 image-border" src="Images/36668786-11ca-4f38-8c17-30b3cf19b595.png" style="width:126.25em;height:61.75em;" width="1515" height="741"/></p>
<p>Let's take the <span class="packt_screen">Compute</span> section as an example. Here, we can find a list of all security issues that are related to compute resources (<span class="packt_screen">Vms and Computers</span>, <span class="packt_screen">App services (Preview)</span>, and <span class="packt_screen">Cloud services</span>). In this list of recommendations, we can see descriptions of issues and how many resources are affected by these issues. In the example here, we can see at the top of the list that 8 out of 10 VMs don't have endpoint protection enabled and that this is classified as red:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-766 image-border" src="Images/67328018-7f64-4b78-921c-c864f6946501.png" style="width:133.00em;height:62.58em;" width="1596" height="751"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Enabling endpoint protection</h1>
                </header>
            
            <article>
                
<p>As an example, let's click on this recommendation and resolve it. A new blade will open with a list of VMs that don't have endpoint protection. We can select specific VMs or all of them, and can opt to install endpoint protection. Installation will start, and after it is completed, we'll see that the recommendation is resolved:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-767 image-border" src="Images/4c989d75-1d8c-434e-b711-98c7ce19670f.png" style="width:39.25em;height:29.42em;" width="683" height="512"/></p>
<p>Similar to this, we can resolve most security center recommendations. We click on the recommendation and follow the steps. However, some recommendations can't be resolved in this way and require additional steps. In this case, you will be taken to documentation that describes the issue and provides steps to resolving it.</p>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Security Center Alerts</h1>
                </header>
            
            <article>
                
<p>Alerts are another part of Azure Security Center; these are very helpful and allow you to detect possible issues. The security alerts section allows you to track and see when unauthorized access to your resources was attempted. In the overview of alerts in Azure Security Center, you can see a list of possible attacks on your resources and see when they happened, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-768 image-border" src="Images/e804c86b-050a-42b7-ad47-6fa0a6ff0faf.png" style="width:129.92em;height:64.58em;" width="1559" height="775"/></p>
<p>If we select any alerts, we will see more information such as <span>a date</span>, what credentials were used, the number of login attempts, and other information. Under <span class="packt_screen">Geo and Threat Intelligence Information</span>, we can see from where an attack took place, giving us a detailed geographical location of the attack origin. Based on the login information and geo-location, we can detect if this was a legitimate user or a brute-force attack on our resources. If we have a valid user attempting this three times from a known location, we can assume this was a user who has simply forgotten their password.</p>
<p>If we have 50 attempts from unknown user(s) from unknown location(s), we can assume it was a brute-force attack. Under <span class="packt_screen">Remediation steps</span>, we have instructions on how to prevent similar attacks in the future. A sample of suspicious authentication activity is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-769 image-border" src="Images/50027950-2ffa-4fe1-bb98-5d0a09170e1d.png" style="width:69.58em;height:64.08em;" width="835" height="769"/></p>
<p class="mce-root"/>
<p>At the bottom, we have two additional actions—<span class="packt_screen">Investigate</span> and <span class="packt_screen">View playbooks</span>. <span class="packt_screen">Investigate</span> allows us to review details about incidents with more details. <span class="packt_screen">View playbooks</span> allows us to create (or use an existing) logic app that will take action if similar events happen in the future. With a logic app, we can design steps and actions that will prevent attacks. For example, if login with an invalid user is attempted more than three times, it will add an NSG rule that will prevent access to a resource for the next 48 hours. An example of investigation details is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-770 image-border" src="Images/5584f19d-281c-4106-a3a1-dbc8806af21a.png" style="width:130.92em;height:61.67em;" width="1571" height="740"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Just-in-Time access</h1>
                </header>
            
            <article>
                
<p>One of the best features in Azure Security Center is Just-in-Time access. Just-in-Time access prevents access to Azure <span>VM</span>s unless it's been specifically requested. By default, all management ports are closed, and you need to request access from specific IP address(es) for a short period of time to enable such access. </p>
<p>To set up Just-in-Time access on Azure VM, go to the Just-in-Time access blade in the <span class="packt_screen">Security Center</span> and select one or more VMs from the list, as shown:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-771 image-border" src="Images/aaf61239-c0f0-4186-b737-17d88ea458cd.png" style="width:72.83em;height:65.83em;" width="874" height="790"/></p>
<p class="mce-root"/>
<p><span>After you select the VM(s) that will have Just-in-Time access enabled, a new blade will open. Here we must define ports that will be closed by default and enabled only on request. The default ports are SSH (<kbd>22</kbd>), RDP (<kbd>3389</kbd>), and WinRM (<kbd>5985</kbd> and <kbd>5986</kbd>), but you can remove and add any port you want. An example of the default settings is shown in the following screenshot:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-772 image-border" src="Images/552f65da-0fc6-4109-b93d-634de40cea5b.png" style="width:39.33em;height:22.50em;" width="567" height="324"/></p>
<p>After Just-in-Time access is enabled, the option to connect to the VM will not be available. To access the VM, you must request access in Azure Security Center. Here, you need to define which port you want to open, from which IP address(es) it will be able to connect, and for how long (from 1 to 3 hours). An example of the request blade is shown here, where we can see how to open the RDP port from the current IP address for one hour:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-773 image-border" src="Images/542743ad-46c8-48b7-acce-dff56bc2fcad.png" style="width:69.92em;height:41.50em;" width="839" height="498"/></p>
<p>With Just-in-Time access, you are controlling who can access your VMs, when, and from where. Unauthorized access is brought to a minimum and your VMs are protected. Another amazing thing is that with Azure Security Center in the standard tier, you can register and protect resources in private and hybrid clouds. This option is not limited only to Azure <span>VM</span>s, but can be enabled for on-premises VMs as well.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Microsoft takes Azure Security very seriously. Lot of steps are taken to ensure your resources are protected and safe in Azure. In addition to this, Microsoft offers lots of additional services that we can use to improve security further. To be secure and achieve maximum, it takes combines effort from Microsoft and us, and we need to take advantage of the security services that Azure has to offer in addition to what Microsoft is already doing to secure our data and services. Besides security features that are declared as security services (such as <span>Key Vault</span> or security center), there are lots of security features that services have built in (such as Azure SQL Firewall or network security groups).</p>
<p>As we are getting toward the end, we are going to review what we have learned. In the last chapter, we are going to talk about services we already discussed and the best practices when using them. Infrastructure-as-Code is a very important part of cloud computing, and we're going to talk about tools that will allow us to work with Azure by automating tasks. Using the Azure portal is a great way to learn about Azure, but if you want to take full advantage, Infrastructure-as-Code is what you want to use.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>Everything in Azure is redundant and has how many copies?
<ol>
<li>One</li>
<li>Two</li>
<li>Three</li>
</ol>
</li>
<li>Most data breaches are caused by...
<ol>
<li>Brute-force attacks</li>
<li>Leaked credentials</li>
<li>Viruses</li>
</ol>
</li>
<li><span>MFA stands for...</span>
<ol>
<li>Multi-factor authentication</li>
<li>Multi-factor authorization</li>
<li>Multi-factor activation</li>
</ol>
</li>
<li>MFA can be configured to use:
<ol>
<li>Phone calls</li>
<li>Text messages</li>
<li>A mobile app</li>
<li>All of the above</li>
</ol>
</li>
<li>Azure Firewall <span>is...</span>
<ol>
<li>Infrastructure as a Service</li>
<li>Firewall as a Service</li>
<li>Both</li>
</ol>
</li>
<li>Azure resources can be encrypted using...
<ol>
<li>An Azure-provided key</li>
<li>A custom key</li>
<li>Both</li>
</ol>
</li>
</ol>
<ol start="7">
<li>To use custom keys, we must use...
<ol>
<li><span>Azure Security Center</span></li>
<li>Azure Key Vault</li>
<li><span>Both</span></li>
</ol>
</li>
<li>Azure Security Center provides...
<ol>
<li>Security management</li>
<li>Advanced threat protection</li>
<li>Both</li>
</ol>
</li>
<li>Azure Security Center can be used to protect...
<ol>
<li>Azure resources</li>
<li>On-premises resources</li>
<li>Both</li>
</ol>
</li>
<li>Just-in-Time access provides...
<ol>
<li>Control over management access for our VMs</li>
<li>Live monitoring of access to VMs</li>
<li>Both</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  </body></html>