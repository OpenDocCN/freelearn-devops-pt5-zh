<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-51"><a id="_idTextAnchor133"/>3</h1>
<h1 id="_idParaDest-52"><a id="_idTextAnchor134"/>The Ansible Commands</h1>
<p>Before moving on to writing and executing more advanced playbooks, we will look at the rest of the built-in Ansible commands. Here, we will cover using the commands that make up Ansible. Toward the end of this chapter, we will install a third-party tool to visualize our host inventory.</p>
<p>This chapter will cover the following topics:</p>
<ul>
<li>Inbuilt commands</li>
<li>Third-party commands</li>
</ul>
<h1 id="_idParaDest-53"><a id="_idTextAnchor135"/>Inbuilt commands</h1>
<p>When we installed Ansible, several <a id="_idIndexMarker143"/>different commands were installed. These were as follows:</p>
<ul>
<li><code>ansible</code></li>
<li><code>ansible-config</code></li>
<li><code>ansible-console</code></li>
<li><code>ansible-doc</code></li>
<li><code>ansible-galaxy</code></li>
<li><code>ansible-inventory</code></li>
<li><code>ansible-playbook</code></li>
<li><code>ansible-pull</code></li>
<li><code>ansible-vault</code></li>
</ul>
<p>We already covered the <code>ansible-galaxy</code> command in <a href="B21620_02.xhtml#_idTextAnchor080"><em class="italic">Chapter 2</em></a>, <em class="italic">Exploring Ansible Galaxy</em>. We will be looking at <code>ansible-playbook</code> throughout the remaining chapters of this book, so I will not go into any detail about that command in this chapter. Let’s start at the top of the list and a command we have already used.</p>
<h2 id="_idParaDest-54"><a id="_idTextAnchor136"/>Ansible</h2>
<p>Now, you <a id="_idIndexMarker144"/>would have thought that <code>ansible</code> would be the most common command we will use throughout this book, but it isn’t.</p>
<p>The <code>ansible</code> command<a id="_idIndexMarker145"/> is only ever used for executing ad hoc commands against a single host or collection of hosts. In <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, we created a host inventory file that targeted a single local virtual machine.</p>
<p>For this part of the chapter, we’ll look at targeting four different hosts I have running in a cloud provider; my host’s file looks as follows:</p>
<pre class="source-code">
ansible01 ansible_host=139.162.233.174
ansible02 ansible_host=139.162.233.227
ansible03 ansible_host=139.144.132.49
ansible04 ansible_host=139.144.132.71
[london]
ansible01
ansible02
[nyc]
ansible03
ansible04
[demohosts:children]
london
nyc
[demohosts:vars]
ansible_connection=ssh
ansible_user=root
ansible_private_key_file=~/.ssh/id_rsa
host_key_checking=False</pre> <p>As you can see, I have four hosts – <code>ansible01</code> &gt; <code>ansible04</code>. My first two hosts are in a group called <code>london</code> and my second two are in a group called <code>nyc</code>. I have then taken these two groups and created one containing them called <code>demohosts</code>, and I used this group to apply some basic configurations based on the hosts I have launched.</p>
<p>Using the <code>ping</code> module, I <a id="_idIndexMarker146"/>can check connectivity to the hosts by running the <a id="_idIndexMarker147"/>following commands. First, let’s check the two hosts in <code>londo<a id="_idTextAnchor137"/>n</code>:</p>
<pre class="console">
$ ansible -I hosts london -m ping</pre> <p>This returns the following results:</p>
<div><div><img alt="Figure 3.1 – Doing an Ansible ping targeting the london hosts" src="img/B21620_03_1.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – Doing an Ansible ping targeting the london hosts</p>
<p>Now, let’s run the same command, but this time targeting the <code>nyc</code> hosts<a id="_idTextAnchor138"/>:</p>
<pre class="console">
$ ansible -i hosts nyc -m ping</pre> <p>This gives us the following output:<a id="_idTextAnchor139"/></p>
<div><div><img alt="Figure 3.2﻿ – Doing an Ansible ping targeting the nyc hosts" src="img/B21620_03_2.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2<a id="_idTextAnchor140"/> – Doing an Ansible ping targeting the nyc hosts</p>
<p>As you can see, all four of my hosts returned <code>pong</code>.</p>
<p>I can also target all four hosts at once by adding <code>all</code> rather than a particular group of host<a id="_idTextAnchor141"/>s:</p>
<pre class="console">
$ ansible -i hosts all -m ping</pre> <p>Now that we can<a id="_idIndexMarker148"/> access our host through Ansible, we can target them and run<a id="_idIndexMarker149"/> some ad hoc commands; let’s start with something ba<a id="_idTextAnchor142"/>si<a id="_idTextAnchor143"/>c:</p>
<pre class="console">
$ ansible -i hosts london -a "ping -c 3 google.com"</pre> <p>This command will connect to the <code>london</code> hosts and run the <code>ping -c 3 google.com</code> command; this will <code>ping</code> the <a href="http://google.com">google.com</a> domain from the hosts and return the results<a id="_idTextAnchor144"/>:</p>
<div><div><img alt="Figure 3.3 – Running the ping command against google.com" src="img/B21620_03_3.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Running the ping command against google.com</p>
<p>We can also run a single module using the <code>ansible</code> command; we did this in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, using the <code>setup</code> module. However, a better example would be updating all the installed packages across all the hosts by running the following comma<a id="_idTextAnchor145"/>nd<a id="_idTextAnchor146"/>:</p>
<pre class="console">
$ ansible -i hosts all -m ansible.builtin.apt -a "name=* state=latest update_cache=ye"</pre> <p>As you <a id="_idIndexMarker150"/>can see, we <a id="_idIndexMarker151"/>have taken the <code>ansible.builtin.apt</code> module, which we defined as follows in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and </em><em class="italic">Running Ansib<a id="_idTextAnchor147"/>le</em>:</p>
<pre class="source-code">
- ansible.builtin.apt:
    name:"*"
    state:"latest"
    update_cache:"true"</pre> <p>I’ve passed in the same options, but rather than use YAML, I have formatted it as a key and value, which is typical of what you would pass into any command on the command lin<a id="_idTextAnchor148"/>e:</p>
<div><div><img alt="Figure 3.4 – Using the ansible.builtin.apt module to update all the packages" src="img/B21620_03_4.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4 – Using the ansible.builtin.apt module to update all the packages</p>
<p>As you can see, the output when running Ansible is quite verbose, and it provides feedback to tell us precisely what it did during the ad hoc execution.</p>
<p>Let’s rerun the command against all our hosts, but this time just for a single package, say <a id="_idTextAnchor149"/><code>ntp</code>:</p>
<pre class="console">
$ ansible -i hosts al<a id="_idTextAnchor150"/>l -m ansible.builtin.apt -a "pkg=ntp state=latest"</pre> <p>Running the command once will install the package on all four of our hosts<a id="_idTextAnchor151"/>:</p>
<div><div><img alt="Figure 3.5 – Using the ansible.builtin.apt module to install the ntp package" src="img/B21620_03_5.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5 – Using the ansible.builtin.apt module to install the ntp package</p>
<p>Now, let’s rerun<a id="_idIndexMarker152"/> the <a id="_idIndexMarker153"/>command:</p>
<pre class="console">
$ ansible -i hosts all -m ansible.builtin.apt -a "pkg=ntp state=latest"</pre> <p>Running the command once will install the package on all four of our hosts and give us the following result<a id="_idTextAnchor152"/>s:</p>
<div><div><img alt="Figure 3.6 – Rerunning the ansible.builtin.apt module to install the ntp package" src="img/B21620_03_6.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6 – Rerunning the ansible.builtin.apt module to install the ntp package</p>
<p>As you can see, the <a id="_idIndexMarker154"/>hosts are returning a <code>SUCCESS</code> status and are showing no <a id="_idIndexMarker155"/>changes, which is what we would expect to see.</p>
<p>So, why would you want to do this, and what is the difference between the two commands we ran?</p>
<p>First, let’s take a look at two of the commands we initially ran once we confirmed our hosts were available using an Ansible <code>ping</code>:</p>
<pre class="console">
$ ansible -i hosts london -a "ping -c 3 google.com"
$ ansible -i hosts all -m ansible.builtin.apt -a "name=* state=latest update_cache=true"</pre> <p>While it appears that the first command isn’t running a module, it is. The default module for the <code>ansible</code> command is called <code>raw</code> and runs raw commands on each of the targeted hosts. The <code>-a</code> part of the command passes arguments to the module. The raw module happens to accept raw commands, which is precisely what we are doing with the second command.</p>
<p>As mentioned previously, you will have noticed that the syntax is slightly different when we pass commands to the <code>ansible</code> command and when using it as part of a YAML playbook. All we are doing here is passing the key-value pairs directly to the module.</p>
<p>So, why would you want to use Ansible like this? Well, it’s excellent for running commands directly against non-Ansible managed hosts in an extremely controlled way.</p>
<p>Ansible uses SSH to connect to the hosts, runs the command, and lets you know the results. Just be careful – it is easy to get overconfident and run something like the following:</p>
<pre class="console">
$ ansible -I hosts all -a "reboot now"</pre> <p>If the user Ansible is using to connect to the host has permission to execute the command, it will just run the command you give it. Running the previous command will reboot all the servers in the host inventory fi<a id="_idTextAnchor153"/>le:</p>
<div><div><img alt="Figure 3.7 – Rebooting all four of the hosts with a single command" src="img/B21620_03_7.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7 – Rebooting all four of the hosts with a single command</p>
<p>All hosts have an <code>UNREACHABLE</code> status<a id="_idIndexMarker156"/> because the <code>reboot</code> command kicked our SSH<a id="_idIndexMarker157"/> session before the <code>SUCCESS</code> status could be returned. You can, however, see that each of the hosts has been rebooted by running the <code>uptime</code> command:</p>
<pre class="console">
$ ansible -i hosts all -a "uptime"</pre> <p>The following screenshot shows the output for the preceding comm<a id="_idTextAnchor154"/>and:</p>
<div><div><img alt="Figure 3.8 – Checking the uptime of the four hosts" src="img/B21620_03_8.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8 – Checking the uptime of the four hosts</p>
<p class="callout-heading">Important</p>
<p class="callout">As mentioned previously, plus speaking from experience (it’s a long story), please be extremely careful when using Ansible to manage hosts using ad hoc commands – it’s a powerful but dumb tool, and it will assume you know the consequences of running the commands against your hosts.</p>
<p>That <a id="_idIndexMarker158"/>concludes <a id="_idIndexMarker159"/>our look at the <code>ansible</code> command; let’s move on to our next command, <code>ansible-config</code>.</p>
<h2 id="_idParaDest-55"><a id="_idTextAnchor155"/>The ansible-config command</h2>
<p>The <code>ansible-config</code> command is <a id="_idIndexMarker160"/>used to manage Ansible configuration files. Ansible <a id="_idIndexMarker161"/>ships with sensible defaults, so there is little to configure outside of these. You can view the current configuration by running the fo<a id="_idTextAnchor156"/>llowing:</p>
<pre class="console">
$ ansible-config dump</pre> <p>As shown from the following output, all the text in green is the default config, and any configuration in orange is a changed<a id="_idTextAnchor157"/> value:</p>
<div><div><img alt="Figure 3.9 – Dumping our complete Ansible configuration to screen" src="img/B21620_03_9.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9 – Dumping our complete Ansible configuration to screen</p>
<p>Running the following command will list details of every configuration option there is within Ansible, including what the option does, its current state, when it was introduced, the type, and much more:</p>
<pre class="console">
$ ansible-config list</pre> <p>The following screenshot shows the output for the preceding co<a id="_idTextAnchor158"/>mmand:</p>
<div><div><img alt="Figure 3.10 – Viewing details on an Ansible configuration option" src="img/B21620_03_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10 – Viewing details on an Ansible configuration option</p>
<p>If you had a configuration file, say at <code>~/.ansible.cfg</code>, then you can load it using the <code>-c</code> or–<code>-config</code> flags:</p>
<pre class="console">
$ ansible-config view –-config "~/.ansible.cfg</pre> <p>The previous <a id="_idIndexMarker162"/>command will give you an overview of the custom configuration file <a id="_idIndexMarker163"/>and display the Ansible default values not defined in your custom configuration file.</p>
<h2 id="_idParaDest-56"><a id="_idTextAnchor159"/>The ansible-console command</h2>
<p>Ansible has a <a id="_idIndexMarker164"/>built-in<a id="_idIndexMarker165"/> console. It is not something I have used much in my day-to-day running of Ansible. To start the console, we need to run one of the following commands:</p>
<pre class="console">
$ ansible-console -i hosts
$ ansible-console -i hosts london
$ ansible-console -i hosts nyc</pre> <p>The first of the three commands targets all of the hosts, while the next two just target the name<a id="_idTextAnchor160"/>d groups:</p>
<div><div><img alt="Figure 3.11 – Establishing the console connection" src="img/B21620_03_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11 – Establishing the console connection</p>
<p>Once connected, you will see that I am connected to the <code>london</code> group of hosts, in which there are two hosts. From here, you can type a module name, such <a id="_idTextAnchor161"/>as <code>ping</code>:</p>
<div><div><img alt="Figure 3.12 – Running ping from Ansible" src="img/B21620_03_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12 – Running ping from Ansible</p>
<p>Alternatively, you<a id="_idIndexMarker166"/> can use the <code>raw</code> module; for example, you <a id="_idIndexMarker167"/>can check the <code>uptime</code> command by typing <code>ansible.builtin.ra<a id="_idTextAnchor162"/>w uptime</code>:</p>
<div><div><img alt="Figure 3.13 – Using the raw module to run the uptime command" src="img/B21620_03_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13 – Using the raw module to run the uptime command</p>
<p>You can also use the same syntax as we did when running the <code>ansible</code> command to pass key-value pairs – for example, running the following at the cons<a id="_idTextAnchor163"/><a id="_idTextAnchor164"/>ole prompt:</p>
<pre class="console">
ansible.builtin.apt pkg=ntp s<a id="_idTextAnchor165"/>tate=latest update_cache=true</pre> <p>It should give you something like the following output:</p>
<div><div><img alt="Figure 3.14 – Checking that the ntp package is installed using the ansible.builtin.apt module" src="img/B21620_03_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14 – Checking that the ntp package is installed using the ansible.builtin.apt module</p>
<p>You may have noticed that the syntax of the command we are running this time is slightly different from when we ran the same module using the <code>ansible</code> command earlier in this chapter.</p>
<p>That command was as <a id="_idTextAnchor166"/>follows:</p>
<pre class="console">
$ ansible -i hosts london -m ansible.builtin.apt -a"pkg=ntp state=latest update_cache=true"</pre> <p>Whereas this time, we just ran the following:</p>
<pre class="console">
ansible.builtin.apt pkg=ntp state=latest update_cache=true</pre> <p>The reason <a id="_idIndexMarker168"/>for this is that when we called the module<a id="_idIndexMarker169"/> using the <code>ansible</code> command, we were working on the command line of our local machine, so we needed to pass in the module name using the <code>-m</code> flag and then define the attributes by using the <code>-a</code> flag. After, we had to pass in our key-value pairs within quotation marks so as not to break the flow of the command as spaces are used as a delimiter when it comes to the command line.</p>
<p>When we ran the Ansible console, we had effectively already run the <code>ansible -i hosts london</code> part of the command, left our local command line altogether, and were interacting with Ansible itself directly.</p>
<p>To leave the console, type <code>exit</code> to return to your regular command-line shell.</p>
<p>As mentioned at the start of this section, the <code>ansible-console</code> command is something I do not use – mainly for the warning I gave when we looked at the <code>ansible</code> command at the start of this chapter.</p>
<p>When connecting to several hosts using the <code>ansible-console</code> command, you must be 100% confident that the commands you are typing are correct. For example, while I was only connected to two hosts, my <code>hosts</code> file could have contained 200 hosts. Now, imagine I typed <a id="_idIndexMarker170"/>the wrong command – executing it <a id="_idIndexMarker171"/>across 200 hosts at once could potentially do some unwanted things, such as rebooting them all simultaneously.</p>
<p>To quit the <code>ansible-console</code> session, simply type <code>exit</code> and hit <em class="italic">Enter</em>.</p>
<p>As you have probably guessed, this happened to me. It wasn’t 200 hosts, but it could have easily been – <em class="italic">so please </em><em class="italic">be careful.</em></p>
<h2 id="_idParaDest-57"><a id="_idTextAnchor167"/>The ansible-inventory command</h2>
<p>Using the <code>ansible-inventory</code> command <a id="_idIndexMarker172"/>provides you with details of your host <a id="_idIndexMarker173"/>inventory files. It can be helpful to understand how your hosts are grouped. For example, let’s say I run the foll<a id="_idTextAnchor168"/>owing command:</p>
<pre class="console">
$ ansible-inventory -i hosts–-graph</pre> <p>In the same folder as the <code>hosts</code> inventory file that I have been using throughout this section, the following<a id="_idTextAnchor169"/> is returned:</p>
<div><div><img alt="Figure 3.15 – Getting an overview of the inventory hosts file" src="img/B21620_03_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15 – Getting an overview of the inventory hosts file</p>
<p>As you can see, it displays the groups, starting with <code>all</code>, then the main host group (<code>demohosts</code>), then the child groups (<code>london</code> and <code>nyc</code>), and finally the hosts themselves (<code>ansible01</code> &gt; <code>ansible04</code>).</p>
<p>If you want to view the configuration for a single host, you can use this command:</p>
<pre class="console">
$ ansible-inventory -i hosts –-host=ansible01</pre> <p>The following screenshot shows the output of the preced<a id="_idTextAnchor170"/>ing command:</p>
<div><div><img alt="Figure 3.16 – Viewing a single host" src="img/B21620_03_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16 – Viewing a single host</p>
<p>You may have <a id="_idIndexMarker174"/>noticed that it displays the configuration information that the <a id="_idIndexMarker175"/>host inherited from the configuration we set for all the hosts in the <code>demohost</code> host group in the inventory file. You can view all the information on each of your hosts and groups by running the following command:</p>
<pre class="console">
$ ansible-inventory -i hosts –-list</pre> <p>This command is helpful if you have a large or complicated host inventory file and want information on just a single host or if you have taken on a host inventory and want a better idea of how the inventory is structured. We will look at a third-party tool later in this chapter that gives more display options.</p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor171"/>What is ansible-pull?</h2>
<p>Like the <code>ansible-console</code> command, <code>ansible-pull</code> is not a command I use very often; I can count on <a id="_idIndexMarker176"/>one hand how often I have <a id="_idIndexMarker177"/>used it in the past several years.</p>
<p><code>ansible-pull</code> is a command that allows a target machine to pull its configuration from a given source, such as a Git repository, and apply it locally. This reverses the typical Ansible push model, where a central control node pushes configuration to managed nodes.</p>
<p>The <code>ansible-pull</code> command works as follows:</p>
<ol>
<li>The target machine, the one running <code>ansible-pull</code>, fetches a specified repository.</li>
<li>Once the repository has been fetched, the target machine looks for a playbook. By default, it looks for one called <code>localhost.yml</code>, but you can specify a different playbook file if you need to – please note that this is not included in the example files.</li>
<li>The target machine then runs the playbook against itself.</li>
</ol>
<p>There are a few use cases for <code>ansible-pull</code>:</p>
<ul>
<li><code>ansible-pull</code> allows nodes to self-configure by pulling their configurations</li>
<li><code>ansible-pull</code> can be scheduled to run at specific intervals via a cron job, ensuring that hosts can self-update when they have connectivity</li>
<li><code>ansible-pull</code> to pull down and apply configurations to their local development environments, ensuring consistency with production configurations</li>
</ul>
<p>There are a few <a id="_idIndexMarker178"/>prerequisites to running <code>ansible-pull</code> – the most <a id="_idIndexMarker179"/>prominent being that the host running <code>ansible-pull</code> must have an active and valid Ansible installation and any other dependencies needed to execute the playbook.</p>
<p>In summary, <code>ansible-pull</code> provides a way to invert the traditional Ansible model, allowing hosts to pull their configurations as needed rather than having a central host push the configurations to them, as we did in <a href="B21620_01.xhtml#_idTextAnchor017"><em class="italic">Chapter 1</em></a>, <em class="italic">Installing and Running Ansible</em>, and <a href="B21620_02.xhtml#_idTextAnchor080"><em class="italic">Chapter 2</em></a>, <em class="italic">Exploring Ansible Galaxy</em>. For the remainder of this book, we will be taking the more traditional approach to Ansible deployments and pushing our configuration to our target hosts.</p>
<p>However, it is always good to know that if, for whatever reason, you are not able to take this approach, then you do have an alternative option in <code>ansible-pull</code>.</p>
<h2 id="_idParaDest-59"><a id="_idTextAnchor172"/>Using the ansible-vault command</h2>
<p>In Ansible, it is <a id="_idIndexMarker180"/>possible to load <a id="_idIndexMarker181"/>variables from files or within a playbook itself; we will look at this in the next chapter in more detail. These files can contain sensitive information such as passwords and API ke<a id="_idTextAnchor173"/>ys. Here’s an example:</p>
<pre class="source-code">
secret:"mypassword"
secret-api-key:"myprivateapikey"</pre> <p>As you can see, we have two sensitive bits of information visible as plaintext. This is OK while the file is on our local machine – well, just about OK. But what if we want to check the file into source control to share it with our colleagues?</p>
<p><em class="italic">We shouldn’t store this information in plaintext, even if the repository </em><em class="italic">is private.</em></p>
<p>Ansible introduced Ansible Vault to help solve this very problem. Using the <code>ansible-vault</code> command, we can encrypt a file or just variables, and then when Ansible is executed, it can be decrypted in memory, and the content can be read as part of the execution.</p>
<p class="callout-heading">Note</p>
<p class="callout">For the rest of the chapter, I will set a Vault password of <code>password</code>, should you wish to run the <code>ansible-vault</code> command against the files in the <code>Chapter03/vault</code> folder.</p>
<p>To encrypt a file, we need to run the following command, providing a password that will be used to decrypt the<a id="_idTextAnchor174"/> file when prompted:</p>
<pre class="console">
$ ansible-vault encrypt secrets.yml</pre> <p>The following screenshot shows the output of the<a id="_idTextAnchor175"/> preceding command:</p>
<div><div><img alt="Figure 3.17 – Using ansible-vault to encrypt an entire file" src="img/B21620_03_17.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.17 – Using ansible-vault to encrypt an entire file</p>
<p>As you can see from the output, you will be asked to confirm the password. Once encrypted, your file will look something like this:</p>
<pre class="source-code">
$ANSIBLE_VAULT;1.1;AES256
62373138643038636664363166646637333131386431366137643630326433303231336331303262
3661383061313436653464663039626338376233646630310a306437666462313439636634646633
39653435333433326361306531393832613038353665333866383161313239343134376632316263
3736633665303161630a393265633066663631336239613938363130306262613633333030336430
66343833376532313866363838653464383065633737613735323739303232383031326262376366
61663136623431306363666330373831336230323132336263626237366539326162373564353937
303465306233633633303533633232623233</pre> <p>As you can see, the<a id="_idIndexMarker182"/> details are encoded using text. This<a id="_idIndexMarker183"/> ensures that our <code>secrets.yml</code> file will still work without problems when it’s checked into source control such as Git.</p>
<p>You can view the content of a file by running t<a id="_idTextAnchor176"/>he following command:</p>
<pre class="console">
$ ansible-vault view secrets.yml</pre> <p>This will ask you for the password and print the content of the<a id="_idTextAnchor177"/> file to the screen:</p>
<div><div><img alt="Figure 3.18 – Using ansible-vault to encrypt an entire file" src="img/B21620_03_18.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.18 – Using ansible-vault to encrypt an entire file</p>
<p>You can decrypt the file on disk by running th<a id="_idTextAnchor178"/>e following command:</p>
<pre class="console">
$ ansible-vault decrypt secrets.yml</pre> <p>This will restore the file to its unencrypted original state.</p>
<p class="callout-heading">Important</p>
<p class="callout">When using the <code>ansible-vault decrypt</code> command, please do not commit or check the decrypted file into your source control system!</p>
<p>Since early in <a id="_idIndexMarker184"/>the release of Ansible 2, encrypting a single <a id="_idIndexMarker185"/>variable in a file is now possible. Let’s add some more variables to our file:</p>
<pre class="source-code">
username:"russmckendrick"
password:"mypassword"
secretapikey:"myprivateapikey"
packages:
  - apache2
  - ntp
  - git</pre> <p>It would be good if we didn’t have to keep viewing or decrypting our file to check its variable name and overall content.</p>
<p>Let’s encrypt the password content by runnin<a id="_idTextAnchor179"/>g <a id="_idTextAnchor180"/>the following command:</p>
<pre class="console">
$ ansible-vault encrypt_string'mypassword'–-name'password'</pre> <p>This will encrypt the <code>mypassword</code> string and give it a varia<a id="_idTextAnchor181"/>ble name of <code>password</code>:</p>
<div><div><img alt="Figure 3.19 – Using ansible-vault to encrypt a single string" src="img/B21620_03_19.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.19 – Using ansible-vault to encrypt a single string</p>
<p>We can then copy and paste the output into our file and repeat this proc<a id="_idTextAnchor182"/>ess for <code>secretapikey</code>:</p>
<pre class="console">
$ ansible-vault encrypt_string 'myprivateapikey' –-name 'secretapikey'</pre> <p>With that, we have<a id="_idIndexMarker186"/> generated two secret variables and <a id="_idIndexMarker187"/>replaced the unencrypted ones in our variables file.</p>
<p class="callout-heading">Note</p>
<p class="callout">For ease of reading, I have truncated the output a little – the entire file can be found in the <code>Chapter03/vault</code> folder in this book’s GitHub repository.</p>
<p>Our variables file should end up looking something like this:</p>
<pre class="source-code">
username:"russmckendrick"
password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
30393463363733386333636536663832383565346335393030643435316132363437643261383837
          3035
secretapikey: !vault |
          $ANSIBLE_VAULT;1.1;AES256
38663133393834646638663632353634343638626237333438336131653862373761666539326263
          3934
packages:
  - apache2
  - ntp
  - git</pre> <p>As you can see, that is much easier to read and is just as secure as encrypting the file.</p>
<p>So far, so good, but how do you use Ansible Vault encrypted data in an Ansible playbook?</p>
<p>Before we look at<a id="_idIndexMarker188"/> how to do this, let’s see what happens when you<a id="_idIndexMarker189"/> don’t tell the <code>ansible-playbook</code> command you are using Ansible Vault by running the following playbook. As you can see, it is loading in the <code>myvars.yml</code> file and then printing the contents of our variables to the screen using the <code>ansible.builtin.debug</code> module:</p>
<pre class="source-code">
---
- name: "Print some secrets"
  hosts: "localhost"
  vars_files:
    - "myvars.yml"
  tasks:
    - name: "Print the vault content"
      ansible.builtin.debug:
        msg:
          - "The username is {{ username }} and password is {{ password }}, also the API key is {{ secretapikey }}"
          - "I am going to install {{ packages }}"</pre> <p>We can run the playbook using the following command; note that since it’s just running locally, we are not passing an inventory file. This is something it will give you a warning about:</p>
<pre class="console">
$ ansible-playbook playbook01.yml</pre> <p>This results in an error message being shown in the Terminal output:</p>
<div><div><img alt="Figure 3.20 – Getting an error when running the ansible-playbook command" src="img/B21620_03_20.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.20 – Getting an error when running the ansible-playbook command</p>
<p>As you can see, it’s complaining that it found Vault-encrypted data in one of the files, but we haven’t provided the secret to unlock it.</p>
<p>The first way we <a id="_idIndexMarker190"/>can pass the Vault password during <a id="_idIndexMarker191"/>the <code>ansible-playbook</code> run is to put the password in a text file and have the <code>ansible-playbook</code> command read the file’s contents.</p>
<p>As mentioned at the start of this section, I have been encoding my Vaults using a password of <code>password</code>. Let’s put that in a file and then u<a id="_idTextAnchor183"/>se it to unlock ou<a id="_idTextAnchor184"/>r Vault:</p>
<pre class="console">
$ echo "password" &gt; /tmp/vault-file</pre> <p>Running the following command will read the content of <code>/tmp/vault-<a id="_idTextAnchor185"/>file</code> and decrypt the data:</p>
<pre class="console">
$ ansible-playbook --vault-id /tmp/vault-file playbook01.yml</pre> <p>As you can see from the following playbook run, the ou<a id="_idTextAnchor186"/>tput is now as we expect:</p>
<div><div><img alt="Figure 3.21 – Running ansible-playbook and passing the Vault password in via a file" src="img/B21620_03_21.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.21 – Running ansible-playbook and passing the Vault password in via a file</p>
<p>If you prefer to be prompted for the password, you can u<a id="_idTextAnchor187"/>se the following command:</p>
<pre class="console">
$ ansible-playbook --vault-id @prompt playbook01.yml</pre> <p>The following <a id="_idTextAnchor188"/>output shows the prompt:</p>
<div><div><img alt="Figure 3.22 – Running ansible-playbook and entering the password via a prompt" src="img/B21620_03_22.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.22 – Running ansible-playbook and entering the password via a prompt</p>
<p>You might be<a id="_idIndexMarker192"/> asking yourself, why are there two different options? When<a id="_idIndexMarker193"/> prompted, just running the command and entering the password might seem enough.</p>
<p>However, when it comes to using services such as the ones we will cover in <a href="B21620_15.xhtml#_idTextAnchor641"><em class="italic">Chapter 15</em></a>, <em class="italic">Using Ansible with GitHub Actions and Azure DevOps</em>, the commands need to run utterly unattended as there will not be an active terminal for you to enter the password.</p>
<p>Another advantage that will be looked at in both <a href="B21620_15.xhtml#_idTextAnchor641"><em class="italic">Chapter 15</em></a>, <em class="italic">Using Ansible with GitHub Actions and Azure DevOps</em>, and <a href="B21620_16.xhtml#_idTextAnchor716"><em class="italic">Chapter 16</em></a>, <em class="italic">Introducing Ansible AWX and Red Hat Ansible Automation Platform</em>, is that by abstracting away the need for an end user to enter credentials at runtime, it is entirely possible for someone to run a pipeline and never need to know or have access to any of the secrets stored in your playbooks or the credentials to unlock them.</p>
<h1 id="_idParaDest-60"><a id="_idTextAnchor189"/>Third-party commands</h1>
<p>Before we finish looking <a id="_idIndexMarker194"/>at the various Ansible commands, let’s look at a command that isn’t shipped as part of Ansible itself but is, in fact, a third-party open source project.</p>
<h2 id="_idParaDest-61"><a id="_idTextAnchor190"/>The ansible-inventory-grapher command</h2>
<p>The <code>ansible-inventory-grapher</code> command, by <a id="_idIndexMarker195"/>Will Thames, uses the Graphviz <a id="_idIndexMarker196"/>library to visualize your host inventories. The first thing we need to do is install Graphviz. To install this on macOS using Homebrew, run the following command:</p>
<pre class="console">
$ brew install graphviz</pre> <p>To install Graphviz on Ubuntu, use the following command:</p>
<pre class="console">
$ sudo apt-get install graphviz</pre> <p><a id="_idTextAnchor191"/>Once installed, you can install <code>ansible<a id="_idTextAnchor192"/>-inventory-grapher</code> using <code>pip</code>:</p>
<pre class="console">
$ pip install ansible-inventory-grapher</pre> <p>Now that we have everything installed, we can generate the graph using the <code>hosts</code> file w<a id="_idTextAnchor193"/>e <a id="_idTextAnchor194"/><a id="_idTextAnchor195"/>used earlier in this chapter:</p>
<pre class="console">
$ ans<a id="_idTextAnchor196"/>ible-inventory-grapher -i hosts demohosts</pre> <p>This will generate som<a id="_idTextAnchor197"/>ething that looks like this:</p>
<div><div><img alt="Figure 3.23 – Running ansible-inventory-grapher against our hosts file" src="img/B21620_03_23.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.23 – Running ansible-inventory-grapher against our hosts file</p>
<p>This is the raw output of <a id="_idIndexMarker197"/>the graph. As you can see, it is like and uses <a id="_idIndexMarker198"/>some of the same syntax as HTML. We can render this using the <code>dot</code> command, which ships as part of Graphviz. The <code>dot</code> command creates hierarchical drawings from graphs. To do th<a id="_idTextAnchor198"/>is, run the following command:</p>
<pre class="console">
$ ansible-inventory-grapher -i hosts demohosts | dot -Tpng &gt; hosts.png</pre> <p>This will generate a PNG file called <code>hosts.png</code> that contains the visualization of the host inventory file you can see here:</p>
<div><div><img alt="Figure 3.24 – The output of passing our ansible-inventory-grapher output through Graphviz" src="img/B21620_03_24.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.24 – The output of passing our ansible-inventory-grapher output through Graphviz</p>
<p>As you can see, this is an<a id="_idIndexMarker199"/> excellent representation of the <a id="_idIndexMarker200"/>hosts being targeted by Ansible; it works great for inclusion in your documentation but also gives you an idea of how a complicated inventory file is structured.</p>
<h1 id="_idParaDest-62"><a id="_idTextAnchor199"/>Summary</h1>
<p>In this chapter, we briefly looked at some of the supporting tools that ship as part of a standard Ansible installation and a useful third-party tool designed to work with Ansible.</p>
<p>We will use these commands and the one we have purposely missed, <code>ansible-playbook</code>, in later chapters.</p>
<p>In the next chapter, we will write a more complex playbook that installs a basic LAMP stack on our local virtual machine.</p>
<h1 id="_idParaDest-63"><a id="_idTextAnchor200"/>Further reading</h1>
<p>You can find the documentation for each of the tools covered in this chapter at the following URLs:</p>
<ul>
<li>Ansible command-line tools overview: <a href="https://docs.ansible.com/ansible/latest/command_guide/command_line_tools.html">https://docs.ansible.com/ansible/latest/command_guide/command_line_tools.html</a></li>
<li><code>ansible</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible.html">https://docs.ansible.com/ansible/latest/cli/ansible.html</a></li>
<li><code>ansible-config</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-config.html ">https://docs.ansible.com/ansible/latest/cli/ansible-config.html</a></li>
<li><code>ansible-console</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-console.html">https://docs.ansible.com/ansible/latest/cli/ansible-console.html</a></li>
<li><code>ansible-doc</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-doc.html">https://docs.ansible.com/ansible/latest/cli/ansible-doc.html</a></li>
<li><code>ansible-inventory</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-inventory.html">https://docs.ansible.com/ansible/latest/cli/ansible-inventory.html</a></li>
<li><code>ansible-playbook</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html">https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html</a></li>
<li><code>ansible-pull</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-pull.html">https://docs.ansible.com/ansible/latest/cli/ansible-pull.html</a></li>
<li><code>ansible-vault</code>: <a href="https://docs.ansible.com/ansible/latest/cli/ansible-vault.html">https://docs.ansible.com/ansible/latest/cli/ansible-vault.html</a></li>
<li><code>ansible-inventory-grapher</code>: <a href="https://github.com/willthames/ansible-inventory-grapher">https://github.com/willthames/ansible-inventory-grapher</a></li>
</ul>
</div>


<div><h1 id="_idParaDest-64" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor201"/>Part 2: Deploying Applications</h1>
<p>Now that you understand Ansible’s basics, it’s time to put that knowledge into practice. In this part, we will focus on deploying applications using Ansible playbooks. From setting up a LAMP stack to deploying WordPress and targeting multiple distributions, you will gain hands-on experience automating application deployments. We will also explore how Ansible can manage Windows-based servers, expanding your automation capabilities.</p>
<p>This part has the following chapters:</p>
<ul>
<li><a href="B21620_04.xhtml#_idTextAnchor202"><em class="italic">Chapter 4</em></a>, <em class="italic">Deploying a LAMP Stack</em></li>
<li><a href="B21620_05.xhtml#_idTextAnchor253"><em class="italic">Chapter 5</em></a>, <em class="italic">Deploying WordPress</em></li>
<li><a href="B21620_06.xhtml#_idTextAnchor291"><em class="italic">Chapter 6</em></a>, <em class="italic">Targeting Multiple Distributions</em></li>
<li><a href="B21620_07.xhtml#_idTextAnchor336"><em class="italic">Chapter 7</em></a>, <em class="italic">Ansible Windows Modules</em></li>
</ul>
</div>
<div><div></div>
</div>
<div><div></div>
</div>
</body></html>