<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Hardening the Security of Your AWS Environment</h1>
                </header>
            
            <article>
                
<p class="mce-root">In this chapter, we will focus on how to secure our AWS account and application. The cloud and security are two concepts that don't always go together. This is not because of the cloud's nature, but because of the idea that a server on the premises is more secure than a server on the cloud. This is because you know exactly where an on-premise server is, and how the connections to it reach there. The purpose of this chapter is to look at some practical tools and information to demonstrate that a well-managed AWS cloud can be more secure than an on-premise environment.<br/>
First we will look at how to secure access for our IAM users. Then, we will look at how to enable logging on for IAM usage with CloudTrail, and, at the network level, with VPC Flow Logs. Creating the right subnets is a crucial step to undertake before placing our application and infrastructure in the cloud. Finally, we will explore the power of a wonderful tool provided by AWS—the <strong>web application firewall</strong> (<strong><span>WAF</span></strong>).</p>
<p>One of the most important security principles is that of the <span><em>least privilege</em>. This refers to limiting the access rights of users to the minimum permissions that they need in order to complete their work in the correct way.</span></p>
<p>In this chapter, we will implement this at many levels in the AWS infrastructure. <span>Moving forward, we will take a closer look at the following topics:</span></p>
<ul>
<li><span><strong>Identity Access Management</strong> (</span><strong>IAM</strong>) security</li>
<li>CloudTrail</li>
<li><strong>Virtual Private Cloud</strong> (<strong>VPC</strong>) subnets</li>
<li>AWS WAF</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p class="mce-root">The code files included within the chapter can be found on GitHub at link: <a href="https://github.com/giuseppeborgese/effective_devops_with_aws__second_edition">https://github.com/giuseppeborgese/effective_devops_with_aws__second_edition</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">IAM security</h1>
                </header>
            
            <article>
                
<p>IAM <span>enables you to securely control access to AWS</span><span> services. Here, we need to implement the least privilege principle, and monitor who does what by recording all of the users' actions.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Root account</h1>
                </header>
            
            <article>
                
<p>When you create an AWS account and log in with the root account, you will see something like the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a4142040-f3e0-471a-b90e-7ccea505be86.png" style="width:37.42em;height:24.83em;"/></p>
<p><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">It is important to perform all of the actions suggested by the IAM web console, and also, to change the root account's password.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Root account password</h1>
                </header>
            
            <article>
                
<p>First, change the root account's password. At the top right of the page, between the bell icon and the <span class="packt_screen">Global</span> drop-down menu, you will find your AWS alias or account number. Click on this, and then click on the <span class="packt_screen">My Account</span> option:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/39ca0b41-851a-46e7-b2bb-4c0c6ba1e18c.png" style="width:31.42em;height:18.50em;"/></p>
<p>Next, click on the <span class="packt_screen">Edit</span> button. The others steps are more straightforward and logical, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0a6e4450-fee9-440e-9324-968e0a74b905.png" style="width:50.75em;height:15.25em;"/></p>
<p><span>For security reasons, the web page will request that you provide your login information again. P</span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">assword protection is never enough, especially for the root account; you should absolutely activate <strong>multi-factor authentication</strong> (<strong>MFA</strong>), whether you have a virtual or hardware device. Plenty of solutions are available on the market. Just to provide some examples, Google Authenticator is one of the most well-known apps for Android devices. I have also used a physical dongle made by Yubico (<a href="https://www.yubico.com/" target="_blank">https://www.yubico.com/</a></span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">).</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Delete your root access keys</h1>
                </header>
            
            <article>
                
<p><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">Access keys have the same permissions as those given following access with a password, so a more secure environment is created when this kind of access is removed from the root account, leaving only password access for use (except in some special cases). </span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">Don't worry about the message shown in the following screenshot:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2768c031-9a30-4859-9bb5-55f6ab30b17a.png" style="width:49.50em;height:12.75em;"/></p>
<p><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">If you created an access key for the root account and find that it was deleted, you will be shown the following message:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="gallery author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><span class="gallery-wrapper"><img src="assets/d0dbf61c-bbb4-4393-be9d-57aee578a269.png" style="width:62.08em;height:23.00em;"/></span></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up a password policy for IAM users</h1>
                </header>
            
            <article>
                
<p>The password policy that you should apply depends on the level of security that you want to apply to your IAM users passwords. I would suggest something like the following, but it will depend on your use case:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/16a72718-7cc7-4ee0-8526-6ac5762cbe33.png" style="width:35.50em;height:32.92em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an administrator group and a personal IAM user </h1>
                </header>
            
            <article>
                
<p><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">To operate with the root account, it is more secure to create a personal IAM user and operate through that. It is also a best practice to assign permissions to the group, and not directly to the IAM users. Do this as follows:</span></p>
<ol>
<li><span>Create a group called</span> <kbd>admins</kbd> <span>or something similiar.</span></li>
<li><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">Assign the administrator policy to this group.</span></li>
<li><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">Create a personal IAM user with some kind of criteria. In my case, I would choose <kbd>myname.mysurname giuseppe.borgese</kbd>.</span></li>
<li><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">Insert the new IAM user in to the</span> <kbd>admins</kbd> <span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">group.</span></li>
</ol>
<p>This allows other IAM users <span>to evaluate whether </span>to create groups with fewer privileges than the administrator. It also allows them to assign the necessary rights, but not more than are required. For example, if an IAM user needed to manage EC2 machines, we could give them the predefined <span class="packt_screen">AmazonEC2FullAccess</span> <span>policy, </span><span>and, correspondingly, if they needed to manage an RDS environment, they could be given an</span> <span class="packt_screen">AmazonRDSFullAccess</span> <span>policy.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">AmazonEC2FullAccess policy</h1>
                </header>
            
            <article>
                
<p><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">The tasks that require root account access are listed clearly on the AWS documentation page at <a href="https://docs.aws.amazon.com/general/latest/gr/aws_tasks-that-require-root.html" target="_blank">https://docs.aws.amazon.com/general/latest/gr/aws_tasks-that-require-root.html</a></span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><span>.</span> <span>To follow is </span>a list of these tasks:</span></p>
<ul>
<li class="mce-root"><span>Modifying root user details</span></li>
<li>Changing your AWS support plan</li>
<li>Closing an AWS account</li>
<li>Signing up for GovCloud</li>
<li>Submiting a reverse DNS for Amazon EC2 requests</li>
<li>Creating a CloudFront key pair</li>
<li>Creating an AWS created X.509 signing certificate</li>
<li>Transfering a route 53 domain to another AWS account</li>
<li>Changing the Amazon EC2 setting for longer resource IDs</li>
<li>Requesting the removal of the port <kbd>25</kbd> email throttle on your EC2 instance</li>
<li>Finding your AWS account canonical user ID</li>
</ul>
<p><span>All of these operations are very rare, so it would be unusual for you to find one of these events cropping up among your everyday tasks. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Final security status</h1>
                </header>
            
            <article>
                
<p>Now that all of your tasks have been accomplished, <span>you can log out from the root user and start to use the IAM user with the administrator rights that you have created, as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f250d8be-76fc-4b87-9fb5-93b414cc7d8c.png" style="width:61.25em;height:30.00em;"/></p>
<div class="lb-bg-left-top-cover lb-box">
<div class="lb-vpos-center">
<div class="lb-grid lb-row lb-row-max-large lb-snap">
<div class="lb-col lb-tiny-24 lb-mid-24">
<p>If you are completely new to the cloud approach, it is worth spending some time reading the <em>AWS Shared Responsibility Model</em> at <a href="https://aws.amazon.com/compliance/shared-responsibility-model/" target="_blank">https://aws.amazon.com/compliance/shared-responsibility-model/</a>. On the page, there is a clear definition of what AWS's responsibility is (<em>security of the cloud</em>), and also, what our responsibility is (<em>security in the cloud</em>). In a few words, it <span>is our responsibility to ensure that </span>what we create inside of the cloud, and all of the tools that we use to create it, are AWS-secure. </p>
<p>In the past, there were many security breaches <span>in </span>the famous AWS S3 <span>service, </span>because people configured the service to be readable/writable from anywhere in the world. AWS guarantees that the service is always updated and patched, but the permissions we give when accessing it are left in our court.</p>
<p>On YouTube, it is possible to listen to a very nice song by Kate Turchin, located at <a href="https://www.youtube.com/watch?v=tIb5PGW_t1o" target="_blank">https://www.youtube.com/watch?v=tIb5PGW_t1o</a>. This song explains the shared responsibility model in an accessible way:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7148cfd4-56ce-4ebb-9f08-eca5271b5a7a.png" style="width:54.75em;height:10.25em;"/></p>
</div>
</div>
</div>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">CloudTrail</h1>
                </header>
            
            <article>
                
<p>We have enabled IAM personal users and have avoided the root account. We have also assigned the necessary IAM policy to our groups, and have assigned each user to the right group. However, we <span>also </span>need to record all of their actions. To fulfill this purpose, the AWS service to enable is CloudTrail. </p>
<p>Each event performed over the AWS infrastructure by an IAM user or a resource with an IAM role assigned to it will be recorded in an S3 bucket and/or in a CloudWatch log group. My advice is to follow the AWS documentation at: <a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-a-trail-using-the-console-first-time.html" target="_blank">https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-a-trail-using-the-console-first-time.html</a>. <span>Creating a trail from the web console will be very straightforward, if you read this document.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VPC Flow Logs</h1>
                </header>
            
            <article>
                
<p><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z h-lparen">An <strong>intrusion</strong></span><strong><span> d</span></strong><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><strong>etection system</strong></span> (<span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><strong>IDS</strong></span>) <span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">and an</span> <span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><strong>i</strong></span><strong><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z h-lparen">ntrusion</span><span> p</span></strong><span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><strong>revention system</strong></span> (<span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"><strong>IPS</strong></span>)<span class="author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z"> are common tools in a secure network. In an on-premise environment, they are not so easy or cheap to implement, because you need dedicated hardware, and also a network structure that accommodates this feature. </span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">By contrast, in<span> </span>AWS, using only one feature of the VPC service, you can enable and disable these tools whenever and wherever you consider appropriate</span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">. </span><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">You can have these tools at three levels of your network: </span></p>
<ul>
<li class="mce-root"><span>The VPC level  </span></li>
<li>The subnet level</li>
<li>The <strong>elastic network interface</strong> (<strong>ENI</strong>) level</li>
</ul>
<p><span class=" author-d-iz88z86z86za0dz67zz78zz78zz74zz68zjz80zz71z9iz90z95be5927z76zz66zz89z7z74zsfz81zfz71zz71zrz122z3wuz84zz89zcz84z1dz66z">As you know, a network interface belongs to one subnet, and one subnet belongs to a VPC. So, if you enable tools at the subnet level, you don't have to apply them at the network interface level, and if you enable them at the VPC level, you don't need to apply them at the subnet level. </span>Before you activate this feature, you need to create the following three resources: </p>
<ul>
<li class="mce-root"><span>An empty CloudWatch group, where the data will be stored</span></li>
<li>An AWS role to perform the VPC Flow Log operation</li>
<li>A policy associated with the role, with the necessary permissions</li>
</ul>
<p>Of course, you can create these resources manually, and all of the instructions to do this are available on the flow logs documentation page at <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html</a>. However, to take a more DevOps/automated approach, we can use a Terraform module. In this case, we use a remote module created on GitHub. As you can see in the official Terraform documentation about module sources at <a href="https://www.terraform.io/docs/modules/sources.html#github" target="_blank">https://www.terraform.io/docs/modules/sources.html#github</a>, GitHub is a supported source type. However, if you want to use your own GitHub repository, you can use <kbd>ssh</kbd> or <kbd>https</kbd> as module sources. For more information, refer to <a href="https://www.terraform.io/docs/modules/sources.html#github" target="_blank">https://www.terraform.io/docs/modules/sources.html#github</a>.</p>
<p>The code to call the module is very simple, and requires only two parameters—the <kbd>source</kbd> and the <kbd>prefix</kbd>. The <kbd>prefix</kbd> will be used to name all the module resources. You can download or look into the <span>GitHub repository link given in the <em>Technical requirement</em> section</span> to see what this module does, <span>in detail</span>. However, to use it, the following few lines are enough:</p>
<pre>module "flow-log-prerequisite" {<br/>   source = "github.com/giuseppeborgese/effective_devops_with_aws__second_edition//terraform- modules//vpc-flow-logs-prerequisite"<br/>   prefix = "devops2nd"<br/> }<br/>output "role" { value = "${module.flow-log-prerequisite.rolename}" }<br/>output "loggroup" { value = "${module.flow-log-prerequisite.cloudwatch_log_group_arn}" }</pre>
<p>The names in the output are useful to use in the web console after that.</p>
<p>After you have added the module lines to any of your existing files, or to a new one with a <kbd>.tf</kbd> <span>extension</span>, it is necessary to initialize them with <kbd>terraform init</kbd>. </p>
<p><span>The following is the output of the <kbd>terraform init</kbd> command:</span></p>
<pre><strong>terraform init -upgrade</strong><br/><strong> Upgrading modules...</strong><br/><strong> - module.flow-log-prerequisite</strong><br/><strong> Updating source "github.com/giuseppeborgese/effective_devops_with_aws__second_edition//terraform-modules//vpc-flow-logs-prerequisite"</strong><br/><strong>Initializing the backend...</strong><br/><strong>Initializing provider plugins...<br/>....</strong></pre>
<p>The <kbd>terraform</kbd> binary has just downloaded the module code. At this point, if it wasn't been done beforehand, download the AWS provider information from the latest available <span>version</span><span>. The</span> <kbd>-upgrade</kbd> <span>option </span><span>forces you to use the latest available version, so that is usually a good idea.</span></p>
<p>Now, with a <kbd>terraform plan</kbd>, we can see which three objects will be created:</p>
<pre class="mce-root"><strong>terraform plan -out /tmp/tf11.out</strong><br/><strong> Refreshing Terraform state in-memory prior to plan...</strong><br/><strong> The refreshed state will be used to calculate this plan, but will not   </strong><br/><strong> be persisted to local or remote state storage.<br/>...<br/>...<br/>An execution plan has been generated and is shown below.</strong><br/><strong> Resource actions are indicated with the following symbols:</strong><br/><strong> + create</strong><br/><strong>Terraform will perform the following actions:</strong><br/><strong>+ module.flow-log-prerequisite.aws_cloudwatch_log_group.flow_log</strong><br/><strong> id: &lt;computed&gt;</strong><br/><strong> arn: &lt;computed&gt;</strong><br/><strong> name: "devops2nd_flowlogs"</strong><br/><strong> retention_in_days: "0"</strong><br/><strong>+ module.flow-log-prerequisite.aws_iam_role.flow_role</strong><br/><strong> id: &lt;computed&gt;</strong><br/><strong> arn: &lt;computed&gt;</strong><br/><strong> assume_role_policy: "{\n \"Version\": \"2012-10-17\",\n \"Statement\": [\n {\n \"Sid\": \"\",\n \"Effect\": \"Allow\",\n \"Principal\": {\n \"Service\": \"vpc-flow-logs.amazonaws.com\"\n },\n \"Action\": \"sts:AssumeRole\"\n }\n ]\n}\n"</strong><br/><strong> create_date: &lt;computed&gt;</strong><br/><strong> force_detach_policies: "false"</strong><br/><strong> max_session_duration: "3600"</strong><br/><strong> name: "devops2nd_flowlogs"</strong><br/><strong> path: "/"</strong><br/><strong> unique_id: &lt;computed&gt;</strong><br/><strong>+ module.flow-log-prerequisite.aws_iam_role_policy.flow_policy</strong><br/><strong> id: &lt;computed&gt;</strong><br/><strong> name: "devops2nd_flowlogs"</strong><br/><strong> policy: "{\n \"Version\": \"2012-10-17\",\n \"Statement\": [\n {\n \"Action\": [\n \"logs:CreateLogGroup\",\n \"logs:CreateLogStream\",\n \"logs:PutLogEvents\",\n \"logs:DescribeLogGroups\",\n \"logs:DescribeLogStreams\"\n ],\n \"Effect\": \"Allow\",\n \"Resource\": \"*\"\n }\n ]\n}\n"</strong><br/><strong> role: "${aws_iam_role.flow_role.id}"<br/><br/></strong><strong>Plan: 3 to add, 0 to change, 0 to destroy.</strong><br/>-----------------------------------------------------------------------</pre>
<p class="mce-root">This plan was saved to: <kbd>/tmp/tf11.out</kbd>.</p>
<p class="mce-root"><span>To apply these actions, run the following command:</span></p>
<pre class="mce-root"><strong>terraform apply /tmp/tf11.out</strong></pre>
<p>Then, create them with a <kbd>terraform apply</kbd> command:</p>
<pre><strong>tf11 apply /tmp/tf11.out</strong><br/><strong> module.flow-log-prerequisite.aws_cloudwatch_log_group.flow_log: Creating...</strong><br/><strong> arn: "" =&gt; "&lt;computed&gt;"</strong><br/><strong> name: "" =&gt; "devops2nd_flowlogs"</strong><br/><strong> retention_in_days: "" =&gt; "0"</strong><br/><strong> module.flow-log-prerequisite.aws_iam_role.flow_role: Creating...</strong><br/><strong> arn: "" =&gt; "&lt;computed&gt;"</strong><br/><strong> assume_role_policy: "" =&gt; "{\n \"Version\": \"2012-10-17\",\n \"Statement\": [\n {\n \"Sid\": \"\",\n \"Effect\": \"Allow\",\n \"Principal\": {\n \"Service\": \"vpc-flow-logs.amazonaws.com\"\n },\n \"Action\": \"sts:AssumeRole\"\n }\n ]\n}\n"</strong><br/><strong> create_date: "" =&gt; "&lt;computed&gt;"</strong><br/><strong> force_detach_policies: "" =&gt; "false"</strong><br/><strong> max_session_duration: "" =&gt; "3600"</strong><br/><strong> name: "" =&gt; "devops2nd_flowlogs"</strong><br/><strong> path: "" =&gt; "/"</strong><br/><strong> unique_id: "" =&gt; "&lt;computed&gt;"</strong><br/><strong> module.flow-log-prerequisite.aws_iam_role.flow_role: Creation complete after 2s (ID: devops2nd_flowlogs)</strong><br/><strong> module.flow-log-prerequisite.aws_iam_role_policy.flow_policy: Creating...</strong><br/><strong> name: "" =&gt; "devops2nd_flowlogs"</strong><br/><strong> policy: "" =&gt; "{\n \"Version\": \"2012-10-17\",\n \"Statement\": [\n {\n \"Action\": [\n \"logs:CreateLogGroup\",\n \"logs:CreateLogStream\",\n \"logs:PutLogEvents\",\n \"logs:DescribeLogGroups\",\n \"logs:DescribeLogStreams\"\n ],\n \"Effect\": \"Allow\",\n \"Resource\": \"*\"\n }\n ]\n}\n"</strong><br/><strong> role: "" =&gt; "devops2nd_flowlogs"</strong><br/><strong> module.flow-log-prerequisite.aws_cloudwatch_log_group.flow_log: Creation complete after 3s (ID: devops2nd_flowlogs)</strong><br/><strong> module.flow-log-prerequisite.aws_iam_role_policy.flow_policy: Creation complete after 1s (ID: devops2nd_flowlogs:devops2nd_flowlogs)</strong><br/><strong>Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</strong><br/><strong> Outputs:</strong><br/><strong>loggroup = arn:aws:logs:us-east-1:790419456202:log-group:devops2nd_flowlogs:*</strong><br/><strong> role = devops2nd_flowlogs</strong></pre>
<p>Take a note of these last two pieces of output as we need to activate the flow log.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the flow log for one subnet</h1>
                </header>
            
            <article>
                
<p>Now, with all of the prerequisites satisfied, we are going to create a flow log for one subnet that is open in the AWS web console for the VPC service:</p>
<ol>
<li>Select one subnet. Now, select the <span class="packt_screen">Flow Logs</span> tab, and click on the <span class="packt_screen">Create flow log</span> button, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2c0781b0-a1fe-42a5-bb02-0f382c2075de.png" style="width:53.42em;height:31.00em;"/></p>
<ol start="2">
<li>Insert the information as it is given in the following screenshot. The log group and the role are the ones created with the Terraform module. In this example, we are interested in seeing the traffic that is accepted, so we select the <span class="packt_screen">Accept</span> option in the <span class="packt_screen">Filter</span> drop-down menu:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9e9d1489-e3d2-4152-85fc-4e108d682de1.png" style="width:67.25em;height:28.58em;"/></p>
<p>Now that you have a situation like this in your AWS web console, take note of the subnet number, because we will need it when it comes to verification. Of course, your subnet ID will be different from mine, which is <span><kbd>subnet-15a59419</kbd>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Verifying the flow logs </h1>
                </header>
            
            <article>
                
<p>In order to verify whether a flow log is working, and to get practice with the flow log, we are going to create an EC2 machine for the subnet login in SSH, and we will analyze the traffic for that SSH login. </p>
<p>We won't cover the full process of creating an EC2 machine <span>here </span>because it is a basic task. If you are at this point in the book, you should already know how to do it. What I suggest is to use a <kbd>t2.micro</kbd> that is a free-tier eligible type. Also, it is very important to create the machine in the subnet where you just activated the flow log, and to allow the SSH to have access from your location. </p>
<p>After a short period of time, you can go into the CloudWatch service, click on the <span class="packt_screen">Logs</span> option<span class="packt_screen">,</span> and select the log group, <kbd>devops2nd_flowlogs</kbd>, created with Terraform:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7da9da5f-c804-4a19-9788-8903ae83a5a7.png" style="width:38.67em;height:15.50em;"/></p>
<p>Inside of that, you will find the name of the network interface associated with the EC2 instance created previously, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/80b36821-4fd6-4779-b97e-3ad60f4ae2f8.png" style="width:28.67em;height:12.58em;"/></p>
<p>If you have many network interfaces <span>in the same subnet</span>, this means that you have multiple machines, and you need to go to the EC2 service and the <span class="packt_screen">Network Interfaces</span> option, and locate the network interface using the <span class="packt_screen">Instance ID</span> column, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c27fb070-6a18-457b-aa82-d8d6244bed68.png"/></p>
<p>However, you will probably only <span>have</span><span> one network interface, so click on its name. In my case, this is</span> <kbd>eni-0d899a52e790058aa-accept</kbd><span>.</span></p>
<p>There are many lines; to understand the details of each one, you can take a look at the record documentation at <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html#flow-log-records" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html#flow-log-records</a>:<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/flow-logs.html#flow-log-records"/></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e3e059f7-ad18-481d-938d-594609795052.png" style="width:69.75em;height:35.83em;"/></p>
<p>However, we want to find our SSH connection attempt, so it is necessary to recover our laptop's public IP with a service like the one at <a href="http://www.whatsmyip.org/" target="_blank">http://www.whatsmyip.org/</a>, and put it in the filter, as follows: </p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/53195b21-6167-4346-a95c-ee9aed34698c.png"/></p>
<p>In the first line, you can see the following items:</p>
<ul>
<li class="mce-root"><span>The public IP of my laptop is </span><kbd>79.1.172.1</kbd></li>
<li>The private IP of the EC2 instance is <kbd>172.31.61.129</kbd></li>
<li>The source port of my laptop is <kbd>61704</kbd></li>
<li>The destination port of the EC2 instance for the SSH service is port <kbd>22</kbd></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VPC Flow Log consideration</h1>
                </header>
            
            <article>
                
<p>We have completed a tour of the VPC Flow Log service with a working <strong>proof of concept</strong> (<strong>PoC</strong>). Of course, there are many other options available in the service, which you can find in the official AWS documentation. By visiting these, you can continue to explore the potential of the VPC Flow Log.</p>
<p>At this point, if you ever try to do <span>the same task performed by the VPC Flow Log in an on-premise environment</span>, it should be clear how <span>easy </span><span>it is to enable a full traffic monitor on the AWS cloud compared with doing do so in an on-premise environment.  </span></p>
<p>Don't forget to delete the EC2 instance that was created previously, in order to avoid incurring any unnecessary extra charges. The other resource will not have any costs, unless you generate a very great amount of traffic in that subnet. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">VPC subnets </h1>
                </header>
            
            <article>
                
<p>In this section, we will look at how to organize our VPC subnets, following the least privileged principle. We have to expose and give access to our resources (EC2, ELB, and RDS) in the fewest possible circumstances, in order to limit security attacks and data leaks. </p>
<p>In each AWS region there is already a default VPC that has been <span>created</span><span>. If you want to know all of the details of this, I would recommend that you read the <em>Default VPC and Default Subnets</em> documentation at </span><a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html</a><span>. However, in short, it is possible to say that everything you put there is potentially exposed to the public network if the security group that you configure allows that. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Routing and subnet types</h1>
                </header>
            
            <article>
                
<p>In the official documentation at <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenarios.html" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenarios.html</a>, there are four scenarios <span>described</span> for your VPC configuration, and it will be useful to look into that. It is important to understand that access to the resources that you place in your subnets is determined by the three following factors:</p>
<ul>
<li class="mce-root"><span>Routing </span></li>
<li>The <strong>Network Access Control</strong> (<span><strong>NAC</strong>) l</span>ist (a stateless firewall)</li>
<li>The security group (a stateful firewall)</li>
</ul>
<p>My advice is to not<span> </span>touch the NAC; leave the default one attached to each subnet, which allows all of the inbound and outbound <span>traffic,</span> and use <span>the security group </span><span>as a firewall instead. A subnet can be classified into three types, based on their security levels:</span></p>
<ul>
<li class="mce-root"><span>Public subnets</span></li>
<li>Private subnets with internet access</li>
<li>Private subnets without internet access</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Accessing private subnets</h1>
                </header>
            
            <article>
                
<p>The resources in public subnets can be accessed by using the public IP and enabling the security group to receive connections. For private subnets, you have at least three ways to do this, as follows:</p>
<ul>
<li class="mce-root"><span>Jump on a bastion host in one public subnet, and, from there, reach the private resources.</span></li>
<li>Use site-to-site VPNs from the AWS VPN service, <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpn-connections.html">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpn-connections.html</a>, to the physical router/s in your office. You can connect two routers, for redundancy. </li>
<li>Place a virtual VPN software in an EC2 machine and connect your device to it. There are countless solutions that do this, and many are in the AWS Marketplace, ready to be used in exchange for a monthly fee. </li>
</ul>
<p>The preferred option, if you have an office with physical routers, is always the site-to-site solution. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What to place in which subnet?</h1>
                </header>
            
            <article>
                
<p>In my test VPC, I have six subnets—two for each type, as you can see in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7b0eca17-e3cb-47c3-9cce-a5ec97e788da.png" style="width:79.67em;height:24.50em;"/></p>
<p><em>What should you insert in each kind of subnet?</em> Consider the following points:</p>
<ul>
<li class="mce-root"><strong>Public subnets</strong><span>: This refers to all of the external</span> <strong>Elastic Load Balancing</strong> <span>(</span><strong>ELB</strong><span>) with public access, the bastion host (if you have one), the v</span><span>irtual VPN software in an EC2 machine, and any other resource that requires access from the internet, and cannot be accessed in any other way.</span></li>
<li><strong>Private subnets with internet access</strong>: This refers to all of the internal ELBs as well as all EC2 machines behind an ELB (internal or external), that have to download or upload something to the internet, and a database that is required to download or upload something to the internet</li>
<li><strong>Private subnets without internet access</strong>: This refers to all resources that don't need access to the internet for any reason, and also resources whose updates are downloaded from an internal repository</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Identifying subnets from the web console</h1>
                </header>
            
            <article>
                
<p>Keep the following points <span>in mind </span>:</p>
<ul>
<li class="mce-root"><span>Every subnet can have</span> <span>one </span><span>associated r</span>oute table</li>
<li>One route table can be associated with multiple subnets</li>
<li>If you don't explicitly associate a route table to a subnet, the default route table is associated automatically</li>
</ul>
<p>In the following screenshot, you can see three route tables, where the <span class="packt_screen">Public Route</span> is the default route table:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/9cda0f1b-b81a-4165-82d0-d349b49e3bf2.png" style="width:56.75em;height:17.83em;"/></p>
<p class="mce-root">In the <span class="packt_screen">Subnets</span> section, you can see the route table associated with that subnet and the single routes, but to change the content of a route table<strong>,</strong> you have to edit from the <span class="packt_screen">Route Tables</span> section. What differentiate a private route from a public route table/subnet is the destination of the <kbd>0.0.0.0/0</kbd> route. If it's a forward internet gateway, <kbd>igw-xxxxx</kbd> means that this subnet is reachable from the outside world and can connect to the internet, as well (assuming that the security group allows for that):</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/60bd4329-52ad-4d9a-a8b2-6373367960a3.png" style="width:38.17em;height:27.08em;"/></p>
<p>If it points to an NAT gateway or another EC2 instance <span>instead</span><span>, this means that it is a private subnet with internet access, and it can access the internet in any way, and so it is reachable from the external world. First, you have to</span> click on the <span class="packt_screen">Create a NAT Gateway</span> button, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ad9c7b44-6d02-4211-91f2-e0f87e0ab73e.png" style="width:61.33em;height:21.33em;"/></p>
<p>After that, you can change the routing table and have a situation like the one shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a08840b5-c40a-4099-ad57-8102b4f8d98f.png" style="width:56.25em;height:29.58em;"/></p>
<p>If the <kbd>0.0.0.0/0</kbd> isn't present, as shown in the preceding screenshot, it is a completely private subnet:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e8cda0c6-bcb0-4919-9f81-2957619639c7.png" style="width:58.08em;height:30.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Endpoint routing</h1>
                </header>
            
            <article>
                
<p><span>If a database has to upload a backup to a private S3 </span><span>bucket </span><span>in the same region, it should never use internet access, but should take a private, internal route. This is called a VPC endpoint. With this kind of route, you can avoid passing through the internet to reach an AWS service, such as S3, DynamoDB, or CloudWatch, and gain speed, security, and cost savings (internet traffic has a cost). To see all of the services with a VPC endpoint, you can take a look at the official documentation at <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html</a>.<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints.html"/></span></p>
<p>Here, we will configure the first VPC endpoint available for the S3 service, as follows: </p>
<ol>
<li>Go to <span class="packt_screen">VPC</span> | <span class="packt_screen">Endpoints |</span> <span class="packt_screen">Create Endpoint:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7a55f50e-9aa3-4a64-9d1a-0611a2711145.png" style="width:21.75em;height:18.50em;"/></p>
<ol start="2">
<li>Leave the default AWS service and select the S3 service, as seen in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ff40f237-8d4a-44a2-ad75-7e33af134d78.png" style="width:36.00em;height:26.33em;"/></p>
<ol start="3">
<li>
<p>Select the VPC that you are working on, and all of the route tables to modify:</p>
</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6a711d1b-fb73-4641-aa7f-64133709a0d5.png" style="width:48.17em;height:23.83em;"/></p>
<ol start="4">
<li>Now, you can see a new route rule, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/2b8643d5-1fa1-40ee-9c77-a52f33f52ca1.png" style="width:45.17em;height:20.08em;"/></p>
<p>Keep in mind that this will work for all of the buckets created in the same VPC region. In this example, it is <kbd>us-east-1</kbd>, North Virginia.</p>
<p>In the AWS documentation for the <em>Endpoints for Amazon S3</em> at <a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints-s3.html" target="_blank">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-endpoints-s3.html</a>, there is an interesting hardening rule for the S3 bucket policy, as follows:</p>
<pre>{<br/>    "Version": "2012-10-17",<br/>    "Id": "Policy1415115909152",<br/>     "Statement": [<br/>        {<br/>            "Sid": "Access-to-specific-VPCE-only",<br/>            "Principal": "*",<br/>            "Action": "s3:*",<br/>            "Effect": "Deny",<br/>            "Resource": ["arn:aws:s3:::my_secure_bucket",<br/>                         "arn:aws:s3:::my_secure_bucket/*"],<br/>            "Condition": {<br/>                "StringNotEquals": {<br/>     "aws:sourceVpce": "vpce-039f31bfec07367ea"<br/>                 }<br/>             }<br/>        }<br/>       ]<br/> }</pre>
<p>I have changed this by adding my VPC endpoint ID, <kbd>vpce-039f31bfec07367ea</kbd> instead of the one in the documentation. With this rule, the bucket <span><kbd>my_secure_bucket</kbd> will be only reachable from the VPCs that are associated with that endpoint. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">AWS WAF</h1>
                </header>
            
            <article>
                
<p>You restrict access by using security groups and private subnets for all your resources. All of the monitor logs, VPC Flow Logs, and CloudTrails are active. IAM policies are enforced, everything is correctly secured, and nothing is exposed. This is because you have the VPN service to access any resources. However, if you want to provide an internet service, you have to open at least one point of access to the external world. As we already discussed in the <em>VPC</em> <em>Subnets</em> section, you should expose as few resources in the public subnet <span>as possible,</span><span> with the <kbd>0.0.0.0/0</kbd> security group rule open. If possible, only an ELB should stay in this situation, passing connections to the EC2 machines in private subnets, since the EC2 machines communicate with the RDS databases with strict security rules. </span></p>
<p>This is the most classic AWS application, and it is not necessary to explain it in detail here. Instead, we want to focus on increasing the security of the ELB with the AWS WAF. For more information, refer to <a href="https://aws.amazon.com/waf/" target="_blank">https://aws.amazon.com/waf/</a>. AWS WAF is a firewall that works <span>at the application level </span><span>and can protect at level 7 of the TCP/IP stack protocol, rather than at level 4 of the TCP/IP stack, where</span><span> the security groups work</span><span>.</span></p>
<p><em>What can the WAF do that a security group can't?</em> Consider the following answers to this question:</p>
<ul>
<li class="mce-root"><span>Protect against </span><span>SQL injection and cross-site scripting</span></li>
<li>Block <strong>denial-of-service</strong> (<strong>DoS</strong>) and <strong>distributed denial-of-service</strong> (<strong>DDoS</strong>)</li>
<li>Protect a part of the URL of your web application, such as <kbd>www.mywebsite/admin</kbd></li>
</ul>
<p>In this chapter, we will create two practical POCs with Terraform about DoS and a sub-URL. To do this, we are going to create a web application playground, apply the WAF, and test the rules to trigger its protection. Keep in mind that when this part of the book was being written, the WAF could only be applied to the <strong>application load balancer</strong> (<strong>ALB</strong>) and CloudFront, but AWS continuously updates its services, so there is no knowing what might be done in the near future.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Web application playground</h1>
                </header>
            
            <article>
                
<p>Our test playground will be an ALB and an EC2 machine with an Apache2 web server <span>installed</span>. In this section, we will only create the environment and test it, without any WAF configuration. In the next section, however, we will add the WAF level on the ALB.</p>
<p>To create the following playground, we will use a Terraform module that is available on GitHub:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/69c2e81d-c9e6-40e9-b752-5614a7d72dc6.png" style="width:31.25em;height:23.33em;"/></p>
<p>Start by adding the following code to your <kbd>main.tf</kbd> file:</p>
<pre>module "webapp-playground" {<br/>  source = "github.com/giuseppeborgese/effective_devops_with_aws__second_edition//terraform-modules//webapp-playground"<br/>  subnet_public_A = "subnet-a94cabf4"<br/>  subnet_public_B = "subnet-54840730"<br/>  subnet_private = "subnet-54840730"<br/>  vpc_id = "vpc-3901d841"<br/>  my_ami = "ami-b70554c8"<br/>  pem_key_name = "effectivedevops"<br/>}</pre>
<p>Some things to keep in mind are as follows:</p>
<ul>
<li class="mce-root"><span>The ALB must always live in at least two subnets, in two different availability zones.</span></li>
<li>This ALB is reachable on port <kbd>80</kbd> and uses an HTTP listener that can be acceptable for <span>a PoC. However, </span>in your real environment, it is best to register a public domain with AWS Route 53, create an SSL certificate with AWS Certificate Manager, associate this certificate to the ALB, and use an HTTPS listener.</li>
</ul>
<ul>
<li>The security group settings are very strict, and you can take a look at the module code to see that the ALB security group <span>ingress </span>is reachable only from port <kbd>80</kbd> to the whole internet, <kbd>0.0.0.0/0</kbd>, and this can be reached in <em>egress</em> only from port <kbd>80</kbd> of the EC2 security group. </li>
</ul>
<p>As usual, to create the resource you need to <span>run the following commands</span>:</p>
<pre class="mce-root"><strong>terraform init -upgrade</strong><br/><strong>terraform plan -out /tmp/tf11.out</strong><br/><strong>Plan: 12 to add, 0 to change, 0 to destroy. </strong><br/><strong>terraform apply /tmp/tf11.out</strong></pre>
<p>Find the DNS ALB name, as shown in the following screenshot, and copy it:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3e2d7f8d-fcc7-4f29-91b5-efa188b5929a.png" style="width:63.92em;height:36.08em;"/></p>
<p><span>Open it from your browser, as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1f443cb9-679c-48e6-afab-daac71e6a059.png" style="width:42.58em;height:5.75em;"/></p>
<p>There is also a subdirectory that we can use to test our WAF later:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/feaf6ed6-30cd-45ff-814e-4f66514444c9.png" style="width:40.75em;height:5.17em;"/></p>
<p>If you don't use it quickly enough, your playground will destroy it with the <kbd>terraform</kbd> command, to avoid incurring any unnecessary charges. If you want to destroy just the playground, but not the other resources that were created, you can use a selective <kbd>destroy</kbd> <span>module, as follows:</span></p>
<pre><strong>terraform destroy -target module.webapp-playground</strong></pre>
<p>If you confirm with a <kbd>Yes</kbd>, then the 12 module resources will be destroyed. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Allow a sub-URL to be accessible only from an IP </h1>
                </header>
            
            <article>
                
<p class="mce-root">Usually, in your web application, you have an admin area, and it could be the case that this part of your portal isn't accessible by everyone. Of course, you have a username and password, but an attacker can steal those credentials in many ways.  </p>
<p>If it is a sensitive application, for the principle of least privilege to be followed, it is convenient to restrict access to the locations where this kind of admin access needs to be used; for example, from the office. If you can have different access for the admin section you can put this behind an internal load balancer and connect the VPC to your office by using a VPN service, as discussed in previous sections. The internal load balancer DNS name is converted with the private IPs of your VPC, and, in this way, you can assure that connections are only made from a trusted source, such as your office.</p>
<p>However, many times, you won't have this option, because the application is all in one bundle, and you cannot separate the admin sub-URL from the main part. In such cases, the only change available is to use an AWS WAF and apply a filter to the admin sub-URL only. We need to create a WAF and attach it to the ALB for our playground web app.</p>
<p>To do this, I have created a <kbd>terraform</kbd> module, and you can use it in your code with the following lines:</p>
<pre>module "limit_admin_WAF" {<br/>  source = "github.com/giuseppeborgese/effective_devops_with_aws__second_edition//terraform-modules//limit-the-admin-area"<br/>  alb_arn = "${module.webapp-playground.alb_arn}"<br/>  my_office_ip = "146.241.179.87/32"<br/>  admin_suburl = "/subdir"<br/>}</pre>
<p>Of course, don't forget to replace your office IP or home connection public IP in the <span><kbd>my_office_ip</kbd> field, and to use the subnet mask <kbd>/32</kbd> if it is a single IP, as in my case.</span></p>
<p>The commands are the usual ones, as follows: </p>
<pre class="mce-root"><strong>terraform plan -out /tmp/tf11.out</strong><br/><strong>terraform init -upgrade</strong><br/><strong>terraform apply /tmp/tf11.out</strong> </pre>
<p>To facilitate the test, I have added an <span><kbd>alb_url</kbd> output variable, as follows:</span></p>
<pre class="mce-root"><strong>alb_url = playground-1940933132.us-east-1.elb.amazonaws.com</strong><br/><strong>loggroup = arn:aws:logs:us-east-1:790419456202:log-group:devops2nd_flowlogs:*</strong><br/><strong>role = devops2nd_flowlogs</strong><br/><strong>giuseppe@Giuseppes-MacBook-Air ~/p/effectivedevops&gt;</strong></pre>
<p class="mce-root">Now, the WAF is associated to the ALB, and all of the requests will be filtered. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing with the command line</h1>
                </header>
            
            <article>
                
<p>This time, we are going to test it using the command-line tool, <kbd>curl</kbd>. As you can see from my office IP, no issues arose when trying to reach both the root directory and the sub-URL: </p>
<pre><strong>giuseppe@Giuseppes-MacBook-Air ~&gt; curl http://playground-1940933132.us-east-1.elb.amazonaws.com/subdir/</strong><br/><strong> This is a sub directory</strong><br/><strong>giuseppe@Giuseppes-MacBook-Air ~&gt; curl http://playground-1940933132.us-east-1.elb.amazonaws.com/</strong><br/><strong> This is a playground main directory</strong><br/><strong>giuseppe@Giuseppes-MacBook-Air ~&gt;</strong></pre>
<p>Instead, when I used a virtual machine with another public IP, I got back the following result: </p>
<pre><strong>[ec2-user@ip-172-31-6-204 ~]$ curl http://playground-1940933132.us-east-1.elb.amazonaws.com/</strong><br/><strong> This is a playground main directory</strong><br/><strong> [ec2-user@ip-172-31-6-204 ~]$ curl http://playground-1940933132.us-east-1.elb.amazonaws.com/subdir/</strong><br/><strong> &lt;html&gt;</strong><br/><strong> &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</strong><br/><strong> &lt;body bgcolor="white"&gt;</strong><br/><strong> &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</strong><br/><strong> &lt;/body&gt;</strong><br/><strong> &lt;/html&gt;</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Identifying the WAF from the web console</h1>
                </header>
            
            <article>
                
<p>Take a look at the resource created, that is, the service WAF, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ab338043-bd83-4d95-9747-9beb1f125b46.png" style="width:73.25em;height:42.17em;"/></p>
<p class="CDPAlignLeft CDPAlign">View the <span class="packt_screen">Web ACLs</span> option, and select the region where you are working from the <span class="packt_screen">Filter</span> menu. You can see what the Terraform module creates, as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c79cb95c-dd32-4735-891f-a324d7023f48.png" style="width:76.58em;height:30.92em;"/></p>
<p class="CDPAlignLeft CDPAlign">In the <span class="packt_screen">Rules</span> section, it is possible to see the filter itself, and the IP that is allowed to access the restricted area:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f580a4a8-7dd0-40bf-b740-f97774e2b7b5.png" style="width:76.25em;height:27.50em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Blocking DoS/DDoS attacks</h1>
                </header>
            
            <article>
                
<p>A DoS attack is an old problem for our applications, especially in their distributed versions, the DDoS, where multiple sources (usually hacked devices of many kinds, that form a botnet) try to run a DoS by running so many queries at the same time that a network becomes overloaded. In this case, to defend and continue to serve traffic to legitimate users, it is fundamental to identify and block malicious sources.</p>
<p>It is worth spending a little bit of time reading the official documentation on <em>Denial of Service Attack Mitigation on AWS, </em>at <a href="https://aws.amazon.com/answers/networking/aws-ddos-attack-mitigation/" target="_blank">https://aws.amazon.com/answers/networking/aws-ddos-attack-mitigation/</a>. What we want to do here is to focus on a practical example of using WAF.</p>
<p>The AWS WAF can block a single public IP that is sending too many requests. The question that should pop up in your mind is, <em>how many requests are too many?</em> This depends on your web application, so what you should do before applying any filter of this kind is measure the number of requests received from a single IP in a five-minute time range. </p>
<p>Keep in mind that the AWS WAF lower limit that it is 2,000 requests and also according to my tests, though request <kbd>2001</kbd> will be not blocked, after a while, you will see a number of subsequent requests blocked. As we did for the other examples, we will not trust what AWS declares, but we will test our PoC after its creation. To immediately see whether the system is working, we will set up the AWS limit for our sub-URL: <kbd>http://playground-1940933132.us-east-1.elb.amazonaws.com/subdir/</kbd>. We are not going to apply anything on the main page, at <kbd>http://playground-1940933132.us-east-1.elb.amazonaws.com</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating AWS WAF with Terraform</h1>
                </header>
            
            <article>
                
<p>Destroy the <kbd>limit_admin_WAF</kbd> module to avoid conflicts. You can do so with the following command: </p>
<pre><strong>terraform destroy -target module.limit_admin_WAF</strong></pre>
<p>Next, comment on the module in your code, using <kbd>/* */</kbd>:</p>
<pre class="mce-root">/* module "limit_admin_WAF" {<br/> source<br/>.............<br/>} */</pre>
<p class="mce-root">Create the new module with the following code:</p>
<pre class="mce-root"> module "limit_admin_WAF" {<br/> source = "github.com/giuseppeborgese/effective_devops_with_aws__second_edition//terraform-modules//ddos_protection"<br/> alb_arn = "${module.webapp-playground.alb_arn}"<br/> admin_suburl = "subdir"<br/> }</pre>
<p>As usual, include the following code snippet:</p>
<pre class="mce-root"><strong>terraform init --upgrade</strong><br/><strong>terraform plan -out /tmp/tf11.out</strong><br/><strong>terraform apply /tmp/tf11.out</strong><br/><strong> Outputs:</strong><br/><strong>alb_url = playground-1757904639.us-east-1.elb.amazonaws.com</strong></pre>
<p>Take the DNS name from the output and test that everything is working with the <kbd>curl</kbd> command, as follows:</p>
<pre> <strong>curl playground-1757904639.us-east-1.elb.amazonaws.com</strong></pre>
<p>The following is a <kbd>playground</kbd> main directory:</p>
<pre class="CDPAlignLeft CDPAlign"><strong>curl playground-1757904639.us-east-1.elb.amazonaws.com/subdir/</strong> </pre>
<p class="CDPAlignLeft CDPAlign">This is a subdirectory. Log in to the web console, go to the WAF service, select the Virginia region, and note the <kbd>subdir</kbd> rule of the <span class="packt_screen">Rate-based</span> type, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a8045127-8b44-40dd-999a-fa32ffc9b43b.png" style="width:73.58em;height:29.42em;"/></p>
<p>Also, in the <span class="packt_screen">Rules</span> section, you will notice that right now, there aren't any IPs blocked:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c7a96ad3-d9ef-4563-a078-d2a5e866f569.png" style="width:69.75em;height:35.83em;"/></p>
<p>Keep in mind that any kind of DoS test is forbidden by AWS by default, and it can be blocked, because it violates the terms and conditions. For more information on the <em>AWS Service Terms</em>, refer to <a href="https://aws.amazon.com/service-terms/" target="_blank">https://aws.amazon.com/service-terms/</a>. In our case, we are going to run 2,000/4,000 requests from a single IP in a short period of time. It is not so large an amount that it will trigger the AWS alarm. If you have a very good internet connection, you can run this script from your laptop, but my advice is to use an Amazon Linux EC2 machine in a public subnet directly exposed to the internet, so that we have the same conditions of experimentation. </p>
<p>Log in on your machine and download the script with the following command: </p>
<pre><strong>curl -O https://raw.githubusercontent.com/giuseppeborgese/effective_devops_with_aws__second_edition/master/terraform-modules/ddos_protection/test_protection.sh</strong><br/><strong>chmod +x test_protection.sh</strong><br/><strong>./test_protection.sh ...</strong></pre>
<p>This will run 4,000 requests to your ALB playground. From the output, you can see that the first 2,000/3,000 requests will be successful:</p>
<pre><strong>This is a subdirectory</strong><br/><strong> 538</strong><br/><strong>This is a subdirectory</strong><br/><strong> 539</strong><br/><strong>This is a subdirectory</strong><br/><strong> 540</strong><br/><strong>This is a subdirectory</strong><br/><strong> 541</strong><br/><strong>This is a subdirectory</strong></pre>
<p>However, you will then start to receive rejected requests like the following:</p>
<pre>259<br/> &lt;html&gt;<br/> &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;<br/> &lt;body bgcolor="white"&gt;<br/> &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;<br/> &lt;/body&gt;<br/> &lt;/html&gt;<br/> 260<br/> &lt;html&gt;<br/> &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;<br/> &lt;body bgcolor="white"&gt;<br/> &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;<br/> &lt;/body&gt;<br/> &lt;/html&gt;</pre>
<p>If you don't see this during the first run, you will have to run the script <span>again</span><span> </span><span>to trigger the requests. You can log in with the web console in the WAF service, and you will see the public IP of your EC machine in the</span> <span class="packt_screen">Rules</span> <span>section:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a25056f8-5185-421e-bd53-dfe2724a4539.png" style="width:69.17em;height:30.33em;"/></p>
<p>Still, if you run a <kbd>curl</kbd> to the root directory, you will see that it is still accessible from your EC2 machine. If you try to access it from your laptop, the <kbd>subdir</kbd> URL will still be accessible. If you don't send any more requests for a while, the public IP of your EC2 machine will be removed from the blacklist, and this is correct, because that IP is not a threat if it returns to transmitting normal traffic amounts. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">DDoS attach consideration</h1>
                </header>
            
            <article>
                
<p>AWS WAF can be a very useful tool for mitigating DOS and DDOS attacks, but before starting to use it, it's convenient to do the following:</p>
<ul>
<li class="mce-root"><span>Read and observe how to implement the </span><span>DoS attack mitigation on AWS</span></li>
<li>Know your application, and set up a good limit for concurrent connections, to avoid blocking valid traffic and getting false positive responses</li>
<li>Build a scalable web application, to respond to requests until the WAF understands that it is under attack and triggers its filters</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">WAF for SQL Injection (SQLi)</h1>
                </header>
            
            <article>
                
<p>We created and tested the WAF features for rate rules and sub-URL limits. As we said at the beginning, there is also the <span>SQLi</span> feature, and it is possible to find some CloudFormation templates related to this on the official AWS website at <a href="https://github.com/aws-samples/aws-waf-sample" target="_blank">https://github.com/aws-samples/aws-waf-sample</a> GitHub repository.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary </h1>
                </header>
            
            <article>
                
<p>In this chapter, we applied the least privilege principle at different level. In the IAM section, you learned how to lock in your root account and pass control to IAM users, by configuring a password policy and setting up permissions and groups. Enabling CloudTrail, we tracked and monitored every action performed on our infrastructure by an IAM user or by a service, in our environment. With VPC Flow Logs, we observed a powerful network monitor applicable at any point of our VPC, and we also created our prerequisites using Terraform, a wonderful tool for growing our practice. . We also covered the concept of the Terraform module. In the <em>VPC subnets</em> section, we looked at the three kinds of subnet that we can use in our AWS cloud, and where to place the different kinds of resources available in our infrastructure, exposing it to the internet as little as possible and keeping as much as possible in private zones.</p>
<p>While discussing the WAF service, we explored one of the most powerful services for security available in the AWS world. Protecting some sensitive parts of your web application can be useful. DoS protection is something that should always be present in professional web service<span>. Configuring WAF is not always easy, but thanks to the power of Terraform automation and to the PoC modules available in this book, understanding the principles and configuring accordingly is only some <kbd>terraform</kbd> and <kbd>git</kbd> commands away. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>Suppose that I have just registered to the AWS cloud and received my password by email. Can I start to build my infrastructure, or do I have to follow some best practice beforehand? </li>
<li>What type of logging in should I enable in my AWS account?</li>
<li>Are security groups and NACL the only firewalls available in AWS?</li>
<li>How can I protect my web application from DDoS attacks by using AWS? </li>
<li>Can I put all of my resources in one subnet?</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p>Security is a very wide field and one chapter cannot be exhaustive. Further resources are available at <a href="https://aws.amazon.com/whitepapers/aws-security-best-practices/">https://aws.amazon.com/whitepapers/aws-security-best-practices/</a>.</p>
<p><span>The <strong>Center for Internet Security</strong></span><span> </span><span>(</span><strong><span>CIS</span></strong><span>) Benchmark for AWS Foundation is a security hardening guideline for securing AWS accounts/environments. Refer to the following links:</span></p>
<ul>
<li><em>CIS Amazon Web Services Foundations</em> at <a href="https://d0.awsstatic.com/whitepapers/compliance/AWS_CIS_Foundations_Benchmark.pdf">https://d0.awsstatic.com/whitepapers/compliance/AWS_CIS_Foundations_Benchmark.pdf</a></li>
<li><em>CIS </em><span><em>Script to check benchmark against the AWS API</em> at <a href="https://github.com/awslabs/aws-security-benchmark" target="_blank">https://github.com/awslabs/aws-security-benchmark</a></span></li>
</ul>
<p class="mce-root">For more information on <em>AWS Certified Security - Specialty</em>, refer to <a href="https://aws.amazon.com/certification/certified-security-specialty/">https://aws.amazon.com/certification/certified-security-specialty/</a>.</p>


            </article>

            
        </section>
    </body></html>