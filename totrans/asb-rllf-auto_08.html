<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-144"><a id="_idTextAnchor144"/>8</h1>
<h1 id="_idParaDest-145"><a id="_idTextAnchor145"/>Helping the Database Team with Automation</h1>
<p>Stateful applications, by definition, must save data persistently. So, when we talk about stateful applications, data will come into the picture, and hence, database servers. Choose any supported database software, depending on the type of data you want to store. This includes the number of transactions, the performance that’s required for your application, high availability and failover support, and many other factors. However, there are more important concerns, such as preparing the datastore, installing the necessary dependencies, packages or libraries. In terms of maintenance, this will be a continuous process as we need to take care of backups, data dumps, snapshots, and restoration in case of failure. </p>
<p>Ansible can help you in such situations. There are hundreds of Ansible database modules available that can help you implement your database automation tasks, including database installation, deployment, managing tables, managing users, and many other tasks.</p>
<p>In this chapter, we will cover the following topics: </p>
<ul>
<li>Ansible for database operations</li>
<li>Installing database servers </li>
<li>Creating and managing databases using Ansible</li>
<li>Automating PostgreSQL operations</li>
<li>Automating a password reset using ITSM and Ansible</li>
</ul>
<p>We will learn how to install the PostgreSQL database servers, create databases, configure database tables, user authentication, and more. You will also learn about the integration opportunities for zero-touch automation while using Ansible and <strong class="bold">IT Service Management</strong> (<strong class="bold">ITSM</strong>) tools.</p>
<h1 id="_idParaDest-146"><a id="_idTextAnchor146"/>Technical requirements</h1>
<p>The following are the technical requirements to proceed with this chapter. </p>
<ul>
<li>A Linux machine for the Ansible control node (with internet access)</li>
<li>A Linux machine for installing and configuring the PostgreSQL server</li>
<li>Basic knowledge about databases (PostgreSQL) and servers</li>
</ul>
<p>All the Ansible code, playbooks, commands, and snippets for this chapter can be found in this book’s GitHub repository at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-08">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-08</a>.  </p>
<h1 id="_idParaDest-147"><a id="_idTextAnchor147"/>Ansible for database operations</h1>
<p>Database operations<a id="_idIndexMarker472"/> not only involve deploying database servers but also counting the day-to-day operations, such as managing databases, tables, database users, permissions or access. Ansible can talk to most of the well-known database services using the appropriate Ansible modules, as shown in the following diagram:</p>
<div><div><img alt="Figure 8.1 – Ansible database automation  " height="386" src="img/B18383_08_01.jpg" width="517"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.1 – Ansible database automation </p>
<p>Some of the most<a id="_idIndexMarker473"/> common database automation use cases are as follows:</p>
<ul>
<li>Deploying standalone database servers</li>
<li>Configure <strong class="bold">high availability</strong> (<strong class="bold">HA</strong>) database clusters</li>
<li>Creating databases and tables</li>
<li>Managing user accounts</li>
<li>Managing permissions</li>
<li>Managing database and server access</li>
<li>Backup and restore operations</li>
<li>Implementing data replication and mirroring </li>
<li>Automated database failovers</li>
</ul>
<p>With the help <a id="_idIndexMarker474"/>of Ansible database collections and modules, we can automate most of these operations. In the next section, you will learn how to install a PostgreSQL database server using Ansible. </p>
<p>Please refer to the <em class="italic">Further reading</em> section at the end of this chapter for more resources.</p>
<h1 id="_idParaDest-148"><a id="_idTextAnchor148"/>Installing database servers</h1>
<p>If you are a <a id="_idIndexMarker475"/>database administrator or if you know how database servers work, then you know the pain and struggle of managing and maintaining the services and data as per the application’s requirements. Since the introduction of virtualized and cloud-based platforms, provisioning virtual machines, disks, and other resources has become less of a headache. However, we still need automated options to provision database servers and database instances. There are single-click deployment solutions from <a id="_idIndexMarker476"/>public <strong class="bold">cloud service providers</strong> (<strong class="bold">CSPs</strong>) known<a id="_idIndexMarker477"/> as <strong class="bold">managed database solutions</strong> but in most cases, we do not have much control and transparency over such services if we have more strict requirements. Hence, organizations are forced to use self-hosted database servers and follow manual deployment and management processes. </p>
<p>In <a href="B18383_07.xhtml#_idTextAnchor125"><em class="italic">Chapter 7</em></a>, <em class="italic">Managing Your Virtualization and Cloud Platforms</em>, you learned how to automate infrastructure provisioning, including virtual machines and disks. In this chapter, we will explore how to automate database tasks, such as installing database servers, or provisioning databases or tables, as shown in the following diagram:</p>
<div><div><img alt="Figure 8.2 – Basic database operations " height="832" src="img/B18383_08_02.jpg" width="1108"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.2 – Basic database operations</p>
<p>Fortunately, Ansible<a id="_idIndexMarker478"/> has a good collection of modules and plugins for deploying and managing database servers such as Microsoft SQL, MySQL, PostgreSQL, InfluxDB, MongoDB, ProxySQL or Vertica. You will learn about the basics of Ansible-based database deployment in the following sections.</p>
<h2 id="_idParaDest-149"><a id="_idTextAnchor149"/>Installing PostgreSQL using Ansible</h2>
<p>Installing PostgreSQL is <a id="_idIndexMarker479"/>simple if you refer to the official documentation. However, you need to install all the dependencies and libraries that are required for PostgreSQL. You also need to configure the database server details. Fortunately, there are well-written Ansible roles available in Ansible Galaxy that we can download and use to install and configure PostgreSQL servers (and other database servers). The following screenshot shows us searching for the <code>postgresql</code> role in Ansible Galaxy:</p>
<div><div><img alt="Figure 8.3 – The postgresql role search in Ansible Galaxy " height="682" src="img/B18383_08_03.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.3 – The postgresql role search in Ansible Galaxy</p>
<p>In this <a id="_idIndexMarker480"/>exercise, you will install a simple standalone PostgreSQL server using the <code>geerlingguy.postgresql</code> Ansible role, which was contributed by community member <em class="italic">Jeff Geerling</em> (<a href="https://galaxy.ansible.com/geerlingguy/postgresql">https://galaxy.ansible.com/geerlingguy/postgresql</a>). Follow these steps:</p>
<ol>
<li>Make sure that your <code>ansible.cfg</code> file has been configured with project-specific roles and a collection page:</li>
</ol>
<div><div><img alt="Figure 8.4 - Configure ansible.cfg " height="219" src="img/B18383_08_04.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.4 - Configure ansible.cfg</p>
<ol>
<li value="2">Install the role using the <code>ansible-galaxy</code> command, as follows:</li>
</ol>
<div><div><img alt="Figure 8.5 – Installing an Ansible role using the ansible-galaxy command " height="273" src="img/B18383_08_05.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.5 – Installing an Ansible role using the ansible-galaxy command</p>
<ol>
<li value="3">Create<a id="_idIndexMarker481"/> a variable file called <code>Chapter-08/vars/postgres.yaml</code> so that you can pass some user details, the database to create, and <code>hba</code> entries to update the <code>geerlingguy.postgresql</code> role. The role will create the resources automatically based on the variables you are passing to the playbook. Skip this step if you do not wish to create such entries and configurations automatically:</li>
</ol>
<div><div><img alt="Figure 8.6 – Variables for PostgreSQL database " height="327" src="img/B18383_08_06.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.6 – Variables for PostgreSQL database</p>
<p class="callout-heading">Important Note</p>
<pre>postgresql_users</strong> have been specified in plain text for demonstration purposes. You should consider using encrypted passwords using Ansible Vault or other appropriate methods. </pre>
<ol>
<li value="4">Create the <code>Chapter-08/postgres-deploy.yaml</code> playbook, as follows:</li>
</ol>
<div><div><img alt="Figure 8.7 – Playbook to deploy PostgreSQL server " height="431" src="img/B18383_08_07.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.7 – Playbook to deploy PostgreSQL server</p>
<ol>
<li value="5">Add a<a id="_idIndexMarker482"/> task that allows remote connections for PostgreSQL and restart the PostgreSQL service. Finally, allow database port <code>5432</code> in the firewall, as shown in the following code snippet. Use other firewall service modules such as <code>community.general.ufw</code> if you are using a different firewall:</li>
</ol>
<div><div><img alt="Figure 8.8 – Tasks for opening the port and database service " height="724" src="img/B18383_08_08.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.8 – Tasks for opening the port and database service</p>
<ol>
<li value="6">Execute<a id="_idIndexMarker483"/> the playbook and deploy the PostgreSQL server:</li>
</ol>
<div><div><img alt="Figure 8.9 – Execute Ansible playbook for PostgreSQL deployment " height="114" src="img/B18383_08_09.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.9 – Execute Ansible playbook for PostgreSQL deployment</p>
<ol>
<li value="7">Log in to the database server (<code>node1</code>) and verify the database server’s details by switching to the <code>postgres</code> user, as follows:</li>
</ol>
<div><div><img alt="Figure 8.10 – Logging in to the PostgreSQL database server " height="219" src="img/B18383_08_10.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.10 – Logging in to the PostgreSQL database server</p>
<ol>
<li value="8">Open the <code>psql</code> client as the <code>postgres</code> user, as follows:</li>
</ol>
<div><div><img alt="Figure 8.11 – Open psql client on the database server " height="219" src="img/B18383_08_11.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.11 – Open psql client on the database server</p>
<ol>
<li value="9">List the existing databases with the <code>\l</code> command and verify that <code>database_demo</code> was created (as per the variable configuration in the <code>vars/postgres.yaml</code> file):</li>
</ol>
<div><div><img alt="Figure 8.12 – Listing the existing databases in the psql command line " height="378" src="img/B18383_08_12.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.12 – Listing the existing databases in the psql command line</p>
<ol>
<li value="10">Verify <a id="_idIndexMarker484"/>the users list by using the <code>\du</code> command as follows:</li>
</ol>
<div><div><img alt="Figure 8.13 – Verifying users in the psql command line " height="248" src="img/B18383_08_13.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.13 – Verifying users in the psql command line</p>
<ol>
<li value="11">Exit the <code>psql</code> console by using the <em class="italic">Ctrl</em> + <em class="italic">D</em> keyboard shortcut or the <code>\q</code> command:</li>
</ol>
<div><div><img alt="Figure 8.14 – Exiting the psql console " height="141" src="img/B18383_08_14.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.14 – Exiting the psql console</p>
<ol>
<li value="12">Also, verify the <code>pg_hba.conf</code> file; the <code>geerlingguy.postgresql</code> role will configure this file based on the content of your variable. Check out the <code>/var/lib/pgsql/data/pg_hba.conf</code> file, as follows:</li>
</ol>
<div><div><img alt="Figure 8.15 – Verifying the /var/lib/pgsql/data/pg_hba.conf file " height="378" src="img/B18383_08_15.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.15 – Verifying the /var/lib/pgsql/data/pg_hba.conf file</p>
<p>If you want to access PostgreSQL from remote nodes, you need to make sure that the <code>pg_hba.conf</code> file entries have been configured appropriately. </p>
<p>It is a<a id="_idIndexMarker485"/> best practice to use existing Ansible roles so that you can save a lot of time and effort while developing your automation content. Also, you need to make sure that the Ansible role and its methods are suitable for your environment instead of blindly using them. </p>
<p>In the next section, you will learn how to update the password for the default <code>postgres</code> user.</p>
<h3>Configuring a password for a default postgres user</h3>
<p>The <a id="_idIndexMarker486"/>default user, <code>postgres</code>, is configured with no password and the default authentication <a id="_idIndexMarker487"/>method is <code>postgres</code> user (or the passwords for other admin users). Set or update the password for the <code>postgres</code> user as follows:</p>
<ol>
<li value="1">Switch to the <code>postgres</code> user:</li>
</ol>
<div><div><img alt="Figure 8.16 – Switch to postgres user and open psql cli " height="299" src="img/B18383_08_16.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.16 – Switch to postgres user and open psql cli</p>
<ol>
<li value="2">Change <a id="_idIndexMarker488"/>the password, exit the <code>psql</code> console and then exit the <code>postgres</code> user as follows:</li>
</ol>
<div><div><img alt="Figure 8.17 – Change the password and exit from the postgres account " height="353" src="img/B18383_08_17.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.17 – Change the password and exit from the postgres account</p>
<p>These steps can also be automated in your database installation playbook if required, though this depends on your organization’s requirements.</p>
<p>It is also possible to automate other database server installations using Ansible, such as Microsoft SQL Server. We will look at this in the next section.</p>
<h2 id="_idParaDest-150"><a id="_idTextAnchor150"/>Installing Microsoft SQL Server on Linux</h2>
<p>In 2016, Microsoft announced <a id="_idIndexMarker489"/>via their blog (refer to the following information box) that Microsoft SQL Server would run on Linux platforms. So, without a Windows server, you can install and use MSSQL databases, and the installation will support the most common Linux platforms, such as <strong class="bold">Red Hat Enterprise Linux</strong> (<strong class="bold">RHEL</strong>), <strong class="bold">SUSE Enterprise Linux Server</strong> (<strong class="bold">SLES</strong>), Ubuntu, and so on. </p>
<p>Installing <a id="_idIndexMarker490"/>MSSQL is pretty straightforward<a id="_idIndexMarker491"/> for Linux, but still, there are several <a id="_idIndexMarker492"/>steps involved in terms of configuration and services. When several database servers must be installed as part of the deployment, instead of configuring each manually, it is possible to use Ansible roles and playbooks to achieve this. Follow the steps as per documentation (refer to the following information box) or use any existing contributions from the community; for example, the role available at <a href="http://galaxy.ansible.com/microsoft/sql">galaxy.ansible.com/microsoft/sql</a> can be used to install MSSQL on Linux:</p>
<div><div><img alt="Figure 8.18 – Installing microsoft.sql collection " height="114" src="img/B18383_08_18.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.18 – Installing microsoft.sql collection</p>
<p>The <code>community.general.mssql_db</code> community module can be used to add or remove MSSQL databases, as follows:</p>
<div><div><img alt="Figure 8.19 – Creating Microsoft SQL database " height="194" src="img/B18383_08_19.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.19 – Creating Microsoft SQL database</p>
<p>Explore more automation content for MSSQL in Ansible Galaxy and use it based on your environment’s requirements. </p>
<p class="callout-heading">Announcing SQL Server on Linux</p>
<p class="callout">Microsoft’s announcement about SQL Server availability for Linux platforms can be found at <a href="https://blogs.microsoft.com/blog/2016/03/07/announcing-sql-server-on-linux/">https://blogs.microsoft.com/blog/2016/03/07/announcing-sql-server-on-linux/</a>. </p>
<p class="callout">Installation guidance for SQL Server on Linux can be found at <a href="https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-setup">https://docs.microsoft.com/en-us/sql/linux/sql-server-linux-setup</a>.</p>
<p>Once the <a id="_idIndexMarker493"/>database server has been installed and configured, automate additional tasks, such as creating a new database, creating new tables, adding users or permissions. Use the Ansible collections and modules that are available, such as <code>community.postgresql</code>, <code>community.mysql</code>, <code>community.cockroachdb</code>, <code>community.cassandra</code>, and more. We will learn about PostgreSQL database automation in the next section while using the <code>community.postgresql</code> Ansible collection.</p>
<h1 id="_idParaDest-151"><a id="_idTextAnchor151"/>Creating and managing databases using Ansible</h1>
<p>The community<a id="_idIndexMarker494"/> collection for PostgreSQL comes with more than 20 <a id="_idIndexMarker495"/>modules and a few plugins. It is possible to use these modules and plugins to automate PostgreSQL database operations, including creating, dropping, and updating databases, tables, users, and other resources in the database server.</p>
<h2 id="_idParaDest-152"><a id="_idTextAnchor152"/>Ansible community.postgresql prerequisites</h2>
<p>If you <a id="_idIndexMarker496"/>are accessing PostgreSQL from a remote node (for example, an Ansible control node), then you need to install the <code>psycopg2</code> Python library on this machine to use these PostgreSQL modules:</p>
<pre class="source-code">
$ pip install psycopg2</pre>
<p>In the next section, we will execute tasks from the database node itself (<code>node1</code>) using Ansible. This library is not required as the database server has already been configured with the required dependencies. </p>
<p>In the next section, you will learn how to manage database operations using Ansible and the <code>community.postgresql</code> collection.</p>
<h2 id="_idParaDest-153"><a id="_idTextAnchor153"/>Managing the database life cycle</h2>
<p>In this section, you<a id="_idIndexMarker497"/> will learn how to create a database, create tables inside the new database, and then configure users and permissions using Ansible. Follow these steps:</p>
<ol>
<li value="1">Create the <code>postgres-manage-database.yaml</code> playbook and add the variables that provide details about the database to be created, tables to be configured, users to be added, and so on. Remember to use Ansible Vault to encrypt sensitive items such as the username and password as follows:</li>
</ol>
<div><div><img alt="Figure 8.20 – Playbook to manage the database operations " height="431" src="img/B18383_08_20.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.20 – Playbook to manage the database operations</p>
<ol>
<li value="2">Add a task to create a new PostgreSQL database, as follows:</li>
</ol>
<div><div><img alt="Figure 8.21 – Task to create database " height="353" src="img/B18383_08_21.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.21 – Task to create database</p>
<ol>
<li value="3">Now, add another task to create the table with columns:</li>
</ol>
<div><div><img alt="Figure 8.22 – Task to create table inside the database " height="484" src="img/B18383_08_22.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.22 – Task to create table inside the database</p>
<ol>
<li value="4">Add one more <a id="_idIndexMarker498"/>task for creating users and grant access to the newly created database:</li>
</ol>
<div><div><img alt="Figure 8.23 – Task to create user and grant access to the database " height="512" src="img/B18383_08_23.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.23 – Task to create user and grant access to the database</p>
<ol>
<li value="5">Execute the playbook to create the database and other resources:</li>
</ol>
<div><div><img alt="Figure 8.24 – Execute playbook to create database, table and user " height="114" src="img/B18383_08_24.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.24 – Execute playbook to create database, table and user</p>
<ol>
<li value="6">Once the playbook has been created, verify the database and resources on the database <a id="_idIndexMarker499"/>server (for example, <code>node1</code>). </li>
<li>Log in to <code>node1</code>, switch to the <code>postgres</code> user and open the <code>psql</code> console. List the databases and you will see the <code>db_sales</code> database and the access privilege for <code>devteam</code>:</li>
</ol>
<div><div><img alt="Figure 8.25 – Log in to the database server and verify details " height="670" src="img/B18383_08_25.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.25 – Log in to the database server and verify details</p>
<ol>
<li value="8">Verify the user details in <code>psql</code>, as follows:</li>
</ol>
<div><div><img alt="Figure 8.26 – Listing and verifying the newly created user " height="272" src="img/B18383_08_26.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.26 – Listing and verifying the newly created user</p>
<ol>
<li value="9">Verify that <a id="_idIndexMarker500"/>the tables have been created as per the playbook.</li>
</ol>
<p>First, connect to the newly created database from the <code>psql</code> console using the <code>\c</code> command and then list the tables inside the database using the <code>\dt</code> command, as follows:</p>
<div><div><img alt="Figure 8.27 – Connecting to the newly created database and list tables " height="327" src="img/B18383_08_27.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.27 – Connecting to the newly created database and list tables</p>
<ol>
<li value="10">Ensure that the columns that you have created using the Ansible playbook are in the table, as shown here:</li>
</ol>
<div><div><img alt="Figure 8.28 – Database table details " height="458" src="img/B18383_08_28.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.28 – Database table details</p>
<ol>
<li value="11">Also verify <a id="_idIndexMarker501"/>access for the new user by using the <code>psql</code> console with the relevant username and password as follows:</li>
</ol>
<div><div><img alt="Figure 8.29 – Verifying new user access and the list tables " height="378" src="img/B18383_08_29.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.29 – Verifying new user access and the list tables</p>
<p>Expand the playbook with more details, such as the columns that are required for the tables, more users, permissions, and so on. Refer to the module’s documentation at <a href="https://docs.ansible.com/ansible/latest/collections/community/postgresql/">https://docs.ansible.com/ansible/latest/collections/community/postgresql/</a> for more details. </p>
<p>In the next section, you will learn more about database operations, such as how to manage remote access by automating <code>pg_hba</code> configurations, taking database dumps, and so on.</p>
<h1 id="_idParaDest-154"><a id="_idTextAnchor154"/>Automating PostgreSQL operations</h1>
<p>With the help <a id="_idIndexMarker502"/>of the modules in the <code>community.postgresql</code> collection, it is possible to automate more database maintenance and operations. Let’s take a closer look.</p>
<h2 id="_idParaDest-155"><a id="_idTextAnchor155"/>Managing PostgreSQL remote access</h2>
<p>Database servers <a id="_idIndexMarker503"/>are accessed by applications on remote nodes and this access needs to be configured appropriately and securely. For a test environment, allow wildcard entries (for example, <code>0.0.0.0/0</code>), but this is not a recommended practice for production servers. You need to configure the correct IP address or hostname to allow or restrict access to the database. This operation can be automated using the <code>community.postgresql.postgresql_pg_hba</code> module, as follows:</p>
<div><div><img alt="Figure 8.30 – Grant user access to database " height="327" src="img/B18383_08_30.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.30 – Grant user access to database</p>
<p>Managing the <code>pg_hba</code> entries using Ansible will allow you to handle the entire life cycle of the database and its access. </p>
<p>Next, we will learn how to take automated database backups.</p>
<h2 id="_idParaDest-156"><a id="_idTextAnchor156"/>Database backup and restore</h2>
<p>Taking <a id="_idIndexMarker504"/>database backups is critical for sensitive and important data. Use Ansible to automate this database dump and schedule daily, weekly, or monthly database backups:</p>
<div><div><img alt="Figure 8.31 – Database backup using Ansible " height="299" src="img/B18383_08_31.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.31 – Database backup using Ansible</p>
<p>The <a id="_idIndexMarker505"/>backup will be saved on the managed node. Customize the destination or automatically copy the backups to remote locations such as NFS volumes or cloud storage.</p>
<p>Similarly, we can automate the database restore operation as follows:</p>
<div><div><img alt="Figure 8.32 – Restore database from backup file " height="299" src="img/B18383_08_32.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.32 – Restore database from backup file</p>
<p>Notice <code>state: restore</code> in the preceding example. This instructs Ansible to perform a restore operation using the file or archive mentioned in the <code>target</code> parameter. The following screenshot shows the full playbook, which can perform backup or restore operations based on the <code>db_action</code> value:</p>
<div><div><img alt="Figure 8.33 – PostgreSQL database backup and restore playbook " height="933" src="img/B18383_08_33.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.33 – PostgreSQL database backup and restore playbook</p>
<p>Please<a id="_idIndexMarker506"/> refer to the <a href="https://docs.ansible.com/ansible/latest/collections/community/postgresql/postgresql_db_module.xhtml">https://docs.ansible.com/ansible/latest/collections/community/postgresql/postgresql_db_module.xhtml</a> documentation to learn more about the <code>community.postgresql.postgresql_db</code> module.</p>
<p class="callout-heading">Ansible PostgreSQL and MySQL Collection</p>
<p class="callout">Please refer to <a href="https://galaxy.ansible.com/community/postgresql">https://galaxy.ansible.com/community/postgresql</a> for the PostgreSQL community collection and <a href="https://docs.ansible.com/ansible/latest/collections/community/postgresql/">https://docs.ansible.com/ansible/latest/collections/community/postgresql/</a> for the documentation. Also, check out <a href="https://galaxy.ansible.com/community/mysql">https://galaxy.ansible.com/community/mysql</a> for the Ansible MySQL collection and modules.</p>
<p>In the next section, you will learn about automated database password reset request handling, which you can do using Ansible and your ITSM tool.</p>
<h1 id="_idParaDest-157"><a id="_idTextAnchor157"/>Automating a password reset using ITSM and Ansible</h1>
<p>With the help <a id="_idIndexMarker507"/>of ITSM tools and Red Hat Ansible Automation Platform (or community Ansible AWX), it is possible to implement zero-touch automation use cases such as database user password resets, database provisioning, and so on. Users will interact with the ITSM tool, and the tool will interact with Ansible Automation Platform to implement the task implementation, as shown in the following figure:</p>
<div><div><img alt="Figure 8.34 – ITSM and Ansible Automation Platform integration for database operations " height="488" src="img/B18383_08_34.jpg" width="862"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.34 – ITSM and Ansible Automation Platform integration for database operations</p>
<p>This <strong class="bold">programmatic automation</strong> is one <a id="_idIndexMarker508"/>of the best features of Ansible and helps organizations scale their automation landscape by integrating with existing tools and software.</p>
<p>Use customized forms or ticketing systems in the ITSM tool, as shown in the following screenshot:</p>
<div><div><img alt="Figure 8.35 – Jira ticket and its details " height="689" src="img/B18383_08_35.jpg" width="773"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.35 – Jira ticket and its details</p>
<p>The<a id="_idIndexMarker509"/> ITSM tool, such <a id="_idIndexMarker510"/>as Jira or ServiceNow, can also be configured with custom fields to collect information, such as the database server’s name, database name, username, and more, as shown in the following screenshot:</p>
<div><div><img alt="Figure 8.36 – Jira ticket with custom fields " height="301" src="img/B18383_08_36.jpg" width="752"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.36 – Jira ticket with custom fields</p>
<p>Automation <a id="_idIndexMarker511"/>will not skip your ITSM processes or procedures; the review and approvals will be in place before the task is executed, as shown in <em class="italic">Figure 8.34</em>.</p>
<p>Once the approval happens, the ITSM tool will send a notification containing data (such as the database hostname, database name, and username) to Ansible Automation Platform and trigger the automation job. We will look at this in more detail in the next section.</p>
<h2 id="_idParaDest-158"><a id="_idTextAnchor158"/>Ansible playbook for resetting passwords </h2>
<p>The <a id="_idIndexMarker512"/>Ansible playbook will be triggered from Ansible<a id="_idIndexMarker513"/> Automation Platform based on the Ansible job template and the input data from Jira. Collect the input data from Jira with the custom fields shown in the following screenshot (refer to <code>Chapter-08/postgres-password-reset.yaml</code> for more details):</p>
<div><div><img alt="Figure 8.37 – Collecting details from Jira in the playbook " height="538" src="img/B18383_08_37.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.37 – Collecting details from Jira in the playbook</p>
<p>The<a id="_idIndexMarker514"/> following task will set the new password for<a id="_idIndexMarker515"/> the user:</p>
<div><div><img alt="Figure 8.38 – A task for setting a new password " height="431" src="img/B18383_08_38.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.38 – A task for setting a new password</p>
<p>Once the password reset operation is successful, the following task will update the Jira ticket with the output of the password reset operation:</p>
<div><div><img alt="Figure 8.39 – Updating the Jira ticket using the community.general.jira module " height="405" src="img/B18383_08_39.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.39 – Updating the Jira ticket using the community.general.jira module</p>
<p>Expand<a id="_idIndexMarker516"/> the playbook by adding tasks that send the new <a id="_idIndexMarker517"/>password to the user via email using the <code>community.general.mail</code> module. Read more about Ansible Jira module from documentation (<a href="https://docs.ansible.com/ansible/latest/collections/community/general/jira_module.xhtml">https://docs.ansible.com/ansible/latest/collections/community/general/jira_module.xhtml</a>).</p>
<h1 id="_idParaDest-159"><a id="_idTextAnchor159"/>Summary</h1>
<p>In this chapter, you learned about how Ansible can help you install database servers and manage database operations such as creating databases, creating tables, assigning user permissions, taking database backups, and configuring <code>pg_hba</code>. You also learned about the integration opportunities that are provided by the ITSM tools for implementing zero-touch automation with Ansible Automation Platform. </p>
<p>In the next chapter, you will learn how to integrate Ansible with your DevOps practices for deployment, rolling updates, IaC provisioning, and more. </p>
<h1 id="_idParaDest-160"><a id="_idTextAnchor160"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, please visit the following links:</p>
<ul>
<li><em class="italic">How to send emails using Ansible and Gmail</em>: <a href="https://www.techbeatly.com/ansible-gmail">https://www.techbeatly.com/ansible-gmail</a> </li>
<li><em class="italic">Using Ansible to deploy Microsoft SQL Server 2019 on Red Hat Enterprise Linux 8</em>: <a href="https://www.redhat.com/sysadmin/mssql-linux-easy">https://www.redhat.com/sysadmin/mssql-linux-easy</a></li>
<li><em class="italic">Community.Postgresql collection</em>: <a href="https://docs.ansible.com/ansible/latest/collections/community/postgresql/index.xhtml">https://docs.ansible.com/ansible/latest/collections/community/postgresql/index.xhtml</a></li>
<li><em class="italic">Ansible Database modules: </em><a href="https://docs.ansible.com/ansible/2.9/modules/list_of_database_modules.xhtml">https://docs.ansible.com/ansible/2.9/modules/list_of_database_modules.xhtml</a></li>
<li><em class="italic">Automating IT Service Management with ServiceNow and Red Hat Ansible Automation Platform</em>: <a href="https://www.ansible.com/integrations/it-service-management/servicenow">https://www.ansible.com/integrations/it-service-management/servicenow</a></li>
<li><em class="italic">MongoDB Collection for Ansible</em>: <a href="https://galaxy.ansible.com/community/mongodb">https://galaxy.ansible.com/community/mongodb</a></li>
</ul>
</div>
<div><div></div>
</div>
</div></body></html>