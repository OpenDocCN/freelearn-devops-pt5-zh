<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Best Practices</h1>
                </header>
            
            <article>
                
<p>In this final chapter, we are going to review what we have learned so far and highlight some best practices. Some simple tips can help you set up things right from the start and s<span>ave you a lot of trouble down the road. Best practices will help you in administration and troubleshooting, as you'll be able to track things better and notice mistakes</span><span> </span><span>easier</span><span>. We'll add some security tips and how to avoid the most common mistakes. We are going to use <strong>infrastructure as code</strong> (<strong>IaC</strong>) as a tool that will help us in our daily tasks in Azure. Using Azure Portal is simple and great to learn things, but to use Azure to its full capacity, we must use ARM templates, Azure PowerShell, or Azure CLI. Finally, to expand IaC, we are going to discuss configuration as code and introduce </span><strong>Desired State Configuration</strong> (<strong>DSC</strong>) <span>and Azure Automation.</span></p>
<p>The following topics will be covered in this chapter:</p>
<ul>
<li>Azure best practices</li>
<li>Infrastructure as code</li>
<li>ARM templates</li>
<li>Azure PowerShell</li>
<li>Azure CLI</li>
<li>Configuration as code</li>
<li>Desired State Configuration</li>
<li>Azure Automation</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>For this chapter, you'll need the following:</p>
<ul>
<li>An Azure Subscription</li>
<li>PowerShell</li>
</ul>
<p class="mce-root"/>
<ul>
<li>Azure PowerShell</li>
<li>The Azure CLI</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure best practices</h1>
                </header>
            
            <article>
                
<p>There are a lot of small things that you need to pay attention to, otherwise you may end up having issues in <span>the </span>long run. When you're managing a single subscription and a small number of resources, it may look simple and not important to create some ground rules. But as <span>the </span>number of subscriptions and resources starts increasing, you may find chaos and it may be too late to turn back. In these situations, it's hard to correct mistakes and get back on <span>the </span>right path.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Naming convention</h1>
                </header>
            
            <article>
                
<p>It's very important to set <span>the </span>naming convention for subscriptions, resource groups, and resources. Your first subscription will probably have a name similar to <kbd>Pay-as-you-go</kbd>. And if you have a single subscription, it's not a big deal. But what if you end up with 5, 10, or 100 subscriptions, and all of them are named <kbd>Pay-as-you-go</kbd>? These subscriptions will have different subscription IDs and you can use this information to separate them, but it will be difficult and confusing. Subscriptions can be renamed and you should definitely use this option. You can organize subscriptions in different ways and it depends on your requirements regarding how you are going to do this. It can be based on departments, applications, environments, and so on.</p>
<p>For example, you can have multiple subscriptions per department. This will help you separate cost and consumption and see how much each department is spending on resources. In this case, you may want to rename subscriptions to something like <kbd>HumanResources</kbd>, <kbd>Finances</kbd>, <kbd>IT</kbd>, and so on. If you have different environments for each department for production, testing, and development, you can add <span>the </span>environment to <span>the </span>subscription name and have something like <kbd>HumanResources-prod</kbd>, <kbd>HumanResources-test</kbd>, and <kbd>HumanResources-dev</kbd>.</p>
<p>You can apply similar principles for naming resource groups, again depending on your requirements. Let's say we use a single subscription, and want to add <span>the </span>department, environment, or application to <span>the </span>resource group name. In this case, we'll have resource groups named like <kbd>IT-helpdesk-prod</kbd>. Or, if we have a subscription per department, <span>the </span>resource group would be named something like <kbd>helpdesk-prod</kbd>. </p>
<p class="mce-root"/>
<p class="mce-root"/>
<p><span>But, when you have multiple subscriptions and all of the subscriptions are listed in the resource group view, with some resources that have similar names, it can get confusing, and it's good idea to include the subscription name in the resource group name anyway. For example, you can have the subscriptions <kbd>Finance</kbd> and <kbd>HR</kbd>, and both of them have applications named <kbd>Employees</kbd>. If you name both resource groups using product and environment, both production resource groups will be named <kbd>Employees-prod</kbd>. They would be in different subscriptions, but when all resource groups in all subscriptions are listed, things can get confusing. </span>In this scenario, it can be beneficial to include <span>the </span>complete path in <span>the </span>resource group name that will include <span>the </span>subscription name as <span>the </span>front part of <span>the </span>resource group name.</p>
<p>For resources, it's good to have some kind of naming convention as well. Design can depend on different things, but I recommend using all available variables to avoid confusion. For example, let's say that our IT department has its own subscription and uses an application named <kbd>helpdesk</kbd>. The application requires two VMs (web and database server) and has production, development, and testing environments. In this case, we would have six VMs being used by <span>the </span>same application, for different purposes and environments. In cases like this, it's good to use parameters such as subscription, environment, product, resource type, and resource purpose. So, VM names for a production environment would be something like <kbd>it-helpdesk-prod-VM-web</kbd> and <span><kbd>it-helpdesk-prod-VM-db</kbd>. There is also a scenario where you have multiple VMs with the same role, such as multiple web servers behind a load balancer. In this scenario, it's good to add numbers to the name and have something like <kbd>it-helpdesk-prod-VM-web-01</kbd>, <kbd>it-helpdesk-prod-VM-web-02</kbd>, and so on.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Public endpoints</h1>
                </header>
            
            <article>
                
<p>It's generally a good idea to avoid exposing public endpoints if it's not required, especially when we talk about management and administration. Exposing <span>the </span>endpoint of your Web App is something you probably want to do, but why expose <span>the </span>database? It will only cause additional security risks and increase <span>the </span>chance of your data being breached. The same goes for management; exposing RDP, SSH, or any other port that can be used to manage and administrate your resources should be avoided. </p>
<p>In case we have a database in IaaS, <span>the </span>best practice is to allow access to <span>the </span>database over port <kbd>1433</kbd>, only inside Azure Vnet, or even limit access to a specific subnet. Use NSGs and <strong>Application Security Groups</strong> (<strong>ASGs</strong>) to set up access and allow access only when it's needed. For example, we can use an NSG and an ASG to set up access to a database, but only when traffic is coming from a specific subnet (use an NSG) and only when coming from a server that is part of <span>the </span>web server group (use an ASG). This isn't limited to port <kbd>1433</kbd> and MS SQL Server; you can apply this approach on any other database you are using in IaaS and whatever port these databases are using, such as 1521 for Oracle, 50000 for IBM DB2, 3306 for MySQL, or any custom port you define.</p>
<p>Databases in PaaS, the Azure SQL Database, and other database PaaS options, offer firewall protection. With firewall protection, you can limit <span>the </span>IP addresses from which you can connect to <span>the </span>database. Make sure that you keep <span>the </span>firewall up to date and remove any unnecessary IP addresses. Also, there is one option in <span>the </span>Azure SQL database firewall that may create additional risk. There is an option to <span class="packt_screen">Allow access to Azure services</span> to connect to your Azure SQL Database, as shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-877 image-border" src="Images/ad87b1d9-d2e4-4c47-a175-a0c731e23005.png" style="width:38.25em;height:15.25em;" width="459" height="183"/></p>
<p>This option is <span class="packt_screen">ON</span> by default and it may look like it makes sense to leave this enabled. Most people would think "Yeah, sure, I want my services in Azure to be able to connect to my database". But this option only checks whether a connection to <span>the </span>database is coming from Azure; it does not check whether the connection is coming from your subscription or even your tenant. Leaving this option <span class="packt_screen">ON</span> allows someone to create an Azure account and try to access your database, as firewall rules will not apply if <span>the </span>connection is coming from Azure.</p>
<p>Connecting to <span>the </span>database will still require <span>the </span>username and password, but this creates an opportunity. In this case, it's very good for us that Microsoft requires credit card information when creating a trial subscription as any account can be tracked to <span>the </span>owner. If someone managed to access <span>the </span>database, this way, <span>the </span>person can be tracked, but you may want to disable this option to prevent any unauthorized access in <span>the </span>first place.</p>
<p>A similar approach can be taken for other backend services that shouldn't be exposed publicly. These can be anything from databases, different connectors, and business logic, to various APIs. Don't expose anything that doesn't need to be exposed. In IaaS scenarios, use NSGs and ASGs to restrict access. When using PaaS, there are different approaches that can be taken. As we mentioned previously, an Azure SQL database has a firewall. For a Web App, we can use an isolated App Service Plan, that allows access only over an Azure Virtual network. Similar to this approach, most PaaS services can be connected to Azure VNet and we can set up access to services from inside our Azure Virtual Network. Then, NSG and ASG rules can be applied to these services as well.</p>
<p>Limiting access to the management ports of Azure VMs is another thing that we need to pay attention to. For example, exposing RDP access to your VM over the internet can have big consequences. I tested leaving the default RDP port open and tracked access attempts with Azure Security Center. Over a single month, there were over 150,000 unauthorized attempts to access <span>the </span>VM. Most of these attempts were using administrator, admin, sysadmin, and root (over 80% of attempts were using these four usernames) as a username, so it's a good thing that you are not allowed to use these names for your Azure VMs.</p>
<p>There are several ways you can restrict access to <span>the </span>management of Azure VMs:</p>
<ul>
<li>Disable public access for management ports and manage Azure VMs over secure connections. This can be P2S, S2S, or Azure ExpressRoute. By using a secure connection, you are limiting management access to authorized users from trusted locations.</li>
</ul>
<ul>
<li>If you cannot use a secure connection, restrict access to trusted public IP addresses. Use NSGs to limit access to Azure VMs that are to be accessed only from IP addresses that are pre-allowed. An example of how to restrict access with NSGs is shown in the following screenshot:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-878 image-border" src="Images/6b4def9e-8f07-42d7-ac6b-d4fd658bb60b.png" style="width:20.17em;height:47.33em;" width="268" height="629"/></p>
<p class="mce-root"/>
<ul>
<li>Use Just in Time Access for Azure VM access. Setting up Just in Time in Azure is simple and fast. When this option is enabled, you need to create a request for access from a predetermined IP address and only for a limited time. This way, access is blocked unless a specific request is created to allow management access. An example of a request to open an RDP port for single hour for user's current IP address is shown here:</li>
</ul>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-879 image-border" src="Images/c994724b-15a6-46bb-801e-e8f4d68a69de.png" style="width:61.42em;height:18.67em;" width="737" height="224"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Other things to consider</h1>
                </header>
            
            <article>
                
<p>Besides naming standards or endpoint security, there are a lot of little things we need to pay attention to:</p>
<ul>
<li>Use PaaS whenever possible. Microsoft Azure offers a number of options, but IaaS will, in general, be more expensive. There are cases where you have no option, but using PaaS will keep <span>the </span>cost of your subscription down.</li>
<li>Use monitoring and logging services. Each Azure Service has some sort of logging, monitoring, and alerting feature. Try expanding these services with services such as Azure Monitor, Azure Network Watcher, or Log Analytics. These tools can help you track issues and performance over time.</li>
<li>Use Azure Advisor to apply some best practices. Azure Advisor analyzes resources in a subscription, compares settings to best practices, and gives recommendations that need to be implemented to increase performance or cut cost.</li>
<li>Similar to Azure Advisor, Azure Security Center offers recommendations to increase <span>the </span>security of your resources. Security Center compares your current security settings and, in combination with security events, creates recommendations to increase security.</li>
</ul>
<ul>
<li>Encrypt data. Even though most Azure services have default encryption, that encryptions is at rest. To secure our data after export or backup, we need to apply additional encryption.</li>
<li>Encrypt connections and use HTTPS. Securing is pointless if data is exposed in transit, so we need to consider this as well.</li>
<li>Check Azure Service Health if you have issues. This can save you hours of troubleshooting. You will be able to notice performance issues or whether a service is unavailable, and automatically connect to Azure to see what is wrong. It can be an issue with Azure on <span>the </span>global or data center level, and it can save time checking if this is the case as <span>the </span>first step.</li>
<li>Configure auto scaling when possible. One of <span>the </span>advantages Azure offers is that you pay only for what you use. Auto scaling, if set up properly, will increase <span>the </span>size/number of instances when <span>the </span>workload increases, and decreases <span>the </span>size when <span>the </span>workload decreases. This can save a lot of money over time.</li>
<li>Use Azure Active Directory authentication whenever possible. Most services can be set up to use a different form of authentication or enable you to create local accounts only for that specific service. It's hard to audit or keep track of access in this case. Using AAD accounts will give you more insight and make tracking much easier.</li>
<li>Enable auditing on services. Some services, such as Azure SQL, have an audit feature built in. Enable this when possible or use Log Analytics to log everything.</li>
<li>Design for resiliency whenever possible. Having a redundant service can cost a lot of money and in some cases even double our cost. However, having a redundant service in another Azure data center can increase availability for your services. In case there is an issue with a service, regardless of whether it's an issue with your service or on <span>the </span>Azure data center level, you can failover to a redundant copy.</li>
<li>Always plan for failure. This isn't only an Azure or cloud-related best practice—planning for failure is an IT best practice. Try to predict different scenarios and what would happen if <span>the </span>service fails. Then, try to fix possible issues and prevent failure.</li>
<li>Try enabling multi-factor authentication. As this can increase cost, it ins't always possible, and <span>the </span>budget might prevent you from accomplishing this. In this case, enable MFA at least for administrators; MFA for administrators is free.</li>
<li>Install endpoint protection on Azure VMs. Endpoint protection will provide real-time protection and prevent malicious or unwanted software from being installed and potentially harming your system.</li>
</ul>
<p class="mce-root"/>
<ul>
<li>Install <span>the </span>latest patches for Azure <span>VMs</span>. Regular patch installation has a double effect: security patches will increase security and other updates can increase performance.</li>
<li>Analyze performance regularly. Having auto-scaling in place is sometimes not enough. Try to monitor <span>the </span>performance of your resources manually when possible. You can spot performance issues or you can see that some services are not utilized. You can make your service perform better and save money.</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Infrastructure as code</h1>
                </header>
            
            <article>
                
<p>IaC is a very important part in Azure best practices. Using Azure Portal is simple and excellent for creating a single resource and learning, but if we want to create complex environments, IaC is what we want to use. For example, for creating a single Azure <span>VM</span>, Azure Portal is a good choice. It takes 3-5 minutes to go through the New VM wizard and complete all of the steps. But what if we need to create new VMs on a daily basis or create tens or even hundreds of them? In this case, we would probably want to use some kind of automation to simplify our work, and this is exactly where <span>IaC</span> comes in. To work with Azure, we have a few options available:</p>
<ul>
<li>ARM templates</li>
<li>Azure PowerShell</li>
<li>Azure CLI</li>
</ul>
<p>We have already mentioned ARM templates. ARM templates are<span> JSON files that hold information about Azure resources and can be used for deployment (or editing/updating existing resources).</span></p>
<p>To answer what Azure PowerShell is, we need to answer what PowerShell is first. PowerShell is a task-based, command-line scripting language based on <span>the </span>.NET framework. It is used to automate tasks and manage operating systems and processes from the command line. Azure PowerShell is a PowerShell module that provides a set of <kbd>cmdlets</kbd> (commands) that allow us to manage Azure resources. </p>
<p>Azure CLI, or Azure <strong>command-line interface</strong> (<strong>CLI</strong>), is Microsoft's cross-platform command-line tool for managing Azure resources. It supports macOS, Linux, and Windows, and provides <span>the </span>same experience whatever platform you choose. The first version of Azure CLI 1.0 was also called X-Plat CLI and was written in JavaScript. It was initially created to support Azure Service Management APIs, and Azure Resource Management support was added later. Azure CLI 2.0 was built for ARM from <span>the </span>start and was written in Python.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing tools</h1>
                </header>
            
            <article>
                
<p>In this section, we'll be discussing various tools, via which you can begin different installations.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">ARM templates</h1>
                </header>
            
            <article>
                
<p>ARM templates don't really require anything, but you can use various tools to help you manage them. As they're JSON files, you can create one using any text editor, but it would be much easier to use an <strong>integrated development environment</strong> (<strong><span>IDE</span></strong>). My recommendation would be either Visual Studio or Visual Studio Code. Using Visual Studio or Visual Studio Code, you can connect to a repository and set up version control, which will allow you to track changes in templates over time. However, we can deploy with ARM templates, calling APIs or from Azure Portal without any additional tools.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure PowerShell</h1>
                </header>
            
            <article>
                
<p>To install Azure PowerShell, we need Windows PowerShell installed first. Luckily, in the client OS, it's already pre-installed on Windows 7 and newer, and for the server OS on Windows Server 2008 R2 and newer. So, all we are missing is the Azure PowerShell module. To install <span>the </span>Azure PowerShell module, we need to run PowerShell and execute the following:</p>
<pre><strong>Install-Module -Name AzureRM</strong></pre>
<p>You will receive a message that will ask you to install <span>the </span>module from <kbd>PSGallery</kbd>, so select <span class="packt_screen">Yes</span> or <span class="packt_screen">Yes to all</span>. After you install <span>the </span>module, we need to import it with this command:</p>
<pre><strong>Import-Module AzureRM</strong></pre>
<p>Finally, we can sign in with <span>the </span>following command:</p>
<pre><strong>Connect-AzureRmAccount</strong></pre>
<p>This will open a window where we need to input our credentials and authorize access to our subscription.</p>
<p>As a new version of Azure PowerShell is released every three weeks, you need to keep it updated. To install <span>the </span>latest version, we need to run this:</p>
<pre><strong>Update-Module -Name AzureRM</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure CLI</h1>
                </header>
            
            <article>
                
<p>Installing <span>the </span>Azure CLI depends on <span>the </span>platform that we're using.</p>
<p>For Windows, we need to download <span>the </span>installer from <a href="https://aka.ms/installazurecliwindows">https://aka.ms/installazurecliwindows</a> and simply run the installer like so:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-880 image-border" src="Images/5e231b61-4126-46b9-88fe-704152768cff.png" style="width:32.17em;height:25.17em;" width="491" height="384"/></p>
<p>To install it on macOS, we need to run this command:</p>
<pre><strong>brew update &amp;&amp; brew install azure-cli</strong></pre>
<p>Installing on Linux depends on <span>the </span>distribution. For example, on a distribution with <kbd>yum</kbd> (such as RHEL or CentOS), we need to run three commands. </p>
<p>First, we import <span>the </span>Microsoft repository key:</p>
<pre><strong>sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc</strong></pre>
<p>Second, we create <span>the </span>repository information:</p>
<pre><strong>sudo sh -c 'echo -e "[azure-cli]\nname=Azure CLI\nbaseurl=https://packages.microsoft.com/yumrepos/azure-cli\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" &gt; /etc/yum.repos.d/azure-cli.repo'</strong></pre>
<p>Finally, we run <span>the </span>installation:</p>
<pre><strong>sudo yum install azure-cli</strong></pre>
<p>Installation may depend on <span>the </span>platform, but after <span>the </span>installation process has completed, running Azure CLI commands is <span>the </span>same on all platforms. To log in to Azure with <span>the </span>Azure CLI, we need to run this:</p>
<pre><strong>az login</strong></pre>
<p>This will display a message (shown here) and open a new browser session, where you need to authorize access to Azure:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-881 image-border" src="Images/95a8cdc3-df3c-412b-871d-80c4325d6e16.png" style="width:80.92em;height:3.08em;" width="971" height="37"/></p>
<p>All commands in <span>the </span>Azure CLI start with <kbd>az</kbd>. To get more information, you can run this:</p>
<pre><strong>az --help</strong></pre>
<p>You will get <span>the </span>following output:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-882 image-border" src="Images/e25a2066-18b1-471b-a575-6ec89205302d.png" style="width:32.75em;height:48.50em;" width="605" height="895"/></p>
<p>You can combine <kbd>--help</kbd> with any of <span>the </span>commands in <span>the </span>list to get more information on a specific command.</p>
<p class="mce-root"/>
<p class="mce-root"/>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating Azure resources with IaC</h1>
                </header>
            
            <article>
                
<p>To better understand how ARM templates, Azure PowerShell, and <span>the </span>Azure CLI work, let's see a simple example and create an Azure Web App with each tool.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Web App with ARM templates</h1>
                </header>
            
            <article>
                
<p>With ARM templates, we need two JSON files. The first file defines what needs to be created and the second file contains parameters that are defined during deployment. So, basically, the first file holds information on what needs to be created (in our example, App Service Plan and Web App), and <span>the </span>second file holds information on where, the size of the service, name, and so on.</p>
<p>This is the template file:</p>
<div>
<pre>{<br/>"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",<br/>"contentVersion": "1.0.0.0",<br/>"parameters": {<br/>"webAppName": {<br/>"type": "string",<br/>"metadata": {<br/>"description": "Base name of the resource such as web app name and app service plan "<br/>},<br/>"minLength": 2<br/>},<br/>"sku":{<br/>"type": "string",<br/>"defaultValue" : "S1",<br/>"metadata": {<br/>"description": "The SKU of App Service Plan, by defaut is standard S1"<br/>}<br/>},<br/>"location": {<br/>"type": "string",<br/>"defaultValue": "[resourceGroup().location]",<br/>"metadata": {<br/>"description": "Location for all resources."<br/>}<br/>}<br/>},<br/>"variables": {<br/>"webAppPortalName": "[concat(parameters('webAppName'))]",<br/>"appServicePlanName": "[concat( parameters('webAppName'),'-AppServicePlan')]"<br/>},<br/>"resources": [<br/>{<br/>"apiVersion": "2017-08-01",<br/>"type": "Microsoft.Web/serverfarms",<br/>"kind": "app",<br/>"name": "[variables('appServicePlanName')]",<br/>"location": "[parameters('location')]",<br/>"comments": "This app service plan is used for the web app and slots.",<br/>"properties": {},<br/>"dependsOn": [],<br/>"sku": {<br/>"name": "[parameters('sku')]"<br/>}<br/>},<br/>{<br/>"apiVersion": "2016-08-01",<br/>"type": "Microsoft.Web/sites",<br/>"kind": "app",<br/>"name": "[variables('webAppPortalName')]",<br/>"location": "[parameters('location')]",<br/>"comments": "This is the web app, also the default 'nameless' slot.",<br/>"properties": {<br/>"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"<br/>},<br/>"dependsOn": [<br/>"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"<br/>]<br/>}<br/>]<br/>}</pre></div>
<p class="mce-root">This is the parameter file:</p>
<div>
<div>
<pre>{<br/>"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",<br/>"contentVersion": "1.0.0.0",<br/>"parameters": {<br/>"webAppName": {<br/>"value": "packt-demo-arm-webapp-01"<br/>},<br/>"sku": {<br/>"value": "S1"<br/>},<br/>"location": {<br/>"value": "[resourceGroup().location]"<br/>}<br/>}<br/>}</pre></div>
</div>
<p>Save both files. Now, let's create a resource group for deployment. Create a new empty <span class="packt_screen">Resource group</span> named <kbd>packt-demo-arm</kbd>. Open <span class="packt_screen">Template deployment</span> and select <span>the</span> <span class="packt_screen"><span>C</span>ustom template</span>. Under <span class="packt_screen">Edit template</span>, load <span>the </span>template file and under <span class="packt_screen">Edit parameter</span>, load <span>the </span>parameter file. Select <span class="packt_screen">Subscription</span> and <span class="packt_screen">Resource group</span> for <span class="packt_screen">packt-demo-arm</span> (if you didn't create it previously, you have <span>the </span>option to do so here). All other fields should be automatically loaded from <span>the </span>parameter file, like in this example (remember to accept <span class="packt_screen">TERMS AND CONDITIONS</span>):</p>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-883 image-border" src="Images/3e6578f2-bcab-420e-8b43-fed69c1d5a27.png" style="width:40.58em;height:35.25em;" width="862" height="749"/></div>
<p>After the deployment has completed, you should find <span>the </span>App Service Plan and Web App, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-884 image-border" src="Images/5584e403-7c23-45d4-8cf4-d1056e42a143.png" style="width:86.42em;height:5.67em;" width="1037" height="68"/></p>
<p>We can use this same ARM template to deploy new Web App simply by changing the resource name or tier in the parameter file; we don't have to go through the deployment wizard in Azure portal for each deployment. This can save a lot of time if we need to deploy multiple Web Apps.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Web App with Azure PowerShell</h1>
                </header>
            
            <article>
                
<p>To create <span>the </span>same resources with Azure PowerShell, we need to execute a single script that will create a resource group, App Service Plan, and Web App. The script starts with parameters and then executes three <kbd>cmdlets</kbd> to create everything we need for deployment. Make sure you are connected to Azure in Azure PowerShell:</p>
<pre>$ResourceGroupName = "packt-demo-ps"<br/>$webappname="packt-demo-ps-webapp-01"<br/>$location="West Europe"<br/>New-AzureRmResourceGroup -Name $ResourceGroupName -Location $location<br/>New-AzureRmAppServicePlan -Name $webappname -Location $location -ResourceGroupName $ResourceGroupName -Tier Free<br/>New-AzureRmWebApp -Name $webappname -Location $location -AppServicePlan $webappname -ResourceGroupName $ResourceGroupName</pre>
<p>After executing <span>the </span>script, you should receive <span>the </span>following output:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-885 image-border" src="Images/e5e3481e-421e-4c21-b799-57be416e4261.png" style="width:108.67em;height:49.92em;" width="1304" height="599"/></p>
<p>If we go to Azure Portal, we should find a new resource group and new items inside it:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-886 image-border" src="Images/566fe50b-925e-4ab6-9e26-9377e5f538cb.png" style="width:76.83em;height:5.75em;" width="922" height="69"/></p>
<p class="mce-root">To start a new deployment, we simply change <span>the </span>parameter values and execute again. We can quickly deploy multiple websites by just changing <span>the </span>name of <span>the W</span>eb App and deploying sites in <span>the </span>same resource group. For example, if I needed to deploy four instances of <span>the </span>same site in <span>the </span>same resource group, I could just change <span>the </span>value of <span><kbd>$webappname</kbd> and change the numbers at the end to <kbd>packt-demo-ps-webapp-01</kbd>, <kbd>packt-demo-ps-webapp-02</kbd>, <kbd>packt-demo-ps-webapp-03</kbd>, and <kbd>packt-demo-ps-webapp-04</kbd>. Instead of going through the wizard in Azure Portal each time, I can run the script by changing a single value.</span></p>
<p>To clean up deployment, you can execute a command that will delete <span>the </span>resource group, along with all <span>the </span>resources inside that resource group:</p>
<pre>$ResourceGroupName = "packt-demo-ps"<br/><br/>Remove-AzureRmResourceGroup -Name $ResourceGroupName -Force</pre>
<p>You should receive output like this, and can verify in Azure <span>Portal</span><span> </span>that <span>the </span>resource group doesn't exist anymore:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-887 image-border" src="Images/2c2ea79a-7ed5-4f07-8632-1ba7c45afd37.png" style="width:28.92em;height:3.08em;" width="467" height="50"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating an Azure Web App with Azure CLI</h1>
                </header>
            
            <article>
                
<p>Now, let's repeat <span>the </span>same process using <span>the </span>Azure CLI. You can see that <span>the </span>Azure CLI script structure is very similar to Azure PowerShell:</p>
<pre>$webappname='packt-demo-cli-webapp-01'<br/>$ResourceGroupName ='packt-demo-cli'<br/>az group create --location westeurope --name $ResourceGroupName<br/>az appservice plan create --name $webappname --resource-group $ResourceGroupName --sku Free<br/>az webapp create --name $webappname --resource-group $ResourceGroupName --plan $webappname</pre>
<p><span>After executing the script, you should receive a long output that ends like this:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-888 image-border" src="Images/080a717c-5546-41ce-989c-8ecf1965d8fc.png" style="width:104.08em;height:37.67em;" width="1249" height="452"/></p>
<p><span>If we go to Azure Portal, we should find the new resource group and new items inside it:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-889 image-border" src="Images/627e81ac-04f4-4da2-87ea-b29b8e4cce56.png" style="width:77.83em;height:5.75em;" width="934" height="69"/></p>
<p>Similar to Azure PowerShell, to deploy again, we just need to edit <span>the </span>parameter values. <span>To clean up deployment, you can execute a command that will delete the resource group, along with all the resources inside the resource group:</span></p>
<pre>$ResourceGroupName ='packt-demo-cli'<br/>az group delete --name $ResourceGroupName</pre>
<p><span>You should receive an output message that the command is completed and verify in Azure Portal that the resource group doesn't exist anymore.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Deploying multiple resources</h1>
                </header>
            
            <article>
                
<p>Each of these deployment methods can be used to deploy multiple resources in a single script. My personal favorite tool is definitely Azure PowerShell, but this is probably because of my system engineering background. I was using Windows PowerShell for years and find Azure PowerShell easiest to use. This doesn't mean that ARM templates or <span>the </span>Azure CLI are behind Azure PowerShell, and I think developers will find these other tools more familiar.</p>
<p>For an example on how to deploy multiple resources as simply as possible, I'll create an Azure PowerShell script that will deploy multiple websites in a single run. You can do similar things with other tools as well:</p>
<pre>$ResourceGroupName = "packt-demo-ps-multiple"<br/>$webappname="packt-demo-ps-webapp"<br/>$location="West Europe"<br/>$NumberOfWebApps= 4<br/><br/>New-AzureRmResourceGroup -Name $ResourceGroupName -Location $locationNew-AzureRmAppServicePlan -Name $webappname -Location $location -ResourceGroupName $ResourceGroupName -Tier Standard<br/><br/>$i=1<br/><br/>Do<br/><br/>{<br/><br/>New-AzureRmWebApp -Name $webappname'-0'$i -Location $location -AppServicePlan $webappname -ResourceGroupName $ResourceGroupName<br/><br/>} While (($i=$I+1) -le $NumberOfWebApps)</pre>
<p class="mce-root"/>
<p>In <span>the preceding </span>output, you'll receive a message for each resource created, and you can verify the deployment in Azure <span>Portal</span>. If <span>the </span>script executed successfully, you should see all of the resources, like this:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-890 image-border" src="Images/aed8c1d5-4af4-4e0c-b585-0d870d5f8dc0.png" style="width:77.58em;height:12.58em;" width="931" height="151"/></p>
<p>To clean up deployment, you can use <span>the </span>same command that we used previously:</p>
<pre>$ResourceGroupName = "packt-demo-ps-multiple"<br/>Remove-AzureRmResourceGroup -Name $ResourceGroupName -Force</pre>
<p>We can use a similar approach when deploying any type of resource in Azure; for example, we can deploy multiple Azure <span>VMs</span>. Let's execute a similar script, this time deploying two web servers:</p>
<pre>$ResourceGroupName = "packt-demo"<br/>$location = "westeurope"<br/>$vmName = "packtdemoVM"<br/>$NumberOfServers= 2<br/><br/>New-AzureRmResourceGroup -Name $ResourceGroupName -Location $location<br/><br/>$i=1<br/><br/>Do<br/><br/>{<br/><br/>New-AzureRmVm -ResourceGroupName $ResourceGroupName -Name $vmName"-0"$i -Location $location -VirtualNetworkName $vmName"-Vnet" -SubnetName $vmName"-subnet" -SecurityGroupName $vmName"-nsg" -PublicIpAddressName $vmName"-IP-"$i -OpenPorts 80,443,3389<br/><br/>} While (($i=$I+1) -le $NumberOfServers)</pre>
<p>The script should deploy one virtual network, one subnet, and one NSG. These resources will be shared between VMs. We don't want to create unnecessary resources as this will enable VMs to communicate. For each VM, we'll create an NIC and disk. An example of <span>the </span>resources created by <span>the </span>script for two servers is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-891 image-border" src="Images/7d201d90-3491-404c-bfea-afeb50f4a64f.png" style="width:78.00em;height:23.17em;" width="936" height="278"/></p>
<p>We can now edit this script to deploy more servers, deploy to a new resource group or a new subnet, or change any number of parameters to influence <span>the </span>deployment results. </p>
<p>So, using this script, I could deploy and number of servers, from 1 to 100, or even more. Now, imagine that you need to deploy 100 VMs in Azure <span>Portal</span><span> </span>with a wizard. Which task will take more time? I think we can recognize that using IaC for deployment has multiple benefits and can make our job <span>significantly</span><span> </span><span>easier.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Configuration as code</h1>
                </header>
            
            <article>
                
<p><span>IaC</span> is only <span>the </span>first step in automation. After we deploy our servers with code, we still need to configure them. Configuring servers manually will probably take more time than deploying them. Luckily, there is <span>the </span>option for configuration as code to complete <span>the </span>configuration steps as well. There are many different tools for configuration, but we are going to explore Azure Automation as <span>the </span>Azure-native <span>configuration as code</span> tool.</p>
<p>Azure Automation can be used for automating and scheduling different tasks. When talking about <span>configuration as code</span>, Azure Automation uses DSC. <span>DSC is a declarative management platform in PowerShell, used for the configuration, deployment, and management of systems.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Apply DSC with Azure Automation</h1>
                </header>
            
            <article>
                
<p>To create a new Azure Automation account, we need to provide <span>the</span> <span class="packt_screen"><span>N</span>ame</span> for <span>the </span>account, <span class="packt_screen">Subscription</span>, <span class="packt_screen">Resource group</span>, and <span class="packt_screen">Location</span>. Another option is to create <span class="packt_screen">Run-as-account</span>. <span class="packt_screen">Run-as-account</span> is a service principal that's used to authenticate to Azure when managing Azure resources through Azure Automation. I strongly recommend that you create this as it will be easier to manage with accounts in place. An example of creating an Azure Automation account is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-892 image-border" src="Images/4ad220f5-f44d-4858-9b8c-797494eda1de.png" style="width:17.42em;height:24.25em;" width="268" height="374"/></p>
<p>With Azure Automation, you can perform various operations, schedule and run scripts, manage your resources, and so on. It's important to mention that you can manage both Azure and on-premises resources, as well as resources in other clouds. Here, we are going to concentrate on applying DSC to Azure <span>VMs</span>.</p>
<p class="mce-root"/>
<p>Managing DSC in Azure Automation is done under <span class="packt_screen">State configuration (DSC)</span>. Here, we can manage <span class="packt_screen">Nodes</span>, <span class="packt_screen">Configurations</span>, and <span class="packt_screen">Compiled configurations</span>, and access the <span class="packt_screen">Gallery</span>. We are going to see each of these settings, except <span class="packt_screen">Gallery</span>. <span class="packt_screen">Gallery</span> contains a number of DSC scripts that you can use or edit, based on your requirements. An example of the <span class="packt_screen"><span>State configuration (DSC)</span></span> blade is shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-893 image-border" src="Images/9ecd6112-5b9f-4860-9c25-cdb3cec82479.png" style="width:90.25em;height:37.00em;" width="1083" height="444"/></p>
<p>DSC uses a script that is applied on selected nodes. <span class="packt_screen">Nodes</span> are VMs or groups of VMs. These VMs can be both Azure VMs or local VMs.</p>
<p>To start a new configuration, we need a DSC script. The script we are going to use ensures that <span>the </span>IIS role is installed on <span>the </span>server. Save <span>the </span>script locally and make sure that <span>the </span>name of <span>the </span>file is <span>the </span>same as <span>the </span>name of <span>the </span>configuration. In our case, <span>the </span>name should be <kbd>webserverDSC</kbd>:</p>
<pre>configuration webserverDSC {<br/>   Node WebServer {<br/>      WindowsFeature IIS {<br/>         Ensure = 'Present'<br/>         Name = 'Web-Server'<br/>         IncludeAllSubFeature = $true<br/>      }<br/>   }<br/>}</pre>
<p>Under <span class="packt_screen">Configurations</span>, select <span class="packt_screen">New configuration</span> and import <span>the </span>previously saved script:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-894 image-border" src="Images/a89046fd-d3fb-42ad-b8d6-fd17f73bf53e.png" style="width:18.17em;height:19.83em;" width="262" height="287"/></p>
<p>After <span>the </span>script has been imported, it needs to be compiled before we can proceed. Select <span>the </span>imported script and a new blade will open. Select <span class="packt_screen">Compile</span> and wait for <span>the </span>compile to finish. The compile time will depend on <span>the </span>size of <span>the </span>script, but in this case, it shouldn't take more than 2-3 minutes. An example of <span>the </span>configuration blade is as follows:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-895 image-border" src="Images/f495207a-a7ce-4e9d-8d6e-ed66d0e165e2.png" style="width:36.17em;height:16.92em;" width="513" height="240"/></p>
<p>After <span>the </span>script has compiled, we can proceed and apply configuration to <span>the </span>nodes. Under <span class="packt_screen">Nodes</span>, select <span class="packt_screen">New</span> and a new blade will open. In <span>the </span>list of VMs, we can select <span>the </span>VMs we want DSC to be applied to. I'm going to select <span>the </span>VM I created with <span>the </span>last script in this chapter, <span class="packt_screen">packtdemoVM-01</span>.</p>
<p>Under <span class="packt_screen">Registration</span>, we can select a few options. We can select which <span class="packt_screen">Registration key</span> will be used, <span class="packt_screen">Node configuration name</span>, <span class="packt_screen">Refresh frequency</span>, <span class="packt_screen">Configuration Mode Frequency</span>, <span class="packt_screen">Configuration Mode</span>, <span class="packt_screen">Allow Module Override</span> or <span class="packt_screen">Reboot Node if Needed</span>, and <span class="packt_screen">Action after Reboot</span>. I'm going to select the new configuration we just created and leave <span>the </span>rest of <span>the </span>settings as <span>the </span>defaults. An example of node registration is shown here:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-896 image-border" src="Images/55403cac-2702-4774-a648-6ed95e20288f.png" style="width:46.00em;height:36.25em;" width="552" height="435"/></p>
<p>After registration is complete, we need to wait for <span>the </span>initial check and for configuration to be applied to our server. This can take some time, depending on <span>the </span>frequency selected and <span>the </span>complexity of DSC we want to apply. If you monitor <span>the </span>node blade, <span>the </span>added node will go from pending to in progress, until it finally reaches compliant. An example of a node with configuration <span>applied</span><span> </span><span>is shown in the following screenshot:</span></p>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-897 image-border" src="Images/57663866-069f-470e-b864-3646abfe8776.png" style="width:80.83em;height:30.83em;" width="970" height="370"/></p>
<p>After <span>the </span>node becomes compliant, we can verify that <span>the </span>configuration is applied. Go to <span>the </span>VM blade that we used in node registration and locate <span>the </span>public IP address. Open <span>the </span>browser and try reaching <kbd>http://'youripaddress'</kbd>. You should get <span>the </span>default IIS page, which will confirm that IIS is installed on <span>the </span>server:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-898 image-border" src="Images/1bbd9f0d-f344-4909-b9ef-ab1f03d53e38.png" style="width:85.75em;height:52.33em;" width="1029" height="628"/></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>Microsoft Azure is a cloud with a lot of services and options. Combining these results in endless possibilities. We mentioned some of <span>the </span>best practices that can guide you to create productive and secure cloud environments. Based on these, you can expand and create your own rules and practices, depending on your services and requirements. </p>
<p>Although we have reached <span>the </span>end of this book, we have covered only a fraction of what Azure has to offer. Covering all of the available services would be just impossible in a single book, and if we wanted to provide a deep dive into each service, it would probably end up with a separate book for each service. This book was intended to provide you with an understanding of cloud design, cloud services, and best practices in <span>the </span>cloud, in order to give you a solid foundation of where you can start your cloud journey and build more, based on <span>the </span>knowledge gained here.</p>
<p>Learning Azure never stops, as new services and options are added daily. I've been using Azure for a long time and almost each time I open Azure <span>Portal</span>, I find something new. But, understanding new services is not an issue if you get a grasp on cloud patterns and best practices. If you understand <span>the </span>services you are currently using, understanding new features and services is not a problem and you will quickly find a way to use them to your advantage.</p>
<p>I hope you enjoyed this book and gained at least some knowledge from it! </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<ol>
<li>The name of <span>the </span>resource should contain...
<ol>
<li>As much information as possible</li>
<li>As little information as possible</li>
<li>Basic information</li>
</ol>
</li>
<li>Public endpoints should be...
<ol>
<li>Always exposed to internet access</li>
<li>Exposed to internet access only when needed</li>
<li>Never exposed to internet access</li>
</ol>
</li>
<li><span>To control management access to Azure VMs, you can use...</span>
<ol>
<li>NSGs</li>
<li>Just in Time access</li>
<li>Both</li>
</ol>
</li>
</ol>
<ol start="4">
<li>Multi-factor authentication is...
<ol>
<li>Free for all users</li>
<li>Free for administrators</li>
<li>Payed for all users</li>
<li>Payed for administrators</li>
</ol>
</li>
<li><span>IaC stands for...</span>
<ol>
<li>Infrastructure as code</li>
<li>Infrastructure as configuration</li>
<li>Information as code</li>
</ol>
</li>
<li>An ARM template is a...
<ol>
<li>Script</li>
<li>JSON file</li>
<li>TXT file</li>
</ol>
</li>
<li>The<span> Azure command-line tool is...</span>
<ol>
<li><span>Azure PowerShell</span></li>
<li>Azure CLI</li>
<li><span>Both</span></li>
</ol>
</li>
<li>With IaC, we can...
<ol>
<li>Deploy a single resource</li>
<li>Deploy multiple resources</li>
<li>Deploy only resources of <span>the </span>same type</li>
</ol>
</li>
<li>DSC stands for...
<ol>
<li>Desired State Configuration</li>
<li>Digital Signature Configuration </li>
<li>Desired Scaling Configuration</li>
</ol>
</li>
<li>The steps to apply DSC in Azure Automation are...
<ol>
<li>Import script, compile script, and register node</li>
<li>Register script, apply to node, and compile configuration</li>
<li>Register node, compile script, and apply configuration</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  </body></html>