<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Application Monitoring and Alerting Strategies</h1>
                </header>
            
            <article>
                
<p><span>In the previous chapter, we covered how to design effective messaging solutions, by covering the Azure Service Bus and Azure Queue Storage and combining different Azure resources in an effective messaging architecture. </span></p>
<p>In this chapter, <span>we are introducing the Design for Operations objective by covering application and platform monitoring and alerting strategies by giving an overview of the available solutions that Azure has to offer. By the end of this chapter, you should know when to use the different types of solutions when issues occur on the Azure platform in general and inside your custom solutions and configurations.</span></p>
<p>The following topics will be covered:</p>
<ul>
<li>Azure Log Analytics</li>
<li><span>Azure Monitor</span></li>
<li>Application Insights</li>
<li><span>Azure Service Health</span></li>
<li>Azure Advisor</li>
<li>Azure Network Watcher</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Log Analytics</h1>
                </header>
            
            <article>
                
<p>Azure Log Analytics is a service that collects and analyzes log files from various Azure resources and on-premises resources. It can collect all the data into a single workspace and offers a query language to query the data.</p>
<p>You can integrate various resources in Log Analytics, such as data from VMs, by installing an agent on Windows and Linux VMs, or you can connect to <span>System Center Operations Manager to collect telemetry from existing agents</span>. Most Azure resources are already integrated in Log Analytics. You only need to create a workspace from the Azure Portal to collect the data from them. You can then query the data from the workspace directly using the query language, or you can use analysis tools that can analyze the data. Some examples of analysis tools are <span>Operations Management Suite, Azure Security Center, and Application Insights. You can import the data in Power BI as well to create data visualizations.</span></p>
<p>When the data is collected, it is organized in data tables separated by the data type. It can collect data from the following resources:</p>
<ul>
<li>Data from Azure Monitor can be collected in Log Analytics and searched using the query language</li>
<li>Agents can be installed on Windows and Linux machines to send data to Log Analytics</li>
<li>A System Center Operations Manager management group can be connected to Log Analytics to collect data from agents</li>
<li>Application Insights and Azure Security Center use Log Analytics by default to store data</li>
<li>Log Analytics offers cmdlets that can be used from PowerShell and can be used in Azure Automation Runbooks</li>
<li>It offers a HTTP Data Collector API that can be leveraged in custom applications to send log data to Log Analytics</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a Log Analytics Workspace</h1>
                </header>
            
            <article>
                
<p>To create a Log Analytics Workspace, take the following steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening: <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Click on <span class="packt_screen">New</span><span> </span>and type in <kbd>Log Analytics</kbd> in the search bar. Create a new workspace.</li>
</ol>
<ol start="3">
<li>Enter the following settings and click on <span class="packt_screen">OK</span><span>:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/bb0fca00-56d9-42b7-8900-c4401b143cf5.jpg" style="width:22.25em;height:49.83em;" width="625" height="1397"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Creating a Log Analytics Workspace</div>
<ol start="4">
<li>The workspace has now been created.</li>
<li>You can now connect the Azure resources to the workspace. For example, pick the <span class="packt_screen">PacktPub</span> resource group, which was created in the first chapter, and open the settings in the Azure Portal. Click on <span class="packt_screen">Activity log </span>in <span>the left menu:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/aabb2921-72d9-4a9e-9f3e-fdfced5de687.jpg" style="width:60.25em;height:43.83em;" width="2275" height="1655"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Azure resource Group Overview blade</div>
<ol start="6">
<li>Click on <span class="packt_screen">Log Analytics</span> in the top menu, click on the <span class="packt_screen">Add</span> button, and select the workspace that was created in the previous steps and click on <span class="packt_screen">OK</span>:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/0f2a6fca-20f8-4c3f-8d89-cc4da29a5ccd.jpg" style="width:21.17em;height:47.67em;" width="621" height="1395"/><br/>
<br/>
Selecting workspace</div>
<ol start="7">
<li>Logging for this Resource Group is now sent to the Log Analytics Workspace.</li>
<li>When you navigate back to the Log Analytics Overview blade and click on <span class="packt_screen">View Designer</span><span>, a blade opens where you can create views for your data:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/154db2c1-12e5-48a4-96a4-9aa2248f0bf3.jpg" style="width:65.00em;height:47.75em;" width="2277" height="1673"/><br/>
<br/>
Log Analytics Designer</div>
<ol start="9">
<li>You can also click on the <span class="packt_screen">Analytics</span> button in the top menu, which will open the Log Analytics portal. Here, you can use predefined and create custom queries. In there, you can open a new tab and create a new query. You can add the following query to create a bar chart with the alert count by severity, per day (for the past 7 days):</li>
</ol>
<pre style="padding-left: 60px">Alert <br/>| where TimeGenerated &gt; ago(7d)<br/>| summarize count() by AlertSeverity, bin(TimeGenerated, 1d)<br/>| render barchart kind=unstacked</pre>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><span><img src="Images/f897036b-100b-450e-8e0f-46cfa69c7101.jpg" style="width:66.92em;height:44.58em;" width="2736" height="1824"/><br/>
<br/>
Query result in the Log Analytics Portal</span></span></div>
<ol start="10">
<li class="mce-root"><span>When you navigate back to the </span>Log Analytics Overview <span>blade in the Azure Portal and</span><span> click on</span> <span class="packt_screen">OMS Portal</span><span>, Microsoft Operations Management Suite should be open, where you can check all the logs and other activities as well:</span></li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/75084f7d-3fdc-4218-94ad-886397acd417.jpg" style="width:63.75em;height:35.50em;" width="2721" height="1517"/><br/>
<br/>
Microsoft Operations Management Suite</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Monitor</h1>
                </header>
            
            <article>
                
<p>Azure Monitor is a monitoring solution in the Azure Portal, which provides infrastructure <span>metrics and logs for mostly all services in Microsoft Azure. Not all Azure resources have been added to Azure Monitor by the time of writing this book, but in the future, more will be added. </span></p>
<p>Azure Monitor offers the following capabilities:</p>
<ul>
<li><strong>Activity Log</strong>: The activity log provides information about all types of events that are occurring inside an Azure Subscription. This can be activities such as stopping or starting VMs and maintenance activities. It offers different event categories, such as administrative, security, service health, autoscale, alerts, recommendations, policies, and resource health events. The events are stored for a retention period of 90 days. Queries can be saved and pinned to the Azure Dashboard, and they can be exported to a storage account for storing them for a larger period of time. They can also be exported to an Event Hub for real-time streaming or sent to Log Analytics as well.</li>
<li><strong>Diagnostic Settings</strong>: This provides information about events that happen inside a particular resource inside an Azure Subscription, for instance, an event for retrieving a secret from the Azure Key Vault. These events are not collected by default; they need to be enabled for the resources manually inside the Azure Portal, inside an ARM template when the resources are created, or using PowerShell or calling the REST API. These events can be stored inside a storage account or Event Hub <span>or sent to Log Analytics </span>as well, just like the events in the Activity log.</li>
<li><strong>Metrics</strong>: Metrics offers time-based metric points for your resources, just as performance counters in Windows Server. Metrics are available by default, and they have a retention period of 93 days. You can check the performance of an Azure resource and track the used and available credits, for instance. They can be sent to Event Hubs, Azure Stream Analytics, and you can retrieve and query data using the REST API and PowerShell.</li>
<li><strong>Alerts:</strong> The Alerts section offers a single place to view and manage all Azure alerts. It displays alerts coming from the Activity Log, Metrics, Application Insights, and Log Analytics. You can create Alert Rules, which can send out an email or SMS, Webhook, send data to a third-party IT Service Management application, or call an Automation Runbook.</li>
</ul>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><img src="Images/9672b0db-f5fe-4815-b4e6-3ec73b12c672.jpg" style="width:62.92em;height:45.83em;" width="2273" height="1655"/><br/>
<br/>
Azure Monitor Metrics</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Application Insights</h1>
                </header>
            
            <article>
                
<p>Application Insights offers a monitoring solution for cross-platform Apps that are hosted in Azure and for on-premises apps. It is aimed at developers and can be used in order to monitor the performance and detect issues, and it helps improve usability of your apps. It can be integrated in DevOps processes and development tools, such as Visual Studio.</p>
<p>Developers can set up an Application Insights Resource inside Azure and install a package inside their application. This can be an Azure application or an on-premises application; they can both connect to the resource in Azure. This package is responsible for sending telemetry data to Azure. You can add performance counters, Docker logs, and diagnostic logs as well. </p>
<p>It collects the following types of application events:</p>
<ul>
<li><strong>Rate data</strong>: Different types of rate data can be sent to Application Insights, such as request and dependency rates and response times and user session counts. </li>
<li><strong>Exceptions</strong>: Exceptions that occur inside an application can be sent to Application Insights.</li>
<li><strong>Page views and performance</strong>: It can give information about page views and load performance of the application. </li>
<li><strong>Diagnostic Logs</strong>: This sends Docker Host diagnostic information to <span>Application Insights and trace logging from applications.</span></li>
<li><strong>AJAX calls</strong>: This is the performance of AJAX calls and failed requests and response time.</li>
<li><strong>Custom Events</strong>: You can create custom events in your applications as well.</li>
<li><strong>Integration</strong>: It can integrate with <span>Visual Studio App Center and HockeyApp to analyze telemetry data from mobile applications as well.</span></li>
</ul>
<p>Once the data is sent to Azure, it can be viewed in the Azure Portal. The Azure Portal offers different capabilities to display and analyze the data. It offers an <span class="packt_screen">Application map</span> blade, a <span class="packt_screen">Live Metrics Stream</span>, <span class="packt_screen">Metrics Explorer</span> blades, a <span class="packt_screen">Performance</span> blade, and more:</p>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><img src="Images/0f0495d9-7d4f-4718-8c76-7c559ed73d0c.jpg" style="width:65.92em;height:40.08em;" width="2275" height="1383"/><br/>
<br/>
Application Insights in the Azure Portal</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Service Health</h1>
                </header>
            
            <article>
                
<p>Azure Service Health offers a dashboard in the Azure Portal where issues regarding the different Azure resources are displayed. This can give you insights about maintenance schedules, which are platform issues that can effect the availability of the resources in Azure.</p>
<p>It offers the following views from the Azure Portal:</p>
<ul>
<li><strong>Service Issues</strong>: This provides an overview of all the global issues on Azure that currently occur in all the different Azure Regions. It also offers a health history where you can review or download summaries of historical events.</li>
<li><strong>Planned Maintenance</strong>: This provides an overview of all the maintenance events that are scheduled.</li>
<li><strong>Resource Health</strong>: An overview of the current and historical health of the different resources inside the Azure Subscription. When you are having issues, you can run a troubleshoot tool from there as well.</li>
<li><strong>Health Alerts</strong>: You can create Health Alerts from there as well so that you are notified when maintenance activities are scheduled and service issues occur.</li>
</ul>
<div class="CDPAlignCenter CDPAlign packt_figref"><span><img src="Images/91103956-2fef-4626-80f1-febd52981499.jpg" style="width:66.42em;height:29.83em;" width="2281" height="1024"/><br/>
<br/>
Azure Service Health in the Azure Portal</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Advisor</h1>
                </header>
            
            <article>
                
<p>Azure Advisor is a tool that helps you follow best practices for deployments in Azure. It analyzes the current configuration of all the Azure resources, and based on that, it can make recommendations about them. For most recommendations, you can address them from inside the Azure Advisor portal directly.</p>
<p>It offers the following categories:</p>
<ul>
<li><span><strong>High Availability</strong>: This provides several recommendations to improve the continuity of your applications and other Azure resources, such as enabling backups and creating Availability Sets.</span></li>
<li><span><span><strong>Security</strong>: This provides recommendations to improve security of Azure resources. It integrates with Azure Security Center.</span></span></li>
<li><span><strong>Performance</strong>: This provides recommendations for the overall performance of the different Azure resources, such as database performance and App Service performance. </span></li>
<li><strong>Costs</strong>: This section provides <span>recommendations</span><span> for being more cost-effective, such as resizing or shutting down virtual machines, or reducing costs by eliminating unprovisioned ExpressRoute circuits.</span></li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Address Recommendation from Azure Advisor</h1>
                </header>
            
            <article>
                
<p>To address a recommendation from Azure Advisor directly, take the following steps:</p>
<ol>
<li>Navigate to the Azure Portal by opening: <a href="https://portal.azure.com/">https://portal.azure.com/</a>.</li>
<li>Select <span class="packt_screen">Azure Advisor</span> from the left menu.</li>
</ol>
<p> </p>
<ol start="3">
<li>You get an overview of all the different recommendations, categorized into four sections:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1034 image-border" src="Images/a32c2f02-7d08-449e-a3fb-eb229a4158e9.png" style="width:61.33em;height:45.25em;" width="1688" height="1131"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Azure Advisor overview</div>
<ol start="4">
<li><span>These recommendations are based on all the different services that we've created for this book. So, if you have followed along, your recommendations will be the same. </span>For this example, we select the <span class="packt_screen">Security</span> section and then <span class="packt_screen">Follow Security Center Recommendations</span>. Pick a high severity recommendation:</li>
</ol>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref"><img src="Images/78ba0198-b7a2-4f87-a507-a93ad1a8dde9.jpg" style="width:61.00em;height:37.58em;" width="1701" height="1049"/></div>
<div style="color: black" class="CDPAlignCenter CDPAlign packt_figref">Security recommendations</div>
<ol start="5">
<li class="mce-root"><span>A new blade opens where you can select the database. Here, you can enable </span><span class="packt_screen">Auditing &amp; Thread Detection</span> <span><span>for the selected database directly.</span></span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1037 image-border" src="Images/8105acec-bced-432f-835e-415bb7f792b0.png" style="width:65.08em;height:26.25em;" width="1628" height="605"/></div>
<div class="mce-root CDPAlignCenter CDPAlign packt_figref"><span>Auditing &amp; Thread Detection settings</span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Azure Network Watcher</h1>
                </header>
            
            <article>
                
<p>Azure Network Watcher offers a network monitoring solution on the Azure resources level for all network communication. This includes VNets, ExpressRoute circuits, Application Gateway traffic, Load Balancers, and more. It can be accessed from the Azure Portal and offers monitoring tools, diagnostic tools, and logs from the network level. </p>
<p>It offers the following capabilities:</p>
<ul>
<li><strong>Topology</strong>: This provides an overview of all the network resources in a VNet by offering a Graph. From the Azure Portal, it provides a subset of all the network parts. To view a full list of the resources, you can use PowerShell or the REST API.</li>
<li><strong>IP flow verify</strong>: This offers an overview of allowed or denied packages for a network interface of a virtual machine. This helps administrators to solve connectivity issues quickly.</li>
<li><strong>Next Hop</strong>: This provides an overview of the destination routes of packages. This is useful for determining connectivity issues and checking whether packages arrive at the destination, such as to on-premises virtual machines.</li>
<li><strong>Security Group View</strong>: This provides an overview of all the configured NSGs and rules that are associated with it from two different levels, the network interface level, and the subnet level.</li>
<li><strong>VPN Diagnostics:</strong> This offers a troubleshooting solution for VPN gateways and connections. Connections and gateways can be called and return the result from the Azure Portal, <span>PowerShell, Azure CLI, or REST API.</span></li>
<li><strong>Packet Capture: </strong>You can capture network traffic packets to diagnose network anomalies. It requires an extension that needs to be installed on virtual machines to capture the data packages. Packages can be stored locally on the virtual machines or on Azure Blob Storage for further analysis.</li>
<li><strong>Connection Troubleshoot</strong>: This offers a troubleshooting solution that checks TCP connections from VMs to VMs, IPv4 addresses, URIs, and <span>fully qualified domain names (FQDNs). This helps with detecting connectivity issues by collecting all the configurations. It uses the same extension as the Packet Capture feature and connectivity can be checked from PowerShell, CLI, and the REST API as well. </span></li>
</ul>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><img src="Images/4ed8d16f-1601-4392-ae64-68b9c67ef37f.jpg" style="width:62.83em;height:38.92em;" width="2275" height="1408"/><br/></span></div>
<div class="packt_figref CDPAlignCenter CDPAlign"><span><span>Network Watcher Overview</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we've covered the different monitoring solutions Azure provides from a platform and application's perspective, such as Application Insights, Network Watcher, and Azure Log Analytics. </p>
<p>The next chapter will be the last chapter of this objective and the final chapter of this book, <a href="a2aa1d0a-4f06-46f9-9718-5b150e447326.xhtml" target="_blank">Chapter 15</a>, <em>Exploring Operations Automation Strategies</em>.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p><span>Answer the following questions to test your knowledge of the information in this chapter. You can find the answers in the <em>Assessments</em> section at the end of this book:</span></p>
<ol>
<li>You are designing an IoT Solution and want to provide a real-time monitoring tool for your administrators. Should you use Azure Log Analytics for this?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>Is Azure Network Watcher a separate application that needs to be installed on your computer?
<ol>
<li>Yes</li>
<li>No</li>
</ol>
</li>
<li>You want to get an overview of all the maintenance events that are scheduled for the Azure platform. Can you retrieve this information from <span>Azure Service Health?</span>
<ol>
<li>Yes</li>
<li>No </li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p><span>You can check the following links for more information about the topics that were covered in this chapter:</span></p>
<ul>
<li><strong>What is Azure Log Analytics?</strong>: <a href="https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-overview">https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-overview</a></li>
<li><strong>Create custom views using View Designer in Log Analytics</strong>: <a href="https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-view-designer">https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-view-designer</a></li>
<li><strong>Azure Monitor Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/">https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/</a></li>
<li><strong>Overview of Azure Monitor</strong>: <a href="https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-azure-monitor">https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/monitoring-overview-azure-monitor</a></li>
<li><strong>Application Insights Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/application-insights/">https://docs.microsoft.com/en-us/azure/application-insights/</a></li>
<li><strong>Azure Service Health Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/service-health/">https://docs.microsoft.com/en-us/azure/service-health/</a></li>
<li><strong>Introduction to Azure Advisor</strong>: <a href="https://docs.microsoft.com/en-us/azure/advisor/advisor-overview">https://docs.microsoft.com/en-us/azure/advisor/advisor-overview</a></li>
<li><strong>Azure Network Watcher Documentation</strong>: <a href="https://docs.microsoft.com/en-us/azure/network-watcher/">https://docs.microsoft.com/en-us/azure/network-watcher/</a></li>
</ul>


            </article>

            
        </section>
    </div>



  </body></html>