<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch13"/>Chapter 13. Database Access</h1></div></div></div><p>JIRA offers a lot of project reports to keep track of a project's progress, analyze trends over the past few months, and make decisions based on various statistics regarding time estimates, status, and workload. In most cases, these reports are enough to reach conclusions, but there are times when desirable information cannot be fetched from the existing JIRA reports. However, it's possible to generate complex reports directly from the database. In this chapter, we will discuss common databases that JIRA can use and the schemas these databases use. We will take a look at some reports that can only be generated by querying the database directly.</p><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">JIRA's database schema</li><li class="listitem" style="list-style-type: disc">Accessing <strong>MySQL</strong></li><li class="listitem" style="list-style-type: disc">Accessing <strong>PostgreSQL</strong></li><li class="listitem" style="list-style-type: disc">User table</li><li class="listitem" style="list-style-type: disc">The <code class="literal">jiraissue</code> table</li><li class="listitem" style="list-style-type: disc">The <code class="literal">customfield</code> table</li><li class="listitem" style="list-style-type: disc">The <code class="literal">customfieldvalue</code> table</li><li class="listitem" style="list-style-type: disc">Some useful SQL queries</li></ul></div><div><div><div><div><h1 class="title"><a id="ch13lvl1sec79"/>JIRA's database schema</h1></div></div></div><p>JIRA stores its configuration and data in a database; if you are evaluating JIRA, it's possible to use the embedded <strong>Hyper SQL Database</strong> (<strong>HSQLDB</strong>) written in Java. This is suitable for small applications, and JIRA uses it only in its evaluation version. HSQLDB is not recommended for production usage. For that, JIRA recommends MySQL or PostgreSQL.</p><p>No matter what type of database is used, the database schema that is, the tables and the relationship between them, is the same. If you want to take a look at the schema, you can refer to <code class="literal">JIRA_INSTALL/atlassian-jira/WEB-INF/classes/entitydefs/entitymodel.xml</code>.</p><p>The contents of the file are as displayed in the following screenshot:</p><p>
</p><div><img src="img/image_13_001.jpg" alt="JIRA's database schema"/></div><p>
</p><p>This is an XML file that contains the definition of all the tables in JIRA and their relationship with other tables.</p><p>Alternatively, you can also check the database schema on the Atlassian website, at <a class="ulink" href="https://developer.atlassian.com/display/JIRADEV/Database+Schema">https://developer.atlassian.com/display/JIRADEV/Database+Schema</a>.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec108"/>Accessing HSQLDB</h2></div></div></div><p>As previously mentioned, HSQLDB is used only for evaluation purposes and should not be used for production instances. You may, however, want to run queries to generate reports from the database. Luckily, HSQLDB comes with a built-in console that can be invoked by performing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Shut down your JIRA service.</li><li class="listitem">Use the following command to start the HSQLDB console:<pre class="programlisting">
<strong>    java -cp JIRA_INSTALL/lib/hsqldb-1.8.0.5.jar  &#13;
    org.hsqldb.util.DatabaseManager -&#13;
    user sa -url jdbc:hsqldb:JIRA_HOME/database/jiradb</strong>
</pre></li></ol></div><p>In the preceding command, replace <code class="literal">JIRA_INSTALL</code> and <code class="literal">JIRA_HOME</code> with the directory locations, as per your installation. If you have installed JIRA using the Windows installer, the following procedure should work.</p><p>First, navigate to the <code class="literal">C:\Program Files\Atlassian\Application Data\JIRA\database</code> directory.</p><p>Then, run the following command:</p><pre class="programlisting">
<strong>java -cp ../../../JIRA/lib/hsqldb-1.8.0.5.jar &#13;
org.hsqldb.util.DatabaseManager -&#13;
user sa -url jdbc:hsqldb:jiradb</strong>
</pre><p>The <strong>HSQL Database Manager</strong> will be displayed on your screen:</p><p>
</p><div><img src="img/image_13_002.jpg" alt="Accessing HSQLDB"/></div><p>
</p><p>You can now run SQL queries in the <strong>HSQL Database Manager</strong> and check the output in the same window.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec80"/>Accessing MySQL</h1></div></div></div><p>The <strong>HSQL Database Manager</strong> should never be used in the production instance because it's prone to data loss. The recommended database is either MySQL or PostgreSQL. Earlier in this book, we discussed how to create a database in MySQL to store JIRA's data and configure it during the setup phase. To access your database in order to run SQL queries, you can either use the MySQL console, which comes with the MySQL server, or you can use <strong>phpMyAdmin</strong>.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec109"/>phpMyAdmin</h2></div></div></div><p>The phpMyAdmin application can be downloaded from <a class="ulink" href="http://www.phpmyadmin.net/">http://www.phpmyadmin.net/</a>.</p><p>This is a great web-based tool to manage your MySQL database and it's usually accessed using <code class="literal">http://localhost/phpmyadmin/</code>. The exact URL can be different, depending on your installation.</p><p>Perform these following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the previous URL in your browser to launch <strong>phpMyAdmin</strong>:<p>
</p><div><img src="img/image_13_003.jpg" alt="phpMyAdmin"/></div><p>
</p><p>You will notice that the list of databases appears on the left-hand side. Our <code class="literal">jiradb</code> database also appears in this list. We created this database for our JIRA instance.</p></li><li class="listitem">Click on the plus (<strong>+</strong>) sign before the database name to expand the table for this database.</li><li class="listitem">You can click on any table to browse its content:<p>
</p><div><img src="img/image_13_004.jpg" alt="phpMyAdmin"/></div><p>
</p></li></ol></div><p>As you can see, we clicked on the <code class="literal">cwd_user</code> table and on the right-hand side, we have the list of users in our JIRA instance.</p><p>Similarly, you can browse any table you want in your JIRA instance. You should have some knowledge of JIRA's database schema to make sense out of this data. Also, if you want to generate complex reports that involve more than one table, you can write SQL queries as well.</p><div><ol class="orderedlist arabic"><li class="listitem">Click on the <strong>SQL</strong> tab in the top navigation bar:<p>
</p><div><img src="img/image_13_005.jpg" alt="phpMyAdmin"/></div><p>
</p></li><li class="listitem">To execute your query, perform the following steps:<div><ol class="orderedlist arabic"><li class="listitem">In the preceding screenshot, you can enter your SQL queries under <strong>Run SQL query/queries on database jiradb:</strong>.</li><li class="listitem">Click on the <strong>Go</strong> button to run the SQL query.</li></ol></div><p>
</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec110"/>The MySQL console</h2></div></div></div><p>When you install the MySQL server on your machine, it comes with the MySQL console. This console can also be used to manage your database. It's not very user-friendly compared to phpMyAdmin, but once you remember the basic commands, you will likely prefer the MySQL console for quick access to the database.</p><p>Run the following command to enter the MySQL console:</p><pre class="programlisting">
<strong>mysql -u USERNAME -p</strong>
</pre><p>In the preceding command, replace <code class="literal">USERNAME</code> with your username. In our case, it's <code class="literal">root</code>. The command will ask you to enter your password, after which you will enter the MySQL console:</p><p>
</p><div><img src="img/image_13_006.jpg" alt="The MySQL console"/></div><p>
</p><p>In the MySQL console, you can enter your commands and run queries.</p><p>Let's take a look at the structure of a few common JIRA tables and generate reports combining these multiple tables. For the following example queries, you may use either phpMyAdmin or the MySQL console, depending on your comfort level.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec81"/>Accessing PostgreSQL</h1></div></div></div><p>When you install PostgreSQL using the Windows installer, it comes with <strong>pgAdmin III</strong>, which is another tool for PostgreSQL's administration and management:</p><p>
</p><div><img src="img/image_13_007.jpg" alt="Accessing PostgreSQL"/></div><p>
</p><p>Let's take a look at some JIRA database tables that store useful information.</p></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec82"/>User table</h1></div></div></div><p>The <code class="literal">cwd_user</code> table is used to store a user in the system. Let's check the structure of this table.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec111"/>The table structure</h2></div></div></div><p>Run the following query:</p><pre class="programlisting">
<strong>desc cwd_user;</strong>
</pre><p>The output of the query is as follows:</p><p>
</p><div><img src="img/image_13_008.jpg" alt="The table structure"/></div><p>
</p></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec112"/>Finding the list of inactive JIRA users</h2></div></div></div><p>One of the main responsibilities of JIRA administrators is user management. Let's say you want to find the list of inactive users, along with their directory information. In big JIRA instances, it may be possible that there are users in JIRA's internal directory, as well as users from corporate LDAP.</p><p>The following query will return the list of inactive users in JIRA:</p><pre class="programlisting">
<strong>SELECT u.user_name,u.first_name,u.last_name,u.email_address,d.directory_name &#13;
from cwd_user u join cwd_directory d on u.directory_id = d.id where u.active &#13;
= 0;</strong>
</pre><p>The preceding query relies on another table, called <code class="literal">cwd_directory</code>. This directory stores the user directory information, whereas whether the user is active or not is stored in the <code class="literal">cwd_user</code> table under the <code class="literal">active</code> table field.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec83"/>The jiraissue table</h1></div></div></div><p>The <code class="literal">jiraissue</code> table is used to store JIRA issues. Let's check the structure of this table.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec113"/>The table structure</h2></div></div></div><p>Run the following query:</p><pre class="programlisting">
<strong>desc jiraissue;</strong>
</pre><p>The output of this query is as follows:</p><p>
</p><div><img src="img/image_13_009.jpg" alt="The table structure"/></div><p>
</p></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec114"/>Finding issues of a specific project</h2></div></div></div><p>It's quite easy to find the list of issues of a specific project using the JIRA <strong>Issue Navigator</strong>, but as we are exploring the database schema and its various tables, let's fetch the issues of a specific project directly from the database:</p><pre class="programlisting">
<strong>SELECT p.id AS project_id, p.pname AS project_name, CONCAT("SSP-&#13;
",ji.issuenum)  AS issue_id, ji.reporter AS issue_reporter FROM project p &#13;
LEFT OUTER JOIN jiraissue ji ON ji.project = p.id WHERE p.pkey = 'SSP' ORDER &#13;
BY ji.issuenum;</strong>
</pre><p>The preceding query will display the list of issues of the project with the <code class="literal">SSP</code> key. You can replace the project key with your own and try the previous query. The project name and a few other fields are fetched from the <code class="literal">project</code> table.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec84"/>The customfield table</h1></div></div></div><p>The <code class="literal">customfield</code> table is used to store all the custom fields. Let's check the structure of this table.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec115"/>The table structure</h2></div></div></div><p>Execute the following query:</p><pre class="programlisting">
<strong>desc customfield;</strong>
</pre><p>The output of the query is as follows:</p><p>
</p><div><img src="img/image_13_010.jpg" alt="The table structure"/></div><p>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec85"/>The customfieldvalue table</h1></div></div></div><p>The <code class="literal">customfieldvalue</code> table is used to store custom field values. Let's check the structure of this table.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec116"/>The table structure</h2></div></div></div><p>Run the following query:</p><pre class="programlisting">
<strong>desc customfieldvalue;</strong>
</pre><p>The output of the query is as follows:</p><p>
</p><div><img src="img/image_13_011.jpg" alt="The table structure"/></div><p>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec86"/>Some useful SQL queries</h1></div></div></div><p>We will list a few useful SQL queries that can help JIRA administrators quickly find the information they are looking for. It's important to mention that new versions of JIRA are released quite regularly, with new features and bug fixes. The database schema may change slightly in new versions. Therefore, verify your SQL queries on the new version of JIRA before using them.</p><div><div><div><div><h2 class="title"><a id="ch13lvl2sec117"/>List of shared filters</h2></div></div></div><p>The following SQL query will list the filters created in the JIRA instance that are shared with others:</p><pre class="programlisting">
<strong>SELECT sr.filtername, sr.authorname</strong>
<strong>FROM searchrequest sr</strong>
<strong>LEFT JOIN sharepermissions sp ON sp.entityid = sr.ID</strong>
<strong>WHERE sp.entitytype = "SearchRequest" AND sp.sharetype != "global";</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec118"/>Fetching users of a specific group</h2></div></div></div><p>It's quite easy to find users of a specific group from the JIRA interface, but you should know how to fetch this information using SQL. The following query will list the users of the <code class="literal">jira-software-users</code> group. You can change it to any group in your instance:</p><pre class="programlisting">
<strong>SELECT cu.user_name, cu.display_name, cu.email_address</strong>
<strong>FROM cwd_user AS cu</strong>
<strong>INNER JOIN cwd_membership AS cm</strong>
<strong>ON cu.directory_id=cm.directory_id</strong>
<strong>AND cu.lower_user_name=cm.lower_child_name</strong>
<strong>AND cm.membership_type='GROUP_USER'</strong>
<strong>WHERE cm.lower_parent_name='jira-software-users';</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec119"/>List of users with count of comments</h2></div></div></div><p>One of the main responsibilities of JIRA administrators is to find users that are either inactive or not using JIRA a lot in a given month. The next query will fetch the list of users, along with the number of comments they posted in a particular month. This will be useful in cases where it's necessary to find users who are active in system, but not performing much activity:</p><pre class="programlisting">
<strong>SELECT author, count(author) as comments </strong>
<strong>FROM jiraaction j</strong>
<strong>WHERE UPDATED &gt; "2014-12-01 00:00:00"</strong>
<strong>group by author </strong>
<strong>ORDER BY author ASC;</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec120"/>Fetching the count of issues per component</h2></div></div></div><p>Let's say you want to find the list of not only all the components in the system, but also the number of issues they are connected to. The following query will give you that information quickly:</p><pre class="programlisting">
<strong>SELECT count(ji.id), c.cname FROM jiraissue ji </strong>
<strong>INNER JOIN nodeassociation na ON ji.id = na.source_node_id</strong>
<strong>INNER JOIN component c ON na.sink_node_id = c.id</strong>
<strong>GROUP BY c.cname;</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec121"/>Listing projects of a specific project category</h2></div></div></div><p>If you want to retrieve the list of projects in a specific category, use the following query:</p><pre class="programlisting">
<strong>SELECT p.pname, p.LEAD, p.pkey</strong>
<strong>FROM project p</strong>
<strong>JOIN nodeassociation na ON (p.ID = na.SOURCE_NODE_ID AND na.ASSOCIATION_TYPE &#13;
= 'ProjectCategory')</strong>
<strong>JOIN projectcategory pc ON (na.SINK_NODE_ID = pc.ID)</strong>
<strong>WHERE pc.cname like 'Category';</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch13lvl2sec122"/>List of assignees or reporters in a particular project</h2></div></div></div><p>Sometimes you have to find the list of users who are involved in a particular project as either an assignee or as a reporter. This is particularly useful when you want to migrate a few projects from one instance to another and you also need to migrate the associated users:</p><pre class="programlisting">
<strong>SELECT DISTINCT reporter AS "User" FROM jiraissue WHERE project IN (</strong>
<strong>    SELECT id AS "Project ID" FROM project WHERE pkey IN ('SSP','SSPA')</strong>
<strong>)</strong>
<strong>UNION</strong>
<strong>SELECT DISTINCT assignee AS "User" FROM jiraissue WHERE project IN (</strong>
<strong>    SELECT id AS "Project ID" FROM project WHERE pkey IN ('SSP','SSPA')</strong>
<strong>)</strong>
</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch13lvl1sec87"/>Summary</h1></div></div></div><p>In this chapter, you learned how to retrieve information directly from the database. This is quite useful when information cannot easily be fetched from the JIRA interface. We discussed some common JIRA tables and looked at some example queries on how to find useful information. The ability to access the database directly empowers JIRA administrators to generate complex reports and seek information faster.</p><p>In the next chapter, you will learn how to customize the look and feel of JIRA by inserting custom CSS code. You will also learn to modify the behavior of the HTML elements of the JIRA interface using JavaScript. We will take a look at some examples to show/hide JIRA fields based on the user selection of a specific value of a select list, and to modify the values of text fields to insert text-based templates.</p></div></body></html>