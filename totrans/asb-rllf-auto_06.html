<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-105"><a id="_idTextAnchor105"/>6</h1>
<h1 id="_idParaDest-106"><a id="_idTextAnchor106"/>Automating Microsoft Windows and Network Devices</h1>
<p>Due to the complexity and wide variety of technologies, there are no one-size-fits-all tools in the information technology space. This is common for automation software as well but fortunately, Ansible can be used for most of your IT automation use cases because of the large community support and contributions from the vendors who provide these services, such as cloud platforms, network appliances, and software platforms. </p>
<p>When we talk about basic system automation, we know how easy it is to automate Linux machines using Ansible. However, we can do the same for Microsoft Windows machines as well. There are community collections and certified Content Collection for managing Microsoft Windows operations, such as user management, firewall, system management, package management, and registry configurations.</p>
<p>Similarly, we have thousands of modules available via different collections for managing network devices such as Cisco, FortiGate, Palo Alto, VyOS, F5, and CheckPoint. To become familiar with network automation, we will discuss the network connection methods and configurations for VyOS and Cisco ASA devices.</p>
<p>In this chapter, we will cover the following topics: </p>
<ul>
<li>Ansible remote connection methods </li>
<li>Automating Microsoft Windows servers using Ansible</li>
<li>Introduction to network automation</li>
<li>VyOS information gathering using Ansible</li>
<li>Creating ACL entries in a Cisco ASA device</li>
</ul>
<p>First, you will learn about the different connection methods available in Ansible. Then, you will learn how to configure and automate Microsoft Windows tasks using Ansible. Finally, you will learn about how to use Ansible for network automation.</p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor107"/>Technical requirements</h1>
<p>The following are the technical requirements for this chapter:</p>
<ul>
<li>A Linux machine for the Ansible control node</li>
<li>One or more Linux machines as managed nodes with Red Hat repositories configured (if you are using non-RHEL machines, then make sure you have the appropriate repositories configured to get packages and updates)</li>
<li>One or more Microsoft Windows machines (we used a Windows 2019 server)</li>
<li>One or more network devices/virtual appliances (for practicing this chapter’s network automation use case)</li>
<li>Basic administrative knowledge of Microsoft Windows machines, including user creation and package management</li>
<li>Basic administrative knowledge of network devices, including IP configuration and access configuration</li>
</ul>
<p>All the Ansible code, playbooks, commands, and snippets for this chapter can be found in this book’s GitHub repository at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-06">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-06</a>.  </p>
<h1 id="_idParaDest-108"><a id="_idTextAnchor108"/>Ansible remote connection methods</h1>
<p>By <a id="_idIndexMarker312"/>default, Ansible <a id="_idIndexMarker313"/>communicates with the remote machine using the SSH protocol (native OpenSSH), as you learned previously in this book. For remote nodes, which do not have SSH server options, it is possible to use other connection methods such as WinRM for Microsoft Windows remote machines or <strong class="bold">httpapi</strong> for <a id="_idIndexMarker314"/>API-based remote devices (such as Cisco NXAPI and Arista eAPI). </p>
<p>The following diagram shows the different connection methods used by Ansible for automating different devices and platforms:</p>
<div><div><img alt="Figure 6.1 – Connection methods used by Ansible " height="1008" src="img/B18383_06_01.jpg" width="1147"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.1 – Connection methods used by Ansible</p>
<p>You can <a id="_idIndexMarker315"/>find the <a id="_idIndexMarker316"/>available Ansible <code>ansible-doc</code> command, as follows:</p>
<div><div><img alt="Figure 6.2 – Ansible connection plugins " height="639" src="img/B18383_06_02.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.2 – Ansible connection plugins</p>
<p class="callout-heading">Ansible Inventory and Connection Parameters</p>
<p class="callout">Refer to <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.xhtml#connecting-to-hosts-behavioral-inventory-parameters">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.xhtml#connecting-to-hosts-behavioral-inventory-parameters</a> for specific <a id="_idIndexMarker317"/>connection parameters for connections such as SSH, Docker, and more.</p>
<p>The number <a id="_idIndexMarker318"/>of connection plugins on your Ansible control node <a id="_idIndexMarker319"/>will depend on the Ansible collections you are using as by default, Ansible only has a few connection options such as <code>ssh</code>, <code>winrm</code>, <code>local</code>, and so on. The remaining connection plugins come with the Ansible collections you have installed. </p>
<p>It is also possible to see details about the <code>ansible-doc</code> command, as follows:</p>
<div><div><img alt="Figure 6.3 – Docker connection plugin details " height="752" src="img/B18383_06_03.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.3 – Docker connection plugin details</p>
<p>In the <a id="_idIndexMarker320"/>preceding output, we <a id="_idIndexMarker321"/>can see details about the <code>community.docker.docker</code> connection plugin, including its usage. </p>
<p>You will learn more about Ansible connection variables and the available options in the next section.</p>
<h2 id="_idParaDest-109"><a id="_idTextAnchor109"/>Ansible connection variables</h2>
<p>It is possible to <a id="_idIndexMarker322"/>control the remote <a id="_idIndexMarker323"/>connection details using the Ansible inventory parameters and other variables. Refer to the documentation at <a href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.xhtml">https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.xhtml</a> to learn more about <a id="_idIndexMarker324"/>Ansible special variables. The following screenshot shows the inventory variables section. Here, different remote connection details are mentioned, such as <code>ansible_connection</code>, <code>ansible_port</code>, and <code>ansible_user</code>:</p>
<div><div><img alt="Figure 6.4 – Ansible inventory variable with special variables " height="327" src="img/B18383_06_04.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.4 – Ansible inventory variable with special variables</p>
<p>It is <a id="_idIndexMarker325"/>possible to<a id="_idIndexMarker326"/> configure different values and variables, as follows: </p>
<ul>
<li><code>ansible_connection</code>: This specifies the connection type to use, such as <code>ssh</code>, <code>local</code> (for <code>localhost</code> nodes), <code>winrm</code>, or <code>docker</code>:<pre># inventory
[local]
localhost ansible_connection=local
[web]
node1 
[windows]
Win2019 ansible_connection: “winrm”</pre></li>
<li><code>ansible_host</code>: The actual name or IP address of the remote node if it is different from the inventory name.</li>
<li><code>ansible_user</code>: The user account to be used for remote node authentication.</li>
<li><code>ansible_password</code>: The password for <code>ansible_user</code> to authenticate. Note that keeping <code>ansible_password</code> in plain text is not a best practice; you should consider keeping it encrypted using Ansible Vault (refer to <a href="B18383_03.xhtml#_idTextAnchor052"><em class="italic">Chapter 3</em></a>, <em class="italic">Automating Your Daily Jobs</em>, the <em class="italic">Encrypting sensitive data using Ansible Vault</em> section and <a href="B18383_13.xhtml#_idTextAnchor241"><em class="italic">Chapter 13</em></a>, <em class="italic">Using Ansible for Secret Management</em>) or following authentication based on SSH keys (refer to <em class="italic">Chapter 1's</em>, <em class="italic">Configuring Your Managed Nodes section</em>).</li>
<li><code>ansible_port</code>: If the remote connection port is something other than <code>22</code> (the default SSH port), then <a id="_idIndexMarker327"/>specify the port number to use for the remote <a id="_idIndexMarker328"/>connection.</li>
</ul>
<p>In the next section, we will learn about the SSH connection parameters and how to configure it for managed nodes.</p>
<h2 id="_idParaDest-110"><a id="_idTextAnchor110"/>SSH connection parameters</h2>
<p>Additionally, there <a id="_idIndexMarker329"/>are SSH-specific variables such as <code>ansible_ssh_private_key_file</code> and <code>ansible_ssh_common_args</code> for assigning different<a id="_idIndexMarker330"/> SSH keys for different managed nodes if needed:</p>
<div><div><img alt="Figure 6.5 – Ansible SSH-specific variables " height="153" src="img/B18383_06_05.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.5 – Ansible SSH-specific variables</p>
<p>With that, you have learned about the Ansible connection methods and connection parameters that are available for controlling the connection. Now, let’s learn how to automate Microsoft Windows servers using Ansible.</p>
<h1 id="_idParaDest-111"><a id="_idTextAnchor111"/>Automating Microsoft Windows servers using Ansible</h1>
<p>As I mentioned earlier, Ansible is <a id="_idIndexMarker331"/>only available for <a id="_idIndexMarker332"/>Linux/Unix platforms, but that doesn’t mean you can’t use Ansible to automate Microsoft Windows machines. It is possible to use Ansible on a Linux/Unix machine (the Ansible control node) and automate your Microsoft Windows machines like so:</p>
<div><div><img alt="Figure 6.6 – Ansible and managed nodes " height="895" src="img/B18383_06_06.jpg" width="1121"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.6 – Ansible and managed nodes</p>
<p>Multiple<a id="_idIndexMarker333"/> Ansible <strong class="bold">Content Collections </strong>can be <a id="_idIndexMarker334"/>used for Microsoft Windows automation. Altogether, there are more than 100 Ansible modules available for automating Microsoft Windows tasks:</p>
<ul>
<li>Ansible modules for Microsoft Windows<a id="_idIndexMarker335"/> from the community (<a href="https://galaxy.ansible.com/community/windows">https://galaxy.ansible.com/community/windows</a>) contains 84 modules.</li>
<li>The Ansible Windows module from Red Hat (<a href="https://galaxy.ansible.com/ansible/windows">https://galaxy.ansible.com/ansible/windows</a>) contains<a id="_idIndexMarker336"/> 40 modules.</li>
</ul>
<p>In the next few sections, you will learn more about Ansible Windows automation, such as the supported Microsoft<a id="_idIndexMarker337"/> Windows versions, prerequisites, credential configuration, and inventory <a id="_idIndexMarker338"/>configurations. </p>
<p class="callout-heading">Ansible Windows Guides</p>
<p class="callout">The official Ansible <a id="_idIndexMarker339"/>documentation portal contains details on how to configure and set up Microsoft Windows machines to automate using Ansible. Refer to <a href="https://docs.ansible.com/ansible/latest/user_guide/windows.xhtml">https://docs.ansible.com/ansible/latest/user_guide/windows.xhtml</a> and <a href="https://www.techbeatly.com/ansible-windows">https://www.techbeatly.com/ansible-windows</a> for more details.</p>
<h2 id="_idParaDest-112"><a id="_idTextAnchor112"/>Supported Microsoft Windows operating systems</h2>
<p>Ansible can <a id="_idIndexMarker340"/>manage most general-purpose Microsoft Windows operating system versions, as follows:</p>
<ul>
<li>Microsoft Windows 7</li>
<li>Microsoft Windows 8.1</li>
<li>Microsoft Windows 10</li>
<li>Microsoft Windows Server 2008</li>
<li>Microsoft Windows Server2008 R2</li>
<li>Microsoft Windows Server 2012</li>
<li>Microsoft Windows Server 2012 R2</li>
<li>Microsoft Windows Server 2016</li>
<li>Microsoft <a id="_idIndexMarker341"/>Windows Server 2019</li>
</ul>
<h2 id="_idParaDest-113"><a id="_idTextAnchor113"/>Microsoft Windows automation – Ansible control node prerequisites</h2>
<p>There is no special <a id="_idIndexMarker342"/>requirement for an Ansible control node other than installing the Python <code>pywinrm</code> library, which can be installed as follows:</p>
<ol>
<li>If you are using a Python virtual environment, then remember to activate your virtual environment (skip this step otherwise):<pre>$ source ~/python-venv/ansible210/bin/activate</pre></li>
<li>Install the <code>pywinrm</code> library:<pre>$ python3 -m pip install --user --ignore-installed pywinrm</pre></li>
</ol>
<p>Make sure that you have installed the <code>pywinrm</code> library on the exact Python environment Ansible is using (check <code>ansible --version</code> and see which Python version it is using).</p>
<h2 id="_idParaDest-114"><a id="_idTextAnchor114"/>Microsoft Windows automation – managed node prerequisites</h2>
<p>The Microsoft Windows <a id="_idIndexMarker343"/>machine should be installed and configured with the following items:</p>
<ul>
<li>PowerShell 3.0 or newer (some of the Ansible modules for Microsoft Windows may require newer versions of PowerShell; refer to the module documentation you use).</li>
<li>.NET 4.0 or newer.</li>
<li>A <strong class="bold">WinRM</strong> listener<a id="_idIndexMarker344"/> should be created and activated – Ansible uses WinRM to connect to the Microsoft Windows machines by default. Microsoft Windows Remote Management is a SOAP-based remote management protocol that communicates over HTTP or HTTPS.</li>
<li>A Microsoft Windows firewall should be configured to allow traffic on <code>5985</code> (HTTP) and/or <code>5986</code> (HTTPS). If there is additional firewall or network traffic control between the Ansible control node and Microsoft Windows machines, then make<a id="_idIndexMarker345"/> sure the ports are allowed there too.</li>
</ul>
<h2 id="_idParaDest-115"><a id="_idTextAnchor115"/>Configuring the user account and WinRM on a Microsoft Windows machine</h2>
<p>In this exercise, you will <a id="_idIndexMarker346"/>configure a user and WinRM on the Microsoft Windows machine:</p>
<ol>
<li value="1">Log into the Microsoft Windows machine and create a new user called <code>ansible</code>. Use any method to create this user:</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">It is possible to use the default <code>Administrator</code> group membership to demonstrate automation without issues. Refer to the documentation at <a href="https://docs.microsoft.com/en-us/windows-server-essentials/manage/manage-user-accounts-in-windows-server-essentials">https://docs.microsoft.com/en-us/windows-server-essentials/manage/manage-user-accounts-in-windows-server-essentials</a> to learn more about how to manage user <a id="_idIndexMarker347"/>accounts in Windows Server.</p>
<div><div><img alt="Figure 6.7 – Creating a new user account on the Microsoft Windows server " height="514" src="img/B18383_06_07.jpg" width="658"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.7 – Creating a new user account on the Microsoft Windows server</p>
<ol>
<li value="2">Like <code>sudo</code> access <a id="_idIndexMarker348"/>in Linux, you need administrator rights for the Microsoft Windows user that you are using to connect from Ansible to the Microsoft Windows machine. Add the new <code>ansible</code> user to the <strong class="bold">Administrators</strong> group, as shown here:</li>
</ol>
<div><div><img alt="Figure 6.8 – Adding the Ansible user to the Administrators group " height="598" src="img/B18383_06_08.jpg" width="720"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.8 – Adding the Ansible user to the Administrators group</p>
<ol>
<li value="3">Verify the <a id="_idIndexMarker349"/>PowerShell version using the <code>(Get-Host).Version</code> command:</li>
</ol>
<div><div><img alt="Figure 6.9 – Checking the PowerShell version " height="241" src="img/B18383_06_09.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.9 – Checking the PowerShell version</p>
<ol>
<li value="4">The next step is to configure the WinRM listener and enable the WinRM service on the Microsoft Windows managed node. Instead of executing multiple commands on PowerShell, use the ready-to-use script available in the Ansible <code>ConfigureRemotingForAnsible.ps1</code> repository (<a href="https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1">https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1</a>). </li>
</ol>
<p>Download the script and execute it on the Microsoft <a id="_idIndexMarker350"/>Windows machine, as follows:</p>
<div><div><img alt="Figure 6.10 – Configuring WinRM on the Microsoft Windows machine using a script " height="496" src="img/B18383_06_10.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.10 – Configuring WinRM on the Microsoft Windows machine using a script</p>
<p>If your Microsoft Windows machine is in a disconnected environment, then download the script from some other machine and transfer it to the Microsoft Windows machine. </p>
<ol>
<li value="5">Verify the WinRM configuration using the <code>winrm e winrm/config/listener</code> command once the script has been executed successfully:</li>
</ol>
<div><div><img alt="Figure 6.11 – Verifying the WinRM configuration " height="683" src="img/B18383_06_11.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.11 – Verifying the WinRM configuration</p>
<ol>
<li value="6">Then <a id="_idIndexMarker351"/>verify the WinRM configuration using the <code>winrm get winrm/config</code> command.</li>
<li>Verify port access from the Ansible control node:</li>
</ol>
<div><div><img alt="Figure 6.12 – Verifying the Ansible to Microsoft Windows connection using WinRM " height="231" src="img/B18383_06_12.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.12 – Verifying the Ansible to Microsoft Windows connection using WinRM</p>
<p class="callout-heading">Configure Your Microsoft Windows Host to be Managed by Ansible</p>
<p class="callout">Refer to <a href="https://www.techbeatly.com/configure-your-windows-host-to-manage-by-ansible/">https://www.techbeatly.com/configure-your-windows-host-to-manage-by-ansible/</a> or <a href="https://docs.ansible.com/ansible/latest/user_guide/windows_winrm.xhtml">https://docs.ansible.com/ansible/latest/user_guide/windows_winrm.xhtml</a> for additional reading.</p>
<p>Now, the <a id="_idIndexMarker352"/>Microsoft Windows managed node is ready to connect using WinRM. Now, you need to configure these details on the Ansible side. In the next section, you will learn how to configure your Ansible inventory to connect to a Microsoft Windows managed node.</p>
<h2 id="_idParaDest-116"><a id="_idTextAnchor116"/>Configuring Ansible to access the Microsoft Windows machine</h2>
<p>In this exercise, you will <a id="_idIndexMarker353"/>configure the <a id="_idIndexMarker354"/>Ansible control node with Microsoft Windows user and other access details:</p>
<ol>
<li value="1">Create a host entry for Microsoft Windows in the Ansible inventory (replace the IP address as needed for your machine):<pre>[windows]
win2019 ansible_host=192.168.56.22</pre></li>
<li>Create a directory for Ansible group variables:<pre>[ansible@ansible Chapter-06]$ mkdir group_vars</pre></li>
<li>Add the <code>group_vars/windows</code> group variable file to configure <code>ansible_connection</code>, <code>ansible_port</code>, and user credentials. These are special variables; see the <code>ansible_</code> prefix for all of them (refer to the <a href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.xhtml">https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.xhtml</a> documentation to learn more about special variables):</li>
</ol>
<div><div><img alt="Figure 6.13 – Ansible group variable for Windows " height="329" src="img/B18383_06_13.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.13 – Ansible group variable for Windows</p>
<p><em class="italic">Note that it is not a best practice to use basic authentication using a username and password in critical environments. For production and critical environments, you are encouraged to use a password that’s been encrypted using Ansible Vault or keep credentials in Ansible Automation Controller (or Ansible Tower). Also, you may need to create a different user rather than an Administrator. You should also consider using SSL certificates and other secure methods to connect Microsoft Windows machines from the Ansible control node. </em></p>
<p class="callout-heading">Ansible Windows Management Using HTTPS and SSL</p>
<p class="callout">Consider using SSL<a id="_idIndexMarker355"/> certificates and other secure methods to connect Microsoft Windows machines from the Ansible control node (or Automation Controller). Refer to <a href="https://www.techbeatly.com/ansible-windows-management-using-https-and-ssl">https://www.techbeatly.com/ansible-windows-management-using-https-and-ssl</a> to learn more.</p>
<ol>
<li value="4">Verify the <a id="_idIndexMarker356"/>Ansible to <a id="_idIndexMarker357"/>Microsoft Windows machine connection:</li>
</ol>
<div><div><img alt="Figure 6.14 – Ansible to Microsoft Windows connection test using the win_ping module " height="241" src="img/B18383_06_14.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.14 – Ansible to Microsoft Windows connection test using the win_ping module</p>
<p>Like <a id="_idIndexMarker358"/>the <code>ping</code> module (for Linux machines), the <code>win_ping</code> module will establish a connection to the target <a id="_idIndexMarker359"/>machine and display the <code>pong</code> message if the connection is successful.</p>
<h2 id="_idParaDest-117"><a id="_idTextAnchor117"/>Microsoft Windows automation – using Ansible to create a Windows user</h2>
<p>In this exercise, you will create a <a id="_idIndexMarker360"/>new user in the Microsoft Windows machine using Ansible:</p>
<ol>
<li value="1">Create a new Ansible playbook called <code>Chapter-06/windows-create-user.yaml</code> and add the following details:</li>
</ol>
<div><div><img alt="Figure 6.15 – Ansible playbook to create a user in Microsoft Windows " height="513" src="img/B18383_06_15.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.15 – Ansible playbook to create a user in Microsoft Windows</p>
<ol>
<li value="2">Execute the Ansible playbook:</li>
</ol>
<div><div><img alt="Figure 6.16 – Executing the Ansible playbook to create a user in Microsoft Windows " height="143" src="img/B18383_06_16.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.16 – Executing the Ansible playbook to create a user in Microsoft Windows</p>
<p class="callout-heading">Inventory Nodes as Extra Variables</p>
<p class="callout">In the preceding playbook, we did not hardcode the <code>hosts</code> information. Instead, we passed the <code>windows</code> host group while executing the playbook. </p>
<ol>
<li value="3">Verify the<a id="_idIndexMarker361"/> Microsoft Windows machine to see if the user has been created or not:</li>
</ol>
<div><div><img alt="Figure 6.17 – New Windows user account created using Ansible " height="229" src="img/B18383_06_17.jpg" width="666"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.17 – New Windows user account created using Ansible</p>
<p>Find more Microsoft <a id="_idIndexMarker362"/>Windows automation use cases from your workplace, such as package deployment, group policy update, Active Directory operations, firewall management, service management, or even executing PowerShell scripts.</p>
<p class="callout-heading">Ansible for Windows Automation</p>
<p class="callout">Refer <a id="_idIndexMarker363"/>to <a href="https://www.ansible.com/for/windows">https://www.ansible.com/for/windows</a> to learn more about Ansible Windows automation. Visit <a href="https://aap2.demoredhat.com/exercises/ansible_windows">https://aap2.demoredhat.com/exercises/ansible_windows</a> to find workshops and practice sessions for Microsoft Windows automation using Ansible. </p>
<p>In the next section, you will learn the basics of network automation using Ansible.</p>
<h1 id="_idParaDest-118"><a id="_idTextAnchor118"/>Introduction to network automation</h1>
<p>Network automation <a id="_idIndexMarker364"/>using Ansible is based on different connection methods. There are some differences between Ansible network automation compared to Linux/Unix and Microsoft Windows automation. Also, note that Ansible can be used to automate the existing network automation tools such as Cisco ACI using the available <a id="_idIndexMarker365"/>Cisco ACI modules (<a href="https://docs.ansible.com/ansible/latest/scenario_guides/guide_aci.xhtml">https://docs.ansible.com/ansible/latest/scenario_guides/guide_aci.xhtml</a>).</p>
<h2 id="_idParaDest-119"><a id="_idTextAnchor119"/>Task execution on an Ansible control node</h2>
<p>Previously, you <a id="_idIndexMarker366"/>learned that Ansible is built on top of Python, so a remote node must be installed with Python to execute the automation tasks (Microsoft Windows modules are written in PowerShell and a <code>winrm</code> connection must be set to use PowerShell modules). Unlike Linux/Microsoft Windows nodes, many network devices do not have Python and cannot run Python scripts. Hence, the network automation modules are processed and executed in the Ansible control node; all actual commands will be executed on the target network devices.</p>
<h2 id="_idParaDest-120"><a id="_idTextAnchor120"/>Different connection methods</h2>
<p>Network task<a id="_idIndexMarker367"/> execution can support multiple communication methods, depending on the operating system of the network device and its version:</p>
<div><div><img alt="Figure 6.18 – Ansible network communication protocols (source: https://docs.ansible.com) " height="287" src="img/B18383_06_18.jpg" width="1314"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.18 – Ansible network communication protocols (source: <a href="https://docs.ansible.com">https://docs.ansible.com</a>)</p>
<p>You need to specify the appropriate method to use for the network device connection, the privilege escalation method (<code>become_method</code> such as <code>enable</code>), and the operating system of the network device, as shown in the following screenshot:</p>
<div><div><img alt="Figure 6.19 – Ansible network device inventory " height="623" src="img/B18383_06_19.jpg" width="1330"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.19 – Ansible network device inventory</p>
<p>In the preceding <a id="_idIndexMarker368"/>screenshot, we used the following:</p>
<ul>
<li><code>ansible_connection=ansible.netcommon.network_cli</code> to specify the connection plugin to use</li>
<li><code>ansible_become_method=enable</code> to use <code>enable</code> as the privilege escalation method</li>
<li><code>ansible_network_os=cisco.ios.ios</code> to indicate the network device operating system </li>
</ul>
<p class="callout-heading">Network Communication Protocols</p>
<p class="callout">Refer to <a href="https://docs.ansible.com/ansible/latest/network/getting_started/network_differences.xhtml#multiple-communication-protocols">https://docs.ansible.com/ansible/latest/network/getting_started/network_differences.xhtml#multiple-communication-protocols</a> for different communication protocols<a id="_idIndexMarker369"/> available for network automation using Ansible.</p>
<p>In the next section, you will learn how to create an Ansible playbook to gather information from a VyOS network device.</p>
<h1 id="_idParaDest-121"><a id="_idTextAnchor121"/>VyOS information gathering using Ansible</h1>
<p>This is an <a id="_idIndexMarker370"/>optional exercise for you to become familiar with <a id="_idIndexMarker371"/>network automation using Ansible. We assume that you have the basic knowledge to install and configure the <strong class="bold">VyOS</strong> appliance inside a virtual machine with your choice of virtualization platform.</p>
<p>Download the VyOS image<a id="_idIndexMarker372"/> from <a href="https://support.vyos.io/en/downloads">https://support.vyos.io/en/downloads</a> and install it as a virtual appliance (refer to the VyOS<a id="_idIndexMarker373"/> documentation at https://support.vyos.io/en/kb more for details).</p>
<p class="callout-heading">VyOS Network Operating System</p>
<p class="callout">VyOs<a id="_idIndexMarker374"/> is an open source network operating system based on Debian Linux. VyOS provides <a id="_idIndexMarker375"/>most networking functionalities, such as routing, <strong class="bold">Virtual Private Networks</strong> (<strong class="bold">VPNs</strong>), firewalls, <strong class="bold">Network Address Translation</strong> (<strong class="bold">NAT</strong>), and<a id="_idIndexMarker376"/> so on. Refer to <a href="https://vyos.io">https://vyos.io</a> for<a id="_idIndexMarker377"/> more details.</p>
<p>In the following exercise, you will create a simple Ansible playbook to collect the operating system information from a VyOS device (or virtual appliance):</p>
<ol>
<li value="1">Add the VyOS virtual machine details to the Ansible inventory:<pre>[ansible@ansible Chapter-06]$ mkdir inventories/
[ansible@ansible Chapter-06]$ cd inventories/</pre></li>
<li>Update the inventory as follows:</li>
</ol>
<div><div><img alt="Figure 6.20 – Updating the Ansible inventory with VyOS device information " height="407" src="img/B18383_06_20.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.20 – Updating the Ansible inventory with VyOS device information</p>
<ol>
<li value="3">Create a <a id="_idIndexMarker378"/>playbook called <code>Chapter-06/vyos-facts.yaml</code> to gather<a id="_idIndexMarker379"/> the VyOS facts:</li>
</ol>
<div><div><img alt="Figure 6.21 – Ansible playbook for collecting details from the VyOS device " height="513" src="img/B18383_06_21.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.21 – Ansible playbook for collecting details from the VyOS device</p>
<ol>
<li value="4">Execute the playbook, as follows:</li>
</ol>
<div><div><img alt="Figure 6.22 – VyOS fact-gathering playbook output " height="488" src="img/B18383_06_22.jpg" width="1209"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.22 – VyOS fact-gathering playbook output</p>
<ol>
<li value="5">Expand the <a id="_idIndexMarker380"/>playbook by collecting more<a id="_idIndexMarker381"/> facts and generating reports using the methods you learned about in <a href="B18383_03.xhtml#_idTextAnchor052"><em class="italic">Chapter 3</em></a>, <em class="italic">Automating Your Daily Jobs</em>.</li>
</ol>
<p>In the next section, you will learn about some more advanced network automation use cases by creating <strong class="bold">access control list</strong> (<strong class="bold">ACL</strong>) entries in a Cisco ASA device.</p>
<h1 id="_idParaDest-122"><a id="_idTextAnchor122"/>Creating ACL entries in a Cisco ASA device</h1>
<p>Cisco ASA<a id="_idIndexMarker382"/> is a security device with the capabilities of firewall, antivirus, intrusion prevention, and VPN. Refer<a id="_idIndexMarker383"/> to <a href="https://www.cisco.com/c/en/us/products/security/adaptive-security-appliance-asa-software/index.xhtml">https://www.cisco.com/c/en/us/products/security/adaptive-security-appliance-asa-software/index.xhtml</a> to learn more about Cisco ASA. </p>
<p>The Cisco ASA <a id="_idIndexMarker384"/>collection (<a href="https://galaxy.ansible.com/cisco/asa">https://galaxy.ansible.com/cisco/asa</a>) provides modules and plugins to automate Cisco ASA operations. In this section, you will learn how to use Cisco ASA modules to create ACL entries in a Cisco ASA device.</p>
<p>The first task is to install the <a id="_idIndexMarker385"/>Cisco ASA collection<a id="_idIndexMarker386"/> using the <code>ansible-galaxy</code> command, as follows:</p>
<pre class="source-code">
$ ansible-galaxy collection install cisco.asa</pre>
<p>Like you have configured the VyOS connection variables, you need to configure the Cisco ASA device connection variables, as follows:</p>
<div><div><img alt="Figure 6.23 – Cisco ASA inventory variables " height="385" src="img/B18383_06_23.jpg" width="1197"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.23 – Cisco ASA inventory variables</p>
<p>As usual, remember<a id="_idIndexMarker387"/> to encrypt the password using Ansible<a id="_idIndexMarker388"/> Vault (or a credential in Ansible Automation Controller) instead of keeping it as a plain text value inside the file. Also, notice the connection variables we have used for the Cisco ASA device, such as <code>ansible_network_os=cisco.asa.asa</code> and <code>ansible_connection=ansible.netcommon.network_cli</code>.</p>
<p>A typical ACL entry creation task includes multiple steps, as shown in the following diagram:</p>
<div><div><img alt="Figure 6.24 – ACL entry creation steps for Cisco ASA " height="871" src="img/B18383_06_24.jpg" width="1088"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.24 – ACL entry creation steps for Cisco ASA</p>
<p>Follow the<a id="_idIndexMarker389"/> standard pre-tasks and post-tasks as per the <a id="_idIndexMarker390"/>organization’s policies and procedures. It is a best practice to create Ansible roles based on specific operations, such as creating an object group, backup configuration, or creating an ACL entry. To make this easier to understand, I have used a single playbook for this demonstration, as follows:</p>
<div><div><img alt="Figure 6.25 – Cisco ACL playbook with variables " height="603" src="img/B18383_06_25.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.25 – Cisco ACL playbook with variables</p>
<p>In the actual <a id="_idIndexMarker391"/>environment, take those variables (shown in <em class="italic">Figure 6.25</em>) from the variable file in the repository (as a source of truth) or collect<a id="_idIndexMarker392"/> them using a Survey form in Ansible Automation Controller (or Ansible Tower).</p>
<p>Add the tasks to the playbook to implement the steps explained in <em class="italic">Figure 6.24</em>.</p>
<p>First, you must take the backup of the current configuration to the TFTP server using the <code>cisco.asa.asa_command</code> module, as shown here:</p>
<div><div><img alt="Figure 6.26 – Playbook task to take the Cisco ASA backup " height="389" src="img/B18383_06_26.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.26 – Playbook task to take the Cisco ASA backup</p>
<p>Add a task to create the object group using the <code>cisco.asa.asa_ogs</code> module, as shown here:</p>
<div><div><img alt="Figure 6.27 – Playbook task to create the object group " height="364" src="img/B18383_06_27.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.27 – Playbook task to create the object group</p>
<p>Finally, add the<a id="_idIndexMarker393"/> task to create the ACL entry <a id="_idIndexMarker394"/>using the <code>cisco.asa.asa_acls </code>module, as shown here:</p>
<div><div><img alt="Figure 6.28 – Playbook task to create the ACL entry " height="523" src="img/B18383_06_28.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.28 – Playbook task to create the ACL entry</p>
<p>Execute the playbook and verify that the task has been completed:</p>
<div><div><img alt="Figure 6.29 – Cisco ASA ACL playbook execution " height="576" src="img/B18383_06_29.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.29 – Cisco ASA ACL playbook execution</p>
<p>Once the <a id="_idIndexMarker395"/>playbook has been executed successfully, verify its <a id="_idIndexMarker396"/>details from the Cisco ASA device by logging in. The following screenshot shows the sample output:</p>
<div><div><img alt="Figure 6.30 – Verifying the ACL entry’s creation from the Cisco ASA device console " height="525" src="img/B18383_06_30.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.30 – Verifying the ACL entry’s creation from the Cisco ASA device console</p>
<p>Then, log in to the TFTP server and verify that the backups have been created from the playbook tasks:</p>
<div><div><img alt="Figure 6.31 – Verifying the configuration backups in the TFTP server " height="269" src="img/B18383_06_31.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.31 – Verifying the configuration backups in the TFTP server</p>
<p>This use case<a id="_idIndexMarker397"/> can be expanded by adding multiple rules, object<a id="_idIndexMarker398"/> groups, and other backup methods. Refer to the Cisco ASA module documentation<a id="_idIndexMarker399"/> at <a href="https://docs.ansible.com/ansible/latest/collections/cisco/asa/index.xhtml">https://docs.ansible.com/ansible/latest/collections/cisco/asa/index.xhtml</a> to learn more.</p>
<p>Expand your knowledge with other network devices you have such as Cisco, Arista, Juniper Network, or HPE devices, but remember to use the appropriate connection methods and parameters.</p>
<p class="callout-heading">Ansible for Network Automation</p>
<p class="callout">Refer to the <a id="_idIndexMarker400"/>documentation at <a href="https://docs.ansible.com/ansible/latest/network/index.xhtml">https://docs.ansible.com/ansible/latest/network/index.xhtml</a> to learn more about network automation basics. Also, check out <em class="italic">Network Getting Started</em> (<a href="https://docs.ansible.com/ansible/latest/network/getting_started/index.xhtml">https://docs.ansible.com/ansible/latest/network/getting_started/index.xhtml</a>) to start configuring network automation.</p>
<p>Visit <a href="https://www.ansible.com/use-cases/network-automation?hsLang=en-us">https://www.ansible.com/use-cases/network-automation?hsLang=en-us</a> to learn more about <a id="_idIndexMarker401"/>Red Hat Ansible Network <a id="_idIndexMarker402"/>Automation. Also, check out the Ansible Network Automation Workshop (<a href="https://aap2.demoredhat.com/exercises/ansible_network">https://aap2.demoredhat.com/exercises/ansible_network</a>) for practice guides.</p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor123"/>Summary</h1>
<p>In this chapter, you learned about different remote connection methods and connection variables available in Ansible. After that, you explored Microsoft Windows automation using Ansible. You learned how to connect to a Microsoft Windows machine from Ansible and create a new user account using an Ansible playbook. </p>
<p>You also learned the difference in network automation between Linux and Windows. You explored simple network automation using a VyOS appliance and collected system information using a fact-gathering playbook. </p>
<p>Finally, you learned how to use a Cisco ASA collection and implemented a use case for creating an ACL entry in a Cisco ASA device.</p>
<p>In the next chapter, you will learn how to use Ansible to automate your virtualization and cloud platforms, such as VMware, AWS, and Google Cloud Platform.</p>
<h1 id="_idParaDest-124"><a id="_idTextAnchor124"/>Further reading</h1>
<p>To learn more about the topics that were covered in this chapter, take a look at the following resources:</p>
<ul>
<li><em class="italic">Cisco ACI Guide</em>: <a href="https://docs.ansible.com/ansible/latest/scenario_guides/guide_aci.xhtml">https://docs.ansible.com/ansible/latest/scenario_guides/guide_aci.xhtml</a> </li>
<li><em class="italic">Self-paced interactive hands-on labs with Ansible Automation Platform</em>: <a href="https://www.redhat.com/en/engage/redhat-ansible-automation-202108061218">https://www.redhat.com/en/engage/redhat-ansible-automation-202108061218</a></li>
<li><em class="italic">Network Automation with Ansible</em>: <a href="https://www.ansible.com/integrations/networks">https://www.ansible.com/integrations/networks</a> </li>
<li><em class="italic">Ansible Network Automation Workshop</em>: <a href="https://aap2.demoredhat.com/exercises/ansible_network/">https://aap2.demoredhat.com/exercises/ansible_network/</a></li>
</ul>
</div>
<div><div></div>
</div>
</div></body></html>