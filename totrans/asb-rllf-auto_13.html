<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-241"><a id="_idTextAnchor241"/>13</h1>
<h1 id="_idParaDest-242"><a id="_idTextAnchor242"/>Using Ansible for Secret Management</h1>
<p>When we automate tasks, we need to implement them with little to no user interaction. However, we also know that there will be stages where Ansible needs inputs such as usernames, passwords, API keys, and secrets. Most of these details can be kept in a variable file and passed to playbooks without a user prompt or interaction but it is not a best practice to keep this kind of sensitive information in a plain text format as variables. There are external key vault services you can use but most of them require additional setup and configurations, which you need to integrate with Ansible.</p>
<p>Ansible Vault is an inbuilt feature of Ansible, using which we can safeguard the sensitive parts of our Ansible artifacts by encrypting our own vault passwords. Ansible Vault is installed together with Ansible and you can use it for Ansible ad hoc commands, playbooks, or within Red Hat Ansible Automation Platform.</p>
<p>In this chapter, you will learn about the following main topics: </p>
<ul>
<li>Handling sensitive data in Ansible</li>
<li>Managing secrets using Ansible Vault</li>
<li>Using secrets in an Ansible playbook</li>
<li>Using Vault credentials in automation controller</li>
</ul>
<p>We will start with basic Vault operations and learn how to use sensitive data in playbooks with the help of Vault. </p>
<h1 id="_idParaDest-243"><a id="_idTextAnchor243"/>Technical requirements</h1>
<p>The following are the technical requirements to proceed with this chapter:</p>
<ul>
<li>One RHEL8/Fedora machine for an Ansible control node</li>
<li>One or more Linux machines with Red Hat repositories configured. If you are using other Linux operating systems instead of <strong class="bold">Red Hat Enterprise Linux</strong> (<strong class="bold">RHEL</strong>) machines, then make sure you have the appropriate repositories configured to get packages and updates.</li>
</ul>
<p>All the Ansible code, Ansible playbooks, commands, and snippets for this chapter can be found in the GitHub repository at <a href="https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-13">https://github.com/PacktPublishing/Ansible-for-Real-life-Automation/tree/main/Chapter-13</a>.  </p>
<h1 id="_idParaDest-244"><a id="_idTextAnchor244"/>Handling sensitive data in Ansible</h1>
<p>It is a<a id="_idIndexMarker857"/> known practice not to keep sensitive data in plain text format. The same rule applies to Ansible as well, as you will be dealing with different types of sensitive data in Ansible. The sensitive data could be anything, such as the following: </p>
<ul>
<li>System passwords</li>
<li>API keys</li>
<li>Port details of applications</li>
<li>Database passwords </li>
<li>SSL certificates or keys</li>
<li>Cloud credentials</li>
</ul>
<p>We have already learned that Ansible uses plain text format for playbooks, variables, and all other configurations. Hence, storing sensitive data in normal variable files is not desirable and we need to store such information using a more secure method.</p>
<p>Before we jump into the details of Ansible Vault, let us learn about some of the alternative secret management methods in the following sections. </p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor245"/>Integrating with Vault services</h2>
<p>One of the<a id="_idIndexMarker858"/> most common methods for storing sensitive information is using key vault software and services where we can access keys and secrets over GUIs, APIs, or CLIs. We need to add tasks in Ansible to contact the Vault store, authenticate, and retrieve secrets as needed. A sample integration is demonstrated in <em class="italic">Figure 13.1</em>:</p>
<div><div><img alt="Figure 13.1 – Ansible integration with an external vault  " height="677" src="img/B18383_13_01.jpg" width="1144"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.1 – Ansible integration with an external vault </p>
<p>There are <a id="_idIndexMarker859"/>managed and self-hosted external secret management solutions available to use, such as HashiCorp Vault (<a href="https://www.vaultproject.io">https://www.vaultproject.io</a>), AWS Secrets Manager (<a href="https://aws.amazon.com/secrets-manager/">https://aws.amazon.com/secrets-manager/</a>), or Azure Key Vault (<a href="https://azure.microsoft.com/en-us/services/key-vault/">https://azure.microsoft.com/en-us/services/key-vault/</a>). For retrieving keys or secrets, we can use the API calls, Ansible modules, or Ansible <code>lookup</code> plugins available, as shown in the following figure:</p>
<div><div><img alt="Figure 13.2 – Using lookup plugins to retrieve vault keys " height="300" src="img/B18383_13_02.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.2 – Using lookup plugins to retrieve vault keys</p>
<p>The external key vault services are good and useful but we also need to handle the overhead in<a id="_idIndexMarker860"/> terms of management and pricing. Refer to the <em class="italic">Further reading</em> section for more documentation and references on external key vault services.</p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor246"/>Interactive input using prompts</h2>
<p>One of the <a id="_idIndexMarker861"/>alternative methods of handling sensitive data in Ansible is collecting the data dynamically during playbook execution. Sensitive and non-sensitive inputs can be accepted using <code>vars_prompt</code>, as follows:</p>
<div><div><img alt="Figure 13.3 – An Ansible playbook accepting passwords using prompts in Ansible " height="536" src="img/B18383_13_03.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.3 – An Ansible playbook accepting passwords using prompts in Ansible</p>
<p>When you execute the playbook, Ansible will ask for the input and, based on the <code>private</code> value, the input will either be visible or hidden on the prompt, as shown in <em class="italic">Figure 13.4</em>:</p>
<div><div><img alt="Figure 13.4 – Accepting the user input using vars_prompt " height="433" src="img/B18383_13_04.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.4 – Accepting the user input using vars_prompt</p>
<p>However, as <a id="_idIndexMarker862"/>you can see in the preceding figure, this method is interactive and someone needs to input the details during the playbook execution. This means you will not be able to use these playbooks in a fully automated workflow where user interaction is not possible. Equally, <code>vars_prompt</code> will not work with the Ansible automation controller, as the controller does not interactively allow <code>vars_prompt</code> questions.</p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor247"/>Encrypting data using Ansible Vault</h2>
<p>As <a id="_idIndexMarker863"/>I mentioned at the beginning of this chapter, Ansible Vault is an inbuilt feature of Ansible, using which we can keep the sensitive parts of our Ansible artifacts secure by encrypting the data. We can use our own passwords as vault passwords for encrypting the content. It is possible to use Ansible Vault for Ansible ad hoc commands, playbooks, or within the Ansible Automation Platform.</p>
<p>It is a best practice to separate sensitive artifacts from non-sensitive artifacts and keep them in separate files. The first step of the process is to separate the sensitive data from regular variable files and store them in separate variable files, as shown in <em class="italic">Figure 13.5</em>.</p>
<div><div><img alt="Figure 13.5 – Ansible artifacts with encrypted variables " height="384" src="img/B18383_13_05.jpg" width="632"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.5 – Ansible artifacts with encrypted variables</p>
<p>With this <a id="_idIndexMarker864"/>practice, you will have the ability to store sensitive data in an encrypted format and the flexibility to modify normal variables at any time. When Ansible wants to read the content of these encrypted files, Ansible will use the vault password, which we can enter using the prompt (<code>--ask-vault-password</code>) or using special Vault password files. For the Ansible Automation Platform, the Vault password can be stored as a credential and assigned to the Job Template.</p>
<p>In the following sections, we will learn how to use Ansible Vault to encrypt variable files and access the encrypted data inside an Ansible playbook.</p>
<h1 id="_idParaDest-248"><a id="_idTextAnchor248"/>Managing secrets using Ansible Vault </h1>
<p>Ansible Vault is <a id="_idIndexMarker865"/>very flexible, as we can encrypt, view, decrypt, or change the Vault password (as in, rekey it) at any time as needed. The Vault password must be stored safely, as you will not be able to retrieve the encrypted Vault content without the Vault password. </p>
<h2 id="_idParaDest-249"><a id="_idTextAnchor249"/>Creating Vault files</h2>
<p>In the <a id="_idIndexMarker866"/>following exercise, we will learn how to create an encrypted file using Ansible Vault:</p>
<ol>
<li>To create a Vault file from scratch, use the <code>ansible-vault create</code> command, as shown in <em class="italic">Figure 13.6</em>:</li>
</ol>
<div><div><img alt="Figure 13.6 – Creating a Vault file " height="168" src="img/B18383_13_06.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.6 – Creating a Vault file</p>
<ol>
<li value="2">After we enter the Vault password, a new file will open in the default text editor, such as <code>vim</code> or <code>nano</code> (we can change the default editor by updating the <code>$EDITOR</code> environment variable). Enter the variables and values as needed, just as with a normal variable file:<pre>cloud_username: myusername 
cloud_password: mysecretpassword</pre></li>
</ol>
<p>Refer to <em class="italic">Figure 13.7</em> for further details:</p>
<div><div><img alt="Figure 13.7 – Adding content to the Vault file " height="484" src="img/B18383_13_07.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.7 – Adding content to the Vault file</p>
<ol>
<li value="3">Save the file as per text editor actions (for example, <code>:wq</code>) and exit the editor.</li>
</ol>
<p>We can <a id="_idIndexMarker867"/>view the Vault file but the content will be encrypted (see <em class="italic">Figure 13.8</em>) and you will not be able to retrieve the data without the Vault password.</p>
<div><div><img alt="Figure 13.8 – Encrypted content inside the Vault file " height="328" src="img/B18383_13_08.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.8 – Encrypted content inside the Vault file</p>
<p>We have learned how to create an encrypted file using Ansible Vault in the preceding exercise. In the following section, we will learn how to encrypt existing files and content using Ansible Vault.</p>
<h2 id="_idParaDest-250"><a id="_idTextAnchor250"/>Encrypting existing files </h2>
<p>If you <a id="_idIndexMarker868"/>have a variable file or file with sensitive content and you want to encrypt it using Ansible Vault, then you can do it using the <code>encrypt</code> command, as explained in the following exercise:</p>
<ol>
<li value="1">Verify the current content of the files as follows:</li>
</ol>
<div><div><img alt="Figure 13.9 – Database details in a plain text format " height="194" src="img/B18383_13_09.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.9 – Database details in a plain text format</p>
<ol>
<li value="2">Encrypt the content using the <code>ansible-vault encrypt</code> command:</li>
</ol>
<div><div><img alt="Figure 13.10 – Encrypting an existing file using Ansible Vault " height="194" src="img/B18383_13_10.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.10 – Encrypting an existing file using Ansible Vault</p>
<ol>
<li value="3">Now, verify<a id="_idIndexMarker869"/> the encryption of the file as follows:</li>
</ol>
<div><div><img alt="Figure 13.11 – The plain text file after being encrypted " height="378" src="img/B18383_13_11.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.11 – The plain text file after being encrypted</p>
<p>Now that we know how to encrypt the files, we will learn how to use Vault ID to handle multiple Vault passwords in the next section.</p>
<h2 id="_idParaDest-251"><a id="_idTextAnchor251"/>Adding Vault ID to an encryption</h2>
<p>When we <a id="_idIndexMarker870"/>have many Vault files and multiple Vault passwords, we can use the <strong class="bold">Vault ID</strong> to identify the Vault content. A Vault ID is an identifier for one or more vaulted secrets and contents. Let’s follow an example:</p>
<ol>
<li value="1">Create and encrypt the secret file with the <code>--vault-id</code> option as follows. The Vault ID will be visible in the prompt, as shown in <em class="italic">Figure 13.12</em>.</li>
</ol>
<div><div><img alt="Figure 13.12 – Create a Vault file with a Vault ID " height="168" src="img/B18383_13_12.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.12 – Create a Vault file with a Vault ID</p>
<ol>
<li value="2">The <a id="_idIndexMarker871"/>same Vault ID can be checked from the content of the Vault file as follows:</li>
</ol>
<div><div><img alt="Figure 13.13 – A Vault file with a Vault ID " height="272" src="img/B18383_13_13.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.13 – A Vault file with a Vault ID</p>
<ol>
<li value="3">The password for the Vault ID can be taken from the prompt (as we did in the preceding example) or from a configured path in <code>ansible.cfg</code> as follows:</li>
</ol>
<div><div><img alt="Figure 13.14 – The Vault ID configured in ansible.cfg " height="219" src="img/B18383_13_14.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.14 – The Vault ID configured in ansible.cfg</p>
<p>Using a Vault ID will help you to manage multiple Vault files in a large environment and identify the Vaulted files and secrets.</p>
<h2 id="_idParaDest-252"><a id="_idTextAnchor252"/>Viewing the content of a Vault file </h2>
<p>Once the <a id="_idIndexMarker872"/>content is encrypted, it is possible to display the Vault content using the <code>ansible-vault view</code> command, as shown in <em class="italic">Figure 13.15</em>. Ansible will prompt the existing Vault password and you will see the content in plain text:</p>
<div><div><img alt="Figure 13.15 – Displaying the Vault content " height="219" src="img/B18383_13_15.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.15 – Displaying the Vault content</p>
<p>Please note that<a id="_idIndexMarker873"/> the Vault file content is still in an encrypted state and you will therefore not be able to access it without the Vault password.</p>
<h2 id="_idParaDest-253"><a id="_idTextAnchor253"/>Editing a Vault file</h2>
<p>To edit the <a id="_idIndexMarker874"/>encrypted Vault file, use the <code>ansible-vault edit</code> command as follows:</p>
<div><div><img alt="Figure 13.16 – Editing an encrypted file using Ansible Vault " height="141" src="img/B18383_13_16.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.16 – Editing an encrypted file using Ansible Vault</p>
<p>The Vault file will open in the text editor in plain text format. Once editing is completed, save the file (for example, <code>:wq</code>) and exit the editor, as shown in <em class="italic">Figure 13.17</em>:</p>
<div><div><img alt="Figure 13.17 – Editing a Vault file in the text editor " height="458" src="img/B18383_13_17.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.17 – Editing a Vault file in the text editor</p>
<p>Once editing is <a id="_idIndexMarker875"/>complete, the Vault files will be saved in an encrypted format without any additional actions required.</p>
<h2 id="_idParaDest-254"><a id="_idTextAnchor254"/>Decrypting a Vault file</h2>
<p>There are <a id="_idIndexMarker876"/>situations where we need to decrypt the file back to plain text temporarily or permanently. In such cases, <code>ansible-vault decrypt</code> will help to decrypt the Vault file back to plain text format as follows:</p>
<div><div><img alt="Figure 13.18 – Decrypting a Vault file " height="168" src="img/B18383_13_18.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.18 – Decrypting a Vault file</p>
<p>Verify the file content after decryption, as shown in <em class="italic">Figure 13.19</em>:</p>
<div><div><img alt="Figure 13.19 – The Vault file after decryption " height="219" src="img/B18383_13_19.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.19 – The Vault file after decryption</p>
<p>When you <a id="_idIndexMarker877"/>encrypt the file again, you can use the same or a different Vault password; it does not matter.</p>
<h2 id="_idParaDest-255"><a id="_idTextAnchor255"/>Vault password rotation by rekeying</h2>
<p>It is a <a id="_idIndexMarker878"/>common practice to rotate passwords, keys, and SSL certificates to ensure that the credentials are not compromised and also to follow the organization’s password policies. The <code>ansible-vault rekey</code> command will help to change or rotate the Vault password for secret content. Ansible Vault will ask for the existing Vault password and, if successful, a prompt for a new Vault password will be displayed, as shown in <em class="italic">Figure 13.20</em>:</p>
<div><div><img alt="Figure 13.20 – Rotating the Vault password " height="219" src="img/B18383_13_20.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.20 – Rotating the Vault password</p>
<p>Remember to update the new Vault password wherever applicable, such as in local Vault password files or Ansible automation controller vault credentials, for example.</p>
<h2 id="_idParaDest-256"><a id="_idTextAnchor256"/>Encrypting specific variables</h2>
<p>If you do not <a id="_idIndexMarker879"/>wish to encrypt an entire variable file, then encrypt a specific variable using the <code>ansible-vault encrypt_string</code> command as follows:</p>
<div><div><img alt="Figure 13.21 – Encrypting a string using Ansible Vault " height="378" src="img/B18383_13_21.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.21 – Encrypting a string using Ansible Vault</p>
<p>The input can be taken from inline, as shown in the preceding example (<em class="italic">Figure 13.21</em>), or from standard input, as shown in <em class="italic">Figure 13.22</em>:</p>
<div><div><img alt="Figure 13.22 – Ansible Vault encrypting the string using the input value " height="458" src="img/B18383_13_22.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.22 – Ansible Vault encrypting the string using the input value</p>
<p>Use this encrypted string as a variable in Ansible playbooks or variable files as follows:</p>
<div><div><img alt="Figure 13.23 – Encrypted string inside the playbook " height="565" src="img/B18383_13_23.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.23 – Encrypted string inside the playbook</p>
<p class="callout-heading">Encrypting content with Ansible Vault</p>
<p class="callout">You have more options with Ansible Vault, such as editing, encrypting, decrypting, and rekeying, for example. Refer to the documentation for more details at <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.xhtml">https://docs.ansible.com/ansible/latest/user_guide/vault.xhtml</a>.</p>
<p>In the following section, we <a id="_idIndexMarker880"/>will learn how to use encrypted Vault files in Ansible playbooks and retrieve the secret information.</p>
<h1 id="_idParaDest-257"><a id="_idTextAnchor257"/>Using secrets in Ansible playbooks</h1>
<p>You have <a id="_idIndexMarker881"/>learned the basic usage of secrets in an Ansible playbook in <a href="B18383_03.xhtml#_idTextAnchor052"><em class="italic">Chapter 3</em></a>’s <em class="italic">Automating notifications</em> section. In this section, we will learn more about their usage and different methods of passing the Vault password.</p>
<p>In the following exercise, we will develop Ansible content to create users in Linux, with their passwords retrieved from an Ansible Vault file:</p>
<ol>
<li value="1">Create a <code>Chapter-13/vars/users.yaml</code> Ansible Vault file as follows and enter the Vault password:<pre>[ansible@ansible Chapter-13]$ ansible-vault create vars/users.yaml </pre></li>
</ol>
<p>Remember the password, as we need this information when executing the playbook.</p>
<ol>
<li value="2">Add<a id="_idIndexMarker882"/> content to the variable files as follows:</li>
</ol>
<div><div><img alt="Figure 13.24 – User details inside an Ansible Vault file " height="272" src="img/B18383_13_24.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.24 – User details inside an Ansible Vault file</p>
<p>Save the file and exit the editor. The <code>userlist</code> variable contains details of multiple users and their passwords.</p>
<ol>
<li value="3">Verify the file content, as shown in <em class="italic">Figure 13.25</em>:</li>
</ol>
<div><div><img alt="Figure 13.25 – A user’s encrypted details  " height="433" src="img/B18383_13_25.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.25 – A user’s encrypted details </p>
<ol>
<li value="4">Create a <code>Chapter-13/manage-user.yaml</code> playbook with the following content:</li>
</ol>
<div><div><img alt="Figure 13.26 – A playbook to add users into " height="378" src="img/B18383_13_26.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.26 – A playbook to add users into</p>
<p>See the <code>vars_files</code> section<a id="_idIndexMarker883"/> because we have already included the encrypted variable file in the playbook.</p>
<div><div><img alt="Figure 13.27 – Creating groups and users " height="458" src="img/B18383_13_27.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.27 – Creating groups and users</p>
<p class="callout-heading">Generating encrypted passwords in Ansible</p>
<p class="callout">The <code>password_hash(‘sha256’)</code> filter has been used to encrypt the password and avoid sending a plain text password. Refer to <a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.xhtml#how-do-i-generate-encrypted-passwords-for-the-user-module">https://docs.ansible.com/ansible/latest/reference_appendices/faq.xhtml#how-do-i-generate-encrypted-passwords-for-the-user-module</a> to learn more about password encryption in Ansible.</p>
<ol>
<li value="5">Now, execute<a id="_idIndexMarker884"/> the playbook using the <code>ansible-playbook</code> command as follows:</li>
</ol>
<div><div><img alt="Figure 13.28 – An Ansible error due to there being no Vault secret " height="141" src="img/B18383_13_28.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.28 – An Ansible error due to there being no Vault secret</p>
<p>Since we have included Ansible Vault files inside the playbook, Ansible expects the Vault secret to be available and will fail if no appropriate secret is.</p>
<ol>
<li value="6">Execute the playbook by adding an <code>--ask-vault-password</code> argument:</li>
</ol>
<div><div><img alt="Figure 13.29 – Executing the playbook with the Vault secret prompt " height="458" src="img/B18383_13_29.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.29 – Executing the playbook with the Vault secret prompt</p>
<ol>
<li value="7">Verify the user creation success on <code>node1</code> using an ad hoc command as follows:</li>
</ol>
<p><em class="italic">Figure 13.30</em> shows a sample output for the command:</p>
<div><div><img alt="Figure 13.30 – An Ansible ad hoc command to check that a user has been created successfully " height="194" src="img/B18383_13_30.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.30 – An Ansible ad hoc command to check that a user has been created successfully</p>
<p>In the <a id="_idIndexMarker885"/>preceding example, you have encrypted a variable file using Ansible Vault and retrieved the information inside the Ansible playbook by prompting the Vault secret. However, for automated operations, we need to skip this prompt. The Vault secret should be able to pass in the command line itself. In such scenarios, use the <code>--vault-password-file</code> argument and pass the Vault secret inside a file.</p>
<ol>
<li value="8">Create a file for storing your Vault secret. The Vault secret should be a plain text file but saved in a safe location, for example, a hidden file in your home directory, as shown in <em class="italic">Figure 13.31</em>:</li>
</ol>
<div><div><img alt="Figure 13.31 – A Vault secret in a hidden file in your home directory " height="194" src="img/B18383_13_31.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.31 – A Vault secret in a hidden file in your home directory</p>
<ol>
<li value="9">Execute the same playbook but pass the Vault secret file using the <code>--vault-password-file</code> argument. This time Ansible will not ask for a password, as shown in <em class="italic">Figure 13.32</em>:</li>
</ol>
<div><div><img alt="Figure 13.32 – The Ansible Vault secret from the password file " height="405" src="img/B18383_13_32.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.32 – The Ansible Vault secret from the password file</p>
<p>The Vault file<a id="_idIndexMarker886"/> can contain any type of data, whether a single variable, a string, a complex dictionary variable, or any other text content. </p>
<p>Ansible Vault will help us to encrypt the sensitive data in Ansible artifacts, but we need to safeguard such data from being captured within logs and we will learn about how to do so in the following section.</p>
<h2 id="_idParaDest-258"><a id="_idTextAnchor258"/>Hiding secrets from logs using no_log</h2>
<p>You have learned <a id="_idIndexMarker887"/>how to keep sensitive content using Ansible Vault but we have a problem here, as Ansible will include the sensitive data content in plain text format when it carries out logging. Sometimes, it will not be visible in the default verbose mode but will be displayed in a higher-level verbose mode, such as <code>-vvv</code> or <code>-vvvv</code>. Refer to <em class="italic">Figure 13.33</em> for the details:</p>
<div><div><img alt="Figure 13.33 – An Ansible playbook output displaying sensitive data " height="458" src="img/B18383_13_33.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.33 – An Ansible playbook output displaying sensitive data</p>
<p>In such<a id="_idIndexMarker888"/> cases, use <code>no_log: True</code>, as shown in <em class="italic">Figure 13.34</em>, and any output in that task will be censored for safety reasons:</p>
<div><div><img alt="Figure 13.34 – Disabling the logging of tasks using no_log " height="353" src="img/B18383_13_34.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.34 – Disabling the logging of tasks using no_log</p>
<p>If you execute the playbook now, you will notice the change as follows:</p>
<div><div><img alt="Figure 13.35 – The Ansible output with no_log applied to sensitive data " height="433" src="img/B18383_13_35.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.35 – The Ansible output with no_log applied to sensitive data</p>
<p>Even<a id="_idIndexMarker889"/> if you enable the high verbose mode, <code>-vvv</code>, Ansible will hide the information, as shown in <em class="italic">Figure 13.36</em>:</p>
<div><div><img alt="Figure 13.36 – A high verbose Ansible log with no_log applied " height="579" src="img/B18383_13_36.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.36 – A high verbose Ansible log with no_log applied</p>
<p>This is one of the best practices to safeguard the sensitive data being captured in system logs and job histories. </p>
<p>In the following section, we will learn how to keep the sensitive data inside other variable locations, such as <code>group_vars</code> and <code>host_vars</code>.</p>
<h2 id="_idParaDest-259"><a id="_idTextAnchor259"/>Ansible Vault for group_vars and host_vars</h2>
<p>As we <a id="_idIndexMarker890"/>discussed earlier in <a id="_idIndexMarker891"/>the chapter, it is a best practice to separate variables and sensitive information wherever appropriate. </p>
<p>For the following exercise, we will reuse the PostgreSQL Ansible artifacts that we developed in <a href="B18383_08.xhtml#_idTextAnchor144"><em class="italic">Chapter 8</em></a>, <em class="italic">Helping Database Team with Automation</em>. PostgreSQL is installed and configured on <code>node2</code>. We will create an additional database user account for accessing the <code>db_sales</code> database (refer back to the content of <em class="italic">Chapter 8</em> for more details.) Let’s do the following:</p>
<ol>
<li value="1">Update the inventory (<code>Chapter-13/hosts</code>) by adding <code>node2</code> as part of the <code>postgres</code> host group:<pre>[postgres]
node2 ansible_host=192.168.56.24</pre></li>
<li>Create <code>group_vars</code> and another subdirectory as follows:</li>
</ol>
<div><div><img alt="Figure 13.37 – Creating the group_vars directory and Vault file " height="202" src="img/B18383_13_37.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.37 – Creating the group_vars directory and Vault file</p>
<ol>
<li value="3">Add a database username and password for the new user:<pre>postgres_app_user_name: appteam
postgres_app_user_password: ‘AppPassword’</pre></li>
<li>Save and verify the Vault file, as shown in <em class="italic">Figure 13.38</em>:</li>
</ol>
<div><div><img alt="Figure 13.38 – The database user information in the Vault file " height="334" src="img/B18383_13_38.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.38 – The database user information in the Vault file</p>
<ol>
<li value="5">Create <a id="_idIndexMarker892"/>another Vault file <a id="_idIndexMarker893"/>for storing the PostgreSQL admin password:<pre>[ansible@ansible Chapter-13]$ ansible-vault create group_vars/postgres/vault/dbadmin.yaml</pre></li>
<li>Add <code>postgres_password</code> inside and save the file:<pre>postgres_password: ‘PassWord’</pre></li>
<li>Create a <code>Chapter-13/postgres-create-dbuser.yaml</code> playbook as follows:</li>
</ol>
<div><div><img alt="Figure 13.39 – An Ansible playbook for managing PostgreSQL user information " height="411" src="img/B18383_13_39.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.39 – An Ansible playbook for managing PostgreSQL user information</p>
<ol>
<li value="8">Add a task to create the PostgreSQL database user as follows:</li>
</ol>
<div><div><img alt="Figure 13.40 – The task to create a PostgreSQL user " height="466" src="img/B18383_13_40.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.40 – The task to create a PostgreSQL user</p>
<p>All the <a id="_idIndexMarker894"/>sensitive variables are inside the <code>group_vars</code> Vault files now, for example, <code>postgres_password</code>, <code>postgres_password</code>, and <code>postgres_app_user_password</code>.</p>
<ol>
<li value="9">Execute the <a id="_idIndexMarker895"/>playbook on the <code>postgres</code> host group (which we created in the first step), and the playbook will read the variables and create the new user safely, as shown in <em class="italic">Figure 13.41</em>:</li>
</ol>
<div><div><img alt="Figure 13.41 – The creation of the PostgreSQL database user  " height="414" src="img/B18383_13_41.jpg" width="1191"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.41 – The creation of the PostgreSQL database user </p>
<p>As a best practice, keep all the sensitive details inside Vault files at appropriate locations and they will remain safe, even if you keep your Ansible content in Git repositories.</p>
<p>In the following section, we will learn how to use the Vault files and credentials in the Ansible Automation Platform.</p>
<h1 id="_idParaDest-260"><a id="_idTextAnchor260"/>Using Vault credentials in the Ansible Automation Platform</h1>
<p>When <a id="_idIndexMarker896"/>you run your playbooks from the Web UI of the automation controller, then you have similar options to provide the Vault secret from the WebUI. We can either keep the Vault secret inside a Vault credential or<a id="_idIndexMarker897"/> we can select the <code>--ask-vault-password</code> in the Ansible command-line execution) and will prompt for the Vault secret when you execute the Job Template from the automation controller’s WebUI.</p>
<p class="callout-heading">The Ansible automation controller</p>
<p class="callout">The Ansible automation controller is the control plane for the <strong class="bold">Ansible Automation Platform</strong> (<strong class="bold">AAP</strong>). When you migrate to AAP 2, the automation controller will be upgraded to include Ansible Tower. Refer to <em class="italic">Chapter 12</em>, <em class="italic">Integrating Ansible with Your Tools</em>, for more details.</p>
<p>In the following section, we will learn how to create Vault credentials in the Ansible automation controller GUI and attach them to the Job Template to retrieve encrypted content.</p>
<h2 id="_idParaDest-261"><a id="_idTextAnchor261"/>Creating Vault credentials</h2>
<p>To store the <a id="_idIndexMarker898"/>Vault secret, create a new credential by following these steps:</p>
<ol>
<li value="1">Open the <strong class="bold">Create New Credential</strong> blade and set <strong class="bold">Credential Type</strong> to <strong class="bold">Vault</strong>, as shown in <em class="italic">Figure 13.42</em>. Enter the Vault secret (password) and add a Vault ID if required:</li>
</ol>
<div><div><img alt="Figure 13.42 – Creating a new Vault credential in the automation controller " height="587" src="img/B18383_13_42.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.42 – Creating a new Vault credential in the automation controller</p>
<ol>
<li value="2">Once<a id="_idIndexMarker899"/> created, update your Job Template and add the new Vault credentials inside. Navigate <strong class="bold">Job Template</strong> | <strong class="bold">Edit</strong> and click on the <em class="italic">Search</em> button near <strong class="bold">Credentials</strong>. </li>
<li>Within the pop-up screen, set <strong class="bold">Selected Category</strong> to <strong class="bold">Vault</strong> and you will see the Vault credentials, as shown in <em class="italic">Figure 13.43</em>. Select the required Vault credentials and click the <strong class="bold">Select</strong> button.</li>
</ol>
<div><div><img alt="Figure 13.43 – Selecting the Vault credential for the Job Template " height="507" src="img/B18383_13_43.jpg" width="1033"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.43 – Selecting the Vault credential for the Job Template</p>
<ol>
<li value="4">Verify the<a id="_idIndexMarker900"/> credentials, as shown in <em class="italic">Figure 13.44</em>:</li>
</ol>
<div><div><img alt="Figure 13.44 – The credentials added in the Job Template " height="580" src="img/B18383_13_44.jpg" width="1099"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 13.44 – The credentials added in the Job Template</p>
<p>If you have multiple Vault files with different Vault secrets, then add multiple Vault credentials as needed and add Vault IDs.</p>
<h1 id="_idParaDest-262"><a id="_idTextAnchor262"/>Summary</h1>
<p>In this chapter, we learned the importance of keeping sensitive data secure within Ansible automation artifacts and the different methods available to do so, such as external Vault services, <code>vars_prompt</code>, and Ansible Vault. After this, we learned different operations within Ansible Vault, such as creating, modifying, viewing, decrypting, and rekeying Vault files and variables. </p>
<p>We also developed Ansible artifacts using Vault files for storing user information and database user credentials. We also discussed the Vault credentials in the automation controller GUI and how to use them with Job Templates.</p>
<p>In the next chapter, we will learn about different methodologies and approaches for developing Ansible automation artifacts and factors to consider throughout Ansible automation.</p>
<h1 id="_idParaDest-263"><a id="_idTextAnchor263"/>Further reading</h1>
<p>To learn more about the topics covered in this chapter, please visit the following links:</p>
<ul>
<li><em class="italic">Tutorial: Use Azure Key Vault to store VM secrets with Ansible</em> – <a href="https://docs.microsoft.com/en-us/azure/developer/ansible/key-vault-configure-secrets?tabs=ansible">https://docs.microsoft.com/en-us/azure/developer/ansible/key-vault-configure-secrets?tabs=ansible</a></li>
<li><em class="italic">How to send emails using Ansible and Gmail</em> – <a href="https://www.techbeatly.com/ansible-gmail">https://www.techbeatly.com/ansible-gmail</a></li>
<li><em class="italic">Logging Ansible output</em> – <a href="https://docs.ansible.com/ansible/latest/reference_appendices/logging.xhtml">https://docs.ansible.com/ansible/latest/reference_appendices/logging.xhtml</a> </li>
<li><em class="italic">Keep vaulted variables safely visible</em> – <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.xhtml#keep-vaulted-variables-safely-visible">https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.xhtml#keep-vaulted-variables-safely-visible</a></li>
<li><em class="italic">Encrypting passwords in Ansible</em> – <a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.xhtml#how-do-i-generate-encrypted-passwords-for-the-user-module">https://docs.ansible.com/ansible/latest/reference_appendices/faq.xhtml#how-do-i-generate-encrypted-passwords-for-the-user-module</a></li>
<li><em class="italic">Vault IDs in Red Hat Ansible and Red Hat Ansible Tower</em> –<a href="https://developers.redhat.com/blog/2020/01/30/vault-ids-in-red-hat-ansible-and-red-hat-ansible-tower">https://developers.redhat.com/blog/2020/01/30/vault-ids-in-red-hat-ansible-and-red-hat-ansible-tower</a></li>
</ul>
</div>
<div><div></div>
</div>
</div>

<div><div><h1 id="_idParaDest-264"><a id="_idTextAnchor264"/>Part 3: Managing Your Automation Development Flow with Best Practices</h1>
</div>
<div><p>This part will describe the importance of continual assessment, monitoring, and security operations. You will learn about different monitoring technologies you can use to detect and protect your environment, as well as how to gain insights from them.</p>
<p>This part of the book comprises the following chapters:</p>
<ul>
<li><a href="B18383_14.xhtml#_idTextAnchor265"><em class="italic">Chapter 14</em></a><em class="italic">, Keeping Automation Simple and Efficient </em></li>
<li><a href="B18383_15.xhtml#_idTextAnchor275"><em class="italic">Chapter 15</em></a><em class="italic">, Automating Non-Standard Platforms and Operations </em></li>
<li><a href="B18383_16.xhtml#_idTextAnchor294"><em class="italic">Chapter 16</em></a><em class="italic">, Ansible Automation Best Practices for Production</em></li>
</ul>
</div>
</div></body></html>