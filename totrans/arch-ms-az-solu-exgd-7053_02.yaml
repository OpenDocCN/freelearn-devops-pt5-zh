- en: Configuring Compute-Intensive Applications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we covered the Azure Virtual Machine (VM) objective.
    We covered how to design Azure VMs by discussing the available series and sizes.
    We also covered how to design for high availability and performance using the
    various features Azure provides.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter introduces the compute-intensive applications objective. It will
    cover how to design high-performance computing (HPC) and other compute-intensive
    applications using Azure services, how to determine when to use Azure Batch, and
    how to design stateless components to accommodate scale and containers with Azure
    Batch.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following topics will be covered:'
  prefs: []
  type: TYPE_NORMAL
- en: High-performance compute virtual machines
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Microsoft HPC Pack
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Azure Batch
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: High-performance compute virtual machines
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure offers several virtual machine series and sizes that are designed and
    optimized for compute-intensive tasks. They are also known as compute-intensive
    instances. At the time of writing this book, Azure offers the A8-A11, the N-series,
    and the H-series, which all support HPC workloads.
  prefs: []
  type: TYPE_NORMAL
- en: 'These series and sizes consist of hardware that is designed and optimized for
    compute-intensive, graphics-intensive, and network-intensive applications. They
    are best suited for modeling, simulations, and HPC cluster applications:'
  prefs: []
  type: TYPE_NORMAL
- en: The A-series offers RDMA networking, which provides ultra-low-latency and high
    bandwidth networking.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The N-series is aimed at graphics-intensive and compute-intensive applications.
    They consist of different NVIDIA Tesla GPUs that are well suited for deep learning
    applications, gaming applications, or virtualization.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The H-series offers virtual machines that are specifically aimed at high performance.
    They offer fast Intel Xeon processors, SSD-based local storage, and DDR4 memory.
    These VMs are best suited for HPC workloads, such as batching, modeling, and simulations.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For more information on the hardware specifications of the N-series virtual
    machines, you can refer to the following article: [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-gpu](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-gpu).
    For more information about high-performance VMs, you can refer to the following
    article: [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json).
  prefs: []
  type: TYPE_NORMAL
- en: The Azure Marketplace offers several virtual machine images that are specifically
    designed for HPC, such as Azure Data Science VMs for Windows and Linux, D3View,
    and more. You can navigate to the marketplace using the following URL: [https://azuremarketplace.microsoft.com/en-us/marketplace.](https://azuremarketplace.microsoft.com/en-us/marketplace)
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft HPC Pack
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Microsoft provides an HPC Pack for Windows Server 2012, 2016, and Linux machines.
    This is a free offering and you can use this to create HPC clusters on your on-premises
    servers and Azure VMs.
  prefs: []
  type: TYPE_NORMAL
- en: You can install HPC Pack on a Windows or Linux Server. These machines will automatically
    become the head node of the cluster. You can then add additional nodes to the
    cluster and run a job on it. This job will be distributed across all the available
    nodes automatically.
  prefs: []
  type: TYPE_NORMAL
- en: 'It offers the following additional features:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Hybrid Cluster**: You can set up hybrid clusters using on-premises servers
    and Azure VMs'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HPC Cluster Manager**: A tool for managing, deploying, and configuring HPC
    clusters'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**PowerShell: **You can use HPC PowerShell to manage, configure, deploy, add,
    and execute jobs on the cluster'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: You can use HPC Pack for designing effective cloud-native HPC solutions and
    hybrid HPC solutions. Both of these are explained in the following sections.
  prefs: []
  type: TYPE_NORMAL
- en: Cloud-native HPC solutions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'A cloud-native HPC solution uses HPC virtual machines and can scale up to thousands
    of instances and compute cores. It uses a head node, several compute nodes, and
    storage. The following Azure resources can be used to create a cloud-native HPC
    architecture:'
  prefs: []
  type: TYPE_NORMAL
- en: '**HPC head node**: The head node runs in Azure on a Windows or Linux server
    virtual machine. When you install Azure HPC Pack on this machine, it will become
    the head node automatically.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HPC compute nodes**: The HPC compute nodes are created using A8 and A9 instances.
    These instances provide RDMA networking, which can be used to achieve high bandwidth
    and microsecond latencies between the nodes.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual Machine Scale Set**: You can place the compute nodes in a **Virtual
    Machine Scale Set** (**VMSS**) for redundancy and availability. VMs that use RDMA
    for communicating with each other are placed in the same Availability Set.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual network**: All the Azure resources, such as the head node, the compute
    nodes, and storage layer, are added to an Azure virtual network.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Storage**: The disks that are used for all the different nodes are stored
    inside Azure Blob Storage.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**ARM templates**: You can use ARM templates to deploy the applications to
    the nodes.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/8c09dd12-1d9e-4aa0-9811-47fb3e5b5bea.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Cloud-native HPC architecture
  prefs: []
  type: TYPE_NORMAL
- en: Hybrid HPC architecture
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Hybrid HPC architecture uses some of the building blocks that are used for
    a cloud-native HPC architecture complemented with the on-premises part. The following
    Azure resources will be used in this scenario:'
  prefs: []
  type: TYPE_NORMAL
- en: '**HPC head node**: The head node runs on your on-premises environment. The
    head node can be installed on a virtual machine in Azure as well, on a Windows
    or Linux server virtual machine, and just like the cloud-native architecture,
    you can install Azure HPC Pack on it and it will become the head node automatically.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HPC compute nodes**: The HPC compute nodes in your on-premises environment
    can be Linux or Windows servers with sufficient compute power. The VMs in Azure
    are created using A8 and A9 instances and provide RDMA networking.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual Machine Scale Sets**: You can place the compute nodes in Azure inside
    a VMSS for redundancy and availability. VMs that use RDMA for communicating with
    each other are placed in the same availability set.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Virtual network**: The Azure resources, such as the compute nodes and storage
    layer are added to an Azure virtual network.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**ExpressRoute**: ExpressRoute offers a secure and reliable connection between
    your on-premises environment and Azure. These connections don''t go over the public
    internet but use a private connection, which is usually set up between an ExpressRoute
    broker and Azure.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**VPN Gateway**: A VPN Gateway offers an endpoint between Azure and your on-premises
    network and enables secure connectivity and communication between the different
    nodes in the HPC cluster. This connection uses the public internet.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Storage**: The disks that are used for the nodes that are hosted in Azure,
    are stored inside Azure Blob Storage.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![](img/a8c4ce1a-f32a-444f-bb3a-813d06a4b574.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Hybrid HPC architecture
  prefs: []
  type: TYPE_NORMAL
- en: Azure Batch
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure Batch is a service that helps developers scale their workloads over virtual
    machines (Windows or Linux) or containers, without the need to manage the infrastructure. With
    Azure Batch, you can run large-scale, parallel and HPC applications efficiently
    in the cloud. Batch computing is most commonly used for applications that regularly
    process, transform, or analyze large volumes of data. Typically, HPC applications
    that run on Azure Batch include deep learning applications, image rendering applications,
    media encoding applications, and Monte Carlo simulations. Azure Media Services
    uses Azure Batch internally for media encoding as well.
  prefs: []
  type: TYPE_NORMAL
- en: The Azure Batch service uses Azure compute as its infrastructure, which means
    you can use both Windows or Linux VMs to host your applications or workloads.
    Azure uses the A8/A9 series VMs with RDMA networking internally for the nodes and
    is fully responsible for creating and managing those virtual machines. Azure adds
    the nodesto a **pool** inside the Azure Batch account.
  prefs: []
  type: TYPE_NORMAL
- en: 'Inside the Azure Batch account, a **job** can be created that will run the
    workload on the pool.Your workload is then added to the Batch **queue** and split
    up into several tasks, so they can run in parallel. Azure Batch scales those tasks automatically
    and they can be scheduled as well. Your workloads, which are called **tasks**,
    are added to the Batch Queue, spread over the managed pool of virtual machines,
    and can be scaled automatically. Most of these tasks can run completely independent,
    but for some HPC workloads, it might be necessary for the tasks to communicate
    with each other. In that case, Azure Batch uses persistent storage to store output
    data for retrieval by other tasks. By default, Azure Blob Storage is used for
    this, but you can use other storage types as well. The tasks communicate with
    each other using a runtime called **Message Passing Interface** (**MPI**) and
    the outcome of all these different tasks can be consolidated into a single result:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/f82d9264-c26a-4476-ae2f-a284b059f88a.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure Batch architecture
  prefs: []
  type: TYPE_NORMAL
- en: To automate the creation of Azure Batch processes, Azure Batch uses a JSON template
    (not to be confused with an ARM template, this one is different). In this template,
    you can automate the creation of the Batch pool, including the VM sizes, the operating
    system, and the number of nodes (the number of VMs). You can use Azure CLI for
    automation as well.
  prefs: []
  type: TYPE_NORMAL
- en: A Batch pool consists of virtual machines that can be created using images from
    the Azure Marketplace, cloud services (a standard guest image from Azure), custom
    images (a custom VHD from a storage account), and specific graphic and rendering
    images.
  prefs: []
  type: TYPE_NORMAL
- en: You can use low priority VMs for Azure Batch. This reduces the costs of VMs
    significantly. This discount is only available for Azure Batch, for all the VM
    sizes Azure Batch supports, and in all regions. For more information on these
    prices, you can refer to the following web page: [https://azure.microsoft.com/en-us/pricing/details/batch/](https://azure.microsoft.com/en-us/pricing/details/batch/).
  prefs: []
  type: TYPE_NORMAL
- en: Creating an Azure Batch service
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this example, we are going to create a Batch pool from the Azure Portal.
    This will give you some extra information on the different settings for Azure
    Batch, such as how to start your applications on the pool of VMs.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create an Azure Batch pool, you can refer to the following steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'The first step is to create an Azure Batch account in the Azure Portal. You
    can refer to the following article to create one: [https://docs.microsoft.com/en-us/azure/batch/batch-account-create-portal](https://docs.microsoft.com/en-us/azure/batch/batch-account-create-portal).
    I''ve created an Azure Batch account called packtpub in a Resource group called PacktBatchGroup:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/33fb0bd6-e4a0-489a-b0fa-444198deae7b.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure Batch service
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, click on Pools in the left-menu and click on Add.Add the following values:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Pool ID: packtpool1'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Display name: PactPool
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Image Type: Cloud Services (Windows Only)'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Node Size: Pick Standard A1'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Scale Mode: Auto Scale
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Formula: "$TargetDedicated=0" (you can refer to the following article about **Automatic
    Scaling Formulas **for more information: [https://docs.microsoft.com/en-us/azure/batch/batch-automatic-scaling](https://docs.microsoft.com/en-us/azure/batch/batch-automatic-scaling))
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Start Task: Disabled (here, you can provide a command for the startup of executables
    or other workloads)'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Leave the other default values for the rest of the settings.
  prefs: []
  type: TYPE_NORMAL
- en: For the virtual network settings, you can run your Batch pool inside a VNet.
    This way, the VMs can communicate with other VMs that are not part of the Batch
    pool, such as a file server or a license server.
  prefs: []
  type: TYPE_NORMAL
- en: 'Click on OK:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/f7af7184-706c-4196-b40e-982cc0d582c3.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure Batch pool settings
  prefs: []
  type: TYPE_NORMAL
- en: 'After creating the Batch pool, you can select Application packages from the
    left-hand menu to upload your executables, libraries, or other metadata that is
    associated with your application. To upload packages, you have to create or link
    an Azure Storage account. Application packages are uploaded as ZIP files that
    consist of all the necessary files. Those files are installed on the VMs automatically
    by Azure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](img/21332571-4d49-4227-8bd4-1ae6ea683838.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure Batch application packages
  prefs: []
  type: TYPE_NORMAL
- en: You can also provide the Start task properties from the left-hand menu as well.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This is just one way of creating a Batch service. There are more methods that
    you can use. You can use Visual Studio, call the Batch API directly, or use CLI
    or PowerShell.
  prefs: []
  type: TYPE_NORMAL
- en: Stateless components
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure Batch uses parallel actions to process the workloads. To fully leverage
    this capability, applications need to be split up into single and stateless tasks,
    called multi-instance tasks. By default, a Batch task is executed on a single
    compute node. By enabling multi-instance tasks, the task is executed on multiple
    compute nodes.
  prefs: []
  type: TYPE_NORMAL
- en: 'Those multi-instance tasks are submitted to the Batch job and then distributed
    over the available nodes inside the Batch pool. Azure Batch automatically creates
    one primary task and several subtasks based on the multi-instance settings. The
    tasks that run in parallel then use Azure Storage to save and retrieve the data
    that''s used by the different tasks:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/4615bb0d-05d7-4536-9551-e5b103f9a480.png)'
  prefs: []
  type: TYPE_IMG
- en: Azure Batch jobs and tasks
  prefs: []
  type: TYPE_NORMAL
- en: Those multi-instance tasks can be created in code using the Batch .NET SDK or
    the Python SDK.
  prefs: []
  type: TYPE_NORMAL
- en: For more information on creating an Azure Batch Solution using the Batch .NET
    SDK, you can refer to the following tutorial: [https://docs.microsoft.com/en-us/azure/batch/tutorial-parallel-dotnet](https://docs.microsoft.com/en-us/azure/batch/tutorial-parallel-dotnet).
  prefs: []
  type: TYPE_NORMAL
- en: Containers on Azure Batch
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Azure Batch also supports the deployment of containers. You can use Docker containers
    or Singularity. Singularity is similar to Docker, but it is primary designed to
    run on shared HPC clusters in on-premises environments and super computing installations. Singularity
    does not require root privileges to execute containers. It allows applications
    to leverage GPUs and specialized networking within the privilege scope of the
    executing user. This makes Singularity compatible for permissions-constrained
    HPC environments. Where Docker is originally designed to run Linux containers,
    Singularity can import Docker images and run Windows containers as well.
  prefs: []
  type: TYPE_NORMAL
- en: Singularity can be run from the Azure Cloud Shell without any installation and
    can be installed from the Azure Batch Shipyard release. This is an open system
    for enabling simple, configuration-based container execution on Azure Batch. Any
    knowledge of the Azure Batch .NET SDK is not needed; only configuration files
    are used here.
  prefs: []
  type: TYPE_NORMAL
- en: For more information on containers on Batch Shipyard, you can refer to the following
    GitHub page: [https://github.com/Azure/batch-shipyard](https://github.com/Azure/batch-shipyard).
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we have covered the compute-intensive applications objective.
    We've covered how to design HPC and other compute-intensive applications using
    Azure services, how to determine when to use Azure Batch, and how to design stateless
    components to accommodate scale and Containers on Azure Batch.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will cover the web application objective.
  prefs: []
  type: TYPE_NORMAL
- en: Questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Answer the following questions to test your knowledge of the information in
    this chapter. You can find the answers in the *Assessments* section at the end
    of this book:'
  prefs: []
  type: TYPE_NORMAL
- en: You want to create HPC clusters in your on-premises environment. Should you
    use Azure Batch?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: For creating high-performance compute VMs, should we use the H-series?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: To automate the creation of Azure Batch processes, should we use ARM templates?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Yes'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: 'No'
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Further reading
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'You can check the following links for more information about the topics that
    are covered in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: '**High performance compute VM sizes**: [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-hpc?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Options with HPC Pack to create and manage a cluster for Windows HPC workloads
    in Azure**: [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/hpcpack-cluster-options](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/hpcpack-cluster-options)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Batch Documentation**: [https://docs.microsoft.com/en-us/azure/batch/](https://docs.microsoft.com/en-us/azure/batch/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**HPC, Batch, and Big Compute solutions using Azure VMs**: [https://docs.microsoft.com/en-us/azure/virtual-machines/linux/high-performance-computing](https://docs.microsoft.com/en-us/azure/virtual-machines/linux/high-performance-computing)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Deploy applications to compute nodes with Batch application packages**: [https://docs.microsoft.com/en-us/azure/batch/batch-application-packages](https://docs.microsoft.com/en-us/azure/batch/batch-application-packages)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Solution architecture: On-premises HPC implementation bursting to Azure**: [https://azure.microsoft.com/en-us/solutions/architecture/hpc-on-prem-burst/](https://azure.microsoft.com/en-us/solutions/architecture/hpc-on-prem-burst/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Solution architecture: HPC cluster deployed in the cloud**: [https://azure.microsoft.com/en-us/solutions/architecture/hpc-cluster/](https://azure.microsoft.com/en-us/solutions/architecture/hpc-cluster/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Solution architecture: Big compute solutions as a service**: [https://azure.microsoft.com/en-us/solutions/architecture/hpc-big-compute-saas/](https://azure.microsoft.com/en-us/solutions/architecture/hpc-big-compute-saas/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
