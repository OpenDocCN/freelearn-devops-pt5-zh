- en: Chapter 8. Encrypting Data with Vault
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Using variables, we saw how to separate data and code. Often, the data provided
    is sensitive, for example, user passwords, data base credentials, API keys, and
    other organization-specific information. Ansible-playbooks, being a source code,
    are most commonly stored in version control repositories such as a **git**, which
    makes it even more difficult to protect this sensitive information in a collaborative
    environment. Starting with version 1.5, Ansible provides a solution called **vault**
    to store and retrieve such sensitive information securely, using proven encryption
    technologies. The objective of using vault is to encrypt data that can then be
    stored and shared freely with a version control system, such as git, without the
    values being compromised.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we will learn about the following topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Understanding the Ansible-vault
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Securing data using the Ansible-vault
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Encryption, decryption, and rekeying operations
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Ansible-vault
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Ansible provides a utility named Ansible-vault, which as the name suggests,
    lets you manage data securely. The Ansible-vault utility can either let you create
    an encrypted file by launching an editor interface, or encrypt an existing file.
    In either case, it will ask for a vault password, which is then used to encrypt
    the data with the AES cipher. The encrypted contents can be stored in a version
    control system without being compromised. Since the AES is based on shared secret,
    the same password needs to be provided for decryption too. To provide the password,
    there are two options, while launching Ansible, run the `--ask-vault-pass` option
    to prompt for the password, and the `--vault-password-file` option to provide
    the path to the file that contains the password.
  prefs: []
  type: TYPE_NORMAL
- en: Advanced Encryption Standard
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**Advanced** **Encryption Standard** (**AES**) is an encryption standard based
    on the **Rijndael** symmetric block cipher, named after, and developed by, two
    Belgian cryptographers—Vincent Rijmen and Joan Daemen. Initially, established
    by (the U.S.) **National Institute of Standards and Technology** (**NIST**) in
    2001, AES is an algorithm adopted by the U.S. government to share classified information,
    and is the most popular symmetric-key cryptography algorithm. AES is also the
    first publicly accessible open cypher approved by the **National Security Agency**
    (**NSA**).'
  prefs: []
  type: TYPE_NORMAL
- en: Being an open and popular standard, Ansible uses the AES cypher with a key size
    of 256 bits to encrypt data with the vault.
  prefs: []
  type: TYPE_NORMAL
- en: What to encrypt with the vault?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Ansible-vault can encrypt any structured data. Since YAML itself is a structured
    language, almost everything that you write for Ansible meets this criteria. The
    following are the pointers on what can be encrypted with the vault:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Most commonly, we encrypt variables, which can be as follows:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Variable files in roles, for example, `vars` and `defaults`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Inventory variables, for example, `host_vars`, `group_vars`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Variables files included with `include_vars` or `vars_files`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Variable files passed to the Ansible-playbook with the `-e` option, for example,
    `-e @vars.yml` or `-e @vars.json`
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Since tasks and handlers are also JSON data, these can be encrypted with the
    vault. However, this should be rarely practiced. It's recommended that you encrypt
    variables and reference them in tasks and handlers instead.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following are the pointers on what cannot be encrypted with the vault:'
  prefs: []
  type: TYPE_NORMAL
- en: Since the unit of encryption for the vault is a file, partial files or values
    cannot be encrypted. You can encrypt the complete file or none of it.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Files and templates cannot be encrypted as they may not be similar to JSON or
    YML.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following data are a good candidates for encryption:'
  prefs: []
  type: TYPE_NORMAL
- en: Credentials, for example, database passwords and application credentials
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: API keys, for example, AWS access and secret keys
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: SSL keys for web servers
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Private SSH keys for deployments
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using the Ansible-vault
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The following table lists all the subcommands that the Ansible-vault utility
    comes with:'
  prefs: []
  type: TYPE_NORMAL
- en: '| Subcommand | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `create` | This creates a encrypted file from scratch using the editor. This
    needs the editor environment variable set before launching the command. |'
  prefs: []
  type: TYPE_TB
- en: '| `edit` | This edits the existing encrypted file with an editor, without decrypting
    the contents. |'
  prefs: []
  type: TYPE_TB
- en: '| `encrypt` | This encrypts an existing file with structured data. |'
  prefs: []
  type: TYPE_TB
- en: '| `decrypt` | This decrypts the file. Use this with care and do not commit
    the decrypted file to version control. |'
  prefs: []
  type: TYPE_TB
- en: '| `rekey` | This changes the key or password used to encrypt or decrypt. |'
  prefs: []
  type: TYPE_TB
- en: Encrypting the data
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let''s perform some operations using Ansible-vault. We will start by creating
    an encrypted file. To create a new file from scratch, Ansible-vault uses the `create`
    subcommand. Before using this subcommand, it is important to set an editor in
    the environment, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Launching this command opens up an editor specified with the editor environment
    variable. The following is an example of the `aws_creds.yml` file that you may
    create to store the AWS user credentials in the form of an access key and secret
    key. These keys are then used to make API calls to the Amazon web services cloud
    platform. Saving this file and exiting the editor will generate an encrypted file:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Encrypting the data](img/B03800_08_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'You can check the type of file created and its contents by running following
    commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Updating the encrypted data
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To update the AWS keys added to the encrypted file, you can later use Ansible-vault''s
    `edit` subcommand as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'The `edit` command does the following operations:'
  prefs: []
  type: TYPE_NORMAL
- en: Prompts for a password
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Decrypts a file on the fly using the AES symmetric cypher
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Opens the editor interface, which allows you to change the content of a file
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Encrypts the file again after being saved
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'There is another way to update the content of the file. You can decrypt the
    file as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Once updated, this file can then be encrypted again, as you learned earlier.
  prefs: []
  type: TYPE_NORMAL
- en: Rotating the encryption keys
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'As a good security practice, it''s a good idea to change encryption keys used
    with Ansible-vault often. When this happens, it''s essential to rekey all the
    files encrypted earlier using the vault. Ansible vault offers a `rekey` subcommand,
    which can be used as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: It asks for the current password, and then allows you to specify and confirm
    your new password. Note that if you are managing this file with version control,
    you would also need to commit the change. Even though the actual contents are
    unchanged, rekeying the operation updates the resulting file that is created,
    which is part of our repository.
  prefs: []
  type: TYPE_NORMAL
- en: Encrypting the database credentials
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Earlier while creating database users, we provided the passwords as plain text
    in `group_vars`. This can be a potential threat, especially when checked into
    a version control repository. Let's encrypt it. We will use the `encrypt` subcommand
    as we already have a variables file.
  prefs: []
  type: TYPE_NORMAL
- en: 'Since we are using the `group_vars` group to provide database credentials,
    we will encrypt the `group_vars/all` file as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'For encryption, Ansible-vault asks for a password or key to be entered by the
    user. Using this key, the vault encrypts the data and replaces the file with the
    encrypted content. The following diagram shows the plain text content on the left
    and the equivalent encrypted content on the right for the `group_vars/all` file:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Encrypting the database credentials](img/B03800_08_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'This file now can be safely checked into a version control system and shared.
    However, the following are the caveats users should be aware of:'
  prefs: []
  type: TYPE_NORMAL
- en: Unlike plain text, the resulting file is an encrypted format. It's not possible
    to get a different file format, for example, `git diff`, to compare the changes
    while committing to version control.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It's not possible to use `grep`, `sed`, or any text search or manipulation programs
    on this file directly. The only way to do so is to decrypt it first, run the text
    manipulation utilities, and encrypt it back.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Ensure that you use the same password for all the files that you are going to
    decrypt with one Ansible-playbook run. Ansible can take only one value for the
    password at a time, and will fail if the files in the same playbook are encrypted
    using different passwords.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s now run the Ansible playbook using the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'It fails with an error! That''s because we are providing the playbook with
    encrypted data, without the key to decrypt it. The primary use for vault is to
    secure data while it''s in the Ansible repository. Ultimately, these values need
    to be decrypted while running the playbook. The decryption password can be specified
    with the `--ask-vault-pass` option, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: This will prompt for "Vault Password" and then continue running Ansible code
    as usual.
  prefs: []
  type: TYPE_NORMAL
- en: Using a password file
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Entering the password every time may not be ideal. Often at times you may also
    want to automate the process of launching Ansible playbook runs, in which case,
    an interactive way is not feasible. This can be avoided by storing the password
    in a file and providing the file to the Ansible playbook run. The password should
    be provided as a single line string in this file.
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s create a password file and secure it with the correct permissions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: When the vault password is stored as plain text, anyone who has access to this
    file can decrypt the data. Make sure the password file is secured with appropriate
    permissions, and is not added to version control. If you decide to version control
    it, use **gpg** or equivalent measures.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now this file can be provided to the Ansible playbook, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Adding the vault password file option to the Ansible configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: With version 1.7, it's also possible to add the `vault_password_file` option
    to the `ansible.cfg` file in the defaults section.
  prefs: []
  type: TYPE_NORMAL
- en: 'Consider the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'The preceding option gives you the freedom of not specifying the encryption
    password or the password file every time. Let''s take a look at the following
    commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Moreover, when starting with version 1.7, instead of storing a plain text password
    in the file, a script can also be provided in the `vault_password_file` option.
    When using the script, ensure that:'
  prefs: []
  type: TYPE_NORMAL
- en: The execute bit is enabled on the script
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Calling this script outputs a password on the standard output
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the script prompts for user inputs, it can be sent to the standard error
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using encrypted data in templates
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You learned earlier that since a template may not be a structured file such
    as YAML or JSON, it cannot be encrypted. However, there is a way to add encrypted
    data to the templates. Remember, templates are, after all, generated on the fly,
    and the dynamic content actually comes from variables, which can be encrypted.
    Let's discuss how to achieve this by adding SSL support for the Nginx web server.
  prefs: []
  type: TYPE_NORMAL
- en: Adding SSL support to Nginx
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We have already set up an Nginx web server, now let''s add SSL support to the
    default site by following these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: 'We begin by adding the variables, as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Let''s also create self-signed SSL certificates:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The preceding command will generate two files, `nginx.key` and `nginx.crt`.
    These are the files that we will have copied over to the web server.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let''s add the contents of these files to the variables, and create the `group_vars/www`
    file:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: In the preceding example, we are just adding placeholders that are to be replaced
    with the actual contents for the key and certificate. These keys and certificates
    should not be exposed in a version control system.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let''s encrypt this file using the vault:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Since we have already provided the path to the vault password in the configuration,
    the Ansible-vault does not ask for the password.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Let''s now create the templates, which add these keys:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Also, let''s add a virtual host `config` file to the SSL:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'We also need to create a task file to configure the SSL site, which will create
    the required directory, files, and configurations:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Finally, let''s call this task selectively based on whether the `nginx_ssl
    var` parameter is set to true:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Now, run the playbook as follows:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'This should configure the default SSL site running at port `443` with self-signed
    certificates. Now, you should be able to open the web server address with the
    `https` secure protocol as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Adding SSL support to Nginx](img/B03800_08_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Of course, it should show a warning as our certificate is self-signed and not
    provided by a designated certification authority.
  prefs: []
  type: TYPE_NORMAL
- en: Review questions
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Do you think you''ve understood the chapter well enough? Try answering the
    following questions to test your understanding:'
  prefs: []
  type: TYPE_NORMAL
- en: Why is there a need to encrypt the data provided to Ansible playbooks?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What is AES, and what is a symmetric-key cipher?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What are the two methods to update a file previously encrypted with the vault?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: What is the parameter that is added to the Ansible configuration file to make
    it aware of the location of the vault password file?
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned how to secure the data passed to the playbooks
    using Ansible-vault. We started with the need to encrypt data, how the vault works,
    and which cipher it uses. We then started to dive into the Ansible-vault utility
    and basic operations such as creating encrypted files, decrypting, rekeying, and
    so on. You also learned how to encrypt existing files by running Ansible-vault
    on the `vars` file holding the database credentials. Finally, we added SSL support
    to Nginx and you learned how to securely store private keys and certificates for
    the web server using the vault and copying them using templates. Note that Ansible
    vault offers a way to provide data to Ansible modules securely. In addition to
    using the vault, additional system security measures are advised that do not come
    under the purview of this text.
  prefs: []
  type: TYPE_NORMAL
- en: After learning about vault, in the next chapter, we will start learning about
    the various approaches to managing multiple environments such as development,
    staging, and production with Ansible. These environments typically map to the
    software development workflow.
  prefs: []
  type: TYPE_NORMAL
