<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">CI/CD Pipelines in OpenShift</h1>
                
            
            <article>
                
<p class="calibre2">In the previous chapter<span class="calibre11">, you learned how to build and deploy a WordPress application from a custom template. You also learned </span><span class="calibre11">how to create and deploy OpenShift templates, and how to </span><span class="calibre11">deploy applications from OpenShift templates.</span></p>
<p class="calibre2"><span class="calibre11">This chapter will introduce the reader to <strong class="calibre4">Continuous Integration/Continuous Delivery</strong> (<strong class="calibre4">CI/CD</strong>), Jenkins, OpenShift pipelines, and Jenkins integration with OpenShift. We will discuss CI/CD, pipelines, and Jenkins as CI/CD, following by how Jenkins works in OpenShift. We will also show you how to create a sample CI/CD pipeline in OpenShift, how to edit pipelines, and how to manage pipeline execution.</span></p>
<p class="calibre2">After reading this chapter, you will understand the following topics:</p>
<p class="calibre2"/>
<ul class="calibre9">
<li class="calibre10">CI/CD and CI/CD pipelines</li>
<li class="calibre10">Jenkins as CI/CD</li>
<li class="calibre10">Jenkins in OpenShift</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Technical requirements</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we will use the following technologies and software:</p>
<ul class="calibre9">
<li class="calibre10">The command-line interface</li>
<li class="calibre10">Minishift</li>
<li class="calibre10">GitHub</li>
<li class="calibre10">Web browsers</li>
</ul>
<p class="calibre2">The Vagrant installation, and all of the code that we will use in this chapter, are located on GitHub, at <a href="https://github.com/PacktPublishing/Learn-OpenShift" class="calibre8">https://github.com/PacktPublishing/Learn-OpenShift</a>.</p>
<p class="calibre2">You can use Firefox or any other browser to navigate through Docker Hub. </p>
<p class="calibre2">As a prerequisite, you will need a stable internet connection from your laptop.</p>
<p class="calibre2">We will use<span class="calibre11"> </span>Minishift<span class="calibre11"> </span>as our lab<span class="calibre11"> </span>environment<span class="calibre11"> </span>in this chapter. Before you start, please delete your existing Minishift VM (if there is one), because we will need to create a new VM, with non-standard parameters:</p>
<pre class="calibre18"><strong class="calibre1">$ minishift start --openshift-version=v3.9.0 --vm-driver=virtualbox --memory 4GB</strong><br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/><strong class="calibre1">output truncated for brevity</strong><br class="title-page-name"/><strong class="calibre1">...</strong><br class="title-page-name"/>-- Minishift VM will be configured with ...<br class="title-page-name"/><strong class="calibre1">   Memory: 4 GB</strong><br class="title-page-name"/>   vCPUs : 2<br class="title-page-name"/>   Disk size: 20 GB<br class="title-page-name"/>...<br class="title-page-name"/>output truncated for brevity<br class="title-page-name"/>...<br class="title-page-name"/>OpenShift server started.<br class="title-page-name"/><br class="title-page-name"/>The server is accessible via web console at:<br class="title-page-name"/><strong class="calibre1">    https://192.168.99.110:8443</strong><br class="title-page-name"/><br class="title-page-name"/>You are logged in as:<br class="title-page-name"/>    User: developer<br class="title-page-name"/>    Password: &lt;any value&gt;<br class="title-page-name"/><br class="title-page-name"/>To login as administrator:<br class="title-page-name"/>    oc login -u system:admin</pre>
<p class="calibre2">Make sure that the <kbd class="calibre12">Memory</kbd><span class="calibre11"> </span>shows 4 GB at least; otherwise, you might not have enough memory for your lab. You can also adjust the amount of memory by stopping the Minishift VM and changing it via the VirtualBox console. But, the safest method is to delete the Minishift VM and create a new one.<span class="calibre11"> </span></p>
<p class="calibre2"/>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">CI/CD and CI/CD pipelines</h1>
                
            
            <article>
                
<p class="calibre2">You may have already heard the term <strong class="calibre4">CI/CD</strong>. It comprises the two main acronyms people use when talking about modern application deployment. While CI stands for <strong class="calibre4">Continuous Integration</strong>, CD has two meanings; one of them is <strong class="calibre4">C<span class="calibre11">ontinuous</span> Deployment,</strong> and another one is <strong class="calibre4">C</strong><span class="calibre11"><strong class="calibre4">ontinuous Delivery</strong>. All three terms are easy to understand, and are described as follows:</span></p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Continuous Integration</strong>: Emphasizes creating and building automation tests against application builds, as well as merging updates into a single branch as often as possible. It helps to catch bugs early on and to avoid the integration difficulties that developers usually encounter when developing new code and merging changes into different branches.</li>
<li class="calibre10"><span><strong class="calibre1">Continuous Delivery</strong>: Helps to extend Continuous Integration processes, to push new code from the development to the production stage in a reproducible fashion. If, with Continuous Integration, you automate builds and tests, then Continuous Delivery automates application release processes, usually using approval procedures. </span></li>
<li class="calibre10"><span><strong class="calibre1">Continuous Deployment</strong>: Extends Continuous Delivery even further, by providing a seamless and uninterrupted application delivery process, without any human intervention. This application deployment method requires quite a lot of effort to make sure that, when you run the code, it won't break anything and will work as expected.   </span></li>
</ul>
<p class="calibre2">The CI and CD processes are put into a series of steps and procedures to form a <strong class="calibre4">pipeline</strong>, often referred to as the CI/CD pipeline. <span class="calibre11">Continuous Integration is shown with both C</span><span class="calibre11">ontinuous Delivery and Continuous Deployment in the following diagram:</span></p>
<p class="cdpaligncenter"><img class="alignnone62" src="../images/00072.gif"/></p>
<div class="cdpaligncenter3">CI/CD pipeline example</div>
<p class="calibre2">The pipeline stages are not strict, but following best practices will help you to make your CI/CD pipeline stable and repeatable.  </p>
<p class="calibre2">There are many CI/CD tools that can help you to automate the application delivery process, but one of the most popular ones in the industry is called Jenkins. It just so happens that OpenShift has built in integration with Jenkins, which we will discuss in the following sections.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Jenkins as CI/CD</h1>
                
            
            <article>
                
<p class="calibre2">Jenkins<sup class="calibre16"> </sup>is an open source automation tool that can be used to accelerate the application development process using CI/CD pipelines. Jenkins controls and manages application development life cycle processes, including the build, test, publish, stage, deploy, and smoke test processes, among others.</p>
<p class="calibre2"/>
<p class="calibre2"/>
<p class="calibre2">The standard Jenkins architecture is shown in the following diagram:</p>
<p class="cdpaligncenter"><img class="alignnone63" src="../images/00073.jpeg"/></p>
<div class="cdpaligncenter1">Jenkins architecture</div>
<p class="calibre2">There are two main components in the Jenkins architecture:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">Jenkins Master</strong>: Your CI/CD controller, handling various tasks, such as:
<ul class="calibre29">
<li class="calibre10">Job scheduling</li>
<li class="calibre10">Distributing the workload among Jenkins Slaves</li>
<li class="calibre10">Jenkins Slave monitoring</li>
<li class="calibre10">Logging and representing job results</li>
</ul>
</li>
<li class="calibre10"><strong class="calibre1">Jenkins Slaves</strong>: A set of Java-based programs that run on the remote host. Jenkins Slaves mainly execute instructions from Jenkins Masters. </li>
</ul>
<p class="calibre2">Jenkins Masters and Jenkins Slaves are functionalities, which basically means that both can coexist on the same host. In small or lab environments, there are usually no issues with running both a Jenkins Master and Jenkins Slaves on the same host, but if you have hundreds (or thousands) of jobs running in your environment, it makes sense to run the <span class="calibre11">Jenkins Master and Jenkins Slaves on different nodes, and to have several Jenkins Slaves, to distribute the load among them. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Jenkins in OpenShift</h1>
                
            
            <article>
                
<p class="calibre2"><span class="calibre11">OpenShift leverages the Jenkins CI/CD model, and extends it by using a combination of the following components:</span></p>
<ul class="calibre9">
<li class="calibre10"><span><strong class="calibre1">OpenShift Domain Specific Language (DSL)</strong>: DSL is provided by the OpenShift Jenkins client plugin that runs on the Jenkins Master pod and interacts with the OpenShift API server. The OpenShift DSL provides a method for controlling your application life cycle.</span></li>
<li class="calibre10"><span><strong class="calibre1">Jenkins Pipeline Build Strategy</strong>: Similar to other OpenShift build strategies, it defines the build's workflow. Jenkins Pipeline Build Strategy allows a developer to create a Jenkins pipeline that is monitored and controlled by OpenShift.   </span></li>
<li class="calibre10"><span><strong class="calibre1">Jenkinsfile</strong>: Defines CI/CD pipelines through a series of steps during application deployment in OpenShift, using the Apache Groovy programming language.</span></li>
</ul>
<p class="calibre2"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Creating Jenkins pipelines in OpenShift</h1>
                
            
            <article>
                
<p class="calibre2">Once the Minishift cluster is up, open your favorite web browser and open OpenShift, using the URL given from the output of the <kbd class="calibre12">minishift start</kbd> command. It is accessible via <span class="calibre11"><kbd class="calibre12">https://192.168.99.110:8443</kbd>, in our case:</span></p>
<p class="cdpaligncenter"><img class="alignnone64" src="../images/00074.jpeg"/></p>
<div class="cdpaligncenter3">OpenShift login page</div>
<p class="calibre2">Use the <span class="calibre11">developer</span> user, with any password, to log in on the welcome page:</p>
<div class="cdpaligncenter2"><img src="../images/00075.jpeg" class="calibre33"/></div>
<div class="cdpaligncenter3">OpenShift welcome page</div>
<p class="calibre2">Click on <span class="calibre11">My Project</span> to access the OpenShift <span class="calibre11">Project Overview</span> page. From there, click on the <span class="calibre11">Builds</span> | <span class="calibre11">Pipelines</span> sub-menu:</p>
<div class="cdpaligncenter2"><img src="../images/00076.jpeg" class="calibre41"/></div>
<p class="calibre2">From here, you should be able to click on <span class="calibre11">Create Sample Pipeline</span>. Then, scroll all the way down and click on the <span class="calibre11">Create</span> button. It should tell you that the <kbd class="calibre12">Pipeline Build Example</kbd> has been created:</p>
<div class="cdpaligncenter2"><img src="../images/00077.jpeg" class="calibre42"/></div>
<p class="calibre2">OpenShift creates a set of pods including Jenkins, mongodb and nodejs, with further integration with OpenShift. And all of that with just one click. This is just a demo, but isn't that cool? Now <span class="calibre11">go back to the <span class="calibre11">Overview</span> menu to check the overall progress:</span></p>
<div class="cdpaligncenter2"><img src="../images/00078.jpeg" class="calibre33"/></div>
<div class="cdpaligncenter3">OpenShift project menu</div>
<p class="calibre2">You should be able to see a few applications, with pods. The first one is a Jenkins application, and the second one is MongoDB, as a part of our test application. There should be <span class="calibre11">No deployments</span> for <kbd class="calibre12">nodejs-mongodb-example</kbd>, because it will be controlled by Jenkins pipelines.</p>
<div class="packt_infobox">Depending on your internet connection, it will take time to pull all of the images and start all of the pods, especially for Jenkins, as it is roughly 2.5 GB. You can go to the <span>Monitoring</span> tab and click on <span>View details</span> to check the current status of the overall process. If the last message from Jenkins is <span><span>pulling image openshift/</span>jenkins<span>-2-centos7</span></span>, then just wait patiently, or go and make some coffee.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Starting a Jenkins pipeline</h1>
                
            
            <article>
                
<p class="calibre2">Once both the Jenkins and MongoDB pods are running, go back to the <span class="calibre11"><span class="calibre11">Builds</span></span> | <span class="calibre11"><span class="calibre11">Pipelines</span> sub-menu: </span></p>
<div class="cdpaligncenter2"><img src="../images/00079.jpeg" class="calibre43"/></div>
<p class="calibre2">Click the <span class="calibre11">Start Pipeline</span> button. This will trigger a CI/CD pipeline, to start building. Depending on your internet connection, this step will take some time to complete; by the end of it, you should be able to see that two stages were completed successfully:</p>
<p class="cdpaligncenter"><img class="alignnone65" src="../images/00080.jpeg"/></p>
<p class="calibre2">Clicking on <span class="calibre11">View Log</span> should open a new tab with the Jenkins console output from the Jenkins login page:</p>
<div class="cdpaligncenter3"><img src="../images/00081.jpeg" class="calibre44"/></div>
<div class="cdpaligncenter3">Jenkins login page</div>
<p class="calibre2">Click on <span class="calibre11">Log in with OpenShift</span> and use the same credentials that you used to authenticate in OpenShift (use the <span class="calibre11">developer</span> user, with any password):</p>
<div class="cdpaligncenter2"><img src="../images/00082.jpeg" class="calibre33"/></div>
<div class="cdpaligncenter3">Jenkins user authorization</div>
<p class="calibre2">You will need to authorize the <span class="calibre11">developer</span> user to access Jenkins, by clicking on <span class="calibre11">Allow selected permission</span><span class="calibre11">s</span>. This will get you to the Jenkins <span class="calibre11">Console Output</span>:</p>
<div class="cdpaligncenter2"><img src="../images/00083.jpeg" class="calibre33"/></div>
<div class="cdpaligncenter3">Jenkins C<span>onsole Output</span></div>
<p class="calibre2">Scroll down to see the complete log, close the lab, and go back to the OpenShift tab.  </p>
<div class="packt_infobox">If you are interested in how Jenkins works in detail and want to learn more, just follow the links in the <em class="calibre28">Further reading</em> section of this chapter. </div>
<p class="calibre2">We mentioned previously that there is a difference between the Continuous Delivery and Continuous Deployment models; one of them includes human intervention, and the other one does not. </p>
<p class="calibre2"><span class="calibre11">What we are going to do next is modify our test pipeline and add an approval step. Go back to the <span class="calibre11">pipeline</span> sub-menu:</span></p>
<p class="cdpaligncenter"><img class="alignnone66" src="../images/00084.jpeg"/></p>
<p class="calibre2">Clicking on <span class="calibre11">Edit Pipeline</span> should redirect us to editing our first pipeline.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Editing Jenkinsfile</h1>
                
            
            <article>
                
<p class="calibre2">You should see the Jenkins pipeline configuration file, <span class="calibre11">Jenkinsfile</span>, as shown in the following screenshot:</p>
<div class="cdpaligncenter2"><img src="../images/00085.jpeg" class="calibre45"/></div>
<div class="cdpaligncenter3">Editing pipelines</div>
<div class="packt_infobox">Jenkins uses the Apache Groovy Programming Language. It is pretty easy to learn, and we are not going to delve too deeply into the details; rather, we will give you some basic skills. You can find more information regarding Groovy in the <em class="calibre28">Further reading</em> section.</div>
<p class="calibre2">We simply need to add a new stage with an arbitrary name; let's call it the <kbd class="calibre12">approval</kbd> stage, in between the <kbd class="calibre12">build</kbd> and <kbd class="calibre12">deploy</kbd> stages. <span class="calibre11">This new <kbd class="calibre12">approval</kbd> stage will put the deployment stage on hold, until you manually approve it:</span></p>
<pre class="calibre18">...<br class="title-page-name"/>node('nodejs') {<br class="title-page-name"/> stage('build') {<br class="title-page-name"/> openshiftBuild(buildConfig: 'nodejs-mongodb-example', showBuildLogs: 'true')<br class="title-page-name"/> }<br class="title-page-name"/><strong class="calibre1"> stage('approval') {</strong><br class="title-page-name"/><strong class="calibre1"> input "Approve moving to deploy stage?"</strong><br class="title-page-name"/><strong class="calibre1"> }</strong><br class="title-page-name"/> stage('deploy') {<br class="title-page-name"/> openshiftDeploy(deploymentConfig: 'nodejs-mongodb-example')<br class="title-page-name"/> }<br class="title-page-name"/>}<br class="title-page-name"/>...</pre>
<p class="calibre2"><span class="calibre11">Click on <span class="calibre11">Save</span> and start the pipeline. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Managing pipeline execution</h1>
                
            
            <article>
                
<p class="calibre2">Adding one more stage called <em class="calibre17">approval</em> triggers the second build to start, and eventually you should be able to see the new <span class="calibre11">approval</span> stage, with <span class="calibre11">Input Required</span>:</p>
<div class="cdpaligncenter4"><img src="../images/00086.jpeg" class="calibre33"/></div>
<p class="calibre2"> </p>
<p class="calibre2">Clicking on <span class="calibre11">Input Required </span>will open a new tab and redirect you to the Jenkins approval stage, asking: <span class="calibre11">Approve moving to deploy stage?</span> Shown as follows:</p>
<div class="cdpaligncenter2"><img src="../images/00087.jpeg" class="calibre33"/></div>
<p class="calibre2">The result will be different depending on what you answer. In our case, we are going to press the <span class="calibre11">Proceed</span> button. This will redirect us to the Jenkins Console Output, but we can just close it and go back to the OpenShift pipeline tab. From the following screenshot, we can see that the CI/CD pipeline has completed the deploy stage and now we have three stages instead of two as in <kbd class="calibre12">Build #1</kbd>.</p>
<div class="cdpaligncenter4"><img src="../images/00088.jpeg" class="calibre33"/></div>
<p class="calibre2">As a result, you should see a <kbd class="calibre12">nodejs-mongodb-example, #2</kbd> pod running in the <span class="calibre11">Overview</span> menu. The <kbd class="calibre12">#2</kbd> means that it is build number two:</p>
<div class="cdpaligncenter2"><img src="../images/00089.jpeg" class="calibre33"/></div>
<p class="calibre2">Jenkins is a lot more complicated than that, but this should have provided you with a good overview of CI/CD in OpenShift, and how easy it is to get started with Jenkins in OpenShift</p>
<p class="calibre2">You are save know to stop and delete your minishift VM running <kbd class="calibre12">minishift delete</kbd> command, unless you are going to do more practice.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter,<span class="calibre11"> we introduced you to CI/CD, Jenkins, OpenShift pipelines, and Jenkins integration with OpenShift. We showed you how to create a sample CI/CD pipeline in OpenShift, how to edit pipelines, and how to manage pipeline execution.</span><span class="calibre11"> </span></p>
<p class="calibre2">In the next chapter, we will briefly touch on HA in general, and will then focus on OpenShift HA. We will discuss how OpenShift provides redundancy in the event of a failure, and how you can prevent this from happening by properly designing your OpenShift cluster. At the end of the chapter, we will discuss how to back up and restore OpenShift cluster data, in case something goes wrong.  </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Questions</h1>
                
            
            <article>
                
<ol class="calibre13">
<li value="1" class="calibre10">What CI/CD method allows you to automate the <span>application delivery process without any human intervention</span>? choose one:
<ol class="calibre14">
<li value="1" class="calibre10">Continuous delivery</li>
<li value="2" class="calibre10">Continuous deployment</li>
<li value="3" class="calibre10">Continuous integration</li>
<li value="4" class="calibre10">Continuous automation</li>
</ol>
</li>
<li value="2" class="calibre10">Which three CI/CD pipeline components does OpenShift use? choose three:
<ol class="calibre14">
<li value="1" class="calibre10">OpenShift Domain Specific Language</li>
<li value="2" class="calibre10">Jenkins Pipeline Build Strategy</li>
<li value="3" class="calibre10">Jenkins Java Connector</li>
<li value="4" class="calibre10">Jenkinsfile</li>
<li value="5" class="calibre10">Jenkins Build Strategy</li>
</ol>
</li>
<li value="3" class="calibre10">You have to manually configure OpenShift authentication for OpenShift pipelines with Jenkins:
<ol class="calibre14">
<li value="1" class="calibre10">True</li>
<li value="2" class="calibre10">False</li>
</ol>
</li>
<li value="4" class="calibre10">What command in Jenkinsfile allows you to implement a manual approval procedure? choose one:
<ol class="calibre14">
<li value="1" class="calibre10">Input</li>
<li value="2" class="calibre10">Hold</li>
<li value="3" class="calibre10">Approve</li>
<li value="4" class="calibre10"><span>Accept</span></li>
</ol>
</li>
<li value="5" class="calibre10">Which menu in the OpenShift GUI brings you to the OpenShift pipelines page? choose one: 
<ol class="calibre14">
<li value="1" class="calibre10">Build | Pipelines</li>
<li value="2" class="calibre10">Jenkins | Pipelines</li>
<li value="3" class="calibre10">Build | Jenkins</li>
<li value="4" class="calibre10">Overview</li>
</ol>
</li>
<li value="6" class="calibre10">The CI/CD pipeline stages in Jenkinsfile are predefined, and cannot be changed:
<ol class="calibre14">
<li value="1" class="calibre10">True</li>
<li value="2" class="calibre10">False</li>
</ol>
</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Further reading</h1>
                
            
            <article>
                
<p class="calibre2">We briefly covered a lot of different topics regarding CI/CD in this chapter. The following links can help you delve into a topic you might be interested in:</p>
<ul class="calibre9">
<li class="calibre10"><strong class="calibre1">CI/CD overview</strong>:<span> <a href="https://www.atlassian.com/continuous-delivery/ci-vs-ci-vs-cd" class="calibre8">https://www.atlassian.com/continuous-delivery/ci-vs-ci-vs-cd</a></span></li>
<li class="calibre10"><strong class="calibre1">Apache Groovy documentation</strong>: <a href="http://groovy-lang.org/syntax.html" class="calibre8">http://groovy-lang.org/syntax.html</a></li>
<li class="calibre10"><strong class="calibre1">OpenShift pipelines</strong>: <a href="https://docs.openshift.com/container-platform/latest/dev_guide/openshift_pipeline.html" class="calibre8">https://docs.openshift.com/container-platform/latest/dev_guide/openshift_pipeline.html</a></li>
<li class="calibre10"><strong class="calibre1">OpenShift Jenkins DSL plugin documentation</strong>: <a href="https://github.com/openshift/jenkins-client-plugin" class="calibre8">https://github.com/openshift/jenkins-client-plugin </a></li>
<li class="calibre10"><strong class="calibre1">Jenkinsfile documentation</strong>: <a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" class="calibre8">https://jenkins.io/doc/book/pipeline/jenkinsfile/</a></li>
</ul>


            </article>

            
        </section>
    </body></html>